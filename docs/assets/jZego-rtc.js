!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var i=e();for(var n in i)("object"==typeof exports?exports:t)[n]=i[n]}}("undefined"!=typeof self?self:this,function(){return function(t){var e={};function i(n){if(e[n])return e[n].exports;var r=e[n]={i:n,l:!1,exports:{}};return t[n].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)i.d(n,r,function(e){return t[e]}.bind(null,r));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=6)}([function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PROTO_VERSION="1.12.2",e.ROOMVERSION="V1",function(t){t[t.debug=0]="debug",t[t.info=1]="info",t[t.warn=2]="warn",t[t.error=3]="error",t[t.report=99]="report",t[t.disable=100]="disable"}(e.ENUM_LOG_LEVEL||(e.ENUM_LOG_LEVEL={})),function(t){t[t.disable=0]="disable",t[t.websocket=1]="websocket",t[t.https=2]="https"}(e.ENUM_REMOTE_TYPE||(e.ENUM_REMOTE_TYPE={}));var n=function(){function t(t,e){void 0===t&&(t=null),void 0===e&&(e=null),this._id=null,this.next=null,this.prev=null,this._id=t,this._data=e}return Object.defineProperty(t.prototype,"id",{get:function(){return this._id},set:function(t){this._id=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"data",{get:function(){return this._data},set:function(t){this._data=t},enumerable:!0,configurable:!0}),t.prototype.hasNext=function(){return this.next&&this.next.id},t.prototype.hasPrev=function(){return this.prev&&this.prev.id},t}();e.ListNode=n;var r=function(){function t(){this.start=new n,this.end=new n,this._idCounter=0,this._numNodes=0,this.start.next=this.end,this.start.prev=null,this.end.prev=this.start,this.end.next=null}return t.prototype.insertBefore=function(t,e){var i=new n(this._idCounter,e);return i.next=t,i.prev=t.prev,t.prev.next=i,t.prev=i,++this._idCounter,++this._numNodes,i},t.prototype.addLast=function(t){return this.insertBefore(this.end,t)},t.prototype.add=function(t){return this.addLast(t)},t.prototype.getFirst=function(){return 0===this._numNodes?null:this.start.next},t.prototype.getLast=function(){return 0===this._numNodes?null:this.end.prev},t.prototype.size=function(){return this._numNodes},t.prototype.getFromFirst=function(t){var e=0,i=this.start.next;if(t>=0)for(;e<t&&null!==i;)i=i.next,++e;else i=null;if(null===i)throw"Index out of bounds.";return i},t.prototype.get=function(t){return 0===t?this.getFirst():t===this._numNodes-1?this.getLast():this.getFromFirst(t)},t.prototype.remove=function(t){return t.prev.next=t.next,t.next.prev=t.prev,--this._numNodes,t},t.prototype.removeFirst=function(){var t=null;return this._numNodes>0&&(t=this.remove(this.start.next)),t},t.prototype.removeLast=function(){var t=null;return this._numNodes>0&&(t=this.remove(this.end.prev)),t},t.prototype.removeAll=function(){this.start.next=this.end,this.end.prev=this.start,this._numNodes=0,this._idCounter=0},t.prototype.each=function(t){for(var e=this.start;e.hasNext();)t(e=e.next)},t.prototype.find=function(t){for(var e=this.start,i=!1,n=null;e.hasNext()&&!i;)t(e=e.next)&&(n=e,i=!0);return n},t.prototype.map=function(t){for(var e=this.start,i=[];e.hasNext();)t(e=e.next)&&i.push(e);return i},t.prototype.push=function(t){return this.addLast(t)},t.prototype.unshift=function(t){this._numNodes>0?this.insertBefore(this.start.next,t):this.insertBefore(this.end,t)},t.prototype.pop=function(){return this.removeLast()},t.prototype.shift=function(){return this.removeFirst()},t}();e.LinkedList=r,e.sdkErrorList={SUCCESS:{code:"ZegoClient.Success",msg:"success."},PARAM:{code:"ZegoClient.Error.Param",msg:"input error."},HEARTBEAT_TIMEOUT:{code:"ZegoClient.Error.Timeout",msg:"heartbeat timeout."},LOGIN_TIMEOUT:{code:"ZegoClient.Error.Timeout",msg:"login timeout."},SEND_MSG_TIMEOUT:{code:"ZegoClient.Error.Timeout",msg:"send customsg timeout."},RESET_QUEUE:{code:"ZegoClient.Error.Timeout",msg:"msg waiting ack is clear when reset."},LOGIN_DISCONNECT:{code:"ZegoClient.Error.Network",msg:"network is broken and login fail."},KICK_OUT:{code:"ZegoClient.Error.Kickout",msg:"kickout reason="},UNKNOWN:{code:"ZegoClient.Error.Unknown",msg:"unknown error."},FREQ_LIMITED:{code:"ZegoClient.Error.requencyLimited",msg:"Frequency Limited."}},function(t){t[t.disconnected=0]="disconnected",t[t.connecting=1]="connecting",t[t.connected=2]="connected"}(e.ENUM_SIGNAL_STATE||(e.ENUM_SIGNAL_STATE={})),e.ENUM_RESOLUTION_TYPE={LOW:{width:240,height:320,frameRate:15,bitRate:300},MEDIUM:{width:480,height:640,frameRate:15,bitRate:800},HIGH:{width:720,height:1280,frameRate:20,bitRate:1500}},e.ENUM_RETRY_STATE={didNotStart:0,retrying:1,finished:2},e.ENUM_PUBLISH_STATE={start:0,waitingSessionRsp:1,waitingOffserRsp:2,waitingServerAnswer:3,waitingServerICE:4,connecting:5,publishing:6,stop:7,didNotStart:8},e.ENUM_PUBLISH_STATE_NEGO={stop:0,start:1,waiterAnswer:2,waitingCandidate:3,sendCandidate:4,iceConnected:5,iceClosed:6,iceFailed:7,iceDisconnected:8},e.ENUM_PLAY_STATE={start:0,waitingSessionRsp:1,waitingOffserRsp:2,waitingServerAnswer:3,waitingServerICE:4,connecting:5,playing:6,stop:7,didNotStart:8},e.ENUM_PLAY_STATE_NEGO={stop:0,start:1,waiterAnswer:2,waitingCandidate:3,sendCandidate:4,iceConnected:5,iceClosed:6,iceFailed:7,iceDisconnected:8},e.ENUM_CONNECT_STATE={disconnect:0,connecting:1,connected:2},e.MAX_TRY_CONNECT_COUNT=1,e.SEND_MSG_RESET=2,e.SEND_MSG_TIMEOUT=1,e.MAX_TRY_HEARTBEAT_COUNT=5,e.ENUM_PUBLISH_STREAM_STATE={waiting_url:1,tryPublish:2,update_info:3,publishing:4,stop:5},e.ENUM_STREAM_SUB_CMD={liveNone:0,liveBegin:2001,liveEnd:2002,liveUpdate:2003},e.ENUM_STREAM_UPDATE_TYPE={added:0,deleted:1},function(t){t[t.logout=0]="logout",t[t.trylogin=1]="trylogin",t[t.login=2]="login"}(e.ENUM_RUN_STATE||(e.ENUM_RUN_STATE={})),function(t){t[t.offline=0]="offline",t[t.online=1]="online"}(e.ENUM_NETWORK_STATE||(e.ENUM_NETWORK_STATE={})),e.ENUM_PUBLISH_STATE_UPDATE={start:0,error:1,retry:2},e.ENUM_PLAY_STATE_UPDATE={start:0,error:1,retry:2},e.MINIUM_HEARTBEAT_INTERVAL=3e3,e.ENUM_STREAM_UPDATE_CMD={added:12001,deleted:12002,updated:12003},e.SERVER_ERROR_CODE=1e4,e.MIXSTREAM_ERROR_CODE=1e4,function(t){t[t.low=1]="low",t[t.stantard=2]="stantard",t[t.hight=3]="hight",t[t.custome=4]="custome"}(e.QUALITYLEVEL||(e.QUALITYLEVEL={})),e.ENUM_SIGNAL_SUB_CMD={none:0,joinLiveRequest:1001,joinLiveResult:1002,joinLiveInvite:1003,joinLiveStop:1004},e.ENUM_PUSH_SIGNAL_SUB_CMD={none:0,pushJoinLiveRequest:11001,pushJoinLiveResult:11002,pushJoinLiveInvite:11003,pushJoinLiveStop:11004},function(t){t[t.auto=0]="auto",t[t.ultra=1]="ultra"}(e.ENUM_PLAY_SOURCE_TYPE||(e.ENUM_PLAY_SOURCE_TYPE={})),function(t){t[t.stop=0]="stop",t[t.start=1]="start"}(e.ENUM_BROADCASTER_STATUS||(e.ENUM_BROADCASTER_STATUS={})),function(t){t[t.cdn=0]="cdn",t[t.ultra=1]="ultra",t[t.customUrl=2]="customUrl"}(e.ENUM_DISPATCH_TYPE||(e.ENUM_DISPATCH_TYPE={})),function(t){t[t.ClientType_None=0]="ClientType_None",t[t.ClientType_H5=1]="ClientType_H5",t[t.ClientType_SmallPragram=2]="ClientType_SmallPragram",t[t.ClientType_Webrtc=3]="ClientType_Webrtc"}(e.E_CLIENT_TYPE||(e.E_CLIENT_TYPE={}))},function(t,e,i){"use strict";var n;Object.defineProperty(e,"__esModule",{value:!0}),e.playErrorList={DISPATCH_ERROR:{code:"ZegoPlayWeb.Error.Dispatch",msg:"dispatch request error"},DISPATCH_TIMEOUT:{code:"ZegoPlayWeb.Timeout.Dispatch",msg:"dispatch request timeout"},CONNECT_FAILED:{code:"ZegoPublish.Error.Connect",msg:"connect signal fail"},TOKEN_ERROR:{code:"ZegoPlayWeb.Error.Token",msg:"login token error"},SEND_SESSION_TIMEOUT:{code:"ZegoPlayWeb.Timeout.Session",msg:"send session request timeout"},CREATE_SESSION_ERROR:{code:"ZegoPlayWeb.Error.Session",msg:"create session error"},CREATE_OFFER_ERROR:{code:"ZegoPublish.Error.CreateOffer",msg:"create offer error"},SERVER_MEDIA_DESC_TIMEOUT:{code:"ZegoPlayWeb.Timeout.RemoteOffer",msg:"wating server mediaDesc timeout"},SET_REMOTE_DESC_ERROR:{code:"ZegoPlayWeb.Error.RemoteOffer",msg:"other side offer error"},CREATE_ANSWER_ERROR:{code:"ZegoPlayWeb.Error.CreateAnswer",msg:"create offer error"},SET_LOCAL_DESC_ERROR:{code:"ZegoPlayWeb.Error.LocalDesc",msg:"setLocalDescription error"},SEND_MEDIA_DESC_TIMEOUT:{code:"ZegoPlayWeb.Timeout.Desc",msg:"send mediaDesc timeout"},SEND_CANDIDATE_ERROR:{code:"ZegoPlayWeb.Error.Candidate",msg:"send candidate error"},SEND_CANDIDATE_TIMEOUT:{code:"ZegoPlayWeb.Timeout.Candidate",msg:"send candidate timeout"},SERVER_NEGO_TIMEOUT:{code:"ZegoPlayWeb.Timeout.negotiation",msg:"negotiation timeout"},SERVER_CANDIDATE_TIMEOUT:{code:"ZegoPlayWeb.Timeout.ServerCandidate",msg:"waiting candidate timeout"},SERVER_CANDIDATE_ERROR:{code:"ZegoPlayWeb.Error.ServerCandidate",msg:"recv candidate error"},MEDIA_CONNECTION_FAILED:{code:"ZegoPlayWeb.Error.ConnectionFailed",msg:"ice Connection state failed"},MEDIA_CONNECTION_CLOSED:{code:"ZegoPlayWeb.Error.ConnectionClosed",msg:"ice connection state closed"},SESSION_CLOSED:{code:"ZegoPlayWeb.Error.SessionClosed",msg:"server session closed"},MEDIA_CONNECTION_DISCONNECTED:{code:"ZegoPublish.Error.IConnectionDisconnected",msg:"ice connection state disconnected"},WEBSOCKET_ERROR:{code:"ZegoPlayWeb.Error.SocketError",msg:"network error"},RETRY_TIMEOUT:{code:"ZegoPlayWeb.Error.RetryTimeout",msg:"retry timeout"},NETWORK_BROKEN:{code:"ZegoPlayWeb.Error.NetworkBroken",msg:"network broken"}},e.publishErrorList={DISPATCH_ERROR:{code:"ZegoPublish.Error.Dispatch",msg:"dispatch request error"},DISPATCH_TIMEOUT:{code:"ZegoPublish.Timeout.Dispatch",msg:"dispatch request timeout"},DISPATCH_MAX_TIMEOUT:{code:"ZegoPublish.Timeout.Dispatch",msg:"dispatch try limit timeout"},CONNECT_FAILED:{code:"ZegoPublish.Error.Connect",msg:"connect signal fail"},TOKEN_ERROR:{code:"ZegoPublish.Error.Token",msg:"login token error"},SEND_SESSION_TIMEOUT:{code:"ZegoPublish.Timeout.Session",msg:"send session request timeout"},CREATE_SESSION_ERROR:{code:"ZegoPublish.Error.Session",msg:"create session error"},CREATE_OFFER_ERROR:{code:"ZegoPublish.Error.CreateOffer",msg:"create offer error"},SET_LOCAL_DESC_ERROR:{code:"ZegoPublish.Error.LocalDesc",msg:"setLocalDescription error"},SEND_MEDIA_DESC_TIMEOUT:{code:"ZegoPublish.Timeout.Desc",msg:"send mediaDesc timeout"},SERVER_MEDIA_DESC_TIMEOUT:{code:"ZegoPublish.Timeout.ServerAnswer",msg:"waiting server mediaDesc timeout"},SERVER_MEDIA_DESC_ERROR:{code:"ZegoPublish.Error.ServerAnswer",msg:"server mediaDesc type error"},SET_REMOTE_DESC_ERROR:{code:"ZegoPublish.Error.RemoteDesc",msg:"other side offer error"},SEND_CANDIDATE_TIMEOUT:{code:"ZegoPublish.Timeout.Candidate",msg:"sendIceCandidate error"},SERVER_CANDIDATE_TIMEOUT:{code:"ZegoPublish.Timeout.ServerCandidate",msg:"waiting candidate timeout"},SERVER_NEGO_TIMEOUT:{code:"ZegoPublish.Timeout.negotiation",msg:"negotiation timeout"},SERVER_CANDIDATE_ERROR:{code:"ZegoPublish.Error.ServerCandidate",msg:"recv candidate error"},SESSION_CLOSED:{code:"ZegoPublish.Error.SessionClosed",msg:"server session closed"},MEDIA_CONNECTION_FAILED:{code:"ZegoPublish.Error.IConnectionFailed",msg:"Iice Connection state failed"},MEDIA_CONNECTION_CLOSED:{code:"ZegoPublish.Error.ConnectionClosed",msg:"ice connection state closed"},MEDIA_CONNECTION_DISCONNECTED:{code:"ZegoPublish.Error.IConnectionDisconnected",msg:"ice connection state disconnected"},WEBSOCKET_ERROR:{code:"ZegoPublish.Error.SocketError",msg:"network error"},RETRY_TIMEOUT:{code:"ZegoPublish.Error.RetryTimeout",msg:"retry timeout"},NETWORK_BROKEN:{code:"ZegoPublish.Error.NetworkBroken",msg:"network broken"}},e.ENUM_PUBLISH_STATE_UPDATE={start:0,error:1,retry:2},e.ENUM_PLAY_STATE_UPDATE={start:0,error:1,retry:2,stop:3},e.ENUM_RETRY_STATE={didNotStart:0,retrying:1,finished:2},e.getSeq=(n=1,function(){return n++})},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.checkConfigParam=function(t,e){return t.appid&&"number"==typeof t.appid?!t.server||t.server.length<1||"string"!=typeof t.server&&!Array.isArray(t.server)?(e.error("ccp.0 server must be string or string[] and not empty"),!1):!(!t.idName||"string"!=typeof t.idName)||(e.error("ccp.0 idName must be string and not empty"),!1):(e.error("ccp.0 appid must be number"),!1)},t.checkLoginParam=function(t,e){return!0},t.checkPreviewParam=function(t,e){var i=t.bitRate;if(4===t.videoQuality||t.externalMediaStream){if("number"!=typeof t.width||-1!==t.width.toString().indexOf("."))return e.error("zc.p.sp.0 width must be number"),!1;if("number"!=typeof t.height||-1!==t.height.toString().indexOf("."))return e.error("zc.p.sp.0 height must be number"),!1;if("number"!=typeof t.frameRate)return e.error("zc.p.sp.0 frameRate must be number"),!1;if("number"==typeof i)i<48&&(i=48),i>1e4&&(i=1e4),t.minBitRate=t.maxBitRate=t.bitRate;else if(i.minBitRate&&i.maxBitRate&&"number"==typeof i.minBitRate&&"number"==typeof i.maxBitRate&&i.minBitRate<=i.maxBitRate)t.minBitRate=i.minBitRate<48?48:i.minBitRate,t.maxBitRate=i.maxBitRate>1e4?1e4:i.maxBitRate;else if(i)return e.error("zc.p.sp.0 bitRate must be number or object which has minBitRate and maxBitRate"),!1}return!0},t.registerCallback=function(t,e,i){var n,r;e.success&&(n=e.success),e.error&&(r=e.error),i[t+"SuccessCallback"]=n,i[t+"ErrorCallback"]=r},t.actionErrorCallback=function(t,e){return e[t+"ErrorCallback"]},t.actionSuccessCallback=function(t,e){return e[t+"SuccessCallback"]},t.getDevices=function(t,e){void 0!==navigator.mediaDevices&&void 0!==navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then(function(e){for(var i=[],n=[],r=[],o=0;o<e.length;o++){var a=e[o];"audioinput"===a.kind&&i.push({deviceName:a.label,deviceID:a.deviceId}),"audiooutput"===a.kind&&n.push({deviceName:a.label,deviceID:a.deviceId}),"videoinput"===a.kind&&r.push({deviceName:a.label,deviceID:a.deviceId})}t&&t({microphones:i,speakers:n,cameras:r})}).catch(function(t){console.error("enumerate devices wrong "+t),e&&e({code:"2000000007",msg:"enumerate devices fail"})}):e&&e({code:"2002000002",msg:"browser do not support"})},t.getServerError=function(t){var e={1:"parse json error.",1001:"login is processing.",1002:"liveroom request error.",1003:"zpush connect fail.",1004:"zpush handshake fail.",1005:"zpush login fail.",1006:"user login state is wrong.",1007:"got no zpush addr",1008:"token error",1009:"dispatch error",1010:"token expired",2002:"biz channel error",1000000000:"liveroom cmd error, code:"};if(0===t)return{code:"ZegoClient.Success",msg:"success"};var i={code:"ZegoClient.Error.Server",msg:""};return i.msg=t>1e9?e[1e9]+t:e[t]?e[t]+" code:"+t:"unknown error code:"+t,i},t.isKeepTryLogin=function(t){switch(t){case 1002:case 1003:return!0;default:return!1}},t.mergeStreamList=function(t,e,i,n,r){t.debug("msl.0 call");var o,a=[],l=[],s=[];n||(n=[]);for(var p=0;p<n.length;p++)if(n[p].anchor_id_name!=e){o=!1;for(var h=0;h<i.length;h++)if(n[p].stream_id===i[h].stream_id){n[p].extra_info!==i[h].extra_info&&s.push(n[p]),o=!0;break}o||a.push(n[p])}else t.debug("msl.0 have self stream added");for(var u=0;u<i.length;u++){o=!1;for(var c=0;c<n.length;c++)if(i[u].stream_id===n[c].stream_id){o=!0;break}o||l.push(i[u])}i.splice(0);for(p=0;p<n.length;p++)i.push(n[p]);r(a,l,s),t.debug("msl.0 call success")},t.checkCustomCommandParam=function(t){return!0},t.generateRandumNumber=function(t){return parseInt(Math.random()*(t+1)+"",10)},t.uuid=function(t,e){var i,n="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),r=[];if(e=e||n.length,t)for(i=0;i<t;i++)r[i]=n[0|Math.random()*e];else{var o=void 0;for(r[8]=r[13]=r[18]=r[23]="-",r[14]="4",i=0;i<36;i++)r[i]||(o=0|16*Math.random(),r[i]=n[19==i?3&o|8:o])}return r.join("")},t.supportDetection=function(t,e,i){var n={webRtc:!1,capture:!1,videoDecodeType:{H264:!1,VP8:!1},screenSharing:t};navigator&&(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.msGetUserMedia||navigator.mozGetUserMedia||navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)&&(n.capture=!0),window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection?(n.webRtc=!0,this.supportVideoCodeType(function(t){n.videoDecodeType.H264=t.H264,n.videoDecodeType.VP8=t.VP8,e&&e(n)},function(t){i&&i(t)})):e&&e(n)},t.compareVersion=function(t,e){t=t.split("."),e=e.split(".");for(var i=Math.max(t.length,e.length);t.length<i;)t.push("0");for(;e.length<i;)e.push("0");for(var n=0;n<i;n++){var r=parseInt(t[n]),o=parseInt(e[n]);if(r>o)return 1;if(r<o)return-1}return 0},t.isSupportLive=function(t,e){var i="当前微信版本过低，无法使用相关组件",n="需要摄像头和录音功能的授权",r=wx.getSystemInfoSync().SDKVersion,o={code:-1,msg:""};this.compareVersion(r,"1.7.0")<0&&(o={code:10001,msg:i},t&&t(o)),wx.getSetting({success:function(e){var i=e.authSetting;i["scope.camera"]&&i["scope.record"]||(o={code:10002,msg:n}),t&&t(o)},fail:function(t){e&&e(t)}})},t.isSupportQQLive=function(t,e){var i="当前微信版本过低，无法使用相关组件",n="需要摄像头和录音功能的授权",r=qq.getSystemInfoSync().SDKVersion,o={code:-1,msg:""};this.compareVersion(r,"1.7.0")<0&&(o={code:10001,msg:i},t&&t(o)),qq.getSetting({success:function(e){var i=e.authSetting;i["scope.camera"]&&i["scope.record"]||(o={code:10002,msg:n}),t&&t(o)},fail:function(t){e&&e(t)}})},t.supportVideoCodeType=function(t,e){var i=!1;new RTCPeerConnection(null).createOffer({offerToReceiveAudio:1,offerToReceiveVideo:1}).then(function(e){if(e&&e.sdp){i=!0;var n=e.sdp.split("\r\n"),r=n.some(function(t){return t.startsWith("a=rtpmap:")&&t.indexOf("H264/")>-1}),o=n.some(function(t){return t.startsWith("a=rtpmap:")&&t.indexOf("VP8/")>-1}),a=n.some(function(t){return t.startsWith("a=rtpmap:")&&t.indexOf("VP9/")>-1}),l=n.some(function(t){return t.startsWith("a=rtpmap:")&&t.indexOf("H264/")>-1});t&&t({H264:r,VP8:o,VP9:a,H265:l})}},function(t){i=!0,clearTimeout(n),e&&e(t)});var n=setTimeout(function(){0==i&&e(!1)},200)},t.inlineWorker=function(t){if(Worker){var e=t.toString().trim().match(/^function\s*\w*\s*\([\w\s,]*\)\s*{([\w\W]*?)}$/)[1],i=URL.createObjectURL(new window.Blob([e],{type:"text/javascript"}));return new Worker(i)}return null},t}();e.ClientUtil=n},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e){this.RETRY_MAX_TIME=300,this.RETRY_START_TIME_INTERVAL=4,this.RETRY_CONTINUE_COUNT=2,this.RETRY_MAX_TIME_INTERVAL=32,this.retryStartTime=0,this.retryActiveCount=1,this.isOverTime=!1}return t.prototype.init=function(t,e,i,n){this.invalid(),this.stopMaxTime(),this.isOverTime=!1,"number"==typeof t&&t<3600&&(this.RETRY_MAX_TIME=t),"number"==typeof e&&(this.RETRY_START_TIME_INTERVAL=e),"number"==typeof i&&(this.RETRY_CONTINUE_COUNT=i),"number"==typeof n&&(this.RETRY_MAX_TIME_INTERVAL=n)},t.prototype.invalid=function(){this.retryTimer&&clearTimeout(this.retryTimer),this.retryTimer=null,this.retryStartTime=0,this.retryActiveCount=1},t}();e.TryHandler=n},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e){this.audioBufferList=[],this.loop=!1,this.replace=!1,this.effectEndedCallBack=null,this.effectEndedListener=null,this.startTimes=0,this.startOffset=0,this.pauseTimes=0,this.resumeOffset=0,this.isMixAudio=!1,this.isMixingBuffer=!1,this.logger=t,this.ac=e}return t.prototype.preloadEffect=function(t,e){var i=this;this.logger.info("amu.pe.0 start preload effect");var n=new XMLHttpRequest;n.open("GET",t,!0),n.responseType="arraybuffer",n.onload=function(){if(200==n.status||304==n.status){var t=n.response;i.ac.decodeAudioData(t,function(t){i.logger.info("amu.pe.0 effect preload success"),e("",t)},function(t){e(t)})}else{var r=n.statusText;e(r)}},n.send()},t.prototype.playEffect=function(t,e,i,n,r){var o=this;!0!==this.isMixAudio?this.audioBuffer?(this.startOffset=t||0,this.loop=e||!1,this.replace=i||!1,this.effectEndedCallBack=r,this.mixEffect(this.audioBuffer,function(){o.buffSource.loop=!!e,t?o.buffSource.start(0,t/1e3):o.buffSource.start(0),o.startTimes=Date.now(),o.effectEndedListener=o.effectEndedHandler.bind(o),o.buffSource.addEventListener("ended",o.effectEndedListener),n&&n()})):this.logger.error("amu.pe.1 no audio buffer found"):this.logger.error("amu.pe.1 audio is mixing")},t.prototype.mixingBuffer=function(t,e){var i=this;!0!==this.isMixAudio||0!=this.audioBufferList.length||0!=this.isMixingBuffer?this.ac.decodeAudioData(t,function(t){i.audioBufferList.push(t),1==i.audioBufferList.length&&i.playRealTimeEffect(i.audioBufferList[0]),i.isMixingBuffer=!0,e&&e()},function(t){i.logger.error("amu.mb.0 "+t),e&&e(t)}):this.logger.error("amu.mb.0 audio is mixing")},t.prototype.stopMingBuffer=function(){return this.isMixingBuffer=!1,this.stopMixingAudio()},t.prototype.playRealTimeEffect=function(t){var e=this;this.mixEffect(t,function(){e.buffSource.start(0),e.buffSource.addEventListener("ended",function(){e.audioBufferList.shift(),e.audioBufferList.length>0&&e.isMixAudio&&e.playRealTimeEffect(e.audioBufferList[0])})})},t.prototype.pauseEffect=function(){this.audioBufferList.length>0?this.logger.error("amu.pe.0 real time buffer can not be paused"):(this.stopMixingAudio(),this.resumeOffset=(this.pauseTimes-this.startTimes+this.startOffset)%(1e3*this.audioBuffer.duration))},t.prototype.resumeEffect=function(){this.audioBufferList.length>0?this.logger.error("amu.pe.0 real time buffer can not be resume"):(this.playEffect(this.resumeOffset,this.loop,this.replace,null,this.effectEndedCallBack),this.startOffset=this.resumeOffset)},t.prototype.mixEffect=function(t,e){this.localStream?(this.gainNode=this.ac.createGain(),this.buffSource=this.ac.createBufferSource(),this.buffSource.buffer=t,this.buffSource.connect(this.gainNode),this.gainNode.connect(this.ac.destination),this.replaceTrack()&&e()):this.logger.error("amu.me.0 localStream can not be found")},t.prototype.startMixingAudio=function(t,e){return this.replace=e||!1,this.isMixAudio?(this.logger.error("amu.sma.0 audio is mixing"),!1):this.localStream?(t.captureStream=t.captureStream||t.mozCaptureStream||t.webkitCaptureStream,this.gainNode=this.ac.createGain(),this.mixAudio=this.ac.createMediaStreamSource(t.captureStream()),this.mixAudio.connect(this.gainNode),this.replaceTrack()):(this.logger.error("amu.sma.0 localStream can not be found"),!1)},t.prototype.replaceTrack=function(){this.streamSource=this.ac.createMediaStreamSource(this.localStream),this.destination=this.ac.createMediaStreamDestination(),!this.replace&&this.streamSource.connect(this.destination),this.gainNode.connect(this.destination);var t=this.destination.stream.getAudioTracks()[0],e=this.peerConnection.getSenders().find(function(e){return e.track.kind===t.kind});if(!e)return this.logger.error("amu.rt.0 no sender"),!1;var i=this.localStream.getAudioTracks()[0];return e.replaceTrack(t),this.localStream.removeTrack(i),this.localStream.addTrack(t),this.isMixAudio=!0,!0},t.prototype.stopMixingAudio=function(){return this.isMixAudio?this.localStream?(this.mixAudio?(this.mixAudio.disconnect(this.gainNode),this.mixAudio=null):this.buffSource&&(this.buffSource.removeEventListener("ended",this.effectEndedListener),this.buffSource.stop(),this.pauseTimes=Date.now(),this.buffSource.disconnect(this.gainNode),this.buffSource=null),this.gainNode.disconnect(this.destination),this.isMixAudio=!1,this.audioBufferList=[],!0):(this.logger.error("amu.sma.1 localStream can not be found"),!1):(this.logger.error("amu.sma.1 no mixing audio found"),!1)},t.prototype.setMixingAudioVolume=function(t){if(!this.gainNode)return this.logger.error("amu.sma.2 no mixing audio found"),!1;this.gainNode.gain.value=t},t.prototype.effectEndedHandler=function(){this.stopMixingAudio(),this.effectEndedCallBack&&this.effectEndedCallBack()},t}();e.audioMixUtil=n},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.zegoSdp=function(t){var e=t.split("\r\n"),i=[],n=[];e.forEach(function(t){var e=t.match(/a=rtpmap:(\d+)\s+((H264\/90000)|(opus\/48000\/2))/);e&&e[1]&&e[2]&&("H264/90000"===e[2]&&i.push(e[1]),"opus/48000/2"===e[2]&&n.push(e[1]))});var r=[];return e.map(function(t){var e=!0,o=t.match(/((a=rtcp-fb:)|(a=rtpmap:)|(a=fmtp:))(\d+)/);if(o&&o[5]&&(i.concat(n).some(function(t){return t==o[5]})||(e=!1)),t.indexOf("m=video")>-1){var a=t.split(" ");t=[a[0],a[1],a[2]].concat(i).join(" ")}else if(t.indexOf("m=audio")>-1){a=t.split(" ");t=[a[0],a[1],a[2]].concat(n).join(" ")}e&&r.push(t)}),r.join("\r\n")},t.getSDPByVideDecodeType=function(t,e){var i={str:"",arr:[],obj:{H264:[],H265:[],VP8:[],VP9:[],OHTER:[]}};if(!t.includes("m=video"))return t;var n=/m=video.+/.exec(t)[0];n=n.match(/[\s|\d]+/g)[1].replace(" ",""),i.str=n,i.arr=i.str.split(" "),i.arr.forEach(function(e){var n=new RegExp("a=rtpmap:"+e+".+").exec(t)[0];n.includes("H264")?i.obj.H264.push(e):n.includes("H265")?i.obj.H265.push(e):n.includes("VP8")?i.obj.VP8.push(e):n.includes("VP9")?i.obj.VP9.push(e):i.obj.OHTER.push(e)}),i.obj.OHTER.forEach(function(e){var n=new RegExp("a=fmtp:"+e+".+apt=(\\d+)").exec(t),r=n&&n[1];r&&(i.obj.H264.includes(r)?i.obj.H264.push(e):i.obj.H265.includes(r)?i.obj.H265.push(e):i.obj.VP8.includes(r)?i.obj.VP8.push(e):i.obj.VP9.includes(r)&&i.obj.VP9.push(e))});var r=[];return"VP9"===e?r=i.obj.H265.concat(i.obj.H264,i.obj.VP8):"VP8"===e?r=i.obj.H265.concat(i.obj.H264,i.obj.VP9):"H264"===e?r=i.obj.H265.concat(i.obj.VP8,i.obj.VP9):"H265"===e&&(r=i.obj.VP8.concat(i.obj.H264,i.obj.VP9)),r.forEach(function(e){var n=i.arr.indexOf(e);i.arr.splice(n,1);var r=new RegExp("a=rtpmap:"+e+".+\\s\\n","g"),o=new RegExp("a=rtcp-fb:"+e+".+\\s\\n","g"),a=new RegExp("a=fmtp:"+e+".+\\s\\n","g");t=(t=(t=t.replace(r,"")).replace(o,"")).replace(a,"")}),t=t.replace(n,i.arr.join(" "))},t}();e.sdpUtil=n},function(t,e,i){"use strict";var n,r=this&&this.__extends||(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])},function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}),o=this&&this.__assign||Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},a=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(r,o){function a(t){try{s(n.next(t))}catch(t){o(t)}}function l(t){try{s(n.throw(t))}catch(t){o(t)}}function s(t){t.done?r(t.value):new i(function(e){e(t.value)}).then(a,l)}s((n=n.apply(t,e||[])).next())})},l=this&&this.__generator||function(t,e){var i,n,r,o,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function l(o){return function(l){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(r=(r=a.trys).length>0&&r[r.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(t){o=[6,t],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,l])}}};Object.defineProperty(e,"__esModule",{value:!0});var s=i(0),p=i(1),h=i(7),u=i(9),c=i(2),f=i(4),v=i(19),T=i(28),d=i(29),E=i(30),S=function(t){function e(){var e=t.call(this)||this;return e.logger=new h.LoggerWeb,e.dataReport=new E.ZegoDataReport(e.logger),e.ac=new("undefined"!=typeof webkitAudioContext?webkitAudioContext:AudioContext),e.stateCenter=new T.StateCenter,e.streamCenter=new u.ZegoStreamCenterWeb(e.logger,e.stateCenter,e.ac,e.dataReport),e.audioMixing=new f.audioMixUtil(e.logger,e.ac),e.init(),e.bindWindowListener(),e.streamCenter.socketCenter=e.socketCenter,e}return r(e,t),e.prototype.getSocket=function(t){return new WebSocket(t)},e.prototype.enableCamera=function(t,e){return this.logger.debug("zc.p.ec.0 call"),"boolean"!=typeof e?(this.logger.error("zc.p.ec.0 argument is not bool"),!1):this.streamCenter.enableCamera(t,e)},e.prototype.enableMicrophone=function(t,e){return this.logger.debug("zc.p.em.0 call"),"boolean"!=typeof e?(this.logger.error("zc.p.em.0 argument is not bool"),!1):this.streamCenter.enableMicrophone(t,e)},e.prototype.setLocalAudioOutput=function(t,e){return this.logger.debug("zc.p.slao call"),"string"!=typeof e?(console.error("audiooutput is not string"),!1):this.streamCenter.setStreamAudioOutput(t,e)},e.prototype.setPlayAudioOutput=function(t,e){return this.logger.debug("zc.p.spao call"),"string"!=typeof e?(console.error("audiooutput is not string"),!1):this.streamCenter.setPlayStreamAudioOutput(t,e)},e.prototype.setCustomSignalUrl=function(t){if(this.logger.debug("zc.p.scs.0 call: "+t),!t||0==t.length)return this.logger.error("zc.p.scs.0 param error"),!1;var e=!0;if(t.forEach(function(t){return 0!=t.indexOf("wss://")&&(e=!1)}),!e)return this.logger.error("zc.p.scs.0 url is not correct"),!1;this.stateCenter.customUrl=t},e.prototype.setQualityMonitorCycle=function(t){"number"==typeof t&&t>=1e3&&this.streamCenter.setQualityMonitorCycle(t)},e.prototype.startPlayingStream=function(t,e,i,n){var r=this;this.logger.info("zc.p.sps.0 call streamid "+t);var o=p.getSeq();if(this.dataReport.newReport(o),!t||""===t)return this.logger.error("zc.p.sps.0 param error"),this.dataReport.uploadReport(o,"/sdk/play","ZegoClient.Error.Param"),!1;if(!e)return this.logger.error("zc.p.sps.0 don't have remoteVideo"),this.dataReport.uploadReport(o,"/sdk/play","ZegoClient.Error.Param"),!1;if(this.stateCenter.customUrl)return this.streamCenter.setPlayStateStart(t,e,i,n)?(this.streamCenter.playerList[t].reportSeq=o,this.streamCenter.startPlayingStream(t,this.stateCenter.customUrl)):(this.logger.error("zc.p.sps.0 cannot start play"),!1);if(!this.stateCenter.isLogin())return this.logger.error("zc.p.sps.0 not login"),this.dataReport.uploadReport(o,"/sdk/play","ZegoClient.Error.NoLogin"),!1;for(var a=!1,l=0;l<this.stateCenter.streamList.length;l++)if(this.stateCenter.streamList[l].stream_id===t){a=!0;break}if(0==a&&this.logger.info("zc.p.sps.0 cannot find stream"),this.stateCenter.pullLimited||(t=NaN+t),!this.streamCenter.setPlayStateStart(t,e,i,n))return this.logger.info("zc.p.sps.0 cannot start play"),this.dataReport.uploadReport(o,"/sdk/play","ZegoClient.Error.Play"),!1;this.streamCenter.playerList[t].reportSeq=o,this.socketCenter.registerRouter("webrtc_url",function(t){r.handleFetchWebRtcUrlRsp(t)});var h=this.streamCenter.playerList[t].tryDispatchHandler;return h.stopMaxTime(),h.invalid(),h.initStream(t,n,!1),h.onactive=function(e,i){r.dataReport.uploadReport(o,"/sdk/play",i.code),i==s.sdkErrorList.SEND_MSG_TIMEOUT?r.onPlayStateUpdate(s.ENUM_PLAY_STATE_UPDATE.error,t,p.playErrorList.DISPATCH_TIMEOUT):r.onPlayStateUpdate(s.ENUM_PLAY_STATE_UPDATE.error,t,p.playErrorList.DISPATCH_ERROR)},h.startMaxTime(),h.active(0)},e.prototype.stopPlayingStream=function(t){if(this.logger.info("zc.p.sps.1.0 call"),!t||""===t)return this.logger.info("zc.p.sps.1.0 param error"),!1;for(var e in this.streamCenter.stopPlayingStream(t),this.stateCenter.streamUrlMap)if(this.stateCenter.streamUrlMap[e]===t){delete this.stateCenter.streamUrlMap[e];break}return this.logger.debug("zc.p.sps.1.0 call success"),!0},e.prototype.startPreview=function(t,e,i,n){if(this.logger.debug("zc.p.sp.0 call"),!t)return this.logger.error("zc.p.sp.0 no localVideo"),!1;if(e.audioBitRate){if("number"!=typeof e.audioBitRate)return void this.logger.error("zc.p.sp.0 audioBitRate must be number");if(e.audioBitRate<6e3||e.audioBitRate>51e4)return void this.logger.error("zc.p.sp.0 audioBitRate cannot less 6k or over 510k")}if(!e.channelCount||1===e.channelCount||2===e.channelCount)return!!c.ClientUtil.checkPreviewParam(e,this.logger)&&this.streamCenter.startPreview(t,e,i,n);this.logger.error("zc.p.sp.0 channelCount must number 1 or 2")},e.prototype.stopPreview=function(t){return this.logger.debug("zc.p.sp.1 call"),t?this.streamCenter.stopPreview(t):(this.logger.info("zc.p.sp.1 param error"),!1)},e.prototype.startPublishingStream=function(t,e,i,n){var r=this;this.logger.info("zc.p.sps.1 call streamid: "+t);var o=p.getSeq();if(this.dataReport.newReport(o),!t)return this.logger.error("zc.p.sps.1 param error"),this.dataReport.uploadReport(o,"/sdk/publish","ZegoClient.Error.Param"),!1;if(!this.streamCenter.checkPreview(e))return this.logger.error("zc.p.sps.1 need preview before publish"),this.dataReport.uploadReport(o,"/sdk/publish","ZegoClient.Error.Param"),!1;if(i&&("string"!=typeof i||""==i))return this.logger.error("zc.p.sps.1 extreaInfo must be string and not empty"),this.dataReport.uploadReport(o,"/sdk/publish","ZegoClient.Error.Param"),!1;if(n||(n={}),this.stateCenter.customUrl&&0!=this.stateCenter.customUrl.length)return this.stateCenter.publishStreamList[t]={state:s.ENUM_PUBLISH_STREAM_STATE.tryPublish,extra_info:i},this.streamCenter.setPublishStateStart(t,e,n)?(this.streamCenter.publisherList[t].reportSeq=o,this.streamCenter.startPublishingStream(t,this.stateCenter.customUrl)):(this.logger.info("zc.p.sps.1 cannot start publish"),!1);if(!this.stateCenter.isLogin())return this.logger.error("zc.p.sps.1 not login"),this.dataReport.uploadReport(o,"/sdk/publish","ZegoClient.Error.NoLogin"),!1;if(this.stateCenter.publishStreamList[t]={state:s.ENUM_PUBLISH_STREAM_STATE.tryPublish,extra_info:i},!this.streamCenter.setPublishStateStart(t,e,n))return this.logger.error("zc.p.sps.1 cannot start publish"),this.dataReport.uploadReport(o,"/sdk/publish","ZegoClient.Error.Publish"),!1;this.streamCenter.publisherList[t].reportSeq=o,this.logger.info("zc.p.sps.1 start publish"),this.socketCenter.registerRouter("webrtc_url",function(t){r.handleFetchWebRtcUrlRsp(t)});var a=this.streamCenter.publisherList[t].tryDispatchHandler;return a.stopMaxTime(),a.invalid(),a.initStream(t,n,!0),a.onactive=function(e,i){r.dataReport.uploadReport(o,"/sdk/publish",i.code),i==s.sdkErrorList.SEND_MSG_TIMEOUT?r.onPublishStateUpdate(s.ENUM_PUBLISH_STATE_UPDATE.error,t,p.publishErrorList.DISPATCH_TIMEOUT):r.onPublishStateUpdate(s.ENUM_PUBLISH_STATE_UPDATE.error,t,p.publishErrorList.DISPATCH_ERROR)},a.startMaxTime(),a.active(0)},e.prototype.stopPublishingStream=function(t){if(this.logger.info("zc.p.sps.1.1 call streamid: "+t),!t)return this.logger.info("zc.p.sps.1.1 param error"),!1;if(this.streamCenter.stopPublishingStream(t),this.stateCenter.publishStreamList[t]){if(this.stateCenter.publishStreamList[t].state>s.ENUM_PUBLISH_STREAM_STATE.waiting_url){this.streamHandler.updateStreamInfo(t,s.ENUM_STREAM_SUB_CMD.liveEnd);for(var e=0;e<this.stateCenter.streamList.length;e++)if(this.stateCenter.streamList[e].stream_id==t){this.stateCenter.streamList.splice(e--,1);break}}delete this.stateCenter.publishStreamList[t]}return!0},e.prototype.preloadEffect=function(t,e,i){var n=this;t&&"number"==typeof t&&e&&"string"==typeof e?this.stateCenter.audioEffectBuffer[t]?this.logger.error("zc.pe.0 audio buffer already exists"):this.audioMixing.preloadEffect(e,function(e,r){if(e)return n.logger.error("zc.pe.0 effect preload fail "+e),void(i&&i(e));r&&(n.stateCenter.audioEffectBuffer[t]=r,i&&i())}):this.logger.error("zc.pe.0 params error")},e.prototype.playEffect=function(t,e,i){if(t.streamId&&"string"==typeof t.streamId&&t.effectId&&"number"==typeof t.effectId)if(this.stateCenter.audioEffectBuffer[t.effectId]){var n=this.stateCenter.audioEffectBuffer[t.effectId],r=this.getPublisher(t.streamId);r?n?r.playEffect(t,n,e,i):this.logger.error("zc.pe.1 no audio buffer found"):this.logger.error("zc.pe.1 publisher doesn't exist")}else this.logger.error("zc,pe.1 audio buffer dosesn't exists");else this.logger.error("zc.pe.1 params error")},e.prototype.pauseEffect=function(t){if(t&&"string"==typeof t){var e=this.getPublisher(t);e?e.pauseEffect():this.logger.error("zc.pe.2 publisher doesn't exist")}else this.logger.error("zc.pe.2 streamid format error")},e.prototype.resumeEffect=function(t){if(t&&"string"==typeof t){var e=this.getPublisher(t);e?e.resumeEffect():this.logger.error("zc.re.0 publisher doesn't exist")}else this.logger.error("zc.re.0 streamid format error")},e.prototype.unloadEffect=function(t){return t&&"number"==typeof t?(delete this.stateCenter.audioEffectBuffer[t],!0):(this.logger.error("zc.ue.0 params error"),!1)},e.prototype.startMixingAudio=function(t,e,i){return this.logger.debug("zc.sma.0 call"),t&&"string"==typeof t?e?Array.isArray(e)&&0!==e.length?this.streamCenter.startMixingAudio(t,e):e instanceof HTMLMediaElement?this.streamCenter.startMixingAudio(t,[e]):(this.logger.error("zc.sma.0 audio param type error"),!1):(this.logger.error("zc.sma.0 no audio"),!1):(this.logger.error("zc.sma.0 stream id type error"),!1)},e.prototype.stopMixingAudio=function(t,e){return t&&"string"==typeof t?Array.isArray(e)&&0!==e.length||void 0===e?this.streamCenter.stopMixingAudio(t,e):(this.logger.error("zc.sma.0 audio param type error"),!1):(this.logger.error("zc.sma.1 param streamID format error"),!1)},e.prototype.mixingBuffer=function(t,e,i,n){var r=this.getPublisher(t);r?i instanceof ArrayBuffer?r.mixingBuffer(i,n):this.logger.error("zc.mb.0 array buffer not found"):this.logger.error("zc.mb.0 publisher doesn't exist")},e.prototype.stopMixingBuffer=function(t,e){if(!t||"string"!=typeof t)return this.logger.error("zc.sma.1 param streamid format error"),!1;var i=this.getPublisher(t);return i?i.stopMixingBuffer():(this.logger.error("zc.sma.1 publisher doesn't exist"),!1)},e.prototype.setMixingAudioVolume=function(t,e){if(this.logger.debug("zc.sma.2 call"),!t||"string"!=typeof t||"number"!=typeof e||e<0||e>100)return this.logger.error("zc.sma.2 param error"),!1;var i=this.getPublisher(t);return i?i.audioMixing.setMixingAudioVolume(e/100):(this.logger.error("zc.sma.2 publisher doesn't exist"),!1)},e.prototype.getPublisher=function(t){var e=null;return this.streamCenter.publisherList[t]&&this.streamCenter.publisherList[t].publisher&&(e=this.streamCenter.publisherList[t].publisher),e},e.prototype.startScreenShotChrome=function(t){if(!e.screenShotReady)return this.logger.error('zc.b.ss Please install the extension:1. Go to chrome://extensions  2. Check: "Enable Developer mode   3. Click: "Load the unpacked extension... 4. Choose "extension" folder from the repository 5. Reload this page'),!1;window.postMessage({type:"SS_UI_REQUEST",text:"start"},"*"),c.ClientUtil.registerCallback("screenShare",{success:t},this.stateCenter.callbackList)},e.prototype.startScreenSharing=function(t,e,i){var n=this;"getDisplayMedia"in navigator.mediaDevices?navigator.mediaDevices.getDisplayMedia({audio:e,video:{width:t.width||window.screen.width,height:t.height||window.screen.height,frameRate:t.frameRate||15,displaySurface:t.displaySurface||"minitor"}}).then(function(t){n.stateCenter.screenShotStreamList.push({stream:t,type:0,micTrack:t.getAudioTracks().length>0?t.getAudioTracks()[0]:null}),t.getVideoTracks()[0].onended=function(){var e=n.stateCenter.screenShotStreamList.findIndex(function(e){return e.stream===t});if(e>-1){var i=n.stateCenter.screenShotStreamList[e].micTrack;i&&i.stop(),n.stateCenter.screenShotStreamList.splice(e,1)}n.onScreenSharingEnded(t)},i(!0,t)}).catch(function(t){n.logger.error("zc.b.sss "+t),i(!1,null,t)}):this.logger.error("zc.b.sss getDisplayMedia is not supported ")},e.prototype.startScreenShotFirFox=function(t,e,i,n){var r=this,o={video:{width:t.width||window.screen.width,height:t.height||window.screen.height,frameRate:t.frameRate||15},audio:i};o.video.mediaSource=e,navigator.mediaDevices.getUserMedia(o).then(function(t){r.stateCenter.screenShotStreamList.push({stream:t,type:0,micTrack:t.getAudioTracks().length>0?t.getAudioTracks()[0]:null}),t.getVideoTracks()[0].onended=function(){var e=r.stateCenter.screenShotStreamList.findIndex(function(e){return e.stream===t});if(e>-1){var i=r.stateCenter.screenShotStreamList[e].micTrack;i&&i.stop(),r.stateCenter.screenShotStreamList.splice(e,1)}r.onScreenSharingEnded(t)},n(!0,t)}).catch(function(t){r.logger.error("zc.b.ssf "+t),n(!1,null)})},e.prototype.stopScreenShot=function(t){var e=this,i=[];void 0===t?i=this.stateCenter.screenShotStreamList.slice():i.push({stream:t,type:-1}),i.forEach(function(t){var i=e.stateCenter.screenShotStreamList.findIndex(function(e){return e.stream===t.stream}),n=e.stateCenter.screenShotStreamList[i];n&&(n.stream.getTracks().forEach(function(t){t.stop()}),n.micTrack&&n.micTrack.stop(),1===n.type&&window.postMessage({type:"SS_UI_CANCEL",text:"start"},"*"),e.stateCenter.screenShotStreamList.splice(i,1))})},e.prototype.switchDevice=function(t,e,i,n,r){var o=this;"audio"!==t&&"video"!==t||"string"!=typeof i?this.logger.error("zg.sd.0 param error"):this.enumDevices(function(a){var l=a.cameras,s=a.microphones;l.find(function(t){return t.deviceId==i})||s.find(function(t){return t.deviceId==i})?o.streamCenter.switchDevice(t,e,i,n,r):o.logger.error("zg.sd.0 can not switch device")},function(t){return r&&r(t)})},e.prototype.WebrtcOnPublishStateUpdateHandle=function(t,e,i){this.stateCenter.publishStreamList[e].state==s.ENUM_PUBLISH_STREAM_STATE.publishing&&this.onPublishStateUpdate(t,e,i)},e.prototype.setCDNInfo=function(t,e){t.urls_flv=e.urls_flv,t.urls_hls=e.urls_m3u8,t.urls_https_flv=e.urls_https_flv,t.urls_https_hls=e.urls_https_m3u8,t.urls_rtmp=e.urls_rtmp},e.prototype.onScreenSharingEnded=function(t){},e.prototype.loginBodyData=function(){return{id_name:this.stateCenter.idName,nick_name:this.stateCenter.nickName,role:this.stateCenter.role,token:this.stateCenter.token,version:s.PROTO_VERSION,room_name:this.stateCenter.roomid,user_state_flag:this.stateCenter.userStateUpdate?1:0,room_create_flag:this.stateCenter.roomCreateFlag,client_type:s.E_CLIENT_TYPE.ClientType_Webrtc,third_token:this.stateCenter.third_token}},e.prototype.screenStreamFrom=function(t,e,i){var n=this,r={};r.audio={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t}},r.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxWidth:window.screen.width,maxHeight:window.screen.height}},!e&&(r.audio=!1),navigator.mediaDevices.getUserMedia(r).then(function(t){n.stateCenter.screenShotStreamList.push({stream:t,type:1,micTrack:t.getAudioTracks().length>0?t.getAudioTracks()[0]:null}),t.getVideoTracks()[0].onended=function(){var e=n.stateCenter.screenShotStreamList.findIndex(function(e){return e.stream===t});if(e>-1){var i=n.stateCenter.screenShotStreamList[e].micTrack;i&&i.stop(),n.stateCenter.screenShotStreamList.splice(e,1)}n.onScreenSharingEnded(t)},i(!0,t)}).catch(function(t){n.logger.error("zc.b.ssf "+t),i(!1,null,t)})},e.prototype.filterStreamList=function(t){var e={},i={},n={},r=[],o=0;for(var a in this.stateCenter.streamList.forEach(function(e,i){e.stream_id==t&&(o=i)}),this.stateCenter.streamList[o])"urls_flv"!=a&&"urls_https_flv"!=a||(e[a]=this.stateCenter.streamList[o][a]),"urls_m3u8"!=a&&"urls_https_m3u8"!=a||(i[a]=this.stateCenter.streamList[o][a]),"urls_rtmp"==a&&(n[a]=this.stateCenter.streamList[o][a]);var l=window.location.protocol,s=window.navigator.userAgent;if(/Safari/.test(s)&&!/Chrome/.test(s))for(var a in i)i[a]&&i[a].forEach(function(t){-1!==t.indexOf(l)&&r.push(t)});else if("http:"==l)for(var a in e)e[a]&&e[a].forEach(function(t){-1===t.indexOf("http")&&-1===t.indexOf("https")||r.push(t)});else if("https:"==l)for(var a in e)e[a]&&e[a].forEach(function(t){-1!==t.indexOf(l)&&r.push(t)});else if("rtmp:"==l)for(var a in n)n[a]&&n[a].forEach(function(t){-1!==t.indexOf(l)&&r.push(t)});return r.filter(function(t,e,i){return i.indexOf(t)==e})},e.prototype.voiceChange=function(t,e){return t&&"number"==typeof t?e&&"string"==typeof e?this.getPublisher(e).voiceChange(t):(this.logger.error("zc.vc.0 stream id error"),!1):(this.logger.error("zc.vc.0 mult error"),!1)},e.prototype.voiceBack=function(t){return this.getPublisher(t).voiceBack()},e.prototype.setPublishStreamConstraints=function(t,e,i,n){this.logger.info("zc.spsc.0 call"),"string"==typeof t&&""!=t?this.streamCenter.setPublishStreamConstraints(t,e,i,n):this.logger.error("zc.spsc.0 stream ID must be string and not empty")},e.prototype.setSoundLevelDelegate=function(t,e){this.logger.info("zc.ssd.0 call"),"boolean"==typeof t?e&&("number"!=typeof e||e<100||e>3e3)?this.logger.error("zc.ssd.0 soundLevel interval must be number which is between 100 and 3000"):this.streamCenter.setSoundLevelDelegate(t,e):this.logger.error("zc.ssd.0 param 1 must be boolean")},e.supportDetection=function(t,e){navigator&&navigator.mediaDevices&&(this.screenShotReady||"getDisplayMedia"in navigator.mediaDevices)?c.ClientUtil.supportDetection(!0,t,e):c.ClientUtil.supportDetection(!1,t,e)},e.prototype.enumDevices=function(t,i){e.enumDevices(t,i)},e.enumDevices=function(t,e){void 0!==navigator.mediaDevices&&void 0!==navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then(function(e){for(var i=[],n=[],r=[],o=0;o<e.length;o++){var a=e[o];"audioinput"===a.kind&&i.push({label:a.label,deviceId:a.deviceId}),"audiooutput"===a.kind&&n.push({label:a.label,deviceId:a.deviceId}),"videoinput"===a.kind&&r.push({label:a.label,deviceId:a.deviceId})}t&&t({microphones:i,speakers:n,cameras:r})}).catch(function(t){e&&e(t)}):e&&e("browser don't support enumerate devices")},e.getAudioInfo=function(t,e,i){if(!t.srcObject)return console.error("srcObject is empty!"),!1;var n=o({},i);return new d.MediaUtil(n).connectToSource(t.srcObject,function(t){e(t)})},e.handleDataAvailable=function(t){t.data&&t.data.size>0&&e.recordedBlobs.push(t.data)},e.startRecord=function(t,i,n){return a(this,void 0,void 0,function(){var r,o;return l(this,function(a){switch(a.label){case 0:return e.recordedBlobs=[],o={mimeType:"video/webm;codecs=vp9"},MediaRecorder.isTypeSupported(o.mimeType)||(o={mimeType:"video/webm;codecs=vp8"},MediaRecorder.isTypeSupported(o.mimeType)||(o={mimeType:"video/webm"},MediaRecorder.isTypeSupported(o.mimeType)||(o={mimeType:""}))),i&&i.audio?(o={mimeType:"audio/webm"},MediaRecorder.isTypeSupported(o.mimeType)||(o={mimeType:""}),[4,navigator.mediaDevices.getUserMedia({audio:{deviceId:i.audioInput?i.audioInput:""}})]):[3,2];case 1:return r=a.sent(),e.recordType="audio",[3,3];case 2:r=t.captureStream(),a.label=3;case 3:try{e.mediaRecorder=new MediaRecorder(r,o)}catch(t){return console.error("Exception while creating MediaRecorder:",t),n&&n(t),[2]}return e.mediaRecorder.onstop=function(t){console.log("Recorder stopped: ",t),i&&i.audio&&r.getTracks().forEach(function(t){return t.stop()})},e.mediaRecorder.ondataavailable=e.handleDataAvailable,e.mediaRecorder.start(10),n&&n(),[2]}})})},e.stopRecord=function(){e.mediaRecorder?e.mediaRecorder.stop():console.warn("please invoke startRecord first")},e.resumeRecord=function(){e.mediaRecorder?e.mediaRecorder.resume():console.warn("please invoke startRecord first")},e.pauseRecord=function(){e.mediaRecorder?e.mediaRecorder.pause():console.warn("please invoke startRecord first")},e.saveRecord=function(t){if(e.mediaRecorder&&e.recordedBlobs){var i=new Blob(e.recordedBlobs,{type:"video"===e.recordType?"video/webm":"audio/webm"}),n=window.URL.createObjectURL(i);if("string"==typeof t&&""!==t){var r=document.createElement("a");r.style.display="none",r.href=n,r.download=t+".webm",document.body.appendChild(r),r.click(),setTimeout(function(){document.body.removeChild(r),window.URL.revokeObjectURL(n)},100)}return n}console.warn("please invoke startRecord first")},e.resumeRecordAudio=function(){e.mediaRecorder?e.mediaRecorder.resume():console.warn("please invoke startRecordAudio first")},e.pauseRecordAudio=function(){e.mediaRecorder?e.mediaRecorder.pause():console.warn("please invoke startRecordAudio first")},e.getRecordAudio=function(){if(e.mediaRecorder&&e.recordedBlobs){var t=new Blob(e.recordedBlobs);return window.URL.createObjectURL(t)}console.warn("please invoke startRecordAudio first")},e.takeSnapShot=function(t,e){if(t&&0!==t.videoHeight){var i=document.createElement("canvas");i.width=t.videoWidth,i.height=t.videoHeight,i.getContext("2d").drawImage(t,0,0,i.width,i.height),e.src=i.toDataURL("image/jpeg")}else console.error("video can not empty")},e.saveSnapShot=function(t,e){if(t&&0!==t.videoHeight){var i=document.createElement("canvas");i.width=t.videoWidth,i.height=t.videoHeight,i.getContext("2d").drawImage(t,0,0,i.width,i.height),i.toBlob(function(t){var i=window.URL.createObjectURL(t),n=document.createElement("a");n.style.display="none",n.href=i,n.download=e+".jpeg",document.body.appendChild(n),n.click(),setTimeout(function(){document.body.removeChild(n),window.URL.revokeObjectURL(i)},100)})}else console.error("video can not empty")},e.prototype.bindWindowListener=function(){var t=this,e=navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPhone/i)?"pagehide":"beforeunload";window.addEventListener(e,function(e){window.event.cancelBubble=!0,t.logout()}),window.addEventListener("message",function(e){var i=e.data,n=i.type,r=i.streamId,o=i.canRequestAudioTrack;e.origin;"SS_DIALOG_SUCCESS"===n&&t.screenStreamFrom(r,o,c.ClientUtil.actionSuccessCallback("screenShare",t.stateCenter.callbackList)),"SS_DIALOG_CANCEL"===n&&(t.logger.error("zc.b.ss "+n),c.ClientUtil.actionSuccessCallback("screenShare",t.stateCenter.callbackList)(!1,null,n))}),window.addEventListener("offline",function(e){for(var i in t.logger.info("zc.off.0 newtwork is broken"),t.stateCenter.networkState=s.ENUM_NETWORK_STATE.offline,t.stateCenter.roomTryHandler&&(t.stateCenter.roomTryHandler.invalid(),t.stateCenter.roomTryHandler.onactive=function(e,i){t.disconnectedHandle(i)},t.stateCenter.roomTryHandler.startMaxTime(),t.onTempBroken()),t.streamCenter.publisherList){(n=t.streamCenter.publisherList[i].streamTryHandler).startMaxTime(),n.invalid()}for(var i in t.streamCenter.playerList){var n;(n=t.streamCenter.playerList[i].streamTryHandler).startMaxTime(),n.invalid()}}),window.addEventListener("online",function(e){if(t.logger.info("zc.on.0 network is online"),t.stateCenter.networkState=s.ENUM_NETWORK_STATE.online,t.stateCenter.roomTryHandler&&t.socketCenter.isDisConnect())t.stateCenter.roomTryHandler.active();else if(t.stateCenter.roomTryHandler)for(var i in t.stateCenter.roomTryHandler.stopMaxTime(),t.streamCenter.publisherList)for(var n=t.streamCenter.publisherList[i].publisher,r=0;r<t.stateCenter.streamList.length;r++)if(n.state==s.ENUM_PUBLISH_STATE.stop&&t.stateCenter.streamList[r].stream_id==i){t.streamHandler.updateStreamInfo(i,s.ENUM_STREAM_SUB_CMD.liveEnd,t.stateCenter.publishStreamList[i].extra_info),t.stateCenter.streamList.splice(r--,1);break}for(var i in t.streamCenter.publisherList){n=t.streamCenter.publisherList[i].publisher;var o=t.streamCenter.publisherList[i].streamTryHandler;n.state==s.ENUM_PUBLISH_STATE.stop||n.stateNego!==s.ENUM_PUBLISH_STATE_NEGO.iceConnected?!o.isOverTime&&t.streamCenter.publishStateHandle(s.ENUM_PUBLISH_STATE_UPDATE.error,i,p.publishErrorList.NETWORK_BROKEN):n.state==s.ENUM_PUBLISH_STATE.publishing&&o.stopMaxTime()}for(var i in t.streamCenter.playerList){var a=t.streamCenter.playerList[i].player;o=t.streamCenter.playerList[i].streamTryHandler;a.state==s.ENUM_PLAY_STATE.stop||a.stateNego!==s.ENUM_PLAY_STATE_NEGO.iceConnected?!o.isOverTime&&t.streamCenter.playStateHandle(s.ENUM_PLAY_STATE_UPDATE.error,i,p.playErrorList.NETWORK_BROKEN):a.state==s.ENUM_PLAY_STATE.playing&&o.stopMaxTime()}})},e.screenShotReady=!1,e.recordType="video",e}(v.BaseCenter);e.ZegoClient=S,window.addEventListener("message",function(t){var e=t.data,i=e.type,n=(e.streamId,t.origin);n!==window.location.origin&&console.warn("ScreenStream: you should discard foreign event from origin:",n),"SS_PING"===i&&(S.screenShotReady=!0)})},function(t,e,i){"use strict";var n,r=this&&this.__extends||(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])},function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});Object.defineProperty(e,"__esModule",{value:!0});var o=i(8),a=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.prototype.openWebSocketLogServer=function(t){if(this.url!=t){if(this.url=t,!t)return;if(null!=this.websocket&&2!=this.websocket.readyState&&3!=this.websocket.readyState)return;this.stopWebSocketServer(),this.websocket=new WebSocket(t),this.websocket.onopen=function(t){},this.websocket.onclose=function(t){console.error("onclose   websocket error:",t)},this.websocket.onmessage=function(t){},this.websocket.onerror=function(t){console.error("open log websocket error:"+t)}}},e.prototype.SendHttpsLog=function(){var t=this;if(0!=this.logCacheSend.length){var e=this.logCacheSend.join("\n"),i=new XMLHttpRequest;i.onreadystatechange=function(){if(4==i.readyState)if(200==i.status){if(0==i.responseText.length)return;try{var e=JSON.parse(i.responseText).interval;"number"==typeof e&&t.logUploadInterval!==e&&(t.timeInterval=e,t.openHttpsLogServer(t.url))}catch(t){console.log("send result failed "+t)}}else console.log("send failed "+i.status)},i.open("POST",this.url,!0),i.send(e),this.logCacheSend=[]}},e.prototype.logReportParamList=function(t,e){var i=new Date,n=i.getFullYear()+"/";return n+=(o.D[i.getMonth()+1]||i.getMonth()+1)+"/",n+=(o.D[i.getDate()]||i.getDate())+" ",n+=(o.D[i.getHours()]||i.getHours())+":",n+=(o.D[i.getMinutes()]||i.getMinutes())+":",n+=o.D[i.getSeconds()]||i.getSeconds(),n+="."+i.getTime()%1e3,e.time=n,e.level=t,e.console="rtc",e.appid=this.appid,e.roomid=this.roomid,e.userid=this.userid,e.id_name=this.userid,e.userName=this.userName,e.sessionid=this.sessionid,e.version=this.version,[JSON.stringify(e)]},e}(o.Logger);e.LoggerWeb=a},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=i(0);e.D=["00","01","02","03","04","05","06","07","08","09"];var r=function(){function t(){this.logLevel=n.ENUM_LOG_LEVEL.info,this.logUploadTimer=null,this.logUploadInterval=1e4,this.logCache=[],this.logCacheSend=[],this.logCacheMax=100}return t.prototype.setLogLevel=function(t){this.logLevel<n.ENUM_LOG_LEVEL.debug||this.logLevel>n.ENUM_LOG_LEVEL.report?this.logLevel=n.ENUM_LOG_LEVEL.disable:this.logLevel=t},t.prototype.setRemoteLogLevel=function(t){this.logRemoteLevel<n.ENUM_LOG_LEVEL.debug||this.logRemoteLevel>n.ENUM_LOG_LEVEL.report?this.logRemoteLevel=n.ENUM_LOG_LEVEL.disable:this.logRemoteLevel=t},t.prototype.setSessionInfo=function(t,e,i,n,r,o){this.appid=t,this.roomid=e,this.sessionid=i,this.userid=n,this.userName=r,this.version=o},t.prototype.openLogServer=function(t){try{t.startsWith("wss:")?(this.logType=n.ENUM_REMOTE_TYPE.websocket,this.openWebSocketLogServer(t)):t.startsWith("https:")?(this.logType=n.ENUM_REMOTE_TYPE.https,this.openHttpsLogServer(t)):this.logType=n.ENUM_REMOTE_TYPE.disable}catch(t){this.error(JSON.stringify(t))}},t.prototype.stopLogServer=function(){this.logType==n.ENUM_REMOTE_TYPE.websocket?this.stopWebSocketServer():this.logType==n.ENUM_REMOTE_TYPE.https&&(this.SendHttpsLog(),this.stopHttpsServer()),this.logType=n.ENUM_REMOTE_TYPE.disable},t.prototype.stopWebSocketServer=function(){this.websocket&&(this.websocket.onclose=null,this.websocket.onerror=null,this.websocket.close(),this.websocket=null)},t.prototype.openHttpsLogServer=function(t){var e=this;this.url=t,t&&(this.stopHttpsServer(),this.logUploadTimer||(this.logUploadTimer=setInterval(function(){e.SendHttpsLog()},this.logUploadInterval)))},t.prototype.stopHttpsServer=function(){this.logUploadTimer&&(clearInterval(this.logUploadTimer),this.logUploadTimer=null)},t.prototype.report=function(t){var e=this.logReportParamList(n.ENUM_LOG_LEVEL.report,t);this.logLevel!==n.ENUM_LOG_LEVEL.disable&&this.logLevel<=n.ENUM_LOG_LEVEL.report&&console.debug.apply(console,e),this.RemoteLog(n.ENUM_LOG_LEVEL.report,e,!0)},t.prototype.debug=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var i=this.logParamList(n.ENUM_LOG_LEVEL.debug,t.join(""));this.logLevel!==n.ENUM_LOG_LEVEL.disable&&this.logLevel<=n.ENUM_LOG_LEVEL.debug&&console.debug.apply(console,i),this.log(n.ENUM_LOG_LEVEL.debug,i)},t.prototype.info=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var i=this.logParamList(n.ENUM_LOG_LEVEL.info,t.join(""));this.logLevel!==n.ENUM_LOG_LEVEL.disable&&this.logLevel<=n.ENUM_LOG_LEVEL.info&&console.info.apply(console,i),this.log(n.ENUM_LOG_LEVEL.info,i)},t.prototype.warn=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var i=this.logParamList(n.ENUM_LOG_LEVEL.warn,t.join(""));this.logLevel!==n.ENUM_LOG_LEVEL.disable&&this.logLevel<=n.ENUM_LOG_LEVEL.warn&&console.warn.apply(console,i),this.log(n.ENUM_LOG_LEVEL.warn,i)},t.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var i=this.logParamList(n.ENUM_LOG_LEVEL.error,t.join(""));this.logLevel!==n.ENUM_LOG_LEVEL.disable&&this.logLevel<=n.ENUM_LOG_LEVEL.error&&console.error.apply(console,i),this.log(n.ENUM_LOG_LEVEL.error,i)},t.prototype.log=function(t,e){this.logRemoteLevel!==n.ENUM_LOG_LEVEL.disable&&this.logRemoteLevel<=t&&this.RemoteLog(t,e)},t.prototype.RemoteLog=function(t,e,i){if(void 0===i&&(i=!1),""!=this.url)if(this.logType==n.ENUM_REMOTE_TYPE.websocket)this.RemoteWebSocketLog(t,e);else if(this.logType==n.ENUM_REMOTE_TYPE.https)this.RemoteHttpsLog(t,e,i);else if(this.logLevel!==n.ENUM_LOG_LEVEL.disable&&this.logLevel<=t)for(this.logCacheSend.push(e);this.logCacheSend.length>this.logCacheMax;)this.logCacheSend.shift()},t.prototype.RemoteWebSocketLog=function(t,e){if("string"==typeof e&&e.length>4e3)console.info("log over maximum, ignore");else if(null==this.websocket||2==this.websocket.readyState||3==this.websocket.readyState){var i=this.url;this.url="",this.openLogServer(i),this.logCacheSend.length<this.logCacheMax&&this.logCacheSend.push(e)}else if(0==this.websocket.readyState)this.logCacheSend.length<this.logCacheMax&&this.logCacheSend.push(e);else if(1==this.websocket.readyState)if(this.logCacheSend.length>0){for(var n="",r=0;r<this.logCacheSend.length;r++)(n+this.logCacheSend[r]).length>4e3&&(this.websocket.send(n),n=""),n=n+this.logCacheSend[r]+"\n";e=n+e,this.logCacheSend=[],this.websocket.send(e)}else this.websocket.send(e);else console.warn("wrong socket state:"+this.websocket.readyState),this.logCacheSend.length<this.logCacheMax&&this.logCacheSend.push(e)},t.prototype.RemoteHttpsLog=function(t,e,i){this.logCacheSend.push(e),(this.logCacheSend.length>=this.logCacheMax||!0===i)&&this.SendHttpsLog()},t.prototype.logParamList=function(t,i){var n=new Date,r=n.getFullYear()+"/";r+=(e.D[n.getMonth()+1]||n.getMonth()+1)+"/",r+=(e.D[n.getDate()]||n.getDate())+" ",r+=(e.D[n.getHours()]||n.getHours())+":",r+=(e.D[n.getMinutes()]||n.getMinutes())+":",r+=e.D[n.getSeconds()]||n.getSeconds(),r+="."+n.getTime()%1e3;var o=i.substr(0,i.indexOf(" "));0==o.length&&(o=i);var a=i.substr(i.indexOf(" ")+1,4500);0==a.length&&(a="");var l={time:r,level:t,action:o,content:a,appid:this.appid,roomid:this.roomid,userid:this.userid,userName:this.userName,sessionid:this.sessionid};return[JSON.stringify(l)]},t}();e.Logger=r},function(t,e,i){"use strict";var n,r=this&&this.__extends||(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])},function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});Object.defineProperty(e,"__esModule",{value:!0});var o=i(10),a=i(11),l=i(1),s=i(0),p=i(14),h=i(15),u=i(16),c=i(2),f=i(17),v=i(18),T=function(t){function e(e,i,n,r){var o=t.call(this,e,i)||this;return o.testEnvironment=!1,o.heartbeatTimer=null,o.heartbeatInterval=1e4,o.chargeInfos={itemtype:"ChargeInfos",timestamp_begin:0,timestamp_end:0,timestamp_diff_flag:0,timestamp_diff:0,infos:[]},o.chargeInfosTimer=null,o.chargeInfosInterval=6e4,o.qualityTimerInterval=3e3,o.previewVideoList=[],o.signalList={},o.deviceStates={camera:0,microphone:0},o.soundLevelDelegate=!1,o.soundLevelInterval=1e3,o.soundLevelTimer=null,o.tryCountConnectInterval=3e3,o.checkMessageTimeout=function(){for(var t in o.signalList)o.signalList[t].signal&&o.signalList[t].signal.checkMessageTimeout()},o.getAllInUseUrl=function(){var t=[];for(var e in o.signalList)t.push(e);return t},o.onDisconnectHandle=function(t){if(o.logger.info("zsc.od.0 call"),o.signalList[t]){var e=o.signalList[t];delete o.signalList[t];for(var i=0;i<e.publishConnectedList.length;i++){var n=o.publisherList[e.publishConnectedList[i]];n&&n.publisher&&n.publisher.onDisconnect()}for(i=0;i<e.playConnectedList.length;i++){var r=o.playerList[e.playConnectedList[i]];r&&r.player&&r.player.onDisconnect()}o.stopSignalHeartbeat(),o.stopChargeInfosUpload(),o.stopSoundLevel()}},o.logger=e,o.stateCenter=i,o.dataReport=r,o.ac=n,o}return r(e,t),e.prototype.onSignalDisconnected=function(t){},e.prototype.setQualityMonitorCycle=function(t){this.logger.debug("zsc.qmc.0 timeInterval "+t),this.qualityTimerInterval=t},e.prototype.setSessionInfo=function(t,e,i,n){this.logger.debug("zsc.ssi.0 called"),this.appid=t,this.userid=e,this.token=i,this.testEnvironment=n},e.prototype.onPlayStateUpdate=function(t,e,i){},e.prototype.onPlayQualityUpdate=function(t,e){},e.prototype.onPublishStateUpdate=function(t,e,i){},e.prototype.onPublishQualityUpdate=function(t,e){},e.prototype.onUpdateHeartBeartIntervalHandle=function(t){t!=this.heartbeatInterval&&(this.logger.debug("zsc.uhb.0 update "+t),this.heartbeatTimer&&(clearTimeout(this.heartbeatTimer),this.heartbeatTimer=null),this.heartbeatInterval=t,this.startSignalHeartbeat())},e.prototype.switchDevice=function(t,e,i,n,r){var o,a,s,p,h,u,c=this,f=null,v=/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent);if(o=this.checkPreview(e)){delete(a=o.mediaStreamConfig).facingMode,"video"===t?(a.videoInput=i,p=e.srcObject.getVideoTracks()[0]):(a.audioInput=i,p=e.srcObject.getAudioTracks()[0]),!v&&p.stop();var T=o.getMediaStreamConstraints(a);navigator.mediaDevices.getUserMedia(T).then(function(i){for(var r in"video"===t?(h=i.getVideoTracks()[0],o.localStream.removeTrack(o.localStream.getVideoTracks()[0])):(h=i.getAudioTracks()[0],o.localStream.removeTrack(o.localStream.getAudioTracks()[0])),c.publisherList)c.publisherList[r].localVideo===e&&(u=r);u&&(f=c.publisherList[u].publisher,(s=f.peerConnection.getSenders().find(function(t){return t.track.kind===h.kind}))?s.replaceTrack(h):c.logger.warn("zg.sd.0 no sender found, only swithcing device on localMediaElement")),o.localStream.addTrack(h),f.signal.sendStreamStatus(l.getSeq(),f.sessionId,o.localStream.getVideoTracks()[0].enabled?0:2,o.localStream.getAudioTracks()[0].enabled?0:2,f.streamId),n&&n()},function(t){return r&&r(t)})}else this.logger.error("zg.sd.0 no preview found")},e.prototype.enableMicrophone=function(t,e){var i=this.checkPreview(t);return i?i.enableMicrophone(e,this):(this.logger.info("zsc.em.0 no preview"),!1)},e.prototype.enableCamera=function(t,e){var i=this.checkPreview(t);return i?i.enableCamera(e,this):(this.logger.error("zsc.ec.0 no preview"),!1)},e.prototype.recordDevices=function(t){var e=this,i=this.checkPreview(t);i?(this.logger.info("zsc.rd.0 call"),c.ClientUtil.getDevices(function(t){e.stateCenter.deviceInfos={microphones:t.microphones,speakers:t.speakers,cameras:t.cameras}},function(t){e.logger.warn("zsc.rd.0 getDevices err:",t)}),this.videoDeviceName=0!==i.localStream.getVideoTracks().length?i.localStream.getVideoTracks()[0].label:"",this.audioDeviceName=0!==i.localStream.getAudioTracks().length?i.localStream.getAudioTracks()[0].label:"",navigator.mediaDevices&&void 0!==navigator.mediaDevices.ondevicechange&&(navigator.mediaDevices.ondevicechange=function(t){e.logger.info("zsc.rd.0 devicechange"),e.stateCenter.deviceChangeTimer&&(clearTimeout(e.stateCenter.deviceChangeTimer),e.stateCenter.deviceChangeTimer=null),e.stateCenter.deviceChangeTimer=setTimeout(function(){c.ClientUtil.getDevices(function(t){for(var i=[],n=function(n){var r=e.stateCenter.deviceInfos.cameras[n];t.cameras.find(function(t){return t.deviceID===r.deviceID})||i.push(r)},r=0;r<e.stateCenter.deviceInfos.cameras.length;r++)n(r);i.length,i.forEach(function(t){for(var i in e.publisherList){var n=e.publisherList[i].localStream;if(n&&e.publisherList[i].cameraLabel===t.deviceName){!1;var r=e.publisherList[i].publisher;r.signal.sendStreamStatus(l.getSeq(),r.sessionId,-6,n.getAudioTracks()[0]&&1==n.getAudioTracks()[0].enabled?0:2,r.streamId),e.onDeviceError({deviceName:e.publisherList[i].cameraLabel,deviceType:"camera",errorCode:-6})}n&&0===n.getAudioTracks().length&&!1}});var o=e.stateCenter.deviceInfos.microphones.filter(function(e){return!t.microphones.find(function(t){return t.deviceID===e.deviceID})});o.forEach(function(t){for(var i in e.publisherList){var n=e.publisherList[i].localStream;if(n&&(e.publisherList[i].microLabel===t.deviceName||e.publisherList[i].microLabel.includes(t.deviceName))){var r=e.publisherList[i].publisher;r.signal.sendStreamStatus(l.getSeq(),r.sessionId,n.getVideoTracks()[0]&&1==n.getVideoTracks()[0].enabled?0:2,-6,r.streamId),e.onDeviceError({deviceName:e.publisherList[i].microLabel,deviceType:"micro",errorCode:-6})}}});var a=e.stateCenter.deviceInfos.speakers.filter(function(e){return!t.speakers.find(function(t){return t.deviceID===e.deviceID})}),s=t.cameras.filter(function(t){return!e.stateCenter.deviceInfos.cameras.find(function(e){return e.deviceID===t.deviceID})}),p=t.microphones.filter(function(t){return!e.stateCenter.deviceInfos.microphones.find(function(e){return e.deviceID===t.deviceID})}),h=t.speakers.filter(function(t){return!e.stateCenter.deviceInfos.speakers.find(function(e){return e.deviceID===t.deviceID})});i.forEach(function(t){var i={deviceInfo:t,state:"DELETE"};e.OnVideoDeviceStateChanged(i)}),o.forEach(function(t){var i={deviceType:"Input",deviceInfo:t,state:"DELETE"};e.OnAudioDeviceStateChanged(i)}),a.forEach(function(t){var i={deviceType:"Output",deviceInfo:t,state:"DELETE"};e.OnAudioDeviceStateChanged(i)}),s.forEach(function(t){var i={deviceInfo:t,state:"ADD"};e.OnVideoDeviceStateChanged(i)}),p.forEach(function(t){var i={deviceType:"Input",deviceInfo:t,state:"ADD"};e.OnAudioDeviceStateChanged(i)}),h.forEach(function(t){var i={deviceType:"Output",deviceInfo:t,state:"ADD"};e.OnAudioDeviceStateChanged(i)}),e.stateCenter.deviceInfos={microphones:t.microphones,speakers:t.speakers,cameras:t.cameras}},function(t){e.logger.warn("zsc.rd.0 getDevices err:",t)})},10)})):this.logger.error("zsc.rd.0 no localVideo found")},e.prototype.startPreview=function(t,e,i,n){var r=this;if(!t)return this.logger.error("zsc.sp.0 localVideo null"),!1;var a=this.checkPreview(t);return a?(this.logger.warn("zsc.sp.0 localvideo already exist"),!0):(a=new o.ZegoPreview(this.logger),this.previewVideoList.push(a),a.startPreview(t,e,function(){r.logger.debug("zsc.sp.0 call success"),r.recordDevices(t),i&&i()},function(t){r.previewVideoList=r.previewVideoList.filter(function(t){return t!==a}),n&&n(t)}),!0)},e.prototype.stopPreview=function(t){if(!t)return this.logger.warn("zsc.sp.0 localVideo null"),!1;for(var e in this.publisherList)this.publisherList[e].localVideo===t&&(this.publisherList[e].localVideo=null);var i=this.checkPreview(t);return i?(i.previewSuc&&(i.stopPreview(),this.removePreview(i)),!0):(this.logger.warn("zsc.sp.0 no preview"),!1)},e.prototype.setPublishStateStart=function(t,e,i){var n=this;if(this.publisherList[t])return this.logger.error("zsc.pss.0 publisher already exist"),!1;var r=new a.ZegoPublish(this.logger,null,this.dataReport,this.qualityTimerInterval,this);r.onPublishStateUpdate=function(e,i,r,o){var a=n.publisherList[i];a?n.publishStateHandle(e,a.streamId,r,o):n.logger.error("zsc.psuh.0 cannot find publish "+t)},r.onPublishQualityUpdate=function(e,i){var r=n.publisherList[e];r?n.onPublishQualityUpdate(r.streamId,i):n.logger.error("zsc.psuh.0 cannot find publish "+t)};var o=e.srcObject,l=o.getVideoTracks()[0]&&o.getVideoTracks()[0].label,s=o.getAudioTracks()[0]&&o.getAudioTracks()[0].label;return r.localVideo=e,this.publisherList[t]={seq:0,reportSeq:null,localVideo:e||"",publisher:r,serverUrls:[],streamId:t,playOption:i,streamTryHandler:new f.TryStreamHandler(this.logger,this.stateCenter),tryDispatchHandler:new v.TryDispatchHandler(this.logger,this.stateCenter,this.socketCenter,this),cameraLabel:l||"",microLabel:s||"",localStream:o},this.dataReport.eventStart(r.reportSeq,"GetSignalUrl"),!0},e.prototype.startPublishingStream=function(t,e,i){this.logger.info("zsc.sps.0 call");var n=this.publisherList[t];if(!n)return this.logger.error("zsc.sps.0 publisher don't exist"),!1;var r=n.publisher;if(this.dataReport.eventEndWithMsg(r.reportSeq,"GetSignalUrl",{urls:e}),!e||0===e.length)return this.publishStateHandle(l.ENUM_PUBLISH_STATE_UPDATE.error,t,l.publishErrorList.DISPATCH_ERROR),this.logger.info("zsc.sps.0 server don't have signal url"),!1;n.serverUrls=n.serverUrls.concat(e);var o=e.indexOf(this.server);-1!==o&&(n.serverUrls.splice(o,1),n.serverUrls.unshift(this.server));var a=n.streamTryHandler;a.invalid(),a.init(this.stateCenter.streamRetryTime),a.initStream(this,!0,t,e),a.active(0)},e.prototype.updateWaitingList=function(t,e,i,n,r){e?t.publishWaitingList.push({streamId:i,success:n,error:r}):t.playWaitingList.push({streamId:i,success:n,error:r})},e.prototype.publishStream=function(t){var e=this.publisherList[t].publisher;if(e){var i=null,n=null,r=this.publisherList[t].playOption,o=this.checkPreview(this.publisherList[t].localVideo);o&&(i=o.localStream,n=o.videoInfo),i?(this.logger.debug("zsc.ps.0 call success"),e.startPublish(t,i,n,o.mediaStreamConfig,r)):this.logger.error("zsc.ps.0 no localStream found before publish")}else this.logger.info("zsc.ps.0 publisher don't exist")},e.prototype.connectPublishServer=function(t,e){var i=this,n=this.publisherList[t];return n?(this.dataReport.eventStart(n.publisher.reportSeq,"ConnectServer"),this.connetWithReuseSignalServer(t,!0,e,function(t,e,n){var r=i.publisherList[t];if(r){var o=r.publisher;if(o){i.dataReport.eventEndWithMsg(o.reportSeq,"ConnectServer",{result:0,server:n});var a=e.tokenInfo;i.logger.info("zsc.cps.0 update token success"),a&&a.report&&(o.qualityUpload=a.report,o.qualityUploadInterval=a.report_interval),o.signal=e.signal,i.server=n,i.publishStream(t),i.getTokenSuccess()}else i.logger.info("zsc.cps.1 check publisher don't exist")}else i.logger.info("zsc.cps.0 after connect publisher don't exist")},function(t,e){i.logger.error("zsc.cps.0 "+t+" connect fail "+e),i.publisherList[t]?i.publishStateHandle(l.ENUM_PUBLISH_STATE_UPDATE.error,t,l.publishErrorList.CONNECT_FAILED):i.logger.info("zsc.cps.0 after connect publisher don't exist")}),!0):(this.logger.error("zsc.cps.0 publisher don't exist"),!1)},e.prototype.getTokenSuccess=function(){this.logger.debug("zsc.gts.0 call")},e.prototype.stopPublishingStream=function(t){var e=this.publisherList[t];if(e){var i=e.tryDispatchHandler,n=e.streamTryHandler;for(var r in i&&(i.stopMaxTime(),i.invalid()),n&&(n.stopMaxTime(),n.invalid()),this.signalList)this.signalList[r].publishWaitingList=this.signalList[r].publishWaitingList.filter(function(e){return e.streamId!==t});delete this.publisherList[t],e.publisher&&(e.publisher.stopPublish(),delete e.publisher),this.removeStreamFromSignal(!0,t),this.stopSignalHeartbeat(),this.stopChargeInfosUpload(),this.stopSoundLevel(),this.logger.debug("zsc.sps.0.1 call success")}else this.logger.warn("zsc.sps.0.1 publisher don't exist")},e.prototype.setPlayStreamAudioOutput=function(t,e){if(null!=e&&0!=e.length){this.logger.debug("zsc.psao.1 device "+e);var i=this.playerList[t];return i?i.player?i.player.setAudioDestination(e):(this.logger.info("zsc.psao.1 player don't exist"),!1):(this.logger.info("zsc.psao.1 play don't exist"),!1)}return!1},e.prototype.setStreamAudioOutput=function(t,e){var i=this;return!(null==e||0==e.length||!t)&&(this.logger.debug("zsc.ssao.0 device "+e),t?"undefined"!==t.sinkId?(t.setSinkId(e).then(function(){i.logger.info("zsc.ssao.0 success device: "+e)}).catch(function(t){i.logger.info("zsc.ssao.0 "+t.name)}),!0):(this.logger.error("zsc.ssao.0 browser does not suppport"),!1):(this.logger.error("zsc.ssao.0 no localVideo"),!1))},e.prototype.connetWithReuseSignalServer=function(t,e,i,n,r){var o=this;this.logger.info("zsc.crss.0 begin "+i);var a=null;if(this.signalList[i])(a=this.signalList[i]).state==s.ENUM_SIGNAL_STATE.connected?(this.logger.info("zsc.crss.0 already connected "+i+" streamId: "+t),e?a.publishConnectedList.push(t):a.playConnectedList.push(t),n(t,a,i)):a.state==s.ENUM_SIGNAL_STATE.connecting&&(this.logger.debug("zsc.crss.0 signal is connecting "+i+" streamId: "+t),this.updateWaitingList(a,e,t,n,r));else{this.logger.info("zsc.crss.0 new signal "+i+" streamId: "+t);var l=new p.ZegoSignal(this.logger,this.stateCenter);l.setSessionInfo(this.appid,this.userid),l.onUpdateHeartBeartInterval=this.onUpdateHeartBeartIntervalHandle.bind(this),l.onDisconnect=this.onDisconnectHandle,this.signalList[i]={signal:l,state:s.ENUM_SIGNAL_STATE.connecting,publishWaitingList:[],playWaitingList:[],publishConnectedList:[],playConnectedList:[],tokenInfo:null,isTimeOut:!1},this.updateWaitingList(this.signalList[i],e,t,n,r),l.connectServer(this.token,i,function(t,e,n){(a=o.signalList[i]).isTimeOut&&(o.logger.error("zsc.crss.0 connected "+e+" over time"),l.disconnectServer(),delete o.signalList[i]);var r,p,h=0;if(0!=t){for(o.logger.debug("zsc.crss.0 connect failed "+e),h=0;h<a.publishWaitingList.length;h++)(r=a.publishWaitingList[h]).error&&r.error(r.streamId,t);for(h=0;h<a.playWaitingList.length;h++)(p=a.playWaitingList[h]).error&&p.error(p.streamId,t);delete o.signalList[i]}else{for(o.logger.debug("zsc.crss.0 connected success "+e),a.state=s.ENUM_SIGNAL_STATE.connected,a.tokenInfo=n,h=0;h<a.publishWaitingList.length;h++)(r=a.publishWaitingList[h]).success&&r.success(r.streamId,a,e),a.publishConnectedList.push(r.streamId);for(h=0;h<a.playWaitingList.length;h++)(p=a.playWaitingList[h]).success&&p.success(p.streamId,a),a.playConnectedList.push(p.streamId,e);a.publishWaitingList=[],a.playWaitingList=[],null==o.heartbeatTimer&&o.startSignalHeartbeat(),null==o.chargeInfosTimer&&o.startChargeInfosUpload(),null==o.soundLevelTimer&&o.soundLevelDelegate&&o.startSoundLevel()}})}},e.prototype.setPlayStateStart=function(t,e,i,n){var r=this;if(this.playerList[t])return this.logger.warn("zsc.pss.1 player already exist"),!1;var o=new h.ZegoPlayWeb(this.logger,null,this.dataReport,this.qualityTimerInterval,this);return o.onVideoSizeChanged=this.onVideoSizeChanged,this.playerList[t]={seq:0,reportSeq:null,player:o,remoteVideo:e,audioOutput:i,signal:null,serverUrls:[],streamId:t,playOption:n,streamTryHandler:new f.TryStreamHandler(this.logger,this.stateCenter),tryDispatchHandler:new v.TryDispatchHandler(this.logger,this.stateCenter,this.socketCenter,this)},o.onPlayStateUpdate=function(t,e,i,n){var o=r.playerList[e];o?r.playStateHandle(t,o.streamId,i,n):r.logger.error("zsc.pss.1 cannot find play "+e)},o.onPlayQualityUpdate=function(t,e){var i=r.playerList[t];i?r.onPlayQualityUpdate(i.streamId,e):r.logger.error("zsc.pss.1 cannot find play "+t)},o.onRemoteCameraStatusUpdate=function(t,e){var i=r.playerList[t];i?r.onRemoteCameraStatusUpdate(i.streamId,e):r.logger.error("zsc.pss.1 cannot find play "+t)},o.onRemoteMicStatusUpdate=function(t,e){var i=r.playerList[t];i?r.onRemoteMicStatusUpdate(i.streamId,e):r.logger.error("zsc.pss.1 cannot find play "+t)},this.dataReport.eventStart(o.reportSeq,"GetSignalUrl"),!0},e.prototype.startPlayingStream=function(t,e,i){this.logger.info("zsc.sps.1 start play called");var n=this.playerList[t];if(!n)return this.logger.error("zsc.sps.1 player don't exist"),!1;var r=n.player;if(this.dataReport.eventEndWithMsg(r.reportSeq,"GetSignalUrl",{urls:e}),0==e.length)return this.playStateHandle(l.ENUM_PLAY_STATE_UPDATE.error,t,l.playErrorList.DISPATCH_ERROR),this.logger.info("zsc.sps.1 server don't have signal url"),!1;n.serverUrls=n.serverUrls.concat(e);var o=e.indexOf(this.server);-1!==o&&(n.serverUrls.splice(o,1),n.serverUrls.unshift(this.server));var a=n.streamTryHandler;a.invalid(),a.init(this.stateCenter.streamRetryTime),a.initStream(this,!1,t,e),a.active(0)},e.prototype.connectPlayServer=function(t,e){var i=this,n=this.playerList[t];return n?(this.dataReport.eventStart(n.player.reportSeq,"ConnectServer"),this.connetWithReuseSignalServer(t,!1,e,function(t,e,n){var r=i.playerList[t];if(r){var o=r.player;if(o){i.dataReport.eventEndWithMsg(o.reportSeq,"ConnectServer",{result:0,server:n});var a=e.tokenInfo;i.logger.info("zsc.cps.1 update token success"),a&&a.report&&(o.qualityUpload=a.report,o.qualityUploadInterval=a.report_interval),o.signal=e.signal,i.server=n,i.playStream(t),i.getTokenSuccess()}else i.logger.error("zsc.cps.1 checkplayer don't exist")}else i.logger.error("zsc.cps.1 after connect player don't exist")},function(t,e){i.playerList[t]?i.playStateHandle(l.ENUM_PLAY_STATE_UPDATE.error,t,l.playErrorList.CONNECT_FAILED):i.logger.error("zsc.cps.1 after connect player don't exist")}),!0):(this.logger.error("zsc.cps.1 player don't exist"),!1)},e.prototype.playStream=function(t){var e=this.playerList[t].player;e?(this.logger.info("zsc.ps.1 call success"),e.startPlay(t,this.playerList[t].remoteVideo,this.playerList[t].audioOutput,this.playerList[t].playOption)):this.logger.warn("zsc.ps.1 player don't exist")},e.prototype.removeStreamFromSignal=function(t,e){var i=[];for(var n in this.signalList){var r=this.signalList[n];if(t){for(var o=0;o<r.publishConnectedList.length;o++)if(r.publishConnectedList[o]===e){this.logger.debug("zsc.rsfs.0 found from publish"),r.publishConnectedList.splice(o,1);break}for(o=0;o<r.publishWaitingList.length;o++)if(r.publishWaitingList[o].streamId===e){this.logger.debug("zsc.rsfs.0 found from publish"),r.publishWaitingList.splice(o,1);break}}else{for(var a=0;a<r.playConnectedList.length;a++)if(r.playConnectedList[a]===e){this.logger.debug("zsc.rsfs.0 found from play"),r.playConnectedList.splice(a,1);break}for(a=0;a<r.playWaitingList.length;a++)if(r.playWaitingList[a].streamId===e){this.logger.debug("zsc.rsfs.0 found from play"),r.playWaitingList.splice(a,1);break}}0==r.publishConnectedList.length&&0==r.playConnectedList.length&&0==r.publishWaitingList.length&&0==r.playWaitingList.length&&(r.signal.disconnectServer(),i.push(n))}for(var l=0;l<i.length;l++)delete this.signalList[i[l]]},e.prototype.stopSignalHeartbeat=function(){this.logger.debug("zsc.ssh.1 call");var t=0;for(var e in this.signalList)t+=1;this.heartbeatTimer&&0==t&&(this.logger.info("zsc.ssh.1 stop"),clearTimeout(this.heartbeatTimer),this.heartbeatTimer=null)},e.prototype.stopChargeInfosUpload=function(){this.logger.debug("zsc.sciu.0 call");var t=0;for(var e in this.signalList)t+=1;this.chargeInfosTimer&&0==t&&(this.logger.info("zsc.sciu.0 stop"),clearTimeout(this.chargeInfosTimer),this.chargeInfosTimer=null)},e.prototype.getPublisher=function(t){var e=null;return this.publisherList[t]&&this.publisherList[t].publisher&&(e=this.publisherList[t].publisher),e},e.prototype.publishStateHandle=function(t,e,i,n){this.logger.info("zsc.psh.0 call "+e);var r=this.publisherList[e].streamTryHandler,o=n||r.RETRY_MAX_TIME<3;if(i){!r.maxTimer&&!o&&r.startMaxTime();var a=this.publisherList[e].publisher;if(this.stateCenter.publishStreamList[e].state=s.ENUM_PUBLISH_STREAM_STATE.tryPublish,i.code===l.publishErrorList.SESSION_CLOSED.code||a.stateNego!=s.ENUM_PUBLISH_STATE_NEGO.iceConnected||n){var p=a.streamId,h=a.localStream,u=a.videoInfo,c=a.mediaStreamConfig,f=a.playOption;if(a.resetPublish(),0!=a.sessionId&&a.signal&&a.shouldSendCloseSession(i)&&(a.signal.sendCloseSession(l.getSeq(),a.sessionId,1),a.signal.removeSession(a.sessionId),a.closeSessionSignal=!0),!o&&!r.retryNextSignal(i))return void a.startPublish(p,h,u,c,f)}else this.logger.info("zsc.psh.0 ice is connected");this.removeStreamFromSignal(!0,e)}if(o){r.stopMaxTime(),r.invalid();var v=this.publisherList[e].reportSeq;return this.dataReport.uploadReport(v,"/sdk/publish",i?i.code:void 0),void this.onPublishStateUpdate(t,e,i)}i&&r.active(null)&&this.onPublishStateUpdate(2,e,i),this.logger.info("zsc.psh.0 end "+e)},e.prototype.playStateHandle=function(t,e,i,n){this.logger.info("zsc.psh.1 call "+e);var r=this.playerList[e].streamTryHandler,o=n||r.RETRY_MAX_TIME<3;if(i){!r.maxTimer&&!o&&r.startMaxTime();var a=this.playerList[e].player;if(i.code===l.playErrorList.SESSION_CLOSED.code||a.stateNego!=s.ENUM_PUBLISH_STATE_NEGO.iceConnected||n){var p=a.streamId,h=a.remoteVideo,u=a.audioOutput,c=a.playOption;if(a.resetPlay(),0!=a.sessionId&&a.signal&&a.shouldSendCloseSession(i)&&(a.signal.sendCloseSession(l.getSeq(),a.sessionId,1),a.signal.removeSession(a.sessionId),a.closeSessionSignal=!0),!o&&!r.retryNextSignal(i))return void a.startPlay(p,h,u,c)}else this.logger.info("zsc.psh.1 ice is connected");this.removeStreamFromSignal(!0,e)}if(o){r.stopMaxTime(),r.invalid();var f=this.playerList[e].reportSeq;return this.dataReport.uploadReport(f,"/sdk/play",i?i.code:void 0),void this.onPlayStateUpdate(t,e,i)}i&&r.active(null)&&this.onPlayStateUpdate(2,e,i),this.logger.info("zsc.psh.1 end "+e)},e.prototype.stopPlayingStream=function(t){var e=this.playerList[t];if(e){var i=e.tryDispatchHandler,n=e.streamTryHandler;for(var r in i&&(i.stopMaxTime(),i.invalid()),n&&(n.stopMaxTime(),n.invalid()),this.signalList)this.signalList[r].playWaitingList=this.signalList[r].playWaitingList.filter(function(e){return e.streamId!==t});delete this.playerList[t],e.player&&(e.player.stopPlay(),delete e.player),this.removeStreamFromSignal(!1,t),this.stopSignalHeartbeat(),this.stopChargeInfosUpload(),this.stopSoundLevel(),this.logger.debug("zsc.sps.1.1 call success")}else this.logger.info("zsc.sps.1.1 player don't exist")},e.prototype.reset=function(){for(var t in this.publisherList){(i=this.publisherList[t].streamTryHandler)&&(i.stopMaxTime(),i.invalid()),this.publisherList[t].publisher&&this.publisherList[t].publisher.stopPublish()}for(var e in this.playerList){var i;(i=this.playerList[e].streamTryHandler)&&(i.stopMaxTime(),i.invalid()),this.playerList[e].player&&this.playerList[e].player.stopPlay()}for(var n in this.signalList)this.signalList[n].signal&&this.signalList[n].signal.disconnectServer();this.playerList={},this.publisherList={},this.signalList={},this.server="",this.heartbeatTimer&&(clearTimeout(this.heartbeatTimer),this.heartbeatTimer=null)},e.prototype.startSignalHeartbeat=function(){var t=this;this.logger.debug("zsc.ssh.0 call"),this.heartbeatTimer&&(clearTimeout(this.heartbeatTimer),this.heartbeatTimer=null),this.heartbeatTimer=setTimeout(function(){t.checkSignalHeartbeat()},this.heartbeatInterval)},e.prototype.checkSignalHeartbeat=function(){for(var t in this.logger.debug("zsc.csh.0 call"),this.signalList)this.signalList[t].signal&&this.signalList[t].signal.sendHeartbeat();this.heartbeatTimer&&this.startSignalHeartbeat()},e.prototype.startChargeInfosUpload=function(){var t=this;this.logger.debug("zsc.sciu.0 call"),this.chargeInfosTimer&&(clearTimeout(this.chargeInfosTimer),this.chargeInfosTimer=null),this.chargeInfosTimer=setTimeout(function(){t.checkChargeInfos()},this.chargeInfosInterval)},e.prototype.checkChargeInfos=function(){this.logger.debug("zsc.cci.0 call");var t={is_publishing:0,play_max_audio_bitrate:0,play_stream_resolution_infos:[]};for(var e in this.chargeInfos.timestamp_begin=(new Date).getTime(),this.publisherList){this.publisherList[e].publisher.state===s.ENUM_PUBLISH_STATE.publishing&&(t.is_publishing=1);break}t.play_max_audio_bitrate=0;var i=function(e){var i=n.playerList[e].remoteVideo,r={video_width:i.videoWidth||0,video_height:i.videoHeight||0,count:1};if(!t.play_stream_resolution_infos.find(function(t){return t.video_width==r.video_width&&t.video_height==r.video_height&&(t.count++,!0)})&&t.play_stream_resolution_infos.push(r),0==r.video_width&&0==r.video_height){var o=1e3*n.playerList[e].player.lastPlayStats.audioBitrate;o>t.play_max_audio_bitrate&&(t.play_max_audio_bitrate=o)}},n=this;for(var r in this.playerList)i(r);0!==this.chargeInfos.timestamp_end?(this.chargeInfos.timestamp_diff=this.chargeInfos.timestamp_begin-this.chargeInfos.timestamp_end,this.chargeInfos.timestamp_diff_flag=1):(this.chargeInfos.timestamp_diff=0,this.chargeInfos.timestamp_diff_flag=0),this.chargeInfos.timestamp_end=(new Date).getTime(),this.chargeInfos.infos=[t],0!==t.play_stream_resolution_infos.length&&this.logger.report(this.chargeInfos),this.chargeInfosTimer&&this.startChargeInfosUpload()},e.prototype.startSoundLevel=function(){var t=this;this.soundLevelTimer&&(clearTimeout(this.soundLevelTimer),this.soundLevelTimer=null),this.soundLevelTimer=setTimeout(function(){t.checkSoundLevel()},this.soundLevelInterval)},e.prototype.checkSoundLevel=function(){var t=[];for(var e in this.publisherList){var i=this.publisherList[e].publisher;t.push({streamID:i.streamId,soundLevel:i.soundLevel,type:"push"})}for(var e in this.playerList){var n=this.playerList[e].player;t.push({streamID:n.streamId,soundLevel:n.soundLevel,type:"pull"})}this.soundLevelDelegate&&t.length>0&&this.onSoundLevelUpdate(t),this.soundLevelDelegate&&this.startSoundLevel()},e.prototype.setSoundLevelDelegate=function(t,e){for(var i in this.logger.info("zsc.ssd.0 call"),e&&(this.soundLevelInterval=e),this.soundLevelDelegate=t,this.publisherList){var n=this.publisherList[i].publisher;t?n.startSoundLevel():n.stopSoundLevel()}for(var i in this.playerList){var r=this.playerList[i].player;t?r.startSoundLevel():r.stopSoundLevel()}if(t){this.logger.info("zsc.ssd.0 start getting sound");var o=0;for(var a in this.signalList)o+=1;null==this.soundLevelTimer&&o>0&&this.startSoundLevel()}else this.logger.info("zsc.ssd.0 stop getting sound"),this.soundLevelTimer&&clearTimeout(this.soundLevelTimer),this.soundLevelTimer=null,this.soundLevelInterval=1e3},e.prototype.stopSoundLevel=function(){var t=0;for(var e in this.signalList)t+=1;this.soundLevelTimer&&0==t&&(this.logger.info("zsc.ssl.0 stop"),clearTimeout(this.soundLevelTimer),this.soundLevelTimer=null,this.soundLevelInterval=1e3)},e.prototype.checkPreview=function(t){for(var e=0;e<this.previewVideoList.length;e++)if(this.previewVideoList[e].localVideo===t)return this.previewVideoList[e];return null},e.prototype.removePreview=function(t){for(var e=0;e<this.previewVideoList.length;e++)if(this.previewVideoList[e]===t){this.previewVideoList.splice(e,1);break}},e.prototype.onDeviceError=function(t){},e.prototype.OnAudioDeviceStateChanged=function(t){},e.prototype.OnVideoDeviceStateChanged=function(t){},e.prototype.onPlayerStreamUrlUpdate=function(t,e,i){},e.prototype.onVideoSizeChanged=function(t,e,i){},e.prototype.onRemoteCameraStatusUpdate=function(t,e){},e.prototype.onRemoteMicStatusUpdate=function(t,e){},e.prototype.onSoundLevelUpdate=function(t){},e.prototype.setPublishStreamConstraints=function(t,e,i,n){var r=this,o=this.publisherList[t],a=/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent);if(o){var l=this.checkPreview(o.localVideo);if(l)if(e&&0!=Object.keys(e).length){var s=!1,p=!1;e.minBitRate&&e.maxBitRate&&(e.bitRate={minBitRate:e.minBitRate,maxBitRate:e.maxBitRate}),e.width&&e.width!=l.mediaStreamConfig.width||e.height&&e.height!=l.mediaStreamConfig.height||e.frameRate&&e.frameRate!=l.mediaStreamConfig.frameRate||"boolean"==typeof e.noiseSuppression&&e.noiseSuppression!=l.mediaStreamConfig.noiseSuppression||"boolean"==typeof e.autoGainControl&&e.autoGainControl!=l.mediaStreamConfig.autoGainControl||"boolean"==typeof e.echoCancellation&&e.echoCancellation!=l.mediaStreamConfig.echoCancellation?s=!0:e.minBitRate==l.mediaStreamConfig.bitRate.minBitRate&&e.maxBitRate==l.mediaStreamConfig.bitRate.maxBitRate||e.minBitRate&&e.maxBitRate&&(p=!0),l.mediaStreamConfig.videoInput!==e.videoInput&&delete l.mediaStreamConfig.facingMode&&delete e.facingMode;var h=Object.assign(l.mediaStreamConfig,e);if(h.externalCapture||h.externalMediaStream)this.logger.error("zc.spsc.0 do not support external stream");else{var u=l.getMediaStreamConstraints(h),c=o.publisher.localStream;if(!o.publisher.peerConnection.getSenders||!o.publisher.peerConnection.getSenders()[0].replaceTrack)return this.logger.error("zc.spsc.0 set publish constraints is not supported"),void(n&&n({code:1,msg:"not supported"}));if(this.logger.info("zc.spsc.0 streamID: "+t+" constraints: "+JSON.stringify(e)),s&&(!a&&c.getTracks().forEach(function(t){return t.stop()}),navigator.mediaDevices.getUserMedia(u).then(function(t){t.getTracks().forEach(function(t){var e=c.getTracks().find(function(e){return e.kind===t.kind}),i=o.publisher.peerConnection.getSenders().find(function(e){return e.track.kind===t.kind});h.minBitRate&&h.maxBitRate&&"video"===i.track.kind&&r.setVideoBitRate(i,h.minBitRate,h.maxBitRate),i.replaceTrack(t),c.removeTrack(e),c.addTrack(t),r.logger.info("zc.spsc.0 set constraints success")}),i&&i()}).catch(function(t){r.logger.error("zc.spsc.0 fail reason ",t.name),n&&n({code:2,msg:t.name})})),p)try{var f=o.publisher.peerConnection.getSenders().find(function(t){return"video"===t.track.kind});this.setVideoBitRate(f,e.minBitRate,e.maxBitRate),i&&i()}catch(t){this.logger.error("zc.spsc.0 fail reason ",t.name),n&&n({code:2,msg:t.name})}}}else this.logger.error("zc.spsc.0 constraints wrong");else this.logger.error("zc.spsc.0 preview no found")}else this.logger.error("zc.spsc.0 publisher not found")},e.prototype.setVideoBitRate=function(t,e,i){var n=this;this.logger.info("zsc.svb.0 call min:"+e+" max:"+i+" ");var r=t.getParameters();return r.encodings||(r.encodings=[{}]),r.encodings[0].minBitrate=1e3*e,r.encodings[0].maxBitrate=1e3*i,t.setParameters(r).then(function(){n.logger.info("zc.spsc.0 set video bitrate success")}).catch(function(t){n.logger.error("zc.spsc.0 set video bitrate fail "+t)}),!0},e.prototype.startMixingAudio=function(t,e){var i=this.getPublisher(t);return i?i.startMixingAudio(e):(this.logger.error("zc.sma.0 publisher doesn't exist"),!1)},e.prototype.stopMixingAudio=function(t,e){var i=this.getPublisher(t);return i?i.stopMixingAudio(e):(this.logger.error("zc.sma.1 publisher doesn't exist"),!1)},e}(u.ZegoStreamCenter);e.ZegoStreamCenterWeb=T},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=i(0),r=i(1),o=function(){function t(t){var e=this;this.log=t,this.localVideo=null,this.localStream=null,this.micTrack=null,this.previewSuc=!1,this.enableMicrophone=function(t,i){if(!e.localStream)return e.logger.error("zp.em.2 no localStream"),!1;for(var n in e.localStream.getAudioTracks().forEach(function(e){e.enabled=t}),e.micTrack&&(e.micTrack.enabled=t),i.publisherList){var o=i.publisherList[n].publisher;o.localStream==e.localStream&&o.signal.sendStreamStatus(r.getSeq(),o.sessionId,e.localStream&&e.localStream.getVideoTracks()[0]&&!0===e.localStream.getVideoTracks()[0].enabled?0:2,t?0:2,o.streamId)}return e.logger.debug("zp.em.2 call success"),!0},this.enableCamera=function(t,i){if(!e.localStream)return e.logger.error("zp.ec.2 no localStream"),!1;for(var n in e.localStream.getVideoTracks().forEach(function(e){e.enabled=t}),i.publisherList){var o=i.publisherList[n].publisher;o.localStream==e.localStream&&o.signal.sendStreamStatus(r.getSeq(),o.sessionId,t?0:2,e.localStream&&e.localStream.getAudioTracks()[0]&&1==e.localStream.getAudioTracks()[0].enabled?0:2,o.streamId)}return e.logger.debug("zp.ec.2 call success"),!0},this.setAudioDestination=function(t){return e.localVideo?"undefined"!==e.localVideo.sinkId?(e.localVideo.setSinkId(t).then(function(){e.logger.info("zp.sad.2 success device: "+t)}).catch(function(t){e.logger.info("zp.sad.2 "+t.name)}),!0):(e.logger.error("zp.sad.2 browser does not suppport"),!1):(e.logger.error("zp.sad.2 no localVideo"),!1)},this.logger=t}return t.prototype.getMediaStreamConstraints=function(t){var e={audio:null,video:null};if(e.audio=!1,e.video=!1,console.log("mediaStreamConfig",t),t.audio&&(void 0===t.audioInput&&void 0===t.noiseSuppression&&void 0===t.autoGainControl&&void 0===t.echoCancellation?(e.audio={},e.audio.noiseSuppression=!0,e.audio.autoGainControl=!0,e.audio.echoCancellation=!0):(e.audio={},void 0!==t.audioInput&&null!==t.audioInput&&(e.audio.deviceId=t.audioInput),void 0!==t.noiseSuppression&&(e.audio.noiseSuppression=t.noiseSuppression),void 0!==t.autoGainControl&&(e.audio.autoGainControl=t.autoGainControl),void 0!==t.echoCancellation&&(e.audio.echoCancellation=t.echoCancellation))),t.video){var i=640,r=480,o=15,a=800;if(1===t.videoQuality?(i=n.ENUM_RESOLUTION_TYPE.LOW.width,r=n.ENUM_RESOLUTION_TYPE.LOW.height,o=n.ENUM_RESOLUTION_TYPE.LOW.frameRate,a=n.ENUM_RESOLUTION_TYPE.LOW.bitRate):2===t.videoQuality?(i=n.ENUM_RESOLUTION_TYPE.MEDIUM.width,r=n.ENUM_RESOLUTION_TYPE.MEDIUM.height,o=n.ENUM_RESOLUTION_TYPE.MEDIUM.frameRate,a=n.ENUM_RESOLUTION_TYPE.MEDIUM.bitRate):3===t.videoQuality?(i=n.ENUM_RESOLUTION_TYPE.HIGH.width,r=n.ENUM_RESOLUTION_TYPE.HIGH.height,o=n.ENUM_RESOLUTION_TYPE.HIGH.frameRate,a=n.ENUM_RESOLUTION_TYPE.HIGH.bitRate):4===t.videoQuality?(i=t.width,r=t.height,o=t.frameRate,a=t.maxBitRate||800):this.logger.info("zp.gmsc.2 user default"),!0===t.horizontal){var l=r;r=i,i=l}e.video={width:i,height:r,frameRate:o,bitRate:a},null!=t.facingMode?e.video.facingMode=t.facingMode:null!=t.videoInput&&null!=t.videoInput&&(e.video.deviceId={exact:t.videoInput}),this.logger.info("zp.gmsc.2 width: "+i+" height: "+r+" rate: "+o)}return e},t.prototype.startPreview=function(t,e,i,n){var r=this;if(this.logger.debug("zp.sv.2 called"),this.localVideo=t,this.mediaStreamConfig=e,void 0!==navigator.mediaDevices&&null!=navigator.mediaDevices.getUserMedia){if(e.externalMediaStream instanceof MediaStream)return this.logger.debug("zp.sv.2 use external media stream"),this.previewSuc=!0,this.localStream=e.externalMediaStream,this.micTrack=e.externalMediaStream.getAudioTracks().length>0?e.externalMediaStream.getAudioTracks()[0]:null,this.videoInfo={width:e.width,height:e.height,frameRate:e.frameRate,minBitRate:e.minBitRate,maxBitRate:e.maxBitRate,channelCount:e.channelCount||(this.micTrack&&this.micTrack.getSettings?this.micTrack.getSettings().channelCount:1),audioBitRate:e.audioBitRate||48e3},void(i&&i());if(e.externalCapture)this.captureStream(t,e)?(this.previewSuc=!0,i&&i()):n&&n("external capture fail");else{var o=this.getMediaStreamConstraints(e);this.videoInfo=o.video,this.videoInfo&&(this.videoInfo.minBitRate=e.minBitRate||o.video.bitRate),this.videoInfo&&(this.videoInfo.maxBitRate=e.maxBitRate||o.video.bitRate),this.videoInfo&&(this.videoInfo.audioBitRate=e.audioBitRate||48e3),this.logger.info("zp.sv.2 ",JSON.stringify(o)),navigator.mediaDevices.getUserMedia(o).then(function(t){if(r.logger.info("zp.sv.2 success"),!r.localVideo)return r.logger.info("zp.sv.2 no localVideo"),void(n&&n("no localVideo"));r.localVideo.srcObject=t,r.localStream=t,r.micTrack=t.getAudioTracks().length>0?t.getAudioTracks()[0]:null,r.videoInfo&&(r.videoInfo.channelCount=e.channelCount||(r.micTrack&&r.micTrack.getSettings?r.micTrack.getSettings().channelCount:1)),r.previewSuc=!0,i&&i()},function(t){r.logger.info("zp.sv.2 failed "+t.message),n&&n(t)})}}else n&&n("browser don't support")},t.prototype.captureStream=function(t,e){if(!t)return this.logger.info("zp.cs.2 no local video"),!1;var i,n;if(t.captureStream)i=t.captureStream(),this.logger.debug("zp.cs.2 captureStream");else{if(!t.mozCaptureStream)return this.logger.info("zp.cs.2 don't support capture stream"),!1;i=t.mozCaptureStream(),this.logger.debug("zp.cs.2 mozCaptureStream")}return 0==i.getTracks().length?(this.logger.error("zp.cs.2 external capture tracks no found"),!1):(this.localStream=i,this.micTrack=i.getAudioTracks().length>0?i.getAudioTracks()[0]:null,this.videoInfo={width:t.videoWidth,height:t.videoHeight,frameRate:e.frameRate||15,minBitRate:800,maxBitRate:800,channelCount:e.channelCount||(this.micTrack&&this.micTrack.getSettings?this.micTrack.getSettings().channelCount:1),audioBitRate:e.audioBitRate||48e3},"number"==typeof e.bitRate?(n<48&&(n=48),n>1e4&&(n=1e4),this.videoInfo.minBitRate=this.videoInfo.maxBitRate=e.bitRate):e.bitRate&&e.bitRate.minBitRate&&e.bitRate.maxBitRate&&"number"==typeof e.bitRate.minBitRate&&"number"==typeof e.bitRate.maxBitRate&&e.bitRate.minBitRate<=e.bitRate.maxBitRate&&(this.videoInfo.minBitRate=e.bitRate.minBitRate<48?48:e.bitRate.minBitRate,this.videoInfo.maxBitRate=e.bitRate.maxBitRate>1e4?1e4:e.bitRate.maxBitRate),this.logger.debug("zp.cs.2 called success"),!0)},t.prototype.stopPreview=function(){if(this.logger.info("zp.sv.2.1 called"),this.localStream){var t=this.localStream.getTracks();t.reverse(),t.forEach(function(t){t.stop()}),this.micTrack&&this.micTrack.stop(),this.localStream=null,this.localVideo.srcObject=null,this.localVideo=null,this.videoInfo=null}},t}();e.ZegoPreview=o},function(t,e,i){"use strict";var n=this&&this.__assign||Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t};Object.defineProperty(e,"__esModule",{value:!0});var r=i(0),o=i(1),a=i(12),l=i(4),s=i(5),p=i(13),h=function(){function t(t,e,i,n,a){this.state=r.ENUM_PUBLISH_STATE.stop,this.sessionId=0,this.sessionToken="",this.waitingICETimeInterval=5e3,this.waitingAnswerTimeInterval=5e3,this.candidateInfo=[],this.waitingICETimer=null,this.waitingAnswerTimer=null,this.qualityTimer=null,this.publishQualityList=[],this.maxQualityListCount=10,this.lastPublishStats={},this.reportSeq=o.getSeq(),this.qualityUpload=!1,this.qualityUploadInterval=3e4,this.qualityUploadLastTime=0,this.qualitySeq=0,this.videoInfo={width:0,height:0,frameRate:0,minBitRate:0,maxBitRate:0,channelCount:1,audioBitRate:48e3},this.streamGoogInfo={},this.mediaStreamConfig=null,this.offerSeq=0,this.audioMixList=[],this.arrayBufferMap={},this.qualityCount=0,this.closeSessionSignal=!1,this.localSdpRevert=!1,this.videoDecodeType="H264",this.stateNego=r.ENUM_PUBLISH_STATE_NEGO.stop,this.negoInterval=25e3,this.publishEvent=!1,this.soundLevel=0,this.script=null,this.mic=null,this.logger=t,this.signal=e,this.dataReport=i,this.streamCenter=a,this.ac=this.streamCenter.ac,this.qualityTimeInterval=n,this.audioMixing=new l.audioMixUtil(t,this.ac),i.newReport(this.reportSeq)}return t.prototype.publishStateUpdateError=function(t,e){this.logger.error("zp.psue.0 call ",this.streamId,JSON.stringify(t)),this.streamId&&this.onPublishStateUpdate(o.ENUM_PUBLISH_STATE_UPDATE.error,this.streamId,t,e),this.logger.info("zp.psue.0 ended")},t.prototype.resetPublish=function(){this.logger.info("zp.rp.0 call"),this.streamId=null,this.state=r.ENUM_PUBLISH_STATE.stop,this.publishEvent=!1,null==this.peerConnection&&null==this.peerConnection||(this.peerConnection.close(),this.peerConnection=null),null!=this.waitingAnswerTimer&&(clearTimeout(this.waitingAnswerTimer),this.waitingAnswerTimer=null),null!=this.waitingICETimer&&(clearTimeout(this.waitingICETimer),this.waitingICETimer=null),null!=this.negoTimer&&(clearTimeout(this.negoTimer),this.negoTimer=null),this.clearPublishQualityTimer(),this.signal&&(this.signal.unregisterPushCallback("CandidateInfoPush",this.sessionId),this.signal.unregisterPushCallback("MediaDescPush",this.sessionId),this.signal.unregisterPushCallback("CloseSessionPush",this.sessionId)),this.sessionSeq=0,this.offerSeq=0,this.candidateInfo=[],this.publishQualityList=[],this.qualityUploadLastTime=0},t.prototype.clearPublishQualityTimer=function(){null!=this.qualityTimer&&(clearInterval(this.qualityTimer),this.qualityTimer=null),this.lastPublishStats={},this.qualityCount=0},t.prototype.shouldSendCloseSession=function(t){return this.state!=r.ENUM_PUBLISH_STATE.stop&&this.state!=r.ENUM_PUBLISH_STATE.waitingSessionRsp},t.prototype.startPublish=function(t,e,i,n,a){var l=this;if(this.logger.info("zp.sp.0 called"),this.signal&&this.signal.negoInterval&&(this.negoInterval=this.signal.negoInterval),t){if(this.peerConnection&&this.stateNego==r.ENUM_PUBLISH_STATE_NEGO.iceConnected)return this.logger.info("zp.sp.0 ice connected"),this.signal.addSession(this.sessionId,this.sessionToken),void this.onPublishStateUpdate(o.ENUM_PUBLISH_STATE_UPDATE.start,this.streamId,null,!0);this.streamId=t,this.localStream=e,this.mediaStreamConfig=n,this.playOption=a||{},navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&(n.externalCapture||n.externalMediaStream)&&(this.localStream.onaddtrack=function(){l.logger.info("zp.sp.0 Track added");var t=l.localStream.getVideoTracks(),e=l.localStream.getAudioTracks();if(t.length>1)l.peerConnection.getSenders().find(function(e){return e.track.kind===t[1].kind}).replaceTrack(t[1]),l.localStream.removeTrack(t[0]);else if(e.length>1){l.peerConnection.getSenders().find(function(t){return t.track.kind===e[1].kind}).replaceTrack(e[1]),l.localStream.removeTrack(e[0])}}),i&&(this.videoInfo=i),a&&a.videoDecodeType&&(this.videoDecodeType=a.videoDecodeType),this.sessionSeq=o.getSeq(),this.dataReport.eventStart(this.reportSeq,"CreateSession");var s=t;1==this.streamCenter.testEnvironment&&(s="zegotest-"+this.streamCenter.appid+"-"+t),this.signal.createSession(this.sessionSeq,0,0,s,a&&a.streamParams,function(t,e,i){l.dataReport.eventEndWithMsg(l.reportSeq,"CreateSession",{sessionId:i.session_id}),l.logger.info("zp.sp.0 sessionId:"+i.session_id),l.sessionSeq==t?0!==i.result?(l.logger.error("zp.sp.0 create session failed "+i.result),l.publishStateUpdateError(o.publishErrorList.CREATE_SESSION_ERROR)):(l.sessionId=i.session_id,l.sessionToken=i.session_token,l.logger.debug("zp.sp.0 create session success "+l.sessionId),l.onCreatePublishSessionSuccess(i)):l.logger.error("zp.sp.0 seq is not match.")},function(t,e){l.dataReport.eventEndWithMsg(l.reportSeq,"CreateSession",{error:t}),l.publishStateUpdateError(o.publishErrorList.SEND_SESSION_TIMEOUT)}),this.state=r.ENUM_PUBLISH_STATE.waitingSessionRsp,this.logger.info("zp.sp.0 called success"),this.stateNego=r.ENUM_PUBLISH_STATE_NEGO.start,this.negoTimer=setTimeout(function(){l.logger.error("zp.sp.0 waiting timeout"),l.publishStateUpdateError(o.publishErrorList.SERVER_NEGO_TIMEOUT)},this.negoInterval)}else this.logger.error("zp.sp.0 streamId is null")},t.prototype.onCreatePublishSessionSuccess=function(t){var e=this;this.logger.info("zp.ops.0 called");var i=[];t.turn_server&&i.push(t.turn_server),t.stun_server&&i.push(t.stun_server);var n={iceTransportPolicy:"relay",iceServers:[{urls:i,username:t.turn_username,credential:t.turn_auth_key}]};this.logger.info("zp.ops.0 username: "+t.turn_username),this.logger.info("zp.ops.0 credential: "+t.turn_auth_key),this.peerConnection=new RTCPeerConnection(n),this.peerConnection.onicecandidate=function(t){e.onIceCandidate(t)},this.peerConnection.onsignalingstatechange=function(t){e.onConnectionStateChange(t)},this.peerConnection.oniceconnectionstatechange=function(t){e.onIceConnectionStateChange(t)};var r=[],a=[];this.localStream&&(this.localStream.getTracks().forEach(function(t){e.peerConnection.addTrack(t,e.localStream)}),r=this.localStream.getVideoTracks(),a=this.localStream.getAudioTracks(),console.warn("getConstraints",a&&a[0]&&a[0].getConstraints&&a[0].getConstraints()),r.length>0&&this.logger.info("zp.ops.0 video device: "+r[0].label),a.length>0&&this.logger.info("zp.ops.0 audio device: "+a[0].label));var l={offerToReceiveAudio:a.length>0?1:0,offerToReceiveVideo:r.length>0?1:0};this.logger.info("zp.ops.0 createOffer: "+JSON.stringify(l)),this.dataReport.eventStart(this.reportSeq,"CreateOffer"),this.peerConnection.createOffer(l).then(function(t){e.dataReport.eventEnd(e.reportSeq,"CreateOffer"),e.onCreateOfferSuccess(t)},function(t){e.dataReport.eventEndWithMsg(e.reportSeq,"CreateOffer",{error:t.toString()}),e.logger.error("zp.ops.0 create offer error "+t.toString()),e.publishStateUpdateError(o.publishErrorList.CREATE_OFFER_ERROR,!0)}),this.signal.registerPushCallback("CandidateInfoPush",this.sessionId,function(t,i,n){e.onRecvCandidateInfo(t,i,n)}),this.signal.registerPushCallback("CloseSessionPush",this.sessionId,function(t,i,n){e.onRecvCloseSession(t,i,n)}),this.signal.registerPushCallback("MediaDescPush",this.sessionId,function(t,i,n){e.onRecvMediaDescription(t,i,n)}),this.signal.registerPushCallback("SessionResetPush",this.sessionId,function(t,i,n){e.onRecvResetSession(t,i,n)}),this.signal.registerPushCallback("PublishEventPush",this.sessionId,function(t,i,n){e.onRecvPublishEvent(t,i,n)}),this.logger.debug("zp.ops.0 call success")},t.prototype.onCreateOfferSuccess=function(t){var e=this;0!=this.videoInfo.maxBitRate&&(t.sdp=this.updateBandwidthRestriction(t.sdp,this.videoInfo.maxBitRate)),t.sdp=t.sdp.replace(/sendrecv/g,"sendonly"),t.sdp=t.sdp.replace(/useinbandfec=\d+/,"maxaveragebitrate="+this.videoInfo.audioBitRate+(2==this.videoInfo.channelCount?";stereo=1":"")),/m=video[\s\S]*m=audio/.test(t.sdp)&&(this.localSdpRevert=!0),t.sdp=s.sdpUtil.getSDPByVideDecodeType(t.sdp,this.videoDecodeType),this.logger.info("zp.oco.0 localSdp1 "+t.sdp.substr(0,t.sdp.length/2)),this.logger.info("zp.oco.0 localSdp2 "+t.sdp.substr(t.sdp.length/2)),this.dataReport.eventStart(this.reportSeq,"SetLocalDescription"),this.peerConnection.setLocalDescription(t).then(function(){e.dataReport.eventEnd(e.reportSeq,"SetLocalDescription"),e.onSetLocalDescriptionSuccess(t)},function(t){e.dataReport.eventEndWithMsg(e.reportSeq,"SetLocalDescription",{error:t.toString()}),e.logger.error("zp.oco.0 error "+t.toString()),e.publishStateUpdateError(o.publishErrorList.SET_LOCAL_DESC_ERROR,!0)})},t.prototype.updateBandwidthRestriction=function(t,e){var i="AS";return"firefox"===a.browserDetails.browser&&(e=1e3*(e>>>0),i="TIAS"),t=-1===t.indexOf("b="+i+":")?(t=t.replace(/c=IN (.*)\r\n/g,"c=IN $1\r\nb="+i+":"+e+"\r\n")).replace("b="+i+":"+e+"\r\n",""):(t=t.replace(new RegExp("b="+i+":.*\r\n","g"),"b="+i+":"+e+"\r\n")).replace("b="+i+":"+e+"\r\n","")},t.prototype.onSetLocalDescriptionSuccess=function(t){var e=this;this.logger.info("zp.osd.0 success");var i={sdp:t.sdp,width:this.videoInfo.width,height:this.videoInfo.height,frameRate:this.videoInfo.frameRate,video_min_kpbs:this.videoInfo.minBitRate,video_max_kpbs:this.videoInfo.maxBitRate,audio_kpbs:48,keyframe_intv:2};this.offerSeq=o.getSeq(),this.dataReport.eventStart(this.reportSeq,"SendMediaDesc"),this.signal.sendMediaDesc(this.offerSeq,this.sessionId,0,i,function(t,i,n){e.offerSeq==t&&e.sessionId==i?(e.logger.info("zp.osd.0 send success"),e.dataReport.eventEnd(e.reportSeq,"SendMediaDesc"),e.waitingAnswerTimer=setTimeout(function(){e.state==r.ENUM_PUBLISH_STATE.waitingServerAnswer&&(e.logger.error("zp.osd.0 waiting timeout"),e.publishStateUpdateError(o.publishErrorList.SERVER_MEDIA_DESC_TIMEOUT))},e.waitingAnswerTimeInterval),e.logger.info("zp.osd.0 send success stateNego:waiterAnswer"),e.stateNego=r.ENUM_PUBLISH_STATE_NEGO.waiterAnswer,e.state=r.ENUM_PUBLISH_STATE.waitingServerAnswer):e.logger.error("zp.osd.0 seq or sessionId is not equal")},function(t,i){e.dataReport.eventEndWithMsg(e.reportSeq,"SendMediaDesc",{error:t}),e.publishStateUpdateError(o.publishErrorList.SEND_MEDIA_DESC_TIMEOUT)}),this.state=r.ENUM_PUBLISH_STATE.waitingOffserRsp,this.logger.debug("zp.osd.0 call success")},t.prototype.onRecvMediaDescription=function(t,e,i){this.logger.info("zp.ormd.0 received"),this.state==r.ENUM_PUBLISH_STATE.waitingServerAnswer?(this.stateNego=r.ENUM_PUBLISH_STATE_NEGO.waitingCandidate,this.logger.info("zp.orm.0 received stateNego:waitingCandidate"),null!=this.waitingAnswerTimer&&(clearTimeout(this.waitingAnswerTimer),this.waitingAnswerTimer=null),this.dataReport.addEvent(this.reportSeq,"RecvMediaDesc"),this.signal.sendMediaDescAck(t,this.sessionId,0),1==i.type?this.onGetRemoteOfferSucceses(i.sdp):this.publishStateUpdateError(o.publishErrorList.SERVER_MEDIA_DESC_ERROR)):this.logger.info("zp.ormd.0 current state "+this.state+" not allowed")},t.prototype.onGetRemoteOfferSucceses=function(t){var e=this;if(48e3!==this.videoInfo.audioBitRate&&(t=t.replace(/maxaveragebitrate=(\d+)/,"maxaveragebitrate="+this.videoInfo.audioBitRate)),this.localSdpRevert){var i=[/[\s\S]*m=audio/.exec(t)[0].replace("m=audio",""),/m=video[\s\S]*/.exec(t)[0],/m=audio[\s\S]*m=video/.exec(t)[0].replace("m=video","")],n=i[0],a=i[1],l=i[2],s=/a=group:BUNDLE\s+(\w+)\s+(\w+)/.exec(n);t=(n=n.replace(/a=group:BUNDLE\s+(\w+)\s+(\w+)/,"a=group:BUNDLE "+s[2]+" "+s[1]))+a+l}this.logger.info("zp.oro.0 remoteSdp:",t);var p={type:"answer",sdp:t,toJSON:function(){}};this.dataReport.eventStart(this.reportSeq,"SetRemoteDescription"),this.peerConnection.setRemoteDescription(new RTCSessionDescription(p)).then(function(){e.logger.info("zp.oro.0 set success"),e.dataReport.eventEnd(e.reportSeq,"SetRemoteDescription")},function(t){e.logger.error("zp.oro.0 failed: "+t.toString()),e.dataReport.eventEndWithMsg(e.reportSeq,"SetRemoteDescription",{error:t.toString()}),e.publishStateUpdateError(o.publishErrorList.SET_REMOTE_DESC_ERROR,!0)}),this.state=r.ENUM_PUBLISH_STATE.waitingServerICE,this.waitingICETimer=setTimeout(function(){e.state==r.ENUM_PUBLISH_STATE.waitingServerICE&&(e.logger.error("zp.orod.0 waiting server timeout"),e.publishStateUpdateError(o.publishErrorList.SERVER_CANDIDATE_TIMEOUT))},this.waitingICETimeInterval),this.logger.debug("zp.oro.0 call success")},t.prototype.onIceConnectionStateChange=function(t){this.state!=r.ENUM_PUBLISH_STATE.stop&&null!=this.peerConnection&&(this.logger.info("zp.oics.0 stateChanged "+this.peerConnection.iceConnectionState),"connected"===this.peerConnection.iceConnectionState?(this.logger.info("zp.oics.0 connected state "+this.state),this.dataReport.eventEnd(this.reportSeq,"IceConnected"),this.stateNego=r.ENUM_PUBLISH_STATE_NEGO.iceConnected,this.logger.info("zp.oisc.0  stateNego:iceConnected"),this.negoTimer&&(clearTimeout(this.negoTimer),this.negoTimer=null),this.publishEvent&&this.publishSuccess()):"closed"===this.peerConnection.iceConnectionState?(this.dataReport.addEvent(this.reportSeq,"IceClosed"),this.stateNego=r.ENUM_PUBLISH_STATE_NEGO.iceClosed,this.checkPublishConnectionFailedState(this.peerConnection.iceConnectionState)):"failed"===this.peerConnection.iceConnectionState?(this.dataReport.addEvent(this.reportSeq,"IceFailed"),this.stateNego=r.ENUM_PUBLISH_STATE_NEGO.iceFailed,this.checkPublishConnectionFailedState(this.peerConnection.iceConnectionState)):"disconnected"===this.peerConnection.iceConnectionState&&(this.dataReport.addEvent(this.reportSeq,"IceDisconnected"),this.stateNego=r.ENUM_PUBLISH_STATE_NEGO.iceDisconnected,this.checkPublishConnectionFailedState(this.peerConnection.iceConnectionState)))},t.prototype.onIceCandidate=function(t){if(this.logger.info("zp.oic.0 candidate"+t.candidate),t.candidate)if(this.logger.info("zp.oic.0 candidate"+t.candidate.candidate),this.state<r.ENUM_PUBLISH_STATE.connecting||this.state==r.ENUM_PUBLISH_STATE.stop)this.candidateInfo.push({candidate:t.candidate.candidate,sdpMid:t.candidate.sdpMid,sdpMLineIndex:t.candidate.sdpMLineIndex});else{var e={candidate:t.candidate.candidate,sdpMid:t.candidate.sdpMid,sdpMLineIndex:t.candidate.sdpMLineIndex};this.sendCandidateInfo([e])}},t.prototype.sendCandidateInfo=function(t){var e=this;this.logger.info("zp.sci.0 called"),!(t=t.filter(function(t){return t.candidate.indexOf("relay")>0}))||t.length<1?this.logger.info("zp.sci.0 cancelled"):(this.dataReport.eventStart(this.reportSeq,"SendIceCandidate"),this.stateNego!==r.ENUM_PUBLISH_STATE_NEGO.iceConnected&&(this.stateNego=r.ENUM_PUBLISH_STATE_NEGO.sendCandidate),this.logger.info("zp.sci.0  stateNego:sendCandidate"),this.signal.sendCandidateInfo(o.getSeq(),this.sessionId,t,function(t,i,n){e.logger.info("zp.sci.0 send success"),e.dataReport.eventEnd(e.reportSeq,"SendIceCandidate")},function(t,i){e.logger.error("zp.sci.0 failed to send: "+t.toString()),e.dataReport.eventEndWithMsg(e.reportSeq,"SendIceCandidate",{error:t}),e.publishStateUpdateError(o.publishErrorList.SEND_CANDIDATE_TIMEOUT)}))},t.prototype.onConnectionStateChange=function(t){this.logger.info("zp.ocs.0 called "+t.target.signalingState)},t.prototype.onRecvCandidateInfo=function(t,e,i){var n=this;if(this.logger.info("zp.oci.0 received "+JSON.stringify(i.infos)),this.state==r.ENUM_PUBLISH_STATE.waitingServerICE){null!=this.waitingICETimer&&(clearTimeout(this.waitingICETimer),this.waitingICETimer=null),this.dataReport.addEvent(this.reportSeq,"RecvIceCandidate"),this.signal.sendCandidateInfoAck(t,this.sessionId,0),this.sendCandidateInfo(this.candidateInfo),this.candidateInfo=[];for(var a=0;a<i.infos.length;a++){var l={sdpMid:i.infos[a].sdpMid,sdpMLineIndex:i.infos[a].sdpMLineIndex,candidate:i.infos[a].candidate};this.logger.debug("zp.orci.0 candidate "+l.candidate),this.peerConnection.addIceCandidate(new RTCIceCandidate(l)).then(function(){n.logger.debug("zp.oci.0 add success")},function(t){n.logger.error("zp.oci.0 add error "+t.toString()),n.publishStateUpdateError(o.publishErrorList.SERVER_CANDIDATE_ERROR,!0)})}this.state=r.ENUM_PUBLISH_STATE.connecting,this.dataReport.eventStart(this.reportSeq,"IceConnected")}else this.logger.info("zp.oci.0 current state "+this.state+" not allowed")},t.prototype.onRecvCloseSession=function(t,e,i){this.logger.info("zp.orcs.0 reason: "+i.reason),this.dataReport.addEvent(this.reportSeq,"RecvCloseSession"),this.signal.sendCloseSessionAck(t,this.sessionId,0);var n=JSON.parse(JSON.stringify(o.publishErrorList.SESSION_CLOSED));n.msg+=" reason:"+i.reason+(i.err_info&&JSON.parse(i.err_info).action?"action:"+JSON.parse(i.err_info).action:""),this.negoTimer&&clearTimeout(this.negoTimer);var r=1*i.reason,a=i.err_info&&JSON.parse(i.err_info).action?JSON.parse(i.err_info).action:null,l=![4,8,10,11,12,14,26,27].includes(r)&&5!=a&&2!=a;this.publishStateUpdateError(n,l)},t.prototype.onRecvResetSession=function(t,e,i){if(this.logger.info("zp.orrs.0 received "),e==this.sessionId){this.dataReport.addEvent(this.reportSeq,"RecvResetSession"),this.signal.sendCloseSessionAck(t,this.sessionId,0);var n=JSON.parse(JSON.stringify(o.publishErrorList.SESSION_CLOSED));this.negoTimer&&clearTimeout(this.negoTimer),this.publishStateUpdateError(n)}else this.logger.error("zp.orrs.0 cannot find session")},t.prototype.onRecvPublishEvent=function(t,e,i){this.logger.info("zp.orpe.0 received"),this.publishEvent=!0,this.stateNego===r.ENUM_PUBLISH_STATE_NEGO.iceConnected&&0==i.event&&this.publishSuccess()},t.prototype.checkPublishConnectionFailedState=function(t){var e=null;"failed"==t?e=o.publishErrorList.MEDIA_CONNECTION_FAILED:"closed"==t?e=o.publishErrorList.MEDIA_CONNECTION_CLOSED:"disconnected"==t&&(e=o.publishErrorList.MEDIA_CONNECTION_DISCONNECTED),null!=e&&(this.logger.info("zp.oics.0  state "+this.state+" connectionState "+t),this.publishStateUpdateError(e))},t.prototype.setPublishQualityTimer=function(){var t=this;if(null==this.qualityTimer){this.logger.info("zp.spq.0 called"),this.clearPublishQualityTimer();var e=!0;this.peerConnection.getStats(function(){}).catch(function(i){t.logger.info("zp.spq.0 "+t.streamId+" getStats callback not support"),e=!1}),this.qualityTimer=setInterval(function(){t.peerConnectionGetStats(e)},this.qualityTimeInterval),this.lastPublishStats={time:0,audioBytesSent:0,videoBytesSent:0,framesEncoded:0,framesSent:0},this.qualitySeq=o.getSeq(),this.qualityCount=0,this.dataReport.newReport(this.qualitySeq)}},t.prototype.peerConnectionGetStats=function(t){var e=this;this.peerConnection&&(t&&this.peerConnection.getStats(function(t){e.getOldGoogStats(t)},function(t){e.logger.info("zp.spq.0 getOldGoogStats error "+t.toString())}),this.peerConnection.getStats(null).then(function(t){e.getPublishStats(t)},function(t){e.logger.info("zp.spq.0 getStats error "+t.toString())}))},t.prototype.getOldGoogStats=function(t){var e=this;t&&t.result&&t.result().forEach(function(t){var i=["audioInputLevel","googCpuLimitedResolution","googBandwidthLimitedResolution","googCodecName","googActualEncBitrate","googFrameWidthInput","googFrameHeightInput","googFrameRateInput","codecImplementationName"];if("VideoBwe"===t.type&&(e.streamGoogInfo.googAvailableSendBandwidth=t.stat("googAvailableSendBandwidth")||""),"ssrc"===t.type)for(var n=0;n<i.length;n++){var r=i[n];t.names().includes(r)&&(e.streamGoogInfo[r]=t.stat(r)||"")}})},t.prototype.getPublishStats=function(t){var e=this;if(t){var i=n({audioCodeType:"opus",audioBitrate:0,videoBitrate:0,audioLevel:0,audioFPS:0,videoFPS:0,nackCount:0,pliCount:0,frameHeight:0,frameWidth:0,videoTransferFPS:0,totalRoundTripTime:0,currentRoundTripTime:0,muted:!this.localVideo||this.localVideo.muted,paused:!this.localVideo||this.localVideo.paused,volume:this.localVideo?this.localVideo.volume:0,audioDeviceLabel:this.streamCenter.audioDeviceName,videoDeviceLbabel:this.streamCenter.videoDeviceName},this.streamCenter.deviceStates,this.streamGoogInfo),r=this.lastPublishStats.time;t.forEach(function(t){("outbound-rtp"==t.type||"ssrc"==t.type&&null!=t.bytesSent)&&"audio"==t.mediaType?(0!=r&&(i.audioBitrate=8*(t.bytesSent-e.lastPublishStats.audioBytesSent)/(t.timestamp-r),i.audioFPS=(t.packetsSent-(t.retransmittedPacketsSent-e.lastPublishStats.audioRetransmittedPacketsSent)-e.lastPublishStats.audioPacketsSent)/(t.timestamp-r)*1e3),i.audioBitrate<0&&(i.audioBitrate=0),e.lastPublishStats.audioBytesSent=t.bytesSent,e.lastPublishStats.time=t.timestamp,e.lastPublishStats.audioPacketsSent=t.packetsSent,e.lastPublishStats.audioRetransmittedPacketsSent=t.retransmittedPacketsSent):("outbound-rtp"==t.type||"ssrc"==t.type&&null!=t.bytesSent)&&"video"==t.mediaType?(0!=r&&(i.videoBitrate=8*(t.bytesSent-e.lastPublishStats.videoBytesSent)/(t.timestamp-r),i.videoFPS=1e3*(t.framesEncoded-e.lastPublishStats.framesEncoded)/(t.timestamp-r)),i.videoBitrate<0&&(i.videoBitrate=0),i.videoFPS<0&&(i.videoFPS=0),i.nackCount=t.nackCount,i.pliCount=t.pliCount,e.lastPublishStats.videoBytesSent=t.bytesSent,e.lastPublishStats.framesEncoded=t.framesEncoded,e.lastPublishStats.time=t.timestamp):"track"==t.type&&("video"==t.kind||t.id.indexOf("video")>=0)||t.frameWidth?(i.frameHeight=t.frameHeight,i.frameWidth=t.frameWidth,0!=r&&(i.videoTransferFPS=1e3*(t.framesSent-e.lastPublishStats.framesSent)/(t.timestamp-r)),i.videoTransferFPS<0&&(i.videoTransferFPS=0),e.lastPublishStats.framesSent=t.framesSent):"candidate-pair"==t.type?(null!=t.totalRoundTripTime&&(i.totalRoundTripTime=t.totalRoundTripTime),null!=t.currentRoundTripTime&&(i.currentRoundTripTime=t.currentRoundTripTime)):"media-source"==t.type&&("audio"==t.kind||t.id.toLowerCase().indexOf("audio")>=0)&&(i.audioLevel=t.audioLevel)}),this.uploadPublishQuality(i),0!=r&&this.onPublishQualityUpdate(this.streamId,i)}},t.prototype.uploadPublishQuality=function(t){var e=this;if(this.qualityUpload){var i=Date.parse(new Date+"");(0==this.qualityUploadLastTime||i-this.qualityUploadLastTime>=this.qualityUploadInterval)&&(t.stream_type="publish",t.stream_id=this.streamId,t.timeStamp=i/1e3,this.logger.info("zp.upq.0 upload"+JSON.stringify(t)),this.signal.QualityReport(o.getSeq(),this.sessionId,t,function(t,i,n){void 0!==n.report&&(e.qualityUpload=n.report,e.qualityUploadInterval=n.report_interval_ms)},function(t,i){e.logger.info("zp.upq.0 upload failed "+t)}),this.qualityUploadLastTime=i)}},t.prototype.stopPublish=function(){if(this.logger.info("zp.sp.0.1 called"),Object.keys(this.streamCenter.publisherList).length=1)for(var t in this.streamCenter.playerList){var e=this.streamCenter.playerList[t].player;e.state==r.ENUM_PLAY_STATE.playing&&e.broadcasterStatus==r.ENUM_BROADCASTER_STATUS.start&&(this.signal&&this.signal.sendBroadcasterStatus(o.getSeq(),e.sessionId,0),e.broadcasterStatus=r.ENUM_BROADCASTER_STATUS.stop)}this.stopMixingAudio(),this.stopMixingBuffer(),this.sessionId&&!this.closeSessionSignal&&this.signal.sendCloseSession(o.getSeq(),this.sessionId,0),this.dataReport.eventEndWithMsg(this.reportSeq,"PublishState",{state:this.state+""}),this.dataReport.addEvent(this.reportSeq,"StopPublish"),this.dataReport.addMsgExt(this.reportSeq,{stream:this.streamId,sessionId:this.sessionId}),this.dataReport.uploadReport(this.reportSeq,"RTCPublishStream"),this.resetPublish()},t.prototype.onPublishStateUpdate=function(t,e,i,n){},t.prototype.onPublishQualityUpdate=function(t,e){},t.prototype.onDisconnect=function(){this.logger.info("zp.od.0 call"),this.logger.info("zp.od.0 websocket disconnect"),this.dataReport.addEvent(this.reportSeq,"OnDisconnect"),this.publishStateUpdateError(o.publishErrorList.WEBSOCKET_ERROR)},t.prototype.playEffect=function(t,e,i,n){this.audioMixing.localStream=this.localStream,this.audioMixing.peerConnection=this.peerConnection,this.audioMixing.audioBuffer=e,this.micTrack||(this.micTrack=this.localStream.getAudioTracks().length>0?this.localStream.getAudioTracks()[0]:null),this.audioMixing.playEffect(t.playTime,t.loop,t.replace,i,n)},t.prototype.pauseEffect=function(){this.audioMixing.pauseEffect()},t.prototype.resumeEffect=function(){this.audioMixing.resumeEffect()},t.prototype.stopMixingBuffer=function(){return this.audioMixing.isMixAudio&&(this.audioMixing.stopMingBuffer(),this.rebackMic()),!0},t.prototype.mixingBuffer=function(t,e){this.audioMixing.localStream=this.localStream,this.audioMixing.peerConnection=this.peerConnection,this.micTrack||(this.micTrack=this.localStream.getAudioTracks().length>0?this.localStream.getAudioTracks()[0]:null),this.audioMixing.mixingBuffer(t,e)},t.prototype.voiceChange=function(t){var e=null,i=null;if(this.pitchEffect||(this.pitchEffect=new p.pitchUtil(this.ac),e=this.ac.createMediaStreamSource(this.localStream),i=this.ac.createMediaStreamDestination(),e.connect(this.pitchEffect.input),this.pitchEffect.output.connect(i)),this.pitchEffect.setPitchOffset(t),!this.micTrack){var n=i.stream.getAudioTracks()[0],r=this.peerConnection.getSenders().find(function(t){return t.track.kind===n.kind});if(!r)return this.logger.error("zp.vc.0 no sender"),!1;this.micTrack||(this.micTrack=this.localStream.getAudioTracks().length>0?this.localStream.getAudioTracks()[0]:null),r.replaceTrack(n),this.localStream.removeTrack(this.micTrack),this.localStream.addTrack(n)}},t.prototype.voiceBack=function(){var t=this;this.micTrack?(this.peerConnection.getSenders().find(function(e){return e.track.kind===t.micTrack.kind}).replaceTrack(this.micTrack),this.localStream.removeTrack(this.localStream.getAudioTracks()[0]),this.localStream.addTrack(this.micTrack),this.pitchEffect=null):this.logger.error("zp.vb.0 mo mickTrack found")},t.prototype.publishSuccess=function(){for(var t in this.state!=r.ENUM_PUBLISH_STATE.publishing&&this.onPublishStateUpdate(o.ENUM_PUBLISH_STATE_UPDATE.start,this.streamId,null,!0),this.state=r.ENUM_PUBLISH_STATE.publishing,this.dataReport.eventStart(this.reportSeq,"PublishState"),this.streamCenter.playerList){var e=this.streamCenter.playerList[t].player;e.state==r.ENUM_PLAY_STATE.playing&&e.broadcasterStatus==r.ENUM_BROADCASTER_STATUS.stop&&(this.signal&&this.signal.sendBroadcasterStatus(o.getSeq(),e.sessionId,1),e.broadcasterStatus=r.ENUM_BROADCASTER_STATUS.start)}this.setPublishQualityTimer();var i=2,n=2;0!==this.localStream.getVideoTracks().length&&1==this.localStream.getVideoTracks()[0].enabled&&(i=0),0!==this.localStream.getAudioTracks().length&&1==this.localStream.getAudioTracks()[0].enabled&&(n=0),this.signal.sendStreamStatus(o.getSeq(),this.sessionId,i,n,this.streamId),this.streamCenter.soundLevelDelegate&&this.startSoundLevel()},t.prototype.startSoundLevel=function(){var t=this;if(this.localStream&&0!=this.localStream.getAudioTracks().length){this.script&&this.script.disconnect()&&(this.script=null),this.mic&&this.mic.disconnect()&&(this.mic=null);try{this.mic=this.ac.createMediaStreamSource(this.localStream),this.script=this.ac.createScriptProcessor(4096,1,1),this.mic.connect(this.script),this.script.connect(this.ac.destination),this.script.onaudioprocess=function(e){for(var i=e.inputBuffer.getChannelData(0),n=0,r=0;r<i.length;r++)n<i[r]&&(n=i[r]);t.soundLevel=100*n},this.ac.resume()}catch(t){this.logger.error("zp.ssl.0 get sound level failed "+t)}}else this.logger.info("zp.ssl.0 local stream no found")},t.prototype.stopSoundLevel=function(){this.logger.info("zp.ssl.0.1 call streamID: "+this.streamId),this.script&&this.script.disconnect(),this.mic&&this.mic.disconnect(),this.script=null,this.mic=null},t.prototype.startMixingAudio=function(t){var e=this;return this.logger.info("zp.sma.0 call"),this.micTrack||(this.micTrack=this.localStream.getAudioTracks().length>0?this.localStream.getAudioTracks()[0]:null),t.forEach(function(t){if(e.audioMixList.find(function(e){return e.media==t}))e.logger.info("zp.sma.0 mix audio already exist");else{var i=new l.audioMixUtil(e.logger,e.ac);i.localStream=e.localStream,i.peerConnection=e.peerConnection,e.audioMixList.push({audioMix:i,media:t}),i.startMixingAudio(t)}}),!0},t.prototype.stopMixingAudio=function(t){var e=this;return this.logger.info("zp.sma.0.0 call"),t?t.forEach(function(t){for(var i=0;i<e.audioMixList.length;i++)if(e.audioMixList[i].media==t){e.audioMixList[i].audioMix.stopMixingAudio()&&e.audioMixList.splice(i--,1);break}}):(this.audioMixList.forEach(function(t){return t.audioMix.stopMixingAudio()}),this.audioMixList=[],this.audioMixing.isMixAudio&&this.audioMixing.stopMixingAudio()),this.rebackMic(),!0},t.prototype.rebackMic=function(){var t=this;this.peerConnection&&this.micTrack instanceof MediaStreamTrack&&0==this.audioMixList.length&&0==Object.keys(this.arrayBufferMap).length&&(this.peerConnection.getSenders().find(function(e){return e.track.kind===t.micTrack.kind}).replaceTrack(this.micTrack),this.localStream.removeTrack(this.localStream.getAudioTracks()[0]),this.localStream.addTrack(this.micTrack))},t}();e.ZegoPublish=h},function(t,e,i){var n;t.exports=function t(e,i,r){function o(l,s){if(!i[l]){if(!e[l]){var p="function"==typeof n&&n;if(!s&&p)return n(l,!0);if(a)return a(l,!0);var h=new Error("Cannot find module '"+l+"'");throw h.code="MODULE_NOT_FOUND",h}var u=i[l]={exports:{}};e[l][0].call(u.exports,function(t){var i=e[l][1][t];return o(i||t)},u,u.exports,t,e,i,r)}return i[l].exports}for(var a="function"==typeof n&&n,l=0;l<r.length;l++)o(r[l]);return o}({1:[function(t,e,i){"use strict";var n=t("./adapter_factory.js"),r=(0,n.adapterFactory)({window:window});e.exports=r},{"./adapter_factory.js":2}],2:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.adapterFactory=function(){var t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).window,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0},i=r.log,n=r.detectBrowser(t),o={browserDetails:n,commonShim:v,extractVersion:r.extractVersion,disableLog:r.disableLog,disableWarnings:r.disableWarnings};switch(n.browser){case"chrome":if(!a||!a.shimPeerConnection||!e.shimChrome)return i("Chrome shim is not included in this adapter release."),o;i("adapter.js shimming chrome."),o.browserShim=a,a.shimGetUserMedia(t),a.shimMediaStream(t),a.shimPeerConnection(t),a.shimOnTrack(t),a.shimAddTrackRemoveTrack(t),a.shimGetSendersWithDtmf(t),a.shimGetStats(t),a.shimSenderReceiverGetStats(t),a.fixNegotiationNeeded(t),v.shimRTCIceCandidate(t),v.shimConnectionState(t),v.shimMaxMessageSize(t),v.shimSendThrowTypeError(t),v.removeAllowExtmapMixed(t);break;case"firefox":if(!h||!h.shimPeerConnection||!e.shimFirefox)return i("Firefox shim is not included in this adapter release."),o;i("adapter.js shimming firefox."),o.browserShim=h,h.shimGetUserMedia(t),h.shimPeerConnection(t),h.shimOnTrack(t),h.shimRemoveStream(t),h.shimSenderGetStats(t),h.shimReceiverGetStats(t),h.shimRTCDataChannel(t),v.shimRTCIceCandidate(t),v.shimConnectionState(t),v.shimMaxMessageSize(t),v.shimSendThrowTypeError(t);break;case"edge":if(!s||!s.shimPeerConnection||!e.shimEdge)return i("MS edge shim is not included in this adapter release."),o;i("adapter.js shimming edge."),o.browserShim=s,s.shimGetUserMedia(t),s.shimGetDisplayMedia(t),s.shimPeerConnection(t),s.shimReplaceTrack(t),v.shimMaxMessageSize(t),v.shimSendThrowTypeError(t);break;case"safari":if(!c||!e.shimSafari)return i("Safari shim is not included in this adapter release."),o;i("adapter.js shimming safari."),o.browserShim=c,c.shimRTCIceServerUrls(t),c.shimCreateOfferLegacy(t),c.shimCallbacksAPI(t),c.shimLocalStreamsAPI(t),c.shimRemoteStreamsAPI(t),c.shimTrackEventTransceiver(t),c.shimGetUserMedia(t),v.shimRTCIceCandidate(t),v.shimMaxMessageSize(t),v.shimSendThrowTypeError(t),v.removeAllowExtmapMixed(t);break;default:i("Unsupported browser!")}return o};var n=t("./utils"),r=T(n),o=t("./chrome/chrome_shim"),a=T(o),l=t("./edge/edge_shim"),s=T(l),p=t("./firefox/firefox_shim"),h=T(p),u=t("./safari/safari_shim"),c=T(u),f=t("./common_shim"),v=T(f);function T(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e.default=t,e}},{"./chrome/chrome_shim":3,"./common_shim":6,"./edge/edge_shim":7,"./firefox/firefox_shim":11,"./safari/safari_shim":14,"./utils":15}],3:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.shimGetDisplayMedia=i.shimGetUserMedia=void 0;var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},r=t("./getusermedia");Object.defineProperty(i,"shimGetUserMedia",{enumerable:!0,get:function(){return r.shimGetUserMedia}});var o=t("./getdisplaymedia");Object.defineProperty(i,"shimGetDisplayMedia",{enumerable:!0,get:function(){return o.shimGetDisplayMedia}}),i.shimMediaStream=function(t){t.MediaStream=t.MediaStream||t.webkitMediaStream},i.shimOnTrack=function(t){if("object"!==(void 0===t?"undefined":n(t))||!t.RTCPeerConnection||"ontrack"in t.RTCPeerConnection.prototype)l.wrapPeerConnectionEvent(t,"track",function(t){return t.transceiver||Object.defineProperty(t,"transceiver",{value:{receiver:t.receiver}}),t});else{Object.defineProperty(t.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(t){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=t)},enumerable:!0,configurable:!0});var e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){var i=this;return this._ontrackpoly||(this._ontrackpoly=function(e){e.stream.addEventListener("addtrack",function(n){var r=void 0;r=t.RTCPeerConnection.prototype.getReceivers?i.getReceivers().find(function(t){return t.track&&t.track.id===n.track.id}):{track:n.track};var o=new Event("track");o.track=n.track,o.receiver=r,o.transceiver={receiver:r},o.streams=[e.stream],i.dispatchEvent(o)}),e.stream.getTracks().forEach(function(n){var r=void 0;r=t.RTCPeerConnection.prototype.getReceivers?i.getReceivers().find(function(t){return t.track&&t.track.id===n.id}):{track:n};var o=new Event("track");o.track=n,o.receiver=r,o.transceiver={receiver:r},o.streams=[e.stream],i.dispatchEvent(o)})},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}},i.shimGetSendersWithDtmf=function(t){if("object"===(void 0===t?"undefined":n(t))&&t.RTCPeerConnection&&!("getSenders"in t.RTCPeerConnection.prototype)&&"createDTMFSender"in t.RTCPeerConnection.prototype){var e=function(t,e){return{track:e,get dtmf(){return void 0===this._dtmf&&("audio"===e.kind?this._dtmf=t.createDTMFSender(e):this._dtmf=null),this._dtmf},_pc:t}};if(!t.RTCPeerConnection.prototype.getSenders){t.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};var i=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(t,n){var r=i.apply(this,arguments);return r||(r=e(this,t),this._senders.push(r)),r};var r=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(t){r.apply(this,arguments);var e=this._senders.indexOf(t);-1!==e&&this._senders.splice(e,1)}}var o=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(t){var i=this;this._senders=this._senders||[],o.apply(this,[t]),t.getTracks().forEach(function(t){i._senders.push(e(i,t))})};var a=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(t){var e=this;this._senders=this._senders||[],a.apply(this,[t]),t.getTracks().forEach(function(t){var i=e._senders.find(function(e){return e.track===t});i&&e._senders.splice(e._senders.indexOf(i),1)})}}else if("object"===(void 0===t?"undefined":n(t))&&t.RTCPeerConnection&&"getSenders"in t.RTCPeerConnection.prototype&&"createDTMFSender"in t.RTCPeerConnection.prototype&&t.RTCRtpSender&&!("dtmf"in t.RTCRtpSender.prototype)){var l=t.RTCPeerConnection.prototype.getSenders;t.RTCPeerConnection.prototype.getSenders=function(){var t=this,e=l.apply(this,[]);return e.forEach(function(e){return e._pc=t}),e},Object.defineProperty(t.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}},i.shimGetStats=function(t){if(t.RTCPeerConnection){var e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(t,i,n){var r=this,o=arguments;if(arguments.length>0&&"function"==typeof t)return e.apply(this,arguments);if(0===e.length&&(0===arguments.length||"function"!=typeof arguments[0]))return e.apply(this,[]);var a=function(t){var e={},i=t.result();return i.forEach(function(t){var i={id:t.id,timestamp:t.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[t.type]||t.type};t.names().forEach(function(e){i[e]=t.stat(e)}),e[i.id]=i}),e},l=function(t){return new Map(Object.keys(t).map(function(e){return[e,t[e]]}))};return arguments.length>=2?e.apply(this,[function(t){o[1](l(a(t)))},arguments[0]]):new Promise(function(t,i){e.apply(r,[function(e){t(l(a(e)))},i])}).then(i,n)}}},i.shimSenderReceiverGetStats=function(t){if("object"===(void 0===t?"undefined":n(t))&&t.RTCPeerConnection&&t.RTCRtpSender&&t.RTCRtpReceiver){if(!("getStats"in t.RTCRtpSender.prototype)){var e=t.RTCPeerConnection.prototype.getSenders;e&&(t.RTCPeerConnection.prototype.getSenders=function(){var t=this,i=e.apply(this,[]);return i.forEach(function(e){return e._pc=t}),i});var i=t.RTCPeerConnection.prototype.addTrack;i&&(t.RTCPeerConnection.prototype.addTrack=function(){var t=i.apply(this,arguments);return t._pc=this,t}),t.RTCRtpSender.prototype.getStats=function(){var t=this;return this._pc.getStats().then(function(e){return l.filterStats(e,t.track,!0)})}}if(!("getStats"in t.RTCRtpReceiver.prototype)){var r=t.RTCPeerConnection.prototype.getReceivers;r&&(t.RTCPeerConnection.prototype.getReceivers=function(){var t=this,e=r.apply(this,[]);return e.forEach(function(e){return e._pc=t}),e}),l.wrapPeerConnectionEvent(t,"track",function(t){return t.receiver._pc=t.srcElement,t}),t.RTCRtpReceiver.prototype.getStats=function(){var t=this;return this._pc.getStats().then(function(e){return l.filterStats(e,t.track,!1)})}}if("getStats"in t.RTCRtpSender.prototype&&"getStats"in t.RTCRtpReceiver.prototype){var o=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof t.MediaStreamTrack){var e=arguments[0],i=void 0,n=void 0,r=void 0;return this.getSenders().forEach(function(t){t.track===e&&(i?r=!0:i=t)}),this.getReceivers().forEach(function(t){return t.track===e&&(n?r=!0:n=t),t.track===e}),r||i&&n?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):i?i.getStats():n?n.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return o.apply(this,arguments)}}}},i.shimAddTrackRemoveTrackWithNative=s,i.shimAddTrackRemoveTrack=function(t){if(t.RTCPeerConnection){var e=l.detectBrowser(t);if(t.RTCPeerConnection.prototype.addTrack&&e.version>=65)return s(t);var i=t.RTCPeerConnection.prototype.getLocalStreams;t.RTCPeerConnection.prototype.getLocalStreams=function(){var t=this,e=i.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map(function(e){return t._reverseStreams[e.id]})};var n=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(e){var i=this;if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},e.getTracks().forEach(function(t){var e=i.getSenders().find(function(e){return e.track===t});if(e)throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[e.id]){var r=new t.MediaStream(e.getTracks());this._streams[e.id]=r,this._reverseStreams[r.id]=e,e=r}n.apply(this,[e])};var r=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(t){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[t.id]||t]),delete this._reverseStreams[this._streams[t.id]?this._streams[t.id].id:t.id],delete this._streams[t.id]},t.RTCPeerConnection.prototype.addTrack=function(e,i){var n=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var r=[].slice.call(arguments,1);if(1!==r.length||!r[0].getTracks().find(function(t){return t===e}))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");var o=this.getSenders().find(function(t){return t.track===e});if(o)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};var a=this._streams[i.id];if(a)a.addTrack(e),Promise.resolve().then(function(){n.dispatchEvent(new Event("negotiationneeded"))});else{var l=new t.MediaStream([e]);this._streams[i.id]=l,this._reverseStreams[l.id]=i,this.addStream(l)}return this.getSenders().find(function(t){return t.track===e})},["createOffer","createAnswer"].forEach(function(e){var i=t.RTCPeerConnection.prototype[e];t.RTCPeerConnection.prototype[e]=function(){var t=this,e=arguments,n=arguments.length&&"function"==typeof arguments[0];return n?i.apply(this,[function(i){var n=p(t,i);e[0].apply(null,[n])},function(t){e[1]&&e[1].apply(null,t)},arguments[2]]):i.apply(this,arguments).then(function(e){return p(t,e)})}});var o=t.RTCPeerConnection.prototype.setLocalDescription;t.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=(t=this,e=arguments[0],i=e.sdp,Object.keys(t._reverseStreams||[]).forEach(function(e){var n=t._reverseStreams[e],r=t._streams[n.id];i=i.replace(new RegExp(n.id,"g"),r.id)}),new RTCSessionDescription({type:e.type,sdp:i})),o.apply(this,arguments)):o.apply(this,arguments);var t,e,i};var a=Object.getOwnPropertyDescriptor(t.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(t.RTCPeerConnection.prototype,"localDescription",{get:function(){var t=a.get.apply(this);return""===t.type?t:p(this,t)}}),t.RTCPeerConnection.prototype.removeTrack=function(t){var e=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!t._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");var i=t._pc===this;if(!i)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};var n=void 0;Object.keys(this._streams).forEach(function(i){var r=e._streams[i].getTracks().find(function(e){return t.track===e});r&&(n=e._streams[i])}),n&&(1===n.getTracks().length?this.removeStream(this._reverseStreams[n.id]):n.removeTrack(t.track),this.dispatchEvent(new Event("negotiationneeded")))}}function p(t,e){var i=e.sdp;return Object.keys(t._reverseStreams||[]).forEach(function(e){var n=t._reverseStreams[e],r=t._streams[n.id];i=i.replace(new RegExp(r.id,"g"),n.id)}),new RTCSessionDescription({type:e.type,sdp:i})}},i.shimPeerConnection=function(t){if(!t.RTCPeerConnection&&t.webkitRTCPeerConnection&&(t.RTCPeerConnection=t.webkitRTCPeerConnection),t.RTCPeerConnection){["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var i=t.RTCPeerConnection.prototype[e];t.RTCPeerConnection.prototype[e]=function(){return arguments[0]=new("addIceCandidate"===e?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}});var e=t.RTCPeerConnection.prototype.addIceCandidate;t.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?e.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}},i.fixNegotiationNeeded=function(t){l.wrapPeerConnectionEvent(t,"negotiationneeded",function(t){var e=t.target;if("stable"===e.signalingState)return t})};var a=t("../utils.js"),l=function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e.default=t,e}(a);function s(t){t.RTCPeerConnection.prototype.getLocalStreams=function(){var t=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(function(e){return t._shimmedLocalStreams[e][0]})};var e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(t,i){if(!i)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};var n=e.apply(this,arguments);return this._shimmedLocalStreams[i.id]?-1===this._shimmedLocalStreams[i.id].indexOf(n)&&this._shimmedLocalStreams[i.id].push(n):this._shimmedLocalStreams[i.id]=[i,n],n};var i=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(t){var e=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{},t.getTracks().forEach(function(t){var i=e.getSenders().find(function(e){return e.track===t});if(i)throw new DOMException("Track already exists.","InvalidAccessError")});var n=this.getSenders();i.apply(this,arguments);var r=this.getSenders().filter(function(t){return-1===n.indexOf(t)});this._shimmedLocalStreams[t.id]=[t].concat(r)};var n=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(t){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[t.id],n.apply(this,arguments)};var r=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(t){var e=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},t&&Object.keys(this._shimmedLocalStreams).forEach(function(i){var n=e._shimmedLocalStreams[i].indexOf(t);-1!==n&&e._shimmedLocalStreams[i].splice(n,1),1===e._shimmedLocalStreams[i].length&&delete e._shimmedLocalStreams[i]}),r.apply(this,arguments)}}},{"../utils.js":15,"./getdisplaymedia":4,"./getusermedia":5}],4:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.shimGetDisplayMedia=function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&("function"==typeof e?t.navigator.mediaDevices.getDisplayMedia=function(i){return e(i).then(function(e){var n=i.video&&i.video.width,r=i.video&&i.video.height,o=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxFrameRate:o||3}},n&&(i.video.mandatory.maxWidth=n),r&&(i.video.mandatory.maxHeight=r),t.navigator.mediaDevices.getUserMedia(i)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}},{}],5:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};i.shimGetUserMedia=function(t){var e=t&&t.navigator;if(e.mediaDevices){var i=o.detectBrowser(t),r=function(t){if("object"!==(void 0===t?"undefined":n(t))||t.mandatory||t.optional)return t;var e={};return Object.keys(t).forEach(function(i){if("require"!==i&&"advanced"!==i&&"mediaSource"!==i){var r="object"===n(t[i])?t[i]:{ideal:t[i]};void 0!==r.exact&&"number"==typeof r.exact&&(r.min=r.max=r.exact);var o=function(t,e){return t?t+e.charAt(0).toUpperCase()+e.slice(1):"deviceId"===e?"sourceId":e};if(void 0!==r.ideal){e.optional=e.optional||[];var a={};"number"==typeof r.ideal?(a[o("min",i)]=r.ideal,e.optional.push(a),(a={})[o("max",i)]=r.ideal,e.optional.push(a)):(a[o("",i)]=r.ideal,e.optional.push(a))}void 0!==r.exact&&"number"!=typeof r.exact?(e.mandatory=e.mandatory||{},e.mandatory[o("",i)]=r.exact):["min","max"].forEach(function(t){void 0!==r[t]&&(e.mandatory=e.mandatory||{},e.mandatory[o(t,i)]=r[t])})}}),t.advanced&&(e.optional=(e.optional||[]).concat(t.advanced)),e},l=function(t,o){if(i.version>=61)return o(t);if((t=JSON.parse(JSON.stringify(t)))&&"object"===n(t.audio)){var l=function(t,e,i){e in t&&!(i in t)&&(t[i]=t[e],delete t[e])};t=JSON.parse(JSON.stringify(t)),l(t.audio,"autoGainControl","googAutoGainControl"),l(t.audio,"noiseSuppression","googNoiseSuppression"),t.audio=r(t.audio)}if(t&&"object"===n(t.video)){var s=t.video.facingMode;s=s&&("object"===(void 0===s?"undefined":n(s))?s:{ideal:s});var p=i.version<66;if(s&&("user"===s.exact||"environment"===s.exact||"user"===s.ideal||"environment"===s.ideal)&&(!e.mediaDevices.getSupportedConstraints||!e.mediaDevices.getSupportedConstraints().facingMode||p)){delete t.video.facingMode;var h=void 0;if("environment"===s.exact||"environment"===s.ideal?h=["back","rear"]:"user"!==s.exact&&"user"!==s.ideal||(h=["front"]),h)return e.mediaDevices.enumerateDevices().then(function(e){var i=(e=e.filter(function(t){return"videoinput"===t.kind})).find(function(t){return h.some(function(e){return t.label.toLowerCase().includes(e)})});return!i&&e.length&&h.includes("back")&&(i=e[e.length-1]),i&&(t.video.deviceId=s.exact?{exact:i.deviceId}:{ideal:i.deviceId}),t.video=r(t.video),a("chrome: "+JSON.stringify(t)),o(t)})}t.video=r(t.video)}return a("chrome: "+JSON.stringify(t)),o(t)},s=function(t){return i.version>=64?t:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[t.name]||t.name,message:t.message,constraint:t.constraint||t.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}};if(e.getUserMedia=function(t,i,n){l(t,function(t){e.webkitGetUserMedia(t,i,function(t){n&&n(s(t))})})}.bind(e),e.mediaDevices.getUserMedia){var p=e.mediaDevices.getUserMedia.bind(e.mediaDevices);e.mediaDevices.getUserMedia=function(t){return l(t,function(t){return p(t).then(function(e){if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach(function(t){t.stop()}),new DOMException("","NotFoundError");return e},function(t){return Promise.reject(s(t))})})}}}};var r=t("../utils.js"),o=function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e.default=t,e}(r),a=o.log},{"../utils.js":15}],6:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};i.shimRTCIceCandidate=function(t){if(t.RTCIceCandidate&&!(t.RTCIceCandidate&&"foundation"in t.RTCIceCandidate.prototype)){var e=t.RTCIceCandidate;t.RTCIceCandidate=function(t){if("object"===(void 0===t?"undefined":n(t))&&t.candidate&&0===t.candidate.indexOf("a=")&&((t=JSON.parse(JSON.stringify(t))).candidate=t.candidate.substr(2)),t.candidate&&t.candidate.length){var i=new e(t),r=a.default.parseCandidate(t.candidate),o=Object.assign(i,r);return o.toJSON=function(){return{candidate:o.candidate,sdpMid:o.sdpMid,sdpMLineIndex:o.sdpMLineIndex,usernameFragment:o.usernameFragment}},o}return new e(t)},t.RTCIceCandidate.prototype=e.prototype,s.wrapPeerConnectionEvent(t,"icecandidate",function(e){return e.candidate&&Object.defineProperty(e,"candidate",{value:new t.RTCIceCandidate(e.candidate),writable:"false"}),e})}},i.shimMaxMessageSize=function(t){if(!t.RTCSctpTransport&&t.RTCPeerConnection){var e=s.detectBrowser(t);"sctp"in t.RTCPeerConnection.prototype||Object.defineProperty(t.RTCPeerConnection.prototype,"sctp",{get:function(){return void 0===this._sctp?null:this._sctp}});var i=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,function(t){if(!t||!t.sdp)return!1;var e=a.default.splitSections(t.sdp);return e.shift(),e.some(function(t){var e=a.default.parseMLine(t);return e&&"application"===e.kind&&-1!==e.protocol.indexOf("SCTP")})}(arguments[0])){var t=function(t){var e=t.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===e||e.length<2)return-1;var i=parseInt(e[1],10);return i!=i?-1:i}(arguments[0]),n=(s=t,p=65536,"firefox"===e.browser&&(p=e.version<57?-1===s?16384:2147483637:e.version<60?57===e.version?65535:65536:2147483637),p),r=function(t,i){var n=65536;"firefox"===e.browser&&57===e.version&&(n=65535);var r=a.default.matchPrefix(t.sdp,"a=max-message-size:");return r.length>0?n=parseInt(r[0].substr(19),10):"firefox"===e.browser&&-1!==i&&(n=2147483637),n}(arguments[0],t),o=void 0;o=0===n&&0===r?Number.POSITIVE_INFINITY:0===n||0===r?Math.max(n,r):Math.min(n,r);var l={};Object.defineProperty(l,"maxMessageSize",{get:function(){return o}}),this._sctp=l}var s,p;return i.apply(this,arguments)}}},i.shimSendThrowTypeError=function(t){if(t.RTCPeerConnection&&"createDataChannel"in t.RTCPeerConnection.prototype){var e=t.RTCPeerConnection.prototype.createDataChannel;t.RTCPeerConnection.prototype.createDataChannel=function(){var t=e.apply(this,arguments);return i(t,this),t},s.wrapPeerConnectionEvent(t,"datachannel",function(t){return i(t.channel,t.target),t})}function i(t,e){var i=t.send;t.send=function(){var n=arguments[0],r=n.length||n.size||n.byteLength;if("open"===t.readyState&&e.sctp&&r>e.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+e.sctp.maxMessageSize+" bytes)");return i.apply(t,arguments)}}},i.shimConnectionState=function(t){if(t.RTCPeerConnection&&!("connectionState"in t.RTCPeerConnection.prototype)){var e=t.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get:function(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get:function(){return this._onconnectionstatechange||null},set:function(t){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),t&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=t)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(function(t){var i=e[t];e[t]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=function(t){var e=t.target;if(e._lastConnectionState!==e.connectionState){e._lastConnectionState=e.connectionState;var i=new Event("connectionstatechange",t);e.dispatchEvent(i)}return t},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}})}},i.removeAllowExtmapMixed=function(t){if(t.RTCPeerConnection){var e=s.detectBrowser(t);if(!("chrome"===e.browser&&e.version>=71)){var i=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(t){return t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")&&(t.sdp=t.sdp.split("\n").filter(function(t){return"a=extmap-allow-mixed"!==t.trim()}).join("\n")),i.apply(this,arguments)}}}};var r,o=t("sdp"),a=(r=o)&&r.__esModule?r:{default:r},l=t("./utils"),s=function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e.default=t,e}(l)},{"./utils":15,sdp:17}],7:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.shimGetDisplayMedia=i.shimGetUserMedia=void 0;var n=t("./getusermedia");Object.defineProperty(i,"shimGetUserMedia",{enumerable:!0,get:function(){return n.shimGetUserMedia}});var r=t("./getdisplaymedia");Object.defineProperty(i,"shimGetDisplayMedia",{enumerable:!0,get:function(){return r.shimGetDisplayMedia}}),i.shimPeerConnection=function(t){var e=l.detectBrowser(t);if(t.RTCIceGatherer&&(t.RTCIceCandidate||(t.RTCIceCandidate=function(t){return t}),t.RTCSessionDescription||(t.RTCSessionDescription=function(t){return t}),e.version<15025)){var i=Object.getOwnPropertyDescriptor(t.MediaStreamTrack.prototype,"enabled");Object.defineProperty(t.MediaStreamTrack.prototype,"enabled",{set:function(t){i.set.call(this,t);var e=new Event("enabled");e.enabled=t,this.dispatchEvent(e)}})}!t.RTCRtpSender||"dtmf"in t.RTCRtpSender.prototype||Object.defineProperty(t.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new t.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),t.RTCDtmfSender&&!t.RTCDTMFSender&&(t.RTCDTMFSender=t.RTCDtmfSender);var n=(0,h.default)(t,e.version);t.RTCPeerConnection=function(t){return t&&t.iceServers&&(t.iceServers=(0,s.filterIceServers)(t.iceServers,e.version),l.log("ICE servers after filtering:",t.iceServers)),new n(t)},t.RTCPeerConnection.prototype=n.prototype},i.shimReplaceTrack=function(t){!t.RTCRtpSender||"replaceTrack"in t.RTCRtpSender.prototype||(t.RTCRtpSender.prototype.replaceTrack=t.RTCRtpSender.prototype.setTrack)};var o,a=t("../utils"),l=function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e.default=t,e}(a),s=t("./filtericeservers"),p=t("rtcpeerconnection-shim"),h=(o=p)&&o.__esModule?o:{default:o}},{"../utils":15,"./filtericeservers":8,"./getdisplaymedia":9,"./getusermedia":10,"rtcpeerconnection-shim":16}],8:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.filterIceServers=function(t,e){var i=!1;return(t=JSON.parse(JSON.stringify(t))).filter(function(t){if(t&&(t.urls||t.url)){var e=t.urls||t.url;t.url&&!t.urls&&r.deprecated("RTCIceServer.url","RTCIceServer.urls");var n="string"==typeof e;return n&&(e=[e]),e=e.filter(function(t){if(0===t.indexOf("stun:"))return!1;var e=t.startsWith("turn")&&!t.startsWith("turn:[")&&t.includes("transport=udp");return e&&!i?(i=!0,!0):e&&!i}),delete t.url,t.urls=n?e[0]:e,!!e.length}})};var n=t("../utils"),r=function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e.default=t,e}(n)},{"../utils":15}],9:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.shimGetDisplayMedia=function(t){"getDisplayMedia"in t.navigator&&t.navigator.mediaDevices&&(t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||(t.navigator.mediaDevices.getDisplayMedia=t.navigator.getDisplayMedia.bind(t.navigator)))}},{}],10:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.shimGetUserMedia=function(t){var e=t&&t.navigator,i=e.mediaDevices.getUserMedia.bind(e.mediaDevices);e.mediaDevices.getUserMedia=function(t){return i(t).catch(function(t){return Promise.reject(function(t){return{name:{PermissionDeniedError:"NotAllowedError"}[t.name]||t.name,message:t.message,constraint:t.constraint,toString:function(){return this.name}}}(t))})}}},{}],11:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.shimGetDisplayMedia=i.shimGetUserMedia=void 0;var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},r=t("./getusermedia");Object.defineProperty(i,"shimGetUserMedia",{enumerable:!0,get:function(){return r.shimGetUserMedia}});var o=t("./getdisplaymedia");Object.defineProperty(i,"shimGetDisplayMedia",{enumerable:!0,get:function(){return o.shimGetDisplayMedia}}),i.shimOnTrack=function(t){"object"===(void 0===t?"undefined":n(t))&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},i.shimPeerConnection=function(t){var e=l.detectBrowser(t);if("object"===(void 0===t?"undefined":n(t))&&(t.RTCPeerConnection||t.mozRTCPeerConnection)){!t.RTCPeerConnection&&t.mozRTCPeerConnection&&(t.RTCPeerConnection=t.mozRTCPeerConnection),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var i=t.RTCPeerConnection.prototype[e];t.RTCPeerConnection.prototype[e]=function(){return arguments[0]=new("addIceCandidate"===e?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}});var i=t.RTCPeerConnection.prototype.addIceCandidate;t.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};var r={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},o=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(t,i,n){return o.apply(this,[t||null]).then(function(t){if(e.version<53&&!i)try{t.forEach(function(t){t.type=r[t.type]||t.type})}catch(e){if("TypeError"!==e.name)throw e;t.forEach(function(e,i){t.set(i,Object.assign({},e,{type:r[e.type]||e.type}))})}return t}).then(i,n)}}},i.shimSenderGetStats=function(t){if("object"===(void 0===t?"undefined":n(t))&&t.RTCPeerConnection&&t.RTCRtpSender&&!(t.RTCRtpSender&&"getStats"in t.RTCRtpSender.prototype)){var e=t.RTCPeerConnection.prototype.getSenders;e&&(t.RTCPeerConnection.prototype.getSenders=function(){var t=this,i=e.apply(this,[]);return i.forEach(function(e){return e._pc=t}),i});var i=t.RTCPeerConnection.prototype.addTrack;i&&(t.RTCPeerConnection.prototype.addTrack=function(){var t=i.apply(this,arguments);return t._pc=this,t}),t.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}},i.shimReceiverGetStats=function(t){if("object"===(void 0===t?"undefined":n(t))&&t.RTCPeerConnection&&t.RTCRtpSender&&!(t.RTCRtpSender&&"getStats"in t.RTCRtpReceiver.prototype)){var e=t.RTCPeerConnection.prototype.getReceivers;e&&(t.RTCPeerConnection.prototype.getReceivers=function(){var t=this,i=e.apply(this,[]);return i.forEach(function(e){return e._pc=t}),i}),l.wrapPeerConnectionEvent(t,"track",function(t){return t.receiver._pc=t.srcElement,t}),t.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}},i.shimRemoveStream=function(t){!t.RTCPeerConnection||"removeStream"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.removeStream=function(t){var e=this;l.deprecated("removeStream","removeTrack"),this.getSenders().forEach(function(i){i.track&&t.getTracks().includes(i.track)&&e.removeTrack(i)})})},i.shimRTCDataChannel=function(t){t.DataChannel&&!t.RTCDataChannel&&(t.RTCDataChannel=t.DataChannel)};var a=t("../utils"),l=function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e.default=t,e}(a)},{"../utils":15,"./getdisplaymedia":12,"./getusermedia":13}],12:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.shimGetDisplayMedia=function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(t.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){var n=new DOMException("getDisplayMedia without video constraints is undefined");return n.name="NotFoundError",n.code=8,Promise.reject(n)}return!0===i.video?i.video={mediaSource:e}:i.video.mediaSource=e,t.navigator.mediaDevices.getUserMedia(i)})}},{}],13:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};i.shimGetUserMedia=function(t){var e=o.detectBrowser(t),i=t&&t.navigator,r=t&&t.MediaStreamTrack;if(i.getUserMedia=function(t,e,n){o.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(t).then(e,n)},!(e.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){var a=function(t,e,i){e in t&&!(i in t)&&(t[i]=t[e],delete t[e])},l=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(t){return"object"===(void 0===t?"undefined":n(t))&&"object"===n(t.audio)&&(t=JSON.parse(JSON.stringify(t)),a(t.audio,"autoGainControl","mozAutoGainControl"),a(t.audio,"noiseSuppression","mozNoiseSuppression")),l(t)},r&&r.prototype.getSettings){var s=r.prototype.getSettings;r.prototype.getSettings=function(){var t=s.apply(this,arguments);return a(t,"mozAutoGainControl","autoGainControl"),a(t,"mozNoiseSuppression","noiseSuppression"),t}}if(r&&r.prototype.applyConstraints){var p=r.prototype.applyConstraints;r.prototype.applyConstraints=function(t){return"audio"===this.kind&&"object"===(void 0===t?"undefined":n(t))&&(t=JSON.parse(JSON.stringify(t)),a(t,"autoGainControl","mozAutoGainControl"),a(t,"noiseSuppression","mozNoiseSuppression")),p.apply(this,[t])}}}};var r=t("../utils"),o=function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e.default=t,e}(r)},{"../utils":15}],14:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};i.shimLocalStreamsAPI=function(t){if("object"===(void 0===t?"undefined":n(t))&&t.RTCPeerConnection){if("getLocalStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in t.RTCPeerConnection.prototype)){var e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addStream=function(t){var i=this;this._localStreams||(this._localStreams=[]),this._localStreams.includes(t)||this._localStreams.push(t),t.getTracks().forEach(function(n){return e.call(i,n,t)})},t.RTCPeerConnection.prototype.addTrack=function(t,i){return i&&(this._localStreams?this._localStreams.includes(i)||this._localStreams.push(i):this._localStreams=[i]),e.call(this,t,i)}}"removeStream"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.removeStream=function(t){var e=this;this._localStreams||(this._localStreams=[]);var i=this._localStreams.indexOf(t);if(-1!==i){this._localStreams.splice(i,1);var n=t.getTracks();this.getSenders().forEach(function(t){n.includes(t.track)&&e.removeTrack(t)})}})}},i.shimRemoteStreamsAPI=function(t){if("object"===(void 0===t?"undefined":n(t))&&t.RTCPeerConnection&&("getRemoteStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in t.RTCPeerConnection.prototype))){Object.defineProperty(t.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(t){var e=this;this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=t),this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach(function(t){if(e._remoteStreams||(e._remoteStreams=[]),!e._remoteStreams.includes(t)){e._remoteStreams.push(t);var i=new Event("addstream");i.stream=t,e.dispatchEvent(i)}})})}});var e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){var t=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach(function(e){if(t._remoteStreams||(t._remoteStreams=[]),!(t._remoteStreams.indexOf(e)>=0)){t._remoteStreams.push(e);var i=new Event("addstream");i.stream=e,t.dispatchEvent(i)}})}),e.apply(t,arguments)}}},i.shimCallbacksAPI=function(t){if("object"===(void 0===t?"undefined":n(t))&&t.RTCPeerConnection){var e=t.RTCPeerConnection.prototype,i=e.createOffer,r=e.createAnswer,o=e.setLocalDescription,a=e.setRemoteDescription,l=e.addIceCandidate;e.createOffer=function(t,e){var n=arguments.length>=2?arguments[2]:arguments[0],r=i.apply(this,[n]);return e?(r.then(t,e),Promise.resolve()):r},e.createAnswer=function(t,e){var i=arguments.length>=2?arguments[2]:arguments[0],n=r.apply(this,[i]);return e?(n.then(t,e),Promise.resolve()):n};var s=function(t,e,i){var n=o.apply(this,[t]);return i?(n.then(e,i),Promise.resolve()):n};e.setLocalDescription=s,s=function(t,e,i){var n=a.apply(this,[t]);return i?(n.then(e,i),Promise.resolve()):n},e.setRemoteDescription=s,s=function(t,e,i){var n=l.apply(this,[t]);return i?(n.then(e,i),Promise.resolve()):n},e.addIceCandidate=s}},i.shimGetUserMedia=function(t){var e=t&&t.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){var i=e.mediaDevices,n=i.getUserMedia.bind(i);e.mediaDevices.getUserMedia=function(t){return n(a(t))}}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=function(t,i,n){e.mediaDevices.getUserMedia(t).then(i,n)}.bind(e))},i.shimConstraints=a,i.shimRTCIceServerUrls=function(t){var e=t.RTCPeerConnection;t.RTCPeerConnection=function(t,i){if(t&&t.iceServers){for(var n=[],r=0;r<t.iceServers.length;r++){var a=t.iceServers[r];!a.hasOwnProperty("urls")&&a.hasOwnProperty("url")?(o.deprecated("RTCIceServer.url","RTCIceServer.urls"),(a=JSON.parse(JSON.stringify(a))).urls=a.url,delete a.url,n.push(a)):n.push(t.iceServers[r])}t.iceServers=n}return new e(t,i)},t.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in t.RTCPeerConnection&&Object.defineProperty(t.RTCPeerConnection,"generateCertificate",{get:function(){return e.generateCertificate}})},i.shimTrackEventTransceiver=function(t){"object"===(void 0===t?"undefined":n(t))&&t.RTCPeerConnection&&"receiver"in t.RTCTrackEvent.prototype&&!t.RTCTransceiver&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},i.shimCreateOfferLegacy=function(t){var e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(t){if(t){void 0!==t.offerToReceiveAudio&&(t.offerToReceiveAudio=!!t.offerToReceiveAudio);var i=this.getTransceivers().find(function(t){return"audio"===t.receiver.track.kind});!1===t.offerToReceiveAudio&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):!0!==t.offerToReceiveAudio||i||this.addTransceiver("audio"),void 0!==t.offerToReceiveVideo&&(t.offerToReceiveVideo=!!t.offerToReceiveVideo);var n=this.getTransceivers().find(function(t){return"video"===t.receiver.track.kind});!1===t.offerToReceiveVideo&&n?"sendrecv"===n.direction?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":"recvonly"===n.direction&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):!0!==t.offerToReceiveVideo||n||this.addTransceiver("video")}return e.apply(this,arguments)}};var r=t("../utils"),o=function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e.default=t,e}(r);function a(t){return t&&void 0!==t.video?Object.assign({},t,{video:o.compactObject(t.video)}):t}},{"../utils":15}],15:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};i.extractVersion=a,i.wrapPeerConnectionEvent=function(t,e,i){if(t.RTCPeerConnection){var n=t.RTCPeerConnection.prototype,r=n.addEventListener;n.addEventListener=function(t,n){if(t!==e)return r.apply(this,arguments);var o=function(t){var e=i(t);e&&n(e)};return this._eventMap=this._eventMap||{},this._eventMap[n]=o,r.apply(this,[t,o])};var o=n.removeEventListener;n.removeEventListener=function(t,i){if(t!==e||!this._eventMap||!this._eventMap[i])return o.apply(this,arguments);var n=this._eventMap[i];return delete this._eventMap[i],o.apply(this,[t,n])},Object.defineProperty(n,"on"+e,{get:function(){return this["_on"+e]},set:function(t){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),t&&this.addEventListener(e,this["_on"+e]=t)},enumerable:!0,configurable:!0})}},i.disableLog=function(t){return"boolean"!=typeof t?new Error("Argument type: "+(void 0===t?"undefined":n(t))+". Please use a boolean."):(r=t,t?"adapter.js logging disabled":"adapter.js logging enabled")},i.disableWarnings=function(t){return"boolean"!=typeof t?new Error("Argument type: "+(void 0===t?"undefined":n(t))+". Please use a boolean."):(o=!t,"adapter.js deprecation warnings "+(t?"disabled":"enabled"))},i.log=function(){if("object"===("undefined"==typeof window?"undefined":n(window))){if(r)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},i.deprecated=function(t,e){o&&console.warn(t+" is deprecated, please use "+e+" instead.")},i.detectBrowser=function(t){var e=t.navigator,i={browser:null,version:null};if(void 0===t||!t.navigator)return i.browser="Not a browser.",i;if(e.mozGetUserMedia)i.browser="firefox",i.version=a(e.userAgent,/Firefox\/(\d+)\./,1);else if(e.webkitGetUserMedia||!1===t.isSecureContext&&t.webkitRTCPeerConnection&&!t.RTCIceGatherer)i.browser="chrome",i.version=a(e.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(e.mediaDevices&&e.userAgent.match(/Edge\/(\d+).(\d+)$/))i.browser="edge",i.version=a(e.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!t.RTCPeerConnection||!e.userAgent.match(/AppleWebKit\/(\d+)\./))return i.browser="Not a supported browser.",i;i.browser="safari",i.version=a(e.userAgent,/AppleWebKit\/(\d+)\./,1)}return i},i.compactObject=function t(e){return"object"!==(void 0===e?"undefined":n(e))?e:Object.keys(e).reduce(function(i,r){var o="object"===n(e[r]),a=o?t(e[r]):e[r],l=o&&!Object.keys(a).length;return void 0===a||l?i:Object.assign(i,function(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}({},r,a))},{})},i.walkStats=l,i.filterStats=function(t,e,i){var n=i?"outbound-rtp":"inbound-rtp",r=new Map;if(null===e)return r;var o=[];return t.forEach(function(t){"track"===t.type&&t.trackIdentifier===e.id&&o.push(t)}),o.forEach(function(e){t.forEach(function(i){i.type===n&&i.trackId===e.id&&l(t,i,r)})}),r};var r=!0,o=!0;function a(t,e,i){var n=t.match(e);return n&&n.length>=i&&parseInt(n[i],10)}function l(t,e,i){e&&!i.has(e.id)&&(i.set(e.id,e),Object.keys(e).forEach(function(n){n.endsWith("Id")?l(t,t.get(e[n]),i):n.endsWith("Ids")&&e[n].forEach(function(e){l(t,t.get(e),i)})}))}},{}],16:[function(t,e,i){"use strict";var n=t("sdp");function r(t,e,i,r,o){var a=n.writeRtpDescription(t.kind,e);if(a+=n.writeIceParameters(t.iceGatherer.getLocalParameters()),a+=n.writeDtlsParameters(t.dtlsTransport.getLocalParameters(),"offer"===i?"actpass":o||"active"),a+="a=mid:"+t.mid+"\r\n",t.rtpSender&&t.rtpReceiver?a+="a=sendrecv\r\n":t.rtpSender?a+="a=sendonly\r\n":t.rtpReceiver?a+="a=recvonly\r\n":a+="a=inactive\r\n",t.rtpSender){var l=t.rtpSender._initialTrackId||t.rtpSender.track.id;t.rtpSender._initialTrackId=l;var s="msid:"+(r?r.id:"-")+" "+l+"\r\n";a+="a="+s,a+="a=ssrc:"+t.sendEncodingParameters[0].ssrc+" "+s,t.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+t.sendEncodingParameters[0].rtx.ssrc+" "+s,a+="a=ssrc-group:FID "+t.sendEncodingParameters[0].ssrc+" "+t.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return a+="a=ssrc:"+t.sendEncodingParameters[0].ssrc+" cname:"+n.localCName+"\r\n",t.rtpSender&&t.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+t.sendEncodingParameters[0].rtx.ssrc+" cname:"+n.localCName+"\r\n"),a}function o(t,e){var i={codecs:[],headerExtensions:[],fecMechanisms:[]},n=function(t,e){t=parseInt(t,10);for(var i=0;i<e.length;i++)if(e[i].payloadType===t||e[i].preferredPayloadType===t)return e[i]},r=function(t,e,i,r){var o=n(t.parameters.apt,i),a=n(e.parameters.apt,r);return o&&a&&o.name.toLowerCase()===a.name.toLowerCase()};return t.codecs.forEach(function(n){for(var o=0;o<e.codecs.length;o++){var a=e.codecs[o];if(n.name.toLowerCase()===a.name.toLowerCase()&&n.clockRate===a.clockRate){if("rtx"===n.name.toLowerCase()&&n.parameters&&a.parameters.apt&&!r(n,a,t.codecs,e.codecs))continue;(a=JSON.parse(JSON.stringify(a))).numChannels=Math.min(n.numChannels,a.numChannels),i.codecs.push(a),a.rtcpFeedback=a.rtcpFeedback.filter(function(t){for(var e=0;e<n.rtcpFeedback.length;e++)if(n.rtcpFeedback[e].type===t.type&&n.rtcpFeedback[e].parameter===t.parameter)return!0;return!1});break}}}),t.headerExtensions.forEach(function(t){for(var n=0;n<e.headerExtensions.length;n++){var r=e.headerExtensions[n];if(t.uri===r.uri){i.headerExtensions.push(r);break}}}),i}function a(t,e,i){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[e][t].indexOf(i)}function l(t,e){var i=t.getRemoteCandidates().find(function(t){return e.foundation===t.foundation&&e.ip===t.ip&&e.port===t.port&&e.priority===t.priority&&e.protocol===t.protocol&&e.type===t.type});return i||t.addRemoteCandidate(e),!i}function s(t,e){var i=new Error(e);return i.name=t,i.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[t],i}e.exports=function(t,e){function i(e,i){i.addTrack(e),i.dispatchEvent(new t.MediaStreamTrackEvent("addtrack",{track:e}))}function p(e,i,n,r){var o=new Event("track");o.track=i,o.receiver=n,o.transceiver={receiver:n},o.streams=r,t.setTimeout(function(){e._dispatchEvent("track",o)})}var h=function(i){var r=this,o=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(t){r[t]=o[t].bind(o)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",i=JSON.parse(JSON.stringify(i||{})),this.usingBundle="max-bundle"===i.bundlePolicy,"negotiate"===i.rtcpMuxPolicy)throw s("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(i.rtcpMuxPolicy||(i.rtcpMuxPolicy="require"),i.iceTransportPolicy){case"all":case"relay":break;default:i.iceTransportPolicy="all"}switch(i.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:i.bundlePolicy="balanced"}if(i.iceServers=function(t,e){var i=!1;return(t=JSON.parse(JSON.stringify(t))).filter(function(t){if(t&&(t.urls||t.url)){var n=t.urls||t.url;t.url&&!t.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var r="string"==typeof n;return r&&(n=[n]),n=n.filter(function(t){return 0!==t.indexOf("turn:")||-1===t.indexOf("transport=udp")||-1!==t.indexOf("turn:[")||i?0===t.indexOf("stun:")&&e>=14393&&-1===t.indexOf("?transport=udp"):(i=!0,!0)}),delete t.url,t.urls=r?n[0]:n,!!n.length}})}(i.iceServers||[],e),this._iceGatherers=[],i.iceCandidatePoolSize)for(var a=i.iceCandidatePoolSize;a>0;a--)this._iceGatherers.push(new t.RTCIceGatherer({iceServers:i.iceServers,gatherPolicy:i.iceTransportPolicy}));else i.iceCandidatePoolSize=0;this._config=i,this.transceivers=[],this._sdpSessionId=n.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(h.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(h.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),h.prototype.onicecandidate=null,h.prototype.onaddstream=null,h.prototype.ontrack=null,h.prototype.onremovestream=null,h.prototype.onsignalingstatechange=null,h.prototype.oniceconnectionstatechange=null,h.prototype.onconnectionstatechange=null,h.prototype.onicegatheringstatechange=null,h.prototype.onnegotiationneeded=null,h.prototype.ondatachannel=null,h.prototype._dispatchEvent=function(t,e){this._isClosed||(this.dispatchEvent(e),"function"==typeof this["on"+t]&&this["on"+t](e))},h.prototype._emitGatheringStateChange=function(){var t=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",t)},h.prototype.getConfiguration=function(){return this._config},h.prototype.getLocalStreams=function(){return this.localStreams},h.prototype.getRemoteStreams=function(){return this.remoteStreams},h.prototype._createTransceiver=function(t,e){var i=this.transceivers.length>0,n={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:t,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&i)n.iceTransport=this.transceivers[0].iceTransport,n.dtlsTransport=this.transceivers[0].dtlsTransport;else{var r=this._createIceAndDtlsTransports();n.iceTransport=r.iceTransport,n.dtlsTransport=r.dtlsTransport}return e||this.transceivers.push(n),n},h.prototype.addTrack=function(e,i){if(this._isClosed)throw s("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var n,r=this.transceivers.find(function(t){return t.track===e});if(r)throw s("InvalidAccessError","Track already exists.");for(var o=0;o<this.transceivers.length;o++)this.transceivers[o].track||this.transceivers[o].kind!==e.kind||(n=this.transceivers[o]);return n||(n=this._createTransceiver(e.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(i)&&this.localStreams.push(i),n.track=e,n.stream=i,n.rtpSender=new t.RTCRtpSender(e,n.dtlsTransport),n.rtpSender},h.prototype.addStream=function(t){var i=this;if(e>=15025)t.getTracks().forEach(function(e){i.addTrack(e,t)});else{var n=t.clone();t.getTracks().forEach(function(t,e){var i=n.getTracks()[e];t.addEventListener("enabled",function(t){i.enabled=t.enabled})}),n.getTracks().forEach(function(t){i.addTrack(t,n)})}},h.prototype.removeTrack=function(e){if(this._isClosed)throw s("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(e instanceof t.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var i=this.transceivers.find(function(t){return t.rtpSender===e});if(!i)throw s("InvalidAccessError","Sender was not created by this connection.");var n=i.stream;i.rtpSender.stop(),i.rtpSender=null,i.track=null,i.stream=null;var r=this.transceivers.map(function(t){return t.stream});-1===r.indexOf(n)&&this.localStreams.indexOf(n)>-1&&this.localStreams.splice(this.localStreams.indexOf(n),1),this._maybeFireNegotiationNeeded()},h.prototype.removeStream=function(t){var e=this;t.getTracks().forEach(function(t){var i=e.getSenders().find(function(e){return e.track===t});i&&e.removeTrack(i)})},h.prototype.getSenders=function(){return this.transceivers.filter(function(t){return!!t.rtpSender}).map(function(t){return t.rtpSender})},h.prototype.getReceivers=function(){return this.transceivers.filter(function(t){return!!t.rtpReceiver}).map(function(t){return t.rtpReceiver})},h.prototype._createIceGatherer=function(e,i){var n=this;if(i&&e>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var r=new t.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(r,"state",{value:"new",writable:!0}),this.transceivers[e].bufferedCandidateEvents=[],this.transceivers[e].bufferCandidates=function(t){var i=!t.candidate||0===Object.keys(t.candidate).length;r.state=i?"completed":"gathering",null!==n.transceivers[e].bufferedCandidateEvents&&n.transceivers[e].bufferedCandidateEvents.push(t)},r.addEventListener("localcandidate",this.transceivers[e].bufferCandidates),r},h.prototype._gather=function(e,i){var r=this,o=this.transceivers[i].iceGatherer;if(!o.onlocalcandidate){var a=this.transceivers[i].bufferedCandidateEvents;this.transceivers[i].bufferedCandidateEvents=null,o.removeEventListener("localcandidate",this.transceivers[i].bufferCandidates),o.onlocalcandidate=function(t){if(!(r.usingBundle&&i>0)){var a=new Event("icecandidate");a.candidate={sdpMid:e,sdpMLineIndex:i};var l=t.candidate,s=!l||0===Object.keys(l).length;if(s)"new"!==o.state&&"gathering"!==o.state||(o.state="completed");else{"new"===o.state&&(o.state="gathering"),l.component=1,l.ufrag=o.getLocalParameters().usernameFragment;var p=n.writeCandidate(l);a.candidate=Object.assign(a.candidate,n.parseCandidate(p)),a.candidate.candidate=p,a.candidate.toJSON=function(){return{candidate:a.candidate.candidate,sdpMid:a.candidate.sdpMid,sdpMLineIndex:a.candidate.sdpMLineIndex,usernameFragment:a.candidate.usernameFragment}}}var h=n.getMediaSections(r._localDescription.sdp);h[a.candidate.sdpMLineIndex]+=s?"a=end-of-candidates\r\n":"a="+a.candidate.candidate+"\r\n",r._localDescription.sdp=n.getDescription(r._localDescription.sdp)+h.join("");var u=r.transceivers.every(function(t){return t.iceGatherer&&"completed"===t.iceGatherer.state});"gathering"!==r.iceGatheringState&&(r.iceGatheringState="gathering",r._emitGatheringStateChange()),s||r._dispatchEvent("icecandidate",a),u&&(r._dispatchEvent("icecandidate",new Event("icecandidate")),r.iceGatheringState="complete",r._emitGatheringStateChange())}},t.setTimeout(function(){a.forEach(function(t){o.onlocalcandidate(t)})},0)}},h.prototype._createIceAndDtlsTransports=function(){var e=this,i=new t.RTCIceTransport(null);i.onicestatechange=function(){e._updateIceConnectionState(),e._updateConnectionState()};var n=new t.RTCDtlsTransport(i);return n.ondtlsstatechange=function(){e._updateConnectionState()},n.onerror=function(){Object.defineProperty(n,"state",{value:"failed",writable:!0}),e._updateConnectionState()},{iceTransport:i,dtlsTransport:n}},h.prototype._disposeIceAndDtlsTransports=function(t){var e=this.transceivers[t].iceGatherer;e&&(delete e.onlocalcandidate,delete this.transceivers[t].iceGatherer);var i=this.transceivers[t].iceTransport;i&&(delete i.onicestatechange,delete this.transceivers[t].iceTransport);var n=this.transceivers[t].dtlsTransport;n&&(delete n.ondtlsstatechange,delete n.onerror,delete this.transceivers[t].dtlsTransport)},h.prototype._transceive=function(t,i,r){var a=o(t.localCapabilities,t.remoteCapabilities);i&&t.rtpSender&&(a.encodings=t.sendEncodingParameters,a.rtcp={cname:n.localCName,compound:t.rtcpParameters.compound},t.recvEncodingParameters.length&&(a.rtcp.ssrc=t.recvEncodingParameters[0].ssrc),t.rtpSender.send(a)),r&&t.rtpReceiver&&a.codecs.length>0&&("video"===t.kind&&t.recvEncodingParameters&&e<15019&&t.recvEncodingParameters.forEach(function(t){delete t.rtx}),t.recvEncodingParameters.length?a.encodings=t.recvEncodingParameters:a.encodings=[{}],a.rtcp={compound:t.rtcpParameters.compound},t.rtcpParameters.cname&&(a.rtcp.cname=t.rtcpParameters.cname),t.sendEncodingParameters.length&&(a.rtcp.ssrc=t.sendEncodingParameters[0].ssrc),t.rtpReceiver.receive(a))},h.prototype.setLocalDescription=function(t){var e,i,r=this;if(-1===["offer","answer"].indexOf(t.type))return Promise.reject(s("TypeError",'Unsupported type "'+t.type+'"'));if(!a("setLocalDescription",t.type,r.signalingState)||r._isClosed)return Promise.reject(s("InvalidStateError","Can not set local "+t.type+" in state "+r.signalingState));if("offer"===t.type)e=n.splitSections(t.sdp),i=e.shift(),e.forEach(function(t,e){var i=n.parseRtpParameters(t);r.transceivers[e].localCapabilities=i}),r.transceivers.forEach(function(t,e){r._gather(t.mid,e)});else if("answer"===t.type){e=n.splitSections(r._remoteDescription.sdp),i=e.shift();var l=n.matchPrefix(i,"a=ice-lite").length>0;e.forEach(function(t,e){var a=r.transceivers[e],s=a.iceGatherer,p=a.iceTransport,h=a.dtlsTransport,u=a.localCapabilities,c=a.remoteCapabilities,f=n.isRejected(t)&&0===n.matchPrefix(t,"a=bundle-only").length;if(!f&&!a.rejected){var v=n.getIceParameters(t,i),T=n.getDtlsParameters(t,i);l&&(T.role="server"),r.usingBundle&&0!==e||(r._gather(a.mid,e),"new"===p.state&&p.start(s,v,l?"controlling":"controlled"),"new"===h.state&&h.start(T));var d=o(u,c);r._transceive(a,d.codecs.length>0,!1)}})}return r._localDescription={type:t.type,sdp:t.sdp},"offer"===t.type?r._updateSignalingState("have-local-offer"):r._updateSignalingState("stable"),Promise.resolve()},h.prototype.setRemoteDescription=function(r){var h=this;if(-1===["offer","answer"].indexOf(r.type))return Promise.reject(s("TypeError",'Unsupported type "'+r.type+'"'));if(!a("setRemoteDescription",r.type,h.signalingState)||h._isClosed)return Promise.reject(s("InvalidStateError","Can not set remote "+r.type+" in state "+h.signalingState));var u={};h.remoteStreams.forEach(function(t){u[t.id]=t});var c=[],f=n.splitSections(r.sdp),v=f.shift(),T=n.matchPrefix(v,"a=ice-lite").length>0,d=n.matchPrefix(v,"a=group:BUNDLE ").length>0;h.usingBundle=d;var E=n.matchPrefix(v,"a=ice-options:")[0];return h.canTrickleIceCandidates=!!E&&E.substr(14).split(" ").indexOf("trickle")>=0,f.forEach(function(a,s){var p=n.splitLines(a),f=n.getKind(a),E=n.isRejected(a)&&0===n.matchPrefix(a,"a=bundle-only").length,S=p[0].substr(2).split(" ")[2],g=n.getDirection(a,v),b=n.parseMsid(a),R=n.getMid(a)||n.generateIdentifier();if(E||"application"===f&&("DTLS/SCTP"===S||"UDP/DTLS/SCTP"===S))h.transceivers[s]={mid:R,kind:f,protocol:S,rejected:!0};else{var L,y,M,C,m,U,O,N,A;!E&&h.transceivers[s]&&h.transceivers[s].rejected&&(h.transceivers[s]=h._createTransceiver(f,!0));var D,w,k=n.parseRtpParameters(a);E||(D=n.getIceParameters(a,v),(w=n.getDtlsParameters(a,v)).role="client"),O=n.parseRtpEncodingParameters(a);var I=n.parseRtcpParameters(a),x=n.matchPrefix(a,"a=end-of-candidates",v).length>0,z=n.matchPrefix(a,"a=candidate:").map(function(t){return n.parseCandidate(t)}).filter(function(t){return 1===t.component});if(("offer"===r.type||"answer"===r.type)&&!E&&d&&s>0&&h.transceivers[s]&&(h._disposeIceAndDtlsTransports(s),h.transceivers[s].iceGatherer=h.transceivers[0].iceGatherer,h.transceivers[s].iceTransport=h.transceivers[0].iceTransport,h.transceivers[s].dtlsTransport=h.transceivers[0].dtlsTransport,h.transceivers[s].rtpSender&&h.transceivers[s].rtpSender.setTransport(h.transceivers[0].dtlsTransport),h.transceivers[s].rtpReceiver&&h.transceivers[s].rtpReceiver.setTransport(h.transceivers[0].dtlsTransport)),"offer"!==r.type||E){if("answer"===r.type&&!E){L=h.transceivers[s],y=L.iceGatherer,M=L.iceTransport,C=L.dtlsTransport,m=L.rtpReceiver,U=L.sendEncodingParameters,N=L.localCapabilities,h.transceivers[s].recvEncodingParameters=O,h.transceivers[s].remoteCapabilities=k,h.transceivers[s].rtcpParameters=I,z.length&&"new"===M.state&&(!T&&!x||d&&0!==s?z.forEach(function(t){l(L.iceTransport,t)}):M.setRemoteCandidates(z)),d&&0!==s||("new"===M.state&&M.start(y,D,"controlling"),"new"===C.state&&C.start(w));var H=o(L.localCapabilities,L.remoteCapabilities),G=H.codecs.filter(function(t){return"rtx"===t.name.toLowerCase()}).length;!G&&L.sendEncodingParameters[0].rtx&&delete L.sendEncodingParameters[0].rtx,h._transceive(L,"sendrecv"===g||"recvonly"===g,"sendrecv"===g||"sendonly"===g),!m||"sendrecv"!==g&&"sendonly"!==g?delete L.rtpReceiver:(A=m.track,b?(u[b.stream]||(u[b.stream]=new t.MediaStream),i(A,u[b.stream]),c.push([A,m,u[b.stream]])):(u.default||(u.default=new t.MediaStream),i(A,u.default),c.push([A,m,u.default])))}}else{(L=h.transceivers[s]||h._createTransceiver(f)).mid=R,L.iceGatherer||(L.iceGatherer=h._createIceGatherer(s,d)),z.length&&"new"===L.iceTransport.state&&(!x||d&&0!==s?z.forEach(function(t){l(L.iceTransport,t)}):L.iceTransport.setRemoteCandidates(z)),N=t.RTCRtpReceiver.getCapabilities(f),e<15019&&(N.codecs=N.codecs.filter(function(t){return"rtx"!==t.name})),U=L.sendEncodingParameters||[{ssrc:1001*(2*s+2)}];var j,P=!1;"sendrecv"===g||"sendonly"===g?(P=!L.rtpReceiver,m=L.rtpReceiver||new t.RTCRtpReceiver(L.dtlsTransport,f),P&&(A=m.track,b&&"-"===b.stream||(b?(u[b.stream]||(u[b.stream]=new t.MediaStream,Object.defineProperty(u[b.stream],"id",{get:function(){return b.stream}})),Object.defineProperty(A,"id",{get:function(){return b.track}}),j=u[b.stream]):(u.default||(u.default=new t.MediaStream),j=u.default)),j&&(i(A,j),L.associatedRemoteMediaStreams.push(j)),c.push([A,m,j]))):L.rtpReceiver&&L.rtpReceiver.track&&(L.associatedRemoteMediaStreams.forEach(function(e){var i,n,r=e.getTracks().find(function(t){return t.id===L.rtpReceiver.track.id});r&&(i=r,(n=e).removeTrack(i),n.dispatchEvent(new t.MediaStreamTrackEvent("removetrack",{track:i})))}),L.associatedRemoteMediaStreams=[]),L.localCapabilities=N,L.remoteCapabilities=k,L.rtpReceiver=m,L.rtcpParameters=I,L.sendEncodingParameters=U,L.recvEncodingParameters=O,h._transceive(h.transceivers[s],!1,P)}}}),void 0===h._dtlsRole&&(h._dtlsRole="offer"===r.type?"active":"passive"),h._remoteDescription={type:r.type,sdp:r.sdp},"offer"===r.type?h._updateSignalingState("have-remote-offer"):h._updateSignalingState("stable"),Object.keys(u).forEach(function(e){var i=u[e];if(i.getTracks().length){if(-1===h.remoteStreams.indexOf(i)){h.remoteStreams.push(i);var n=new Event("addstream");n.stream=i,t.setTimeout(function(){h._dispatchEvent("addstream",n)})}c.forEach(function(t){var e=t[0],n=t[1];i.id===t[2].id&&p(h,e,n,[i])})}}),c.forEach(function(t){t[2]||p(h,t[0],t[1],[])}),t.setTimeout(function(){h&&h.transceivers&&h.transceivers.forEach(function(t){t.iceTransport&&"new"===t.iceTransport.state&&t.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),t.iceTransport.addRemoteCandidate({}))})},4e3),Promise.resolve()},h.prototype.close=function(){this.transceivers.forEach(function(t){t.iceTransport&&t.iceTransport.stop(),t.dtlsTransport&&t.dtlsTransport.stop(),t.rtpSender&&t.rtpSender.stop(),t.rtpReceiver&&t.rtpReceiver.stop()}),this._isClosed=!0,this._updateSignalingState("closed")},h.prototype._updateSignalingState=function(t){this.signalingState=t;var e=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",e)},h.prototype._maybeFireNegotiationNeeded=function(){var e=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,t.setTimeout(function(){if(e.needNegotiation){e.needNegotiation=!1;var t=new Event("negotiationneeded");e._dispatchEvent("negotiationneeded",t)}},0))},h.prototype._updateIceConnectionState=function(){var t,e={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(t){t.iceTransport&&!t.rejected&&e[t.iceTransport.state]++}),t="new",e.failed>0?t="failed":e.checking>0?t="checking":e.disconnected>0?t="disconnected":e.new>0?t="new":e.connected>0?t="connected":e.completed>0&&(t="completed"),t!==this.iceConnectionState){this.iceConnectionState=t;var i=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",i)}},h.prototype._updateConnectionState=function(){var t,e={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(t){t.iceTransport&&t.dtlsTransport&&!t.rejected&&(e[t.iceTransport.state]++,e[t.dtlsTransport.state]++)}),e.connected+=e.completed,t="new",e.failed>0?t="failed":e.connecting>0?t="connecting":e.disconnected>0?t="disconnected":e.new>0?t="new":e.connected>0&&(t="connected"),t!==this.connectionState){this.connectionState=t;var i=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",i)}},h.prototype.createOffer=function(){var i=this;if(i._isClosed)return Promise.reject(s("InvalidStateError","Can not call createOffer after close"));var o=i.transceivers.filter(function(t){return"audio"===t.kind}).length,a=i.transceivers.filter(function(t){return"video"===t.kind}).length,l=arguments[0];if(l){if(l.mandatory||l.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==l.offerToReceiveAudio&&(o=!0===l.offerToReceiveAudio?1:!1===l.offerToReceiveAudio?0:l.offerToReceiveAudio),void 0!==l.offerToReceiveVideo&&(a=!0===l.offerToReceiveVideo?1:!1===l.offerToReceiveVideo?0:l.offerToReceiveVideo)}for(i.transceivers.forEach(function(t){"audio"===t.kind?--o<0&&(t.wantReceive=!1):"video"===t.kind&&--a<0&&(t.wantReceive=!1)});o>0||a>0;)o>0&&(i._createTransceiver("audio"),o--),a>0&&(i._createTransceiver("video"),a--);var p=n.writeSessionBoilerplate(i._sdpSessionId,i._sdpSessionVersion++);i.transceivers.forEach(function(r,o){var a=r.track,l=r.kind,s=r.mid||n.generateIdentifier();r.mid=s,r.iceGatherer||(r.iceGatherer=i._createIceGatherer(o,i.usingBundle));var p=t.RTCRtpSender.getCapabilities(l);e<15019&&(p.codecs=p.codecs.filter(function(t){return"rtx"!==t.name})),p.codecs.forEach(function(t){"H264"===t.name&&void 0===t.parameters["level-asymmetry-allowed"]&&(t.parameters["level-asymmetry-allowed"]="1"),r.remoteCapabilities&&r.remoteCapabilities.codecs&&r.remoteCapabilities.codecs.forEach(function(e){t.name.toLowerCase()===e.name.toLowerCase()&&t.clockRate===e.clockRate&&(t.preferredPayloadType=e.payloadType)})}),p.headerExtensions.forEach(function(t){var e=r.remoteCapabilities&&r.remoteCapabilities.headerExtensions||[];e.forEach(function(e){t.uri===e.uri&&(t.id=e.id)})});var h=r.sendEncodingParameters||[{ssrc:1001*(2*o+1)}];a&&e>=15019&&"video"===l&&!h[0].rtx&&(h[0].rtx={ssrc:h[0].ssrc+1}),r.wantReceive&&(r.rtpReceiver=new t.RTCRtpReceiver(r.dtlsTransport,l)),r.localCapabilities=p,r.sendEncodingParameters=h}),"max-compat"!==i._config.bundlePolicy&&(p+="a=group:BUNDLE "+i.transceivers.map(function(t){return t.mid}).join(" ")+"\r\n"),p+="a=ice-options:trickle\r\n",i.transceivers.forEach(function(t,e){p+=r(t,t.localCapabilities,"offer",t.stream,i._dtlsRole),p+="a=rtcp-rsize\r\n",!t.iceGatherer||"new"===i.iceGatheringState||0!==e&&i.usingBundle||(t.iceGatherer.getLocalCandidates().forEach(function(t){t.component=1,p+="a="+n.writeCandidate(t)+"\r\n"}),"completed"===t.iceGatherer.state&&(p+="a=end-of-candidates\r\n"))});var h=new t.RTCSessionDescription({type:"offer",sdp:p});return Promise.resolve(h)},h.prototype.createAnswer=function(){var i=this;if(i._isClosed)return Promise.reject(s("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==i.signalingState&&"have-local-pranswer"!==i.signalingState)return Promise.reject(s("InvalidStateError","Can not call createAnswer in signalingState "+i.signalingState));var a=n.writeSessionBoilerplate(i._sdpSessionId,i._sdpSessionVersion++);i.usingBundle&&(a+="a=group:BUNDLE "+i.transceivers.map(function(t){return t.mid}).join(" ")+"\r\n"),a+="a=ice-options:trickle\r\n";var l=n.getMediaSections(i._remoteDescription.sdp).length;i.transceivers.forEach(function(t,n){if(!(n+1>l)){if(t.rejected)return"application"===t.kind?"DTLS/SCTP"===t.protocol?a+="m=application 0 DTLS/SCTP 5000\r\n":a+="m=application 0 "+t.protocol+" webrtc-datachannel\r\n":"audio"===t.kind?a+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===t.kind&&(a+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(a+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+t.mid+"\r\n");var s;t.stream&&("audio"===t.kind?s=t.stream.getAudioTracks()[0]:"video"===t.kind&&(s=t.stream.getVideoTracks()[0]),s&&e>=15019&&"video"===t.kind&&!t.sendEncodingParameters[0].rtx&&(t.sendEncodingParameters[0].rtx={ssrc:t.sendEncodingParameters[0].ssrc+1}));var p=o(t.localCapabilities,t.remoteCapabilities),h=p.codecs.filter(function(t){return"rtx"===t.name.toLowerCase()}).length;!h&&t.sendEncodingParameters[0].rtx&&delete t.sendEncodingParameters[0].rtx,a+=r(t,p,"answer",t.stream,i._dtlsRole),t.rtcpParameters&&t.rtcpParameters.reducedSize&&(a+="a=rtcp-rsize\r\n")}});var p=new t.RTCSessionDescription({type:"answer",sdp:a});return Promise.resolve(p)},h.prototype.addIceCandidate=function(t){var e,i=this;return t&&void 0===t.sdpMLineIndex&&!t.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(r,o){if(!i._remoteDescription)return o(s("InvalidStateError","Can not add ICE candidate without a remote description"));if(t&&""!==t.candidate){var a=t.sdpMLineIndex;if(t.sdpMid)for(var p=0;p<i.transceivers.length;p++)if(i.transceivers[p].mid===t.sdpMid){a=p;break}var h=i.transceivers[a];if(!h)return o(s("OperationError","Can not add ICE candidate"));if(h.rejected)return r();var u=Object.keys(t.candidate).length>0?n.parseCandidate(t.candidate):{};if("tcp"===u.protocol&&(0===u.port||9===u.port))return r();if(u.component&&1!==u.component)return r();if((0===a||a>0&&h.iceTransport!==i.transceivers[0].iceTransport)&&!l(h.iceTransport,u))return o(s("OperationError","Can not add ICE candidate"));var c=t.candidate.trim();0===c.indexOf("a=")&&(c=c.substr(2)),(e=n.getMediaSections(i._remoteDescription.sdp))[a]+="a="+(u.type?c:"end-of-candidates")+"\r\n",i._remoteDescription.sdp=n.getDescription(i._remoteDescription.sdp)+e.join("")}else for(var f=0;f<i.transceivers.length&&(i.transceivers[f].rejected||(i.transceivers[f].iceTransport.addRemoteCandidate({}),(e=n.getMediaSections(i._remoteDescription.sdp))[f]+="a=end-of-candidates\r\n",i._remoteDescription.sdp=n.getDescription(i._remoteDescription.sdp)+e.join(""),!i.usingBundle));f++);r()})},h.prototype.getStats=function(e){if(e&&e instanceof t.MediaStreamTrack){var i=null;if(this.transceivers.forEach(function(t){t.rtpSender&&t.rtpSender.track===e?i=t.rtpSender:t.rtpReceiver&&t.rtpReceiver.track===e&&(i=t.rtpReceiver)}),!i)throw s("InvalidAccessError","Invalid selector.");return i.getStats()}var n=[];return this.transceivers.forEach(function(t){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(e){t[e]&&n.push(t[e].getStats())})}),Promise.all(n).then(function(t){var e=new Map;return t.forEach(function(t){t.forEach(function(t){e.set(t.id,t)})}),e})},["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach(function(e){var i=t[e];if(i&&i.prototype&&i.prototype.getStats){var n=i.prototype.getStats;i.prototype.getStats=function(){return n.apply(this).then(function(t){var e=new Map;return Object.keys(t).forEach(function(i){var n;t[i].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(n=t[i]).type]||n.type,e.set(i,t[i])}),e})}}});var u=["createOffer","createAnswer"];return u.forEach(function(t){var e=h.prototype[t];h.prototype[t]=function(){var t=arguments;return"function"==typeof t[0]||"function"==typeof t[1]?e.apply(this,[arguments[2]]).then(function(e){"function"==typeof t[0]&&t[0].apply(null,[e])},function(e){"function"==typeof t[1]&&t[1].apply(null,[e])}):e.apply(this,arguments)}}),(u=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach(function(t){var e=h.prototype[t];h.prototype[t]=function(){var t=arguments;return"function"==typeof t[1]||"function"==typeof t[2]?e.apply(this,arguments).then(function(){"function"==typeof t[1]&&t[1].apply(null)},function(e){"function"==typeof t[2]&&t[2].apply(null,[e])}):e.apply(this,arguments)}}),["getStats"].forEach(function(t){var e=h.prototype[t];h.prototype[t]=function(){var t=arguments;return"function"==typeof t[1]?e.apply(this,arguments).then(function(){"function"==typeof t[1]&&t[1].apply(null)}):e.apply(this,arguments)}}),h}},{sdp:17}],17:[function(t,e,i){"use strict";var n={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};n.localCName=n.generateIdentifier(),n.splitLines=function(t){return t.trim().split("\n").map(function(t){return t.trim()})},n.splitSections=function(t){var e=t.split("\nm=");return e.map(function(t,e){return(e>0?"m="+t:t).trim()+"\r\n"})},n.getDescription=function(t){var e=n.splitSections(t);return e&&e[0]},n.getMediaSections=function(t){var e=n.splitSections(t);return e.shift(),e},n.matchPrefix=function(t,e){return n.splitLines(t).filter(function(t){return 0===t.indexOf(e)})},n.parseCandidate=function(t){for(var e,i={foundation:(e=0===t.indexOf("a=candidate:")?t.substring(12).split(" "):t.substring(10).split(" "))[0],component:parseInt(e[1],10),protocol:e[2].toLowerCase(),priority:parseInt(e[3],10),ip:e[4],address:e[4],port:parseInt(e[5],10),type:e[7]},n=8;n<e.length;n+=2)switch(e[n]){case"raddr":i.relatedAddress=e[n+1];break;case"rport":i.relatedPort=parseInt(e[n+1],10);break;case"tcptype":i.tcpType=e[n+1];break;case"ufrag":i.ufrag=e[n+1],i.usernameFragment=e[n+1];break;default:i[e[n]]=e[n+1]}return i},n.writeCandidate=function(t){var e=[];e.push(t.foundation),e.push(t.component),e.push(t.protocol.toUpperCase()),e.push(t.priority),e.push(t.address||t.ip),e.push(t.port);var i=t.type;return e.push("typ"),e.push(i),"host"!==i&&t.relatedAddress&&t.relatedPort&&(e.push("raddr"),e.push(t.relatedAddress),e.push("rport"),e.push(t.relatedPort)),t.tcpType&&"tcp"===t.protocol.toLowerCase()&&(e.push("tcptype"),e.push(t.tcpType)),(t.usernameFragment||t.ufrag)&&(e.push("ufrag"),e.push(t.usernameFragment||t.ufrag)),"candidate:"+e.join(" ")},n.parseIceOptions=function(t){return t.substr(14).split(" ")},n.parseRtpMap=function(t){var e=t.substr(9).split(" "),i={payloadType:parseInt(e.shift(),10)};return e=e[0].split("/"),i.name=e[0],i.clockRate=parseInt(e[1],10),i.channels=3===e.length?parseInt(e[2],10):1,i.numChannels=i.channels,i},n.writeRtpMap=function(t){var e=t.payloadType;void 0!==t.preferredPayloadType&&(e=t.preferredPayloadType);var i=t.channels||t.numChannels||1;return"a=rtpmap:"+e+" "+t.name+"/"+t.clockRate+(1!==i?"/"+i:"")+"\r\n"},n.parseExtmap=function(t){var e=t.substr(9).split(" ");return{id:parseInt(e[0],10),direction:e[0].indexOf("/")>0?e[0].split("/")[1]:"sendrecv",uri:e[1]}},n.writeExtmap=function(t){return"a=extmap:"+(t.id||t.preferredId)+(t.direction&&"sendrecv"!==t.direction?"/"+t.direction:"")+" "+t.uri+"\r\n"},n.parseFmtp=function(t){for(var e,i={},n=t.substr(t.indexOf(" ")+1).split(";"),r=0;r<n.length;r++)e=n[r].trim().split("="),i[e[0].trim()]=e[1];return i},n.writeFmtp=function(t){var e="",i=t.payloadType;if(void 0!==t.preferredPayloadType&&(i=t.preferredPayloadType),t.parameters&&Object.keys(t.parameters).length){var n=[];Object.keys(t.parameters).forEach(function(e){t.parameters[e]?n.push(e+"="+t.parameters[e]):n.push(e)}),e+="a=fmtp:"+i+" "+n.join(";")+"\r\n"}return e},n.parseRtcpFb=function(t){var e=t.substr(t.indexOf(" ")+1).split(" ");return{type:e.shift(),parameter:e.join(" ")}},n.writeRtcpFb=function(t){var e="",i=t.payloadType;return void 0!==t.preferredPayloadType&&(i=t.preferredPayloadType),t.rtcpFeedback&&t.rtcpFeedback.length&&t.rtcpFeedback.forEach(function(t){e+="a=rtcp-fb:"+i+" "+t.type+(t.parameter&&t.parameter.length?" "+t.parameter:"")+"\r\n"}),e},n.parseSsrcMedia=function(t){var e=t.indexOf(" "),i={ssrc:parseInt(t.substr(7,e-7),10)},n=t.indexOf(":",e);return n>-1?(i.attribute=t.substr(e+1,n-e-1),i.value=t.substr(n+1)):i.attribute=t.substr(e+1),i},n.parseSsrcGroup=function(t){var e=t.substr(13).split(" ");return{semantics:e.shift(),ssrcs:e.map(function(t){return parseInt(t,10)})}},n.getMid=function(t){var e=n.matchPrefix(t,"a=mid:")[0];if(e)return e.substr(6)},n.parseFingerprint=function(t){var e=t.substr(14).split(" ");return{algorithm:e[0].toLowerCase(),value:e[1]}},n.getDtlsParameters=function(t,e){var i=n.matchPrefix(t+e,"a=fingerprint:");return{role:"auto",fingerprints:i.map(n.parseFingerprint)}},n.writeDtlsParameters=function(t,e){var i="a=setup:"+e+"\r\n";return t.fingerprints.forEach(function(t){i+="a=fingerprint:"+t.algorithm+" "+t.value+"\r\n"}),i},n.getIceParameters=function(t,e){var i=n.splitLines(t),r={usernameFragment:(i=i.concat(n.splitLines(e))).filter(function(t){return 0===t.indexOf("a=ice-ufrag:")})[0].substr(12),password:i.filter(function(t){return 0===t.indexOf("a=ice-pwd:")})[0].substr(10)};return r},n.writeIceParameters=function(t){return"a=ice-ufrag:"+t.usernameFragment+"\r\na=ice-pwd:"+t.password+"\r\n"},n.parseRtpParameters=function(t){for(var e={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},i=n.splitLines(t),r=i[0].split(" "),o=3;o<r.length;o++){var a=r[o],l=n.matchPrefix(t,"a=rtpmap:"+a+" ")[0];if(l){var s=n.parseRtpMap(l),p=n.matchPrefix(t,"a=fmtp:"+a+" ");switch(s.parameters=p.length?n.parseFmtp(p[0]):{},s.rtcpFeedback=n.matchPrefix(t,"a=rtcp-fb:"+a+" ").map(n.parseRtcpFb),e.codecs.push(s),s.name.toUpperCase()){case"RED":case"ULPFEC":e.fecMechanisms.push(s.name.toUpperCase())}}}return n.matchPrefix(t,"a=extmap:").forEach(function(t){e.headerExtensions.push(n.parseExtmap(t))}),e},n.writeRtpDescription=function(t,e){var i="";i+="m="+t+" ",i+=e.codecs.length>0?"9":"0",i+=" UDP/TLS/RTP/SAVPF ",i+=e.codecs.map(function(t){return void 0!==t.preferredPayloadType?t.preferredPayloadType:t.payloadType}).join(" ")+"\r\n",i+="c=IN IP4 0.0.0.0\r\n",i+="a=rtcp:9 IN IP4 0.0.0.0\r\n",e.codecs.forEach(function(t){i+=n.writeRtpMap(t),i+=n.writeFmtp(t),i+=n.writeRtcpFb(t)});var r=0;return e.codecs.forEach(function(t){t.maxptime>r&&(r=t.maxptime)}),r>0&&(i+="a=maxptime:"+r+"\r\n"),i+="a=rtcp-mux\r\n",e.headerExtensions&&e.headerExtensions.forEach(function(t){i+=n.writeExtmap(t)}),i},n.parseRtpEncodingParameters=function(t){var e,i=[],r=n.parseRtpParameters(t),o=-1!==r.fecMechanisms.indexOf("RED"),a=-1!==r.fecMechanisms.indexOf("ULPFEC"),l=n.matchPrefix(t,"a=ssrc:").map(function(t){return n.parseSsrcMedia(t)}).filter(function(t){return"cname"===t.attribute}),s=l.length>0&&l[0].ssrc,p=n.matchPrefix(t,"a=ssrc-group:FID").map(function(t){var e=t.substr(17).split(" ");return e.map(function(t){return parseInt(t,10)})});p.length>0&&p[0].length>1&&p[0][0]===s&&(e=p[0][1]),r.codecs.forEach(function(t){if("RTX"===t.name.toUpperCase()&&t.parameters.apt){var n={ssrc:s,codecPayloadType:parseInt(t.parameters.apt,10)};s&&e&&(n.rtx={ssrc:e}),i.push(n),o&&((n=JSON.parse(JSON.stringify(n))).fec={ssrc:s,mechanism:a?"red+ulpfec":"red"},i.push(n))}}),0===i.length&&s&&i.push({ssrc:s});var h=n.matchPrefix(t,"b=");return h.length&&(h=0===h[0].indexOf("b=TIAS:")?parseInt(h[0].substr(7),10):0===h[0].indexOf("b=AS:")?1e3*parseInt(h[0].substr(5),10)*.95-16e3:void 0,i.forEach(function(t){t.maxBitrate=h})),i},n.parseRtcpParameters=function(t){var e={},i=n.matchPrefix(t,"a=ssrc:").map(function(t){return n.parseSsrcMedia(t)}).filter(function(t){return"cname"===t.attribute})[0];i&&(e.cname=i.value,e.ssrc=i.ssrc);var r=n.matchPrefix(t,"a=rtcp-rsize");e.reducedSize=r.length>0,e.compound=0===r.length;var o=n.matchPrefix(t,"a=rtcp-mux");return e.mux=o.length>0,e},n.parseMsid=function(t){var e,i=n.matchPrefix(t,"a=msid:");if(1===i.length)return{stream:(e=i[0].substr(7).split(" "))[0],track:e[1]};var r=n.matchPrefix(t,"a=ssrc:").map(function(t){return n.parseSsrcMedia(t)}).filter(function(t){return"msid"===t.attribute});return r.length>0?{stream:(e=r[0].value.split(" "))[0],track:e[1]}:void 0},n.generateSessionId=function(){return Math.random().toString().substr(2,21)},n.writeSessionBoilerplate=function(t,e,i){var r,o=void 0!==e?e:2;r=t||n.generateSessionId();var a=i||"thisisadapterortc";return"v=0\r\no="+a+" "+r+" "+o+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},n.writeMediaSection=function(t,e,i,r){var o=n.writeRtpDescription(t.kind,e);if(o+=n.writeIceParameters(t.iceGatherer.getLocalParameters()),o+=n.writeDtlsParameters(t.dtlsTransport.getLocalParameters(),"offer"===i?"actpass":"active"),o+="a=mid:"+t.mid+"\r\n",t.direction?o+="a="+t.direction+"\r\n":t.rtpSender&&t.rtpReceiver?o+="a=sendrecv\r\n":t.rtpSender?o+="a=sendonly\r\n":t.rtpReceiver?o+="a=recvonly\r\n":o+="a=inactive\r\n",t.rtpSender){var a="msid:"+r.id+" "+t.rtpSender.track.id+"\r\n";o+="a="+a,o+="a=ssrc:"+t.sendEncodingParameters[0].ssrc+" "+a,t.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+t.sendEncodingParameters[0].rtx.ssrc+" "+a,o+="a=ssrc-group:FID "+t.sendEncodingParameters[0].ssrc+" "+t.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return o+="a=ssrc:"+t.sendEncodingParameters[0].ssrc+" cname:"+n.localCName+"\r\n",t.rtpSender&&t.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+t.sendEncodingParameters[0].rtx.ssrc+" cname:"+n.localCName+"\r\n"),o},n.getDirection=function(t,e){for(var i=n.splitLines(t),r=0;r<i.length;r++)switch(i[r]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return i[r].substr(2)}return e?n.getDirection(e):"sendrecv"},n.getKind=function(t){var e=n.splitLines(t),i=e[0].split(" ");return i[0].substr(2)},n.isRejected=function(t){return"0"===t.split(" ",2)[1]},n.parseMLine=function(t){var e=n.splitLines(t),i=e[0].substr(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},n.parseOLine=function(t){var e=n.matchPrefix(t,"o=")[0],i=e.substr(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},n.isValidSDP=function(t){if("string"!=typeof t||0===t.length)return!1;for(var e=n.splitLines(t),i=0;i<e.length;i++)if(e[i].length<2||"="!==e[i].charAt(1))return!1;return!0},"object"==typeof e&&(e.exports=n)},{}]},{},[1])(1)},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){this.delayTime=.1,this.fadeTime=.05,this.startTime=.1,this.previousPitch=-1,this.context=t,this.input=t.createGain(),this.output=t.createGain(),this.mod1=t.createBufferSource(),this.mod2=t.createBufferSource(),this.mod3=t.createBufferSource(),this.mod4=t.createBufferSource(),this.shiftDownBuffer=this.createDelayTimeBuffer(t,this.startTime,this.fadeTime,!1),this.shiftUpBuffer=this.createDelayTimeBuffer(t,this.startTime,this.fadeTime,!0),this.mod1.buffer=this.shiftDownBuffer,this.mod2.buffer=this.shiftDownBuffer,this.mod3.buffer=this.shiftUpBuffer,this.mod4.buffer=this.shiftUpBuffer,this.mod1.loop=!0,this.mod2.loop=!0,this.mod3.loop=!0,this.mod4.loop=!0,this.mod1Gain=t.createGain(),this.mod2Gain=t.createGain(),this.mod3Gain=t.createGain(),this.mod4Gain=t.createGain(),this.mod3Gain.gain.value=0,this.mod4Gain.gain.value=0,this.mod1.connect(this.mod1Gain),this.mod2.connect(this.mod2Gain),this.mod3.connect(this.mod3Gain),this.mod4.connect(this.mod4Gain),this.modGain1=t.createGain(),this.modGain2=t.createGain(),this.delay1=t.createDelay(),this.delay2=t.createDelay(),this.mod1Gain.connect(this.modGain1),this.mod2Gain.connect(this.modGain2),this.mod3Gain.connect(this.modGain1),this.mod4Gain.connect(this.modGain2),this.modGain1.connect(this.delay1.delayTime),this.modGain2.connect(this.delay2.delayTime),this.fade1=t.createBufferSource(),this.fade2=t.createBufferSource(),this.fadeBuffer=this.createFadeBuffer(t,this.startTime,this.fadeTime),this.fade1.buffer=this.fadeBuffer,this.fade2.buffer=this.fadeBuffer,this.fade1.loop=!0,this.fade2.loop=!0,this.mix1=t.createGain(),this.mix2=t.createGain(),this.mix1.gain.value=0,this.mix2.gain.value=0,this.fade1.connect(this.mix1.gain),this.fade2.connect(this.mix2.gain),this.input.connect(this.delay1),this.input.connect(this.delay2),this.delay1.connect(this.mix1),this.delay2.connect(this.mix2),this.mix1.connect(this.output),this.mix2.connect(this.output);var e=t.currentTime+.05,i=e+this.startTime-this.fadeTime;this.mod1.start(e),this.mod2.start(i),this.mod3.start(e),this.mod4.start(i),this.fade1.start(e),this.fade2.start(i),this.setDelay(this.delayTime)}return t.prototype.createFadeBuffer=function(t,e,i){for(var n=e*t.sampleRate,r=n+(e-2*i)*t.sampleRate,o=t.createBuffer(1,r,t.sampleRate),a=o.getChannelData(0),l=i*t.sampleRate,s=n-l,p=0;p<n;++p)a[p]=p<l?Math.sqrt(p/l):p>=s?Math.sqrt(1-(p-s)/l):1;for(p=n;p<length;++p)a[p]=0;return o},t.prototype.createDelayTimeBuffer=function(t,e,i,n){for(var r=e*t.sampleRate,o=r+(e-2*i)*t.sampleRate,a=t.createBuffer(1,o,t.sampleRate),l=a.getChannelData(0),s=0;s<r;++s)l[s]=n?(r-s)/o:s/r;for(s=r;s<o;++s)l[s]=0;return a},t.prototype.setDelay=function(t){this.modGain1.gain.setTargetAtTime(.5*t,0,.01),this.modGain2.gain.setTargetAtTime(.5*t,0,.01)},t.prototype.setPitchOffset=function(t){t>0?(this.mod1Gain.gain.value=0,this.mod2Gain.gain.value=0,this.mod3Gain.gain.value=1,this.mod4Gain.gain.value=1):(this.mod1Gain.gain.value=1,this.mod2Gain.gain.value=1,this.mod3Gain.gain.value=0,this.mod4Gain.gain.value=0),this.setDelay(this.delayTime*Math.abs(t)),this.previousPitch=t},t}();e.pitchUtil=n},function(t,e,i){"use strict";var n=this&&this.__assign||Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t};Object.defineProperty(e,"__esModule",{value:!0});var r=i(0),o=i(1),a=function(){function t(t,e){this.sendDataMap={},this.sendDataList=new r.LinkedList,this.sendDataCheckOnceCount=100,this.signalSeq=0,this.pushCallback={},this.sessionInfos={},this.tryHeartbeatCount=0,this.heartbeatInterval=1e4,this.sendDataTimeout=5e3,this.sendDataDropTimeout=1e4,this.tryConnectCount=1,this.tryConnectTimer=null,this.tryConnectInterval=3e3,this.state=r.ENUM_CONNECT_STATE.disconnect,this.tokenType=0,this.browser=this.getBrowserAndVersion(),this.platform=navigator.platform,this.negoInterval=25e3,this.negoTryCount=1,this.negoTryMaxCount=2,this.logger=t,this.stateCenter=e}return t.prototype.getBrowserAndVersion=function(){var t,e=navigator.userAgent,i=e.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*([\d\.]+)/i)||[];return/trident/i.test(i[1])?{name:"IE",version:(t=/\brv[ :]+([\d\.]+)/g.exec(e)||[])[1]||""}:"Chrome"===i[1]&&null!=(t=e.match(/\bOPR|Edge\/([\d\.]+)/))?{name:"Opera",version:t[1]}:(i=i[2]?[i[1],i[2]]:[navigator.appName,navigator.appVersion,"-?"],null!=(t=e.match(/version\/([\d+\.]+)/i))&&i.splice(1,1,t[1]),{name:i[0],version:i[1]})},t.prototype.setSessionInfo=function(t,e){this.logger.debug("zs.ssi.0 call"),this.appid=t+"",this.userid=e},t.prototype.onDisconnect=function(t){},t.prototype.onUpdateHeartBeartInterval=function(t){},t.prototype.resetConnectTimer=function(){this.logger.info("zs.rct.0 call"),clearTimeout(this.tryConnectTimer),this.tryConnectTimer=null,this.tryConnectCount=0},t.prototype.bindWebSocketHandle=function(){var t=this;this.tryHeartbeatCount=0,this.websocket.onmessage=function(e){var i=JSON.parse(e.data);t.logger.info("zs.bsh.0 signmsg= ",i.header.cmd),t.logger.info("zs.bsh.0 signmsg= "+JSON.stringify(i)),i.header.appid==t.appid&&i.header.user_id===t.userid?t.handleServerPush(i):t.logger.warn("zs.bsh.0 check header failed")},this.websocket.onclose=function(e){t.logger.info("zs.bsh.0 signal close msg = "+JSON.stringify(e.code)),t.state!=r.ENUM_CONNECT_STATE.disconnect&&(t.resetConnectTimer(),t.startConnectTimer(),t.resetCheckMessage())},this.websocket.onerror=function(e){t.logger.error("zs.bsh.0 msg = "+JSON.stringify(e))}},t.prototype.resetCheckMessage=function(){this.logger.debug("zs.rcm.0 call");for(var t=this.sendDataList.getFirst();null!=t;)this.sendDataList.remove(t),t._data.error&&t._data.error(r.SEND_MSG_RESET,t._data.seq),t=this.sendDataList.getFirst();this.sendDataMap={}},t.prototype.handleServerPush=function(t){switch(t.header.cmd){case"LoginRsp":this.handleRespondData("LoginReq",t);break;case"CreateSessionRsp":this.handleRespondData("CreateSessionReq",t),0===t.body.result&&this.addSession(t.header.session_id,t.body.session_token);break;case"MediaDescRsp":this.handleRespondData("MediaDescReq",t);break;case"CandidateInfoRsp":this.handleRespondData("CandidateInfoReq",t);break;case"CloseSessionRsp":this.handleRespondData("CloseSessionReq",t),this.removeSession(t.header.session_id);break;case"ClientHBRsp":this.handleRespondData("ClientHBReq",t);break;case"MediaDescPush":case"CandidateInfoPush":this.handlePushData(t);break;case"CloseSessionPush":this.handlePushData(t),this.removeSession(t.header.session_id);break;case"QualityReportRsp":this.handleRespondData("QualityReportReq",t);break;case"SessionResetPush":this.handlePushResetSessionData(t);break;case"StreamStatusNotifyPush":case"PublishEventPush":case"PlayEventPush":this.handlePushData(t)}},t.prototype.disconnectCallback=function(){this.connectCallback&&(this.connectCallback(-1,this.server,void 0),this.connectCallback=null);var t=this.server;this.disconnectServer(),this.onDisconnect(t)},t.prototype.updateToken=function(){var t=this;this.logger.info("zs.ut.0 call");var e={token:this.token,tokenType:this.tokenType,roomid:this.stateCenter.roomid,anchorname:this.stateCenter.anchor_info.anchor_id,sdkversion:r.PROTO_VERSION,osinfo:navigator.appVersion};if(0!=Object.keys(this.sessionInfos).length){var i=[];for(var n in this.sessionInfos){var a=parseInt(n);i.push({session_id:a,session_token:this.sessionInfos[a].token})}e.sessions=i}this.sendMessageWithCallback("LoginReq",o.getSeq(),0,e,function(e,i,n){if(0==n.result){t.token=n.token,t.tokenType=n.tokenType;var r={report:n.report,report_interval:n.report_interval_ms};n.negoInterval&&(t.negoInterval=n.negoInterval),n.negoTryCount&&(t.negoTryCount=n.negoTryCount),n.negoTryMaxCount&&(t.negoTryMaxCount=n.negoTryMaxCount),null!=t.connectCallback&&(t.connectCallback(0,t.server,r),t.connectCallback=null)}else{var o={error:n.strError};null!=t.connectCallback&&(t.connectCallback(n.result,t.server,o),t.connectCallback=null)}},function(e,i){null!=t.connectCallback&&(t.connectCallback(-1,t.server,void 0),t.connectCallback=null)})},t.prototype.sendMessageWithCallback=function(t,e,i,n,o,a){if(this.logger.debug("zs.smwc.0 call "+t),!this.websocket||1!==this.websocket.readyState)return this.logger.error("zs.smwc.0 connect not establish"),void(a&&a(r.SEND_MSG_TIMEOUT,e));var l={header:this.getHeader(t,e,i),body:n};null==o&&(o=null),null==a&&(a=null);var s={seq:e,deleted:!1,cmd:t,time:Date.parse(new Date+""),success:o,error:a},p=this.sendDataList.push(s);this.sendDataMap[s.seq]=p;var h=JSON.stringify(l);this.websocket.send(h),this.logger.debug("zs.smwc.0 success")},t.prototype.getHeader=function(t,e,i){return this.globalHeader={version:"1.0.1",cmd:t,appid:this.appid+"",seq:e,user_id:this.userid,session_id:i},this.globalHeader},t.prototype.connectServer=function(t,e,i){var n=this;if(this.token=t,this.server=e,this.state=r.ENUM_CONNECT_STATE.connecting,this.connectCallback=i,this.websocket&&1===this.websocket.readyState)this.resetConnectTimer(),this.state=r.ENUM_CONNECT_STATE.connected;else{this.logger.info("zs.cs.0 need new websocket");try{this.websocket&&(this.logger.warn("zs.cs.0 close error websocket"),this.websocket.onclose=null,this.websocket.onerror=null,this.websocket.close(),this.websocket=null),this.websocket=new WebSocket(this.server),this.websocket.onopen=function(){n.resetConnectTimer(),n.logger.info("zs.cs.0 websocket open call"),n.bindWebSocketHandle(),n.updateToken(),n.state=r.ENUM_CONNECT_STATE.connected},this.websocket.onclose=function(t){n.logger.info("zs.cs.0 signal websocket close code "+JSON.stringify(t.code))},this.websocket.onerror=function(t){n.logger.info("zs.cs.0 websocket onerror call  "+JSON.stringify(t))}}catch(t){this.logger.error("zs.cs.0 websocket error "+t)}}this.tryConnectTimer=setTimeout(function(){n.startConnectTimer(i)},this.tryConnectInterval)},t.prototype.startConnectTimer=function(t){if(this.logger.info("zs.sct.0 call"),this.tryConnectCount>=r.MAX_TRY_CONNECT_COUNT)return this.logger.info("zs.sct.0 beyond "+this.server+" max limit"),void this.disconnectCallback();this.websocket&&1===this.websocket.readyState?this.resetConnectTimer():(this.tryConnectCount+=1,this.connectServer(this.token,this.server,t))},t.prototype.disconnectServer=function(){this.logger.debug("zs.ds.0 call"),this.connectCallback=null,this.resetCheckMessage(),this.resetConnectTimer(),this.websocket&&(this.websocket.onclose=null,this.websocket.onerror=null,this.websocket.close(),this.websocket=null),this.token="",this.sessionInfos={},this.tokenType=0,this.tryHeartbeatCount=0,this.tryConnectCount=0,this.state=r.ENUM_CONNECT_STATE.disconnect},t.prototype.isServerConnected=function(){return!(!this.websocket||1!==this.websocket.readyState)},t.prototype.createSession=function(t,e,i,n,o,a,l){void 0===o&&(o=""),this.logger.debug("zs.cs.1 call: ",n);var s="";r.PROTO_VERSION.split(".").forEach(function(t,e){return 1==t.length&&1==e?s+="0"+t:s+=t});var p={type:e,stream_id:n,platform:this.platform,browser:this.browser.name,version:this.browser.version,app_id:this.appid,negotiate_mode:i,strAuthParam:o,sdk_version:1*s};this.sendMessageWithCallback("CreateSessionReq",t,0,p,a,l)},t.prototype.removeSession=function(t){this.logger.info("zs.rs.0 call"),this.sessionInfos[t]&&delete this.sessionInfos[t]},t.prototype.sendCloseSession=function(t,e,i,n,r){this.logger.debug("zs.scs.0 call: ",e);var o={reason:i};this.removeSession(e),this.sendMessageWithCallback("CloseSessionReq",t,e,o,n,r)},t.prototype.sendMessage=function(t,e,i,n){if(this.logger.debug("zs.sm.0 call "+t),this.websocket&&1===this.websocket.readyState){var r={header:this.getHeader(t,e,i),body:n},o=JSON.stringify(r);this.websocket.send(o),this.logger.debug("zs.sm.0 success")}else this.logger.error("zs.sm.0 connect not establish")},t.prototype.handleRespondData=function(t,e){this.logger.debug("zs.hrd.0 call");var i=this.sendDataMap[e.header.seq];if(null!=i){var n=i._data;n.cmd!==t?this.logger.error("sz.hrd.0 command is not match"):n.success&&n.success(e.header.seq,e.header.session_id,e.body),delete this.sendDataMap[e.header.seq],this.sendDataList.remove(i)}else{if("CloseSessionRsp"==e.header.cmd)return;this.logger.error("zs.hrd.0 cannot find data "+t)}},t.prototype.addSession=function(t,e){this.logger.info("zs.as.0 call"),this.sessionInfos[t]={token:e}},t.prototype.handlePushData=function(t){this.logger.debug("zs.hpd.0 call "+t.header.cmd+" session "+t.header.session_id);var e=this.pushCallback[t.header.cmd+t.header.session_id];e?e.callback&&e.callback(t.header.seq,t.header.session_id,t.body):this.logger.info("zs.hpd.0 no callbackData "+t.header.cmd+" session: "+t.header.session_id)},t.prototype.handlePushResetSessionData=function(t){this.logger.debug("zs.hprsd.0 call ");var e=[];if(0==t.body.cResetType)e=Object.keys(this.sessionInfos);else if(1==t.body.cResetType)for(var i=0;i<t.body.session_ids.length;i++)e.push(t.body.session_ids[i]);if(this.sendResetSessionAck(t.header.seq,0,0),0!=e.length)for(var n=0;n<e.length;n++){var r=this.pushCallback[t.header.cmd+e[n]];null==r?this.logger.info("zs.hprsd.0 no callbackData "+e[n]):r.callback&&r.callback(t.header.seq,e[n],t.body)}else this.logger.info("zs.hprsd.0 no session to callback")},t.prototype.sendMediaDesc=function(t,e,i,n,r,o){this.logger.debug("zs.smd.0 call: ",e);var a={type:i,sdp:n.sdp};null!=n.width&&(a.width=n.width),null!=n.height&&(a.height=n.height),null!=n.frameRate&&(a.framerate=n.frameRate),null!=n.video_min_kpbs&&(a.video_min_kpbs=n.video_min_kpbs),null!=n.video_max_kpbs&&(a.video_max_kpbs=n.video_max_kpbs),null!=n.audio_kpbs&&(a.audio_kpbs=n.audio_kpbs),null!=n.keyframe_intv&&(a.keyframe_intv=n.keyframe_intv),this.sendMessageWithCallback("MediaDescReq",t,e,a,r,o)},t.prototype.sendCandidateInfo=function(t,e,i,n,r){this.logger.debug("zs.sci.0 call: ",e);for(var o=[],a=0;a<i.length;a++){var l={candidate:i[a].candidate,sdpMid:i[a].sdpMid,sdpMLineIndex:i[a].sdpMLineIndex};o.push(l)}var s={infos:o};this.sendMessageWithCallback("CandidateInfoReq",t,e,s,n,r)},t.prototype.sendMediaDescAck=function(t,e,i){this.logger.debug("zs.smda.0 call: ",e);var n={result:i};this.sendMessage("MediaDescAck",t,e,n)},t.prototype.sendCandidateInfoAck=function(t,e,i){this.logger.debug("zs.scia.0 call: ",e);var n={result:i};this.sendMessage("CandidateInfoAck",t,e,n)},t.prototype.sendCloseSessionAck=function(t,e,i){this.logger.debug("zs.scsa.0 call: ",e);var n={result:i};this.sendMessage("CloseSessionAck",t,e,n)},t.prototype.sendResetSessionAck=function(t,e,i){this.logger.debug("zs.ssra.0 call: ",e);var n={result:i};this.sendMessage("SessionResetAck",t,e,n)},t.prototype.registerPushCallback=function(t,e,i){i&&"function"==typeof i&&(this.logger.debug("zs.rpc.0 setcallback"),this.pushCallback[t+e]={callback:i})},t.prototype.unregisterPushCallback=function(t,e){delete this.pushCallback[t+e]},t.prototype.checkMessageTimeout=function(){for(var t=this.sendDataList.getFirst(),e=Date.parse(new Date+""),i=0,n=0,o=0;!(null==t||t._data.time+this.sendDataTimeout>e||(delete this.sendDataMap[t._data.seq],this.sendDataList.remove(t),++n,null==t._data.error||this.sendDataDropTimeout>0&&t._data.time+this.sendDataDropTimeout<e?++o:t._data.error&&t._data.error(r.SEND_MSG_TIMEOUT,t._data.seq),++i>=this.sendDataCheckOnceCount));)t=this.sendDataList.getFirst();0==n&&0==o||this.logger.debug("zs.cmt.0 call success, state: timeout=",n," drop=",o)},t.prototype.sendHeartbeat=function(){var t=this;if(this.logger.debug("zs.shb.0 call tryHeartbeatCount:"+this.tryHeartbeatCount),0!=Object.keys(this.sessionInfos).length){if(++this.tryHeartbeatCount>r.MAX_TRY_HEARTBEAT_COUNT)return this.logger.error("zs.shb.0 heartbeat try limit"),void this.disconnectCallback();var e=[];for(var i in this.sessionInfos)e.push(parseInt(i));var n={session_ids:e};this.sendMessageWithCallback("ClientHBReq",o.getSeq(),0,n,function(e,i,n){t.heartbeatInterval!=n.hb_interval&&(t.heartbeatInterval=n.hb_interval,t.onUpdateHeartBeartInterval(n.hb_interval)),t.tryHeartbeatCount=0},function(t,e){})}else this.logger.info("zs.shb.0 no need to heartbeat")},t.prototype.QualityReport=function(t,e,i,r,o){this.logger.debug("zs.qr.0 call");var a={streams:[n({},i,{aid:e})]};this.sendMessageWithCallback("QualityReportReq",t,e,a,r,o)},t.prototype.sendStreamStatus=function(t,e,i,n,r){this.logger.debug("zs.sss.0 call");var o={mic_status:n,camera_status:i};this.logger.info("zs.sss.0 stream "+(r||"")+" status "+JSON.stringify(o)),this.sendMessage("StreamStatusNotify",t,e,o)},t.prototype.sendBroadcasterStatus=function(t,e,i){this.logger.debug("zs.sss.0 call");var n={status:i};this.sendMessage("BroadcasterStatusNotify",t,e,n)},t}();e.ZegoSignal=a},function(t,e,i){"use strict";var n=this&&this.__assign||Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t};Object.defineProperty(e,"__esModule",{value:!0});var r=i(0),o=i(1),a=i(5),l=function(){function t(t,e,i,n,a){this.state=r.ENUM_PLAY_STATE.stop,this.candidateInfo=[],this.waitICETimer=null,this.waitingICETimeInterval=5e3,this.waitingOfferTimer=null,this.waitingOfferTimeInterval=5e3,this.qualityTimer=null,this.playQualityList=[],this.maxQualityListCount=10,this.lastPlayStats={audioPacketsLost:0,videoPacketsLost:0,time:0,audioTime:0,videoTime:0,audioBytesReceived:0,videoBytesReceived:0,framesDecoded:0,framesReceived:0,framesDropped:0,audioBitrate:0,audioPacketsReceived:0},this.reportSeq=o.getSeq(),this.videoSizeCallback=!1,this.qualityUpload=!1,this.qualityUploadInterval=3e4,this.qualityUploadLastTime=0,this.streamGoogInfo={},this.closeSessionSignal=!1,this.stateNego=r.ENUM_PLAY_STATE_NEGO.stop,this.negoInterval=25e3,this.broadcasterStatus=r.ENUM_BROADCASTER_STATUS.stop,this.cameraStatus=null,this.micStatus=null,this.playEvent=!1,this.gotStreamStatus=!1,this.ac=null,this.soundLevel=0,this.mic=null,this.script=null,this.logger=t,this.signal=e,this.dataReport=i,this.qualityTimeInterval=n,this.streamCenter=a,i.newReport(this.reportSeq)}return t.prototype.setAudioDestination=function(t){var e=this;return this.remoteVideo?"undefined"!==this.remoteVideo.sinkId?(this.remoteVideo.setSinkId(t).then(function(){e.logger.info("zp.sad.1 success device: "+t)}).catch(function(t){e.logger.info("zp.sad.1 "+t.name)}),!0):(this.logger.error("zp.sad.1 browser does not suppport"),!1):(this.logger.info("zp.sad.1 no remoteVideo"),!1)},t.prototype.startPlay=function(t,e,i,n){var a=this;if(this.logger.info("zp.sp.1 called ",t),this.playEvent=!1,this.signal&&this.signal.negoInterval&&(this.negoInterval=this.signal.negoInterval),t){if(this.peerConnection&&this.stateNego==r.ENUM_PLAY_STATE_NEGO.iceConnected)return this.logger.info("zp.sp.1 ice connected"),this.signal.addSession(this.sessionId,this.sessionToken),void this.onPlayStateUpdate(o.ENUM_PLAY_STATE_UPDATE.start,this.streamId,null,!0);this.streamId=t,this.remoteVideo=e,this.audioOutput=i,this.playOption=n||{},n&&n.videoDecodeType&&(this.playOption.videoDecodeType=n.videoDecodeType),this.sessionSeq=o.getSeq(),this.dataReport.eventStart(this.reportSeq,"CreateSession");var l=t;1==this.streamCenter.testEnvironment&&(l="zegotest-"+this.streamCenter.appid+"-"+t),this.signal.createSession(this.sessionSeq,1,0,l,n&&n.streamParams,function(t,e,i){a.dataReport.eventEndWithMsg(a.reportSeq,"CreateSession",{sessionId:i.session_id}),a.logger.info("zp.sp.1 sessionId:"+i.session_id),a.sessionSeq==t?0!==i.result?(a.logger.error("zp.sp.1 create error"),a.playStateUpdateError(o.playErrorList.CREATE_SESSION_ERROR)):(a.sessionId=i.session_id,a.sessionToken=i.session_token,a.onCreatePlaySessionSuccess(i)):a.logger.error("zp.sp.1 seq is not match.")},function(t,e){a.dataReport.eventEndWithMsg(a.reportSeq,"CreateSession",{error:t}),a.playStateUpdateError(o.playErrorList.SEND_SESSION_TIMEOUT)}),this.state=r.ENUM_PLAY_STATE.waitingSessionRsp,this.logger.debug("zp.sp.1 called success"),this.stateNego=r.ENUM_PLAY_STATE_NEGO.start,this.negoTimer=setTimeout(function(){a.logger.error("zp.sp.1 waiting timeout"),a.playStateUpdateError(o.playErrorList.SERVER_NEGO_TIMEOUT)},this.negoInterval)}else this.logger.warn("zp.sp.1 streamId is null")},t.prototype.onCreatePlaySessionSuccess=function(t){var e=this;this.logger.info("zp.ops.1 success");var i=[];t.turn_server&&i.push(t.turn_server),t.stun_server&&i.push(t.stun_server);var n={iceTransportPolicy:"relay",iceServers:[{urls:i,username:t.turn_username,credential:t.turn_auth_key}]};this.logger.info("zp.ops.1 username: "+t.turn_username),this.logger.info("zp.ops.1 credential: "+t.turn_auth_key),this.peerConnection=new RTCPeerConnection(n),this.peerConnection.onicecandidate=function(t){e.onIceCandidate(t)},this.peerConnection.onsignalingstatechange=function(t){e.onConnectionStateChange(t)},this.peerConnection.oniceconnectionstatechange=function(t){e.onIceConnectionStateChange(t)},this.peerConnection.ontrack=function(t){e.onGotRemoteStream(t.streams[0])},this.remoteVideo.oncanplay=function(){e.logger.debug("zp.ops.1 "+e.remoteVideo.videoWidth+" X "+e.remoteVideo.videoHeight),e.videoSizeCallback||(e.logger.debug("zp.ops.1 onresize callback"),e.onVideoSizeChanged(e.streamId,e.remoteVideo.videoWidth,e.remoteVideo.videoHeight),e.videoSizeCallback=!0)};var r={offerToReceiveAudio:1,offerToReceiveVideo:1};this.playOption&&"audio"===this.playOption.playType&&(r.offerToReceiveVideo=0),this.playOption&&"video"===this.playOption.playType&&(r.offerToReceiveAudio=0),this.logger.info("zp.ops.1 createOffer: "+JSON.stringify(r)),this.dataReport.eventStart(this.reportSeq,"CreateOffer"),this.peerConnection.createOffer(r).then(function(t){e.dataReport.eventEnd(e.reportSeq,"CreateOffer"),e.onCreateOfferSuccess(t)},function(t){e.dataReport.eventEndWithMsg(e.reportSeq,"CreateOffer",{error:t.toString()}),e.logger.error("zp.ops.0 create offer error "+t.toString()),e.playStateUpdateError(o.playErrorList.CREATE_OFFER_ERROR,!0)}),this.signal.registerPushCallback("MediaDescPush",this.sessionId,function(t,i,n){e.onRecvMediaDesc(t,i,n)}),this.signal.registerPushCallback("CandidateInfoPush",this.sessionId,function(t,i,n){e.onRecvCandidateInfo(t,i,n)}),this.signal.registerPushCallback("CloseSessionPush",this.sessionId,function(t,i,n){e.onRecvCloseSession(t,i,n)}),this.signal.registerPushCallback("SessionResetPush",this.sessionId,function(t,i,n){e.onRecvResetSession(t,i,n)}),this.signal.registerPushCallback("StreamStatusNotifyPush",this.sessionId,function(t,i,n){e.gotStreamStatus=!0,e.streamStatus=n,e.remoteStream&&e.onRecvStreamStatus(n)}),this.signal.registerPushCallback("PlayEventPush",this.sessionId,function(t,i,n){e.onRecvPlayEvent(t,i,n)}),this.logger.debug("zp.ops.1 call success")},t.prototype.onCreateOfferSuccess=function(t){var e=this;this.logger.info("zp.oco.1 localSdp1 "+t.sdp.substr(0,t.sdp.length/2)),this.logger.info("zp.oco.1 localSdp2 "+t.sdp.substr(t.sdp.length/2)),t.sdp=t.sdp.replace(/sendrecv/g,"recvonly"),t.sdp=t.sdp.replace(/useinbandfec=/,"stereo=1;useinbandfec="),this.playOption.videoDecodeType&&(t.sdp=a.sdpUtil.getSDPByVideDecodeType(t.sdp,this.playOption.videoDecodeType)),this.dataReport.eventStart(this.reportSeq,"SetLocalDescription"),this.peerConnection.setLocalDescription(t).then(function(){e.dataReport.eventEnd(e.reportSeq,"SetLocalDescription"),e.onSetLocalDescriptionSuccess(t)},function(t){e.logger.error("zp.oca.1 set error "+t.toString()),e.dataReport.eventEnd(e.reportSeq,"SetLocalDescription",{error:t.toString()}),e.playStateUpdateError(o.playErrorList.SET_LOCAL_DESC_ERROR,!0)})},t.prototype.onSetLocalDescriptionSuccess=function(t){var e=this;this.logger.info("zp.osd.1 success");var i={sdp:t.sdp};this.answerSeq=o.getSeq(),this.dataReport.eventStart(this.reportSeq,"SendMediaDesc"),this.signal.sendMediaDesc(this.answerSeq,this.sessionId,0,i,function(t,i,n){e.logger.info("zp.osd.1 sendMediaDesc resp"),e.answerSeq==t&&e.sessionId==i?(e.logger.info("zp.osd.1 send success stateNego:waiterAnswer"),e.stateNego=r.ENUM_PLAY_STATE_NEGO.waiterAnswer,e.dataReport.eventEnd(e.reportSeq,"SendMediaDesc"),e.waitingOfferTimer=setTimeout(function(){e.state==r.ENUM_PLAY_STATE.waitingOffserRsp&&(e.logger.error("zp.osd.1 waiting timeout"),e.playStateUpdateError(o.playErrorList.SERVER_CANDIDATE_TIMEOUT))},e.waitingOfferTimeInterval),e.state=r.ENUM_PLAY_STATE.waitingServerAnswer):e.logger.error("zp.osd.1 seq or sessionId is not equal "+e.answerSeq+" "+t,0+e.sessionId+" "+i)},function(t,i){e.logger.error("zp.osd.1 failed to send "+t),e.dataReport.eventEndWithMsg(e.reportSeq,"SendMediaDesc",{error:t}),e.playStateUpdateError(o.playErrorList.SEND_MEDIA_DESC_TIMEOUT)}),this.state=r.ENUM_PLAY_STATE.waitingOffserRsp},t.prototype.onRecvMediaDesc=function(t,e,i){var n=this;if(this.logger.info("zp.orm.1 received ",i),this.stateNego=r.ENUM_PLAY_STATE_NEGO.waitingCandidate,this.logger.info("zp.orm.1 received stateNego:waitingCandidate"),this.state===r.ENUM_PLAY_STATE.waitingServerAnswer){null!=this.waitingOfferTimer&&(clearTimeout(this.waitingOfferTimer),this.waitingOfferTimer=null),this.dataReport.addEvent(this.reportSeq,"RecvMediaDesc"),this.signal.sendMediaDescAck(t,this.sessionId,0);var a={type:"answer",sdp:i.sdp,toJSON:function(){}};this.dataReport.eventStart(this.reportSeq,"SetRemoteDescription"),this.logger.info("zp.orm.1 remoteSdp ",a.sdp),this.peerConnection.setRemoteDescription(new RTCSessionDescription(a)).then(function(){n.dataReport.eventEnd(n.reportSeq,"SetRemoteDescription"),n.logger.info("zp.orm.1 set success")},function(t){n.logger.error("zp.orm.1 set remote error "+t.toString()),n.dataReport.eventEndWithMsg(n.reportSeq,"SetRemoteDescription",{error:t.toString()}),n.playStateUpdateError(o.playErrorList.SET_REMOTE_DESC_ERROR,!0)}),this.waitICETimer=setTimeout(function(){n.state==r.ENUM_PLAY_STATE.waitingServerICE&&(n.logger.error("zp.orm.1 waiting server timeout"),n.playStateUpdateError(o.playErrorList.SERVER_CANDIDATE_TIMEOUT))},this.waitingICETimeInterval),this.state=r.ENUM_PLAY_STATE.waitingServerICE,this.logger.debug("zp.orm.1 call success")}else this.logger.error("zp.orm.1 current state "+this.state+" not allowed")},t.prototype.onRecvCandidateInfo=function(t,e,i){var n=this;if(this.logger.info("zp.orci.1 received "),this.state==r.ENUM_PLAY_STATE.waitingServerICE){null!=this.waitICETimer&&(clearTimeout(this.waitICETimer),this.waitICETimer=null),this.dataReport.addEvent(this.reportSeq,"RecvIceCandidate"),this.signal.sendCandidateInfoAck(t,this.sessionId,0),this.sendCandidateInfo(this.candidateInfo),this.candidateInfo=[];for(var a=0;a<i.infos.length;a++){var l={sdpMid:i.infos[a].sdpMid,sdpMLineIndex:i.infos[a].sdpMLineIndex,candidate:i.infos[a].candidate};this.logger.debug("zp.orci.1 candidate "+l.candidate),this.peerConnection.addIceCandidate(new RTCIceCandidate(l)).then(function(){n.logger.debug("zp.orci.1 add success")},function(t){n.logger.error("zp.orci.1 add error "+t.toString()),n.playStateUpdateError(o.playErrorList.SERVER_CANDIDATE_ERROR,!0)})}this.state=r.ENUM_PLAY_STATE.connecting,this.logger.debug("zp.orci.1 call success")}else this.logger.warn("zp.orci.1 current state "+this.state+" not allowed")},t.prototype.onRecvPlayEvent=function(t,e,i){if(this.logger.info("zp.orpe.1 received"),!0===this.playEvent&&0==i.event){this.logger.info("zp.orpe.1 retry: "+this.streamId);var n=this.streamId,r=this.remoteVideo,a=this.audioOutput,l=this.playOption;this.signal.sendCloseSession(o.getSeq(),this.sessionId,1),this.resetPlay(),this.startPlay(n,r,a,l)}else this.playEvent=!0},t.prototype.onIceCandidate=function(t){if(this.logger.info("zp.oic.1 called"),null!=t.candidate)if(this.logger.debug("zp.oic.1 candidate "+t.candidate.candidate),this.state<r.ENUM_PLAY_STATE.connecting||this.state==r.ENUM_PLAY_STATE.stop)this.logger.debug("zp.oic.1 cached"),this.candidateInfo.push({candidate:t.candidate.candidate,sdpMid:t.candidate.sdpMid,sdpMLineIndex:t.candidate.sdpMLineIndex});else{this.logger.debug("zp.oic.1 send");var e={candidate:t.candidate.candidate,sdpMid:t.candidate.sdpMid,sdpMLineIndex:t.candidate.sdpMLineIndex};this.sendCandidateInfo([e])}},t.prototype.onConnectionStateChange=function(t){this.logger.info("zp.oisc.1 called "+t.target.signalingState)},t.prototype.onIceConnectionStateChange=function(t){if(this.state!=r.ENUM_PLAY_STATE.stop&&null!=this.peerConnection)if(this.logger.info("zp.oisc.1  stateChanged "+this.peerConnection.iceConnectionState),"connected"===this.peerConnection.iceConnectionState){for(var e in this.dataReport.addEvent(this.reportSeq,"IceConnected"),this.state!=r.ENUM_PLAY_STATE.playing&&this.onPlayStateUpdate(o.ENUM_PLAY_STATE_UPDATE.start,this.streamId,null,!0),this.state=r.ENUM_PLAY_STATE.playing,this.dataReport.eventStart(this.reportSeq,"PlayState"),this.streamCenter.publisherList){if(this.streamCenter.publisherList[e].publisher.state==r.ENUM_PUBLISH_STATE.publishing&&this.broadcasterStatus==r.ENUM_BROADCASTER_STATUS.stop){this.signal&&this.signal.sendBroadcasterStatus(o.getSeq(),this.sessionId,1),this.broadcasterStatus=r.ENUM_BROADCASTER_STATUS.start;break}}this.setPlayQualityTimer(),this.stateNego=r.ENUM_PLAY_STATE_NEGO.iceConnected,this.logger.info("zp.oisc.1  stateNego:iceConnected"),this.negoTimer&&clearTimeout(this.negoTimer)}else"closed"===this.peerConnection.iceConnectionState?(this.dataReport.addEvent(this.reportSeq,"IceClosed"),this.stateNego=r.ENUM_PLAY_STATE_NEGO.iceClosed,this.checkPlayConnectionFailedState(this.peerConnection.iceConnectionState)):"failed"===this.peerConnection.iceConnectionState?(this.dataReport.addEvent(this.reportSeq,"IceFailed"),this.stateNego=r.ENUM_PLAY_STATE_NEGO.iceFailed,this.checkPlayConnectionFailedState(this.peerConnection.iceConnectionState)):"disconnected"===this.peerConnection.iceConnectionState&&(this.dataReport.addEvent(this.reportSeq,"IceDisconnected"),this.stateNego=r.ENUM_PLAY_STATE_NEGO.iceDisconnected,this.checkPlayConnectionFailedState(this.peerConnection.iceConnectionState))},t.prototype.checkPlayConnectionFailedState=function(t){var e=null;"failed"==t?e=o.playErrorList.MEDIA_CONNECTION_FAILED:"closed"==t?e=o.playErrorList.MEDIA_CONNECTION_CLOSED:"disconnected"==t&&(e=o.playErrorList.MEDIA_CONNECTION_DISCONNECTED),null!=e&&(this.logger.info("zp.oics.1  state "+this.state+" connectionState "+t),this.playStateUpdateError(e))},t.prototype.clearPlayQualityTimer=function(){null!=this.qualityTimer&&(clearInterval(this.qualityTimer),this.qualityTimer=null),this.lastPlayStats={audioPacketsLost:0,videoPacketsLost:0,time:0,audioTime:0,videoTime:0,audioBytesReceived:0,videoBytesReceived:0,framesDecoded:0,framesDropped:0,framesReceived:0,audioBitrate:0,audioPacketsReceived:0}},t.prototype.resetPlay=function(){this.logger.info("zp.rp.1 call"),this.streamId=null,this.state=r.ENUM_PLAY_STATE.stop,this.playEvent=!1,null!=this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null),null!=this.waitingOfferTimer&&(clearTimeout(this.waitingOfferTimer),this.waitingOfferTimer=null),null!=this.waitICETimer&&(clearTimeout(this.waitICETimer),this.waitICETimer=null),null!=this.negoTimer&&(clearTimeout(this.negoTimer),this.negoTimer=null),this.clearPlayQualityTimer(),this.remoteVideo&&(this.remoteVideo.srcObject=null,this.remoteVideo.oncanplay=null,this.remoteVideo=null),this.audioOputput=null,this.signal&&(this.signal.unregisterPushCallback("MediaDescPush",this.sessionId),this.signal.unregisterPushCallback("CandidateInfoPush",this.sessionId),this.signal.unregisterPushCallback("CloseSessionPush",this.sessionId)),this.sessionSeq=0,this.answerSeq=0,this.videoSizeCallback=!1,this.script&&this.script.disconnect(),this.mic&&this.mic.disconnect()},t.prototype.setPlayQualityTimer=function(){var t=this;if(null==this.qualityTimer){this.logger.debug("zp.spq.1 startTimer"),this.clearPlayQualityTimer();var e=!0;this.peerConnection.getStats(function(){}).catch(function(i){t.logger.info("zp.spq.1 "+t.streamId+" getStats callback not support"),e=!1}),this.qualityTimer=setInterval(function(){t.peerConnectionGetStats(e)},this.qualityTimeInterval),this.lastPlayStats={audioPacketsLost:0,videoPacketsLost:0,time:0,audioTime:0,videoTime:0,audioBytesReceived:0,videoBytesReceived:0,framesDecoded:0,framesReceived:0,framesDropped:0,audioBitrate:0,audioPacketsReceived:0}}},t.prototype.peerConnectionGetStats=function(t){var e=this;this.peerConnection&&(t&&this.peerConnection.getStats(function(t){e.getOldGoogStats(t)},function(t){e.logger.info("zp.spq.1 getOldGoogStats error "+t.toString())}),this.peerConnection.getStats(null).then(function(t){e.getPlayStats(t)},function(t){e.logger.info("zp.spq.1 getStats error "+t.toString())}))},t.prototype.getOldGoogStats=function(t){var e=this;t&&t.result().forEach(function(t){var i=["audioOutputLevel","googCpuLimitedResolution","googBandwidthLimitedResolution","googCodecName","googActualEncBitrate","googFrameWidthInput","googFrameHeightInput","googFrameRateInput","codecImplementationName"];if("VideoBwe"===t.type&&t.names().includes("googAvailableSendBandwidth")&&(e.streamGoogInfo.googAvailableSendBandwidth=t.stat("googAvailableReceiveBandwidth")||""),"ssrc"===t.type)for(var n=0;n<i.length;n++){var r=i[n];t.names().includes(r)&&(e.streamGoogInfo[r]=t.stat(r)||"")}})},t.prototype.getPlayStats=function(t){var e=this;if(null!=t){var i=n({audioFractionLost:null,audioPacketsLost:0,audioPacketsLostRate:0,audioBitrate:0,audioLevel:0,audioSendLevel:0,audioSamplingRate:0,audioFPS:0,audioCodecType:"opus",audioQuality:null,videoQuality:null,videoPacketsLostRate:0,videoBitrate:0,videoFPS:0,playData:0,nackCount:0,pliCount:0,audioJitter:0,videoFractionLost:null,videoFramesDecoded:0,frameHeight:0,frameWidth:0,videoTransferFPS:0,videoFramesDropped:0,totalRoundTripTime:0,currentRoundTripTime:0,muted:!this.remoteVideo||this.remoteVideo.muted,paused:!this.remoteVideo||this.remoteVideo.paused,volume:this.remoteVideo?this.remoteVideo.volume:0,audioDeviceLabel:"",videoDeviceLbabel:""},this.streamGoogInfo);if(this.remoteVideo){var r=this.remoteVideo.srcObject;i.audioDeviceLabel=r.getAudioTracks().length>0?r.getAudioTracks()[0].label:"",i.videoDeviceLbabel=r.getVideoTracks().length>0?r.getVideoTracks()[0].label:""}var o=this.lastPlayStats.time,a=null;t.forEach(function(t){("inbound-rtp"==t.type||"ssrc"==t.type&&null!=t.bytesReceived)&&("audio"==t.mediaType||t.id.indexOf("AudioStream")>=0)?(0!=o&&(i.audioBitrate=8*(t.bytesReceived-e.lastPlayStats.audioBytesReceived)/(t.timestamp-o),i.audioFPS=(t.packetsReceived-e.lastPlayStats.audioPacketsReceived)/(t.timestamp-o)*1e3),i.audioBitrate<0&&(i.audioBitrate=0),i.audioJitter=t.jitter,i.audioPacketsLost=t.packetsLost,i.audioFractionLost=t.fractionLost,i.audioPacketsLostRate=(t.packetsLost-e.lastPlayStats.audioPacketsLost)/(t.timestamp-e.lastPlayStats.audioTime),e.lastPlayStats.audioBytesReceived=t.bytesReceived,e.lastPlayStats.audioPacketsLost=t.packetsLost,e.lastPlayStats.audioTime=t.timestamp,e.lastPlayStats.time=t.timestamp,e.lastPlayStats.audioBitrate=i.audioBitrate,e.lastPlayStats.audioPacketsReceived=t.packetsReceived):("inbound-rtp"==t.type||"ssrc"==t.type&&null!=t.bytesReceived)&&("video"==t.mediaType||t.id.indexOf("VideoStream")>=0)?(0!=o&&(i.videoBitrate=8*(t.bytesReceived-e.lastPlayStats.videoBytesReceived)/(t.timestamp-o),i.videoFPS=1e3*(t.framesDecoded-e.lastPlayStats.framesDecoded)/(t.timestamp-o)),i.videoBitrate<0&&(i.videoBitrate=0),i.videoFPS<0&&(i.videoFPS=0),i.nackCount=t.nackCount,i.pliCount=t.pliCount,i.videoFractionLost=t.fractionLost,i.videoFramesDecoded=t.framesDecoded,i.videoPacketsLostRate=(t.packetsLost-e.lastPlayStats.videoPacketsLost)/(t.timestamp-e.lastPlayStats.videoTime),e.lastPlayStats.videoBytesReceived=t.bytesReceived,e.lastPlayStats.framesDecoded=t.framesDecoded,e.lastPlayStats.videoPacketsLost=t.packetsLost,e.lastPlayStats.videoTime=t.timestamp,e.lastPlayStats.time=t.timestamp):"track"==t.type&&("video"==t.kind||t.id.indexOf("video")>=0)||t.frameWidth?(i.frameHeight=t.frameHeight,i.frameWidth=t.frameWidth,0!=o&&(i.videoTransferFPS=1e3*(t.framesReceived-e.lastPlayStats.framesReceived)/(t.timestamp-o),i.videoFramesDropped=t.framesDropped-e.lastPlayStats.framesDropped),i.videoTransferFPS<0&&(i.videoTransferFPS=0),i.videoFramesDropped<0&&(i.videoFramesDropped=0),e.lastPlayStats.framesReceived=t.framesReceived,e.lastPlayStats.framesDropped=t.framesDropped):"track"==t.type&&("audio"==t.kind||t.id.indexOf("audio")>=0)?(i.audioLevel=t.audioLevel,i.audioSendLevel=t.totalAudioEnergy,i.audioSamplingRate=t.totalSamplesDuration):"candidate-pair"==t.type&&(null!=t.totalRoundTripTime&&(i.totalRoundTripTime=t.totalRoundTripTime),null!=t.currentRoundTripTime&&(i.currentRoundTripTime=t.currentRoundTripTime,a=1e3*i.currentRoundTripTime))}),i.audioQuality=this.getNetQuality(a,i.audioFractionLost),i.videoQuality=this.getNetQuality(a,i.videoFractionLost),this.uploadPlayQuality(i),0!=o&&this.onPlayQualityUpdate(this.streamId,i)}},t.prototype.getNetQuality=function(t,e){return t&&t<600?e>.4?2:e>.3?4:5:t<900?e>.4?2:e>.2?3:4:e>.2?2:3},t.prototype.uploadPlayQuality=function(t){var e=this;if(this.qualityUpload){var i=Date.parse(new Date+"");(0==this.qualityUploadLastTime||i-this.qualityUploadLastTime>=this.qualityUploadInterval)&&(t.stream_type="play",t.stream_id=this.streamId,t.timeStamp=i/1e3,this.logger.info("zp.upq.1 upload"+JSON.stringify(t)),this.signal.QualityReport(o.getSeq(),this.sessionId,t,function(t,i,n){void 0!==n.report&&(e.qualityUpload=n.report,e.qualityUploadInterval=n.report_interval_ms)},function(t,i){e.logger.info("zp.upq.1 upload failed "+t)}),this.qualityUploadLastTime=i)}},t.prototype.onRecvResetSession=function(t,e,i){if(this.logger.info("zp.orrs.1 received "),e==this.sessionId){this.dataReport.addEvent(this.reportSeq,"RecvResetSession"),this.signal.sendCloseSessionAck(t,this.sessionId,0);var n=JSON.parse(JSON.stringify(o.playErrorList.SESSION_CLOSED));this.negoTimer&&clearTimeout(this.negoTimer),this.playStateUpdateError(n)}else this.logger.info("zp.orrs.1 cannot find session")},t.prototype.onRecvCloseSession=function(t,e,i){this.logger.info("zp.orcs.1 reason: "+i.reason),this.dataReport.addEvent(this.reportSeq,"RecvCloseSession"),this.signal.sendCloseSessionAck(t,this.sessionId,0);var n=JSON.parse(JSON.stringify(o.playErrorList.SESSION_CLOSED));n.msg+=" reason:"+i.reason+(i.err_info&&JSON.parse(i.err_info).action?"action:"+JSON.parse(i.err_info).action:""),this.negoTimer&&clearTimeout(this.negoTimer);var r=1*i.reason,a=i.err_info&&JSON.parse(i.err_info).action?JSON.parse(i.err_info).action:null,l=![4,8,10,11,12,14,24,26,27,28].includes(r)&&5!=a&&2!=a;this.playStateUpdateError(n,l)},t.prototype.onRecvStreamStatus=function(t){if(this.logger.debug("zp.orss.0 call"),this.logger.info("zp.orss.0 stream "+this.streamId+" status camera_status: "+t.camera_status+" mic_status: "+t.mic_status),this.cameraStatus!==t.camera_status&&this.onRemoteCameraStatusUpdate(this.streamId,t.camera_status),this.micStatus!==t.mic_status&&this.onRemoteMicStatusUpdate(this.streamId,t.mic_status),this.cameraStatus=t.camera_status,this.micStatus=t.mic_status,-1===["all","video","audio"].indexOf(this.playOption.playType)){var e=this.remoteVideo.srcObject;0!==t.camera_status&&e&&0!==e.getVideoTracks().length&&(e.getVideoTracks().forEach(function(t){t.stop(),e.removeTrack(t)}),this.remoteVideo.srcObject=e),0==t.camera_status&&e&&0==e.getVideoTracks().length&&(this.remoteVideo.srcObject=this.remoteStream.clone()),this.logger.debug("zp.orss.0 call success")}else this.logger.info("zp.orss.0 has set playType, ignore stream status")},t.prototype.onGotRemoteStream=function(t){this.logger.info("zp.ogrs.0 called "+t),this.remoteVideo?(this.remoteStream=t,this.remoteVideo.srcObject=t.clone(),this.audioOputput&&this.setAudioDestination(this.audioOputput),this.gotStreamStatus&&this.onRecvStreamStatus(this.streamStatus),this.streamCenter.soundLevelDelegate&&this.startSoundLevel(),this.dataReport.addEvent(this.reportSeq,"GetRemoteStream")):this.logger.error("zp.ogrs.0 no remoteVideo")},t.prototype.sendCandidateInfo=function(t){var e=this;this.logger.info("zp.sci.1 called"),!(t=t.filter(function(t){return!(t.candidate.indexOf("tcp")>0)&&(!!t.candidate||void 0)}))||t.length<1?this.logger.info("zp.sci.1 cancelled"):(this.dataReport.eventStart(this.reportSeq,"SendIceCandidate"),this.stateNego!==r.ENUM_PLAY_STATE_NEGO.iceConnected&&(this.stateNego=r.ENUM_PLAY_STATE_NEGO.sendCandidate),this.logger.info("zp.sci.1  stateNego:sendCandidate"),this.signal.sendCandidateInfo(o.getSeq(),this.sessionId,t,function(t,i,n){e.logger.debug("zp.sci.1 send success"),e.dataReport.eventEnd(e.reportSeq,"SendIceCandidate")},function(t,i){e.logger.error("zp.sci.1 failed to send: "+t.toString()),e.dataReport.eventEndWithMsg(e.reportSeq,"SendIceCandidate",{error:t}),e.playStateUpdateError(o.playErrorList.SEND_CANDIDATE_ERROR)}))},t.prototype.shouldSendCloseSession=function(t){return this.state!=o.ENUM_PLAY_STATE_UPDATE.stop&&this.state!=r.ENUM_PLAY_STATE.waitingSessionRsp},t.prototype.playStateUpdateError=function(t,e){this.logger.info("zp.psue.1 called ",this.streamId,JSON.stringify(t)),this.streamId&&this.onPlayStateUpdate(o.ENUM_PLAY_STATE_UPDATE.error,this.streamId,t,e),this.logger.info("zp.psue.1 ended")},t.prototype.onPlayStateUpdate=function(t,e,i,n){},t.prototype.onPlayQualityUpdate=function(t,e){},t.prototype.onVideoSizeChanged=function(t,e,i){},t.prototype.onRemoteCameraStatusUpdate=function(t,e){},t.prototype.onRemoteMicStatusUpdate=function(t,e){},t.prototype.stopPlay=function(){for(var t in this.logger.info("zp.sp.1.1 called"),this.streamCenter.publisherList){if(this.streamCenter.publisherList[t].publisher.state==r.ENUM_PUBLISH_STATE.publishing&&this.broadcasterStatus==r.ENUM_BROADCASTER_STATUS.start){this.signal&&this.signal.sendBroadcasterStatus(o.getSeq(),this.sessionId,0),this.broadcasterStatus=r.ENUM_BROADCASTER_STATUS.stop;break}}this.sessionId&&!this.closeSessionSignal&&this.signal.sendCloseSession(o.getSeq(),this.sessionId,0),this.dataReport.eventEndWithMsg(this.reportSeq,"PlayState",{state:this.state+""}),this.dataReport.addEvent(this.reportSeq,"StopPlay"),this.dataReport.addMsgExt(this.reportSeq,{stream:this.streamId,sessionId:this.sessionId}),this.dataReport.uploadReport(this.reportSeq,"RTCPlayStream"),this.resetPlay()},t.prototype.onDisconnect=function(){this.logger.info("zp.od.1 call"),this.logger.info("zp.od.1 websocket disconnect"),this.dataReport.addEvent(this.reportSeq,"OnDisconnect"),this.playStateUpdateError(o.playErrorList.WEBSOCKET_ERROR)},t.prototype.startSoundLevel=function(){var t=this;if(this.logger.info("zp.ssl.1 call streamID: "+this.streamId),this.remoteStream&&0!=this.remoteStream.getAudioTracks().length){this.script&&this.script.disconnect()&&(this.script=null),this.mic&&this.mic.disconnect()&&(this.mic=null),this.ac&&this.ac.close()&&(this.ac=null);try{this.ac=new("undefined"!=typeof webkitAudioContext?webkitAudioContext:AudioContext),this.mic=this.ac.createMediaStreamSource(this.remoteVideo.srcObject),this.script=this.ac.createScriptProcessor(4096,1,1),this.mic.connect(this.script),this.script.connect(this.ac.destination),this.script.onaudioprocess=function(e){for(var i=e.inputBuffer.getChannelData(0),n=0,r=0;r<i.length;r++)n<i[r]&&(n=i[r]);t.soundLevel=100*n}}catch(t){this.logger.error("zp.ssl.1 get sound level failed "+t)}}else this.logger.info("zp.ssl.1 remote stream no found")},t.prototype.stopSoundLevel=function(){this.logger.info("zp.ssl.1.1 call streamID: "+this.streamId),this.script&&this.script.disconnect(),this.mic&&this.mic.disconnect(),this.ac&&this.ac.close(),this.script=null,this.mic=null,this.ac=null},t}();e.ZegoPlayWeb=l},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e){this.playerList={},this.publisherList={}}return t.prototype.setSessionInfo=function(t,e,i,n){},t}();e.ZegoStreamCenter=n},function(t,e,i){"use strict";var n,r=this&&this.__extends||(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])},function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});Object.defineProperty(e,"__esModule",{value:!0});var o=i(3),a=i(0),l=i(1),s=function(t){function e(e,i){var n=t.call(this,e,i)||this;return n.logger=e,n.stateCenter=i,n}return r(e,t),e.prototype.initStream=function(t,e,i,n){this.streamCenter=t,this.isPublish=e,this.streamID=i,this.serverUrls=n},e.prototype.active=function(t){var e=this;if(this.logger.info("zc.tsh.a retry call "+this.streamID),this.stateCenter.networkState==a.ENUM_NETWORK_STATE.offline)return this.logger.info("zc.tsh.a network is broken, stop retry"),!1;if(this.retryTimer)return this.logger.info("zc.tsh.a has actived, ignore"),!1;if(this.isOverTime)return this.logger.warn("zc.tsh.a retry over time, stop retry"),!1;if(1==this.retryActiveCount)this.retryActiveInterval=Math.floor(Math.random()*(1-this.RETRY_START_TIME_INTERVAL)+this.RETRY_START_TIME_INTERVAL);else{var i=Math.pow(2,Math.round(this.retryActiveCount/this.RETRY_CONTINUE_COUNT+1));this.retryActiveInterval=i>this.RETRY_MAX_TIME_INTERVAL?this.RETRY_MAX_TIME_INTERVAL:i}var n,r=this.serverUrls;if(this.isPublish){var o=this.streamCenter.publisherList[this.streamID].publisher;n=o.signal?o.signal.server:""}else{var l=this.streamCenter.playerList[this.streamID].player;n=l.signal?l.signal.server:""}r.forEach(function(t,i){return i<=r.indexOf(n)&&e.serverUrls.push(t)}),r.splice(0,r.indexOf(n)+1);var s=this.serverUrls[this.retryActiveCount%this.serverUrls.length==0?this.serverUrls.length-1:this.retryActiveCount%this.serverUrls.length-1];return this.retryTimer=setTimeout(function(){console.warn("stream "+e.streamID+" retry connect signal server "+s),e.retryTimer&&clearTimeout(e.retryTimer),e.retryTimer=null,e.retryActiveCount++,e.isPublish?e.streamCenter.connectPublishServer(e.streamID,s):e.streamCenter.connectPlayServer(e.streamID,s)},"number"==typeof t?t:1e3*this.retryActiveInterval),this.logger.info("zc.tsh.a call success"),!0},e.prototype.startMaxTime=function(){var t=this;this.maxTimer||(this.maxTimer=setTimeout(function(){if(console.warn(t.streamID+" over max time "+t.RETRY_MAX_TIME+"s, stop retry"),t.isOverTime=!0,t.invalid(),t.isPublish){var e=t.streamCenter.publisherList[t.streamID];if(!e)return void t.logger.info("zc.tsh.smt streamID "+t.streamID+" publish no found");e.publisher.onPublishStateUpdate(l.ENUM_PUBLISH_STATE_UPDATE.error,t.streamID,l.publishErrorList.RETRY_TIMEOUT,!0)}else{var i=t.streamCenter.playerList[t.streamID];if(!i)return void t.logger.info("zc.tsh.smt streamID "+t.streamID+" play no found");i.player.onPlayStateUpdate(l.ENUM_PLAY_STATE_UPDATE.error,t.streamID,l.playErrorList.RETRY_TIMEOUT,!0)}},1e3*this.RETRY_MAX_TIME))},e.prototype.stopMaxTime=function(){this.maxTimer&&clearTimeout(this.maxTimer),this.maxTimer=null},e.prototype.onactive=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e]},e.prototype.retryNextSignal=function(t){if(t.code==l.publishErrorList.SESSION_CLOSED.code||t.code==l.playErrorList.SESSION_CLOSED.code){var e=t.msg.match(/reason:(\d+)/)[1];return this.isPublish?!["26"].includes(e):!["24","26","28"].includes(e)}return!0},e}(o.TryHandler);e.TryStreamHandler=s},function(t,e,i){"use strict";var n,r=this&&this.__extends||(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])},function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});Object.defineProperty(e,"__esModule",{value:!0});var o=i(3),a=i(0),l=function(t){function e(e,i,n,r){var o=t.call(this,e,i)||this;return o.retryActiveCount=1,o.RETRY_MAX_TIME=90,o.logger=e,o.stateCenter=i,o.socketCenter=n,o.streamCenter=r,o}return r(e,t),e.prototype.initStream=function(t,e,i){this.streamID=t,this.playOption=e,this.isPublish=i},e.prototype.active=function(t){var e=this;if(this.logger.info("zc.tdh.a retry call "+this.streamID),this.stateCenter.networkState==a.ENUM_NETWORK_STATE.offline)return this.logger.info("zc.tdh.a network is broken, stop retry"),!1;if(this.retryTimer)return this.logger.info("zc.tdh.a has actived, ignore"),!1;if(this.isOverTime)return this.logger.warn("zc.tdh.a retry over time, stop retry"),!1;var i=this.retryActiveCount-1,n={stream_id:this.streamID,ptype:this.isPublish?"push":"pull",signals:this.streamCenter.getAllInUseUrl(),header_kvs:[{key:"grpc-metadata-push",value:this.playOption&&this.playOption.cdnUrl||""}],retry:i};return this.retryTimer=setTimeout(function(){var t=e.socketCenter.sendMessage("webrtc_url",n,void 0,function(t){t===a.sdkErrorList.SEND_MSG_TIMEOUT&&(e.stopMaxTime(),e.invalid(),e.onactive(void 0,t))});e.isPublish?e.streamCenter.publisherList[e.streamID]&&(e.streamCenter.publisherList[e.streamID].seq=t):e.streamCenter.playerList[e.streamID]&&(e.streamCenter.playerList[e.streamID].seq=t),e.retryTimer&&clearTimeout(e.retryTimer),e.retryTimer=null,e.retryActiveCount++},"number"==typeof t?t:1e3*this.retryActiveInterval),this.logger.info("zc.tdh.a call success"),!0},e.prototype.startMaxTime=function(){var t=this;this.maxTimer||(this.maxTimer=setTimeout(function(){console.warn(t.streamID+" disaptch over max time "+t.RETRY_MAX_TIME+"s, stop retry"),t.isOverTime=!0,t.invalid(),t.onactive(void 0,a.sdkErrorList.SEND_MSG_TIMEOUT)},1e3*this.RETRY_MAX_TIME))},e.prototype.stopMaxTime=function(){this.maxTimer&&clearTimeout(this.maxTimer),this.maxTimer=null},e.prototype.onactive=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e]},e}(o.TryHandler);e.TryDispatchHandler=l},function(t,e,i){"use strict";var n,r=this&&this.__extends||(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])},function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});Object.defineProperty(e,"__esModule",{value:!0});var o=i(20),a=i(0),l=i(2),s=i(21),p=i(22),h=i(23),u=i(24),c=i(25),f=i(26),v=i(27),T=i(1),d=function(t){function e(){return t.call(this)||this}return r(e,t),e.prototype.init=function(){this.bindSocketHandler(),this.bindStreamHandler(),this.bindHeatBeatHandler(),this.bindRoomHandler(),this.bindMessageHandler(),this.bindLiveHandler(),this.bindStreamCenterHandler()},e.prototype.bindSocketHandler=function(){var t=this;this.socketCenter=new s.SocketCenter(this.logger,this.stateCenter),this.socketCenter.registerRouter("push_signal",function(e){t.liveHandler.handlePushSignalMsg(e)}),this.socketCenter.getSocket=function(e){return t.getSocket(e)},this.socketCenter.handlePushKickout=function(e){t.logger.info("zb.cm.bsh.0 call "+e);var i=t.stateCenter.roomTryHandler;i.onactive=function(e,i){i&&t.onKickOut(i)},e.body.need_relogin&&1==e.body.need_relogin?(t.stateCenter.sessionid="",i.startMaxTime(),i.active()):(t.roomHandler.resetRoom(),t.onKickOut({code:a.sdkErrorList.KICK_OUT.code,msg:a.sdkErrorList.KICK_OUT.msg+e.body.reason})),t.logger.info("zb.cm.bsh.0 end")},this.socketCenter.handlePushCustomMsg=function(e){t.messageHandler.handlePushCustomMsg(e)},this.socketCenter.handlePushUserStateUpdateMsg=function(e){t.roomHandler.handlePushUserStateUpdateMsg(e)},this.socketCenter.handlePushRoomMsg=function(e){t.onRecvRoomMsg(e.body.chat_data,e.body.server_msg_id,e.body.ret_msg_id)},this.socketCenter.handlePushMergeMsg=function(e){t.messageHandler.handlePushMergeMsg(e)},this.socketCenter.handlePushTransMsg=function(e){t.messageHandler.handlePushTransMsg(e)},this.socketCenter.handleBigImMsgRsp=function(e){t.messageHandler.handleBigImMsgRsp(e)}},e.prototype.bindStreamHandler=function(){var t=this;this.streamHandler=new h.StreamHandler(this.logger,this.stateCenter,this.socketCenter,this.streamCenter),this.streamHandler.onStreamUpdated=function(e,i){t.onStreamUpdated(e,i)},this.streamHandler.onPublishStateUpdate=function(e,i,n){t.onPublishStateUpdate(e,i,n)},this.streamHandler.onStreamExtraInfoUpdated=function(e){t.onStreamExtraInfoUpdated(e)},this.streamHandler.setCDNInfo=function(e,i){t.setCDNInfo(e,i)}},e.prototype.bindHeatBeatHandler=function(){var t=this;this.heartBeatHandler=new u.HeartBeatHandler(this.logger,this.stateCenter,this.socketCenter),this.heartBeatHandler.onRecvReliableMessage=function(e,i,n){t.onRecvReliableMessage(e,i,n)},this.heartBeatHandler.handleFetchStreamListRsp=function(e){t.streamHandler.handleFetchStreamListRsp(e)},this.heartBeatHandler.fetchUserList=function(){t.roomHandler.fetchUserList()},this.heartBeatHandler.onUpdateOnlineCount=function(e,i){t.onUpdateOnlineCount(e,i)},this.heartBeatHandler.updateStreamInfo=function(e,i,n,r){void 0===n&&(n=""),t.streamHandler.updateStreamInfo(e,i,n,r)},this.heartBeatHandler.hbLogout=function(e){t.logger.info("zc.hl.0 call "+e);var i=t.stateCenter.roomTryHandler;i.onactive=function(e,i){t.disconnectedHandle(i)},e==a.sdkErrorList.HEARTBEAT_TIMEOUT||e.msg.endsWith("1000002001")||e.msg.endsWith("1000000152")?(i.startMaxTime(),i.active()):(i.stopMaxTime(),i.invalid(),t.roomHandler.resetRoom(),t.disconnectedHandle(e)),t.logger.info("zc.hl.0 end")}},e.prototype.bindRoomHandler=function(){var t=this;this.roomHandler=new p.RoomHandler(this.logger,this.stateCenter,this.socketCenter),this.roomHandler.loginSuccessCallBack=function(e,i){var n=i.body.hearbeat_interval<a.MINIUM_HEARTBEAT_INTERVAL?a.MINIUM_HEARTBEAT_INTERVAL:i.body.hearbeat_interval;t.stateCenter.tryHeartbeatCount=0,t.stateCenter.heartbeatTimer&&clearTimeout(t.stateCenter.heartbeatTimer),t.heartBeatHandler.start(n),t.heartBeatHandler.resetCheckMessage(),t.heartBeatHandler.startCheckMessageTimeout(),t.streamCenter.setSessionInfo(t.stateCenter.appid,t.stateCenter.idName,t.stateCenter.token,t.stateCenter.testEnvironment),i.body.anchor_info&&t.onGetAnchorInfo(i.body.anchor_info.anchor_id_name,i.body.anchor_info.anchor_nick_name),i.body.online_count&&t.onUpdateOnlineCount(t.stateCenter.roomid,i.body.online_count),t.logger.info("zb.cm.brh hls userStateUpdate "+t.stateCenter.userStateUpdate),t.stateCenter.userStateUpdate&&(t.logger.info("zb.cm.brh hls fetch all new userlist"),t.roomHandler.fetchUserList()),t.stateCenter.isResetRoom=!1,t.streamHandler.handleStreamStart(e,i)},this.roomHandler.onGetTotalUserList=function(e,i){t.onGetTotalUserList(e,i)},this.roomHandler.resetRoomCallBack=function(){t.heartBeatHandler.resetHeartbeat(),t.heartBeatHandler.resetCheckMessage(),t.resetStreamCenter()},this.roomHandler.onUserStateUpdate=function(e,i){t.onUserStateUpdate(e,i)},this.roomHandler.onDisconnect=function(e){t.logger.info("zc.od.0 call "+e),t.stateCenter.roomTryHandler.onactive=function(e,i){t.disconnectedHandle(i)},t.stateCenter.roomTryHandler.startMaxTime(),t.stateCenter.roomTryHandler.active(),t.logger.info("zc.od.0 end")},this.roomHandler.loginBodyData=function(){return t.loginBodyData()}},e.prototype.bindMessageHandler=function(){var t=this;this.messageHandler=new c.MessageHandler(this.logger,this.stateCenter,this.socketCenter),this.messageHandler.onRecvCustomCommand=function(e,i,n){t.onRecvCustomCommand(e,i,n)},this.messageHandler.onRecvBigRoomMessage=function(e,i){t.onRecvBigRoomMessage(e,i)},this.messageHandler.onRecvReliableMessage=function(e,i,n){t.onRecvReliableMessage(e,i,n)}},e.prototype.bindLiveHandler=function(){var t=this;this.liveHandler=new f.LiveHandler(this.logger,this.stateCenter,this.socketCenter),this.liveHandler.onRecvEndJoinLiveCommand=function(e,i,n,r){t.onRecvEndJoinLiveCommand(e,i,n,r)},this.liveHandler.onRecvInviteJoinLiveRequest=function(e,i,n,r){t.onRecvInviteJoinLiveRequest(e,i,n,r)},this.liveHandler.onRecvJoinLiveRequest=function(e,i,n,r){t.onRecvJoinLiveRequest(e,i,n,r)}},e.prototype.bindStreamCenterHandler=function(){var t=this;this.streamCenter.onPlayStateUpdate=function(e,i,n){t.onPlayStateUpdateHandle(e,i,n)},this.streamCenter.onPlayQualityUpdate=function(e,i){t.onPlayQualityUpdate(e,i)},this.streamCenter.onPublishStateUpdate=function(e,i,n){t.onPublishStateUpdateHandle(e,i,n)},this.streamCenter.onPublishQualityUpdate=function(e,i){t.onPublishQualityUpdate(e,i)},this.streamCenter.onPlayerStreamUrlUpdate=function(e,i,n){t.onStreamUrlUpdate(e,i,n)},this.streamCenter.onVideoSizeChanged=function(e,i,n){t.onVideoSizeChanged(e,i,n)},this.streamCenter.onRemoteCameraStatusUpdate=function(e,i){t.onRemoteCameraStatusUpdate(e,i)},this.streamCenter.onRemoteMicStatusUpdate=function(e,i){t.onRemoteMicStatusUpdate(e,i)},this.streamCenter.onSoundLevelUpdate=function(e){t.onSoundLevelUpdate(e)},this.streamCenter.onDeviceError=function(e){t.onDeviceError(e)},this.streamCenter.OnAudioDeviceStateChanged=function(e){t.OnAudioDeviceStateChanged(e)},this.streamCenter.OnVideoDeviceStateChanged=function(e){t.OnVideoDeviceStateChanged(e)}},e.prototype.config=function(t){return this.logger.debug("zb.cm.cf call"),l.ClientUtil.checkConfigParam(t,this.logger)?(this.stateCenter.appid=t.appid,"string"==typeof t.server?(this.stateCenter.server=t.server,this.stateCenter.serverBak=t.server):Array.isArray(t.server)&&t.server.length>0&&(this.stateCenter.server=t.server[0],this.stateCenter.serverBak=t.server[1]||t.server[0]),this.logger.info("zb.cm.cf server "+JSON.stringify(t.server)),this.stateCenter.idName=t.idName,this.stateCenter.nickName=t.nickName,this.logger.setLogLevel(t.logLevel),!1===t.audienceCreateRoom&&(this.stateCenter.roomCreateFlag=0),t.remoteLogLevel?this.logger.setRemoteLogLevel(t.remoteLogLevel):this.logger.setRemoteLogLevel(0),this.logger.setSessionInfo(t.appid,"","",t.idName,"",a.PROTO_VERSION),t.logUrl?this.logger.openLogServer(t.logUrl):this.logger.openLogServer("wss://weblogger-demo.zego.im/log"),-1==this.stateCenter.server.indexOf("test2-wsliveroom-api.zego.im")&&-1==this.stateCenter.server.indexOf("wsliveroom-test.zegocloud.com")&&-1==this.stateCenter.server.indexOf("wsliveroom-test.zego.im")||(this.stateCenter.testEnvironment=!0),"number"==typeof t.maxRetryTime&&t.maxRetryTime<3600&&(this.stateCenter.roomRetryTime=this.stateCenter.streamRetryTime=t.maxRetryTime),this.stateCenter.configOK=!0,navigator&&navigator.appVersion&&this.logger.info("zb.cm.cf "+navigator.appVersion),this.stateCenter.networkState=navigator?navigator.onLine?a.ENUM_NETWORK_STATE.online:a.ENUM_NETWORK_STATE.offline:a.ENUM_NETWORK_STATE.online,this.logger.debug("zb.cm.cf call success"),!0):(this.logger.error("zb.cm.cf param error"),!1)},e.prototype.login=function(t,e,i,n,r){var o=this;return this.logger.info("zb.rh.lg call"),this.stateCenter.loginSeq=T.getSeq(),this.dataReport.newReport(this.stateCenter.loginSeq),"string"!=typeof t?(this.logger.error("zb.rh.lg roomid  type error"),void this.dataReport.uploadReport(this.stateCenter.loginSeq,"/sdk/login","ZegoClient.Error.Param")):"string"!=typeof i?(this.logger.error("zb.rh.lg token type error"),void this.dataReport.uploadReport(this.stateCenter.loginSeq,"/sdk/login","ZegoClient.Error.Param")):void(1===e||2===e?(this.stateCenter.runState!==a.ENUM_RUN_STATE.logout&&this.roomHandler.resetRoom(),this.stateCenter.roomTryHandler||(this.stateCenter.roomTryHandler=new v.RetryRoomHandler(this.logger,this.stateCenter)),this.stateCenter.roomTryHandler.init(this.stateCenter.roomRetryTime),this.stateCenter.roomTryHandler.initRoom(this.roomHandler,this.stateCenter.server,this.stateCenter.serverBak,t,e,i,null),this.stateCenter.roomTryHandler.onactive=function(t,e){t?(o.dataReport.uploadReport(o.stateCenter.loginSeq,"/sdk/login"),n&&n(t)):(o.dataReport.uploadReport(o.stateCenter.loginSeq,"/sdk/login",e.msg),r&&r(e))},this.stateCenter.roomTryHandler.active(!0)):this.logger.error("zb.rh.lg role error"))},e.prototype.loginWithAuthor=function(t,e,i,n,r,o){"string"!=typeof t||"string"!=typeof i||"string"!=typeof n||1!==e&&2!==e?this.logger.error("zb.rh.lg params error"):this.roomHandler.login(this.stateCenter.server,t,e,i,n,r,o)},e.prototype.logout=function(){return this.logger.info("zc.lg.0 call"),this.roomHandler.logout()},e.prototype.setUserStateUpdate=function(t){"boolean"==typeof t?this.roomHandler.setUserStateUpdate(t):console.error("setUserStateUpdate param error")},e.prototype.onUserStateUpdate=function(t,e){},e.prototype.onGetTotalUserList=function(t,e){},e.prototype.onUpdateOnlineCount=function(t,e){},e.prototype.onGetAnchorInfo=function(t,e){},e.prototype.release=function(){this.logger.debug("zb.cm.rl call"),this.roomHandler.resetRoom(),this.logger.stopLogServer(),this.logger.debug("zb.cm.rl call success")},e.prototype.sendCustomCommand=function(t,e,i,n){return"string"!=typeof e&&"object"!=typeof e?(this.logger.error("zb.mh.scc params error"),!1):this.messageHandler.sendCustomCommand(t,e,i,n)},e.prototype.onRecvCustomCommand=function(t,e,i){},e.prototype.sendRoomMsg=function(t,e,i,n,r){return 1!==t&&2!==t?(this.logger.error("zb.srm category must be number 1 or 2"),void r(a.sdkErrorList.PARAM)):1!==t&&2!==t&&3!==t?(this.logger.error("zb.srm type must be number 1 or 2 or 3"),void r(a.sdkErrorList.PARAM)):"string"!=typeof i?(this.logger.error("zb.srm msg content must be string"),void r(a.sdkErrorList.PARAM)):void this.messageHandler.sendRoomMsg(t,e,i,n,r)},e.prototype.onRecvRoomMsg=function(t,e,i){},e.prototype.sendReliableMessage=function(t,e,i,n){this.messageHandler.sendReliableMessage(t,e,i,n)},e.prototype.onRecvReliableMessage=function(t,e,i){},e.prototype.sendBigRoomMessage=function(t,e,i,n,r){this.messageHandler.sendBigRoomMessage(t,e,i,n,r)},e.prototype.onRecvBigRoomMessage=function(t,e){},e.prototype.sendRelayMessage=function(t,e,i,n){this.messageHandler.sendRelayMessage(t,e,i,n)},e.prototype.requestJoinLive=function(t,e,i,n){return this.liveHandler.requestJoinLive(t,e,i,n)},e.prototype.onRecvJoinLiveRequest=function(t,e,i,n){},e.prototype.inviteJoinLive=function(t,e,i,n){return this.liveHandler.inviteJoinLive(t,e,i,n)},e.prototype.onRecvInviteJoinLiveRequest=function(t,e,i,n){},e.prototype.endJoinLive=function(t,e,i){return this.liveHandler.endJoinLive(t,e,i)},e.prototype.onRecvEndJoinLiveCommand=function(t,e,i,n){},e.prototype.respondJoinLive=function(t,e,i,n){return this.liveHandler.respondJoinLive(t,e,i,n)},e.prototype.updateMixStream=function(t,e,i){return this.streamHandler.updateMixStream(t,e,i)},e.prototype.stopMixStream=function(t,e,i){return this.streamHandler.stopMixStream(t,e,i)},e.prototype.publishTarget=function(t,e,i){return this.streamHandler.publishTarget(t,e,i)},e.prototype.updateStreamExtraInfo=function(t,e){return this.streamHandler.updateStreamExtraInfo(t,e)},e.prototype.onStreamUrlUpdate=function(t,e,i){},e.prototype.onStreamUpdated=function(t,e){},e.prototype.onStreamExtraInfoUpdated=function(t){},e.prototype.onPlayStateUpdate=function(t,e,i){},e.prototype.onVideoSizeChanged=function(t,e,i){},e.prototype.onRemoteCameraStatusUpdate=function(t,e){},e.prototype.onRemoteMicStatusUpdate=function(t,e){},e.prototype.onPlayQualityUpdate=function(t,e){},e.prototype.onPublishStateUpdate=function(t,e,i){},e.prototype.onPublishQualityUpdate=function(t,e){},e.prototype.onSoundLevelUpdate=function(t){},e.prototype.onDeviceError=function(t){},e.prototype.OnAudioDeviceStateChanged=function(t){},e.prototype.OnVideoDeviceStateChanged=function(t){},e.prototype.onDisconnect=function(t){},e.prototype.onKickOut=function(t){},e.prototype.onTempBroken=function(){},e.prototype.onReconnect=function(){},e.prototype.disconnectedHandle=function(t){t?this.onDisconnect(a.sdkErrorList.LOGIN_DISCONNECT):this.onReconnect()},e.getCurrentVersion=function(){return a.PROTO_VERSION},e}(o.Common);e.BaseCenter=d},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=i(0),r=i(1),o=function(){function t(){}return t.prototype.onPlayStateUpdateHandle=function(t,e,i){this.onPlayStateUpdate(t,e,i)},t.prototype.onPublishStateUpdateHandle=function(t,e,i){0==t?this.stateCenter.publishStreamList[e]&&(this.stateCenter.publishStreamList[e].state!=n.ENUM_PUBLISH_STREAM_STATE.tryPublish||this.stateCenter.streamList.find(function(t){return t.stream_id==e})?(this.stateCenter.publishStreamList[e].state=n.ENUM_PUBLISH_STREAM_STATE.publishing,this.WebrtcOnPublishStateUpdateHandle(t,e,i)):(this.stateCenter.publishStreamList[e].state=n.ENUM_PUBLISH_STREAM_STATE.update_info,this.streamHandler.updateStreamInfo(e,n.ENUM_STREAM_SUB_CMD.liveBegin,this.stateCenter.publishStreamList[e].extra_info))):this.onPublishStateUpdate(t,e,i)},t.prototype.resetStreamCenter=function(){if(this.stateCenter.customUrl&&(this.stateCenter.customUrl=null),this.streamCenter.reset(),!this.socketCenter.isDisConnect())for(var t in this.stateCenter.publishStreamList)if(this.stateCenter.publishStreamList[t].state==n.ENUM_PUBLISH_STREAM_STATE.publishing){this.streamHandler.updateStreamInfo(t,n.ENUM_STREAM_SUB_CMD.liveEnd,this.stateCenter.publishStreamList[t].extra_info);for(var e=0;e<this.stateCenter.streamList.length;e++)if(this.stateCenter.streamList[e].stream_id==t){this.stateCenter.streamList.splice(e--,1);break}}},t.prototype.handleFetchWebRtcUrlRsp=function(t){var e=t.body.stream_id,i=!1;if(t.body.urls&&Array.isArray(t.body.urls)&&t.body.urls.length>0?i=!0:this.logger.error("cb.cm.hfwur signal url is empty"),"push"===t.body.ptype&&this.streamCenter.publisherList[e]){var n=this.streamCenter.publisherList[e].tryDispatchHandler;if(0!==t.body.err_code&&void 0!==t.body.need_action&&2==t.body.need_action)return n.retryActiveInterval=t.body.action_delay/1e3||Math.floor(3*Math.random())+3,void n.active();if(0!==t.body.err_code&&1!==t.body.need_action)return n.retryActiveInterval=Math.floor(3*Math.random())+3,void n.active();if(n.stopMaxTime(),n.invalid(),t.header.seq!==this.streamCenter.publisherList[e].seq)return void this.logger.info("cb.cm.hfwur seq is not match, ignore "+e);if(!i)return this.dataReport.uploadReport(this.streamCenter.publisherList[e].reportSeq,"/sdk/publish",r.publishErrorList.DISPATCH_ERROR.code),this.streamHandler.onPublishStateUpdate(1,e,r.publishErrorList.DISPATCH_ERROR),void this.stopPublishingStream(e);this.stateCenter.publishStreamList[e]?this.streamCenter.startPublishingStream(e,t.body.urls):this.logger.error("cb.cm.hfwur no streamid to publish")}else if("pull"==t.body.ptype&&this.streamCenter.playerList[e]){n=this.streamCenter.playerList[e].tryDispatchHandler;if(0!==t.body.err_code&&void 0!==t.body.need_action&&2==t.body.need_action)return n.retryActiveInterval=t.body.action_delay/1e3||Math.floor(3*Math.random())+3,void n.active();if(0!==t.body.err_code&&1!==t.body.need_action)return n.retryActiveInterval=Math.floor(3*Math.random())+3,void n.active();if(n.stopMaxTime(),n.invalid(),t.header.seq!==this.streamCenter.playerList[e].seq)return void this.logger.info("cb.cm.hfwur seq is not match, ignore "+e);if(!i)return this.dataReport.uploadReport(this.streamCenter.playerList[e].reportSeq,"/sdk/play",r.playErrorList.DISPATCH_ERROR.code),this.streamCenter.onPlayStateUpdate(1,e,r.playErrorList.DISPATCH_ERROR),void this.stopPlayingStream(e);for(var o=!1,a=0;a<this.stateCenter.streamList.length;a++)if(this.stateCenter.streamList[a].stream_id===e){o=!0;break}0==o&&this.logger.warn("cb.cm.hfwur cannot find stream, continue to play"),this.streamCenter.startPlayingStream(e,t.body.urls)}},t}();e.Common=o},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=i(0),r=i(2),o=function(){function t(t,e){var i=this;this.cmdSeq=0,this.responseRouters={},this.logger=t,this.stateCenter=e,this.responseRouters={push_kickout:function(t){i.handlePushKickout(t)},push_custommsg:function(t){i.handlePushCustomMsg(t)},push_im_chat:function(t){i.handlePushRoomMsg(t)},push_userlist_update:function(t){i.handlePushUserStateUpdateMsg(t)},push_merge_message:function(t){i.handlePushMergeMsg(t)},trans:function(t){i.handleTransRsp(t)},push_trans:function(t){i.handlePushTransMsg(t)}}}return t.prototype.handlePushKickout=function(t){},t.prototype.handlePushCustomMsg=function(t){},t.prototype.handlePushRoomMsg=function(t){},t.prototype.handlePushUserStateUpdateMsg=function(t){},t.prototype.handlePushMergeMsg=function(t){},t.prototype.handlePushTransMsg=function(t){},t.prototype.handleBigImMsgRsp=function(t){},t.prototype.handleTransRsp=function(t){if(this.stateCenter.isLogin())if(0==t.body.err_code){var e=t.body.trans_type;this.stateCenter.transSeqMap[e]?(this.stateCenter.transSeqMap[e].seq=t.body.trans_seq,this.logger.debug("zb.sc.htr trans "+e+" seq "+t.body.trans_seq)):this.logger.error("zb.sc.htr cannot match send info")}else this.logger.error("zb.sc.htr trans send error "+t.body.err_code);else this.logger.error("zb.sc.htr not login")},t.prototype.handleBizChannelRspCallback=function(t,e){0===t.body.err_code?null!=e.success&&e.success(t.header.seq,t.body.cmd,t.body.rsp_body):null!=e.error&&e.error(t.body.err_code,t.header.seq,t.body.rsp_body)},t.prototype.registerRouter=function(t,e){this.responseRouters[t]=e},t.prototype.getSocket=function(t){return null},t.prototype.getHeaderV2=function(t){return{Protocol:"req_v2",cmd:t,appid:this.stateCenter.appid,seq:++this.cmdSeq,user_id:this.stateCenter.userid,session_id:this.stateCenter.sessionid||"",room_id:this.stateCenter.roomid||""}},t.prototype.getHeader=function(t){return{Protocol:"req",cmd:t,appid:this.stateCenter.appid,seq:++this.cmdSeq,user_id:this.stateCenter.userid,session_id:this.stateCenter.sessionid||"",room_id:this.stateCenter.roomid||""}},t.prototype.sendMessage=function(t,e,i,r){if(this.logger.info("zb.sc.sm call "+t+" "+e),this.isDisConnect())return this.logger.error("zb.sc.sm error  "+t+" websocket is disconnected"),-1;var o="V1"===n.ROOMVERSION?this.getHeader(t):this.getHeaderV2(t),a={header:o,body:e};if(null==i&&(i=null),null==r&&(r=null),null!=i||null!=r){var l={data:a,seq:o.seq,deleted:!1,time:Date.parse(new Date+""),success:i,error:r},s=this.stateCenter.sendCommandList.push(l);this.stateCenter.sendCommandMap[l.seq]=s}return this.websocket.send(JSON.stringify(a)),this.logger.info("zb.sc.sm success"),o.seq},t.prototype.sendCustomMessage=function(t,e,i,r){if(this.logger.debug("zb.sc.scm call"),this.isDisConnect())return this.logger.error("zb.sc.scm error"),!1;var o="V1"===n.ROOMVERSION?this.getHeader(t):this.getHeaderV2(t),a={header:o,body:e},l=JSON.stringify(a);null==i&&(i=null),null==r&&(r=null);var s={data:a,seq:o.seq,deleted:!1,time:Date.parse(new Date+""),success:i,error:r},p=this.stateCenter.sendDataList.push(s);return this.stateCenter.sendDataMap[s.seq]=p,this.websocket.send(l),this.logger.debug("zb.sc.scm success seq: ",o.seq),!0},t.prototype.isDisConnect=function(){return!this.websocket||1!==this.websocket.readyState},t.prototype.closeSocket=function(){this.websocket&&(this.logger.info("zb.sc.cs close websocket"),this.websocket.onclose=null,this.websocket.onerror=null,this.websocket.close(),this.websocket=null)},t.prototype.createSocket=function(t){this.websocket=this.getSocket(t)},t.prototype.openHandler=function(t){this.websocket.onopen=t},t.prototype.closeHandler=function(t){this.websocket.onclose=t},t.prototype.errorHandler=function(t){this.websocket.onerror=t},t.prototype.checkResponse=function(t){return(t.header.appid!==this.stateCenter.appid||t.header.session_id!==this.stateCenter.sessionid||t.header.user_id!==this.stateCenter.userid||t.header.room_id!==this.stateCenter.roomid||this.stateCenter.runState!==n.ENUM_RUN_STATE.login)&&(this.logger.error("zb.sc.crp check session fail."),!0)},t.prototype.responseHandler=function(){var t=this;this.websocket.onmessage=function(e){var i=JSON.parse(e.data);t.logger.info("zb.sc.ws.rph jsonmsg= ",i.header.cmd),t.logger.info("zb.sc.ws.rph jsonmsg= ",e.data),0!==i.body.err_code&&i.body.err_message&&t.logger.error("zb.sc.ws.rph cmd="+i.header.cmd+", err_code="+i.body.err_code+", err_message="+i.body.err_message+" "),"login"!==i.header.cmd?"logout"!==i.header.cmd?t.stateCenter.isLogin()?t.checkResponse(i)?t.logger.error("zb.sc.ws.rph check session fail."):(t.handleSendCommandMsgRsp(i),t.logger.info("zb.sc.ws.rph cmd="+i.header.cmd+",function="+!!t.responseRouters[i.header.cmd]),t.responseRouters[i.header.cmd]&&t.responseRouters[i.header.cmd](i)):t.logger.warn("zb.sc.ws.rph  already logout"):t.responseRouters.logout(i,t.cmdSeq):t.responseRouters.login(i,t.cmdSeq)}},t.prototype.handleSendCommandMsgRsp=function(t){this.logger.debug("zb.sc.hscmr call");var e,i=this.stateCenter.sendCommandMap[t.header.seq];null!=i&&(e=i._data,delete this.stateCenter.sendCommandMap[t.header.seq],this.stateCenter.sendCommandList.remove(i),"login"==e.data.header.cmd?this.logger.debug("zb.sc.hscmr don't check "+e.data.header.cmd):"relay"==e.data.header.cmd?this.handleRelayRspCallback(t,e):"bigim_chat"==e.data.header.cmd?this.handleBigImRspCallback(t,e):"biz_channel"==e.data.header.cmd?this.handleBizChannelRspCallback(t,e):0===t.body.err_code?null!=e.success&&e.success(t.header.seq):null!=e.error&&e.error(r.ClientUtil.getServerError(t.body.err_code),t.header.seq)),this.logger.debug("zb.sc.hscmr call success")},t.prototype.handleRelayRspCallback=function(t,e){0===t.body.err_code?null!=e.success&&e.success(t.header.seq,t.body.relay_result):null!=e.error&&e.error(r.ClientUtil.getServerError(t.body.err_code),t.header.seq)},t.prototype.handleBigImRspCallback=function(t,e){0===t.body.err_code?null!=e.success&&this.handleBigImMsgRsp(t):null!=e.error&&e.error(r.ClientUtil.getServerError(t.body.err_code),t.header.seq)},t}();e.SocketCenter=o},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=i(0),r=i(2),o=function(){function t(t,e,i){this.logger=t,this.socketCenter=i,this.stateCenter=e}return t.prototype.setRunState=function(t){this.logger.debug("zb.rh.srs old="+this.stateCenter.runState+", new="+t),this.stateCenter.lastRunState=this.stateCenter.runState,this.stateCenter.runState=t},t.prototype.resetTryLogin=function(){this.logger.debug("zb.rh.rtl call"),clearTimeout(this.stateCenter.tryLoginTimer),this.stateCenter.tryLoginTimer=null,this.logger.debug("zb.rh.rtl call success")},t.prototype.resetBigRoomInfo=function(){this.stateCenter.transSeqMap={},this.stateCenter.realyMessageList=[],this.stateCenter.relayTimer&&(clearTimeout(this.stateCenter.relayTimer),this.stateCenter.relayTimer=null),this.stateCenter.bigImLastTimeIndex=0,this.stateCenter.bigIMmessageList=[],this.stateCenter.bigImCallbackMap={},this.stateCenter.bigImTimer&&(clearTimeout(this.stateCenter.bigImTimer),this.stateCenter.bigImTimer=null),this.stateCenter.serverTimeOffset=0,this.stateCenter.datiTimeWindow=0,this.stateCenter.bigimTimeWindow=0},t.prototype.resetRoom=function(){var t=this;if(this.logger.debug("zb.rh.rr call"),this.stateCenter.isResetRoom=!0,this.resetTryLogin(),this.resetRoomCallBack(),this.stateCenter.roomTryHandler&&(this.stateCenter.roomTryHandler.invalid(),this.stateCenter.roomTryHandler.stopMaxTime(),this.stateCenter.roomTryHandler=null),this.stateCenter.streamList=[],this.stateCenter.streamQuerying=!1,this.stateCenter.publishStreamList={},this.stateCenter.joinLiveCallbackMap={},this.stateCenter.joinLiveRequestMap={},this.stateCenter.streamUrlMap={},this.resetBigRoomInfo(),this.stateCenter.cmdCallback={},this.logger.debug("zb.rh.rr call send logout=",this.stateCenter.sessionid),"0"!==this.stateCenter.sessionid&&this.stateCenter.runState!==n.ENUM_RUN_STATE.logout){this.socketCenter.registerRouter("logout",function(e){t.handleLogoutRsp(e)}),this.socketCenter.sendMessage("logout",{reserve:0})}this.socketCenter.closeSocket(),this.setRunState(n.ENUM_RUN_STATE.logout),this.stateCenter.userid="",this.stateCenter.sessionid="",this.stateCenter.userQuerying=!1,this.logger.setSessionInfo(this.stateCenter.appid,this.stateCenter.roomid,this.stateCenter.sessionid,this.stateCenter.idName,this.stateCenter.nickName,n.PROTO_VERSION),this.logger.debug("zb.rh.rr call success")},t.prototype.resetRoomCallBack=function(){},t.prototype.onDisconnect=function(t){},t.prototype.loginSuccessCallBack=function(t,e){},t.prototype.onGetTotalUserList=function(t,e){},t.prototype.login=function(t,e,i,o,a,l,s){if(this.logger.setSessionInfo(this.stateCenter.appid,e,"",this.stateCenter.idName,this.stateCenter.nickName,n.PROTO_VERSION),this.logger.info("zb.rh.lg call:",e,o),a&&(this.stateCenter.third_token=a),!this.stateCenter.configOK||!r.ClientUtil.checkLoginParam(e,o))return this.logger.error("zb.rh.lg param error"),void s({code:"ZegoClient.Error.Config",msg:"config error"});this.logger.debug("zb.rh.lg begin"),this.stateCenter.runState!==n.ENUM_RUN_STATE.trylogin&&this.setRunState(n.ENUM_RUN_STATE.trylogin),this.stateCenter.roomid=e,this.stateCenter.token=o,this.stateCenter.role=i,r.ClientUtil.registerCallback("login",{success:l,error:s},this.stateCenter.callbackList),this.resetTryLogin(),this.tryLogin(t),this.logger.info("zb.rh.lg call success")},t.prototype.loginBodyData=function(){return null},t.prototype.tryLogin=function(t){var e=this;if(this.logger.debug("zb.rh.tl call"),this.stateCenter.runState===n.ENUM_RUN_STATE.trylogin){if(this.stateCenter.startConnceTime=(new Date).getTime(),console.warn("start connect",this.stateCenter.startConnceTime),this.socketCenter.isDisConnect()){this.logger.debug("zb.rh.tl need new websocket");try{this.socketCenter.closeSocket(),this.logger.debug("zb.rh.tl new websocket"),this.socketCenter.createSocket(t),this.socketCenter.registerRouter("login",function(t,i){e.handleLoginRsp(t,i)}),this.socketCenter.closeHandler(function(t){e.socketCenter.closeSocket(),e.closeHandler(t)}),this.socketCenter.openHandler(function(){e.openHandler()}),this.socketCenter.errorHandler(function(t){e.logger.error("zb.rh.tl "+t),e.socketCenter.closeSocket(),e.closeHandler(t)})}catch(t){this.logger.error("zb.rh.tl websocket err:"+t)}}else{var i=this.loginBodyData();this.logger.info("zb.rh.tl use current websocket and sent login"),this.socketCenter.sendMessage("login",i)}this.stateCenter.tryLoginTimer=setTimeout(function(){e.logger.warn("zb.rh.tl over time no response, login timeout"),r.ClientUtil.actionErrorCallback("login",e.stateCenter.callbackList)(n.sdkErrorList.LOGIN_TIMEOUT)},this.stateCenter.tryLoginInterval),this.logger.info("zb.rh.tl call success")}else this.logger.error("zb.rh.tl state error")},t.prototype.handleLoginRsp=function(t,e){if(this.logger.debug("zb.rh.hlr call"),this.stateCenter.runState===n.ENUM_RUN_STATE.trylogin){if(t.header.seq===e)return 0!==t.body.err_code?(this.handleLoginFail(t),void this.logger.error("zb.rh.hlr server error=",t.body.err_code)):(this.handleLoginSuccess(t),void this.logger.info("zb.rh.hlr call success."));this.logger.error("zb.rh.hlr in wrong seq, local=",e,",recv=",t.header.seq)}else this.logger.error("zb.rh.hlr state error")},t.prototype.handleLoginFail=function(t){this.logger.debug("zb.rh.hlf call"),this.resetTryLogin();var e=r.ClientUtil.getServerError(t.body.err_code);r.ClientUtil.actionErrorCallback("login",this.stateCenter.callbackList)(e),this.logger.debug("zb.rh.hlf call success")},t.prototype.handleLoginSuccess=function(t){this.stateCenter.startloginSucTime=(new Date).getTime(),console.warn("login suc",this.stateCenter.startloginSucTime,this.stateCenter.startloginSucTime-this.stateCenter.startloginTime,this.stateCenter.startloginSucTime-this.stateCenter.startConnceTime),this.logger.info("zb.rh.hls call");var e=this.stateCenter.lastRunState;if(this.setRunState(n.ENUM_RUN_STATE.login),this.stateCenter.userid=t.body.user_id,this.stateCenter.sessionid=t.body.session_id,this.stateCenter.anchor_info=t.body.anchor_info||this.stateCenter.anchor_info,this.stateCenter.userListInterval=t.body.userlist_interval||this.stateCenter.userListInterval,this.stateCenter.userListMergeInterval=t.body.userlist_merge_timeout||this.stateCenter.userListMergeInterval,this.logger.setSessionInfo(this.stateCenter.appid,this.stateCenter.roomid,this.stateCenter.sessionid,this.stateCenter.idName,this.stateCenter.nickName,n.PROTO_VERSION),t.body.config_info&&(this.logger.setRemoteLogLevel(t.body.config_info.log_level),""!=t.body.config_info.log_url&&this.logger.openLogServer(t.body.config_info.log_url)),null!=t.body.ret_timestamp&&"string"==typeof t.body.ret_timestamp){var i=parseFloat(t.body.ret_timestamp);this.stateCenter.serverTimeOffset=0==i?0:t.body.ret_timestamp-(new Date).getTime()}t.body.bigim_time_window&&"number"==typeof t.body.bigim_time_window&&(this.stateCenter.bigimTimeWindow=t.body.bigim_time_window),t.body.dati_time_window&&"number"==typeof t.body.dati_time_window&&(this.stateCenter.datiTimeWindow=t.body.dati_time_window),t.body.cluster_env&&1===t.body.cluster_env&&(this.stateCenter.testEnvironment=!0),this.resetTryLogin(),this.loginSuccessCallBack(e,t)},t.prototype.openHandler=function(){this.logger.info("zb.rh.oh websocket.onpen call"),this.socketCenter.responseHandler();var t=this.loginBodyData();this.logger.info("zb.rh.oh websocket.onpen send login"),this.stateCenter.startloginTime=(new Date).getTime(),console.warn("start login",this.stateCenter.startloginTime,this.stateCenter.startloginTime-this.stateCenter.startConnceTime),this.socketCenter.sendMessage("login",t),this.logger.debug("zb.rh.oh websocket.onpen call success")},t.prototype.closeHandler=function(t){this.logger.error("zb.rh.ws.oc room websocket close "+JSON.stringify(t.code)),this.stateCenter.runState!==n.ENUM_RUN_STATE.logout?this.stateCenter.runState===n.ENUM_RUN_STATE.trylogin?(this.resetTryLogin(),r.ClientUtil.actionErrorCallback("login",this.stateCenter.callbackList)(1006==t.code?n.sdkErrorList.LOGIN_TIMEOUT:t)):this.stateCenter.runState===n.ENUM_RUN_STATE.login&&(this.logger.info("zb.rh.ws.oc is called because of network broken"),this.resetTryLogin(),this.onDisconnect(n.sdkErrorList.LOGIN_DISCONNECT)):this.logger.info("zb.rh.ws.oc onclose logout flow call websocket.close")},t.prototype.logout=function(){return this.logger.debug("zb.rh.lo call"),this.resetRoom(),this.logger.info("zb.rh.lo call success"),!0},t.prototype.setUserStateUpdate=function(t){return this.logger.debug("zb.rh.su call"),"boolean"!=typeof t?(this.logger.info("zb.rh.su param error"),!1):(this.stateCenter.userStateUpdate=t,this.logger.info("zb.rh.su call success "+t),!0)},t.prototype.fetchUserList=function(){this.logger.debug("zb.rh.ful call"),this.stateCenter.userQuerying?this.logger.warn("zb.rh.ful is already querying"):(this.stateCenter.userQuerying=!0,this.stateCenter.userTempList=[],"V1"===n.ROOMVERSION?this.fetchUserListWithPage(0):this.fetchUserListWithPageV2(0),this.logger.info("zb.rh.ful the first time call"))},t.prototype.fetchUserListWithPageV2=function(t){var e=this;this.logger.debug("zb.rh.fulwp call"),this.socketCenter.registerRouter("user_list_v2",function(i){e.handleFetchUserListRspV2(t,i)}),this.socketCenter.sendMessage("user_list_v2",{marker:0===t?"":t+"",mode:0,limit:100}),this.logger.info("zb.rh.fulwp call success")},t.prototype.fetchUserListWithPage=function(t){var e=this;this.logger.debug("zb.rh.fulwp call"),this.socketCenter.registerRouter("user_list",function(t){e.handleFetchUserListRsp(t)}),this.socketCenter.sendMessage("user_list",{user_index:t,sort_type:0}),this.logger.info("zb.rh.fulwp call success")},t.prototype.handleFetchUserListRspV2=function(t,e){if(this.logger.debug("zb.rh.hfulr call"),0!=e.body.err_code)return this.stateCenter.userQuerying=!1,this.stateCenter.lastUserQueryTime=Date.now()+this.stateCenter.userListInterval,void this.logger.info("zb.rh.hfulr fetch error "+e.body.err_code);if(this.stateCenter.userStateUpdate){if(this.stateCenter.userTempList=this.stateCenter.userTempList.concat(e.body.user_baseinfos),t!=e.body.marker)return this.logger.warn("zb.rh.hfulr fetch another page"),void this.fetchUserListWithPageV2(t+1);this.stateCenter.userSeq=e.body.server_user_seq,this.logger.info("zb.rh.hfulr set user Seq "+this.stateCenter.userSeq);for(var i=[],n=0;n<this.stateCenter.userTempList.length;n++){var r={idName:this.stateCenter.userTempList[n].id_name,nickName:this.stateCenter.userTempList[n].nick_name,role:this.stateCenter.userTempList[n].role};i.push(r)}this.stateCenter.userQuerying=!1,this.stateCenter.lastUserQueryTime=Date.now()+this.stateCenter.userListInterval,this.onGetTotalUserList(this.stateCenter.roomid,i),this.stateCenter.userTempList=[],this.logger.info("zb.rh.hfulr call success user_list "+i+" count "+i.length)}},t.prototype.handleFetchUserListRsp=function(t){if(this.logger.debug("zb.rh.hfulr call"),0!=t.body.err_code)return this.stateCenter.userQuerying=!1,this.stateCenter.lastUserQueryTime=Date.now()+this.stateCenter.userListInterval,void this.logger.info("zb.rh.hfulr fetch error "+t.body.err_code);if(this.stateCenter.userStateUpdate){this.stateCenter.userTempList=this.stateCenter.userTempList.concat(t.body.user_baseinfos);var e=t.body.ret_user_index;if(e!=t.body.server_user_index)return this.logger.warn("zb.rh.hfulr fetch another page"),void this.fetchUserListWithPage(e+1);this.stateCenter.userSeq=t.body.server_user_seq,this.logger.info("zb.rh.hfulr set user Seq "+this.stateCenter.userSeq);for(var i=[],n=0;n<this.stateCenter.userTempList.length;n++){var r={idName:this.stateCenter.userTempList[n].id_name,nickName:this.stateCenter.userTempList[n].nick_name,role:this.stateCenter.userTempList[n].role};i.push(r)}this.stateCenter.userQuerying=!1,this.stateCenter.lastUserQueryTime=Date.now()+this.stateCenter.userListInterval,this.onGetTotalUserList(this.stateCenter.roomid,i),this.stateCenter.userTempList=[],this.logger.info("zb.rh.hfulr call success user_list "+i+" count "+i.length)}},t.prototype.handleLogoutRsp=function(t){this.logger.debug("zb.rh.hlor result=",t.body.err_code)},t.prototype.handlePushUserStateUpdateMsg=function(t){if(this.logger.info("zb.rh.hpus call"),this.stateCenter.isLogin())if(this.stateCenter.userStateUpdate)if(this.stateCenter.userSeq+t.body.user_actions.length===t.body.user_list_seq){this.stateCenter.userSeq=t.body.user_list_seq,this.logger.debug("zb.rh.hpus push userSeq "+this.stateCenter.userSeq);for(var e=[],i=0;i<t.body.user_actions.length;i++){var n={action:t.body.user_actions[i].Action,idName:t.body.user_actions[i].IdName,nickName:t.body.user_actions[i].NickName,role:t.body.user_actions[i].Role,loginTime:t.body.user_actions[i].LoginTime};e.push(n)}this.onUserStateUpdate(t.body.room_id,e),this.logger.info("zb.rh.hpus call success")}else this.mergeUserByUserSeq(t.body.user_list_seq,t.body.user_actions);else this.logger.info("zb.rh.hpus no userStateUpdate flag");else this.logger.error("zb.rh.hpus not login")},t.prototype.onUserStateUpdate=function(t,e){},t.prototype.mergeUserByUserSeq=function(t,e){var i=this;this.stateCenter.userSeqMergeMap||(this.logger.warn("zb.rh.hpus new merge userlist "+this.stateCenter.userSeq+" server "+t),this.stateCenter.userSeqMergeMap={},this.stateCenter.userSeqMergeTimer&&clearTimeout(this.stateCenter.userSeqMergeTimer),this.stateCenter.userSeqMergeTimer=setTimeout(function(){var t=Object.keys(i.stateCenter.userSeqMergeMap).map(function(t){return+t}).sort(function(t,e){return t-e});if(t[t.length-1]-t[0]+1===t.length)i.mergeUser(t);else{i.stateCenter.userSeqMergeMap=null;var e=i.stateCenter.lastUserQueryTime-Date.now();i.logger.info("zb.rh.hpus fetch merge userlist "+i.stateCenter.userSeq+" userSeqList "+t.join(",")+" wait "+e),e>0?(i.stateCenter.userQueryTimer&&clearTimeout(i.stateCenter.userQueryTimer),i.stateCenter.userQueryTimer=setTimeout(function(){i.fetchUserList()},e)):i.fetchUserList()}},this.stateCenter.userListMergeInterval)),this.logger.warn("zb.rh.hpus merge userlist "+this.stateCenter.userSeq+" server "+t+" userlist "+e.length),this.stateCenter.userSeqMergeMap[t]=e},t.prototype.mergeUser=function(t){var e=this;this.logger.info("zb.rh.hpus merge userlist "+this.stateCenter.userSeq+" userSeqList "+t.join(",")),this.stateCenter.userSeq=t[t.length-1];var i={};t.forEach(function(t){e.stateCenter.userSeqMergeMap[t].forEach(function(t){i[t.IdName]=t})}),this.stateCenter.userSeqMergeMap=null;var n=Object.values(i).map(function(t){return{action:t.Action,idName:t.IdName,nickName:t.NickName,role:t.Role,loginTime:t.LoginTime?String(t.LoginTime):""}});n.sort(function(t,e){return t.loginTime.localeCompare(e.loginTime)}),this.onUserStateUpdate(this.stateCenter.roomid,n)},t}();e.RoomHandler=o},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=i(0),r=i(2),o=function(){function t(t,e,i,n){this.logger=t,this.socketCenter=i,this.stateCenter=e,this.streamCenter=n}return t.prototype.setCDNInfo=function(t,e){},t.prototype.onStreamUpdated=function(t,e){},t.prototype.onStreamExtraInfoUpdated=function(t){},t.prototype.handleStreamStart=function(t,e){var i=this;if(this.stateCenter.streamQuerying=!1,this.socketCenter.registerRouter("stream",function(t){i.handleStreamUpdateRsp(t)}),this.socketCenter.registerRouter("push_stream_update",function(t){i.handlePushStreamUpdateMsg(t)}),t==n.ENUM_RUN_STATE.login){this.logger.info("zb.sh.hss recover from disconnect so call streamupdate"),this.handleFullUpdateStream(e.body.stream_seq,e.body.stream_info||[]),this.handleReconnectStream(e.body.stream_info);var o=this.makeCallbackStreamList(this.stateCenter.streamList);r.ClientUtil.actionSuccessCallback("login",this.stateCenter.callbackList)(o)}else{this.logger.info("zb.sh.hss success callback user"),this.stateCenter.streamList=e.body.stream_info||[],this.stateCenter.streamSeq=e.body.stream_seq;for(var a=0;a<this.stateCenter.streamList.length;a++)this.stateCenter.streamList[a].anchor_id_name==this.stateCenter.idName&&(this.updateStreamInfo(this.stateCenter.streamList[a].stream_id,n.ENUM_STREAM_SUB_CMD.liveEnd),this.stateCenter.streamList.splice(a--,1));o=this.makeCallbackStreamList(this.stateCenter.streamList);r.ClientUtil.actionSuccessCallback("login",this.stateCenter.callbackList)(o)}},t.prototype.onPublishStateUpdate=function(t,e,i){},t.prototype.updateStreamInfo=function(t,e,i,r){var o=this;void 0===i&&(i=""),this.logger.debug("zb.sh.usi call");var a={stream_id:t,extra_info:i||""},l=JSON.stringify(a),s={sub_cmd:e,stream_msg:l};this.socketCenter.registerRouter("stream",function(t){o.handleStreamUpdateRsp(t)}),this.socketCenter.sendMessage("stream",s,void 0,function(a,l){o.stateCenter.isResetRoom||o.stateCenter.runState!==n.ENUM_RUN_STATE.login||a!=n.sdkErrorList.SEND_MSG_TIMEOUT?r&&r(a,l):2001==e&&o.stateCenter.publishStreamList[t]&&o.stateCenter.publishStreamList[t].state==n.ENUM_PUBLISH_STREAM_STATE.update_info||2002==e?setTimeout(function(){o.updateStreamInfo(t,e,i,r)},0):r&&r(a,l)}),this.logger.info("zb.sh.usi call success cmd "+e)},t.prototype.handleStreamUpdateRsp=function(t){if(this.stateCenter.isLogin())if(0==t.body.err_code){this.logger.info("zb.sh.hsur stream seq "+this.stateCenter.streamSeq+" server seq "+t.body.stream_seq),this.stateCenter.streamSeq=t.body.stream_seq;for(var e=function(e){var r=t.body.stream_info[e].stream_id;if(!i.stateCenter.publishStreamList[r])return i.logger.info("hsur.0 stream is not exist"),{value:void 0};i.stateCenter.publishStreamList[r].state==n.ENUM_PUBLISH_STREAM_STATE.update_info&&(i.stateCenter.publishStreamList[r].state=n.ENUM_PUBLISH_STREAM_STATE.publishing,i.stateCenter.streamList.find(function(t){return t.stream_id==r})||i.stateCenter.streamList.push(t.body.stream_info[e]),i.onPublishStateUpdate(0,r,0))},i=this,r=0;r<t.body.stream_info.length;r++){var o=e(r);if("object"==typeof o)return o.value}}else this.logger.error("zb.sh.hsur stream update error "+t.body.err_code);else this.logger.error("zb.sh.hsur not login")},t.prototype.handleFetchStreamListRsp=function(t){this.logger.info("zb.sh.hfslr call"),this.stateCenter.streamQuerying=!1,0===t.body.err_code?this.stateCenter.streamSeq!==t.body.stream_seq?(this.handleFullUpdateStream(t.body.stream_seq,t.body.stream_info),this.logger.debug("zb.sh.hfslr call success")):this.logger.info("zb.sh.hfslr same seq"):this.logger.info("zb.sh.hfslr server error=",t.body.err_code)},t.prototype.handleFullUpdateStream=function(t,e){var i=this;this.logger.debug("zb.sh.hfus call"),this.stateCenter.streamSeq=t,this.logger.debug("zb.sh.hfus server seq "+this.stateCenter.streamSeq),r.ClientUtil.mergeStreamList(this.logger,this.stateCenter.idName,this.stateCenter.streamList,e,function(t,e,r){0!==t.length&&(i.logger.debug("zb.sh.hfus callback addstream"),i.onStreamUpdated(n.ENUM_STREAM_UPDATE_TYPE.added,i.makeCallbackStreamList(t))),0!==e.length&&(i.logger.debug("zb.sh.hfus callback delstream"),i.onStreamUpdated(n.ENUM_STREAM_UPDATE_TYPE.deleted,i.makeCallbackStreamList(e))),0!==r.length&&(i.logger.debug("zb.sh.hfus callback updatestream"),i.onStreamExtraInfoUpdated(i.makeCallbackStreamList(r)))}),this.logger.info("zb.sh.hfus call success")},t.prototype.handlePushStreamUpdateMsg=function(t){if(this.logger.info("zb.sh.hpsum call"),t.body.stream_info&&0!==t.body.stream_info.length){if(t.body.stream_info.length+this.stateCenter.streamSeq!==t.body.stream_seq)return this.logger.info("zb.sh.hpsum call updatestream"),void this.fetchStreamList();switch(this.stateCenter.streamSeq=t.body.stream_seq,t.body.stream_cmd){case n.ENUM_STREAM_UPDATE_CMD.added:this.handleAddedStreamList(t.body.stream_info);break;case n.ENUM_STREAM_UPDATE_CMD.deleted:this.handleDeletedStreamList(t.body.stream_info);break;case n.ENUM_STREAM_UPDATE_CMD.updated:this.handleUpdatedStreamList(t.body.stream_info)}this.logger.info("zb.sh.hpsum call success")}else this.logger.info("zb.sh.hpsum, emtpy list")},t.prototype.handleAddedStreamList=function(t){this.logger.debug("zb.sh.hasl call");for(var e,i=[],r=0;r<t.length;r++)if(t[r].anchor_id_name!=this.stateCenter.idName){e=!1;for(var o=0;o<this.stateCenter.streamList.length;o++)if(t[r].stream_id===this.stateCenter.streamList[o].stream_id){e=!0;break}e||i.push(t[r])}else this.logger.debug("hdsl.0 have self stream added");if(0!==i.length){this.logger.debug("zb.sh.hasl callback addstream");for(var a=0;a<i.length;a++)this.stateCenter.streamList.push(i[a]);this.onStreamUpdated(n.ENUM_STREAM_UPDATE_TYPE.added,this.makeCallbackStreamList(i))}this.logger.info("zb.sh.hasl call success")},t.prototype.handleDeletedStreamList=function(t){this.logger.debug("zb.sh.hdsl call");for(var e=[],i=0;i<t.length;i++)if(t[i].anchor_id_name!=this.stateCenter.idName){for(var r=this.stateCenter.streamList.length-1;r>=0;r--)if(t[i].stream_id===this.stateCenter.streamList[r].stream_id){this.stateCenter.streamList.splice(r,1),e.push(t[i]);break}}else this.logger.debug("zb.sh.hdsl have self stream deleted");0!==e.length&&(this.logger.debug("zb.sh.hdsl callback delstream"),this.onStreamUpdated(n.ENUM_STREAM_UPDATE_TYPE.deleted,this.makeCallbackStreamList(e))),this.logger.info("zb.sh.hdsl call")},t.prototype.handleUpdatedStreamList=function(t){this.logger.debug("zb.sh.husl call");for(var e=[],i=0;i<t.length;i++)if(t[i].anchor_id_name!=this.stateCenter.idName){for(var n=0;n<this.stateCenter.streamList.length;n++)if(t[i].stream_id===this.stateCenter.streamList[n].stream_id){t[i].extra_info!==this.stateCenter.streamList[n].extra_info&&(this.stateCenter.streamList[n]=t[i],e.push(t[i]));break}}else this.logger.debug("hsul.0 have self stream updated");0!==e.length&&(this.logger.debug("zb.sh.husl callback updatestream"),this.onStreamExtraInfoUpdated(this.makeCallbackStreamList(e))),this.logger.info("zb.sh.husl call success")},t.prototype.fetchStreamList=function(){if(this.logger.info("zb.sh.fsl call"),this.stateCenter.isLogin())if(this.stateCenter.streamQuerying)this.logger.info("zb.sh.fsl already doing");else{this.stateCenter.streamQuerying=!0,this.logger.debug("zb.sh.fsl send fetch request");this.socketCenter.registerRouter("stream_info",this.handleFetchStreamListRsp.bind(this)),this.socketCenter.sendMessage("stream_info",{reserve:0}),this.logger.debug("zb.sh.fsl call success")}else this.logger.info("zb.sh.fsl state error")},t.prototype.handleReconnectStream=function(t){this.logger.info("zb.sh.hrs call");var e=this.streamCenter.publisherList,i=function(i){if(e[i].publisher.state!=n.ENUM_PUBLISH_STATE.publishing||t.find(function(t){return t.stream_id==i})){if(e[i].publisher.state==n.ENUM_PUBLISH_STATE.stop&&t.find(function(t){return t.stream_id==i})){r.updateStreamInfo(i,n.ENUM_STREAM_SUB_CMD.liveEnd);for(var o=0;o<r.stateCenter.streamList.length;o++)if(r.stateCenter.streamList[o].stream_id==i){r.stateCenter.streamList.splice(o--,1);break}}}else r.updateStreamInfo(i,n.ENUM_STREAM_SUB_CMD.liveBegin,r.stateCenter.publishStreamList[i].extra_info)},r=this;for(var o in e)i(o);this.logger.info("zb.sh.hrs end")},t.prototype.makeCallbackStreamList=function(t){var e=[];if(t&&t.length>0)for(var i=0;i<t.length;i++){var n={anchor_id_name:t[i].anchor_id_name,stream_gid:t[i].stream_gid,anchor_nick_name:t[i].anchor_nick_name,extra_info:t[i].extra_info,stream_id:t[i].stream_id,urls_flv:"",urls_rtmp:"",urls_hls:"",urls_https_flv:"",urls_https_hls:""};this.setCDNInfo(n,t[i]),e.push(n)}return e},t.prototype.updateMixStream=function(t,e,i){var o=this;if(this.logger.info("zb.sh.ums call"),null==t.outputStreamId&&null==t.outputUrl)return this.logger.error("zb.sh.ums no mix stream info"),!1;if(0==t.streamList.length)return this.logger.error("zb.sh.ums no input stream"),!1;var a={id_name:this.stateCenter.idName,live_channel:this.stateCenter.roomid,appid:this.stateCenter.appid,version:n.PROTO_VERSION};"string"==typeof t.userData&&t.userData.length<=1e4&&(a.UserData=t.userData);for(var l=[],s=0;s<t.streamList.length;s++){var p=t.streamList[s],h=p.streamId;this.stateCenter.testEnvironment&&(h="zegotest-"+this.stateCenter.appid+"-"+p.streamId),l.push({stream_id:h,rect:{layer:s,top:p.top,left:p.left,bottom:p.bottom,right:p.right}})}a.MixInput=l;var u={};if(null!=t.outputStreamId?this.stateCenter.testEnvironment?u.stream_id="zegotest-"+this.stateCenter.appid+"-"+t.outputStreamId:u.stream_id=t.outputStreamId:null!=t.outputUrl&&(u.mixurl=t.outputUrl),!t.outputBitrate)return this.logger.error("zb.sh.ums no bitrate param"),!1;if(u.bitrate=t.outputBitrate,!t.outputFps)return this.logger.error("zb.sh.ums no fps param"),!1;if(u.fps=t.outputFps,!t.outputWidth)return this.logger.error("zb.sh.ums no width param"),!1;if(u.width=t.outputWidth,!t.outputHeight)return this.logger.error("zb.sh.ums no height param"),!1;if(u.height=t.outputHeight,t.outputAudioConfig&&(u.audio_enc_id=t.outputAudioConfig),t.outputAudioBitrate&&(u.audio_bitrate=t.outputAudioBitrate),t.outputAudioChannels&&(u.audio_channel_cnt=t.outputAudioChannels),t.outputBgColor){if("number"!=typeof t.outputBgColor)return this.logger.error("zb.sh.ums param outputBgColor error"),!1;a.output_bg_color=t.outputBgColor}if(t.outputBgImage){if("string"!=typeof t.outputBgImage||!t.outputBgImage.startsWith("preset-id://"))return this.logger.error("zb.sh.ums param outputBgImage error"),!1;a.output_bg_image=t.outputBgImage}this.stateCenter.testEnvironment?u.testenv=1:u.testenv=0,a.MixOutput=[u],t.extraParams&&(a.extra_params=t.extraParams);var c={channel:"zeus",cmd:"start_mix",req_body:JSON.stringify(a)};return this.logger.debug("zb.sh.ums send command"),this.socketCenter.sendMessage("biz_channel",c,function(a,l,s){o.logger.debug("zb.sh.ums receive message");var p="zegotest-"+o.stateCenter.appid+"-";if(0!=s.length){for(var h=JSON.parse(s),u=[],c=t.outputStreamId,f=0;f<h.play.length;f++){var v={rtmpUrls:null,hlsUrls:null,flvUrls:null};o.stateCenter.testEnvironment&&c&&c.startsWith(p)&&(c=c.slice(p.length)),h.play[f].rtmp_url&&h.play[f].rtmp_url.length>0&&(v.rtmpUrls=[h.play[f].rtmp_url]),h.play[f].hls_url&&h.play[f].hls_url.length>0&&(v.hlsUrls=[h.play[f].hls_url]),h.play[f].hdl_url&&h.play[f].hdl_url.length>0&&(v.flvUrls=[h.play[f].hdl_url]),u.push(v)}e&&e(c,u)}else i&&i(r.ClientUtil.getServerError(n.MIXSTREAM_ERROR_CODE+1))},function(t,e,a){if("number"==typeof t){o.logger.debug("zb.sh.ums error: "+t);var l=[];if(1000000150==t&&0!=a.length)for(var s=JSON.parse(a),p="zegotest-"+o.stateCenter.appid+"-",h=0;h<s.non_exist_streams.length;h++){var u=s.non_exist_streams[h];o.stateCenter.testEnvironment&&u.startsWith(p)?l.push(u.slice(p.length)):l.push(u)}i&&i(r.ClientUtil.getServerError(n.MIXSTREAM_ERROR_CODE+t),l)}else o.logger.debug("zb.sh.ums error code "+t.code),i&&i(t)}),!0},t.prototype.publishTarget=function(t,e,i){var o=this;if(t.type&&-1!=["addpush","delpush","clearpush"].indexOf(t.type))if(this.logger.info("zb.sh.ptcall"),t.streamId&&"string"==typeof t.streamId)if(t.pushUrl&&"string"==typeof t.pushUrl)if(this.stateCenter.publishStreamList[t.streamId]){var a=Math.ceil((new Date).getTime()/1e3),l=t.streamId;this.stateCenter.testEnvironment&&(l="zegotest-"+this.stateCenter.appid+"-"+t.streamId);var s={appid:this.stateCenter.appid,biz_type:0,timestamp:a,seq:this.stateCenter.cdnSeq++,version:1*n.PROTO_VERSION,stream_id:l,pushurl:t.pushUrl},p={channel:"media",cmd:t.type,req_body:JSON.stringify(s)};this.logger.debug("zb.sh.pt send command"),this.socketCenter.sendMessage("biz_channel",p,function(a,l,s){if(o.logger.debug("zb.sh.pt receive message"),0!=s.length){var p=JSON.parse(s),h=p.code,u=p.message;if(h&&0!=h)return o.logger.error("zb.sh.pt "+t.type+" error code: "+h+" "+u),void(i&&i({code:h,message:u}));o.logger.info("zb.sh.pt "+t.type+" success"),e&&e()}else i&&i(r.ClientUtil.getServerError(n.MIXSTREAM_ERROR_CODE+1))},function(t,e,n){o.logger.debug("zb.sh.pt error: "+i);var r="";2001==t?r="invalid channel":2002==t&&(r="bizchannel error"),i&&i({code:t,message:r})})}else this.logger.error("zb.sh.pt publish stream no found");else this.logger.error("zb.sh.pt pushurl error");else this.logger.error("zb.sh.pt streamid error");else this.logger.error("zb.sh.pt cdn push type error")},t.prototype.stopMixStream=function(t,e,i){if(this.logger.info("zb.sh.sms call"),null==t.outputStreamId&&null==t.outputUrl)return this.logger.error("zb.sh.sms outputStreamId and outputUrl at least one "),!1;var o={id_name:this.stateCenter.idName,live_channel:this.stateCenter.roomid,appid:this.stateCenter.appid,version:n.PROTO_VERSION};null!=t.outputStreamId?this.stateCenter.testEnvironment?o.stream_id="zegotest-"+this.stateCenter.appid+"-"+t.outputStreamId:o.stream_id=t.outputStreamId:null!=t.outputUrl&&(o.mixurl=t.outputUrl);var a={channel:"zeus",cmd:"stop_mix",req_body:JSON.stringify(o)};return this.socketCenter.sendMessage("biz_channel",a,function(t,i){e&&e()},function(t,e){"number"==typeof t?i&&i(r.ClientUtil.getServerError(n.MIXSTREAM_ERROR_CODE+t)):i&&i(t)}),!0},t.prototype.updateStreamExtraInfo=function(t,e){return this.logger.info("zb.sh.usei call"),t?"string"==typeof e&&(this.stateCenter.publishStreamList[t]&&(this.stateCenter.publishStreamList[t].extra_info=e,this.stateCenter.publishStreamList[t].state>=n.ENUM_PUBLISH_STREAM_STATE.update_info&&this.updateStreamInfo(t,n.ENUM_STREAM_SUB_CMD.liveUpdate,e)),!0):(this.logger.error("zb.sh.usei param error"),!1)},t}();e.StreamHandler=o},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=i(0),r=i(2),o=function(){function t(t,e,i){this.logger=t,this.socketCenter=i,this.stateCenter=e}return t.prototype.resetHeartbeat=function(){this.logger.debug("zb.hb.rht call"),this.stateCenter.heartbeatTimer&&clearTimeout(this.stateCenter.heartbeatTimer),this.stateCenter.heartbeatTimer=null,this.stateCenter.tryHeartbeatCount=0,this.logger.debug("zb.hb.rht call success")},t.prototype.hbLogout=function(t){},t.prototype.start=function(t){var e=this;if(this.logger.debug("zb.hb.sht call"),this.stateCenter.isLogin()){if(++this.stateCenter.tryHeartbeatCount>3)return this.logger.error("zb.hb.sht come to try limit"),void this.hbLogout(n.sdkErrorList.HEARTBEAT_TIMEOUT);this.logger.debug("zb.hb.sht send packet");this.socketCenter.registerRouter("hb",function(t){e.handleHeartbeatRsp(t)}),this.socketCenter.sendMessage("hb",{reserve:0}),this.logger.debug("zb.hb.sht call success"),this.stateCenter.heartbeatInterval=t,this.stateCenter.heartbeatTimer=setTimeout(function(){e.start(e.stateCenter.heartbeatInterval)},this.stateCenter.heartbeatInterval)}else this.logger.warn("zb.hb.sht state error")},t.prototype.handleHeartbeatRsp=function(t){if(this.logger.debug("zb.hb.hhbr call"),0!==t.body.err_code)return this.logger.error("zb.hb.hhbr call disconnect, server error=",t.body.err_code),void this.hbLogout(r.ClientUtil.getServerError(t.body.err_code));for(var e in this.stateCenter.tryHeartbeatCount=0,this.stateCenter.heartbeatInterval=t.body.hearbeat_interval,this.stateCenter.heartbeatInterval<n.MINIUM_HEARTBEAT_INTERVAL&&(this.stateCenter.heartbeatInterval=n.MINIUM_HEARTBEAT_INTERVAL),t.body.bigim_time_window&&"number"==typeof t.body.bigim_time_window&&(this.stateCenter.bigimTimeWindow=t.body.bigim_time_window),t.body.dati_time_window&&"number"==typeof t.body.dati_time_window&&(this.stateCenter.datiTimeWindow=t.body.dati_time_window),this.ReliableMessageHandler(t),this.fetchStreamList(t),this.patchUserList(t),this.stateCenter.publishStreamList)this.stateCenter.publishStreamList[e].state==n.ENUM_PUBLISH_STREAM_STATE.update_info&&(this.logger.info("zb.hb.hhbr try to update stream info"),this.updateStreamInfo(e,n.ENUM_STREAM_SUB_CMD.liveBegin,this.stateCenter.publishStreamList[e].extra_info));null!=t.body.online_count&&0!=t.body.online_count&&this.onUpdateOnlineCount(this.stateCenter.roomid,t.body.online_count),this.logger.debug("zb.hb.hhbr call success")},t.prototype.ReliableMessageHandler=function(t){var e=this;if(t.body.trans_seqs)for(var i=0;i<t.body.trans_seqs.length;i++){var n=t.body.trans_seqs[i].trans_channel,r=t.body.trans_seqs[i].trans_seq_array;(r=r.filter(function(t){var i=t.trans_type,n=t.trans_seq;return!e.stateCenter.transSeqMap[i]||e.stateCenter.transSeqMap[i].seq!==n})).length>0&&this.fetchReliableMessage(n,r)}},t.prototype.fetchReliableMessage=function(t,e){var i=this;this.logger.debug("zb.hb.frm call");var n={trans_channel:t,fetch_array:e};this.socketCenter.registerRouter("trans_fetch",function(t){i.handleFetchTransRsp(t)}),this.socketCenter.sendMessage("trans_fetch",n),this.logger.debug("zb.hb.frm call success")},t.prototype.handleFetchTransRsp=function(t){var e=this;this.stateCenter.isLogin()?0==t.body.err_code?t.body.trans_fetch_results.forEach(function(t){var i=t.trans_type,n=t.trans_seq;e.stateCenter.transSeqMap[i]={seq:n},t.trans_user_idname!=e.stateCenter.idName&&t.trans_idname!=e.stateCenter.idName&&e.onRecvReliableMessage(i,n,t.trans_data),e.logger.debug("zb.hb.hftr trans "+i+" seq "+n)}):this.logger.error("zb.hb.hftr trans send error "+t.body.err_code):this.logger.error("zb.hb.hftr not login")},t.prototype.fetchStreamList=function(t){var e=this;t.body.stream_seq!==this.stateCenter.streamSeq&&(this.logger.debug("zb.hb.fsl current seq "+this.stateCenter.streamSeq+" server Seq "+t.body.stream_seq),this.logger.debug("zb.hb.fsl call"),this.stateCenter.isLogin()?this.stateCenter.streamQuerying?this.logger.warn("zb.hb.fsl already doing"):(this.stateCenter.streamQuerying=!0,this.logger.debug("zb.hb.fsl send fetch request"),this.socketCenter.registerRouter("stream_info",function(t){e.handleFetchStreamListRsp(t)}),this.socketCenter.sendMessage("stream_info",{reserve:0}),this.logger.debug("zb.hb.fsl call success")):this.logger.warn("zb.hb.fsl state error"))},t.prototype.patchUserList=function(t){var e=this;if(t.body.server_user_seq!==this.stateCenter.userSeq&&this.stateCenter.userStateUpdate&&!this.stateCenter.userSeqMergeMap){var i=this.stateCenter.lastUserQueryTime-Date.now();this.logger.info("zb.hb.hhbr call update user "+this.stateCenter.userSeq+" server "+t.body.server_user_seq+" wait "+i),i>0?(this.stateCenter.userQueryTimer&&clearTimeout(this.stateCenter.userQueryTimer),this.stateCenter.userQueryTimer=setTimeout(function(){e.fetchUserList()},i)):this.fetchUserList()}},t.prototype.handleFetchStreamListRsp=function(t){},t.prototype.fetchUserList=function(){},t.prototype.updateStreamInfo=function(t,e,i,n){void 0===i&&(i="")},t.prototype.onUpdateOnlineCount=function(t,e){},t.prototype.onRecvReliableMessage=function(t,e,i){},t.prototype.resetCheckMessage=function(){this.logger.debug("zb.hb.rcm call"),clearTimeout(this.stateCenter.sendDataCheckTimer),this.stateCenter.sendDataCheckTimer=null,this.checkSendMessageList(this.stateCenter.sendDataList),this.checkSendMessageList(this.stateCenter.sendCommandList),this.stateCenter.sendDataMap={},this.stateCenter.sendCommandMap={},this.logger.debug("zb.hb.rcm call success")},t.prototype.checkSendMessageList=function(t){for(var e=t.getFirst();null!=e;)t.remove(e),e._data.error&&(e._data.data.body.custom_msg?e._data.error(n.sdkErrorList.SEND_MSG_TIMEOUT,e._data.data.header.seq,e._data.data.body.custom_msg):e._data.error(n.sdkErrorList.SEND_MSG_TIMEOUT,e._data.data.header.seq)),e=t.getFirst()},t.prototype.checkMessageListTimeout=function(t,e){for(var i=t.getFirst(),r=Date.parse(new Date+""),o=0,a=0,l=0;!(null==i||i._data.time+this.stateCenter.sendDataTimeout>r||(delete e[i._data.data.header.seq],t.remove(i),++a,null==i._data.error||this.stateCenter.sendDataDropTimeout>0&&i._data.time+this.stateCenter.sendDataDropTimeout<r?++l:i._data.data.body.custom_msg?i._data.error(n.sdkErrorList.SEND_MSG_TIMEOUT,i._data.data.header.seq,i._data.data.body.custom_msg):i._data.error(n.sdkErrorList.SEND_MSG_TIMEOUT,i._data.data.header.seq),++o>=this.stateCenter.sendDataCheckOnceCount));)i=t.getFirst();0==a&&0==l||this.logger.debug("zb.hb.cmt call success, stat: timeout=",a,"drop=",l)},t.prototype.startCheckMessageTimeout=function(){var t=this;this.stateCenter.isLogin()?(this.checkMessageListTimeout(this.stateCenter.sendDataList,this.stateCenter.sendDataMap),this.checkMessageListTimeout(this.stateCenter.sendCommandList,this.stateCenter.sendCommandMap),this.stateCenter.sendDataCheckTimer=setTimeout(function(){t.startCheckMessageTimeout()},this.stateCenter.sendDataCheckInterval)):this.logger.warn("zb.hb.scmt state error")},t}();e.HeartBeatHandler=o},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=i(0),r=i(2),o=function(){function t(t,e,i){this.logger=t,this.socketCenter=i,this.stateCenter=e}return t.prototype.sendCustomCommand=function(t,e,i,n){var o=this;if(this.logger.debug("zb.mh.scc call"),!this.stateCenter.isLogin())return this.logger.error("zb.mh.scc state error"),!1;if(!t)return this.logger.error("zb.mh.scc dstMembers error"),!1;var a={from_userid:this.stateCenter.idName,from_username:this.stateCenter.nickName,request_id:this.stateCenter.getRequestId(),custom_content:e||"",room_id:this.stateCenter.roomid},l={dest_id_name:t,custom_msg:JSON.stringify(a)};return r.ClientUtil.checkCustomCommandParam(l)?(this.socketCenter.registerRouter("custommsg",function(t){o.handleSendCustomMsgRsp(t)}),this.socketCenter.sendCustomMessage("custommsg",l,i,n),this.logger.info("zb.mh.scc call success"),!0):(this.logger.info("zb.mh.scc param error"),!1)},t.prototype.handleSendCustomMsgRsp=function(t){this.logger.debug("zb.mh.hscmrcall");var e,i=this.stateCenter.sendDataMap[t.header.seq];null!=i?("custommsg"!=(e=i._data).data.header.cmd?this.logger.error("zb.mh.hscmrcmd wrong"+e.data.header.cmd):0===t.body.err_code?null!=e.success&&e.success(t.header.seq,e.data.body.custom_msg):null!=e.error&&e.error(r.ClientUtil.getServerError(t.body.err_code),t.header.seq,e.data.body.custom_msg),delete this.stateCenter.sendDataMap[t.header.seq],this.stateCenter.sendDataList.remove(i)):this.logger.error("zb.mh.hscmrno found seq="+t.header.seq),this.logger.debug("zb.mh.hscmr  call success")},t.prototype.handlePushCustomMsg=function(t){var e=JSON.parse(t.body.custommsg);this.logger.debug("zb.mh.hpcm submsg=",e),this.onRecvCustomCommand(e.from_userid,e.from_username,e.custom_content)},t.prototype.onRecvCustomCommand=function(t,e,i){},t.prototype.sendRoomMsg=function(t,e,i,r,o){var a=this;if(this.logger.debug("zb.mh.srm call"),this.stateCenter.isLogin()){var l=Date.parse(new Date+"");if(this.stateCenter.sendRoomMsgTime>0&&this.stateCenter.sendRoomMsgTime+this.stateCenter.SendRoomMsgInterval>l)return this.logger.info("zb.mh.srm freq error"),void(o&&o(n.sdkErrorList.FREQ_LIMITED,0,t,e,i));this.stateCenter.sendRoomMsgTime=l,this.logger.debug("zb.mh.srm send fetch request");var s={msg_category:t,msg_type:e,msg_content:i};this.socketCenter.registerRouter("im_chat",function(t){a.handleSendRoomMsgRsp(t)}),this.socketCenter.sendCustomMessage("im_chat",s,r,o),this.logger.info("zb.mh.srm call success")}else this.logger.error("zb.mh.srm state error")},t.prototype.handleSendRoomMsgRsp=function(t){this.logger.debug("zb.mh.hsrmr call");var e,i=this.stateCenter.sendDataMap[t.header.seq];null!=i?("im_chat"!=(e=i._data).data.header.cmd?this.logger.error("zb.mh.hsrmr cmd wrong"+e.data.header.cmd):0===t.body.err_code?e.success&&e.success(t.header.seq,t.body.msg_id,e.data.body.msg_category,e.data.body.msg_type,e.data.body.msg_content):e.error&&e.error(r.ClientUtil.getServerError(t.body.err_code),t.header.seq,e.data.body.msg_category,e.data.body.msg_type,e.data.body.msg_content),delete this.stateCenter.sendDataMap[t.header.seq],this.stateCenter.sendDataList.remove(i)):this.logger.error("hzb.mh.hsrmr no found seq="+t.header.seq),this.logger.info("zb.mh.hsrmr call success")},t.prototype.onRecvRoomMsg=function(t,e,i){},t.prototype.sendReliableMessage=function(t,e,i,n){this.logger.debug("zb.mh.srirm call"),this.stateCenter.transSeqMap[t]||(this.stateCenter.transSeqMap[t]={seq:0});var r={trans_type:t,trans_data:e,trans_local_seq:this.stateCenter.transSeqMap[t].seq,trans_channel:"clt"};this.socketCenter.sendMessage("trans",r,i,n)},t.prototype.sendBigRoomMessage=function(t,e,i,n,r){var o=this;this.logger.debug("zb.mh.sbim call");var a=this.stateCenter.bigimTimeWindow,l=this.stateCenter.serverTimeOffset,s=(new Date).getTime()+l,p=(++this.stateCenter.cmdSeq).toString();if(null==n&&(n=null),null==r&&(r=null),this.stateCenter.bigImCallbackMap[p]={success:n,error:r},0==a){var h={msg_category:t,msg_type:e,msg_content:i,bigmsg_client_id:p};this.logger.debug("zb.mh.sbim no time window"),this.sendBigRoomMessageInternal([h],function(t){o.handleBigImMsgRsp(t)},r)}else{var u=Math.floor(s/a);if(this.logger.debug("currentIndex "+u+" lastTimeIndex "+this.stateCenter.bigImLastTimeIndex),this.stateCenter.bigImLastTimeIndex<u&&0==this.stateCenter.bigImMessageList.length){this.stateCenter.bigImLastTimeIndex=u;var c={msg_category:t,msg_type:e,msg_content:i,bigmsg_client_id:p};this.sendBigRoomMessageInternal([c],function(t){o.handleBigImMsgRsp(t)},r)}else this.stateCenter.bigImMessageList.push({msg_category:t,msg_type:e,msg_content:i,bigmsg_client_id:p}),1==this.stateCenter.bigImMessageList.length&&this.setBigImTimer(l,a)}},t.prototype.handlePushMergeMsg=function(t){if(this.stateCenter.isLogin()){for(var e=0;e<t.body.messages.length;e++)14001===t.body.messages[e].sub_cmd&&this.handlePushBigRooMsg(t.body.messages[e].msg_body);this.logger.debug("zb.mh.hpmm call success")}else this.logger.error("zb.mh.hpmmnot login")},t.prototype.handlePushBigRooMsg=function(t){var e;try{e=JSON.parse(t)}catch(t){return void this.logger.warn("zb.mh.hpbrm parse json error")}if(e){for(var i=e.room_id,n=[],r=0;r<e.msg_data.length;r++){var o=e.msg_data[r];o.id_name!=this.stateCenter.idName?n.push({idName:o.id_name,nickName:o.nick_name,messageId:o.bigmsg_id,category:o.msg_category,type:o.msg_type,content:o.msg_content,time:o.send_time}):this.logger.debug("zb.mh.hpbrm self message")}0==n.length?this.logger.debug("zb.mh.hpbrm no other pushData except self"):this.onRecvBigRoomMessage(n,i),this.logger.debug("zb.mh.hpbrm call success")}else this.logger.warn("zb.mh.hpbrm cann't find message body")},t.prototype.onRecvBigRoomMessage=function(t,e){},t.prototype.sendBigRoomMessageInternal=function(t,e,i){this.logger.debug("zb.mh.sbim call");var n={msgs:t};this.socketCenter.sendMessage("bigim_chat",n,e,i)},t.prototype.handleBigImMsgRsp=function(t){if(this.stateCenter.isLogin()){this.stateCenter.bigimTimeWindow!=t.body.bigim_time_window&&(this.stateCenter.bigimTimeWindow=t.body.bigim_time_window);for(var e=0;e<t.body.msgs.length;e++){var i=t.body.msgs[e].bigmsg_client_id,n=t.body.msgs[e].bigmsg_id;if(this.stateCenter.bigImCallbackMap[i]){var r=this.stateCenter.bigImCallbackMap[i].success;null!=r&&r(t.header.seq,n),delete this.stateCenter.bigImCallbackMap[i]}}}else this.logger.info("zb.mh.hbmr not login")},t.prototype.setBigImTimer=function(t,e){var i=this,n=e-((new Date).getTime()+t)%e,o=r.ClientUtil.generateRandumNumber(e)+n;this.logger.info("zb.mh.sbt setTimer "+o),this.stateCenter.bigImTimer=setTimeout(function(){i.onBigImTimer()},o)},t.prototype.onBigImTimer=function(){var t=this,e=(new Date).getTime()+this.stateCenter.serverTimeOffset;this.stateCenter.bigImLastTimeIndex=Math.floor(e/this.stateCenter.bigimTimeWindow);for(var i=[],n=[],r=0;r<this.stateCenter.bigImMessageList.length&&!(r>=20);r++){var o=this.stateCenter.bigImMessageList[r];i.push({msg_category:o.msg_category,msg_type:o.msg_type,msg_content:o.msg_content,bigmsg_client_id:o.bigmsg_client_id}),n.push(o.bigmsg_client_id)}this.stateCenter.bigImMessageList.length>20?this.stateCenter.bigImMessageList.splice(0,20):this.stateCenter.bigImMessageList=[],this.sendBigRoomMessageInternal(i,function(e){t.handleBigImMsgRsp(e)},function(e,i){for(var r=0;r<n.length;r++){var o=n[r],a=t.stateCenter.bigImCallbackMap[o];a&&(null!=a.error&&a.error(e,i),delete t.stateCenter.bigImCallbackMap[o])}}),clearTimeout(this.stateCenter.bigImTimer),this.stateCenter.bigImTimer=null,this.stateCenter.bigImMessageList.length>0&&this.setBigImTimer(this.stateCenter.serverTimeOffset,this.stateCenter.bigimTimeWindow)},t.prototype.sendRelayMessage=function(t,e,i,n){this.logger.debug("zb.mh.srm call");var r=this.stateCenter.datiTimeWindow,o=this.stateCenter.serverTimeOffset;r>0?(this.stateCenter.realyMessageList.push({type:t,data:e,success:i,error:n}),1==this.stateCenter.realyMessageList.length&&this.setRelayTimer(o,r)):this.sendRelayMessageInternal(t,e,i,n)},t.prototype.sendRelayMessageInternal=function(t,e,i,n){this.logger.debug("zb.mh.srmi call");var r={relay_type:t,relay_data:e};this.socketCenter.sendMessage("relay",r,i,n)},t.prototype.setRelayTimer=function(t,e){var i=this,n=2*e-((new Date).getTime()+t)%e,o=r.ClientUtil.generateRandumNumber(n);this.logger.info("zb.mh.srt setTimer "+o),this.stateCenter.relayTimer=setTimeout(function(){i.onRelayTimer()},o)},t.prototype.onRelayTimer=function(){if(0!=this.stateCenter.realyMessageList.length){var t=this.stateCenter.realyMessageList[0];this.sendRelayMessageInternal(t.type,t.data,t.success,t.error),clearTimeout(this.stateCenter.relayTimer),this.stateCenter.relayTimer=null,this.stateCenter.realyMessageList.splice(0,1),this.stateCenter.realyMessageList.length>0&&this.setRelayTimer(this.stateCenter.serverTimeOffset,this.stateCenter.datiTimeWindow)}else this.logger.info("zb.mh.ort no relay data")},t.prototype.handlePushTransMsg=function(t){if(this.stateCenter.isLogin()){var e=t.body.trans_type,i=t.body.trans_seq;this.stateCenter.transSeqMap[e]?this.stateCenter.transSeqMap[e].seq=i:this.stateCenter.transSeqMap[e]={seq:i},t.body.trans_user_idname!=this.stateCenter.idName&&t.body.trans_idname!=this.stateCenter.idName?this.onRecvReliableMessage(e,i,t.body.trans_data):this.logger.debug("zb.mh.hptr receive self trans message"),this.logger.info("zb.mh.hptr trans "+e+" seq "+i)}else this.logger.error("zb.mh.hptr not login")},t.prototype.onRecvReliableMessage=function(t,e,i){},t}();e.MessageHandler=o},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=i(0),r=function(){function t(t,e,i){this.logger=t,this.socketCenter=i,this.stateCenter=e}return t.prototype.requestJoinLive=function(t,e,i,r){this.logger.debug("zb.lh.rjl call");var o=this.stateCenter.getRequestId(),a=this.stateCenter.getSignalCmdContent(o,t);return null!=r&&(this.stateCenter.joinLiveCallbackMap[o]=r,this.sendSignalCmd(n.ENUM_SIGNAL_SUB_CMD.joinLiveRequest,a,t,e,i),!0)},t.prototype.inviteJoinLive=function(t,e,i,r){this.logger.debug("zb.lh.ijl call");var o=this.stateCenter.getRequestId(),a=this.stateCenter.getSignalCmdContent(o,t);return null!=r&&(this.stateCenter.joinLiveCallbackMap[o]=r,this.sendSignalCmd(n.ENUM_SIGNAL_SUB_CMD.joinLiveInvite,a,t,e,i),!0)},t.prototype.endJoinLive=function(t,e,i){this.logger.debug("zb.lh.ejl call");var r=this.stateCenter.getRequestId(),o=this.stateCenter.getSignalCmdContent(r,t);return this.sendSignalCmd(n.ENUM_SIGNAL_SUB_CMD.joinLiveStop,o,t,e,i),!0},t.prototype.respondJoinLive=function(t,e,i,r){this.logger.debug("zb.lh.rpjl call");var o=this.stateCenter.joinLiveRequestMap[t];if(!o)return this.logger.info("zb.lh.rpjl no dest id name"),!1;var a=0;!0===e&&(a=1);var l=this.stateCenter.getSignalCmdContent(t,o,a);return this.sendSignalCmd(n.ENUM_SIGNAL_SUB_CMD.joinLiveResult,l,o,i,r),delete this.stateCenter.joinLiveRequestMap[t],!0},t.prototype.sendSignalCmd=function(t,e,i,n,r){if(this.logger.debug("zb.lh.ssc call"),this.stateCenter.isLogin()){this.logger.debug("zb.lh.ssc send signal cmd "+t);var o={sub_cmd:t,signal_msg:e,dest_id_name:[i]};this.socketCenter.sendMessage("signal",o,n,r),this.logger.info("zb.lh.ssc call success")}else this.logger.error("zb.lh.ssc state error")},t.prototype.handlePushSignalMsg=function(t){if(this.stateCenter.isLogin()){var e=JSON.parse(t.body.signal_msg);switch(this.logger.debug("zb.lh.hpcm hpsm= ",e),t.body.sub_cmd){case n.ENUM_PUSH_SIGNAL_SUB_CMD.pushJoinLiveRequest:this.handlePushJoinLiveRequestMsg(e);break;case n.ENUM_PUSH_SIGNAL_SUB_CMD.pushJoinLiveResult:this.handlePushJoinLiveResultMsg(e);break;case n.ENUM_PUSH_SIGNAL_SUB_CMD.pushJoinLiveInvite:this.handlePushJoinLiveInviteMsg(e);break;case n.ENUM_PUSH_SIGNAL_SUB_CMD.pushJoinLiveStop:this.handlePushJoinLiveStopMsg(e)}this.logger.debug("zb.lh.hpsm call end")}else this.logger.warn("zb.lh.hpsm not login")},t.prototype.handlePushJoinLiveRequestMsg=function(t){var e=t.request_id;if("string"==typeof e){var i=t.from_userid;"string"==typeof i?(this.stateCenter.joinLiveRequestMap[e]=i,this.logger.info("zb.lh.hpjlrm onRecvJoinLiveRequest "+i),this.onRecvJoinLiveRequest(e,t.from_userid,t.from_username,t.room_id)):this.logger.error("zb.lh.hpjlrm no from user")}else this.logger.error("zb.lh.hpjlrm no requestId")},t.prototype.onRecvJoinLiveRequest=function(t,e,i,n){},t.prototype.handlePushJoinLiveInviteMsg=function(t){var e=t.request_id;if("string"==typeof e){var i=t.from_userid;"string"==typeof i?(this.stateCenter.joinLiveRequestMap[e]=i,this.logger.info("zb.lh.hpjlim onRecvInviteJoinLiveRequest "+i),this.onRecvInviteJoinLiveRequest(e,t.from_userid,t.from_username,t.room_id)):this.logger.error("zb.lh.hpjlim no from user")}else this.logger.error("zb.lh.hpjlim no requestId")},t.prototype.onRecvInviteJoinLiveRequest=function(t,e,i,n){},t.prototype.handlePushJoinLiveResultMsg=function(t){var e=t.request_id;if("string"==typeof e){var i=t.result;if(null!=i){var n=1==i;if(this.stateCenter.joinLiveCallbackMap[e]){var r=this.stateCenter.joinLiveCallbackMap[e];if(!r)return void this.logger.info("hpjlrm.o no callback");this.logger.info("zb.lh.hpjlrm joinLiveRequest/invite result "+n),delete this.stateCenter.joinLiveCallbackMap[e],r(n,t.from_userid,t.from_username)}}else this.logger.info("zb.lh.hpjlrm no result")}else this.logger.error("zb.lh.hpjlrm no requestId")},t.prototype.handlePushJoinLiveStopMsg=function(t){var e=t.request_id;"string"==typeof e?(this.logger.info("zb.lh.hpjlsm onRecvEndJoinLiveCommand "+t.from_userid),this.onRecvEndJoinLiveCommand(e,t.from_userid,t.from_username,t.room_id)):this.logger.error("zb.lh.hpjlsm no requestId")},t.prototype.onRecvEndJoinLiveCommand=function(t,e,i,n){},t}();e.LiveHandler=r},function(t,e,i){"use strict";var n,r=this&&this.__extends||(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])},function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});Object.defineProperty(e,"__esModule",{value:!0});var o=i(3),a=i(0),l=function(t){function e(e,i){var n=t.call(this,e,i)||this;return n.logger=e,n.stateCenter=i,n}return r(e,t),e.prototype.initRoom=function(t,e,i,n,r,o,a){this.roomHandler=t,this.server=e,this.serverBak=i||e,this.roomID=n,this.role=r,this.token=o,this.authToken=a},e.prototype.active=function(t){var e=this;if(this.logger.info("zc.rrh.a retry call"),this.stateCenter.networkState!=a.ENUM_NETWORK_STATE.offline)if(this.retryTimer)this.logger.info("zc.rrh.a has actived, ignore");else if(this.isOverTime)this.logger.info("zc.rrh.a retry over time, stop retry");else{if(1==this.retryActiveCount)this.retryActiveInterval=Math.floor(Math.random()*(1-this.RETRY_START_TIME_INTERVAL)+this.RETRY_START_TIME_INTERVAL);else{var i=Math.pow(2,Math.round(this.retryActiveCount/this.RETRY_CONTINUE_COUNT+1));this.retryActiveInterval=i>this.RETRY_MAX_TIME_INTERVAL?this.RETRY_MAX_TIME_INTERVAL:i}this.retryTimer=setTimeout(function(){e.roomHandler.login(e.retryActiveCount%2==1?e.server:e.serverBak,e.roomID,e.role,e.token,e.authToken,function(t){e.handleLoginFinish(t)},function(t){e.handleLoginFinish(null,t)}),e.retryTimer&&clearTimeout(e.retryTimer),e.retryTimer=null,e.retryActiveCount++},t?0:1e3*this.retryActiveInterval)}else this.logger.info("zc.rrh.a network is broken, stop retry")},e.prototype.startMaxTime=function(){var t=this;this.maxTimer||(this.maxTimer=setTimeout(function(){console.warn("over max time "+t.RETRY_MAX_TIME+"s, stop retry"),t.isOverTime=!0,t.roomHandler.resetRoom(),t.stopMaxTime(),t.invalid(),t.onactive(null,a.sdkErrorList.LOGIN_TIMEOUT)},1e3*this.RETRY_MAX_TIME))},e.prototype.stopMaxTime=function(){this.maxTimer&&clearTimeout(this.maxTimer),this.maxTimer=null},e.prototype.onactive=function(t,e){},e.prototype.handleError=function(t){if(this.RETRY_MAX_TIME<3)return!1;if("ZegoClient.Error.Server"==t.code){var e=t.msg.match(/code:(\d+)/)[1];return!["1000002002","1000005030","1000005035","1010","1011","1013","1014","1015","1016","1017","1018","1019","1020","1021","1023"].includes(e)&&(!!["1100040001","1100040100"].includes(e)||this.stateCenter.lastRunState==a.ENUM_RUN_STATE.login&&(this.stateCenter.sessionid="",this.invalid(),!0))}return!0},e.prototype.handleLoginFinish=function(t,e){e?this.handleError(e)?(!this.maxTimer&&this.startMaxTime(),this.active()):(this.roomHandler.resetRoom(),this.stopMaxTime(),this.invalid(),this.onactive(null,e)):(this.stopMaxTime(),this.invalid(),this.onactive(t))},e}(o.TryHandler);e.RetryRoomHandler=l},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=i(0),r=i(1),o=function(){function t(){this.testEnvironment=!1,this.third_token="",this.pullLimited=!0,this.configOK=!1,this.roomCreateFlag=1,this.runState=n.ENUM_RUN_STATE.logout,this.lastRunState=n.ENUM_RUN_STATE.logout,this.callbackList={},this.streamList=[],this.publishStreamList={},this.userQuerying=!1,this.userTempList=[],this.userSeq=0,this.userSeqMergeMap=null,this.userSeqMergeTimer=null,this.userQueryTimer=null,this.lastUserQueryTime=0,this.userListInterval=3e4,this.userListMergeInterval=5e3,this.anchor_info={anchor_id:"",anchor_id_name:"",anchor_nick_name:""},this.deviceInfos=null,this.deviceChangeTimer=null,this.deviceStateOut=!1,this.sendCommandMap={},this.sendCommandList=new n.LinkedList,this.sendDataMap={},this.sendDataList=new n.LinkedList,this.joinLiveCallbackMap={},this.joinLiveRequestMap={},this.streamUrlMap={},this.cmdCallback={},this.transSeqMap={},this.realyMessageList=[],this.relayTimer=null,this.bigImLastTimeIndex=0,this.bigIMmessageList=[],this.bigImCallbackMap={},this.bigImTimer=null,this.serverTimeOffset=0,this.datiTimeWindow=0,this.bigimTimeWindow=0,this.bigImMessageList=[],this.screenShotStreamList=[],this.tryLoginTimer=null,this.tryLoginInterval=1e4,this.roomRetryTime=300,this.streamRetryTime=300,this.heartbeatTimer=null,this.sendDataCheckTimer=null,this.sendDataCheckInterval=2e3,this.sendDataTimeout=5e3,this.sendDataDropTimeout=1e4,this.sendDataCheckOnceCount=100,this.sendRoomMsgTime=0,this.SendRoomMsgInterval=500,this.cmdSeq=0,this.audioEffectBuffer={},this.cdnSeq=0,this.isResetRoom=!1}return t.prototype.isLogin=function(){return this.runState===n.ENUM_RUN_STATE.login},t.prototype.getRequestId=function(){return this.idName+"-"+r.getSeq()},t.prototype.getSignalCmdContent=function(t,e,i){var n={request_id:t,room_id:this.roomid,from_userid:this.idName,from_username:this.nickName,to_userid:e};return null!=i&&(n.result=i),JSON.stringify(n)},t}();e.StateCenter=o},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=i(2),r=function(){function t(t){var e=t.type,i=t.channels,n=void 0===i?1:i,r=t.bufferSize,o=void 0===r?0:r,a=t.sampleBit,l=void 0===a?16:a,s=t.sampleRate,p=void 0===s?44100:s,h=this;this.instant=0,this.slow=0,this.clip=0;var u=new("undefined"!=typeof webkitAudioContext?webkitAudioContext:AudioContext);this.context=u,this.type=e,this.channels=n,this.bufferSize=o,this.sampleBit=l,this.sampleRate=p,this.script=u.createScriptProcessor(o,n,n);(new Date).getTime();this.script.addEventListener("audioprocess",function(t){var i,n=t.inputBuffer.getChannelData(0),r=0,o=0;for(i=0;i<n.length;++i)r+=n[i]*n[i],Math.abs(n[i])>.99&&(o+=1);if(h.instant=Math.sqrt(r/n.length),h.slow=.95*h.slow+.05*h.instant,h.clip=o/n.length,"pcm"===e||"wav"===e){for(var a=[],l=0;l<h.channels;l++)a.push(t.inputBuffer.getChannelData(l));h.recorderBuffer(a)}}),"pcm"!==e&&"wav"!==e||this.initRecorderBuffer(e)}return t.prototype.connectToSource=function(t,e){console.log("SoundMeter connecting");try{this.mic=this.context.createMediaStreamSource(t),this.mic.connect(this.script),this.script.connect(this.context.destination),void 0!==e&&e(null)}catch(t){console.error(t),void 0!==e&&e(t)}return this},t.prototype.recorderBuffer=function(t){this.worker.postMessage({command:"record",val:t})},t.prototype.initRecorderBuffer=function(t){var e=this;this.worker=n.ClientUtil.inlineWorker(function(){var t,e,i,n,r,o,a=[],l=this;function s(e){var i,n;if(1==t)i=h(a[0],r,a),1!=e&&(n=p(e,i));else if(2==t){var o=h(a[0],r,a),l=h(a[1],r,a);1!=e?n=u(p(e,o),p(e,l)):i=u(o,l)}return 1!=e?n:i}function p(t,e){for(var i=new Float32Array(e.length/t),n=0,r=0;n<i.length;)i[n]=e[r],r+=t,n++;return i}function h(t,e,i){for(var n=new Float32Array(e*t.length),r=0,o=0;o<i[0].length;o++)n.set(i[0][o],r),r+=i[0][o].length;return n}function u(t,e){for(var i=new Float32Array(t.length+e.length),n=0;n<t.length+e.length;n+=2)i[n]=t[n/2>>0],i[n+1]=e[n/2>>0];return i}function c(t,e,i){for(var n=0;n<i.length;n++)t.setUint8(e+n,i.charCodeAt(n))}function f(t,e,i){for(var n=0;n<i.length;n++,e+=2){var r=Math.max(-1,Math.min(1,i[n]));t.setInt16(e,r<0?32768*r:32767*r,!0)}}function v(t,e,i){for(var n=0;n<i.length;n++,e++){var r=Math.max(-1,Math.min(1,i[n])),o=r<0?128*r:127*r;o+=128,t.setInt8(e,o)}}this.onmessage=function(p){switch(p.data.command){case"init":h=p.data.val,t=h.sampleChannel,e=h.sampleBit,i=h.sampleRate,n=h.oldSampleRate,r=h.bufferSize,o=h.type;break;case"record":!function(r){for(var p=0;p<t;p++)a[p]||(a[p]=[]),a[p].push(r[p]);var h=Math.round(n/i);"pcm"===o?function(t){var i=function(t,i){var n;8==i?n=t.length:16==i&&(n=t.length,n*=2);var r=new ArrayBuffer(n),o=new DataView(r);8==i?v(o,0,t):16==e&&f(o,0,t);return o}(s(t),e);l.postMessage({command:"exportPcmLive",val:i})}(h):"wav"===o&&function(n){var r=function(n,r){var o;8==r?o=n.length:16==e&&(o=n.length,o*=2);var a=new ArrayBuffer(o+44),l=new DataView(a),s=i,p=e,h=t;c(l,0,"RIFF"),l.setUint32(4,36+o,!0),c(l,8,"WAVE"),c(l,12,"fmt "),l.setUint32(16,16,!0),l.setUint16(20,1,!0),l.setUint16(22,h,!0),l.setUint32(24,s,!0),l.setUint32(28,s*h*(p/8),!0),l.setUint16(32,h*(p/8),!0),l.setUint16(34,p,!0),c(l,36,"data"),l.setUint32(40,o,!0),8==e?v(l,44,n):16==e&&f(l,44,n);return l}(s(n),e);l.postMessage({command:"exportWav",val:r})}(h);a=[]}(p.data.val)}var h}}),this.worker.postMessage({command:"init",val:{sampleChannel:this.channels,sampleBit:this.sampleBit,sampleRate:this.sampleRate,oldSampleRate:this.context.sampleRate,bufferSize:this.bufferSize,type:t}}),this.worker.onmessage=function(t){switch(t.data.command){case"exportPcmLive":e.onReceiveBuffer(t.data.val);break;case"exportWav":e.onReceiveWav(t.data.val)}}},t.prototype.onReceiveBuffer=function(t){},t.prototype.onReceiveWav=function(t){},t.prototype.writeString=function(t,e,i){for(var n=0;n<i.length;n++)t.setUint8(e+n,i.charCodeAt(n))},t.prototype.writeBuffer=function(t,e,i){for(var n=0;n<i.byteLength;n++)t.setUint8(e+n,i[n])},t.prototype.concatenation=function(t){for(var e=0,i=0;i<t.length;++i)e+=t[i].buffer.byteLength;var n=new Uint8Array(e),r=0;for(i=0;i<t.length;++i)n.set(new Uint8Array(t[i].buffer),r),r+=t[i].buffer.byteLength;return n},t.prototype.encodeWave=function(t){var e=this.concatenation(t),i=e.byteLength,n=new ArrayBuffer(i+44),r=new DataView(n),o=this.sampleRate,a=this.sampleBit,l=this.channels;return this.writeString(r,0,"RIFF"),r.setUint32(4,36+i,!0),this.writeString(r,8,"WAVE"),this.writeString(r,12,"fmt "),r.setUint32(16,16,!0),r.setUint16(20,1,!0),r.setUint16(22,l,!0),r.setUint32(24,o,!0),r.setUint32(28,o*l*(a/8),!0),r.setUint16(32,l*(a/8),!0),r.setUint16(34,a,!0),this.writeString(r,36,"data"),r.setUint32(40,i,!0),this.writeBuffer(r,44,e),r},t.prototype.stop=function(){this.mic.disconnect(),this.script.disconnect()},t}();e.MediaUtil=r},function(t,e,i){"use strict";var n=this&&this.__assign||Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t};Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t){this.log=t,this.dataStatistics={},this.logger=t}return t.prototype.newReport=function(t){this.dataStatistics[t]={abs_time:Date.now(),time_consumed:0,error:0,events:[],event:""}},t.prototype.addMsgExt=function(t,e){this.dataStatistics[t]?this.dataStatistics[t].msg_ext=e:console.warn(t+" not exist")},t.prototype.eventStart=function(t,e){this.dataStatistics[t]?null!=this.dataStatistics[t].events?this.dataStatistics[t].events.push({event:e,abs_time:Date.now(),time_consumed:0}):this.logger.warn("zd.es.0 no events"):this.logger.warn("zd.es.0 no seq match")},t.prototype.eventEnd=function(t,e,i){if(this.dataStatistics[t]){var n=this.dataStatistics[t].events;if(n&&0!==n.length){for(var r=n.length-1;r>=0;r--)if(n[r].event==e&&n[r].time_consumed){n[r].time_consumed=Date.now()-n[r].abs_time;break}}else this.logger.info("zd.ee.0 no events")}else this.logger.info("zd.ee.0 no seq match")},t.prototype.eventEndWithMsg=function(t,e,i){if(this.dataStatistics[t]){var r=this.dataStatistics[t].events;if(r){for(var o=r.length-1;o>=0;o--)if(r[o].event==e&&r[o].time_consumed){r[o].time_consumed=Date.now()-r[o].abs_time,null==r[o].msg_ext&&(r[o].msg_ext={}),r[o].msg_ext=n({},i);break}}else this.logger.warn("zd.ee.0 no events")}else this.logger.warn("zd.ee.0 no seq match")},t.prototype.addEventInfo=function(t,e,i,n){if(this.dataStatistics[t]){var r=this.dataStatistics[t].events;if(null!=r){for(var o=r.length-1;o>=0;o--)if(r[o].event==e&&null!=r[o].time_consumed&&r[o].event==e&&null!=r[o].time_consumed){null==r[o].msg_ext&&(r[o].msg_ext={}),r[o].msg_ext[i]=n;break}}else this.logger.warn("zd.aei.0 no events")}else this.logger.warn("zd.aei.0 no seq match")},t.prototype.addEvent=function(t,e,i){this.dataStatistics[t]?this.dataStatistics[t].events&&(i?this.dataStatistics[t].events.push({event:e,abs_time:Date.now(),msg_ext:i}):this.dataStatistics[t].events.push({event:e,abs_time:Date.now()})):this.logger.warn("zd.ae.0 no seq match")},t.prototype.uploadReport=function(t,e,i){var n=this.dataStatistics[t];null!=n&&(n.itemtype=e,n.event=e,n.time_consumed=Date.now()-n.abs_time,i&&(n.error=1,n.error_msg=i),this.logger.report(n),delete this.dataStatistics[t])},t}();e.ZegoDataReport=r}])});