!function(t,n){if("object"==typeof exports&&"object"==typeof module)module.exports=n();else if("function"==typeof define&&define.amd)define([],n);else{var i=n();for(var l in i)("object"==typeof exports?exports:t)[l]=i[l]}}("undefined"!=typeof self?self:this,function(){return function(t){var n={};function i(l){if(n[l])return n[l].exports;var p=n[l]={i:l,l:!1,exports:{}};return t[l].call(p.exports,p,p.exports,i),p.l=!0,p.exports}return i.m=t,i.c=n,i.d=function(t,n,l){i.o(t,n)||Object.defineProperty(t,n,{enumerable:!0,get:l})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,n){if(1&n&&(t=i(t)),8&n)return t;if(4&n&&"object"==typeof t&&t&&t.__esModule)return t;var l=Object.create(null);if(i.r(l),Object.defineProperty(l,"default",{enumerable:!0,value:t}),2&n&&"string"!=typeof t)for(var p in t)i.d(l,p,function(n){return t[n]}.bind(null,p));return l},i.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(n,"a",n),n},i.o=function(t,n){return Object.prototype.hasOwnProperty.call(t,n)},i.p="",i(i.s=6)}([function(t,n,i){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.PROTO_VERSION="1.10.0",n.ROOMVERSION="V1",function(t){t[t.debug=0]="debug",t[t.info=1]="info",t[t.warn=2]="warn",t[t.error=3]="error",t[t.report=99]="report",t[t.disable=100]="disable"}(n.ENUM_LOG_LEVEL||(n.ENUM_LOG_LEVEL={})),function(t){t[t.disable=0]="disable",t[t.websocket=1]="websocket",t[t.https=2]="https"}(n.ENUM_REMOTE_TYPE||(n.ENUM_REMOTE_TYPE={}));var l=function(){function t(t,n){void 0===t&&(t=null),void 0===n&&(n=null),this._id=null,this.next=null,this.prev=null,this._id=t,this._data=n}return Object.defineProperty(t.prototype,"id",{get:function(){return this._id},set:function(t){this._id=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"data",{get:function(){return this._data},set:function(t){this._data=t},enumerable:!0,configurable:!0}),t.prototype.hasNext=function(){return this.next&&this.next.id},t.prototype.hasPrev=function(){return this.prev&&this.prev.id},t}();n.ListNode=l;var p=function(){function t(){this.start=new l,this.end=new l,this._idCounter=0,this._numNodes=0,this.start.next=this.end,this.start.prev=null,this.end.prev=this.start,this.end.next=null}return t.prototype.insertBefore=function(t,n){var i=new l(this._idCounter,n);return i.next=t,i.prev=t.prev,t.prev.next=i,t.prev=i,++this._idCounter,++this._numNodes,i},t.prototype.addLast=function(t){return this.insertBefore(this.end,t)},t.prototype.add=function(t){return this.addLast(t)},t.prototype.getFirst=function(){return 0===this._numNodes?null:this.start.next},t.prototype.getLast=function(){return 0===this._numNodes?null:this.end.prev},t.prototype.size=function(){return this._numNodes},t.prototype.getFromFirst=function(t){var n=0,i=this.start.next;if(t>=0)for(;n<t&&null!==i;)i=i.next,++n;else i=null;if(null===i)throw"Index out of bounds.";return i},t.prototype.get=function(t){return 0===t?this.getFirst():t===this._numNodes-1?this.getLast():this.getFromFirst(t)},t.prototype.remove=function(t){return t.prev.next=t.next,t.next.prev=t.prev,--this._numNodes,t},t.prototype.removeFirst=function(){var t=null;return this._numNodes>0&&(t=this.remove(this.start.next)),t},t.prototype.removeLast=function(){var t=null;return this._numNodes>0&&(t=this.remove(this.end.prev)),t},t.prototype.removeAll=function(){this.start.next=this.end,this.end.prev=this.start,this._numNodes=0,this._idCounter=0},t.prototype.each=function(t){for(var n=this.start;n.hasNext();)t(n=n.next)},t.prototype.find=function(t){for(var n=this.start,i=!1,l=null;n.hasNext()&&!i;)t(n=n.next)&&(l=n,i=!0);return l},t.prototype.map=function(t){for(var n=this.start,i=[];n.hasNext();)t(n=n.next)&&i.push(n);return i},t.prototype.push=function(t){return this.addLast(t)},t.prototype.unshift=function(t){this._numNodes>0?this.insertBefore(this.start.next,t):this.insertBefore(this.end,t)},t.prototype.pop=function(){return this.removeLast()},t.prototype.shift=function(){return this.removeFirst()},t}();n.LinkedList=p,n.sdkErrorList={SUCCESS:{code:"ZegoClient.Success",msg:"success."},PARAM:{code:"ZegoClient.Error.Param",msg:"input error."},HEARTBEAT_TIMEOUT:{code:"ZegoClient.Error.Timeout",msg:"heartbeat timeout."},LOGIN_TIMEOUT:{code:"ZegoClient.Error.Timeout",msg:"login timeout."},SEND_MSG_TIMEOUT:{code:"ZegoClient.Error.Timeout",msg:"send customsg timeout."},RESET_QUEUE:{code:"ZegoClient.Error.Timeout",msg:"msg waiting ack is clear when reset."},LOGIN_DISCONNECT:{code:"ZegoClient.Error.Network",msg:"network is broken and login fail."},KICK_OUT:{code:"ZegoClient.Error.Kickout",msg:"kickout reason="},UNKNOWN:{code:"ZegoClient.Error.Unknown",msg:"unknown error."},FREQ_LIMITED:{code:"ZegoClient.Error.requencyLimited",msg:"Frequency Limited."}},function(t){t[t.disconnected=0]="disconnected",t[t.connecting=1]="connecting",t[t.connected=2]="connected"}(n.ENUM_SIGNAL_STATE||(n.ENUM_SIGNAL_STATE={})),n.ENUM_RESOLUTION_TYPE={LOW:{width:240,height:320,frameRate:15,bitRate:300},MEDIUM:{width:480,height:640,frameRate:15,bitRate:800},HIGH:{width:720,height:1280,frameRate:20,bitRate:1500}},n.ENUM_RETRY_STATE={didNotStart:0,retrying:1,finished:2},n.ENUM_PUBLISH_STATE={start:0,waitingSessionRsp:1,waitingOffserRsp:2,waitingServerAnswer:3,waitingServerICE:4,connecting:5,publishing:6,stop:7,didNotStart:8},n.ENUM_PUBLISH_STATE_NEGO={stop:0,start:1,waiterAnswer:2,waitingCandidate:3,sendCandidate:4,iceConnected:5,iceClosed:6,iceFailed:7,iceDisconnected:8},n.ENUM_PLAY_STATE={start:0,waitingSessionRsp:1,waitingOffserRsp:2,waitingServerAnswer:3,waitingServerICE:4,connecting:5,playing:6,stop:7,didNotStart:8},n.ENUM_PLAY_STATE_NEGO={stop:0,start:1,waiterAnswer:2,waitingCandidate:3,sendCandidate:4,iceConnected:5,iceClosed:6,iceFailed:7,iceDisconnected:8},n.ENUM_CONNECT_STATE={disconnect:0,connecting:1,connected:2},n.MAX_TRY_CONNECT_COUNT=1,n.SEND_MSG_RESET=2,n.SEND_MSG_TIMEOUT=1,n.MAX_TRY_HEARTBEAT_COUNT=5,n.ENUM_PUBLISH_STREAM_STATE={waiting_url:1,tryPublish:2,update_info:3,publishing:4,stop:5},n.ENUM_STREAM_SUB_CMD={liveNone:0,liveBegin:2001,liveEnd:2002,liveUpdate:2003},n.ENUM_STREAM_UPDATE_TYPE={added:0,deleted:1},function(t){t[t.logout=0]="logout",t[t.trylogin=1]="trylogin",t[t.login=2]="login"}(n.ENUM_RUN_STATE||(n.ENUM_RUN_STATE={})),function(t){t[t.offline=0]="offline",t[t.online=1]="online"}(n.ENUM_NETWORK_STATE||(n.ENUM_NETWORK_STATE={})),n.ENUM_PUBLISH_STATE_UPDATE={start:0,error:1,retry:2},n.ENUM_PLAY_STATE_UPDATE={start:0,error:1,retry:2},n.MINIUM_HEARTBEAT_INTERVAL=3e3,n.ENUM_STREAM_UPDATE_CMD={added:12001,deleted:12002,updated:12003},n.SERVER_ERROR_CODE=1e4,n.MIXSTREAM_ERROR_CODE=1e4,function(t){t[t.low=1]="low",t[t.stantard=2]="stantard",t[t.hight=3]="hight",t[t.custome=4]="custome"}(n.QUALITYLEVEL||(n.QUALITYLEVEL={})),n.ENUM_SIGNAL_SUB_CMD={none:0,joinLiveRequest:1001,joinLiveResult:1002,joinLiveInvite:1003,joinLiveStop:1004},n.ENUM_PUSH_SIGNAL_SUB_CMD={none:0,pushJoinLiveRequest:11001,pushJoinLiveResult:11002,pushJoinLiveInvite:11003,pushJoinLiveStop:11004},function(t){t[t.auto=0]="auto",t[t.ultra=1]="ultra"}(n.ENUM_PLAY_SOURCE_TYPE||(n.ENUM_PLAY_SOURCE_TYPE={})),function(t){t[t.stop=0]="stop",t[t.start=1]="start"}(n.ENUM_BROADCASTER_STATUS||(n.ENUM_BROADCASTER_STATUS={})),function(t){t[t.cdn=0]="cdn",t[t.ultra=1]="ultra",t[t.customUrl=2]="customUrl"}(n.ENUM_DISPATCH_TYPE||(n.ENUM_DISPATCH_TYPE={})),function(t){t[t.ClientType_None=0]="ClientType_None",t[t.ClientType_H5=1]="ClientType_H5",t[t.ClientType_SmallPragram=2]="ClientType_SmallPragram",t[t.ClientType_Webrtc=3]="ClientType_Webrtc"}(n.E_CLIENT_TYPE||(n.E_CLIENT_TYPE={}))},function(t,n,i){"use strict";var l;Object.defineProperty(n,"__esModule",{value:!0}),n.playErrorList={DISPATCH_ERROR:{code:"ZegoPlayWeb.Error.Dispatch",msg:"dispatch request error"},DISPATCH_TIMEOUT:{code:"ZegoPlayWeb.Timeout.Dispatch",msg:"dispatch request timeout"},CONNECT_FAILED:{code:"ZegoPublish.Error.Connect",msg:"connect signal fail"},TOKEN_ERROR:{code:"ZegoPlayWeb.Error.Token",msg:"login token error"},SEND_SESSION_TIMEOUT:{code:"ZegoPlayWeb.Timeout.Session",msg:"send session request timeout"},CREATE_SESSION_ERROR:{code:"ZegoPlayWeb.Error.Session",msg:"create session error"},CREATE_OFFER_ERROR:{code:"ZegoPublish.Error.CreateOffer",msg:"create offer error"},SERVER_MEDIA_DESC_TIMEOUT:{code:"ZegoPlayWeb.Timeout.RemoteOffer",msg:"wating server mediaDesc timeout"},SET_REMOTE_DESC_ERROR:{code:"ZegoPlayWeb.Error.RemoteOffer",msg:"other side offer error"},CREATE_ANSWER_ERROR:{code:"ZegoPlayWeb.Error.CreateAnswer",msg:"create offer error"},SET_LOCAL_DESC_ERROR:{code:"ZegoPlayWeb.Error.LocalDesc",msg:"setLocalDescription error"},SEND_MEDIA_DESC_TIMEOUT:{code:"ZegoPlayWeb.Timeout.Desc",msg:"send mediaDesc timeout"},SEND_CANDIDATE_ERROR:{code:"ZegoPlayWeb.Error.Candidate",msg:"send candidate error"},SEND_CANDIDATE_TIMEOUT:{code:"ZegoPlayWeb.Timeout.Candidate",msg:"send candidate timeout"},SERVER_NEGO_TIMEOUT:{code:"ZegoPlayWeb.Timeout.negotiation",msg:"negotiation timeout"},SERVER_CANDIDATE_TIMEOUT:{code:"ZegoPlayWeb.Timeout.ServerCandidate",msg:"waiting candidate timeout"},SERVER_CANDIDATE_ERROR:{code:"ZegoPlayWeb.Error.ServerCandidate",msg:"recv candidate error"},MEDIA_CONNECTION_FAILED:{code:"ZegoPlayWeb.Error.ConnectionFailed",msg:"ice Connection state failed"},MEDIA_CONNECTION_CLOSED:{code:"ZegoPlayWeb.Error.ConnectionClosed",msg:"ice connection state closed"},SESSION_CLOSED:{code:"ZegoPlayWeb.Error.SessionClosed",msg:"server session closed"},MEDIA_CONNECTION_DISCONNECTED:{code:"ZegoPublish.Error.IConnectionDisconnected",msg:"ice connection state disconnected"},WEBSOCKET_ERROR:{code:"ZegoPlayWeb.Error.SocketError",msg:"network error"},RETRY_TIMEOUT:{cose:"ZegoPlayWeb.Error.RetryTimeout",msg:"retry timeout"},NETWORK_BROKEN:{code:"ZegoPlayWeb.Error.NetworkBroken",msg:"network broken"}},n.publishErrorList={DISPATCH_ERROR:{code:"ZegoPublish.Error.Dispatch",msg:"dispatch request error"},DISPATCH_TIMEOUT:{code:"ZegoPublish.Timeout.Dispatch",msg:"dispatch request timeout"},CONNECT_FAILED:{code:"ZegoPublish.Error.Connect",msg:"connect signal fail"},TOKEN_ERROR:{code:"ZegoPublish.Error.Token",msg:"login token error"},SEND_SESSION_TIMEOUT:{code:"ZegoPublish.Timeout.Session",msg:"send session request timeout"},CREATE_SESSION_ERROR:{code:"ZegoPublish.Error.Session",msg:"create session error"},CREATE_OFFER_ERROR:{code:"ZegoPublish.Error.CreateOffer",msg:"create offer error"},SET_LOCAL_DESC_ERROR:{code:"ZegoPublish.Error.LocalDesc",msg:"setLocalDescription error"},SEND_MEDIA_DESC_TIMEOUT:{code:"ZegoPublish.Timeout.Desc",msg:"send mediaDesc timeout"},SERVER_MEDIA_DESC_TIMEOUT:{code:"ZegoPublish.Timeout.ServerAnswer",msg:"waiting server mediaDesc timeout"},SERVER_MEDIA_DESC_ERROR:{code:"ZegoPublish.Error.ServerAnswer",msg:"server mediaDesc type error"},SET_REMOTE_DESC_ERROR:{code:"ZegoPublish.Error.RemoteDesc",msg:"other side offer error"},SEND_CANDIDATE_TIMEOUT:{code:"ZegoPublish.Timeout.Candidate",msg:"sendIceCandidate error"},SERVER_CANDIDATE_TIMEOUT:{code:"ZegoPublish.Timeout.ServerCandidate",msg:"waiting candidate timeout"},SERVER_NEGO_TIMEOUT:{code:"ZegoPublish.Timeout.negotiation",msg:"negotiation timeout"},SERVER_CANDIDATE_ERROR:{code:"ZegoPublish.Error.ServerCandidate",msg:"recv candidate error"},SESSION_CLOSED:{code:"ZegoPublish.Error.SessionClosed",msg:"server session closed"},MEDIA_CONNECTION_FAILED:{code:"ZegoPublish.Error.IConnectionFailed",msg:"Iice Connection state failed"},MEDIA_CONNECTION_CLOSED:{code:"ZegoPublish.Error.ConnectionClosed",msg:"ice connection state closed"},MEDIA_CONNECTION_DISCONNECTED:{code:"ZegoPublish.Error.IConnectionDisconnected",msg:"ice connection state disconnected"},WEBSOCKET_ERROR:{code:"ZegoPublish.Error.SocketError",msg:"network error"},RETRY_TIMEOUT:{cose:"ZegoPublish.Error.RetryTimeout",msg:"retry timeout"},NETWORK_BROKEN:{code:"ZegoPublish.Error.NetworkBroken",msg:"network broken"}},n.ENUM_PUBLISH_STATE_UPDATE={start:0,error:1,retry:2},n.ENUM_PLAY_STATE_UPDATE={start:0,error:1,retry:2,stop:3},n.ENUM_RETRY_STATE={didNotStart:0,retrying:1,finished:2},n.getSeq=(l=1,function(){return l++})},function(t,n,i){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var l=function(){function t(){}return t.checkConfigParam=function(t,n){return t.appid&&"number"==typeof t.appid?!t.server||t.server.length<1||"string"!=typeof t.server&&!Array.isArray(t.server)?(n.error("ccp.0 server must be string or string[] and not empty"),!1):!(!t.idName||"string"!=typeof t.idName)||(n.error("ccp.0 idName must be string and not empty"),!1):(n.error("ccp.0 appid must be number"),!1)},t.checkLoginParam=function(t,n){return!0},t.checkPreviewParam=function(t,n){var i=t.bitRate;if(4===t.videoQuality||t.externalMediaStream){if("number"!=typeof t.width||-1!==t.width.toString().indexOf("."))return n.error("zc.p.sp.0 width must be number"),!1;if("number"!=typeof t.height||-1!==t.height.toString().indexOf("."))return n.error("zc.p.sp.0 height must be number"),!1;if("number"!=typeof t.frameRate)return n.error("zc.p.sp.0 frameRate must be number"),!1;if("number"==typeof i)i<48&&(i=48),i>1e4&&(i=1e4),t.minBitRate=t.maxBitRate=t.bitRate;else if(i.minBitRate&&i.maxBitRate&&"number"==typeof i.minBitRate&&"number"==typeof i.maxBitRate&&i.minBitRate<=i.maxBitRate)t.minBitRate=i.minBitRate<48?48:i.minBitRate,t.maxBitRate=i.maxBitRate>1e4?1e4:i.maxBitRate;else if(i)return n.error("zc.p.sp.0 bitRate must be number or object which has minBitRate and maxBitRate"),!1}return!0},t.registerCallback=function(t,n,i){var l,p;n.success&&(l=n.success),n.error&&(p=n.error),i[t+"SuccessCallback"]=l,i[t+"ErrorCallback"]=p},t.actionErrorCallback=function(t,n){return n[t+"ErrorCallback"]},t.actionSuccessCallback=function(t,n){return n[t+"SuccessCallback"]},t.getDevices=function(t,n){void 0!==navigator.mediaDevices&&void 0!==navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then(function(n){for(var i=[],l=[],p=[],v=0;v<n.length;v++){var e=n[v];"audioinput"===e.kind&&i.push({deviceName:e.label,deviceID:e.deviceId}),"audiooutput"===e.kind&&l.push({deviceName:e.label,deviceID:e.deviceId}),"videoinput"===e.kind&&p.push({deviceName:e.label,deviceID:e.deviceId})}t&&t({microphones:i,speakers:l,cameras:p})}).catch(function(t){console.error("enumerate devices wrong "+t),n&&n({code:"2000000007",msg:"enumerate devices fail"})}):n&&n({code:"2002000002",msg:"browser do not support"})},t.getServerError=function(t){var n={1:"parse json error.",1001:"login is processing.",1002:"liveroom request error.",1003:"zpush connect fail.",1004:"zpush handshake fail.",1005:"zpush login fail.",1006:"user login state is wrong.",1007:"got no zpush addr",1008:"token error",1009:"dispatch error",1010:"token expired",2002:"biz channel error",1000000000:"liveroom cmd error, code:"};if(0===t)return{code:"ZegoClient.Success",msg:"success"};var i={code:"ZegoClient.Error.Server",msg:""};return i.msg=t>1e9?n[1e9]+t:n[t]?n[t]+" code:"+t:"unknown error code:"+t,i},t.isKeepTryLogin=function(t){switch(t){case 1002:case 1003:return!0;default:return!1}},t.mergeStreamList=function(t,n,i,l,p){t.debug("msl.0 call");var v,e=[],T=[],E=[];l||(l=[]);for(var R=0;R<l.length;R++)if(l[R].anchor_id_name!=n){v=!1;for(var S=0;S<i.length;S++)if(l[R].stream_id===i[S].stream_id){l[R].extra_info!==i[S].extra_info&&E.push(l[R]),v=!0;break}v||e.push(l[R])}else t.debug("msl.0 have self stream added");for(var L=0;L<i.length;L++){v=!1;for(var M=0;M<l.length;M++)if(i[L].stream_id===l[M].stream_id){v=!0;break}v||T.push(i[L])}i.splice(0);for(R=0;R<l.length;R++)i.push(l[R]);p(e,T,E),t.debug("msl.0 call success")},t.checkCustomCommandParam=function(t){return!0},t.generateRandumNumber=function(t){return parseInt(Math.random()*(t+1)+"",10)},t.uuid=function(t,n){var i,l="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),p=[];if(n=n||l.length,t)for(i=0;i<t;i++)p[i]=l[0|Math.random()*n];else{var v=void 0;for(p[8]=p[13]=p[18]=p[23]="-",p[14]="4",i=0;i<36;i++)p[i]||(v=0|16*Math.random(),p[i]=l[19==i?3&v|8:v])}return p.join("")},t.supportDetection=function(t,n,i){var l={webRtc:!1,capture:!1,videoDecodeType:{H264:!1,VP8:!1},screenSharing:t};navigator&&(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.msGetUserMedia||navigator.mozGetUserMedia||navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)&&(l.capture=!0),window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection?(l.webRtc=!0,this.supportVideoCodeType(function(t){l.videoDecodeType.H264=t.H264,l.videoDecodeType.VP8=t.VP8,n&&n(l)},function(t){i&&i(t)})):n&&n(l)},t.compareVersion=function(t,n){t=t.split("."),n=n.split(".");for(var i=Math.max(t.length,n.length);t.length<i;)t.push("0");for(;n.length<i;)n.push("0");for(var l=0;l<i;l++){var p=parseInt(t[l]),v=parseInt(n[l]);if(p>v)return 1;if(p<v)return-1}return 0},t.isSupportLive=function(t,n){var i="当前微信版本过低，无法使用相关组件",l="需要摄像头和录音功能的授权",p=wx.getSystemInfoSync().SDKVersion,v={code:-1,msg:""};this.compareVersion(p,"1.7.0")<0&&(v={code:10001,msg:i},t&&t(v)),wx.getSetting({success:function(n){var i=n.authSetting;i["scope.camera"]&&i["scope.record"]||(v={code:10002,msg:l}),t&&t(v)},fail:function(t){n&&n(t)}})},t.isSupportQQLive=function(t,n){var i="当前微信版本过低，无法使用相关组件",l="需要摄像头和录音功能的授权",p=qq.getSystemInfoSync().SDKVersion,v={code:-1,msg:""};this.compareVersion(p,"1.7.0")<0&&(v={code:10001,msg:i},t&&t(v)),qq.getSetting({success:function(n){var i=n.authSetting;i["scope.camera"]&&i["scope.record"]||(v={code:10002,msg:l}),t&&t(v)},fail:function(t){n&&n(t)}})},t.supportVideoCodeType=function(t,n){var i=!1;new RTCPeerConnection(null).createOffer({offerToReceiveAudio:1,offerToReceiveVideo:1}).then(function(n){if(n&&n.sdp){i=!0;var l=n.sdp.split("\r\n"),p=l.some(function(t){return t.startsWith("a=rtpmap:")&&t.indexOf("H264/")>-1}),v=l.some(function(t){return t.startsWith("a=rtpmap:")&&t.indexOf("VP8/")>-1}),e=l.some(function(t){return t.startsWith("a=rtpmap:")&&t.indexOf("VP9/")>-1}),T=l.some(function(t){return t.startsWith("a=rtpmap:")&&t.indexOf("H264/")>-1});t&&t({H264:p,VP8:v,VP9:e,H265:T})}},function(t){i=!0,clearTimeout(l),n&&n(t)});var l=setTimeout(function(){0==i&&n(!1)},200)},t.inlineWorker=function(t){if(Worker){var n=t.toString().trim().match(/^function\s*\w*\s*\([\w\s,]*\)\s*{([\w\W]*?)}$/)[1],i=URL.createObjectURL(new window.Blob([n],{type:"text/javascript"}));return new Worker(i)}return null},t}();n.ClientUtil=l},function(t,n,i){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var l=function(){function t(t,n){this.audioBufferList=[],this.loop=!1,this.replace=!1,this.effectEndedCallBack=null,this.effectEndedListener=null,this.startTimes=0,this.startOffset=0,this.pauseTimes=0,this.resumeOffset=0,this.isMixAudio=!1,this.isMixingBuffer=!1,this.logger=t,this.ac=n}return t.prototype.preloadEffect=function(t,n){var i=this;this.logger.info("amu.pe.0 start preload effect");var l=new XMLHttpRequest;l.open("GET",t,!0),l.responseType="arraybuffer",l.onload=function(){if(200==l.status||304==l.status){var t=l.response;i.ac.decodeAudioData(t,function(t){i.logger.info("amu.pe.0 effect preload success"),n("",t)},function(t){n(t)})}else{var p=l.statusText;n(p)}},l.send()},t.prototype.playEffect=function(t,n,i,l,p){var v=this;!0!==this.isMixAudio?this.audioBuffer?(this.startOffset=t||0,this.loop=n||!1,this.replace=i||!1,this.effectEndedCallBack=p,this.mixEffect(this.audioBuffer,function(){v.buffSource.loop=!!n,t?v.buffSource.start(0,t/1e3):v.buffSource.start(0),v.startTimes=Date.now(),v.effectEndedListener=v.effectEndedHandler.bind(v),v.buffSource.addEventListener("ended",v.effectEndedListener),l&&l()})):this.logger.error("amu.pe.1 no audio buffer found"):this.logger.error("amu.pe.1 audio is mixing")},t.prototype.mixingBuffer=function(t,n){var i=this;!0!==this.isMixAudio||0!=this.audioBufferList.length||0!=this.isMixingBuffer?this.ac.decodeAudioData(t,function(t){i.audioBufferList.push(t),1==i.audioBufferList.length&&i.playRealTimeEffect(i.audioBufferList[0]),i.isMixingBuffer=!0,n&&n()},function(t){i.logger.error("amu.mb.0 "+t),n&&n(t)}):this.logger.error("amu.mb.0 audio is mixing")},t.prototype.stopMingBuffer=function(){return this.isMixingBuffer=!1,this.stopMixingAudio()},t.prototype.playRealTimeEffect=function(t){var n=this;this.mixEffect(t,function(){n.buffSource.start(0),n.buffSource.addEventListener("ended",function(){n.audioBufferList.shift(),n.audioBufferList.length>0&&n.isMixAudio&&n.playRealTimeEffect(n.audioBufferList[0])})})},t.prototype.pauseEffect=function(){this.audioBufferList.length>0?this.logger.error("amu.pe.0 real time buffer can not be paused"):(this.stopMixingAudio(),this.resumeOffset=(this.pauseTimes-this.startTimes+this.startOffset)%(1e3*this.audioBuffer.duration))},t.prototype.resumeEffect=function(){this.audioBufferList.length>0?this.logger.error("amu.pe.0 real time buffer can not be resume"):(this.playEffect(this.resumeOffset,this.loop,this.replace,null,this.effectEndedCallBack),this.startOffset=this.resumeOffset)},t.prototype.mixEffect=function(t,n){this.localStream?(this.gainNode=this.ac.createGain(),this.buffSource=this.ac.createBufferSource(),this.buffSource.buffer=t,this.buffSource.connect(this.gainNode),this.gainNode.connect(this.ac.destination),this.replaceTrack()&&n()):this.logger.error("amu.me.0 localStream can not be found")},t.prototype.startMixingAudio=function(t,n){return this.replace=n||!1,this.isMixAudio?(this.logger.error("amu.sma.0 audio is mixing"),!1):this.localStream?(t.captureStream=t.captureStream||t.mozCaptureStream||t.webkitCaptureStream,this.gainNode=this.ac.createGain(),this.mixAudio=this.ac.createMediaStreamSource(t.captureStream()),this.mixAudio.connect(this.gainNode),this.replaceTrack()):(this.logger.error("amu.sma.0 localStream can not be found"),!1)},t.prototype.replaceTrack=function(){this.streamSource=this.ac.createMediaStreamSource(this.localStream),this.destination=this.ac.createMediaStreamDestination(),!this.replace&&this.streamSource.connect(this.destination),this.gainNode.connect(this.destination);var t=this.destination.stream.getAudioTracks()[0],n=this.peerConnection.getSenders().find(function(n){return n.track.kind===t.kind});return n?(this.micTrack=this.localStream.getAudioTracks()[0],n.replaceTrack(t),this.localStream.removeTrack(this.micTrack),this.localStream.addTrack(t),this.isMixAudio=!0,!0):(this.logger.error("amu.rt.0 no sender"),!1)},t.prototype.stopMixingAudio=function(){return this.isMixAudio?this.localStream?(this.mixAudio?(this.mixAudio.disconnect(this.gainNode),this.mixAudio=null):this.buffSource&&(this.buffSource.removeEventListener("ended",this.effectEndedListener),this.buffSource.stop(),this.pauseTimes=Date.now(),this.buffSource.disconnect(this.gainNode),this.buffSource=null),this.gainNode.disconnect(this.destination),this.isMixAudio=!1,this.audioBufferList=[],!0):(this.logger.error("amu.sma.1 localStream can not be found"),!1):(this.logger.error("amu.sma.1 no mixing audio found"),!1)},t.prototype.setMixingAudioVolume=function(t){if(!this.gainNode)return this.logger.error("amu.sma.2 no mixing audio found"),!1;this.gainNode.gain.value=t},t.prototype.effectEndedHandler=function(){this.stopMixingAudio(),this.effectEndedCallBack&&this.effectEndedCallBack()},t}();n.audioMixUtil=l},function(t,n,i){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var l=function(){function t(){}return t.zegoSdp=function(t){var n=t.split("\r\n"),i=[],l=[];n.forEach(function(t){var n=t.match(/a=rtpmap:(\d+)\s+((H264\/90000)|(opus\/48000\/2))/);n&&n[1]&&n[2]&&("H264/90000"===n[2]&&i.push(n[1]),"opus/48000/2"===n[2]&&l.push(n[1]))});var p=[];return n.map(function(t){var n=!0,v=t.match(/((a=rtcp-fb:)|(a=rtpmap:)|(a=fmtp:))(\d+)/);if(v&&v[5]&&(i.concat(l).some(function(t){return t==v[5]})||(n=!1)),t.indexOf("m=video")>-1){var e=t.split(" ");t=[e[0],e[1],e[2]].concat(i).join(" ")}else if(t.indexOf("m=audio")>-1){e=t.split(" ");t=[e[0],e[1],e[2]].concat(l).join(" ")}n&&p.push(t)}),p.join("\r\n")},t.getSDPByVideDecodeType=function(t,n){var i={str:"",arr:[],obj:{H264:[],H265:[],VP8:[],VP9:[],OHTER:[]}};if(!t.includes("m=video"))return t;var l=/m=video.+/.exec(t)[0];l=l.match(/[\s|\d]+/g)[1].replace(" ",""),i.str=l,i.arr=i.str.split(" "),i.arr.forEach(function(n){var l=new RegExp("a=rtpmap:"+n+".+").exec(t)[0];l.includes("H264")?i.obj.H264.push(n):l.includes("H265")?i.obj.H265.push(n):l.includes("VP8")?i.obj.VP8.push(n):l.includes("VP9")?i.obj.VP9.push(n):i.obj.OHTER.push(n)}),i.obj.OHTER.forEach(function(n){var l=new RegExp("a=fmtp:"+n+".+apt=(\\d+)").exec(t),p=l&&l[1];p&&(i.obj.H264.includes(p)?i.obj.H264.push(n):i.obj.H265.includes(p)?i.obj.H265.push(n):i.obj.VP8.includes(p)?i.obj.VP8.push(n):i.obj.VP9.includes(p)&&i.obj.VP9.push(n))});var p=[];return"VP9"===n?p=i.obj.H265.concat(i.obj.H264,i.obj.VP8):"VP8"===n?p=i.obj.H265.concat(i.obj.H264,i.obj.VP9):"H264"===n?p=i.obj.H265.concat(i.obj.VP8,i.obj.VP9):"H265"===n&&(p=i.obj.VP8.concat(i.obj.H264,i.obj.VP9)),p.forEach(function(n){var l=i.arr.indexOf(n);i.arr.splice(l,1);var p=new RegExp("a=rtpmap:"+n+".+\\s\\n","g"),v=new RegExp("a=rtcp-fb:"+n+".+\\s\\n","g"),e=new RegExp("a=fmtp:"+n+".+\\s\\n","g");t=(t=(t=t.replace(p,"")).replace(v,"")).replace(e,"")}),t=t.replace(l,i.arr.join(" "))},t}();n.sdpUtil=l},function(t,n,i){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var l=function(){function t(t,n){this.RETRY_MAX_TIME=300,this.RETRY_START_TIME_INTERVAL=4,this.RETRY_CONTINUE_COUNT=2,this.RETRY_MAX_TIME_INTERVAL=32,this.retryStartTime=0,this.retryActiveCount=1,this.isOverTime=!1}return t.prototype.init=function(t,n,i,l){this.invalid(),this.stopMaxTime(),this.isOverTime=!1,"number"==typeof t&&t<3600&&(this.RETRY_MAX_TIME=t),"number"==typeof n&&(this.RETRY_START_TIME_INTERVAL=n),"number"==typeof i&&(this.RETRY_CONTINUE_COUNT=i),"number"==typeof l&&(this.RETRY_MAX_TIME_INTERVAL=l)},t.prototype.invalid=function(){this.retryTimer&&clearTimeout(this.retryTimer),this.retryTimer=null,this.retryStartTime=0,this.retryActiveCount=1},t}();n.TryHandler=l},function(t,n,i){"use strict";var l,p=this&&this.__extends||(l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var i in n)n.hasOwnProperty(i)&&(t[i]=n[i])},function(t,n){function i(){this.constructor=t}l(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}),v=this&&this.__assign||Object.assign||function(t){for(var n,i=1,l=arguments.length;i<l;i++)for(var p in n=arguments[i])Object.prototype.hasOwnProperty.call(n,p)&&(t[p]=n[p]);return t},e=this&&this.__awaiter||function(t,n,i,l){return new(i||(i=Promise))(function(p,v){function e(t){try{E(l.next(t))}catch(t){v(t)}}function T(t){try{E(l.throw(t))}catch(t){v(t)}}function E(t){t.done?p(t.value):new i(function(n){n(t.value)}).then(e,T)}E((l=l.apply(t,n||[])).next())})},T=this&&this.__generator||function(t,n){var i,l,p,v,e={label:0,sent:function(){if(1&p[0])throw p[1];return p[1]},trys:[],ops:[]};return v={next:T(0),throw:T(1),return:T(2)},"function"==typeof Symbol&&(v[Symbol.iterator]=function(){return this}),v;function T(v){return function(T){return function(v){if(i)throw new TypeError("Generator is already executing.");for(;e;)try{if(i=1,l&&(p=2&v[0]?l.return:v[0]?l.throw||((p=l.return)&&p.call(l),0):l.next)&&!(p=p.call(l,v[1])).done)return p;switch(l=0,p&&(v=[2&v[0],p.value]),v[0]){case 0:case 1:p=v;break;case 4:return e.label++,{value:v[1],done:!1};case 5:e.label++,l=v[1],v=[0];continue;case 7:v=e.ops.pop(),e.trys.pop();continue;default:if(!(p=(p=e.trys).length>0&&p[p.length-1])&&(6===v[0]||2===v[0])){e=0;continue}if(3===v[0]&&(!p||v[1]>p[0]&&v[1]<p[3])){e.label=v[1];break}if(6===v[0]&&e.label<p[1]){e.label=p[1],p=v;break}if(p&&e.label<p[2]){e.label=p[2],e.ops.push(v);break}p[2]&&e.ops.pop(),e.trys.pop();continue}v=n.call(t,e)}catch(t){v=[6,t],l=0}finally{i=p=0}if(5&v[0])throw v[1];return{value:v[0]?v[1]:void 0,done:!0}}([v,T])}}};Object.defineProperty(n,"__esModule",{value:!0});var E=i(0),R=i(1),S=i(7),L=i(9),M=i(2),u=i(3),h=i(19),f=i(29),U=i(30),O=function(t){function n(){var n=this,i=new S.LoggerWeb,l=new f.StateCenter,p=new("undefined"!=typeof webkitAudioContext?webkitAudioContext:AudioContext),v=new L.ZegoStreamCenterWeb(i,l,p);return(n=t.call(this)||this).ac=p,n.streamCenter=v,n.logger=i,n.stateCenter=l,n.audioMixing=new u.audioMixUtil(i,n.ac),n.init(),n.bindWindowListener(),n}return p(n,t),n.prototype.getSocket=function(t){return new WebSocket(t)},n.prototype.enableCamera=function(t,n){return this.logger.debug("zc.p.ec.0 call"),"boolean"!=typeof n?(this.logger.error("zc.p.ec.0 argument is not bool"),!1):this.streamCenter.enableCamera(t,n)},n.prototype.enableMicrophone=function(t,n){return this.logger.debug("zc.p.em.0 call"),"boolean"!=typeof n?(this.logger.error("zc.p.em.0 argument is not bool"),!1):this.streamCenter.enableMicrophone(t,n)},n.prototype.setLocalAudioOutput=function(t,n){return this.logger.debug("zc.p.slao call"),"string"!=typeof n?(console.error("audiooutput is not string"),!1):this.streamCenter.setStreamAudioOutput(t,n)},n.prototype.setPlayAudioOutput=function(t,n){return this.logger.debug("zc.p.spao call"),"string"!=typeof n?(console.error("audiooutput is not string"),!1):this.streamCenter.setPlayStreamAudioOutput(t,n)},n.prototype.setCustomSignalUrl=function(t){if(this.logger.debug("zc.p.scs.0 call: "+t),!t||0==t.length)return this.logger.error("zc.p.scs.0 param error"),!1;var n=!0;if(t.forEach(function(t){return 0!=t.indexOf("wss://")&&(n=!1)}),!n)return this.logger.error("zc.p.scs.0 url is not correct"),!1;this.stateCenter.customUrl=t},n.prototype.setQualityMonitorCycle=function(t){"number"==typeof t&&t>=1e3&&this.streamCenter.setQualityMonitorCycle(t)},n.prototype.startPlayingStream=function(t,n,i,l){var p=this;if(this.logger.info("zc.p.sps.0 call streamid "+t),!t||""===t)return this.logger.error("zc.p.sps.0 param error"),!1;if(!n)return this.logger.error("zc.p.sps.0 don't have remoteVideo"),!1;if(this.stateCenter.customUrl)return this.streamCenter.setPlayStateStart(t,n,i,l)?this.streamCenter.startPlayingStream(t,this.stateCenter.customUrl):(this.logger.error("zc.p.sps.0 cannot start play"),!1);if(!this.stateCenter.isLogin())return this.logger.error("zc.p.sps.0 not login"),!1;for(var v=!1,e=0;e<this.stateCenter.streamList.length;e++)if(this.stateCenter.streamList[e].stream_id===t){v=!0;break}if(0==v&&this.logger.info("zc.p.sps.0 cannot find stream"),this.stateCenter.pullLimited||(t=NaN+t),!this.streamCenter.setPlayStateStart(t,n,i,l))return this.logger.info("zc.p.sps.0 cannot start play"),!1;var T={stream_id:t,ptype:"pull",signals:this.streamCenter.getAllInUseUrl()};this.socketCenter.registerRouter("webrtc_url",function(t){p.handleFetchWebRtcUrlRsp(t)});var S=this.socketCenter.sendMessage("webrtc_url",T,void 0,function(n,i){n==E.sdkErrorList.SEND_MSG_TIMEOUT?p.onPlayStateUpdate(E.ENUM_PLAY_STATE_UPDATE.error,t,R.playErrorList.DISPATCH_TIMEOUT):p.onPlayStateUpdate(E.ENUM_PLAY_STATE_UPDATE.error,t,R.playErrorList.DISPATCH_ERROR),p.streamCenter.stopPlayingStream(t)});return this.streamCenter.playerList[t]&&(this.streamCenter.playerList[t].seq=S),!0},n.prototype.stopPlayingStream=function(t){if(this.logger.info("zc.p.sps.1.0 call"),!t||""===t)return this.logger.info("zc.p.sps.1.0 param error"),!1;this.streamCenter.playerList[t];for(var n in this.streamCenter.stopPlayingStream(t),this.stateCenter.streamUrlMap)if(this.stateCenter.streamUrlMap[n]===t){delete this.stateCenter.streamUrlMap[n];break}return this.logger.debug("zc.p.sps.1.0 call success"),!0},n.prototype.startPreview=function(t,n,i,l){if(this.logger.debug("zc.p.sp.0 call"),!t)return this.logger.error("zc.p.sp.0 no localVideo"),!1;if(n.audioBitRate){if("number"!=typeof n.audioBitRate)return void this.logger.error("zc.p.sp.0 audioBitRate must be number");if(n.audioBitRate<48e3)return void this.logger.error("zc.p.sp.0 audioBitRate cannot less 48000");this.stateCenter.audioBitRate=n.audioBitRate}return!!M.ClientUtil.checkPreviewParam(n,this.logger)&&this.streamCenter.startPreview(t,n,i,l)},n.prototype.stopPreview=function(t){return this.logger.debug("zc.p.sp.1 call"),t?this.streamCenter.stopPreview(t):(this.logger.info("zc.p.sp.1 param error"),!1)},n.prototype.startPublishingStream=function(t,n,i,l){var p=this;if(this.logger.info("zc.p.sps.1 call streamid: "+t),!t)return this.logger.error("zc.p.sps.1 param error"),!1;if(!this.streamCenter.checkPreview(n))return this.logger.error("zc.p.sps.1 need preview before publish"),!1;if(i&&("string"!=typeof i||""==i))return this.logger.error("zc.p.sps.1 extreaInfo must be string and not empty"),!1;if(l||(l={}),l.audioBitRate=this.stateCenter.audioBitRate,this.stateCenter.customUrl&&0!=this.stateCenter.customUrl.length)return this.stateCenter.publishStreamList[t]={state:E.ENUM_PUBLISH_STREAM_STATE.tryPublish,extra_info:i},this.streamCenter.setPublishStateStart(t,n,l)?this.streamCenter.startPublishingStream(t,this.stateCenter.customUrl):(this.logger.info("zc.p.sps.1 cannot start publish"),!1);if(!this.stateCenter.isLogin())return this.logger.error("zc.p.sps.1 not login"),!1;if(this.stateCenter.publishStreamList[t]={state:E.ENUM_PUBLISH_STREAM_STATE.tryPublish,extra_info:i},!this.streamCenter.setPublishStateStart(t,n,l))return this.logger.error("zc.p.sps.1 cannot start publish"),!1;this.logger.info("zc.p.sps.1 start publish");var v={stream_id:t,ptype:"push",signals:this.streamCenter.getAllInUseUrl(),header_kvs:[{key:"grpc-metadata-push",value:l&&l.cdnUrl||""}]};return this.socketCenter.registerRouter("webrtc_url",function(t){p.handleFetchWebRtcUrlRsp(t)}),this.socketCenter.sendMessage("webrtc_url",v,void 0,function(n,i){n==E.sdkErrorList.SEND_MSG_TIMEOUT?p.onPublishStateUpdate(E.ENUM_PUBLISH_STATE_UPDATE.error,t,R.publishErrorList.DISPATCH_TIMEOUT):p.onPublishStateUpdate(E.ENUM_PUBLISH_STATE_UPDATE.error,t,R.publishErrorList.DISPATCH_ERROR),p.streamCenter.stopPublishingStream(t)}),!0},n.prototype.stopPublishingStream=function(t){if(this.logger.info("zc.p.sps.1.1 call streamid: "+t),!t)return this.logger.info("zc.p.sps.1.1 param error"),!1;var n=this.streamCenter.publisherList[t];if(!n||0==n.serverUrls.length||!n.publisher.signal)return n&&this.logger.error("zc.p.sps.1.1 stream can not be destroyed when dispatching"),!1;if(this.streamCenter.stopPublishingStream(t),this.stateCenter.publishStreamList[t]){if(this.stateCenter.publishStreamList[t].state>=E.ENUM_PUBLISH_STREAM_STATE.update_info){this.streamHandler.updateStreamInfo(t,E.ENUM_STREAM_SUB_CMD.liveEnd);for(var i=0;i<this.stateCenter.streamList.length;i++)if(this.stateCenter.streamList[i].stream_id==t){this.stateCenter.streamList.splice(i--,1);break}}delete this.stateCenter.publishStreamList[t]}return!0},n.prototype.preloadEffect=function(t,n,i){var l=this;t&&"number"==typeof t&&n&&"string"==typeof n?this.stateCenter.audioEffectBuffer[t]?this.logger.error("zc.pe.0 audio buffer already exists"):this.audioMixing.preloadEffect(n,function(n,p){if(n)return l.logger.error("zc.pe.0 effect preload fail "+n),void(i&&i(n));p&&(l.stateCenter.audioEffectBuffer[t]=p,i&&i())}):this.logger.error("zc.pe.0 params error")},n.prototype.playEffect=function(t,n,i){if(t.streamId&&"string"==typeof t.streamId&&t.effectId&&"number"==typeof t.effectId)if(this.stateCenter.audioEffectBuffer[t.effectId]){var l=this.stateCenter.audioEffectBuffer[t.effectId],p=this.getPublisher(t.streamId);p?l?p.playEffect(t,l,n,i):this.logger.error("zc.pe.1 no audio buffer found"):this.logger.error("zc.pe.1 publisher doesn't exist")}else this.logger.error("zc,pe.1 audio buffer dosesn't exists");else this.logger.error("zc.pe.1 params error")},n.prototype.pauseEffect=function(t){if(t&&"string"==typeof t){var n=this.getPublisher(t);n?n.pauseEffect():this.logger.error("zc.pe.2 publisher doesn't exist")}else this.logger.error("zc.pe.2 streamid format error")},n.prototype.resumeEffect=function(t){if(t&&"string"==typeof t){var n=this.getPublisher(t);n?n.resumeEffect():this.logger.error("zc.re.0 publisher doesn't exist")}else this.logger.error("zc.re.0 streamid format error")},n.prototype.unloadEffect=function(t){return t&&"number"==typeof t?(delete this.stateCenter.audioEffectBuffer[t],!0):(this.logger.error("zc.ue.0 params error"),!1)},n.prototype.startMixingAudio=function(t,n,i){return this.logger.debug("zc.sma.0 call"),t&&"string"==typeof t?n?Array.isArray(n)&&0!==n.length?this.streamCenter.startMixingAudio(t,n):n instanceof HTMLMediaElement?this.streamCenter.startMixingAudio(t,[n]):(this.logger.error("zc.sma.0 audio param type error"),!1):(this.logger.error("zc.sma.0 no audio"),!1):(this.logger.error("zc.sma.0 stream id type error"),!1)},n.prototype.stopMixingAudio=function(t,n){return t&&"string"==typeof t?Array.isArray(n)&&0!==n.length||void 0===n?this.streamCenter.stopMixingAudio(t,n):(this.logger.error("zc.sma.0 audio param type error"),!1):(this.logger.error("zc.sma.1 param streamID format error"),!1)},n.prototype.mixingBuffer=function(t,n,i,l){var p=this.getPublisher(t);p?i instanceof ArrayBuffer?p.mixingBuffer(i,l):this.logger.error("zc.mb.0 array buffer not found"):this.logger.error("zc.mb.0 publisher doesn't exist")},n.prototype.stopMixingBuffer=function(t,n){if(!t||"string"!=typeof t)return this.logger.error("zc.sma.1 param streamid format error"),!1;var i=this.getPublisher(t);return i?i.stopMixingBuffer():(this.logger.error("zc.sma.1 publisher doesn't exist"),!1)},n.prototype.setMixingAudioVolume=function(t,n){if(this.logger.debug("zc.sma.2 call"),!t||"string"!=typeof t||"number"!=typeof n||n<0||n>100)return this.logger.error("zc.sma.2 param error"),!1;var i=this.getPublisher(t);return i?i.audioMixing.setMixingAudioVolume(n/100):(this.logger.error("zc.sma.2 publisher doesn't exist"),!1)},n.prototype.getPublisher=function(t){var n=null;return this.streamCenter.publisherList[t]&&this.streamCenter.publisherList[t].publisher&&(n=this.streamCenter.publisherList[t].publisher),n},n.prototype.startScreenShotChrome=function(t){if(!n.screenShotReady)return this.logger.error('zc.b.ss Please install the extension:1. Go to chrome://extensions  2. Check: "Enable Developer mode   3. Click: "Load the unpacked extension... 4. Choose "extension" folder from the repository 5. Reload this page'),!1;window.postMessage({type:"SS_UI_REQUEST",text:"start"},"*"),M.ClientUtil.registerCallback("screenShare",{success:t},this.stateCenter.callbackList)},n.prototype.startScreenSharing=function(t,n,i){var l=this;"getDisplayMedia"in navigator.mediaDevices?navigator.mediaDevices.getDisplayMedia({audio:n,video:{width:t.width||window.screen.width,height:t.height||window.screen.height,frameRate:t.frameRate||15,displaySurface:t.displaySurface||"minitor"}}).then(function(t){l.stateCenter.screenShotStreamList.push({stream:t,type:0}),t.getVideoTracks()[0].onended=function(){var n=l.stateCenter.screenShotStreamList.findIndex(function(n){return n.stream===t});n>-1&&l.stateCenter.screenShotStreamList.splice(n,1),l.onScreenSharingEnded(t)},i(!0,t)}).catch(function(t){l.logger.error("zc.b.sss "+t),i(!1,null,t)}):this.logger.error("zc.b.sss getDisplayMedia is not supported ")},n.prototype.startScreenShotFirFox=function(t,n,i,l){var p=this,v={video:{width:t.width||window.screen.width,height:t.height||window.screen.height,frameRate:t.frameRate||15},audio:i};v.video.mediaSource=n,navigator.mediaDevices.getUserMedia(v).then(function(t){p.stateCenter.screenShotStreamList.push({stream:t,type:0}),t.getVideoTracks()[0].onended=function(){var n=p.stateCenter.screenShotStreamList.findIndex(function(n){return n.stream===t});n>-1&&p.stateCenter.screenShotStreamList.splice(n,1),p.onScreenSharingEnded(t)},l(!0,t)}).catch(function(t){p.logger.error("zc.b.ssf "+t),l(!1,null)})},n.prototype.stopScreenShot=function(t){var n=this,i=[];void 0===t?i=this.stateCenter.screenShotStreamList.slice():i.push({stream:t,type:-1}),i.forEach(function(t){var i=n.stateCenter.screenShotStreamList.findIndex(function(n){return n.stream===t.stream});i>-1&&(t.stream.getTracks().forEach(function(t){t.stop()}),1===n.stateCenter.screenShotStreamList[i].type&&window.postMessage({type:"SS_UI_CANCEL",text:"start"},"*"),n.stateCenter.screenShotStreamList.splice(i,1))})},n.prototype.switchDevice=function(t,n,i,l,p){var v=this;"audio"!==t&&"video"!==t||"string"!=typeof i?this.logger.error("zg.sd.0 param error"):this.enumDevices(function(e){var T=e.cameras,E=e.microphones;T.find(function(t){return t.deviceId==i})||E.find(function(t){return t.deviceId==i})?v.streamCenter.switchDevice(t,n,i,l,p):v.logger.error("zg.sd.0 can not switch device")},function(t){return p&&p(t)})},n.prototype.WebrtcOnPublishStateUpdateHandle=function(t,n,i){this.stateCenter.publishStreamList[n].state==E.ENUM_PUBLISH_STREAM_STATE.publishing&&this.onPublishStateUpdate(t,n,i)},n.prototype.setCDNInfo=function(t,n){t.urls_flv=n.urls_flv,t.urls_hls=n.urls_m3u8,t.urls_https_flv=n.urls_https_flv,t.urls_https_hls=n.urls_https_m3u8,t.urls_rtmp=n.urls_rtmp},n.prototype.onScreenSharingEnded=function(t){},n.prototype.loginBodyData=function(){return{id_name:this.stateCenter.idName,nick_name:this.stateCenter.nickName,role:this.stateCenter.role,token:this.stateCenter.token,version:E.PROTO_VERSION,room_name:this.stateCenter.roomid,user_state_flag:this.stateCenter.userStateUpdate?1:0,room_create_flag:this.stateCenter.roomCreateFlag,client_type:E.E_CLIENT_TYPE.ClientType_Webrtc,third_token:this.stateCenter.third_token}},n.prototype.screenStreamFrom=function(t,n,i){var l=this,p={};p.audio={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t}},p.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxWidth:window.screen.width,maxHeight:window.screen.height}},!n&&(p.audio=!1),navigator.mediaDevices.getUserMedia(p).then(function(t){l.stateCenter.screenShotStreamList.push({stream:t,type:1}),t.getVideoTracks()[0].onended=function(){var n=l.stateCenter.screenShotStreamList.findIndex(function(n){return n.stream===t});n>-1&&l.stateCenter.screenShotStreamList.splice(n,1),l.onScreenSharingEnded(t)},i(!0,t)}).catch(function(t){l.logger.error("zc.b.ssf "+t),i(!1,null,t)})},n.prototype.filterStreamList=function(t){var n={},i={},l={},p=[],v=0;for(var e in this.stateCenter.streamList.forEach(function(n,i){n.stream_id==t&&(v=i)}),this.stateCenter.streamList[v])"urls_flv"!=e&&"urls_https_flv"!=e||(n[e]=this.stateCenter.streamList[v][e]),"urls_m3u8"!=e&&"urls_https_m3u8"!=e||(i[e]=this.stateCenter.streamList[v][e]),"urls_rtmp"==e&&(l[e]=this.stateCenter.streamList[v][e]);var T=window.location.protocol,E=window.navigator.userAgent;if(/Safari/.test(E)&&!/Chrome/.test(E))for(var e in i)i[e]&&i[e].forEach(function(t){-1!==t.indexOf(T)&&p.push(t)});else if("http:"==T)for(var e in n)n[e]&&n[e].forEach(function(t){-1===t.indexOf("http")&&-1===t.indexOf("https")||p.push(t)});else if("https:"==T)for(var e in n)n[e]&&n[e].forEach(function(t){-1!==t.indexOf(T)&&p.push(t)});else if("rtmp:"==T)for(var e in l)l[e]&&l[e].forEach(function(t){-1!==t.indexOf(T)&&p.push(t)});return p.filter(function(t,n,i){return i.indexOf(t)==n})},n.prototype.voiceChange=function(t,n){return t&&"number"==typeof t?n&&"string"==typeof n?this.getPublisher(n).voiceChange(t):(this.logger.error("zc.vc.0 stream id error"),!1):(this.logger.error("zc.vc.0 mult error"),!1)},n.prototype.voiceBack=function(t){return this.getPublisher(t).voiceBack()},n.prototype.setPublishStreamConstraints=function(t,n,i,l){this.logger.info("zc.spsc.0 call"),"string"==typeof t&&""!=t?this.streamCenter.setPublishStreamConstraints(t,n,i,l):this.logger.error("zc.spsc.0 stream ID must be string and not empty")},n.prototype.setSoundLevelDelegate=function(t,n){this.logger.info("zc.ssd.0 call"),"boolean"==typeof t?n&&("number"!=typeof n||n<100||n>3e3)?this.logger.error("zc.ssd.0 soundLevel interval must be number which is between 100 and 3000"):this.streamCenter.setSoundLevelDelegate(t,n):this.logger.error("zc.ssd.0 param 1 must be boolean")},n.supportDetection=function(t,n){navigator&&navigator.mediaDevices&&(this.screenShotReady||"getDisplayMedia"in navigator.mediaDevices)?M.ClientUtil.supportDetection(!0,t,n):M.ClientUtil.supportDetection(!1,t,n)},n.prototype.enumDevices=function(t,i){n.enumDevices(t,i)},n.enumDevices=function(t,n){void 0!==navigator.mediaDevices&&void 0!==navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then(function(n){for(var i=[],l=[],p=[],v=0;v<n.length;v++){var e=n[v];"audioinput"===e.kind&&i.push({label:e.label,deviceId:e.deviceId}),"audiooutput"===e.kind&&l.push({label:e.label,deviceId:e.deviceId}),"videoinput"===e.kind&&p.push({label:e.label,deviceId:e.deviceId})}t&&t({microphones:i,speakers:l,cameras:p})}).catch(function(t){n&&n(t)}):n&&n("browser don't support enumerate devices")},n.getAudioInfo=function(t,n,i){if(!t.srcObject)return console.error("srcObject is empty!"),!1;var l=v({},i);return new U.MediaUtil(l).connectToSource(t.srcObject,function(t){n(t)})},n.handleDataAvailable=function(t){t.data&&t.data.size>0&&n.recordedBlobs.push(t.data)},n.startRecord=function(t,i,l){return e(this,void 0,void 0,function(){var p,v;return T(this,function(e){switch(e.label){case 0:return n.recordedBlobs=[],v={mimeType:"video/webm;codecs=vp9"},MediaRecorder.isTypeSupported(v.mimeType)||(v={mimeType:"video/webm;codecs=vp8"},MediaRecorder.isTypeSupported(v.mimeType)||(v={mimeType:"video/webm"},MediaRecorder.isTypeSupported(v.mimeType)||(v={mimeType:""}))),i&&i.audio?(v={mimeType:"audio/webm"},MediaRecorder.isTypeSupported(v.mimeType)||(v={mimeType:""}),[4,navigator.mediaDevices.getUserMedia({audio:{deviceId:i.audioInput?i.audioInput:""}})]):[3,2];case 1:return p=e.sent(),n.recordType="audio",[3,3];case 2:p=t.captureStream(),e.label=3;case 3:try{n.mediaRecorder=new MediaRecorder(p,v)}catch(t){return console.error("Exception while creating MediaRecorder:",t),l&&l(t),[2]}return n.mediaRecorder.onstop=function(t){console.log("Recorder stopped: ",t),i&&i.audio&&p.getTracks().forEach(function(t){return t.stop()})},n.mediaRecorder.ondataavailable=n.handleDataAvailable,n.mediaRecorder.start(10),l&&l(),[2]}})})},n.stopRecord=function(){n.mediaRecorder?n.mediaRecorder.stop():console.warn("please invoke startRecord first")},n.resumeRecord=function(){n.mediaRecorder?n.mediaRecorder.resume():console.warn("please invoke startRecord first")},n.pauseRecord=function(){n.mediaRecorder?n.mediaRecorder.pause():console.warn("please invoke startRecord first")},n.saveRecord=function(t){if(n.mediaRecorder&&n.recordedBlobs){var i=new Blob(n.recordedBlobs,{type:"video"===n.recordType?"video/webm":"audio/webm"}),l=window.URL.createObjectURL(i);if("string"==typeof t&&""!==t){var p=document.createElement("a");p.style.display="none",p.href=l,p.download=t+".webm",document.body.appendChild(p),p.click(),setTimeout(function(){document.body.removeChild(p),window.URL.revokeObjectURL(l)},100)}return l}console.warn("please invoke startRecord first")},n.resumeRecordAudio=function(){n.mediaRecorder?n.mediaRecorder.resume():console.warn("please invoke startRecordAudio first")},n.pauseRecordAudio=function(){n.mediaRecorder?n.mediaRecorder.pause():console.warn("please invoke startRecordAudio first")},n.getRecordAudio=function(){if(n.mediaRecorder&&n.recordedBlobs){var t=new Blob(n.recordedBlobs);return window.URL.createObjectURL(t)}console.warn("please invoke startRecordAudio first")},n.takeSnapShot=function(t,n){if(t&&0!==t.videoHeight){var i=document.createElement("canvas");i.width=t.videoWidth,i.height=t.videoHeight,i.getContext("2d").drawImage(t,0,0,i.width,i.height),n.src=i.toDataURL("image/jpeg")}else console.error("video can not empty")},n.saveSnapShot=function(t,n){if(t&&0!==t.videoHeight){var i=document.createElement("canvas");i.width=t.videoWidth,i.height=t.videoHeight,i.getContext("2d").drawImage(t,0,0,i.width,i.height),i.toBlob(function(t){var i=window.URL.createObjectURL(t),l=document.createElement("a");l.style.display="none",l.href=i,l.download=n+".jpeg",document.body.appendChild(l),l.click(),setTimeout(function(){document.body.removeChild(l),window.URL.revokeObjectURL(i)},100)})}else console.error("video can not empty")},n.prototype.bindWindowListener=function(){var t=this,n=navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPhone/i)?"pagehide":"beforeunload";window.addEventListener(n,function(n){window.event.cancelBubble=!0,t.logout()}),window.addEventListener("message",function(n){var i=n.data,l=i.type,p=i.streamId,v=i.canRequestAudioTrack;n.origin;"SS_DIALOG_SUCCESS"===l&&t.screenStreamFrom(p,v,M.ClientUtil.actionSuccessCallback("screenShare",t.stateCenter.callbackList)),"SS_DIALOG_CANCEL"===l&&(t.logger.error("zc.b.ss "+l),M.ClientUtil.actionSuccessCallback("screenShare",t.stateCenter.callbackList)(!1,null,l))}),window.addEventListener("offline",function(n){for(var i in t.logger.info("zc.off.0 newtwork is broken"),t.stateCenter.networkState=E.ENUM_NETWORK_STATE.offline,t.stateCenter.roomTryHandler&&(t.stateCenter.roomTryHandler.invalid(),t.stateCenter.roomTryHandler.onactive=function(n,i){t.disconnectedHandle(i)},t.stateCenter.roomTryHandler.startMaxTime(),t.onTempBroken()),t.streamCenter.publisherList){(l=t.streamCenter.publisherList[i].streamTryHandler).startMaxTime(),l.invalid()}for(var i in t.streamCenter.playerList){var l;(l=t.streamCenter.playerList[i].streamTryHandler).startMaxTime(),l.invalid()}}),window.addEventListener("online",function(n){if(t.logger.info("zc.on.0 network is online"),t.stateCenter.networkState=E.ENUM_NETWORK_STATE.online,t.stateCenter.roomTryHandler&&t.socketCenter.isDisConnect())t.stateCenter.roomTryHandler.active();else if(t.stateCenter.roomTryHandler)for(var i in t.stateCenter.roomTryHandler.stopMaxTime(),t.streamCenter.publisherList)for(var l=t.streamCenter.publisherList[i].publisher,p=0;p<t.stateCenter.streamList.length;p++)if(l.state==E.ENUM_PUBLISH_STATE.stop&&t.stateCenter.streamList[p].stream_id==i){t.streamHandler.updateStreamInfo(i,E.ENUM_STREAM_SUB_CMD.liveEnd,t.stateCenter.publishStreamList[i].extra_info),t.stateCenter.streamList.splice(p--,1);break}for(var i in t.streamCenter.publisherList){l=t.streamCenter.publisherList[i].publisher;var v=t.streamCenter.publisherList[i].streamTryHandler;l.state==E.ENUM_PUBLISH_STATE.stop||l.stateNego!==E.ENUM_PUBLISH_STATE_NEGO.iceConnected?!v.isOverTime&&t.streamCenter.publishStateHandle(E.ENUM_PUBLISH_STATE_UPDATE.error,i,R.publishErrorList.NETWORK_BROKEN):l.state==E.ENUM_PUBLISH_STATE.publishing&&v.stopMaxTime()}for(var i in t.streamCenter.playerList){var e=t.streamCenter.playerList[i].player;v=t.streamCenter.playerList[i].streamTryHandler;e.state==E.ENUM_PLAY_STATE.stop||e.stateNego!==E.ENUM_PLAY_STATE_NEGO.iceConnected?!v.isOverTime&&t.streamCenter.playStateHandle(E.ENUM_PLAY_STATE_UPDATE.error,i,R.playErrorList.NETWORK_BROKEN):e.state==E.ENUM_PLAY_STATE.playing&&v.stopMaxTime()}})},n.screenShotReady=!1,n.recordType="video",n}(h.BaseCenter);n.ZegoClient=O,window.addEventListener("message",function(t){var n=t.data,i=n.type,l=(n.streamId,t.origin);l!==window.location.origin&&console.warn("ScreenStream: you should discard foreign event from origin:",l),"SS_PING"===i&&(O.screenShotReady=!0)})},function(t,n,i){"use strict";var l,p=this&&this.__extends||(l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var i in n)n.hasOwnProperty(i)&&(t[i]=n[i])},function(t,n){function i(){this.constructor=t}l(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)});Object.defineProperty(n,"__esModule",{value:!0});var v=i(8),e=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return p(n,t),n.prototype.openWebSocketLogServer=function(t){if(this.url!=t){if(this.url=t,!t)return;if(null!=this.websocket&&2!=this.websocket.readyState&&3!=this.websocket.readyState)return;this.stopWebSocketServer(),this.websocket=new WebSocket(t),this.websocket.onopen=function(t){},this.websocket.onclose=function(t){console.error("onclose   websocket error:",t)},this.websocket.onmessage=function(t){},this.websocket.onerror=function(t){console.error("open log websocket error:"+t)}}},n.prototype.SendHttpsLog=function(){var t=this;if(0!=this.logCacheSend.length){var n=this.logCacheSend.join("\n"),i=new XMLHttpRequest;i.onreadystatechange=function(){if(4==i.readyState)if(200==i.status){if(0==i.responseText.length)return;try{var n=JSON.parse(i.responseText).interval;"number"==typeof n&&t.logUploadInterval!==n&&(t.timeInterval=n,t.openHttpsLogServer(t.url))}catch(t){console.log("send result failed "+t)}}else console.log("send failed "+i.status)},i.open("POST",this.url,!0),i.send(n),this.logCacheSend=[]}},n.prototype.logReportParamList=function(t,n){var i=new Date,l=i.getFullYear()+"/";return l+=(v.D[i.getMonth()+1]||i.getMonth()+1)+"/",l+=(v.D[i.getDate()]||i.getDate())+" ",l+=(v.D[i.getHours()]||i.getHours())+":",l+=(v.D[i.getMinutes()]||i.getMinutes())+":",l+=v.D[i.getSeconds()]||i.getSeconds(),l+="."+i.getTime()%1e3,n.time=l,n.level=t,n.console="rtc",n.appid=this.appid,n.roomid=this.roomid,n.userid=this.userid,n.id_name=this.userid,n.userName=this.userName,n.sessionid=this.sessionid,n.version=this.version,[JSON.stringify(n)]},n}(v.Logger);n.LoggerWeb=e},function(t,n,i){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var l=i(0);n.D=["00","01","02","03","04","05","06","07","08","09"];var p=function(){function t(){this.logLevel=l.ENUM_LOG_LEVEL.info,this.logUploadTimer=null,this.logUploadInterval=1e4,this.logCache=[],this.logCacheSend=[],this.logCacheMax=100}return t.prototype.setLogLevel=function(t){this.logLevel<l.ENUM_LOG_LEVEL.debug||this.logLevel>l.ENUM_LOG_LEVEL.report?this.logLevel=l.ENUM_LOG_LEVEL.disable:this.logLevel=t},t.prototype.setRemoteLogLevel=function(t){this.logRemoteLevel<l.ENUM_LOG_LEVEL.debug||this.logRemoteLevel>l.ENUM_LOG_LEVEL.report?this.logRemoteLevel=l.ENUM_LOG_LEVEL.disable:this.logRemoteLevel=t},t.prototype.setSessionInfo=function(t,n,i,l,p,v){this.appid=t,this.roomid=n,this.sessionid=i,this.userid=l,this.userName=p,this.version=v},t.prototype.openLogServer=function(t){try{t.startsWith("wss:")?(this.logType=l.ENUM_REMOTE_TYPE.websocket,this.openWebSocketLogServer(t)):t.startsWith("https:")?(this.logType=l.ENUM_REMOTE_TYPE.https,this.openHttpsLogServer(t)):this.logType=l.ENUM_REMOTE_TYPE.disable}catch(t){this.error(JSON.stringify(t))}},t.prototype.stopLogServer=function(){this.logType==l.ENUM_REMOTE_TYPE.websocket?this.stopWebSocketServer():this.logType==l.ENUM_REMOTE_TYPE.https&&(this.SendHttpsLog(),this.stopHttpsServer()),this.logType=l.ENUM_REMOTE_TYPE.disable},t.prototype.stopWebSocketServer=function(){this.websocket&&(this.websocket.onclose=null,this.websocket.onerror=null,this.websocket.close(),this.websocket=null)},t.prototype.openHttpsLogServer=function(t){var n=this;this.url=t,t&&(this.stopHttpsServer(),this.logUploadTimer||(this.logUploadTimer=setInterval(function(){n.SendHttpsLog()},this.logUploadInterval)))},t.prototype.stopHttpsServer=function(){this.logUploadTimer&&(clearInterval(this.logUploadTimer),this.logUploadTimer=null)},t.prototype.report=function(t){var n=this.logReportParamList(l.ENUM_LOG_LEVEL.report,t);this.logLevel!==l.ENUM_LOG_LEVEL.disable&&this.logLevel<=l.ENUM_LOG_LEVEL.report&&console.debug.apply(console,n),this.RemoteLog(l.ENUM_LOG_LEVEL.report,n,!0)},t.prototype.debug=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var i=this.logParamList(l.ENUM_LOG_LEVEL.debug,t.join(""));this.logLevel!==l.ENUM_LOG_LEVEL.disable&&this.logLevel<=l.ENUM_LOG_LEVEL.debug&&console.debug.apply(console,i),this.log(l.ENUM_LOG_LEVEL.debug,i)},t.prototype.info=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var i=this.logParamList(l.ENUM_LOG_LEVEL.info,t.join(""));this.logLevel!==l.ENUM_LOG_LEVEL.disable&&this.logLevel<=l.ENUM_LOG_LEVEL.info&&console.info.apply(console,i),this.log(l.ENUM_LOG_LEVEL.info,i)},t.prototype.warn=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var i=this.logParamList(l.ENUM_LOG_LEVEL.warn,t.join(""));this.logLevel!==l.ENUM_LOG_LEVEL.disable&&this.logLevel<=l.ENUM_LOG_LEVEL.warn&&console.warn.apply(console,i),this.log(l.ENUM_LOG_LEVEL.warn,i)},t.prototype.error=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var i=this.logParamList(l.ENUM_LOG_LEVEL.error,t.join(""));this.logLevel!==l.ENUM_LOG_LEVEL.disable&&this.logLevel<=l.ENUM_LOG_LEVEL.error&&console.error.apply(console,i),this.log(l.ENUM_LOG_LEVEL.error,i)},t.prototype.log=function(t,n){this.logRemoteLevel!==l.ENUM_LOG_LEVEL.disable&&this.logRemoteLevel<=t&&this.RemoteLog(t,n)},t.prototype.RemoteLog=function(t,n,i){if(void 0===i&&(i=!1),""!=this.url)if(this.logType==l.ENUM_REMOTE_TYPE.websocket)this.RemoteWebSocketLog(t,n);else if(this.logType==l.ENUM_REMOTE_TYPE.https)this.RemoteHttpsLog(t,n,i);else if(this.logLevel!==l.ENUM_LOG_LEVEL.disable&&this.logLevel<=t)for(this.logCacheSend.push(n);this.logCacheSend.length>this.logCacheMax;)this.logCacheSend.shift()},t.prototype.RemoteWebSocketLog=function(t,n){if("string"==typeof n&&n.length>4e3)console.info("log over maximum, ignore");else if(null==this.websocket||2==this.websocket.readyState||3==this.websocket.readyState){var i=this.url;this.url="",this.openLogServer(i),this.logCacheSend.length<this.logCacheMax&&this.logCacheSend.push(n)}else if(0==this.websocket.readyState)this.logCacheSend.length<this.logCacheMax&&this.logCacheSend.push(n);else if(1==this.websocket.readyState)if(this.logCacheSend.length>0){for(var l="",p=0;p<this.logCacheSend.length;p++)(l+this.logCacheSend[p]).length>4e3&&(this.websocket.send(l),l=""),l=l+this.logCacheSend[p]+"\n";n=l+n,this.logCacheSend=[],this.websocket.send(n)}else this.websocket.send(n);else console.warn("wrong socket state:"+this.websocket.readyState),this.logCacheSend.length<this.logCacheMax&&this.logCacheSend.push(n)},t.prototype.RemoteHttpsLog=function(t,n,i){this.logCacheSend.push(n),(this.logCacheSend.length>=this.logCacheMax||!0===i)&&this.SendHttpsLog()},t.prototype.logParamList=function(t,i){var l=new Date,p=l.getFullYear()+"/";p+=(n.D[l.getMonth()+1]||l.getMonth()+1)+"/",p+=(n.D[l.getDate()]||l.getDate())+" ",p+=(n.D[l.getHours()]||l.getHours())+":",p+=(n.D[l.getMinutes()]||l.getMinutes())+":",p+=n.D[l.getSeconds()]||l.getSeconds(),p+="."+l.getTime()%1e3;var v=i.substr(0,i.indexOf(" "));0==v.length&&(v=i);var e=i.substr(i.indexOf(" ")+1,4500);0==e.length&&(e="");var T={time:p,level:t,action:v,content:e,appid:this.appid,roomid:this.roomid,userid:this.userid,userName:this.userName,sessionid:this.sessionid};return[JSON.stringify(T)]},t}();n.Logger=p},function(t,n,i){"use strict";var l,p=this&&this.__extends||(l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var i in n)n.hasOwnProperty(i)&&(t[i]=n[i])},function(t,n){function i(){this.constructor=t}l(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)});Object.defineProperty(n,"__esModule",{value:!0});var v=i(10),e=i(11),T=i(12),E=i(1),R=i(0),S=i(15),L=i(16),M=i(17),u=i(2),h=i(18),f=function(t){function n(n,i,l){var p=t.call(this,n,i)||this;return p.testEnvironment=!1,p.heartbeatTimer=null,p.heartbeatInterval=1e4,p.chargeInfos={itemtype:"ChargeInfos",timestamp_begin:0,timestamp_end:0,timestamp_diff_flag:0,timestamp_diff:0,infos:[]},p.chargeInfosTimer=null,p.chargeInfosInterval=6e4,p.qualityTimerInterval=3e3,p.previewVideoList=[],p.signalList={},p.deviceStates={camera:0,microphone:0},p.soundLevelDelegate=!1,p.soundLevelInterval=1e3,p.soundLevelTimer=null,p.tryCountConnectInterval=3e3,p.checkMessageTimeout=function(){for(var t in p.signalList)p.signalList[t].signal&&p.signalList[t].signal.checkMessageTimeout()},p.getAllInUseUrl=function(){var t=[];for(var n in p.signalList)t.push(n);return t},p.onDisconnectHandle=function(t){if(p.logger.info("zsc.od.0 call"),p.signalList[t]){var n=p.signalList[t];delete p.signalList[t];for(var i=0;i<n.publishConnectedList.length;i++){var l=p.publisherList[n.publishConnectedList[i]];l&&l.publisher&&l.publisher.onDisconnect()}for(i=0;i<n.playConnectedList.length;i++){var v=p.playerList[n.playConnectedList[i]];v&&v.player&&v.player.onDisconnect()}p.stopSignalHeartbeat(),p.stopChargeInfosUpload(),p.stopSoundLevel()}},p.logger=n,p.stateCenter=i,p.dataReport=new v.ZegoDataReport(p.logger),p.ac=l,p}return p(n,t),n.prototype.onSignalDisconnected=function(t){},n.prototype.setQualityMonitorCycle=function(t){this.logger.debug("zsc.qmc.0 timeInterval "+t),this.qualityTimerInterval=t},n.prototype.setSessionInfo=function(t,n,i,l){this.logger.debug("zsc.ssi.0 called"),this.appid=t,this.userid=n,this.token=i,this.testEnvironment=l},n.prototype.onPlayStateUpdate=function(t,n,i){},n.prototype.onPlayQualityUpdate=function(t,n){},n.prototype.onPublishStateUpdate=function(t,n,i){},n.prototype.onPublishQualityUpdate=function(t,n){},n.prototype.onUpdateHeartBeartIntervalHandle=function(t){t!=this.heartbeatInterval&&(this.logger.debug("zsc.uhb.0 update "+t),this.heartbeatTimer&&(clearTimeout(this.heartbeatTimer),this.heartbeatTimer=null),this.heartbeatInterval=t,this.startSignalHeartbeat())},n.prototype.switchDevice=function(t,n,i,l,p){var v,e,T,R,S,L,M=this,u=null,h=/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent);if(v=this.checkPreview(n)){delete(e=v.mediaStreamConfig).facingMode,"video"===t?(e.videoInput=i,R=n.srcObject.getVideoTracks()[0]):(e.audioInput=i,R=n.srcObject.getAudioTracks()[0]),!h&&R.stop();var f=v.getMediaStreamConstraints(e);navigator.mediaDevices.getUserMedia(f).then(function(i){for(var p in"video"===t?(S=i.getVideoTracks()[0],v.localStream.removeTrack(v.localStream.getVideoTracks()[0])):(S=i.getAudioTracks()[0],v.localStream.removeTrack(v.localStream.getAudioTracks()[0])),M.publisherList)M.publisherList[p].localVideo===n&&(L=p);L&&(u=M.publisherList[L].publisher,(T=u.peerConnection.getSenders().find(function(t){return t.track.kind===S.kind}))?T.replaceTrack(S):M.logger.warn("zg.sd.0 no sender found, only swithcing device on localMediaElement")),v.localStream.addTrack(S),u.signal.sendStreamStatus(E.getSeq(),u.sessionId,v.localStream.getVideoTracks()[0].enabled?0:2,v.localStream.getAudioTracks()[0].enabled?0:2),l&&l()},function(t){return p&&p(t)})}else this.logger.error("zg.sd.0 no preview found")},n.prototype.enableMicrophone=function(t,n){var i=this.checkPreview(t);return i?i.enableMicrophone(n,this):(this.logger.info("zsc.em.0 no preview"),!1)},n.prototype.enableCamera=function(t,n){var i=this.checkPreview(t);return i?i.enableCamera(n,this):(this.logger.error("zsc.ec.0 no preview"),!1)},n.prototype.recordDevices=function(t){var n=this,i=this.checkPreview(t);i?(this.logger.info("zsc.rd.0 call"),u.ClientUtil.getDevices(function(t){n.stateCenter.deviceInfos={microphones:t.microphones,speakers:t.speakers,cameras:t.cameras}},function(t){n.logger.warn("zsc.rd.0 getDevices err:",t)}),this.videoDeviceName=0!==i.localStream.getVideoTracks().length?i.localStream.getVideoTracks()[0].label:"",this.audioDeviceName=0!==i.localStream.getAudioTracks().length?i.localStream.getAudioTracks()[0].label:"",navigator.mediaDevices&&void 0!==navigator.mediaDevices.ondevicechange&&(navigator.mediaDevices.ondevicechange=function(i){n.logger.info("zsc.rd.0 devicechange"),n.stateCenter.deviceChangeTimer&&(clearTimeout(n.stateCenter.deviceChangeTimer),n.stateCenter.deviceChangeTimer=null),n.stateCenter.deviceChangeTimer=setTimeout(function(){u.ClientUtil.getDevices(function(i){var l,p=!1;for(var v in i.cameras.find(function(t){return t.deviceName===n.videoDeviceName})?n.deviceStates.camera=0:(n.deviceStates.camera=-6,p=!0,n.onDeviceError({deviceName:n.videoDeviceName,deviceType:"camera",errorCode:-6})),i.microphones.find(function(t){return t.deviceName===n.audioDeviceName})?n.deviceStates.microphone=0:(n.deviceStates.microphone=-6,p=!0,n.onDeviceError({deviceName:n.audioDeviceName,deviceType:"microphone",errorCode:-6})),n.publisherList)n.publisherList[v].localVideo===t&&(l=v);if(p&&l){var e=n.getPublisher(l);e.signal.sendStreamStatus(E.getSeq(),e.sessionId,n.deviceStates.camera,n.deviceStates.microphone)}var T=n.stateCenter.deviceInfos.cameras.filter(function(t){return!i.cameras.find(function(n){return n.deviceID===t.deviceID})}),R=n.stateCenter.deviceInfos.microphones.filter(function(t){return!i.microphones.find(function(n){return n.deviceID===t.deviceID})}),S=n.stateCenter.deviceInfos.speakers.filter(function(t){return!i.speakers.find(function(n){return n.deviceID===t.deviceID})}),L=i.cameras.filter(function(t){return!n.stateCenter.deviceInfos.cameras.find(function(n){return n.deviceID===t.deviceID})}),M=i.microphones.filter(function(t){return!n.stateCenter.deviceInfos.microphones.find(function(n){return n.deviceID===t.deviceID})}),u=i.speakers.filter(function(t){return!n.stateCenter.deviceInfos.speakers.find(function(n){return n.deviceID===t.deviceID})});T.forEach(function(t){var i={deviceInfo:t,state:"DELETE"};n.OnVideoDeviceStateChanged(i)}),R.forEach(function(t){var i={deviceType:"Input",deviceInfo:t,state:"DELETE"};n.OnAudioDeviceStateChanged(i)}),S.forEach(function(t){var i={deviceType:"Output",deviceInfo:t,state:"DELETE"};n.OnAudioDeviceStateChanged(i)}),L.forEach(function(t){var i={deviceInfo:t,state:"ADD"};n.OnVideoDeviceStateChanged(i)}),M.forEach(function(t){var i={deviceType:"Input",deviceInfo:t,state:"ADD"};n.OnAudioDeviceStateChanged(i)}),u.forEach(function(t){var i={deviceType:"Output",deviceInfo:t,state:"ADD"};n.OnAudioDeviceStateChanged(i)}),n.stateCenter.deviceInfos={microphones:i.microphones,speakers:i.speakers,cameras:i.cameras}},function(t){n.logger.warn("zsc.rd.0 getDevices err:",t)})},10)})):this.logger.error("zsc.rd.0 no localVideo found")},n.prototype.startPreview=function(t,n,i,l){var p=this;if(!t)return this.logger.error("zsc.sp.0 localVideo null"),!1;var v=this.checkPreview(t);return v?(this.logger.warn("zsc.sp.0 localvideo already exist"),!0):(v=new e.ZegoPreview(this.logger),this.previewVideoList.push(v),v.startPreview(t,n,function(){p.logger.debug("zsc.sp.0 call success"),p.recordDevices(t),i&&i()},function(t){p.previewVideoList=p.previewVideoList.filter(function(t){return t!==v}),l&&l(t)}),!0)},n.prototype.stopPreview=function(t){if(!t)return this.logger.warn("zsc.sp.0 localVideo null"),!1;for(var n in this.publisherList)this.publisherList[n].localVideo===t&&(this.publisherList[n].localVideo=null);var i=this.checkPreview(t);return i?(i.previewSuc&&(i.stopPreview(),this.removePreview(i)),!0):(this.logger.warn("zsc.sp.0 no preview"),!1)},n.prototype.setPublishStateStart=function(t,n,i){var l=this;if(this.publisherList[t])return this.logger.error("zsc.pss.0 publisher already exist"),!1;var p=new T.ZegoPublish(this.logger,null,this.dataReport,this.qualityTimerInterval,this);return p.onPublishStateUpdate=function(n,i,p,v){var e=l.publisherList[i];e?l.publishStateHandle(n,e.streamId,p,v):l.logger.error("zsc.psuh.0 cannot find publish "+t)},p.onPublishQualityUpdate=function(n,i){var p=l.publisherList[n];p?l.onPublishQualityUpdate(p.streamId,i):l.logger.error("zsc.psuh.0 cannot find publish "+t)},p.localVideo=n,this.publisherList[t]={localVideo:n,publisher:p,serverUrls:[],streamId:t,playOption:i,streamTryHandler:new h.TryStreamHandler(this.logger,this.stateCenter)},this.dataReport.eventStart(p.reportSeq,"GetSignalUrl"),!0},n.prototype.startPublishingStream=function(t,n,i){this.logger.info("zsc.sps.0 call");var l=this.publisherList[t];if(!l)return this.logger.error("zsc.sps.0 publisher don't exist"),!1;var p=l.publisher;if(this.dataReport.eventEndWithMsg(p.reportSeq,"GetSignalUrl",{urls:n}),!n||0===n.length)return this.publishStateHandle(E.ENUM_PUBLISH_STATE_UPDATE.error,t,E.publishErrorList.DISPATCH_ERROR),this.logger.info("zsc.sps.0 server don't have signal url"),!1;l.serverUrls=l.serverUrls.concat(n);var v=n.indexOf(this.server);-1!==v&&(l.serverUrls.splice(v,1),l.serverUrls.unshift(this.server));var e=l.streamTryHandler;e.invalid(),e.init(this.stateCenter.streamRetryTime),e.initStream(this,!0,t,n),e.active(0)},n.prototype.updateWaitingList=function(t,n,i,l,p){n?t.publishWaitingList.push({streamId:i,success:l,error:p}):t.playWaitingList.push({streamId:i,success:l,error:p})},n.prototype.publishStream=function(t){var n=this.publisherList[t].publisher;if(n){var i=null,l=null,p=this.publisherList[t].playOption,v=this.checkPreview(this.publisherList[t].localVideo);v&&(i=v.localStream,l=v.videoInfo),i?(this.logger.debug("zsc.ps.0 call success"),n.startPublish(t,i,l,v.mediaStreamConfig,p)):this.logger.error("zsc.ps.0 no localStream found before publish")}else this.logger.info("zsc.ps.0 publisher don't exist")},n.prototype.connectPublishServer=function(t,n){var i=this,l=this.publisherList[t];return l?(this.dataReport.eventStart(l.publisher.reportSeq,"ConnectServer"),this.connetWithReuseSignalServer(t,!0,n,function(t,n,l){var p=i.publisherList[t];if(p){var v=p.publisher;if(v){i.dataReport.eventEndWithMsg(v.reportSeq,"ConnectServer",{result:0,server:l});var e=n.tokenInfo;i.logger.info("zsc.cps.0 update token success"),e&&e.report&&(v.qualityUpload=e.report,v.qualityUploadInterval=e.report_interval),v.signal=n.signal,i.server=l,i.publishStream(t),i.getTokenSuccess()}else i.logger.info("zsc.cps.1 check publisher don't exist")}else i.logger.info("zsc.cps.0 after connect publisher don't exist")},function(t,n){i.logger.error("zsc.cps.0 "+t+" connect fail "+n),i.publisherList[t]?i.publishStateHandle(E.ENUM_PUBLISH_STATE_UPDATE.error,t,E.publishErrorList.CONNECT_FAILED):i.logger.info("zsc.cps.0 after connect publisher don't exist")}),!0):(this.logger.error("zsc.cps.0 publisher don't exist"),!1)},n.prototype.getTokenSuccess=function(){this.logger.debug("zsc.gts.0 call")},n.prototype.stopPublishingStream=function(t){var n=this.publisherList[t];if(n){var i=n.streamTryHandler;for(var l in i&&(i.stopMaxTime(),i.invalid()),this.signalList)this.signalList[l].publishWaitingList=this.signalList[l].publishWaitingList.filter(function(n){return n.streamId!==t});delete this.publisherList[t],n.publisher&&(n.publisher.stopPublish(),delete n.publisher),this.removeStreamFromSignal(!0,t),this.stopSignalHeartbeat(),this.stopChargeInfosUpload(),this.stopSoundLevel(),this.logger.debug("zsc.sps.0.1 call success")}else this.logger.warn("zsc.sps.0.1 publisher don't exist")},n.prototype.setPlayStreamAudioOutput=function(t,n){if(null!=n&&0!=n.length){this.logger.debug("zsc.psao.1 device "+n);var i=this.playerList[t];return i?i.player?i.player.setAudioDestination(n):(this.logger.info("zsc.psao.1 player don't exist"),!1):(this.logger.info("zsc.psao.1 play don't exist"),!1)}return!1},n.prototype.setStreamAudioOutput=function(t,n){var i=this;return!(null==n||0==n.length||!t)&&(this.logger.debug("zsc.ssao.0 device "+n),t?"undefined"!==t.sinkId?(t.setSinkId(n).then(function(){i.logger.info("zsc.ssao.0 success device: "+n)}).catch(function(t){i.logger.info("zsc.ssao.0 "+t.name)}),!0):(this.logger.error("zsc.ssao.0 browser does not suppport"),!1):(this.logger.error("zsc.ssao.0 no localVideo"),!1))},n.prototype.connetWithReuseSignalServer=function(t,n,i,l,p){var v=this;this.logger.info("zsc.crss.0 begin "+i);var e=null;if(this.signalList[i])(e=this.signalList[i]).state==R.ENUM_SIGNAL_STATE.connected?(this.logger.info("zsc.crss.0 already connected "+i+" streamId: "+t),n?e.publishConnectedList.push(t):e.playConnectedList.push(t),l(t,e,i)):e.state==R.ENUM_SIGNAL_STATE.connecting&&(this.logger.debug("zsc.crss.0 signal is connecting "+i+" streamId: "+t),this.updateWaitingList(e,n,t,l,p));else{this.logger.info("zsc.crss.0 new signal "+i+" streamId: "+t);var T=new S.ZegoSignal(this.logger,this.stateCenter);T.setSessionInfo(this.appid,this.userid),T.onUpdateHeartBeartInterval=this.onUpdateHeartBeartIntervalHandle.bind(this),T.onDisconnect=this.onDisconnectHandle,this.signalList[i]={signal:T,state:R.ENUM_SIGNAL_STATE.connecting,publishWaitingList:[],playWaitingList:[],publishConnectedList:[],playConnectedList:[],tokenInfo:null,isTimeOut:!1},this.updateWaitingList(this.signalList[i],n,t,l,p),T.connectServer(this.token,i,function(t,n,l){(e=v.signalList[i]).isTimeOut&&(v.logger.error("zsc.crss.0 connected "+n+" over time"),T.disconnectServer(),delete v.signalList[i]);var p,E,S=0;if(0!=t){for(v.logger.debug("zsc.crss.0 connect failed "+n),S=0;S<e.publishWaitingList.length;S++)(p=e.publishWaitingList[S]).error&&p.error(p.streamId,t);for(S=0;S<e.playWaitingList.length;S++)(E=e.playWaitingList[S]).error&&E.error(E.streamId,t);delete v.signalList[i]}else{for(v.logger.debug("zsc.crss.0 connected success "+n),e.state=R.ENUM_SIGNAL_STATE.connected,e.tokenInfo=l,S=0;S<e.publishWaitingList.length;S++)(p=e.publishWaitingList[S]).success&&p.success(p.streamId,e,n),e.publishConnectedList.push(p.streamId);for(S=0;S<e.playWaitingList.length;S++)(E=e.playWaitingList[S]).success&&E.success(E.streamId,e),e.playConnectedList.push(E.streamId,n);e.publishWaitingList=[],e.playWaitingList=[],null==v.heartbeatTimer&&v.startSignalHeartbeat(),null==v.chargeInfosTimer&&v.startChargeInfosUpload(),null==v.soundLevelTimer&&v.soundLevelDelegate&&v.startSoundLevel()}})}},n.prototype.setPlayStateStart=function(t,n,i,l){var p=this;if(this.playerList[t])return this.logger.warn("zsc.pss.1 player already exist"),!1;var v=new L.ZegoPlayWeb(this.logger,null,this.dataReport,this.qualityTimerInterval,this);return v.onVideoSizeChanged=this.onVideoSizeChanged,this.playerList[t]={seq:0,player:v,remoteVideo:n,audioOutput:i,signal:null,serverUrls:[],streamId:t,playOption:l,streamTryHandler:new h.TryStreamHandler(this.logger,this.stateCenter)},v.onPlayStateUpdate=function(t,n,i,l){var v=p.playerList[n];v?p.playStateHandle(t,v.streamId,i,l):p.logger.error("zsc.pss.1 cannot find play "+n)},v.onPlayQualityUpdate=function(t,n){var i=p.playerList[t];i?p.onPlayQualityUpdate(i.streamId,n):p.logger.error("zsc.pss.1 cannot find play "+t)},v.onRemoteCameraStatusUpdate=function(t,n){var i=p.playerList[t];i?p.onRemoteCameraStatusUpdate(i.streamId,n):p.logger.error("zsc.pss.1 cannot find play "+t)},v.onRemoteMicStatusUpdate=function(t,n){var i=p.playerList[t];i?p.onRemoteMicStatusUpdate(i.streamId,n):p.logger.error("zsc.pss.1 cannot find play "+t)},this.dataReport.eventStart(v.reportSeq,"GetSignalUrl"),!0},n.prototype.startPlayingStream=function(t,n,i){this.logger.info("zsc.sps.1 start play called");var l=this.playerList[t];if(!l)return this.logger.error("zsc.sps.1 player don't exist"),!1;var p=l.player;if(this.dataReport.eventEndWithMsg(p.reportSeq,"GetSignalUrl",{urls:n}),0==n.length)return this.playStateHandle(E.ENUM_PLAY_STATE_UPDATE.error,t,E.playErrorList.DISPATCH_ERROR),this.logger.info("zsc.sps.1 server don't have signal url"),!1;l.serverUrls=l.serverUrls.concat(n);var v=n.indexOf(this.server);-1!==v&&(l.serverUrls.splice(v,1),l.serverUrls.unshift(this.server));var e=l.streamTryHandler;e.invalid(),e.init(this.stateCenter.streamRetryTime),e.initStream(this,!1,t,n),e.active(0)},n.prototype.connectPlayServer=function(t,n){var i=this,l=this.playerList[t];return l?(this.dataReport.eventStart(l.player.reportSeq,"ConnectServer"),this.connetWithReuseSignalServer(t,!1,n,function(t,n,l){var p=i.playerList[t];if(p){var v=p.player;if(v){i.dataReport.eventEndWithMsg(v.reportSeq,"ConnectServer",{result:0,server:l});var e=n.tokenInfo;i.logger.info("zsc.cps.1 update token success"),e&&e.report&&(v.qualityUpload=e.report,v.qualityUploadInterval=e.report_interval),v.signal=n.signal,i.server=l,i.playStream(t),i.getTokenSuccess()}else i.logger.error("zsc.cps.1 checkplayer don't exist")}else i.logger.error("zsc.cps.1 after connect player don't exist")},function(t,n){i.playerList[t]?i.playStateHandle(E.ENUM_PLAY_STATE_UPDATE.error,t,E.playErrorList.CONNECT_FAILED):i.logger.error("zsc.cps.1 after connect player don't exist")}),!0):(this.logger.error("zsc.cps.1 player don't exist"),!1)},n.prototype.playStream=function(t){var n=this.playerList[t].player;n?(this.logger.info("zsc.ps.1 call success"),n.startPlay(t,this.playerList[t].remoteVideo,this.playerList[t].audioOutput,this.playerList[t].playOption)):this.logger.warn("zsc.ps.1 player don't exist")},n.prototype.removeStreamFromSignal=function(t,n){var i=[];for(var l in this.signalList){var p=this.signalList[l];if(t){for(var v=0;v<p.publishConnectedList.length;v++)if(p.publishConnectedList[v]===n){this.logger.debug("zsc.rsfs.0 found from publish"),p.publishConnectedList.splice(v,1);break}for(v=0;v<p.publishWaitingList.length;v++)if(p.publishWaitingList[v].streamId===n){this.logger.debug("zsc.rsfs.0 found from publish"),p.publishWaitingList.splice(v,1);break}}else{for(var e=0;e<p.playConnectedList.length;e++)if(p.playConnectedList[e]===n){this.logger.debug("zsc.rsfs.0 found from play"),p.playConnectedList.splice(e,1);break}for(e=0;e<p.playWaitingList.length;e++)if(p.playWaitingList[e].streamId===n){this.logger.debug("zsc.rsfs.0 found from play"),p.playWaitingList.splice(e,1);break}}0==p.publishConnectedList.length&&0==p.playConnectedList.length&&0==p.publishWaitingList.length&&0==p.playWaitingList.length&&(p.signal.disconnectServer(),i.push(l))}for(var T=0;T<i.length;T++)delete this.signalList[i[T]]},n.prototype.stopSignalHeartbeat=function(){this.logger.debug("zsc.ssh.1 call");var t=0;for(var n in this.signalList)t+=1;this.heartbeatTimer&&0==t&&(this.logger.info("zsc.ssh.1 stop"),clearTimeout(this.heartbeatTimer),this.heartbeatTimer=null)},n.prototype.stopChargeInfosUpload=function(){this.logger.debug("zsc.sciu.0 call");var t=0;for(var n in this.signalList)t+=1;this.chargeInfosTimer&&0==t&&(this.logger.info("zsc.sciu.0 stop"),clearTimeout(this.chargeInfosTimer),this.chargeInfosTimer=null)},n.prototype.getPublisher=function(t){var n=null;return this.publisherList[t]&&this.publisherList[t].publisher&&(n=this.publisherList[t].publisher),n},n.prototype.publishStateHandle=function(t,n,i,l){this.logger.info("zsc.psh.0 call "+n);var p=this.publisherList[n].streamTryHandler,v=l||p.RETRY_MAX_TIME<3;if(i){!p.maxTimer&&!v&&p.startMaxTime();var e=this.publisherList[n].publisher;if(this.stateCenter.publishStreamList[n].state=R.ENUM_PUBLISH_STREAM_STATE.tryPublish,i.code===E.publishErrorList.SESSION_CLOSED.code||e.stateNego!=R.ENUM_PUBLISH_STATE_NEGO.iceConnected||l){var T=e.streamId,S=e.localStream,L=e.videoInfo,M=e.mediaStreamConfig,u=e.playOption;if(e.resetPublish(),0!=e.sessionId&&e.signal&&e.shouldSendCloseSession(i)&&(e.signal.sendCloseSession(E.getSeq(),e.sessionId,1),e.signal.removeSession(e.sessionId),e.closeSessionSignal=!0),!v&&!p.retryNextSignal(i))return void e.startPublish(T,S,L,M,u)}else this.logger.info("zsc.psh.0 ice is connected");this.removeStreamFromSignal(!0,n)}if(v)return p.stopMaxTime(),p.invalid(),void this.onPublishStateUpdate(t,n,i);i&&p.active(null)&&this.onPublishStateUpdate(2,n,i),this.logger.info("zsc.psh.0 end "+n)},n.prototype.playStateHandle=function(t,n,i,l){this.logger.info("zsc.psh.1 call "+n);var p=this.playerList[n].streamTryHandler,v=l||p.RETRY_MAX_TIME<3;if(i){!p.maxTimer&&!v&&p.startMaxTime();var e=this.playerList[n].player;if(i.code===E.playErrorList.SESSION_CLOSED.code||e.stateNego!=R.ENUM_PUBLISH_STATE_NEGO.iceConnected||l){var T=e.streamId,S=e.remoteVideo,L=e.audioOutput,M=e.playOption;if(e.resetPlay(),0!=e.sessionId&&e.signal&&e.shouldSendCloseSession(i)&&(e.signal.sendCloseSession(E.getSeq(),e.sessionId,1),e.signal.removeSession(e.sessionId),e.closeSessionSignal=!0),!v&&!p.retryNextSignal(i))return void e.startPlay(T,S,L,M)}else this.logger.info("zsc.psh.1 ice is connected");this.removeStreamFromSignal(!0,n)}if(v)return p.stopMaxTime(),p.invalid(),void this.onPlayStateUpdate(t,n,i);i&&p.active(null)&&this.onPlayStateUpdate(2,n,i),this.logger.info("zsc.psh.1 end "+n)},n.prototype.stopPlayingStream=function(t){var n=this.playerList[t];if(n){var i=n.streamTryHandler;for(var l in i&&(i.stopMaxTime(),i.invalid()),this.signalList)this.signalList[l].playWaitingList=this.signalList[l].playWaitingList.filter(function(n){return n.streamId!==t});delete this.playerList[t],n.player&&(n.player.stopPlay(),delete n.player),this.removeStreamFromSignal(!1,t),this.stopSignalHeartbeat(),this.stopChargeInfosUpload(),this.stopSoundLevel(),this.logger.debug("zsc.sps.1.1 call success")}else this.logger.info("zsc.sps.1.1 player don't exist")},n.prototype.reset=function(){for(var t in this.publisherList){(i=this.publisherList[t].streamTryHandler)&&(i.stopMaxTime(),i.invalid()),this.publisherList[t].publisher&&this.publisherList[t].publisher.stopPublish()}for(var n in this.playerList){var i;(i=this.playerList[n].streamTryHandler)&&(i.stopMaxTime(),i.invalid()),this.playerList[n].player&&this.playerList[n].player.stopPlay()}for(var l in this.signalList)this.signalList[l].signal&&this.signalList[l].signal.disconnectServer();this.playerList={},this.publisherList={},this.signalList={},this.server="",this.heartbeatTimer&&(clearTimeout(this.heartbeatTimer),this.heartbeatTimer=null)},n.prototype.startSignalHeartbeat=function(){var t=this;this.logger.debug("zsc.ssh.0 call"),this.heartbeatTimer&&(clearTimeout(this.heartbeatTimer),this.heartbeatTimer=null),this.heartbeatTimer=setTimeout(function(){t.checkSignalHeartbeat()},this.heartbeatInterval)},n.prototype.checkSignalHeartbeat=function(){for(var t in this.logger.debug("zsc.csh.0 call"),this.signalList)this.signalList[t].signal&&this.signalList[t].signal.sendHeartbeat();this.heartbeatTimer&&this.startSignalHeartbeat()},n.prototype.startChargeInfosUpload=function(){var t=this;this.logger.debug("zsc.sciu.0 call"),this.chargeInfosTimer&&(clearTimeout(this.chargeInfosTimer),this.chargeInfosTimer=null),this.chargeInfosTimer=setTimeout(function(){t.checkChargeInfos()},this.chargeInfosInterval)},n.prototype.checkChargeInfos=function(){this.logger.debug("zsc.cci.0 call");var t={is_publishing:0,play_max_audio_bitrate:0,play_stream_resolution_infos:[]};for(var n in this.chargeInfos.timestamp_begin=(new Date).getTime(),this.publisherList){this.publisherList[n].publisher.state===R.ENUM_PUBLISH_STATE.publishing&&(t.is_publishing=1);break}t.play_max_audio_bitrate=0;var i=function(n){var i=l.playerList[n].remoteVideo,p={video_width:i.videoWidth||0,video_height:i.videoHeight||0,count:1};if(!t.play_stream_resolution_infos.find(function(t){return t.video_width==p.video_width&&t.video_height==p.video_height&&(t.count++,!0)})&&t.play_stream_resolution_infos.push(p),0==p.video_width&&0==p.video_height){var v=1e3*l.playerList[n].player.lastPlayStats.audioBitrate;v>t.play_max_audio_bitrate&&(t.play_max_audio_bitrate=v)}},l=this;for(var p in this.playerList)i(p);0!==this.chargeInfos.timestamp_end?(this.chargeInfos.timestamp_diff=this.chargeInfos.timestamp_begin-this.chargeInfos.timestamp_end,this.chargeInfos.timestamp_diff_flag=1):(this.chargeInfos.timestamp_diff=0,this.chargeInfos.timestamp_diff_flag=0),this.chargeInfos.timestamp_end=(new Date).getTime(),this.chargeInfos.infos=[t],0!==t.play_stream_resolution_infos.length&&this.logger.report(this.chargeInfos),this.chargeInfosTimer&&this.startChargeInfosUpload()},n.prototype.startSoundLevel=function(){var t=this;this.soundLevelTimer&&(clearTimeout(this.soundLevelTimer),this.soundLevelTimer=null),this.soundLevelTimer=setTimeout(function(){t.checkSoundLevel()},this.soundLevelInterval)},n.prototype.checkSoundLevel=function(){var t=[];for(var n in this.publisherList){var i=this.publisherList[n].publisher;t.push({streamID:i.streamId,soundLevel:i.soundLevel,type:"push"})}for(var n in this.playerList){var l=this.playerList[n].player;t.push({streamID:l.streamId,soundLevel:l.soundLevel,type:"pull"})}this.soundLevelDelegate&&t.length>0&&this.onSoundLevelUpdate(t),this.soundLevelDelegate&&this.startSoundLevel()},n.prototype.setSoundLevelDelegate=function(t,n){for(var i in this.logger.info("zsc.ssd.0 call"),n&&(this.soundLevelInterval=n),this.soundLevelDelegate=t,this.publisherList){var l=this.publisherList[i].publisher;t?l.startSoundLevel():l.stopSoundLevel()}for(var i in this.playerList){var p=this.playerList[i].player;t?p.startSoundLevel():p.stopSoundLevel()}if(t){this.logger.info("zsc.ssd.0 start getting sound");var v=0;for(var e in this.signalList)v+=1;null==this.soundLevelTimer&&v>0&&this.startSoundLevel()}else this.logger.info("zsc.ssd.0 stop getting sound"),this.soundLevelTimer&&clearTimeout(this.soundLevelTimer),this.soundLevelTimer=null,this.soundLevelInterval=1e3},n.prototype.stopSoundLevel=function(){var t=0;for(var n in this.signalList)t+=1;this.soundLevelTimer&&0==t&&(this.logger.info("zsc.ssl.0 stop"),clearTimeout(this.soundLevelTimer),this.soundLevelTimer=null,this.soundLevelInterval=1e3)},n.prototype.checkPreview=function(t){for(var n=0;n<this.previewVideoList.length;n++)if(this.previewVideoList[n].localVideo===t)return this.previewVideoList[n];return null},n.prototype.removePreview=function(t){for(var n=0;n<this.previewVideoList.length;n++)if(this.previewVideoList[n]===t){this.previewVideoList.splice(n,1);break}},n.prototype.onDeviceError=function(t){},n.prototype.OnAudioDeviceStateChanged=function(t){},n.prototype.OnVideoDeviceStateChanged=function(t){},n.prototype.onPlayerStreamUrlUpdate=function(t,n,i){},n.prototype.onVideoSizeChanged=function(t,n,i){},n.prototype.onRemoteCameraStatusUpdate=function(t,n){},n.prototype.onRemoteMicStatusUpdate=function(t,n){},n.prototype.onSoundLevelUpdate=function(t){},n.prototype.setPublishStreamConstraints=function(t,n,i,l){var p=this,v=this.publisherList[t],e=/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent);if(v){var T=this.checkPreview(v.localVideo);if(T)if(n&&0!=Object.keys(n).length){var E=!1,R=!1;n.minBitRate&&n.maxBitRate&&(n.bitRate={minBitRate:n.minBitRate,maxBitRate:n.maxBitRate}),n.width&&n.width!=T.mediaStreamConfig.width||n.height&&n.height!=T.mediaStreamConfig.height||n.frameRate&&n.frameRate!=T.mediaStreamConfig.frameRate?E=!0:n.minBitRate==T.mediaStreamConfig.bitRate.minBitRate&&n.maxBitRate==T.mediaStreamConfig.bitRate.maxBitRate||n.minBitRate&&n.maxBitRate&&(R=!0),T.mediaStreamConfig.videoInput!==n.videoInput&&delete T.mediaStreamConfig.facingMode&&delete n.facingMode;var S=Object.assign(T.mediaStreamConfig,n);if(S.externalCapture||S.externalMediaStream)this.logger.error("zc.spsc.0 do not support external stream");else{var L=T.getMediaStreamConstraints(S),M=v.publisher.localStream;if(!v.publisher.peerConnection.getSenders||!v.publisher.peerConnection.getSenders()[0].replaceTrack)return this.logger.error("zc.spsc.0 set publish constraints is not supported"),void(l&&l({code:1,msg:"not supported"}));if(this.logger.info("zc.spsc.0 streamID: "+t+" constraints: "+JSON.stringify(n)),E&&(!e&&M.getTracks().forEach(function(t){return t.stop()}),navigator.mediaDevices.getUserMedia(L).then(function(t){t.getTracks().forEach(function(t){var n=M.getTracks().find(function(n){return n.kind===t.kind}),i=v.publisher.peerConnection.getSenders().find(function(n){return n.track.kind===t.kind});S.minBitRate&&S.maxBitRate&&"video"===i.track.kind&&p.setVideoBitRate(i,S.minBitRate,S.maxBitRate),i.replaceTrack(t),M.removeTrack(n),M.addTrack(t),p.logger.info("zc.spsc.0 set constraints success")}),i&&i()}).catch(function(t){p.logger.error("zc.spsc.0 fail reason ",t.name),l&&l({code:2,msg:t.name})})),R)try{var u=v.publisher.peerConnection.getSenders().find(function(t){return"video"===t.track.kind});this.setVideoBitRate(u,n.minBitRate,n.maxBitRate),i&&i()}catch(t){this.logger.error("zc.spsc.0 fail reason ",t.name),l&&l({code:2,msg:t.name})}}}else this.logger.error("zc.spsc.0 constraints wrong");else this.logger.error("zc.spsc.0 preview no found")}else this.logger.error("zc.spsc.0 publisher not found")},n.prototype.setVideoBitRate=function(t,n,i){var l=this;this.logger.info("zsc.svb.0 call min:"+n+" max:"+i+" ");var p=t.getParameters();return p.encodings||(p.encodings=[{}]),p.encodings[0].minBitrate=1e3*n,p.encodings[0].maxBitrate=1e3*i,t.setParameters(p).then(function(){l.logger.info("zc.spsc.0 set video bitrate success")}).catch(function(t){l.logger.error("zc.spsc.0 set video bitrate fail "+t)}),!0},n.prototype.startMixingAudio=function(t,n){var i=this.getPublisher(t);return i?i.startMixingAudio(n):(this.logger.error("zc.sma.0 publisher doesn't exist"),!1)},n.prototype.stopMixingAudio=function(t,n){var i=this.getPublisher(t);return i?i.stopMixingAudio(n):(this.logger.error("zc.sma.1 publisher doesn't exist"),!1)},n}(M.ZegoStreamCenter);n.ZegoStreamCenterWeb=f},function(t,n,i){"use strict";var l=this&&this.__assign||Object.assign||function(t){for(var n,i=1,l=arguments.length;i<l;i++)for(var p in n=arguments[i])Object.prototype.hasOwnProperty.call(n,p)&&(t[p]=n[p]);return t};Object.defineProperty(n,"__esModule",{value:!0});var p=function(){function t(t){this.log=t,this.dataStatistics={},this.logger=t}return t.prototype.newReport=function(t){this.dataStatistics[t]={abs_time:Date.now(),time_consumed:0,error:0,events:[]}},t.prototype.addMsgExt=function(t,n){this.dataStatistics[t]?this.dataStatistics[t].msg_ext=n:console.warn(t+" not exist")},t.prototype.eventStart=function(t,n){this.dataStatistics[t]?null!=this.dataStatistics[t].events?this.dataStatistics[t].events.push({event:n,abs_time:Date.now(),time_consumed:0}):this.logger.warn("zd.es.0 no events"):this.logger.warn("zd.es.0 no seq match")},t.prototype.eventEnd=function(t,n,i){if(this.dataStatistics[t]){var l=this.dataStatistics[t].events;if(l&&0!==l.length){for(var p=l.length-1;p>=0;p--)if(l[p].event==n&&l[p].time_consumed){l[p].time_consumed=Date.now()-l[p].abs_time;break}}else this.logger.info("zd.ee.0 no events")}else this.logger.info("zd.ee.0 no seq match")},t.prototype.eventEndWithMsg=function(t,n,i){if(this.dataStatistics[t]){var p=this.dataStatistics[t].events;if(p){for(var v=p.length-1;v>=0;v--)if(p[v].event==n&&p[v].time_consumed){p[v].time_consumed=Date.now()-p[v].abs_time,null==p[v].msg_ext&&(p[v].msg_ext={}),p[v].msg_ext=l({},i);break}}else this.logger.warn("zd.ee.0 no events")}else this.logger.warn("zd.ee.0 no seq match")},t.prototype.addEventInfo=function(t,n,i,l){if(this.dataStatistics[t]){var p=this.dataStatistics[t].events;if(null!=p){for(var v=p.length-1;v>=0;v--)if(p[v].event==n&&null!=p[v].time_consumed&&p[v].event==n&&null!=p[v].time_consumed){null==p[v].msg_ext&&(p[v].msg_ext={}),p[v].msg_ext[i]=l;break}}else this.logger.warn("zd.aei.0 no events")}else this.logger.warn("zd.aei.0 no seq match")},t.prototype.addEvent=function(t,n,i){this.dataStatistics[t]?this.dataStatistics[t].events&&(i?this.dataStatistics[t].events.push({event:n,abs_time:Date.now(),msg_ext:i}):this.dataStatistics[t].events.push({event:n,abs_time:Date.now()})):this.logger.warn("zd.ae.0 no seq match")},t.prototype.uploadReport=function(t,n){var i=this.dataStatistics[t];null!=i&&(i.itemtype=n,i.time_consumed=Date.now()-i.abs_time,this.logger.report(i),delete this.dataStatistics[t])},t}();n.ZegoDataReport=p},function(t,n,i){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var l=i(0),p=i(1),v=function(){function t(t){var n=this;this.log=t,this.localVideo=null,this.localStream=null,this.previewSuc=!1,this.enableMicrophone=function(t,i){if(!n.localStream)return n.logger.error("zp.em.2 no localStream"),!1;for(var l in n.localStream.getAudioTracks().forEach(function(n){n.enabled=t}),i.publisherList){var v=i.publisherList[l].publisher;v.localStream==n.localStream&&v.signal.sendStreamStatus(p.getSeq(),v.sessionId,n.localStream&&n.localStream.getVideoTracks()[0]&&!0===n.localStream.getVideoTracks()[0].enabled?0:2,t?0:2)}return n.logger.debug("zp.em.2 call success"),!0},this.enableCamera=function(t,i){if(!n.localStream)return n.logger.error("zp.ec.2 no localStream"),!1;for(var l in n.localStream.getVideoTracks().forEach(function(n){n.enabled=t}),i.publisherList){var v=i.publisherList[l].publisher;v.localStream==n.localStream&&v.signal.sendStreamStatus(p.getSeq(),v.sessionId,t?0:2,n.localStream&&n.localStream.getAudioTracks()[0]&&1==n.localStream.getAudioTracks()[0].enabled?0:2)}return n.logger.debug("zp.ec.2 call success"),!0},this.setAudioDestination=function(t){return n.localVideo?"undefined"!==n.localVideo.sinkId?(n.localVideo.setSinkId(t).then(function(){n.logger.info("zp.sad.2 success device: "+t)}).catch(function(t){n.logger.info("zp.sad.2 "+t.name)}),!0):(n.logger.error("zp.sad.2 browser does not suppport"),!1):(n.logger.error("zp.sad.2 no localVideo"),!1)},this.logger=t}return t.prototype.getMediaStreamConstraints=function(t){var n={audio:null,video:null};if(n.audio=!1,n.video=!1,console.log("mediaStreamConfig",t),t.audio&&(void 0===t.audioInput&&void 0===t.noiseSuppression&&void 0===t.autoGainControl&&void 0===t.echoCancellation?(n.audio={},n.audio.noiseSuppression=!0,n.audio.autoGainControl=!0,n.audio.echoCancellation=!0):(n.audio={},void 0!==t.audioInput&&null!==t.audioInput&&(n.audio.deviceId=t.audioInput),void 0!==t.noiseSuppression&&(n.audio.noiseSuppression=t.noiseSuppression),void 0!==t.autoGainControl&&(n.audio.autoGainControl=t.autoGainControl),void 0!==t.echoCancellation&&(n.audio.echoCancellation=t.echoCancellation))),t.video){var i=640,p=480,v=15,e=800;if(1===t.videoQuality?(i=l.ENUM_RESOLUTION_TYPE.LOW.width,p=l.ENUM_RESOLUTION_TYPE.LOW.height,v=l.ENUM_RESOLUTION_TYPE.LOW.frameRate,e=l.ENUM_RESOLUTION_TYPE.LOW.bitRate):2===t.videoQuality?(i=l.ENUM_RESOLUTION_TYPE.MEDIUM.width,p=l.ENUM_RESOLUTION_TYPE.MEDIUM.height,v=l.ENUM_RESOLUTION_TYPE.MEDIUM.frameRate,e=l.ENUM_RESOLUTION_TYPE.MEDIUM.bitRate):3===t.videoQuality?(i=l.ENUM_RESOLUTION_TYPE.HIGH.width,p=l.ENUM_RESOLUTION_TYPE.HIGH.height,v=l.ENUM_RESOLUTION_TYPE.HIGH.frameRate,e=l.ENUM_RESOLUTION_TYPE.HIGH.bitRate):4===t.videoQuality?(i=t.width,p=t.height,v=t.frameRate,e=t.maxBitRate||800):this.logger.info("zp.gmsc.2 user default"),!0===t.horizontal){var T=p;p=i,i=T}n.video={width:i,height:p,frameRate:v,bitRate:e},null!=t.facingMode?n.video.facingMode=t.facingMode:null!=t.videoInput&&null!=t.videoInput&&(n.video.deviceId={exact:t.videoInput}),this.logger.info("zp.gmsc.2 width: "+i+" height: "+p+" rate: "+v)}return n},t.prototype.startPreview=function(t,n,i,l){var p=this;if(this.logger.debug("zp.sv.2 called"),this.localVideo=t,this.mediaStreamConfig=n,void 0!==navigator.mediaDevices&&null!=navigator.mediaDevices.getUserMedia){if(n.externalMediaStream instanceof MediaStream)return this.logger.debug("zp.sv.2 use external media stream"),this.previewSuc=!0,this.localStream=n.externalMediaStream,this.videoInfo={width:n.width,height:n.height,frameRate:n.frameRate,minBitRate:n.minBitRate,maxBitRate:n.maxBitRate},void(i&&i());if(n.externalCapture)this.captureStream(t,n)?(this.previewSuc=!0,i&&i()):l&&l("external capture fail");else{var v=this.getMediaStreamConstraints(n);this.videoInfo=v.video,this.videoInfo&&(this.videoInfo.minBitRate=n.minBitRate||v.video.bitRate),this.videoInfo&&(this.videoInfo.maxBitRate=n.maxBitRate||v.video.bitRate),this.logger.info("zp.sv.2 ",JSON.stringify(v)),navigator.mediaDevices.getUserMedia(v).then(function(t){if(p.logger.info("zp.sv.2 success"),!p.localVideo)return p.logger.info("zp.sv.2 no localVideo"),void(l&&l("no localVideo"));p.localVideo.srcObject=t,p.localStream=t,p.previewSuc=!0,i&&i()},function(t){p.logger.info("zp.sv.2 failed "+t.message),l&&l(t)})}}else l&&l("browser don't support")},t.prototype.captureStream=function(t,n){if(!t)return this.logger.info("zp.cs.2 no local video"),!1;var i,l;if(t.captureStream)i=t.captureStream(),this.logger.debug("zp.cs.2 captureStream");else{if(!t.mozCaptureStream)return this.logger.info("zp.cs.2 don't support capture stream"),!1;i=t.mozCaptureStream(),this.logger.debug("zp.cs.2 mozCaptureStream")}return 0==i.getTracks().length?(this.logger.error("zp.cs.2 external capture tracks no found"),!1):(this.localStream=i,this.videoInfo={width:t.videoWidth,height:t.videoHeight,frameRate:n.frameRate||15,minBitRate:800,maxBitRate:800},"number"==typeof n.bitRate?(l<48&&(l=48),l>1e4&&(l=1e4),this.videoInfo.minBitRate=this.videoInfo.maxBitRate=n.bitRate):n.bitRate&&n.bitRate.minBitRate&&n.bitRate.maxBitRate&&"number"==typeof n.bitRate.minBitRate&&"number"==typeof n.bitRate.maxBitRate&&n.bitRate.minBitRate<=n.bitRate.maxBitRate&&(this.videoInfo.minBitRate=n.bitRate.minBitRate<48?48:n.bitRate.minBitRate,this.videoInfo.maxBitRate=n.bitRate.maxBitRate>1e4?1e4:n.bitRate.maxBitRate),this.logger.debug("zp.cs.2 called success"),!0)},t.prototype.stopPreview=function(){if(this.logger.info("zp.sv.2.1 called"),this.localStream){var t=this.localStream.getTracks();t.reverse(),t.forEach(function(t){t.stop()}),this.localStream=null,this.localVideo.srcObject=null,this.localVideo=null,this.videoInfo=null}},t}();n.ZegoPreview=v},function(t,n,i){"use strict";var l=this&&this.__assign||Object.assign||function(t){for(var n,i=1,l=arguments.length;i<l;i++)for(var p in n=arguments[i])Object.prototype.hasOwnProperty.call(n,p)&&(t[p]=n[p]);return t};Object.defineProperty(n,"__esModule",{value:!0});var p=i(0),v=i(1),e=i(13),T=i(3),E=i(4),R=i(14),S=function(){function t(t,n,i,l,e){this.state=p.ENUM_PUBLISH_STATE.stop,this.sessionId=0,this.waitingICETimeInterval=5e3,this.waitingAnswerTimeInterval=5e3,this.candidateInfo=[],this.waitingICETimer=null,this.waitingAnswerTimer=null,this.qualityTimer=null,this.publishQualityList=[],this.maxQualityListCount=10,this.lastPublishStats={},this.reportSeq=v.getSeq(),this.qualityUpload=!1,this.qualityUploadInterval=3e4,this.qualityUploadLastTime=0,this.qualitySeq=0,this.videoInfo={width:0,height:0,frameRate:0,minBitRate:0,maxBitRate:0},this.streamGoogInfo={},this.mediaStreamConfig=null,this.offerSeq=0,this.audioMixList=[],this.arrayBufferMap={},this.qualityCount=0,this.closeSessionSignal=!1,this.audioBitRate=48e3,this.localSdpRevert=!1,this.videoDecodeType="H264",this.stateNego=p.ENUM_PUBLISH_STATE_NEGO.stop,this.negoInterval=25e3,this.publishEvent=!1,this.soundLevel=0,this.script=null,this.mic=null,this.logger=t,this.signal=n,this.dataReport=i,this.streamCenter=e,this.ac=this.streamCenter.ac,this.qualityTimeInterval=l,this.audioMixing=new T.audioMixUtil(t,this.ac),i.newReport(this.reportSeq)}return t.prototype.publishStateUpdateError=function(t,n){this.logger.error("zp.psue.0 call ",this.streamId,JSON.stringify(t)),this.streamId&&this.onPublishStateUpdate(v.ENUM_PUBLISH_STATE_UPDATE.error,this.streamId,t,n),this.logger.info("zp.psue.0 ended")},t.prototype.resetPublish=function(){this.logger.info("zp.rp.0 call"),this.streamId=null,this.state=p.ENUM_PUBLISH_STATE.stop,this.publishEvent=!1,null==this.peerConnection&&null==this.peerConnection||(this.peerConnection.close(),this.peerConnection=null),null!=this.waitingAnswerTimer&&(clearTimeout(this.waitingAnswerTimer),this.waitingAnswerTimer=null),null!=this.waitingICETimer&&(clearTimeout(this.waitingICETimer),this.waitingICETimer=null),null!=this.negoTimer&&(clearTimeout(this.negoTimer),this.negoTimer=null),this.clearPublishQualityTimer(),this.signal&&(this.signal.unregisterPushCallback("CandidateInfoPush",this.sessionId),this.signal.unregisterPushCallback("MediaDescPush",this.sessionId),this.signal.unregisterPushCallback("CloseSessionPush",this.sessionId)),this.sessionSeq=0,this.offerSeq=0,this.candidateInfo=[],this.publishQualityList=[],this.qualityUploadLastTime=0},t.prototype.clearPublishQualityTimer=function(){null!=this.qualityTimer&&(clearInterval(this.qualityTimer),this.qualityTimer=null),this.lastPublishStats={},this.qualityCount=0},t.prototype.shouldSendCloseSession=function(t){return this.state!=p.ENUM_PUBLISH_STATE.stop&&this.state!=p.ENUM_PUBLISH_STATE.waitingSessionRsp},t.prototype.startPublish=function(t,n,i,l,e){var T=this;if(this.logger.info("zp.sp.0 called"),this.signal&&this.signal.negoInterval&&(this.negoInterval=this.signal.negoInterval),t)if(this.peerConnection&&this.stateNego==p.ENUM_PUBLISH_STATE_NEGO.iceConnected)this.logger.info("zp.sp.0 ice connected");else{this.streamId=t,this.localStream=n,this.mediaStreamConfig=l,this.playOption=e||{},navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&(l.externalCapture||l.externalMediaStream)&&(this.localStream.onaddtrack=function(){T.logger.info("zp.sp.0 Track added");var t=T.localStream.getVideoTracks(),n=T.localStream.getAudioTracks();if(t.length>1)T.peerConnection.getSenders().find(function(n){return n.track.kind===t[1].kind}).replaceTrack(t[1]),T.localStream.removeTrack(t[0]);else if(n.length>1){T.peerConnection.getSenders().find(function(t){return t.track.kind===n[1].kind}).replaceTrack(n[1]),T.localStream.removeTrack(n[0])}}),i&&(this.videoInfo=i),e&&e.audioBitRate&&(this.audioBitRate=e.audioBitRate),e&&e.videoDecodeType&&(this.videoDecodeType=e.videoDecodeType),this.sessionSeq=v.getSeq(),this.dataReport.eventStart(this.reportSeq,"CreateSession");var E=t;1==this.streamCenter.testEnvironment&&(E="zegotest-"+this.streamCenter.appid+"-"+t),this.signal.createSession(this.sessionSeq,0,0,E,e&&e.streamParams,function(t,n,i){T.dataReport.eventEndWithMsg(T.reportSeq,"CreateSession",{sessionId:i.session_id}),T.logger.info("zp.sp.0 sessionId:"+i.session_id),T.sessionSeq==t?0!==i.result?(T.logger.error("zp.sp.0 create session failed "+i.result),T.publishStateUpdateError(v.publishErrorList.CREATE_SESSION_ERROR)):(T.sessionId=i.session_id,T.logger.debug("zp.sp.0 create session success "+T.sessionId),T.onCreatePublishSessionSuccess(i)):T.logger.error("zp.sp.0 seq is not match.")},function(t,n){T.dataReport.eventEndWithMsg(T.reportSeq,"CreateSession",{error:t}),T.publishStateUpdateError(v.publishErrorList.SEND_SESSION_TIMEOUT)}),this.state=p.ENUM_PUBLISH_STATE.waitingSessionRsp,this.logger.info("zp.sp.0 called success"),this.stateNego=p.ENUM_PUBLISH_STATE_NEGO.start,this.negoTimer=setTimeout(function(){T.logger.error("zp.sp.0 waiting timeout"),T.publishStateUpdateError(v.publishErrorList.SERVER_NEGO_TIMEOUT)},this.negoInterval)}else this.logger.error("zp.sp.0 streamId is null")},t.prototype.onCreatePublishSessionSuccess=function(t){var n=this;this.logger.info("zp.ops.0 called");var i=[];t.turn_server&&i.push(t.turn_server),t.stun_server&&i.push(t.stun_server);var l={iceTransportPolicy:"relay",iceServers:[{urls:i,username:t.turn_username,credential:t.turn_auth_key}]};this.logger.info("zp.ops.0 username: "+t.turn_username),this.logger.info("zp.ops.0 credential: "+t.turn_auth_key),this.peerConnection=new RTCPeerConnection(l),this.peerConnection.onicecandidate=function(t){n.onIceCandidate(t)},this.peerConnection.onsignalingstatechange=function(t){n.onConnectionStateChange(t)},this.peerConnection.oniceconnectionstatechange=function(t){n.onIceConnectionStateChange(t)};var p=[],e=[];this.localStream&&(this.localStream.getTracks().forEach(function(t){n.peerConnection.addTrack(t,n.localStream)}),p=this.localStream.getVideoTracks(),e=this.localStream.getAudioTracks(),console.warn("getConstraints",e&&e[0]&&e[0].getConstraints&&e[0].getConstraints()),p.length>0&&this.logger.info("zp.ops.0 video device: "+p[0].label),e.length>0&&this.logger.info("zp.ops.0 audio device: "+e[0].label));var T={offerToReceiveAudio:e.length>0?1:0,offerToReceiveVideo:p.length>0?1:0};this.logger.info("zp.ops.0 createOffer: "+JSON.stringify(T)),this.dataReport.eventStart(this.reportSeq,"CreateOffer"),this.peerConnection.createOffer(T).then(function(t){n.dataReport.eventEnd(n.reportSeq,"CreateOffer"),n.onCreateOfferSuccess(t)},function(t){n.dataReport.eventEndWithMsg(n.reportSeq,"CreateOffer",{error:t.toString()}),n.logger.error("zp.ops.0 create offer error "+t.toString()),n.publishStateUpdateError(v.publishErrorList.CREATE_OFFER_ERROR,!0)}),this.signal.registerPushCallback("CandidateInfoPush",this.sessionId,function(t,i,l){n.onRecvCandidateInfo(t,i,l)}),this.signal.registerPushCallback("CloseSessionPush",this.sessionId,function(t,i,l){n.onRecvCloseSession(t,i,l)}),this.signal.registerPushCallback("MediaDescPush",this.sessionId,function(t,i,l){n.onRecvMediaDescription(t,i,l)}),this.signal.registerPushCallback("SessionResetPush",this.sessionId,function(t,i,l){n.onRecvResetSession(t,i,l)}),this.signal.registerPushCallback("PublishEventPush",this.sessionId,function(t,i,l){n.onRecvPublishEvent(t,i,l)}),this.logger.debug("zp.ops.0 call success")},t.prototype.onCreateOfferSuccess=function(t){var n=this;0!=this.videoInfo.maxBitRate&&(t.sdp=this.updateBandwidthRestriction(t.sdp,this.videoInfo.maxBitRate)),t.sdp=t.sdp.replace(/sendrecv/g,"sendonly"),t.sdp=t.sdp.replace(/useinbandfec=\d+/,"maxaveragebitrate="+this.audioBitRate),/m=video[\s\S]*m=audio/.test(t.sdp)&&(this.localSdpRevert=!0),t.sdp=E.sdpUtil.getSDPByVideDecodeType(t.sdp,this.videoDecodeType),this.logger.info("zp.oco.0 localSdp1 "+t.sdp.substr(0,t.sdp.length/2)),this.logger.info("zp.oco.0 localSdp2 "+t.sdp.substr(t.sdp.length/2)),this.dataReport.eventStart(this.reportSeq,"SetLocalDescription"),this.peerConnection.setLocalDescription(t).then(function(){n.dataReport.eventEnd(n.reportSeq,"SetLocalDescription"),n.onSetLocalDescriptionSuccess(t)},function(t){n.dataReport.eventEndWithMsg(n.reportSeq,"SetLocalDescription",{error:t.toString()}),n.logger.error("zp.oco.0 error "+t.toString()),n.publishStateUpdateError(v.publishErrorList.SET_LOCAL_DESC_ERROR,!0)})},t.prototype.updateBandwidthRestriction=function(t,n){var i="AS";return"firefox"===e.browserDetails.browser&&(n=1e3*(n>>>0),i="TIAS"),t=-1===t.indexOf("b="+i+":")?(t=t.replace(/c=IN (.*)\r\n/g,"c=IN $1\r\nb="+i+":"+n+"\r\n")).replace("b="+i+":"+n+"\r\n",""):(t=t.replace(new RegExp("b="+i+":.*\r\n","g"),"b="+i+":"+n+"\r\n")).replace("b="+i+":"+n+"\r\n","")},t.prototype.onSetLocalDescriptionSuccess=function(t){var n=this;this.logger.info("zp.osd.0 success");var i={sdp:t.sdp,width:this.videoInfo.width,height:this.videoInfo.height,frameRate:this.videoInfo.frameRate,video_min_kpbs:this.videoInfo.minBitRate,video_max_kpbs:this.videoInfo.maxBitRate,audio_kpbs:48,keyframe_intv:2};this.offerSeq=v.getSeq(),this.dataReport.eventStart(this.reportSeq,"SendMediaDesc"),this.signal.sendMediaDesc(this.offerSeq,this.sessionId,0,i,function(t,i,l){n.offerSeq==t&&n.sessionId==i?(n.logger.info("zp.osd.0 send success"),n.dataReport.eventEnd(n.reportSeq,"SendMediaDesc"),n.waitingAnswerTimer=setTimeout(function(){n.state==p.ENUM_PUBLISH_STATE.waitingServerAnswer&&(n.logger.error("zp.osd.0 waiting timeout"),n.publishStateUpdateError(v.publishErrorList.SERVER_MEDIA_DESC_TIMEOUT))},n.waitingAnswerTimeInterval),n.logger.info("zp.osd.0 send success stateNego:waiterAnswer"),n.stateNego=p.ENUM_PUBLISH_STATE_NEGO.waiterAnswer,n.state=p.ENUM_PUBLISH_STATE.waitingServerAnswer):n.logger.error("zp.osd.0 seq or sessionId is not equal")},function(t,i){n.dataReport.eventEndWithMsg(n.reportSeq,"SendMediaDesc",{error:t}),n.publishStateUpdateError(v.publishErrorList.SEND_MEDIA_DESC_TIMEOUT)}),this.state=p.ENUM_PUBLISH_STATE.waitingOffserRsp,this.logger.debug("zp.osd.0 call success")},t.prototype.onRecvMediaDescription=function(t,n,i){this.logger.info("zp.ormd.0 received"),this.state==p.ENUM_PUBLISH_STATE.waitingServerAnswer?(this.stateNego=p.ENUM_PUBLISH_STATE_NEGO.waitingCandidate,this.logger.info("zp.orm.0 received stateNego:waitingCandidate"),null!=this.waitingAnswerTimer&&(clearTimeout(this.waitingAnswerTimer),this.waitingAnswerTimer=null),this.dataReport.addEvent(this.reportSeq,"RecvMediaDesc"),this.signal.sendMediaDescAck(t,this.sessionId,0),1==i.type?this.onGetRemoteOfferSucceses(i.sdp):this.publishStateUpdateError(v.publishErrorList.SERVER_MEDIA_DESC_ERROR)):this.logger.info("zp.ormd.0 current state "+this.state+" not allowed")},t.prototype.onGetRemoteOfferSucceses=function(t){var n=this;if(48e3!==this.audioBitRate&&(t=t.replace(/maxaveragebitrate=(\d+)/,"maxaveragebitrate="+this.audioBitRate)),this.localSdpRevert){var i=[/[\s\S]*m=audio/.exec(t)[0].replace("m=audio",""),/m=video[\s\S]*/.exec(t)[0],/m=audio[\s\S]*m=video/.exec(t)[0].replace("m=video","")],l=i[0],e=i[1],T=i[2],E=/a=group:BUNDLE\s+(\w+)\s+(\w+)/.exec(l);t=(l=l.replace(/a=group:BUNDLE\s+(\w+)\s+(\w+)/,"a=group:BUNDLE "+E[2]+" "+E[1]))+e+T}this.logger.info("zp.oro.0 remoteSdp:",t);var R={type:"answer",sdp:t,toJSON:function(){}};this.dataReport.eventStart(this.reportSeq,"SetRemoteDescription"),this.peerConnection.setRemoteDescription(new RTCSessionDescription(R)).then(function(){n.logger.info("zp.oro.0 set success"),n.dataReport.eventEnd(n.reportSeq,"SetRemoteDescription")},function(t){n.logger.error("zp.oro.0 failed: "+t.toString()),n.dataReport.eventEndWithMsg(n.reportSeq,"SetRemoteDescription",{error:t.toString()}),n.publishStateUpdateError(v.publishErrorList.SET_REMOTE_DESC_ERROR,!0)}),this.state=p.ENUM_PUBLISH_STATE.waitingServerICE,this.waitingICETimer=setTimeout(function(){n.state==p.ENUM_PUBLISH_STATE.waitingServerICE&&(n.logger.error("zp.orod.0 waiting server timeout"),n.publishStateUpdateError(v.publishErrorList.SERVER_CANDIDATE_TIMEOUT))},this.waitingICETimeInterval),this.logger.debug("zp.oro.0 call success")},t.prototype.onIceConnectionStateChange=function(t){this.state!=p.ENUM_PUBLISH_STATE.stop&&null!=this.peerConnection&&(this.logger.info("zp.oics.0 stateChanged "+this.peerConnection.iceConnectionState),"connected"===this.peerConnection.iceConnectionState?(this.logger.info("zp.oics.0 connected state "+this.state),this.dataReport.eventEnd(this.reportSeq,"IceConnected"),this.stateNego=p.ENUM_PUBLISH_STATE_NEGO.iceConnected,this.logger.info("zp.oisc.0  stateNego:iceConnected"),this.negoTimer&&(clearTimeout(this.negoTimer),this.negoTimer=null),this.publishEvent&&this.publishSuccess()):"closed"===this.peerConnection.iceConnectionState?(this.dataReport.addEvent(this.reportSeq,"IceClosed"),this.stateNego=p.ENUM_PUBLISH_STATE_NEGO.iceClosed,this.checkPublishConnectionFailedState(this.peerConnection.iceConnectionState)):"failed"===this.peerConnection.iceConnectionState?(this.dataReport.addEvent(this.reportSeq,"IceFailed"),this.stateNego=p.ENUM_PUBLISH_STATE_NEGO.iceFailed,this.checkPublishConnectionFailedState(this.peerConnection.iceConnectionState)):"disconnected"===this.peerConnection.iceConnectionState&&(this.dataReport.addEvent(this.reportSeq,"IceDisconnected"),this.stateNego=p.ENUM_PUBLISH_STATE_NEGO.iceDisconnected,this.checkPublishConnectionFailedState(this.peerConnection.iceConnectionState)))},t.prototype.onIceCandidate=function(t){if(this.logger.info("zp.oic.0 candidate"+t.candidate),t.candidate)if(this.logger.info("zp.oic.0 candidate"+t.candidate.candidate),this.state<p.ENUM_PUBLISH_STATE.connecting||this.state==p.ENUM_PUBLISH_STATE.stop)this.candidateInfo.push({candidate:t.candidate.candidate,sdpMid:t.candidate.sdpMid,sdpMLineIndex:t.candidate.sdpMLineIndex});else{var n={candidate:t.candidate.candidate,sdpMid:t.candidate.sdpMid,sdpMLineIndex:t.candidate.sdpMLineIndex};this.sendCandidateInfo([n])}},t.prototype.sendCandidateInfo=function(t){var n=this;this.logger.info("zp.sci.0 called"),!(t=t.filter(function(t){return t.candidate.indexOf("relay")>0}))||t.length<1?this.logger.info("zp.sci.0 cancelled"):(this.dataReport.eventStart(this.reportSeq,"SendIceCandidate"),this.stateNego!==p.ENUM_PUBLISH_STATE_NEGO.iceConnected&&(this.stateNego=p.ENUM_PUBLISH_STATE_NEGO.sendCandidate),this.logger.info("zp.sci.0  stateNego:sendCandidate"),this.signal.sendCandidateInfo(v.getSeq(),this.sessionId,t,function(t,i,l){n.logger.info("zp.sci.0 send success"),n.dataReport.eventEnd(n.reportSeq,"SendIceCandidate")},function(t,i){n.logger.error("zp.sci.0 failed to send: "+t.toString()),n.dataReport.eventEndWithMsg(n.reportSeq,"SendIceCandidate",{error:t}),n.publishStateUpdateError(v.publishErrorList.SEND_CANDIDATE_TIMEOUT)}))},t.prototype.onConnectionStateChange=function(t){this.logger.info("zp.ocs.0 called "+t.target.signalingState)},t.prototype.onRecvCandidateInfo=function(t,n,i){var l=this;if(this.logger.info("zp.oci.0 received "+JSON.stringify(i.infos)),this.state==p.ENUM_PUBLISH_STATE.waitingServerICE){null!=this.waitingICETimer&&(clearTimeout(this.waitingICETimer),this.waitingICETimer=null),this.dataReport.addEvent(this.reportSeq,"RecvIceCandidate"),this.signal.sendCandidateInfoAck(t,this.sessionId,0),this.sendCandidateInfo(this.candidateInfo),this.candidateInfo=[];for(var e=0;e<i.infos.length;e++){var T={sdpMid:i.infos[e].sdpMid,sdpMLineIndex:i.infos[e].sdpMLineIndex,candidate:i.infos[e].candidate};this.logger.debug("zp.orci.0 candidate "+T.candidate),this.peerConnection.addIceCandidate(new RTCIceCandidate(T)).then(function(){l.logger.debug("zp.oci.0 add success")},function(t){l.logger.error("zp.oci.0 add error "+t.toString()),l.publishStateUpdateError(v.publishErrorList.SERVER_CANDIDATE_ERROR,!0)})}this.state=p.ENUM_PUBLISH_STATE.connecting,this.dataReport.eventStart(this.reportSeq,"IceConnected")}else this.logger.info("zp.oci.0 current state "+this.state+" not allowed")},t.prototype.onRecvCloseSession=function(t,n,i){this.logger.info("zp.orcs.0 reason: "+i.reason),this.dataReport.addEvent(this.reportSeq,"RecvCloseSession"),this.signal.sendCloseSessionAck(t,this.sessionId,0);var l=JSON.parse(JSON.stringify(v.publishErrorList.SESSION_CLOSED));l.msg+=" reason:"+i.reason+(i.err_info&&JSON.parse(i.err_info).action?"action:"+JSON.parse(i.err_info).action:""),this.negoTimer&&clearTimeout(this.negoTimer);var p=1*i.reason,e=i.err_info&&JSON.parse(i.err_info).action?JSON.parse(i.err_info).action:null,T=![4,8,10,11,12,14,26,27].includes(p)&&5!=e&&2!=e;this.publishStateUpdateError(l,T)},t.prototype.onRecvResetSession=function(t,n,i){if(this.logger.info("zp.orrs.0 received "),n==this.sessionId){this.dataReport.addEvent(this.reportSeq,"RecvResetSession"),this.signal.sendCloseSessionAck(t,this.sessionId,0);var l=JSON.parse(JSON.stringify(v.publishErrorList.SESSION_CLOSED));this.negoTimer&&clearTimeout(this.negoTimer),this.publishStateUpdateError(l)}else this.logger.error("zp.orrs.0 cannot find session")},t.prototype.onRecvPublishEvent=function(t,n,i){this.logger.info("zp.orpe.0 received"),this.publishEvent=!0,this.stateNego===p.ENUM_PUBLISH_STATE_NEGO.iceConnected&&0==i.event&&this.publishSuccess()},t.prototype.checkPublishConnectionFailedState=function(t){var n=null;"failed"==t?n=v.publishErrorList.MEDIA_CONNECTION_FAILED:"closed"==t?n=v.publishErrorList.MEDIA_CONNECTION_CLOSED:"disconnected"==t&&(n=v.publishErrorList.MEDIA_CONNECTION_DISCONNECTED),null!=n&&(this.logger.info("zp.oics.0  state "+this.state+" connectionState "+t),this.publishStateUpdateError(n))},t.prototype.setPublishQualityTimer=function(){var t=this;if(null==this.qualityTimer){this.logger.info("zp.spq.0 called"),this.clearPublishQualityTimer();var n=!0;this.peerConnection.getStats(function(){}).catch(function(i){t.logger.info("zp.spq.0 "+t.streamId+" getStats callback not support"),n=!1}),this.qualityTimer=setInterval(function(){t.peerConnectionGetStats(n)},this.qualityTimeInterval),this.lastPublishStats={time:0,audioBytesSent:0,videoBytesSent:0,framesEncoded:0,framesSent:0},this.qualitySeq=v.getSeq(),this.qualityCount=0,this.dataReport.newReport(this.qualitySeq)}},t.prototype.peerConnectionGetStats=function(t){var n=this;this.peerConnection&&(t&&this.peerConnection.getStats(function(t){n.getOldGoogStats(t)},function(t){n.logger.info("zp.spq.0 getOldGoogStats error "+t.toString())}),this.peerConnection.getStats(null).then(function(t){n.getPublishStats(t)},function(t){n.logger.info("zp.spq.0 getStats error "+t.toString())}))},t.prototype.getOldGoogStats=function(t){var n=this;t&&t.result&&t.result().forEach(function(t){var i=["audioInputLevel","googCpuLimitedResolution","googBandwidthLimitedResolution","googCodecName","googActualEncBitrate","googFrameWidthInput","googFrameHeightInput","googFrameRateInput","codecImplementationName"];if("VideoBwe"===t.type&&(n.streamGoogInfo.googAvailableSendBandwidth=t.stat("googAvailableSendBandwidth")||""),"ssrc"===t.type)for(var l=0;l<i.length;l++){var p=i[l];t.names().includes(p)&&(n.streamGoogInfo[p]=t.stat(p)||"")}})},t.prototype.getPublishStats=function(t){var n=this;if(t){var i=l({audioCodeType:"opus",audioBitrate:0,videoBitrate:0,audioLevel:0,videoFPS:0,nackCount:0,pliCount:0,frameHeight:0,frameWidth:0,videoTransferFPS:0,totalRoundTripTime:0,currentRoundTripTime:0,muted:!this.localVideo||this.localVideo.muted,paused:!this.localVideo||this.localVideo.paused,volume:this.localVideo?this.localVideo.volume:0,audioDeviceLabel:this.streamCenter.audioDeviceName,videoDeviceLbabel:this.streamCenter.videoDeviceName},this.streamCenter.deviceStates,this.streamGoogInfo),p=this.lastPublishStats.time;t.forEach(function(t){("outbound-rtp"==t.type||"ssrc"==t.type&&null!=t.bytesSent)&&"audio"==t.mediaType?(0!=p&&(i.audioBitrate=8*(t.bytesSent-n.lastPublishStats.audioBytesSent)/(t.timestamp-p)),i.audioBitrate<0&&(i.audioBitrate=0),n.lastPublishStats.audioBytesSent=t.bytesSent,n.lastPublishStats.time=t.timestamp):("outbound-rtp"==t.type||"ssrc"==t.type&&null!=t.bytesSent)&&"video"==t.mediaType?(0!=p&&(i.videoBitrate=8*(t.bytesSent-n.lastPublishStats.videoBytesSent)/(t.timestamp-p),i.videoFPS=1e3*(t.framesEncoded-n.lastPublishStats.framesEncoded)/(t.timestamp-p)),i.videoBitrate<0&&(i.videoBitrate=0),i.videoFPS<0&&(i.videoFPS=0),i.nackCount=t.nackCount,i.pliCount=t.pliCount,n.lastPublishStats.videoBytesSent=t.bytesSent,n.lastPublishStats.framesEncoded=t.framesEncoded,n.lastPublishStats.time=t.timestamp):"track"==t.type&&("video"==t.kind||t.id.indexOf("video")>=0)||t.frameWidth?(i.frameHeight=t.frameHeight,i.frameWidth=t.frameWidth,0!=p&&(i.videoTransferFPS=1e3*(t.framesSent-n.lastPublishStats.framesSent)/(t.timestamp-p)),i.videoTransferFPS<0&&(i.videoTransferFPS=0),n.lastPublishStats.framesSent=t.framesSent):"candidate-pair"==t.type?(null!=t.totalRoundTripTime&&(i.totalRoundTripTime=t.totalRoundTripTime),null!=t.currentRoundTripTime&&(i.currentRoundTripTime=t.currentRoundTripTime)):"media-source"==t.type&&("audio"==t.kind||t.id.toLowerCase().indexOf("audio")>=0)&&(i.audioLevel=t.audioLevel)}),this.uploadPublishQuality(i),0!=p&&this.onPublishQualityUpdate(this.streamId,i)}},t.prototype.uploadPublishQuality=function(t){var n=this;if(this.qualityUpload){var i=Date.parse(new Date+"");(0==this.qualityUploadLastTime||i-this.qualityUploadLastTime>=this.qualityUploadInterval)&&(t.stream_type="publish",t.stream_id=this.streamId,t.timeStamp=i/1e3,this.logger.info("zp.upq.0 upload"+JSON.stringify(t)),this.signal.QualityReport(v.getSeq(),this.sessionId,t,function(t,i,l){void 0!==l.report&&(n.qualityUpload=l.report,n.qualityUploadInterval=l.report_interval_ms)},function(t,i){n.logger.info("zp.upq.0 upload failed "+t)}),this.qualityUploadLastTime=i)}},t.prototype.stopPublish=function(){if(this.logger.info("zp.sp.0.1 called"),Object.keys(this.streamCenter.publisherList).length=1)for(var t in this.streamCenter.playerList){var n=this.streamCenter.playerList[t].player;n.state==p.ENUM_PLAY_STATE.playing&&n.broadcasterStatus==p.ENUM_BROADCASTER_STATUS.start&&(this.signal&&this.signal.sendBroadcasterStatus(v.getSeq(),n.sessionId,0),n.broadcasterStatus=p.ENUM_BROADCASTER_STATUS.stop)}this.sessionId&&!this.closeSessionSignal&&this.signal.sendCloseSession(v.getSeq(),this.sessionId,0),this.dataReport.eventEndWithMsg(this.reportSeq,"PublishState",{state:this.state+""}),this.dataReport.addEvent(this.reportSeq,"StopPublish"),this.dataReport.addMsgExt(this.reportSeq,{stream:this.streamId,sessionId:this.sessionId}),this.dataReport.uploadReport(this.reportSeq,"RTCPublishStream"),this.resetPublish()},t.prototype.onPublishStateUpdate=function(t,n,i,l){},t.prototype.onPublishQualityUpdate=function(t,n){},t.prototype.onDisconnect=function(){this.logger.info("zp.od.0 call"),this.logger.info("zp.od.0 websocket disconnect"),this.dataReport.addEvent(this.reportSeq,"OnDisconnect"),this.publishStateUpdateError(v.publishErrorList.WEBSOCKET_ERROR)},t.prototype.playEffect=function(t,n,i,l){this.audioMixing.localStream=this.localStream,this.audioMixing.peerConnection=this.peerConnection,this.audioMixing.audioBuffer=n,this.audioMixing.playEffect(t.playTime,t.loop,t.replace,i,l)},t.prototype.pauseEffect=function(){this.audioMixing.pauseEffect()},t.prototype.resumeEffect=function(){this.audioMixing.resumeEffect()},t.prototype.stopMixingBuffer=function(){return this.audioMixing.stopMingBuffer()},t.prototype.mixingBuffer=function(t,n){this.audioMixing.localStream=this.localStream,this.audioMixing.peerConnection=this.peerConnection,this.audioMixing.mixingBuffer(t,n)},t.prototype.voiceChange=function(t){var n=null,i=null;if(this.pitchEffect||(this.pitchEffect=new R.pitchUtil(this.ac),n=this.ac.createMediaStreamSource(this.localStream),i=this.ac.createMediaStreamDestination(),n.connect(this.pitchEffect.input),this.pitchEffect.output.connect(i)),this.pitchEffect.setPitchOffset(t),!this.micTrack){var l=i.stream.getAudioTracks()[0],p=this.peerConnection.getSenders().find(function(t){return t.track.kind===l.kind});if(!p)return this.logger.error("zp.vc.0 no sender"),!1;this.micTrack=this.localStream.getAudioTracks()[0],p.replaceTrack(l),this.localStream.removeTrack(this.micTrack),this.localStream.addTrack(l)}},t.prototype.voiceBack=function(){var t=this;this.micTrack?(this.peerConnection.getSenders().find(function(n){return n.track.kind===t.micTrack.kind}).replaceTrack(this.micTrack),this.localStream.removeTrack(this.localStream.getAudioTracks()[0]),this.localStream.addTrack(this.micTrack),this.micTrack=null,this.pitchEffect=null):this.logger.error("zp.vb.0 mo mickTrack found")},t.prototype.publishSuccess=function(){for(var t in this.state!=p.ENUM_PUBLISH_STATE.publishing&&this.onPublishStateUpdate(v.ENUM_PUBLISH_STATE_UPDATE.start,this.streamId,null,!0),this.state=p.ENUM_PUBLISH_STATE.publishing,this.dataReport.eventStart(this.reportSeq,"PublishState"),this.streamCenter.playerList){var n=this.streamCenter.playerList[t].player;n.state==p.ENUM_PLAY_STATE.playing&&n.broadcasterStatus==p.ENUM_BROADCASTER_STATUS.stop&&(this.signal&&this.signal.sendBroadcasterStatus(v.getSeq(),n.sessionId,1),n.broadcasterStatus=p.ENUM_BROADCASTER_STATUS.start)}this.setPublishQualityTimer();var i=2,l=2;0!==this.localStream.getVideoTracks().length&&1==this.localStream.getVideoTracks()[0].enabled&&(i=0),0!==this.localStream.getAudioTracks().length&&1==this.localStream.getAudioTracks()[0].enabled&&(l=0),this.signal.sendStreamStatus(v.getSeq(),this.sessionId,i,l),this.streamCenter.soundLevelDelegate&&this.startSoundLevel()},t.prototype.startSoundLevel=function(){var t=this;if(this.localStream&&0!=this.localStream.getAudioTracks().length){this.script&&this.script.disconnect()&&(this.script=null),this.mic&&this.mic.disconnect()&&(this.mic=null);try{this.mic=this.ac.createMediaStreamSource(this.localStream),this.script=this.ac.createScriptProcessor(4096,1,1),this.mic.connect(this.script),this.script.connect(this.ac.destination),this.script.onaudioprocess=function(n){for(var i=n.inputBuffer.getChannelData(0),l=0,p=0;p<i.length;p++)l<i[p]&&(l=i[p]);t.soundLevel=100*l},this.ac.resume()}catch(t){this.logger.error("zp.ssl.0 get sound level failed "+t)}}else this.logger.info("zp.ssl.0 local stream no found")},t.prototype.stopSoundLevel=function(){this.logger.info("zp.ssl.0.1 call streamID: "+this.streamId),this.script&&this.script.disconnect(),this.mic&&this.mic.disconnect(),this.script=null,this.mic=null},t.prototype.startMixingAudio=function(t){var n=this;return this.logger.info("zp.sma.0 call"),t.forEach(function(t){if(n.audioMixList.find(function(n){return n.media==t}))n.logger.info("zp.sma.0 mix audio already exist");else{var i=new T.audioMixUtil(n.logger,n.ac);i.localStream=n.localStream,i.peerConnection=n.peerConnection,n.audioMixList.push({audioMix:i,media:t}),i.startMixingAudio(t)}}),!0},t.prototype.stopMixingAudio=function(t){var n=this;return this.logger.info("zp.sma.0.0 call"),t?t.forEach(function(t){for(var i=0;i<n.audioMixList.length;i++)if(n.audioMixList[i].media==t){n.audioMixList[i].audioMix.stopMixingAudio()&&n.audioMixList.splice(i--,1);break}}):(this.audioMixList.forEach(function(t){return t.audioMix.stopMixingAudio()}),this.audioMixList=[],this.audioMixing.isMixAudio&&this.audioMixing.stopMixingAudio()),!0},t}();n.ZegoPublish=S},function(t,n,i){var l;t.exports=function t(n,i,p){function v(T,E){if(!i[T]){if(!n[T]){var R="function"==typeof l&&l;if(!E&&R)return l(T,!0);if(e)return e(T,!0);var S=new Error("Cannot find module '"+T+"'");throw S.code="MODULE_NOT_FOUND",S}var L=i[T]={exports:{}};n[T][0].call(L.exports,function(t){var i=n[T][1][t];return v(i||t)},L,L.exports,t,n,i,p)}return i[T].exports}for(var e="function"==typeof l&&l,T=0;T<p.length;T++)v(p[T]);return v}({1:[function(t,n,i){"use strict";var l=t("./adapter_factory.js"),p=(0,l.adapterFactory)({window:window});n.exports=p},{"./adapter_factory.js":2}],2:[function(t,n,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.adapterFactory=function(){var t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).window,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0},i=p.log,l=p.detectBrowser(t),v={browserDetails:l,commonShim:h,extractVersion:p.extractVersion,disableLog:p.disableLog,disableWarnings:p.disableWarnings};switch(l.browser){case"chrome":if(!e||!e.shimPeerConnection||!n.shimChrome)return i("Chrome shim is not included in this adapter release."),v;i("adapter.js shimming chrome."),v.browserShim=e,e.shimGetUserMedia(t),e.shimMediaStream(t),e.shimPeerConnection(t),e.shimOnTrack(t),e.shimAddTrackRemoveTrack(t),e.shimGetSendersWithDtmf(t),e.shimGetStats(t),e.shimSenderReceiverGetStats(t),e.fixNegotiationNeeded(t),h.shimRTCIceCandidate(t),h.shimConnectionState(t),h.shimMaxMessageSize(t),h.shimSendThrowTypeError(t),h.removeAllowExtmapMixed(t);break;case"firefox":if(!S||!S.shimPeerConnection||!n.shimFirefox)return i("Firefox shim is not included in this adapter release."),v;i("adapter.js shimming firefox."),v.browserShim=S,S.shimGetUserMedia(t),S.shimPeerConnection(t),S.shimOnTrack(t),S.shimRemoveStream(t),S.shimSenderGetStats(t),S.shimReceiverGetStats(t),S.shimRTCDataChannel(t),h.shimRTCIceCandidate(t),h.shimConnectionState(t),h.shimMaxMessageSize(t),h.shimSendThrowTypeError(t);break;case"edge":if(!E||!E.shimPeerConnection||!n.shimEdge)return i("MS edge shim is not included in this adapter release."),v;i("adapter.js shimming edge."),v.browserShim=E,E.shimGetUserMedia(t),E.shimGetDisplayMedia(t),E.shimPeerConnection(t),E.shimReplaceTrack(t),h.shimMaxMessageSize(t),h.shimSendThrowTypeError(t);break;case"safari":if(!M||!n.shimSafari)return i("Safari shim is not included in this adapter release."),v;i("adapter.js shimming safari."),v.browserShim=M,M.shimRTCIceServerUrls(t),M.shimCreateOfferLegacy(t),M.shimCallbacksAPI(t),M.shimLocalStreamsAPI(t),M.shimRemoteStreamsAPI(t),M.shimTrackEventTransceiver(t),M.shimGetUserMedia(t),h.shimRTCIceCandidate(t),h.shimMaxMessageSize(t),h.shimSendThrowTypeError(t),h.removeAllowExtmapMixed(t);break;default:i("Unsupported browser!")}return v};var l=t("./utils"),p=f(l),v=t("./chrome/chrome_shim"),e=f(v),T=t("./edge/edge_shim"),E=f(T),R=t("./firefox/firefox_shim"),S=f(R),L=t("./safari/safari_shim"),M=f(L),u=t("./common_shim"),h=f(u);function f(t){if(t&&t.__esModule)return t;var n={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(n[i]=t[i]);return n.default=t,n}},{"./chrome/chrome_shim":3,"./common_shim":6,"./edge/edge_shim":7,"./firefox/firefox_shim":11,"./safari/safari_shim":14,"./utils":15}],3:[function(t,n,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.shimGetDisplayMedia=i.shimGetUserMedia=void 0;var l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},p=t("./getusermedia");Object.defineProperty(i,"shimGetUserMedia",{enumerable:!0,get:function(){return p.shimGetUserMedia}});var v=t("./getdisplaymedia");Object.defineProperty(i,"shimGetDisplayMedia",{enumerable:!0,get:function(){return v.shimGetDisplayMedia}}),i.shimMediaStream=function(t){t.MediaStream=t.MediaStream||t.webkitMediaStream},i.shimOnTrack=function(t){if("object"!==(void 0===t?"undefined":l(t))||!t.RTCPeerConnection||"ontrack"in t.RTCPeerConnection.prototype)T.wrapPeerConnectionEvent(t,"track",function(t){return t.transceiver||Object.defineProperty(t,"transceiver",{value:{receiver:t.receiver}}),t});else{Object.defineProperty(t.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(t){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=t)},enumerable:!0,configurable:!0});var n=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){var i=this;return this._ontrackpoly||(this._ontrackpoly=function(n){n.stream.addEventListener("addtrack",function(l){var p=void 0;p=t.RTCPeerConnection.prototype.getReceivers?i.getReceivers().find(function(t){return t.track&&t.track.id===l.track.id}):{track:l.track};var v=new Event("track");v.track=l.track,v.receiver=p,v.transceiver={receiver:p},v.streams=[n.stream],i.dispatchEvent(v)}),n.stream.getTracks().forEach(function(l){var p=void 0;p=t.RTCPeerConnection.prototype.getReceivers?i.getReceivers().find(function(t){return t.track&&t.track.id===l.id}):{track:l};var v=new Event("track");v.track=l,v.receiver=p,v.transceiver={receiver:p},v.streams=[n.stream],i.dispatchEvent(v)})},this.addEventListener("addstream",this._ontrackpoly)),n.apply(this,arguments)}}},i.shimGetSendersWithDtmf=function(t){if("object"===(void 0===t?"undefined":l(t))&&t.RTCPeerConnection&&!("getSenders"in t.RTCPeerConnection.prototype)&&"createDTMFSender"in t.RTCPeerConnection.prototype){var n=function(t,n){return{track:n,get dtmf(){return void 0===this._dtmf&&("audio"===n.kind?this._dtmf=t.createDTMFSender(n):this._dtmf=null),this._dtmf},_pc:t}};if(!t.RTCPeerConnection.prototype.getSenders){t.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};var i=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(t,l){var p=i.apply(this,arguments);return p||(p=n(this,t),this._senders.push(p)),p};var p=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(t){p.apply(this,arguments);var n=this._senders.indexOf(t);-1!==n&&this._senders.splice(n,1)}}var v=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(t){var i=this;this._senders=this._senders||[],v.apply(this,[t]),t.getTracks().forEach(function(t){i._senders.push(n(i,t))})};var e=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(t){var n=this;this._senders=this._senders||[],e.apply(this,[t]),t.getTracks().forEach(function(t){var i=n._senders.find(function(n){return n.track===t});i&&n._senders.splice(n._senders.indexOf(i),1)})}}else if("object"===(void 0===t?"undefined":l(t))&&t.RTCPeerConnection&&"getSenders"in t.RTCPeerConnection.prototype&&"createDTMFSender"in t.RTCPeerConnection.prototype&&t.RTCRtpSender&&!("dtmf"in t.RTCRtpSender.prototype)){var T=t.RTCPeerConnection.prototype.getSenders;t.RTCPeerConnection.prototype.getSenders=function(){var t=this,n=T.apply(this,[]);return n.forEach(function(n){return n._pc=t}),n},Object.defineProperty(t.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}},i.shimGetStats=function(t){if(t.RTCPeerConnection){var n=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(t,i,l){var p=this,v=arguments;if(arguments.length>0&&"function"==typeof t)return n.apply(this,arguments);if(0===n.length&&(0===arguments.length||"function"!=typeof arguments[0]))return n.apply(this,[]);var e=function(t){var n={},i=t.result();return i.forEach(function(t){var i={id:t.id,timestamp:t.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[t.type]||t.type};t.names().forEach(function(n){i[n]=t.stat(n)}),n[i.id]=i}),n},T=function(t){return new Map(Object.keys(t).map(function(n){return[n,t[n]]}))};return arguments.length>=2?n.apply(this,[function(t){v[1](T(e(t)))},arguments[0]]):new Promise(function(t,i){n.apply(p,[function(n){t(T(e(n)))},i])}).then(i,l)}}},i.shimSenderReceiverGetStats=function(t){if("object"===(void 0===t?"undefined":l(t))&&t.RTCPeerConnection&&t.RTCRtpSender&&t.RTCRtpReceiver){if(!("getStats"in t.RTCRtpSender.prototype)){var n=t.RTCPeerConnection.prototype.getSenders;n&&(t.RTCPeerConnection.prototype.getSenders=function(){var t=this,i=n.apply(this,[]);return i.forEach(function(n){return n._pc=t}),i});var i=t.RTCPeerConnection.prototype.addTrack;i&&(t.RTCPeerConnection.prototype.addTrack=function(){var t=i.apply(this,arguments);return t._pc=this,t}),t.RTCRtpSender.prototype.getStats=function(){var t=this;return this._pc.getStats().then(function(n){return T.filterStats(n,t.track,!0)})}}if(!("getStats"in t.RTCRtpReceiver.prototype)){var p=t.RTCPeerConnection.prototype.getReceivers;p&&(t.RTCPeerConnection.prototype.getReceivers=function(){var t=this,n=p.apply(this,[]);return n.forEach(function(n){return n._pc=t}),n}),T.wrapPeerConnectionEvent(t,"track",function(t){return t.receiver._pc=t.srcElement,t}),t.RTCRtpReceiver.prototype.getStats=function(){var t=this;return this._pc.getStats().then(function(n){return T.filterStats(n,t.track,!1)})}}if("getStats"in t.RTCRtpSender.prototype&&"getStats"in t.RTCRtpReceiver.prototype){var v=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof t.MediaStreamTrack){var n=arguments[0],i=void 0,l=void 0,p=void 0;return this.getSenders().forEach(function(t){t.track===n&&(i?p=!0:i=t)}),this.getReceivers().forEach(function(t){return t.track===n&&(l?p=!0:l=t),t.track===n}),p||i&&l?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):i?i.getStats():l?l.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return v.apply(this,arguments)}}}},i.shimAddTrackRemoveTrackWithNative=E,i.shimAddTrackRemoveTrack=function(t){if(t.RTCPeerConnection){var n=T.detectBrowser(t);if(t.RTCPeerConnection.prototype.addTrack&&n.version>=65)return E(t);var i=t.RTCPeerConnection.prototype.getLocalStreams;t.RTCPeerConnection.prototype.getLocalStreams=function(){var t=this,n=i.apply(this);return this._reverseStreams=this._reverseStreams||{},n.map(function(n){return t._reverseStreams[n.id]})};var l=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(n){var i=this;if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},n.getTracks().forEach(function(t){var n=i.getSenders().find(function(n){return n.track===t});if(n)throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[n.id]){var p=new t.MediaStream(n.getTracks());this._streams[n.id]=p,this._reverseStreams[p.id]=n,n=p}l.apply(this,[n])};var p=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(t){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},p.apply(this,[this._streams[t.id]||t]),delete this._reverseStreams[this._streams[t.id]?this._streams[t.id].id:t.id],delete this._streams[t.id]},t.RTCPeerConnection.prototype.addTrack=function(n,i){var l=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var p=[].slice.call(arguments,1);if(1!==p.length||!p[0].getTracks().find(function(t){return t===n}))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");var v=this.getSenders().find(function(t){return t.track===n});if(v)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};var e=this._streams[i.id];if(e)e.addTrack(n),Promise.resolve().then(function(){l.dispatchEvent(new Event("negotiationneeded"))});else{var T=new t.MediaStream([n]);this._streams[i.id]=T,this._reverseStreams[T.id]=i,this.addStream(T)}return this.getSenders().find(function(t){return t.track===n})},["createOffer","createAnswer"].forEach(function(n){var i=t.RTCPeerConnection.prototype[n];t.RTCPeerConnection.prototype[n]=function(){var t=this,n=arguments,l=arguments.length&&"function"==typeof arguments[0];return l?i.apply(this,[function(i){var l=R(t,i);n[0].apply(null,[l])},function(t){n[1]&&n[1].apply(null,t)},arguments[2]]):i.apply(this,arguments).then(function(n){return R(t,n)})}});var v=t.RTCPeerConnection.prototype.setLocalDescription;t.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=(t=this,n=arguments[0],i=n.sdp,Object.keys(t._reverseStreams||[]).forEach(function(n){var l=t._reverseStreams[n],p=t._streams[l.id];i=i.replace(new RegExp(l.id,"g"),p.id)}),new RTCSessionDescription({type:n.type,sdp:i})),v.apply(this,arguments)):v.apply(this,arguments);var t,n,i};var e=Object.getOwnPropertyDescriptor(t.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(t.RTCPeerConnection.prototype,"localDescription",{get:function(){var t=e.get.apply(this);return""===t.type?t:R(this,t)}}),t.RTCPeerConnection.prototype.removeTrack=function(t){var n=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!t._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");var i=t._pc===this;if(!i)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};var l=void 0;Object.keys(this._streams).forEach(function(i){var p=n._streams[i].getTracks().find(function(n){return t.track===n});p&&(l=n._streams[i])}),l&&(1===l.getTracks().length?this.removeStream(this._reverseStreams[l.id]):l.removeTrack(t.track),this.dispatchEvent(new Event("negotiationneeded")))}}function R(t,n){var i=n.sdp;return Object.keys(t._reverseStreams||[]).forEach(function(n){var l=t._reverseStreams[n],p=t._streams[l.id];i=i.replace(new RegExp(p.id,"g"),l.id)}),new RTCSessionDescription({type:n.type,sdp:i})}},i.shimPeerConnection=function(t){if(!t.RTCPeerConnection&&t.webkitRTCPeerConnection&&(t.RTCPeerConnection=t.webkitRTCPeerConnection),t.RTCPeerConnection){["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(n){var i=t.RTCPeerConnection.prototype[n];t.RTCPeerConnection.prototype[n]=function(){return arguments[0]=new("addIceCandidate"===n?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}});var n=t.RTCPeerConnection.prototype.addIceCandidate;t.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}},i.fixNegotiationNeeded=function(t){T.wrapPeerConnectionEvent(t,"negotiationneeded",function(t){var n=t.target;if("stable"===n.signalingState)return t})};var e=t("../utils.js"),T=function(t){if(t&&t.__esModule)return t;var n={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(n[i]=t[i]);return n.default=t,n}(e);function E(t){t.RTCPeerConnection.prototype.getLocalStreams=function(){var t=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(function(n){return t._shimmedLocalStreams[n][0]})};var n=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(t,i){if(!i)return n.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};var l=n.apply(this,arguments);return this._shimmedLocalStreams[i.id]?-1===this._shimmedLocalStreams[i.id].indexOf(l)&&this._shimmedLocalStreams[i.id].push(l):this._shimmedLocalStreams[i.id]=[i,l],l};var i=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(t){var n=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{},t.getTracks().forEach(function(t){var i=n.getSenders().find(function(n){return n.track===t});if(i)throw new DOMException("Track already exists.","InvalidAccessError")});var l=this.getSenders();i.apply(this,arguments);var p=this.getSenders().filter(function(t){return-1===l.indexOf(t)});this._shimmedLocalStreams[t.id]=[t].concat(p)};var l=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(t){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[t.id],l.apply(this,arguments)};var p=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(t){var n=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},t&&Object.keys(this._shimmedLocalStreams).forEach(function(i){var l=n._shimmedLocalStreams[i].indexOf(t);-1!==l&&n._shimmedLocalStreams[i].splice(l,1),1===n._shimmedLocalStreams[i].length&&delete n._shimmedLocalStreams[i]}),p.apply(this,arguments)}}},{"../utils.js":15,"./getdisplaymedia":4,"./getusermedia":5}],4:[function(t,n,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.shimGetDisplayMedia=function(t,n){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&("function"==typeof n?t.navigator.mediaDevices.getDisplayMedia=function(i){return n(i).then(function(n){var l=i.video&&i.video.width,p=i.video&&i.video.height,v=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:n,maxFrameRate:v||3}},l&&(i.video.mandatory.maxWidth=l),p&&(i.video.mandatory.maxHeight=p),t.navigator.mediaDevices.getUserMedia(i)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}},{}],5:[function(t,n,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};i.shimGetUserMedia=function(t){var n=t&&t.navigator;if(n.mediaDevices){var i=v.detectBrowser(t),p=function(t){if("object"!==(void 0===t?"undefined":l(t))||t.mandatory||t.optional)return t;var n={};return Object.keys(t).forEach(function(i){if("require"!==i&&"advanced"!==i&&"mediaSource"!==i){var p="object"===l(t[i])?t[i]:{ideal:t[i]};void 0!==p.exact&&"number"==typeof p.exact&&(p.min=p.max=p.exact);var v=function(t,n){return t?t+n.charAt(0).toUpperCase()+n.slice(1):"deviceId"===n?"sourceId":n};if(void 0!==p.ideal){n.optional=n.optional||[];var e={};"number"==typeof p.ideal?(e[v("min",i)]=p.ideal,n.optional.push(e),(e={})[v("max",i)]=p.ideal,n.optional.push(e)):(e[v("",i)]=p.ideal,n.optional.push(e))}void 0!==p.exact&&"number"!=typeof p.exact?(n.mandatory=n.mandatory||{},n.mandatory[v("",i)]=p.exact):["min","max"].forEach(function(t){void 0!==p[t]&&(n.mandatory=n.mandatory||{},n.mandatory[v(t,i)]=p[t])})}}),t.advanced&&(n.optional=(n.optional||[]).concat(t.advanced)),n},T=function(t,v){if(i.version>=61)return v(t);if((t=JSON.parse(JSON.stringify(t)))&&"object"===l(t.audio)){var T=function(t,n,i){n in t&&!(i in t)&&(t[i]=t[n],delete t[n])};t=JSON.parse(JSON.stringify(t)),T(t.audio,"autoGainControl","googAutoGainControl"),T(t.audio,"noiseSuppression","googNoiseSuppression"),t.audio=p(t.audio)}if(t&&"object"===l(t.video)){var E=t.video.facingMode;E=E&&("object"===(void 0===E?"undefined":l(E))?E:{ideal:E});var R=i.version<66;if(E&&("user"===E.exact||"environment"===E.exact||"user"===E.ideal||"environment"===E.ideal)&&(!n.mediaDevices.getSupportedConstraints||!n.mediaDevices.getSupportedConstraints().facingMode||R)){delete t.video.facingMode;var S=void 0;if("environment"===E.exact||"environment"===E.ideal?S=["back","rear"]:"user"!==E.exact&&"user"!==E.ideal||(S=["front"]),S)return n.mediaDevices.enumerateDevices().then(function(n){var i=(n=n.filter(function(t){return"videoinput"===t.kind})).find(function(t){return S.some(function(n){return t.label.toLowerCase().includes(n)})});return!i&&n.length&&S.includes("back")&&(i=n[n.length-1]),i&&(t.video.deviceId=E.exact?{exact:i.deviceId}:{ideal:i.deviceId}),t.video=p(t.video),e("chrome: "+JSON.stringify(t)),v(t)})}t.video=p(t.video)}return e("chrome: "+JSON.stringify(t)),v(t)},E=function(t){return i.version>=64?t:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[t.name]||t.name,message:t.message,constraint:t.constraint||t.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}};if(n.getUserMedia=function(t,i,l){T(t,function(t){n.webkitGetUserMedia(t,i,function(t){l&&l(E(t))})})}.bind(n),n.mediaDevices.getUserMedia){var R=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(t){return T(t,function(t){return R(t).then(function(n){if(t.audio&&!n.getAudioTracks().length||t.video&&!n.getVideoTracks().length)throw n.getTracks().forEach(function(t){t.stop()}),new DOMException("","NotFoundError");return n},function(t){return Promise.reject(E(t))})})}}}};var p=t("../utils.js"),v=function(t){if(t&&t.__esModule)return t;var n={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(n[i]=t[i]);return n.default=t,n}(p),e=v.log},{"../utils.js":15}],6:[function(t,n,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};i.shimRTCIceCandidate=function(t){if(t.RTCIceCandidate&&!(t.RTCIceCandidate&&"foundation"in t.RTCIceCandidate.prototype)){var n=t.RTCIceCandidate;t.RTCIceCandidate=function(t){if("object"===(void 0===t?"undefined":l(t))&&t.candidate&&0===t.candidate.indexOf("a=")&&((t=JSON.parse(JSON.stringify(t))).candidate=t.candidate.substr(2)),t.candidate&&t.candidate.length){var i=new n(t),p=e.default.parseCandidate(t.candidate),v=Object.assign(i,p);return v.toJSON=function(){return{candidate:v.candidate,sdpMid:v.sdpMid,sdpMLineIndex:v.sdpMLineIndex,usernameFragment:v.usernameFragment}},v}return new n(t)},t.RTCIceCandidate.prototype=n.prototype,E.wrapPeerConnectionEvent(t,"icecandidate",function(n){return n.candidate&&Object.defineProperty(n,"candidate",{value:new t.RTCIceCandidate(n.candidate),writable:"false"}),n})}},i.shimMaxMessageSize=function(t){if(!t.RTCSctpTransport&&t.RTCPeerConnection){var n=E.detectBrowser(t);"sctp"in t.RTCPeerConnection.prototype||Object.defineProperty(t.RTCPeerConnection.prototype,"sctp",{get:function(){return void 0===this._sctp?null:this._sctp}});var i=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,function(t){if(!t||!t.sdp)return!1;var n=e.default.splitSections(t.sdp);return n.shift(),n.some(function(t){var n=e.default.parseMLine(t);return n&&"application"===n.kind&&-1!==n.protocol.indexOf("SCTP")})}(arguments[0])){var t=function(t){var n=t.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===n||n.length<2)return-1;var i=parseInt(n[1],10);return i!=i?-1:i}(arguments[0]),l=(E=t,R=65536,"firefox"===n.browser&&(R=n.version<57?-1===E?16384:2147483637:n.version<60?57===n.version?65535:65536:2147483637),R),p=function(t,i){var l=65536;"firefox"===n.browser&&57===n.version&&(l=65535);var p=e.default.matchPrefix(t.sdp,"a=max-message-size:");return p.length>0?l=parseInt(p[0].substr(19),10):"firefox"===n.browser&&-1!==i&&(l=2147483637),l}(arguments[0],t),v=void 0;v=0===l&&0===p?Number.POSITIVE_INFINITY:0===l||0===p?Math.max(l,p):Math.min(l,p);var T={};Object.defineProperty(T,"maxMessageSize",{get:function(){return v}}),this._sctp=T}var E,R;return i.apply(this,arguments)}}},i.shimSendThrowTypeError=function(t){if(t.RTCPeerConnection&&"createDataChannel"in t.RTCPeerConnection.prototype){var n=t.RTCPeerConnection.prototype.createDataChannel;t.RTCPeerConnection.prototype.createDataChannel=function(){var t=n.apply(this,arguments);return i(t,this),t},E.wrapPeerConnectionEvent(t,"datachannel",function(t){return i(t.channel,t.target),t})}function i(t,n){var i=t.send;t.send=function(){var l=arguments[0],p=l.length||l.size||l.byteLength;if("open"===t.readyState&&n.sctp&&p>n.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+n.sctp.maxMessageSize+" bytes)");return i.apply(t,arguments)}}},i.shimConnectionState=function(t){if(t.RTCPeerConnection&&!("connectionState"in t.RTCPeerConnection.prototype)){var n=t.RTCPeerConnection.prototype;Object.defineProperty(n,"connectionState",{get:function(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(n,"onconnectionstatechange",{get:function(){return this._onconnectionstatechange||null},set:function(t){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),t&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=t)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(function(t){var i=n[t];n[t]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=function(t){var n=t.target;if(n._lastConnectionState!==n.connectionState){n._lastConnectionState=n.connectionState;var i=new Event("connectionstatechange",t);n.dispatchEvent(i)}return t},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}})}},i.removeAllowExtmapMixed=function(t){if(t.RTCPeerConnection){var n=E.detectBrowser(t);if(!("chrome"===n.browser&&n.version>=71)){var i=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(t){return t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")&&(t.sdp=t.sdp.split("\n").filter(function(t){return"a=extmap-allow-mixed"!==t.trim()}).join("\n")),i.apply(this,arguments)}}}};var p,v=t("sdp"),e=(p=v)&&p.__esModule?p:{default:p},T=t("./utils"),E=function(t){if(t&&t.__esModule)return t;var n={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(n[i]=t[i]);return n.default=t,n}(T)},{"./utils":15,sdp:17}],7:[function(t,n,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.shimGetDisplayMedia=i.shimGetUserMedia=void 0;var l=t("./getusermedia");Object.defineProperty(i,"shimGetUserMedia",{enumerable:!0,get:function(){return l.shimGetUserMedia}});var p=t("./getdisplaymedia");Object.defineProperty(i,"shimGetDisplayMedia",{enumerable:!0,get:function(){return p.shimGetDisplayMedia}}),i.shimPeerConnection=function(t){var n=T.detectBrowser(t);if(t.RTCIceGatherer&&(t.RTCIceCandidate||(t.RTCIceCandidate=function(t){return t}),t.RTCSessionDescription||(t.RTCSessionDescription=function(t){return t}),n.version<15025)){var i=Object.getOwnPropertyDescriptor(t.MediaStreamTrack.prototype,"enabled");Object.defineProperty(t.MediaStreamTrack.prototype,"enabled",{set:function(t){i.set.call(this,t);var n=new Event("enabled");n.enabled=t,this.dispatchEvent(n)}})}!t.RTCRtpSender||"dtmf"in t.RTCRtpSender.prototype||Object.defineProperty(t.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new t.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),t.RTCDtmfSender&&!t.RTCDTMFSender&&(t.RTCDTMFSender=t.RTCDtmfSender);var l=(0,S.default)(t,n.version);t.RTCPeerConnection=function(t){return t&&t.iceServers&&(t.iceServers=(0,E.filterIceServers)(t.iceServers,n.version),T.log("ICE servers after filtering:",t.iceServers)),new l(t)},t.RTCPeerConnection.prototype=l.prototype},i.shimReplaceTrack=function(t){!t.RTCRtpSender||"replaceTrack"in t.RTCRtpSender.prototype||(t.RTCRtpSender.prototype.replaceTrack=t.RTCRtpSender.prototype.setTrack)};var v,e=t("../utils"),T=function(t){if(t&&t.__esModule)return t;var n={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(n[i]=t[i]);return n.default=t,n}(e),E=t("./filtericeservers"),R=t("rtcpeerconnection-shim"),S=(v=R)&&v.__esModule?v:{default:v}},{"../utils":15,"./filtericeservers":8,"./getdisplaymedia":9,"./getusermedia":10,"rtcpeerconnection-shim":16}],8:[function(t,n,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.filterIceServers=function(t,n){var i=!1;return(t=JSON.parse(JSON.stringify(t))).filter(function(t){if(t&&(t.urls||t.url)){var n=t.urls||t.url;t.url&&!t.urls&&p.deprecated("RTCIceServer.url","RTCIceServer.urls");var l="string"==typeof n;return l&&(n=[n]),n=n.filter(function(t){if(0===t.indexOf("stun:"))return!1;var n=t.startsWith("turn")&&!t.startsWith("turn:[")&&t.includes("transport=udp");return n&&!i?(i=!0,!0):n&&!i}),delete t.url,t.urls=l?n[0]:n,!!n.length}})};var l=t("../utils"),p=function(t){if(t&&t.__esModule)return t;var n={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(n[i]=t[i]);return n.default=t,n}(l)},{"../utils":15}],9:[function(t,n,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.shimGetDisplayMedia=function(t){"getDisplayMedia"in t.navigator&&t.navigator.mediaDevices&&(t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||(t.navigator.mediaDevices.getDisplayMedia=t.navigator.getDisplayMedia.bind(t.navigator)))}},{}],10:[function(t,n,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.shimGetUserMedia=function(t){var n=t&&t.navigator,i=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(t){return i(t).catch(function(t){return Promise.reject(function(t){return{name:{PermissionDeniedError:"NotAllowedError"}[t.name]||t.name,message:t.message,constraint:t.constraint,toString:function(){return this.name}}}(t))})}}},{}],11:[function(t,n,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.shimGetDisplayMedia=i.shimGetUserMedia=void 0;var l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},p=t("./getusermedia");Object.defineProperty(i,"shimGetUserMedia",{enumerable:!0,get:function(){return p.shimGetUserMedia}});var v=t("./getdisplaymedia");Object.defineProperty(i,"shimGetDisplayMedia",{enumerable:!0,get:function(){return v.shimGetDisplayMedia}}),i.shimOnTrack=function(t){"object"===(void 0===t?"undefined":l(t))&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},i.shimPeerConnection=function(t){var n=T.detectBrowser(t);if("object"===(void 0===t?"undefined":l(t))&&(t.RTCPeerConnection||t.mozRTCPeerConnection)){!t.RTCPeerConnection&&t.mozRTCPeerConnection&&(t.RTCPeerConnection=t.mozRTCPeerConnection),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(n){var i=t.RTCPeerConnection.prototype[n];t.RTCPeerConnection.prototype[n]=function(){return arguments[0]=new("addIceCandidate"===n?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}});var i=t.RTCPeerConnection.prototype.addIceCandidate;t.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};var p={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},v=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(t,i,l){return v.apply(this,[t||null]).then(function(t){if(n.version<53&&!i)try{t.forEach(function(t){t.type=p[t.type]||t.type})}catch(n){if("TypeError"!==n.name)throw n;t.forEach(function(n,i){t.set(i,Object.assign({},n,{type:p[n.type]||n.type}))})}return t}).then(i,l)}}},i.shimSenderGetStats=function(t){if("object"===(void 0===t?"undefined":l(t))&&t.RTCPeerConnection&&t.RTCRtpSender&&!(t.RTCRtpSender&&"getStats"in t.RTCRtpSender.prototype)){var n=t.RTCPeerConnection.prototype.getSenders;n&&(t.RTCPeerConnection.prototype.getSenders=function(){var t=this,i=n.apply(this,[]);return i.forEach(function(n){return n._pc=t}),i});var i=t.RTCPeerConnection.prototype.addTrack;i&&(t.RTCPeerConnection.prototype.addTrack=function(){var t=i.apply(this,arguments);return t._pc=this,t}),t.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}},i.shimReceiverGetStats=function(t){if("object"===(void 0===t?"undefined":l(t))&&t.RTCPeerConnection&&t.RTCRtpSender&&!(t.RTCRtpSender&&"getStats"in t.RTCRtpReceiver.prototype)){var n=t.RTCPeerConnection.prototype.getReceivers;n&&(t.RTCPeerConnection.prototype.getReceivers=function(){var t=this,i=n.apply(this,[]);return i.forEach(function(n){return n._pc=t}),i}),T.wrapPeerConnectionEvent(t,"track",function(t){return t.receiver._pc=t.srcElement,t}),t.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}},i.shimRemoveStream=function(t){!t.RTCPeerConnection||"removeStream"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.removeStream=function(t){var n=this;T.deprecated("removeStream","removeTrack"),this.getSenders().forEach(function(i){i.track&&t.getTracks().includes(i.track)&&n.removeTrack(i)})})},i.shimRTCDataChannel=function(t){t.DataChannel&&!t.RTCDataChannel&&(t.RTCDataChannel=t.DataChannel)};var e=t("../utils"),T=function(t){if(t&&t.__esModule)return t;var n={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(n[i]=t[i]);return n.default=t,n}(e)},{"../utils":15,"./getdisplaymedia":12,"./getusermedia":13}],12:[function(t,n,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.shimGetDisplayMedia=function(t,n){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(t.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){var l=new DOMException("getDisplayMedia without video constraints is undefined");return l.name="NotFoundError",l.code=8,Promise.reject(l)}return!0===i.video?i.video={mediaSource:n}:i.video.mediaSource=n,t.navigator.mediaDevices.getUserMedia(i)})}},{}],13:[function(t,n,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};i.shimGetUserMedia=function(t){var n=v.detectBrowser(t),i=t&&t.navigator,p=t&&t.MediaStreamTrack;if(i.getUserMedia=function(t,n,l){v.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(t).then(n,l)},!(n.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){var e=function(t,n,i){n in t&&!(i in t)&&(t[i]=t[n],delete t[n])},T=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(t){return"object"===(void 0===t?"undefined":l(t))&&"object"===l(t.audio)&&(t=JSON.parse(JSON.stringify(t)),e(t.audio,"autoGainControl","mozAutoGainControl"),e(t.audio,"noiseSuppression","mozNoiseSuppression")),T(t)},p&&p.prototype.getSettings){var E=p.prototype.getSettings;p.prototype.getSettings=function(){var t=E.apply(this,arguments);return e(t,"mozAutoGainControl","autoGainControl"),e(t,"mozNoiseSuppression","noiseSuppression"),t}}if(p&&p.prototype.applyConstraints){var R=p.prototype.applyConstraints;p.prototype.applyConstraints=function(t){return"audio"===this.kind&&"object"===(void 0===t?"undefined":l(t))&&(t=JSON.parse(JSON.stringify(t)),e(t,"autoGainControl","mozAutoGainControl"),e(t,"noiseSuppression","mozNoiseSuppression")),R.apply(this,[t])}}}};var p=t("../utils"),v=function(t){if(t&&t.__esModule)return t;var n={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(n[i]=t[i]);return n.default=t,n}(p)},{"../utils":15}],14:[function(t,n,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};i.shimLocalStreamsAPI=function(t){if("object"===(void 0===t?"undefined":l(t))&&t.RTCPeerConnection){if("getLocalStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in t.RTCPeerConnection.prototype)){var n=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addStream=function(t){var i=this;this._localStreams||(this._localStreams=[]),this._localStreams.includes(t)||this._localStreams.push(t),t.getTracks().forEach(function(l){return n.call(i,l,t)})},t.RTCPeerConnection.prototype.addTrack=function(t,i){return i&&(this._localStreams?this._localStreams.includes(i)||this._localStreams.push(i):this._localStreams=[i]),n.call(this,t,i)}}"removeStream"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.removeStream=function(t){var n=this;this._localStreams||(this._localStreams=[]);var i=this._localStreams.indexOf(t);if(-1!==i){this._localStreams.splice(i,1);var l=t.getTracks();this.getSenders().forEach(function(t){l.includes(t.track)&&n.removeTrack(t)})}})}},i.shimRemoteStreamsAPI=function(t){if("object"===(void 0===t?"undefined":l(t))&&t.RTCPeerConnection&&("getRemoteStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in t.RTCPeerConnection.prototype))){Object.defineProperty(t.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(t){var n=this;this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=t),this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach(function(t){if(n._remoteStreams||(n._remoteStreams=[]),!n._remoteStreams.includes(t)){n._remoteStreams.push(t);var i=new Event("addstream");i.stream=t,n.dispatchEvent(i)}})})}});var n=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){var t=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(n){n.streams.forEach(function(n){if(t._remoteStreams||(t._remoteStreams=[]),!(t._remoteStreams.indexOf(n)>=0)){t._remoteStreams.push(n);var i=new Event("addstream");i.stream=n,t.dispatchEvent(i)}})}),n.apply(t,arguments)}}},i.shimCallbacksAPI=function(t){if("object"===(void 0===t?"undefined":l(t))&&t.RTCPeerConnection){var n=t.RTCPeerConnection.prototype,i=n.createOffer,p=n.createAnswer,v=n.setLocalDescription,e=n.setRemoteDescription,T=n.addIceCandidate;n.createOffer=function(t,n){var l=arguments.length>=2?arguments[2]:arguments[0],p=i.apply(this,[l]);return n?(p.then(t,n),Promise.resolve()):p},n.createAnswer=function(t,n){var i=arguments.length>=2?arguments[2]:arguments[0],l=p.apply(this,[i]);return n?(l.then(t,n),Promise.resolve()):l};var E=function(t,n,i){var l=v.apply(this,[t]);return i?(l.then(n,i),Promise.resolve()):l};n.setLocalDescription=E,E=function(t,n,i){var l=e.apply(this,[t]);return i?(l.then(n,i),Promise.resolve()):l},n.setRemoteDescription=E,E=function(t,n,i){var l=T.apply(this,[t]);return i?(l.then(n,i),Promise.resolve()):l},n.addIceCandidate=E}},i.shimGetUserMedia=function(t){var n=t&&t.navigator;if(n.mediaDevices&&n.mediaDevices.getUserMedia){var i=n.mediaDevices,l=i.getUserMedia.bind(i);n.mediaDevices.getUserMedia=function(t){return l(e(t))}}!n.getUserMedia&&n.mediaDevices&&n.mediaDevices.getUserMedia&&(n.getUserMedia=function(t,i,l){n.mediaDevices.getUserMedia(t).then(i,l)}.bind(n))},i.shimConstraints=e,i.shimRTCIceServerUrls=function(t){var n=t.RTCPeerConnection;t.RTCPeerConnection=function(t,i){if(t&&t.iceServers){for(var l=[],p=0;p<t.iceServers.length;p++){var e=t.iceServers[p];!e.hasOwnProperty("urls")&&e.hasOwnProperty("url")?(v.deprecated("RTCIceServer.url","RTCIceServer.urls"),(e=JSON.parse(JSON.stringify(e))).urls=e.url,delete e.url,l.push(e)):l.push(t.iceServers[p])}t.iceServers=l}return new n(t,i)},t.RTCPeerConnection.prototype=n.prototype,"generateCertificate"in t.RTCPeerConnection&&Object.defineProperty(t.RTCPeerConnection,"generateCertificate",{get:function(){return n.generateCertificate}})},i.shimTrackEventTransceiver=function(t){"object"===(void 0===t?"undefined":l(t))&&t.RTCPeerConnection&&"receiver"in t.RTCTrackEvent.prototype&&!t.RTCTransceiver&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},i.shimCreateOfferLegacy=function(t){var n=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(t){if(t){void 0!==t.offerToReceiveAudio&&(t.offerToReceiveAudio=!!t.offerToReceiveAudio);var i=this.getTransceivers().find(function(t){return"audio"===t.receiver.track.kind});!1===t.offerToReceiveAudio&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):!0!==t.offerToReceiveAudio||i||this.addTransceiver("audio"),void 0!==t.offerToReceiveVideo&&(t.offerToReceiveVideo=!!t.offerToReceiveVideo);var l=this.getTransceivers().find(function(t){return"video"===t.receiver.track.kind});!1===t.offerToReceiveVideo&&l?"sendrecv"===l.direction?l.setDirection?l.setDirection("sendonly"):l.direction="sendonly":"recvonly"===l.direction&&(l.setDirection?l.setDirection("inactive"):l.direction="inactive"):!0!==t.offerToReceiveVideo||l||this.addTransceiver("video")}return n.apply(this,arguments)}};var p=t("../utils"),v=function(t){if(t&&t.__esModule)return t;var n={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(n[i]=t[i]);return n.default=t,n}(p);function e(t){return t&&void 0!==t.video?Object.assign({},t,{video:v.compactObject(t.video)}):t}},{"../utils":15}],15:[function(t,n,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};i.extractVersion=e,i.wrapPeerConnectionEvent=function(t,n,i){if(t.RTCPeerConnection){var l=t.RTCPeerConnection.prototype,p=l.addEventListener;l.addEventListener=function(t,l){if(t!==n)return p.apply(this,arguments);var v=function(t){var n=i(t);n&&l(n)};return this._eventMap=this._eventMap||{},this._eventMap[l]=v,p.apply(this,[t,v])};var v=l.removeEventListener;l.removeEventListener=function(t,i){if(t!==n||!this._eventMap||!this._eventMap[i])return v.apply(this,arguments);var l=this._eventMap[i];return delete this._eventMap[i],v.apply(this,[t,l])},Object.defineProperty(l,"on"+n,{get:function(){return this["_on"+n]},set:function(t){this["_on"+n]&&(this.removeEventListener(n,this["_on"+n]),delete this["_on"+n]),t&&this.addEventListener(n,this["_on"+n]=t)},enumerable:!0,configurable:!0})}},i.disableLog=function(t){return"boolean"!=typeof t?new Error("Argument type: "+(void 0===t?"undefined":l(t))+". Please use a boolean."):(p=t,t?"adapter.js logging disabled":"adapter.js logging enabled")},i.disableWarnings=function(t){return"boolean"!=typeof t?new Error("Argument type: "+(void 0===t?"undefined":l(t))+". Please use a boolean."):(v=!t,"adapter.js deprecation warnings "+(t?"disabled":"enabled"))},i.log=function(){if("object"===("undefined"==typeof window?"undefined":l(window))){if(p)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},i.deprecated=function(t,n){v&&console.warn(t+" is deprecated, please use "+n+" instead.")},i.detectBrowser=function(t){var n=t.navigator,i={browser:null,version:null};if(void 0===t||!t.navigator)return i.browser="Not a browser.",i;if(n.mozGetUserMedia)i.browser="firefox",i.version=e(n.userAgent,/Firefox\/(\d+)\./,1);else if(n.webkitGetUserMedia||!1===t.isSecureContext&&t.webkitRTCPeerConnection&&!t.RTCIceGatherer)i.browser="chrome",i.version=e(n.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(n.mediaDevices&&n.userAgent.match(/Edge\/(\d+).(\d+)$/))i.browser="edge",i.version=e(n.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!t.RTCPeerConnection||!n.userAgent.match(/AppleWebKit\/(\d+)\./))return i.browser="Not a supported browser.",i;i.browser="safari",i.version=e(n.userAgent,/AppleWebKit\/(\d+)\./,1)}return i},i.compactObject=function t(n){return"object"!==(void 0===n?"undefined":l(n))?n:Object.keys(n).reduce(function(i,p){var v="object"===l(n[p]),e=v?t(n[p]):n[p],T=v&&!Object.keys(e).length;return void 0===e||T?i:Object.assign(i,function(t,n,i){return n in t?Object.defineProperty(t,n,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[n]=i,t}({},p,e))},{})},i.walkStats=T,i.filterStats=function(t,n,i){var l=i?"outbound-rtp":"inbound-rtp",p=new Map;if(null===n)return p;var v=[];return t.forEach(function(t){"track"===t.type&&t.trackIdentifier===n.id&&v.push(t)}),v.forEach(function(n){t.forEach(function(i){i.type===l&&i.trackId===n.id&&T(t,i,p)})}),p};var p=!0,v=!0;function e(t,n,i){var l=t.match(n);return l&&l.length>=i&&parseInt(l[i],10)}function T(t,n,i){n&&!i.has(n.id)&&(i.set(n.id,n),Object.keys(n).forEach(function(l){l.endsWith("Id")?T(t,t.get(n[l]),i):l.endsWith("Ids")&&n[l].forEach(function(n){T(t,t.get(n),i)})}))}},{}],16:[function(t,n,i){"use strict";var l=t("sdp");function p(t,n,i,p,v){var e=l.writeRtpDescription(t.kind,n);if(e+=l.writeIceParameters(t.iceGatherer.getLocalParameters()),e+=l.writeDtlsParameters(t.dtlsTransport.getLocalParameters(),"offer"===i?"actpass":v||"active"),e+="a=mid:"+t.mid+"\r\n",t.rtpSender&&t.rtpReceiver?e+="a=sendrecv\r\n":t.rtpSender?e+="a=sendonly\r\n":t.rtpReceiver?e+="a=recvonly\r\n":e+="a=inactive\r\n",t.rtpSender){var T=t.rtpSender._initialTrackId||t.rtpSender.track.id;t.rtpSender._initialTrackId=T;var E="msid:"+(p?p.id:"-")+" "+T+"\r\n";e+="a="+E,e+="a=ssrc:"+t.sendEncodingParameters[0].ssrc+" "+E,t.sendEncodingParameters[0].rtx&&(e+="a=ssrc:"+t.sendEncodingParameters[0].rtx.ssrc+" "+E,e+="a=ssrc-group:FID "+t.sendEncodingParameters[0].ssrc+" "+t.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return e+="a=ssrc:"+t.sendEncodingParameters[0].ssrc+" cname:"+l.localCName+"\r\n",t.rtpSender&&t.sendEncodingParameters[0].rtx&&(e+="a=ssrc:"+t.sendEncodingParameters[0].rtx.ssrc+" cname:"+l.localCName+"\r\n"),e}function v(t,n){var i={codecs:[],headerExtensions:[],fecMechanisms:[]},l=function(t,n){t=parseInt(t,10);for(var i=0;i<n.length;i++)if(n[i].payloadType===t||n[i].preferredPayloadType===t)return n[i]},p=function(t,n,i,p){var v=l(t.parameters.apt,i),e=l(n.parameters.apt,p);return v&&e&&v.name.toLowerCase()===e.name.toLowerCase()};return t.codecs.forEach(function(l){for(var v=0;v<n.codecs.length;v++){var e=n.codecs[v];if(l.name.toLowerCase()===e.name.toLowerCase()&&l.clockRate===e.clockRate){if("rtx"===l.name.toLowerCase()&&l.parameters&&e.parameters.apt&&!p(l,e,t.codecs,n.codecs))continue;(e=JSON.parse(JSON.stringify(e))).numChannels=Math.min(l.numChannels,e.numChannels),i.codecs.push(e),e.rtcpFeedback=e.rtcpFeedback.filter(function(t){for(var n=0;n<l.rtcpFeedback.length;n++)if(l.rtcpFeedback[n].type===t.type&&l.rtcpFeedback[n].parameter===t.parameter)return!0;return!1});break}}}),t.headerExtensions.forEach(function(t){for(var l=0;l<n.headerExtensions.length;l++){var p=n.headerExtensions[l];if(t.uri===p.uri){i.headerExtensions.push(p);break}}}),i}function e(t,n,i){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[n][t].indexOf(i)}function T(t,n){var i=t.getRemoteCandidates().find(function(t){return n.foundation===t.foundation&&n.ip===t.ip&&n.port===t.port&&n.priority===t.priority&&n.protocol===t.protocol&&n.type===t.type});return i||t.addRemoteCandidate(n),!i}function E(t,n){var i=new Error(n);return i.name=t,i.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[t],i}n.exports=function(t,n){function i(n,i){i.addTrack(n),i.dispatchEvent(new t.MediaStreamTrackEvent("addtrack",{track:n}))}function R(n,i,l,p){var v=new Event("track");v.track=i,v.receiver=l,v.transceiver={receiver:l},v.streams=p,t.setTimeout(function(){n._dispatchEvent("track",v)})}var S=function(i){var p=this,v=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(t){p[t]=v[t].bind(v)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",i=JSON.parse(JSON.stringify(i||{})),this.usingBundle="max-bundle"===i.bundlePolicy,"negotiate"===i.rtcpMuxPolicy)throw E("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(i.rtcpMuxPolicy||(i.rtcpMuxPolicy="require"),i.iceTransportPolicy){case"all":case"relay":break;default:i.iceTransportPolicy="all"}switch(i.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:i.bundlePolicy="balanced"}if(i.iceServers=function(t,n){var i=!1;return(t=JSON.parse(JSON.stringify(t))).filter(function(t){if(t&&(t.urls||t.url)){var l=t.urls||t.url;t.url&&!t.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var p="string"==typeof l;return p&&(l=[l]),l=l.filter(function(t){return 0!==t.indexOf("turn:")||-1===t.indexOf("transport=udp")||-1!==t.indexOf("turn:[")||i?0===t.indexOf("stun:")&&n>=14393&&-1===t.indexOf("?transport=udp"):(i=!0,!0)}),delete t.url,t.urls=p?l[0]:l,!!l.length}})}(i.iceServers||[],n),this._iceGatherers=[],i.iceCandidatePoolSize)for(var e=i.iceCandidatePoolSize;e>0;e--)this._iceGatherers.push(new t.RTCIceGatherer({iceServers:i.iceServers,gatherPolicy:i.iceTransportPolicy}));else i.iceCandidatePoolSize=0;this._config=i,this.transceivers=[],this._sdpSessionId=l.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(S.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(S.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),S.prototype.onicecandidate=null,S.prototype.onaddstream=null,S.prototype.ontrack=null,S.prototype.onremovestream=null,S.prototype.onsignalingstatechange=null,S.prototype.oniceconnectionstatechange=null,S.prototype.onconnectionstatechange=null,S.prototype.onicegatheringstatechange=null,S.prototype.onnegotiationneeded=null,S.prototype.ondatachannel=null,S.prototype._dispatchEvent=function(t,n){this._isClosed||(this.dispatchEvent(n),"function"==typeof this["on"+t]&&this["on"+t](n))},S.prototype._emitGatheringStateChange=function(){var t=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",t)},S.prototype.getConfiguration=function(){return this._config},S.prototype.getLocalStreams=function(){return this.localStreams},S.prototype.getRemoteStreams=function(){return this.remoteStreams},S.prototype._createTransceiver=function(t,n){var i=this.transceivers.length>0,l={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:t,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&i)l.iceTransport=this.transceivers[0].iceTransport,l.dtlsTransport=this.transceivers[0].dtlsTransport;else{var p=this._createIceAndDtlsTransports();l.iceTransport=p.iceTransport,l.dtlsTransport=p.dtlsTransport}return n||this.transceivers.push(l),l},S.prototype.addTrack=function(n,i){if(this._isClosed)throw E("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var l,p=this.transceivers.find(function(t){return t.track===n});if(p)throw E("InvalidAccessError","Track already exists.");for(var v=0;v<this.transceivers.length;v++)this.transceivers[v].track||this.transceivers[v].kind!==n.kind||(l=this.transceivers[v]);return l||(l=this._createTransceiver(n.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(i)&&this.localStreams.push(i),l.track=n,l.stream=i,l.rtpSender=new t.RTCRtpSender(n,l.dtlsTransport),l.rtpSender},S.prototype.addStream=function(t){var i=this;if(n>=15025)t.getTracks().forEach(function(n){i.addTrack(n,t)});else{var l=t.clone();t.getTracks().forEach(function(t,n){var i=l.getTracks()[n];t.addEventListener("enabled",function(t){i.enabled=t.enabled})}),l.getTracks().forEach(function(t){i.addTrack(t,l)})}},S.prototype.removeTrack=function(n){if(this._isClosed)throw E("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(n instanceof t.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var i=this.transceivers.find(function(t){return t.rtpSender===n});if(!i)throw E("InvalidAccessError","Sender was not created by this connection.");var l=i.stream;i.rtpSender.stop(),i.rtpSender=null,i.track=null,i.stream=null;var p=this.transceivers.map(function(t){return t.stream});-1===p.indexOf(l)&&this.localStreams.indexOf(l)>-1&&this.localStreams.splice(this.localStreams.indexOf(l),1),this._maybeFireNegotiationNeeded()},S.prototype.removeStream=function(t){var n=this;t.getTracks().forEach(function(t){var i=n.getSenders().find(function(n){return n.track===t});i&&n.removeTrack(i)})},S.prototype.getSenders=function(){return this.transceivers.filter(function(t){return!!t.rtpSender}).map(function(t){return t.rtpSender})},S.prototype.getReceivers=function(){return this.transceivers.filter(function(t){return!!t.rtpReceiver}).map(function(t){return t.rtpReceiver})},S.prototype._createIceGatherer=function(n,i){var l=this;if(i&&n>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var p=new t.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(p,"state",{value:"new",writable:!0}),this.transceivers[n].bufferedCandidateEvents=[],this.transceivers[n].bufferCandidates=function(t){var i=!t.candidate||0===Object.keys(t.candidate).length;p.state=i?"completed":"gathering",null!==l.transceivers[n].bufferedCandidateEvents&&l.transceivers[n].bufferedCandidateEvents.push(t)},p.addEventListener("localcandidate",this.transceivers[n].bufferCandidates),p},S.prototype._gather=function(n,i){var p=this,v=this.transceivers[i].iceGatherer;if(!v.onlocalcandidate){var e=this.transceivers[i].bufferedCandidateEvents;this.transceivers[i].bufferedCandidateEvents=null,v.removeEventListener("localcandidate",this.transceivers[i].bufferCandidates),v.onlocalcandidate=function(t){if(!(p.usingBundle&&i>0)){var e=new Event("icecandidate");e.candidate={sdpMid:n,sdpMLineIndex:i};var T=t.candidate,E=!T||0===Object.keys(T).length;if(E)"new"!==v.state&&"gathering"!==v.state||(v.state="completed");else{"new"===v.state&&(v.state="gathering"),T.component=1,T.ufrag=v.getLocalParameters().usernameFragment;var R=l.writeCandidate(T);e.candidate=Object.assign(e.candidate,l.parseCandidate(R)),e.candidate.candidate=R,e.candidate.toJSON=function(){return{candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex,usernameFragment:e.candidate.usernameFragment}}}var S=l.getMediaSections(p._localDescription.sdp);S[e.candidate.sdpMLineIndex]+=E?"a=end-of-candidates\r\n":"a="+e.candidate.candidate+"\r\n",p._localDescription.sdp=l.getDescription(p._localDescription.sdp)+S.join("");var L=p.transceivers.every(function(t){return t.iceGatherer&&"completed"===t.iceGatherer.state});"gathering"!==p.iceGatheringState&&(p.iceGatheringState="gathering",p._emitGatheringStateChange()),E||p._dispatchEvent("icecandidate",e),L&&(p._dispatchEvent("icecandidate",new Event("icecandidate")),p.iceGatheringState="complete",p._emitGatheringStateChange())}},t.setTimeout(function(){e.forEach(function(t){v.onlocalcandidate(t)})},0)}},S.prototype._createIceAndDtlsTransports=function(){var n=this,i=new t.RTCIceTransport(null);i.onicestatechange=function(){n._updateIceConnectionState(),n._updateConnectionState()};var l=new t.RTCDtlsTransport(i);return l.ondtlsstatechange=function(){n._updateConnectionState()},l.onerror=function(){Object.defineProperty(l,"state",{value:"failed",writable:!0}),n._updateConnectionState()},{iceTransport:i,dtlsTransport:l}},S.prototype._disposeIceAndDtlsTransports=function(t){var n=this.transceivers[t].iceGatherer;n&&(delete n.onlocalcandidate,delete this.transceivers[t].iceGatherer);var i=this.transceivers[t].iceTransport;i&&(delete i.onicestatechange,delete this.transceivers[t].iceTransport);var l=this.transceivers[t].dtlsTransport;l&&(delete l.ondtlsstatechange,delete l.onerror,delete this.transceivers[t].dtlsTransport)},S.prototype._transceive=function(t,i,p){var e=v(t.localCapabilities,t.remoteCapabilities);i&&t.rtpSender&&(e.encodings=t.sendEncodingParameters,e.rtcp={cname:l.localCName,compound:t.rtcpParameters.compound},t.recvEncodingParameters.length&&(e.rtcp.ssrc=t.recvEncodingParameters[0].ssrc),t.rtpSender.send(e)),p&&t.rtpReceiver&&e.codecs.length>0&&("video"===t.kind&&t.recvEncodingParameters&&n<15019&&t.recvEncodingParameters.forEach(function(t){delete t.rtx}),t.recvEncodingParameters.length?e.encodings=t.recvEncodingParameters:e.encodings=[{}],e.rtcp={compound:t.rtcpParameters.compound},t.rtcpParameters.cname&&(e.rtcp.cname=t.rtcpParameters.cname),t.sendEncodingParameters.length&&(e.rtcp.ssrc=t.sendEncodingParameters[0].ssrc),t.rtpReceiver.receive(e))},S.prototype.setLocalDescription=function(t){var n,i,p=this;if(-1===["offer","answer"].indexOf(t.type))return Promise.reject(E("TypeError",'Unsupported type "'+t.type+'"'));if(!e("setLocalDescription",t.type,p.signalingState)||p._isClosed)return Promise.reject(E("InvalidStateError","Can not set local "+t.type+" in state "+p.signalingState));if("offer"===t.type)n=l.splitSections(t.sdp),i=n.shift(),n.forEach(function(t,n){var i=l.parseRtpParameters(t);p.transceivers[n].localCapabilities=i}),p.transceivers.forEach(function(t,n){p._gather(t.mid,n)});else if("answer"===t.type){n=l.splitSections(p._remoteDescription.sdp),i=n.shift();var T=l.matchPrefix(i,"a=ice-lite").length>0;n.forEach(function(t,n){var e=p.transceivers[n],E=e.iceGatherer,R=e.iceTransport,S=e.dtlsTransport,L=e.localCapabilities,M=e.remoteCapabilities,u=l.isRejected(t)&&0===l.matchPrefix(t,"a=bundle-only").length;if(!u&&!e.rejected){var h=l.getIceParameters(t,i),f=l.getDtlsParameters(t,i);T&&(f.role="server"),p.usingBundle&&0!==n||(p._gather(e.mid,n),"new"===R.state&&R.start(E,h,T?"controlling":"controlled"),"new"===S.state&&S.start(f));var U=v(L,M);p._transceive(e,U.codecs.length>0,!1)}})}return p._localDescription={type:t.type,sdp:t.sdp},"offer"===t.type?p._updateSignalingState("have-local-offer"):p._updateSignalingState("stable"),Promise.resolve()},S.prototype.setRemoteDescription=function(p){var S=this;if(-1===["offer","answer"].indexOf(p.type))return Promise.reject(E("TypeError",'Unsupported type "'+p.type+'"'));if(!e("setRemoteDescription",p.type,S.signalingState)||S._isClosed)return Promise.reject(E("InvalidStateError","Can not set remote "+p.type+" in state "+S.signalingState));var L={};S.remoteStreams.forEach(function(t){L[t.id]=t});var M=[],u=l.splitSections(p.sdp),h=u.shift(),f=l.matchPrefix(h,"a=ice-lite").length>0,U=l.matchPrefix(h,"a=group:BUNDLE ").length>0;S.usingBundle=U;var O=l.matchPrefix(h,"a=ice-options:")[0];return S.canTrickleIceCandidates=!!O&&O.substr(14).split(" ").indexOf("trickle")>=0,u.forEach(function(e,E){var R=l.splitLines(e),u=l.getKind(e),O=l.isRejected(e)&&0===l.matchPrefix(e,"a=bundle-only").length,N=R[0].substr(2).split(" ")[2],b=l.getDirection(e,h),D=l.parseMsid(e),A=l.getMid(e)||l.generateIdentifier();if(O||"application"===u&&("DTLS/SCTP"===N||"UDP/DTLS/SCTP"===N))S.transceivers[E]={mid:A,kind:u,protocol:N,rejected:!0};else{var w,k,x,H,G,j,V,W,F;!O&&S.transceivers[E]&&S.transceivers[E].rejected&&(S.transceivers[E]=S._createTransceiver(u,!0));var z,J,Y=l.parseRtpParameters(e);O||(z=l.getIceParameters(e,h),(J=l.getDtlsParameters(e,h)).role="client"),V=l.parseRtpEncodingParameters(e);var Q=l.parseRtcpParameters(e),Z=l.matchPrefix(e,"a=end-of-candidates",h).length>0,K=l.matchPrefix(e,"a=candidate:").map(function(t){return l.parseCandidate(t)}).filter(function(t){return 1===t.component});if(("offer"===p.type||"answer"===p.type)&&!O&&U&&E>0&&S.transceivers[E]&&(S._disposeIceAndDtlsTransports(E),S.transceivers[E].iceGatherer=S.transceivers[0].iceGatherer,S.transceivers[E].iceTransport=S.transceivers[0].iceTransport,S.transceivers[E].dtlsTransport=S.transceivers[0].dtlsTransport,S.transceivers[E].rtpSender&&S.transceivers[E].rtpSender.setTransport(S.transceivers[0].dtlsTransport),S.transceivers[E].rtpReceiver&&S.transceivers[E].rtpReceiver.setTransport(S.transceivers[0].dtlsTransport)),"offer"!==p.type||O){if("answer"===p.type&&!O){w=S.transceivers[E],k=w.iceGatherer,x=w.iceTransport,H=w.dtlsTransport,G=w.rtpReceiver,j=w.sendEncodingParameters,W=w.localCapabilities,S.transceivers[E].recvEncodingParameters=V,S.transceivers[E].remoteCapabilities=Y,S.transceivers[E].rtcpParameters=Q,K.length&&"new"===x.state&&(!f&&!Z||U&&0!==E?K.forEach(function(t){T(w.iceTransport,t)}):x.setRemoteCandidates(K)),U&&0!==E||("new"===x.state&&x.start(k,z,"controlling"),"new"===H.state&&H.start(J));var I=v(w.localCapabilities,w.remoteCapabilities),X=I.codecs.filter(function(t){return"rtx"===t.name.toLowerCase()}).length;!X&&w.sendEncodingParameters[0].rtx&&delete w.sendEncodingParameters[0].rtx,S._transceive(w,"sendrecv"===b||"recvonly"===b,"sendrecv"===b||"sendonly"===b),!G||"sendrecv"!==b&&"sendonly"!==b?delete w.rtpReceiver:(F=G.track,D?(L[D.stream]||(L[D.stream]=new t.MediaStream),i(F,L[D.stream]),M.push([F,G,L[D.stream]])):(L.default||(L.default=new t.MediaStream),i(F,L.default),M.push([F,G,L.default])))}}else{(w=S.transceivers[E]||S._createTransceiver(u)).mid=A,w.iceGatherer||(w.iceGatherer=S._createIceGatherer(E,U)),K.length&&"new"===w.iceTransport.state&&(!Z||U&&0!==E?K.forEach(function(t){T(w.iceTransport,t)}):w.iceTransport.setRemoteCandidates(K)),W=t.RTCRtpReceiver.getCapabilities(u),n<15019&&(W.codecs=W.codecs.filter(function(t){return"rtx"!==t.name})),j=w.sendEncodingParameters||[{ssrc:1001*(2*E+2)}];var $,a=!1;"sendrecv"===b||"sendonly"===b?(a=!w.rtpReceiver,G=w.rtpReceiver||new t.RTCRtpReceiver(w.dtlsTransport,u),a&&(F=G.track,D&&"-"===D.stream||(D?(L[D.stream]||(L[D.stream]=new t.MediaStream,Object.defineProperty(L[D.stream],"id",{get:function(){return D.stream}})),Object.defineProperty(F,"id",{get:function(){return D.track}}),$=L[D.stream]):(L.default||(L.default=new t.MediaStream),$=L.default)),$&&(i(F,$),w.associatedRemoteMediaStreams.push($)),M.push([F,G,$]))):w.rtpReceiver&&w.rtpReceiver.track&&(w.associatedRemoteMediaStreams.forEach(function(n){var i,l,p=n.getTracks().find(function(t){return t.id===w.rtpReceiver.track.id});p&&(i=p,(l=n).removeTrack(i),l.dispatchEvent(new t.MediaStreamTrackEvent("removetrack",{track:i})))}),w.associatedRemoteMediaStreams=[]),w.localCapabilities=W,w.remoteCapabilities=Y,w.rtpReceiver=G,w.rtcpParameters=Q,w.sendEncodingParameters=j,w.recvEncodingParameters=V,S._transceive(S.transceivers[E],!1,a)}}}),void 0===S._dtlsRole&&(S._dtlsRole="offer"===p.type?"active":"passive"),S._remoteDescription={type:p.type,sdp:p.sdp},"offer"===p.type?S._updateSignalingState("have-remote-offer"):S._updateSignalingState("stable"),Object.keys(L).forEach(function(n){var i=L[n];if(i.getTracks().length){if(-1===S.remoteStreams.indexOf(i)){S.remoteStreams.push(i);var l=new Event("addstream");l.stream=i,t.setTimeout(function(){S._dispatchEvent("addstream",l)})}M.forEach(function(t){var n=t[0],l=t[1];i.id===t[2].id&&R(S,n,l,[i])})}}),M.forEach(function(t){t[2]||R(S,t[0],t[1],[])}),t.setTimeout(function(){S&&S.transceivers&&S.transceivers.forEach(function(t){t.iceTransport&&"new"===t.iceTransport.state&&t.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),t.iceTransport.addRemoteCandidate({}))})},4e3),Promise.resolve()},S.prototype.close=function(){this.transceivers.forEach(function(t){t.iceTransport&&t.iceTransport.stop(),t.dtlsTransport&&t.dtlsTransport.stop(),t.rtpSender&&t.rtpSender.stop(),t.rtpReceiver&&t.rtpReceiver.stop()}),this._isClosed=!0,this._updateSignalingState("closed")},S.prototype._updateSignalingState=function(t){this.signalingState=t;var n=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",n)},S.prototype._maybeFireNegotiationNeeded=function(){var n=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,t.setTimeout(function(){if(n.needNegotiation){n.needNegotiation=!1;var t=new Event("negotiationneeded");n._dispatchEvent("negotiationneeded",t)}},0))},S.prototype._updateIceConnectionState=function(){var t,n={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(t){t.iceTransport&&!t.rejected&&n[t.iceTransport.state]++}),t="new",n.failed>0?t="failed":n.checking>0?t="checking":n.disconnected>0?t="disconnected":n.new>0?t="new":n.connected>0?t="connected":n.completed>0&&(t="completed"),t!==this.iceConnectionState){this.iceConnectionState=t;var i=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",i)}},S.prototype._updateConnectionState=function(){var t,n={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(t){t.iceTransport&&t.dtlsTransport&&!t.rejected&&(n[t.iceTransport.state]++,n[t.dtlsTransport.state]++)}),n.connected+=n.completed,t="new",n.failed>0?t="failed":n.connecting>0?t="connecting":n.disconnected>0?t="disconnected":n.new>0?t="new":n.connected>0&&(t="connected"),t!==this.connectionState){this.connectionState=t;var i=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",i)}},S.prototype.createOffer=function(){var i=this;if(i._isClosed)return Promise.reject(E("InvalidStateError","Can not call createOffer after close"));var v=i.transceivers.filter(function(t){return"audio"===t.kind}).length,e=i.transceivers.filter(function(t){return"video"===t.kind}).length,T=arguments[0];if(T){if(T.mandatory||T.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==T.offerToReceiveAudio&&(v=!0===T.offerToReceiveAudio?1:!1===T.offerToReceiveAudio?0:T.offerToReceiveAudio),void 0!==T.offerToReceiveVideo&&(e=!0===T.offerToReceiveVideo?1:!1===T.offerToReceiveVideo?0:T.offerToReceiveVideo)}for(i.transceivers.forEach(function(t){"audio"===t.kind?--v<0&&(t.wantReceive=!1):"video"===t.kind&&--e<0&&(t.wantReceive=!1)});v>0||e>0;)v>0&&(i._createTransceiver("audio"),v--),e>0&&(i._createTransceiver("video"),e--);var R=l.writeSessionBoilerplate(i._sdpSessionId,i._sdpSessionVersion++);i.transceivers.forEach(function(p,v){var e=p.track,T=p.kind,E=p.mid||l.generateIdentifier();p.mid=E,p.iceGatherer||(p.iceGatherer=i._createIceGatherer(v,i.usingBundle));var R=t.RTCRtpSender.getCapabilities(T);n<15019&&(R.codecs=R.codecs.filter(function(t){return"rtx"!==t.name})),R.codecs.forEach(function(t){"H264"===t.name&&void 0===t.parameters["level-asymmetry-allowed"]&&(t.parameters["level-asymmetry-allowed"]="1"),p.remoteCapabilities&&p.remoteCapabilities.codecs&&p.remoteCapabilities.codecs.forEach(function(n){t.name.toLowerCase()===n.name.toLowerCase()&&t.clockRate===n.clockRate&&(t.preferredPayloadType=n.payloadType)})}),R.headerExtensions.forEach(function(t){var n=p.remoteCapabilities&&p.remoteCapabilities.headerExtensions||[];n.forEach(function(n){t.uri===n.uri&&(t.id=n.id)})});var S=p.sendEncodingParameters||[{ssrc:1001*(2*v+1)}];e&&n>=15019&&"video"===T&&!S[0].rtx&&(S[0].rtx={ssrc:S[0].ssrc+1}),p.wantReceive&&(p.rtpReceiver=new t.RTCRtpReceiver(p.dtlsTransport,T)),p.localCapabilities=R,p.sendEncodingParameters=S}),"max-compat"!==i._config.bundlePolicy&&(R+="a=group:BUNDLE "+i.transceivers.map(function(t){return t.mid}).join(" ")+"\r\n"),R+="a=ice-options:trickle\r\n",i.transceivers.forEach(function(t,n){R+=p(t,t.localCapabilities,"offer",t.stream,i._dtlsRole),R+="a=rtcp-rsize\r\n",!t.iceGatherer||"new"===i.iceGatheringState||0!==n&&i.usingBundle||(t.iceGatherer.getLocalCandidates().forEach(function(t){t.component=1,R+="a="+l.writeCandidate(t)+"\r\n"}),"completed"===t.iceGatherer.state&&(R+="a=end-of-candidates\r\n"))});var S=new t.RTCSessionDescription({type:"offer",sdp:R});return Promise.resolve(S)},S.prototype.createAnswer=function(){var i=this;if(i._isClosed)return Promise.reject(E("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==i.signalingState&&"have-local-pranswer"!==i.signalingState)return Promise.reject(E("InvalidStateError","Can not call createAnswer in signalingState "+i.signalingState));var e=l.writeSessionBoilerplate(i._sdpSessionId,i._sdpSessionVersion++);i.usingBundle&&(e+="a=group:BUNDLE "+i.transceivers.map(function(t){return t.mid}).join(" ")+"\r\n"),e+="a=ice-options:trickle\r\n";var T=l.getMediaSections(i._remoteDescription.sdp).length;i.transceivers.forEach(function(t,l){if(!(l+1>T)){if(t.rejected)return"application"===t.kind?"DTLS/SCTP"===t.protocol?e+="m=application 0 DTLS/SCTP 5000\r\n":e+="m=application 0 "+t.protocol+" webrtc-datachannel\r\n":"audio"===t.kind?e+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===t.kind&&(e+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(e+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+t.mid+"\r\n");var E;t.stream&&("audio"===t.kind?E=t.stream.getAudioTracks()[0]:"video"===t.kind&&(E=t.stream.getVideoTracks()[0]),E&&n>=15019&&"video"===t.kind&&!t.sendEncodingParameters[0].rtx&&(t.sendEncodingParameters[0].rtx={ssrc:t.sendEncodingParameters[0].ssrc+1}));var R=v(t.localCapabilities,t.remoteCapabilities),S=R.codecs.filter(function(t){return"rtx"===t.name.toLowerCase()}).length;!S&&t.sendEncodingParameters[0].rtx&&delete t.sendEncodingParameters[0].rtx,e+=p(t,R,"answer",t.stream,i._dtlsRole),t.rtcpParameters&&t.rtcpParameters.reducedSize&&(e+="a=rtcp-rsize\r\n")}});var R=new t.RTCSessionDescription({type:"answer",sdp:e});return Promise.resolve(R)},S.prototype.addIceCandidate=function(t){var n,i=this;return t&&void 0===t.sdpMLineIndex&&!t.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(p,v){if(!i._remoteDescription)return v(E("InvalidStateError","Can not add ICE candidate without a remote description"));if(t&&""!==t.candidate){var e=t.sdpMLineIndex;if(t.sdpMid)for(var R=0;R<i.transceivers.length;R++)if(i.transceivers[R].mid===t.sdpMid){e=R;break}var S=i.transceivers[e];if(!S)return v(E("OperationError","Can not add ICE candidate"));if(S.rejected)return p();var L=Object.keys(t.candidate).length>0?l.parseCandidate(t.candidate):{};if("tcp"===L.protocol&&(0===L.port||9===L.port))return p();if(L.component&&1!==L.component)return p();if((0===e||e>0&&S.iceTransport!==i.transceivers[0].iceTransport)&&!T(S.iceTransport,L))return v(E("OperationError","Can not add ICE candidate"));var M=t.candidate.trim();0===M.indexOf("a=")&&(M=M.substr(2)),(n=l.getMediaSections(i._remoteDescription.sdp))[e]+="a="+(L.type?M:"end-of-candidates")+"\r\n",i._remoteDescription.sdp=l.getDescription(i._remoteDescription.sdp)+n.join("")}else for(var u=0;u<i.transceivers.length&&(i.transceivers[u].rejected||(i.transceivers[u].iceTransport.addRemoteCandidate({}),(n=l.getMediaSections(i._remoteDescription.sdp))[u]+="a=end-of-candidates\r\n",i._remoteDescription.sdp=l.getDescription(i._remoteDescription.sdp)+n.join(""),!i.usingBundle));u++);p()})},S.prototype.getStats=function(n){if(n&&n instanceof t.MediaStreamTrack){var i=null;if(this.transceivers.forEach(function(t){t.rtpSender&&t.rtpSender.track===n?i=t.rtpSender:t.rtpReceiver&&t.rtpReceiver.track===n&&(i=t.rtpReceiver)}),!i)throw E("InvalidAccessError","Invalid selector.");return i.getStats()}var l=[];return this.transceivers.forEach(function(t){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(n){t[n]&&l.push(t[n].getStats())})}),Promise.all(l).then(function(t){var n=new Map;return t.forEach(function(t){t.forEach(function(t){n.set(t.id,t)})}),n})},["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach(function(n){var i=t[n];if(i&&i.prototype&&i.prototype.getStats){var l=i.prototype.getStats;i.prototype.getStats=function(){return l.apply(this).then(function(t){var n=new Map;return Object.keys(t).forEach(function(i){var l;t[i].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(l=t[i]).type]||l.type,n.set(i,t[i])}),n})}}});var L=["createOffer","createAnswer"];return L.forEach(function(t){var n=S.prototype[t];S.prototype[t]=function(){var t=arguments;return"function"==typeof t[0]||"function"==typeof t[1]?n.apply(this,[arguments[2]]).then(function(n){"function"==typeof t[0]&&t[0].apply(null,[n])},function(n){"function"==typeof t[1]&&t[1].apply(null,[n])}):n.apply(this,arguments)}}),(L=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach(function(t){var n=S.prototype[t];S.prototype[t]=function(){var t=arguments;return"function"==typeof t[1]||"function"==typeof t[2]?n.apply(this,arguments).then(function(){"function"==typeof t[1]&&t[1].apply(null)},function(n){"function"==typeof t[2]&&t[2].apply(null,[n])}):n.apply(this,arguments)}}),["getStats"].forEach(function(t){var n=S.prototype[t];S.prototype[t]=function(){var t=arguments;return"function"==typeof t[1]?n.apply(this,arguments).then(function(){"function"==typeof t[1]&&t[1].apply(null)}):n.apply(this,arguments)}}),S}},{sdp:17}],17:[function(t,n,i){"use strict";var l={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};l.localCName=l.generateIdentifier(),l.splitLines=function(t){return t.trim().split("\n").map(function(t){return t.trim()})},l.splitSections=function(t){var n=t.split("\nm=");return n.map(function(t,n){return(n>0?"m="+t:t).trim()+"\r\n"})},l.getDescription=function(t){var n=l.splitSections(t);return n&&n[0]},l.getMediaSections=function(t){var n=l.splitSections(t);return n.shift(),n},l.matchPrefix=function(t,n){return l.splitLines(t).filter(function(t){return 0===t.indexOf(n)})},l.parseCandidate=function(t){for(var n,i={foundation:(n=0===t.indexOf("a=candidate:")?t.substring(12).split(" "):t.substring(10).split(" "))[0],component:parseInt(n[1],10),protocol:n[2].toLowerCase(),priority:parseInt(n[3],10),ip:n[4],address:n[4],port:parseInt(n[5],10),type:n[7]},l=8;l<n.length;l+=2)switch(n[l]){case"raddr":i.relatedAddress=n[l+1];break;case"rport":i.relatedPort=parseInt(n[l+1],10);break;case"tcptype":i.tcpType=n[l+1];break;case"ufrag":i.ufrag=n[l+1],i.usernameFragment=n[l+1];break;default:i[n[l]]=n[l+1]}return i},l.writeCandidate=function(t){var n=[];n.push(t.foundation),n.push(t.component),n.push(t.protocol.toUpperCase()),n.push(t.priority),n.push(t.address||t.ip),n.push(t.port);var i=t.type;return n.push("typ"),n.push(i),"host"!==i&&t.relatedAddress&&t.relatedPort&&(n.push("raddr"),n.push(t.relatedAddress),n.push("rport"),n.push(t.relatedPort)),t.tcpType&&"tcp"===t.protocol.toLowerCase()&&(n.push("tcptype"),n.push(t.tcpType)),(t.usernameFragment||t.ufrag)&&(n.push("ufrag"),n.push(t.usernameFragment||t.ufrag)),"candidate:"+n.join(" ")},l.parseIceOptions=function(t){return t.substr(14).split(" ")},l.parseRtpMap=function(t){var n=t.substr(9).split(" "),i={payloadType:parseInt(n.shift(),10)};return n=n[0].split("/"),i.name=n[0],i.clockRate=parseInt(n[1],10),i.channels=3===n.length?parseInt(n[2],10):1,i.numChannels=i.channels,i},l.writeRtpMap=function(t){var n=t.payloadType;void 0!==t.preferredPayloadType&&(n=t.preferredPayloadType);var i=t.channels||t.numChannels||1;return"a=rtpmap:"+n+" "+t.name+"/"+t.clockRate+(1!==i?"/"+i:"")+"\r\n"},l.parseExtmap=function(t){var n=t.substr(9).split(" ");return{id:parseInt(n[0],10),direction:n[0].indexOf("/")>0?n[0].split("/")[1]:"sendrecv",uri:n[1]}},l.writeExtmap=function(t){return"a=extmap:"+(t.id||t.preferredId)+(t.direction&&"sendrecv"!==t.direction?"/"+t.direction:"")+" "+t.uri+"\r\n"},l.parseFmtp=function(t){for(var n,i={},l=t.substr(t.indexOf(" ")+1).split(";"),p=0;p<l.length;p++)n=l[p].trim().split("="),i[n[0].trim()]=n[1];return i},l.writeFmtp=function(t){var n="",i=t.payloadType;if(void 0!==t.preferredPayloadType&&(i=t.preferredPayloadType),t.parameters&&Object.keys(t.parameters).length){var l=[];Object.keys(t.parameters).forEach(function(n){t.parameters[n]?l.push(n+"="+t.parameters[n]):l.push(n)}),n+="a=fmtp:"+i+" "+l.join(";")+"\r\n"}return n},l.parseRtcpFb=function(t){var n=t.substr(t.indexOf(" ")+1).split(" ");return{type:n.shift(),parameter:n.join(" ")}},l.writeRtcpFb=function(t){var n="",i=t.payloadType;return void 0!==t.preferredPayloadType&&(i=t.preferredPayloadType),t.rtcpFeedback&&t.rtcpFeedback.length&&t.rtcpFeedback.forEach(function(t){n+="a=rtcp-fb:"+i+" "+t.type+(t.parameter&&t.parameter.length?" "+t.parameter:"")+"\r\n"}),n},l.parseSsrcMedia=function(t){var n=t.indexOf(" "),i={ssrc:parseInt(t.substr(7,n-7),10)},l=t.indexOf(":",n);return l>-1?(i.attribute=t.substr(n+1,l-n-1),i.value=t.substr(l+1)):i.attribute=t.substr(n+1),i},l.parseSsrcGroup=function(t){var n=t.substr(13).split(" ");return{semantics:n.shift(),ssrcs:n.map(function(t){return parseInt(t,10)})}},l.getMid=function(t){var n=l.matchPrefix(t,"a=mid:")[0];if(n)return n.substr(6)},l.parseFingerprint=function(t){var n=t.substr(14).split(" ");return{algorithm:n[0].toLowerCase(),value:n[1]}},l.getDtlsParameters=function(t,n){var i=l.matchPrefix(t+n,"a=fingerprint:");return{role:"auto",fingerprints:i.map(l.parseFingerprint)}},l.writeDtlsParameters=function(t,n){var i="a=setup:"+n+"\r\n";return t.fingerprints.forEach(function(t){i+="a=fingerprint:"+t.algorithm+" "+t.value+"\r\n"}),i},l.getIceParameters=function(t,n){var i=l.splitLines(t),p={usernameFragment:(i=i.concat(l.splitLines(n))).filter(function(t){return 0===t.indexOf("a=ice-ufrag:")})[0].substr(12),password:i.filter(function(t){return 0===t.indexOf("a=ice-pwd:")})[0].substr(10)};return p},l.writeIceParameters=function(t){return"a=ice-ufrag:"+t.usernameFragment+"\r\na=ice-pwd:"+t.password+"\r\n"},l.parseRtpParameters=function(t){for(var n={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},i=l.splitLines(t),p=i[0].split(" "),v=3;v<p.length;v++){var e=p[v],T=l.matchPrefix(t,"a=rtpmap:"+e+" ")[0];if(T){var E=l.parseRtpMap(T),R=l.matchPrefix(t,"a=fmtp:"+e+" ");switch(E.parameters=R.length?l.parseFmtp(R[0]):{},E.rtcpFeedback=l.matchPrefix(t,"a=rtcp-fb:"+e+" ").map(l.parseRtcpFb),n.codecs.push(E),E.name.toUpperCase()){case"RED":case"ULPFEC":n.fecMechanisms.push(E.name.toUpperCase())}}}return l.matchPrefix(t,"a=extmap:").forEach(function(t){n.headerExtensions.push(l.parseExtmap(t))}),n},l.writeRtpDescription=function(t,n){var i="";i+="m="+t+" ",i+=n.codecs.length>0?"9":"0",i+=" UDP/TLS/RTP/SAVPF ",i+=n.codecs.map(function(t){return void 0!==t.preferredPayloadType?t.preferredPayloadType:t.payloadType}).join(" ")+"\r\n",i+="c=IN IP4 0.0.0.0\r\n",i+="a=rtcp:9 IN IP4 0.0.0.0\r\n",n.codecs.forEach(function(t){i+=l.writeRtpMap(t),i+=l.writeFmtp(t),i+=l.writeRtcpFb(t)});var p=0;return n.codecs.forEach(function(t){t.maxptime>p&&(p=t.maxptime)}),p>0&&(i+="a=maxptime:"+p+"\r\n"),i+="a=rtcp-mux\r\n",n.headerExtensions&&n.headerExtensions.forEach(function(t){i+=l.writeExtmap(t)}),i},l.parseRtpEncodingParameters=function(t){var n,i=[],p=l.parseRtpParameters(t),v=-1!==p.fecMechanisms.indexOf("RED"),e=-1!==p.fecMechanisms.indexOf("ULPFEC"),T=l.matchPrefix(t,"a=ssrc:").map(function(t){return l.parseSsrcMedia(t)}).filter(function(t){return"cname"===t.attribute}),E=T.length>0&&T[0].ssrc,R=l.matchPrefix(t,"a=ssrc-group:FID").map(function(t){var n=t.substr(17).split(" ");return n.map(function(t){return parseInt(t,10)})});R.length>0&&R[0].length>1&&R[0][0]===E&&(n=R[0][1]),p.codecs.forEach(function(t){if("RTX"===t.name.toUpperCase()&&t.parameters.apt){var l={ssrc:E,codecPayloadType:parseInt(t.parameters.apt,10)};E&&n&&(l.rtx={ssrc:n}),i.push(l),v&&((l=JSON.parse(JSON.stringify(l))).fec={ssrc:E,mechanism:e?"red+ulpfec":"red"},i.push(l))}}),0===i.length&&E&&i.push({ssrc:E});var S=l.matchPrefix(t,"b=");return S.length&&(S=0===S[0].indexOf("b=TIAS:")?parseInt(S[0].substr(7),10):0===S[0].indexOf("b=AS:")?1e3*parseInt(S[0].substr(5),10)*.95-16e3:void 0,i.forEach(function(t){t.maxBitrate=S})),i},l.parseRtcpParameters=function(t){var n={},i=l.matchPrefix(t,"a=ssrc:").map(function(t){return l.parseSsrcMedia(t)}).filter(function(t){return"cname"===t.attribute})[0];i&&(n.cname=i.value,n.ssrc=i.ssrc);var p=l.matchPrefix(t,"a=rtcp-rsize");n.reducedSize=p.length>0,n.compound=0===p.length;var v=l.matchPrefix(t,"a=rtcp-mux");return n.mux=v.length>0,n},l.parseMsid=function(t){var n,i=l.matchPrefix(t,"a=msid:");if(1===i.length)return{stream:(n=i[0].substr(7).split(" "))[0],track:n[1]};var p=l.matchPrefix(t,"a=ssrc:").map(function(t){return l.parseSsrcMedia(t)}).filter(function(t){return"msid"===t.attribute});return p.length>0?{stream:(n=p[0].value.split(" "))[0],track:n[1]}:void 0},l.generateSessionId=function(){return Math.random().toString().substr(2,21)},l.writeSessionBoilerplate=function(t,n,i){var p,v=void 0!==n?n:2;p=t||l.generateSessionId();var e=i||"thisisadapterortc";return"v=0\r\no="+e+" "+p+" "+v+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},l.writeMediaSection=function(t,n,i,p){var v=l.writeRtpDescription(t.kind,n);if(v+=l.writeIceParameters(t.iceGatherer.getLocalParameters()),v+=l.writeDtlsParameters(t.dtlsTransport.getLocalParameters(),"offer"===i?"actpass":"active"),v+="a=mid:"+t.mid+"\r\n",t.direction?v+="a="+t.direction+"\r\n":t.rtpSender&&t.rtpReceiver?v+="a=sendrecv\r\n":t.rtpSender?v+="a=sendonly\r\n":t.rtpReceiver?v+="a=recvonly\r\n":v+="a=inactive\r\n",t.rtpSender){var e="msid:"+p.id+" "+t.rtpSender.track.id+"\r\n";v+="a="+e,v+="a=ssrc:"+t.sendEncodingParameters[0].ssrc+" "+e,t.sendEncodingParameters[0].rtx&&(v+="a=ssrc:"+t.sendEncodingParameters[0].rtx.ssrc+" "+e,v+="a=ssrc-group:FID "+t.sendEncodingParameters[0].ssrc+" "+t.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return v+="a=ssrc:"+t.sendEncodingParameters[0].ssrc+" cname:"+l.localCName+"\r\n",t.rtpSender&&t.sendEncodingParameters[0].rtx&&(v+="a=ssrc:"+t.sendEncodingParameters[0].rtx.ssrc+" cname:"+l.localCName+"\r\n"),v},l.getDirection=function(t,n){for(var i=l.splitLines(t),p=0;p<i.length;p++)switch(i[p]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return i[p].substr(2)}return n?l.getDirection(n):"sendrecv"},l.getKind=function(t){var n=l.splitLines(t),i=n[0].split(" ");return i[0].substr(2)},l.isRejected=function(t){return"0"===t.split(" ",2)[1]},l.parseMLine=function(t){var n=l.splitLines(t),i=n[0].substr(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},l.parseOLine=function(t){var n=l.matchPrefix(t,"o=")[0],i=n.substr(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},l.isValidSDP=function(t){if("string"!=typeof t||0===t.length)return!1;for(var n=l.splitLines(t),i=0;i<n.length;i++)if(n[i].length<2||"="!==n[i].charAt(1))return!1;return!0},"object"==typeof n&&(n.exports=l)},{}]},{},[1])(1)},function(t,n,i){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var l=function(){function t(t){this.delayTime=.1,this.fadeTime=.05,this.startTime=.1,this.previousPitch=-1,this.context=t,this.input=t.createGain(),this.output=t.createGain(),this.mod1=t.createBufferSource(),this.mod2=t.createBufferSource(),this.mod3=t.createBufferSource(),this.mod4=t.createBufferSource(),this.shiftDownBuffer=this.createDelayTimeBuffer(t,this.startTime,this.fadeTime,!1),this.shiftUpBuffer=this.createDelayTimeBuffer(t,this.startTime,this.fadeTime,!0),this.mod1.buffer=this.shiftDownBuffer,this.mod2.buffer=this.shiftDownBuffer,this.mod3.buffer=this.shiftUpBuffer,this.mod4.buffer=this.shiftUpBuffer,this.mod1.loop=!0,this.mod2.loop=!0,this.mod3.loop=!0,this.mod4.loop=!0,this.mod1Gain=t.createGain(),this.mod2Gain=t.createGain(),this.mod3Gain=t.createGain(),this.mod4Gain=t.createGain(),this.mod3Gain.gain.value=0,this.mod4Gain.gain.value=0,this.mod1.connect(this.mod1Gain),this.mod2.connect(this.mod2Gain),this.mod3.connect(this.mod3Gain),this.mod4.connect(this.mod4Gain),this.modGain1=t.createGain(),this.modGain2=t.createGain(),this.delay1=t.createDelay(),this.delay2=t.createDelay(),this.mod1Gain.connect(this.modGain1),this.mod2Gain.connect(this.modGain2),this.mod3Gain.connect(this.modGain1),this.mod4Gain.connect(this.modGain2),this.modGain1.connect(this.delay1.delayTime),this.modGain2.connect(this.delay2.delayTime),this.fade1=t.createBufferSource(),this.fade2=t.createBufferSource(),this.fadeBuffer=this.createFadeBuffer(t,this.startTime,this.fadeTime),this.fade1.buffer=this.fadeBuffer,this.fade2.buffer=this.fadeBuffer,this.fade1.loop=!0,this.fade2.loop=!0,this.mix1=t.createGain(),this.mix2=t.createGain(),this.mix1.gain.value=0,this.mix2.gain.value=0,this.fade1.connect(this.mix1.gain),this.fade2.connect(this.mix2.gain),this.input.connect(this.delay1),this.input.connect(this.delay2),this.delay1.connect(this.mix1),this.delay2.connect(this.mix2),this.mix1.connect(this.output),this.mix2.connect(this.output);var n=t.currentTime+.05,i=n+this.startTime-this.fadeTime;this.mod1.start(n),this.mod2.start(i),this.mod3.start(n),this.mod4.start(i),this.fade1.start(n),this.fade2.start(i),this.setDelay(this.delayTime)}return t.prototype.createFadeBuffer=function(t,n,i){for(var l=n*t.sampleRate,p=l+(n-2*i)*t.sampleRate,v=t.createBuffer(1,p,t.sampleRate),e=v.getChannelData(0),T=i*t.sampleRate,E=l-T,R=0;R<l;++R)e[R]=R<T?Math.sqrt(R/T):R>=E?Math.sqrt(1-(R-E)/T):1;for(R=l;R<length;++R)e[R]=0;return v},t.prototype.createDelayTimeBuffer=function(t,n,i,l){for(var p=n*t.sampleRate,v=p+(n-2*i)*t.sampleRate,e=t.createBuffer(1,v,t.sampleRate),T=e.getChannelData(0),E=0;E<p;++E)T[E]=l?(p-E)/v:E/p;for(E=p;E<v;++E)T[E]=0;return e},t.prototype.setDelay=function(t){this.modGain1.gain.setTargetAtTime(.5*t,0,.01),this.modGain2.gain.setTargetAtTime(.5*t,0,.01)},t.prototype.setPitchOffset=function(t){t>0?(this.mod1Gain.gain.value=0,this.mod2Gain.gain.value=0,this.mod3Gain.gain.value=1,this.mod4Gain.gain.value=1):(this.mod1Gain.gain.value=1,this.mod2Gain.gain.value=1,this.mod3Gain.gain.value=0,this.mod4Gain.gain.value=0),this.setDelay(this.delayTime*Math.abs(t)),this.previousPitch=t},t}();n.pitchUtil=l},function(t,n,i){"use strict";var l=this&&this.__assign||Object.assign||function(t){for(var n,i=1,l=arguments.length;i<l;i++)for(var p in n=arguments[i])Object.prototype.hasOwnProperty.call(n,p)&&(t[p]=n[p]);return t};Object.defineProperty(n,"__esModule",{value:!0});var p=i(0),v=i(1),e=function(){function t(t,n){this.sendDataMap={},this.sendDataList=new p.LinkedList,this.sendDataCheckOnceCount=100,this.signalSeq=0,this.pushCallback={},this.sessionInfos={},this.tryHeartbeatCount=0,this.heartbeatInterval=1e4,this.sendDataTimeout=5e3,this.sendDataDropTimeout=1e4,this.tryConnectCount=1,this.tryConnectTimer=null,this.tryConnectInterval=3e3,this.state=p.ENUM_CONNECT_STATE.disconnect,this.tokenType=0,this.browser=this.getBrowserAndVersion(),this.platform=navigator.platform,this.negoInterval=25e3,this.negoTryCount=1,this.negoTryMaxCount=2,this.logger=t,this.stateCenter=n}return t.prototype.getBrowserAndVersion=function(){var t,n=navigator.userAgent,i=n.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*([\d\.]+)/i)||[];return/trident/i.test(i[1])?{name:"IE",version:(t=/\brv[ :]+([\d\.]+)/g.exec(n)||[])[1]||""}:"Chrome"===i[1]&&null!=(t=n.match(/\bOPR|Edge\/([\d\.]+)/))?{name:"Opera",version:t[1]}:(i=i[2]?[i[1],i[2]]:[navigator.appName,navigator.appVersion,"-?"],null!=(t=n.match(/version\/([\d+\.]+)/i))&&i.splice(1,1,t[1]),{name:i[0],version:i[1]})},t.prototype.setSessionInfo=function(t,n){this.logger.debug("zs.ssi.0 call"),this.appid=t+"",this.userid=n},t.prototype.onDisconnect=function(t){},t.prototype.onUpdateHeartBeartInterval=function(t){},t.prototype.resetConnectTimer=function(){this.logger.info("zs.rct.0 call"),clearTimeout(this.tryConnectTimer),this.tryConnectTimer=null,this.tryConnectCount=0},t.prototype.bindWebSocketHandle=function(){var t=this;this.tryHeartbeatCount=0,this.websocket.onmessage=function(n){var i=JSON.parse(n.data);t.logger.info("zs.bsh.0 signmsg= ",i.header.cmd),t.logger.info("zs.bsh.0 signmsg= "+JSON.stringify(i)),i.header.appid==t.appid&&i.header.user_id===t.userid?t.handleServerPush(i):t.logger.warn("zs.bsh.0 check header failed")},this.websocket.onclose=function(n){t.logger.info("zs.bsh.0 signal close msg = "+JSON.stringify(n.code)),t.state!=p.ENUM_CONNECT_STATE.disconnect&&(t.resetConnectTimer(),t.startConnectTimer(),t.resetCheckMessage())},this.websocket.onerror=function(n){t.logger.error("zs.bsh.0 msg = "+JSON.stringify(n))}},t.prototype.resetCheckMessage=function(){this.logger.debug("zs.rcm.0 call");for(var t=this.sendDataList.getFirst();null!=t;)this.sendDataList.remove(t),t._data.error&&t._data.error(p.SEND_MSG_RESET,t._data.seq),t=this.sendDataList.getFirst();this.sendDataMap={}},t.prototype.handleServerPush=function(t){switch(t.header.cmd){case"LoginRsp":this.handleRespondData("LoginReq",t);break;case"CreateSessionRsp":this.handleRespondData("CreateSessionReq",t),0===t.body.result&&this.addSession(t.header.session_id,t.body.session_token);break;case"MediaDescRsp":this.handleRespondData("MediaDescReq",t);break;case"CandidateInfoRsp":this.handleRespondData("CandidateInfoReq",t);break;case"CloseSessionRsp":this.handleRespondData("CloseSessionReq",t),this.removeSession(t.header.session_id);break;case"ClientHBRsp":this.handleRespondData("ClientHBReq",t);break;case"MediaDescPush":case"CandidateInfoPush":this.handlePushData(t);break;case"CloseSessionPush":this.handlePushData(t),this.removeSession(t.header.session_id);break;case"QualityReportRsp":this.handleRespondData("QualityReportReq",t);break;case"SessionResetPush":this.handlePushResetSessionData(t);break;case"StreamStatusNotifyPush":case"PublishEventPush":case"PlayEventPush":this.handlePushData(t)}},t.prototype.disconnectCallback=function(){this.connectCallback&&(this.connectCallback(-1,this.server,void 0),this.connectCallback=null);var t=this.server;this.disconnectServer(),this.onDisconnect(t)},t.prototype.updateToken=function(){var t=this;this.logger.info("zs.ut.0 call");var n={token:this.token,tokenType:this.tokenType,roomid:this.stateCenter.roomid,anchorname:this.stateCenter.anchor_info.anchor_id,sdkversion:p.PROTO_VERSION,osinfo:navigator.appVersion};if(0!=Object.keys(this.sessionInfos).length){var i=[];for(var l in this.sessionInfos){var e=parseInt(l);i.push({session_id:e,session_token:this.sessionInfos[e].token})}n.sessions=i}this.sendMessageWithCallback("LoginReq",v.getSeq(),0,n,function(n,i,l){if(0==l.result){t.token=l.token,t.tokenType=l.tokenType;var p={report:l.report,report_interval:l.report_interval_ms};l.negoInterval&&(t.negoInterval=l.negoInterval),l.negoTryCount&&(t.negoTryCount=l.negoTryCount),l.negoTryMaxCount&&(t.negoTryMaxCount=l.negoTryMaxCount),null!=t.connectCallback&&(t.connectCallback(0,t.server,p),t.connectCallback=null)}else{var v={error:l.strError};null!=t.connectCallback&&(t.connectCallback(l.result,t.server,v),t.connectCallback=null)}},function(n,i){null!=t.connectCallback&&(t.connectCallback(-1,t.server,void 0),t.connectCallback=null)})},t.prototype.sendMessageWithCallback=function(t,n,i,l,v,e){if(this.logger.debug("zs.smwc.0 call "+t),!this.websocket||1!==this.websocket.readyState)return this.logger.error("zs.smwc.0 connect not establish"),void(e&&e(p.SEND_MSG_TIMEOUT,n));var T={header:this.getHeader(t,n,i),body:l};null==v&&(v=null),null==e&&(e=null);var E={seq:n,deleted:!1,cmd:t,time:Date.parse(new Date+""),success:v,error:e},R=this.sendDataList.push(E);this.sendDataMap[E.seq]=R;var S=JSON.stringify(T);this.websocket.send(S),this.logger.debug("zs.smwc.0 success")},t.prototype.getHeader=function(t,n,i){return this.globalHeader={version:"1.0.1",cmd:t,appid:this.appid+"",seq:n,user_id:this.userid,session_id:i},this.globalHeader},t.prototype.connectServer=function(t,n,i){var l=this;if(this.token=t,this.server=n,this.state=p.ENUM_CONNECT_STATE.connecting,this.connectCallback=i,this.websocket&&1===this.websocket.readyState)this.resetConnectTimer(),this.state=p.ENUM_CONNECT_STATE.connected;else{this.logger.info("zs.cs.0 need new websocket");try{this.websocket&&(this.logger.warn("zs.cs.0 close error websocket"),this.websocket.onclose=null,this.websocket.onerror=null,this.websocket.close(),this.websocket=null),this.websocket=new WebSocket(this.server),this.websocket.onopen=function(){l.resetConnectTimer(),l.logger.info("zs.cs.0 websocket open call"),l.bindWebSocketHandle(),l.updateToken(),l.state=p.ENUM_CONNECT_STATE.connected},this.websocket.onclose=function(t){l.logger.info("zs.cs.0 signal websocket close code "+JSON.stringify(t.code))},this.websocket.onerror=function(t){l.logger.info("zs.cs.0 websocket onerror call  "+JSON.stringify(t))}}catch(t){this.logger.error("zs.cs.0 websocket error "+t)}}this.tryConnectTimer=setTimeout(function(){l.startConnectTimer(i)},this.tryConnectInterval)},t.prototype.startConnectTimer=function(t){if(this.logger.info("zs.sct.0 call"),this.tryConnectCount>=p.MAX_TRY_CONNECT_COUNT)return this.logger.info("zs.sct.0 beyond "+this.server+" max limit"),void this.disconnectCallback();this.websocket&&1===this.websocket.readyState?this.resetConnectTimer():(this.tryConnectCount+=1,this.connectServer(this.token,this.server,t))},t.prototype.disconnectServer=function(){this.logger.debug("zs.ds.0 call"),this.connectCallback=null,this.resetCheckMessage(),this.resetConnectTimer(),this.websocket&&(this.websocket.onclose=null,this.websocket.onerror=null,this.websocket.close(),this.websocket=null),this.token="",this.sessionInfos={},this.tokenType=0,this.tryHeartbeatCount=0,this.tryConnectCount=0,this.state=p.ENUM_CONNECT_STATE.disconnect},t.prototype.isServerConnected=function(){return!(!this.websocket||1!==this.websocket.readyState)},t.prototype.createSession=function(t,n,i,l,v,e,T){void 0===v&&(v=""),this.logger.debug("zs.cs.1 call: ",l);var E="";p.PROTO_VERSION.split(".").forEach(function(t,n){return 1==t.length&&1==n?E+="0"+t:E+=t});var R={type:n,stream_id:l,platform:this.platform,browser:this.browser.name,version:this.browser.version,app_id:this.appid,negotiate_mode:i,strAuthParam:v,sdk_version:1*E};this.sendMessageWithCallback("CreateSessionReq",t,0,R,e,T)},t.prototype.removeSession=function(t){this.logger.info("zs.rs.0 call"),this.sessionInfos[t]&&delete this.sessionInfos[t]},t.prototype.sendCloseSession=function(t,n,i,l,p){this.logger.debug("zs.scs.0 call: ",n);var v={reason:i};this.removeSession(n),this.sendMessageWithCallback("CloseSessionReq",t,n,v,l,p)},t.prototype.sendMessage=function(t,n,i,l){if(this.logger.debug("zs.sm.0 call "+t),this.websocket&&1===this.websocket.readyState){var p={header:this.getHeader(t,n,i),body:l},v=JSON.stringify(p);this.websocket.send(v),this.logger.debug("zs.sm.0 success")}else this.logger.error("zs.sm.0 connect not establish")},t.prototype.handleRespondData=function(t,n){this.logger.debug("zs.hrd.0 call");var i=this.sendDataMap[n.header.seq];if(null!=i){var l=i._data;l.cmd!==t?this.logger.error("sz.hrd.0 command is not match"):l.success&&l.success(n.header.seq,n.header.session_id,n.body),delete this.sendDataMap[n.header.seq],this.sendDataList.remove(i)}else{if("CloseSessionRsp"==n.header.cmd)return;this.logger.error("zs.hrd.0 cannot find data "+t)}},t.prototype.addSession=function(t,n){this.logger.info("zs.as.0 call"),this.sessionInfos[t]={token:n}},t.prototype.handlePushData=function(t){this.logger.debug("zs.hpd.0 call "+t.header.cmd+" session "+t.header.session_id);var n=this.pushCallback[t.header.cmd+t.header.session_id];n?n.callback&&n.callback(t.header.seq,t.header.session_id,t.body):this.logger.info("zs.hpd.0 no callbackData "+t.header.cmd+" session: "+t.header.session_id)},t.prototype.handlePushResetSessionData=function(t){this.logger.debug("zs.hprsd.0 call ");var n=[];if(0==t.body.cResetType)n=Object.keys(this.sessionInfos);else if(1==t.body.cResetType)for(var i=0;i<t.body.session_ids.length;i++)n.push(t.body.session_ids[i]);if(this.sendResetSessionAck(t.header.seq,0,0),0!=n.length)for(var l=0;l<n.length;l++){var p=this.pushCallback[t.header.cmd+n[l]];null==p?this.logger.info("zs.hprsd.0 no callbackData "+n[l]):p.callback&&p.callback(t.header.seq,n[l],t.body)}else this.logger.info("zs.hprsd.0 no session to callback")},t.prototype.sendMediaDesc=function(t,n,i,l,p,v){this.logger.debug("zs.smd.0 call: ",n);var e={type:i,sdp:l.sdp};null!=l.width&&(e.width=l.width),null!=l.height&&(e.height=l.height),null!=l.frameRate&&(e.framerate=l.frameRate),null!=l.video_min_kpbs&&(e.video_min_kpbs=l.video_min_kpbs),null!=l.video_max_kpbs&&(e.video_max_kpbs=l.video_max_kpbs),null!=l.audio_kpbs&&(e.audio_kpbs=l.audio_kpbs),null!=l.keyframe_intv&&(e.keyframe_intv=l.keyframe_intv),this.sendMessageWithCallback("MediaDescReq",t,n,e,p,v)},t.prototype.sendCandidateInfo=function(t,n,i,l,p){this.logger.debug("zs.sci.0 call: ",n);for(var v=[],e=0;e<i.length;e++){var T={candidate:i[e].candidate,sdpMid:i[e].sdpMid,sdpMLineIndex:i[e].sdpMLineIndex};v.push(T)}var E={infos:v};this.sendMessageWithCallback("CandidateInfoReq",t,n,E,l,p)},t.prototype.sendMediaDescAck=function(t,n,i){this.logger.debug("zs.smda.0 call: ",n);var l={result:i};this.sendMessage("MediaDescAck",t,n,l)},t.prototype.sendCandidateInfoAck=function(t,n,i){this.logger.debug("zs.scia.0 call: ",n);var l={result:i};this.sendMessage("CandidateInfoAck",t,n,l)},t.prototype.sendCloseSessionAck=function(t,n,i){this.logger.debug("zs.scsa.0 call: ",n);var l={result:i};this.sendMessage("CloseSessionAck",t,n,l)},t.prototype.sendResetSessionAck=function(t,n,i){this.logger.debug("zs.ssra.0 call: ",n);var l={result:i};this.sendMessage("SessionResetAck",t,n,l)},t.prototype.registerPushCallback=function(t,n,i){i&&"function"==typeof i&&(this.logger.debug("zs.rpc.0 setcallback"),this.pushCallback[t+n]={callback:i})},t.prototype.unregisterPushCallback=function(t,n){delete this.pushCallback[t+n]},t.prototype.checkMessageTimeout=function(){for(var t=this.sendDataList.getFirst(),n=Date.parse(new Date+""),i=0,l=0,v=0;!(null==t||t._data.time+this.sendDataTimeout>n||(delete this.sendDataMap[t._data.seq],this.sendDataList.remove(t),++l,null==t._data.error||this.sendDataDropTimeout>0&&t._data.time+this.sendDataDropTimeout<n?++v:t._data.error&&t._data.error(p.SEND_MSG_TIMEOUT,t._data.seq),++i>=this.sendDataCheckOnceCount));)t=this.sendDataList.getFirst();0==l&&0==v||this.logger.debug("zs.cmt.0 call success, state: timeout=",l," drop=",v)},t.prototype.sendHeartbeat=function(){var t=this;if(this.logger.debug("zs.shb.0 call tryHeartbeatCount:"+this.tryHeartbeatCount),0!=Object.keys(this.sessionInfos).length){if(++this.tryHeartbeatCount>p.MAX_TRY_HEARTBEAT_COUNT)return this.logger.error("zs.shb.0 heartbeat try limit"),void this.disconnectCallback();var n=[];for(var i in this.sessionInfos)n.push(parseInt(i));var l={session_ids:n};this.sendMessageWithCallback("ClientHBReq",v.getSeq(),0,l,function(n,i,l){t.heartbeatInterval!=l.hb_interval&&(t.heartbeatInterval=l.hb_interval,t.onUpdateHeartBeartInterval(l.hb_interval)),t.tryHeartbeatCount=0},function(t,n){})}else this.logger.info("zs.shb.0 no need to heartbeat")},t.prototype.QualityReport=function(t,n,i,p,v){this.logger.debug("zs.qr.0 call");var e={streams:[l({},i,{aid:n})]};this.sendMessageWithCallback("QualityReportReq",t,n,e,p,v)},t.prototype.sendStreamStatus=function(t,n,i,l){this.logger.debug("zs.sss.0 call");var p={mic_status:l,camera_status:i};this.logger.info("zs.sss.0 stream status "+JSON.stringify(p)),this.sendMessage("StreamStatusNotify",t,n,p)},t.prototype.sendBroadcasterStatus=function(t,n,i){this.logger.debug("zs.sss.0 call");var l={status:i};this.sendMessage("BroadcasterStatusNotify",t,n,l)},t}();n.ZegoSignal=e},function(t,n,i){"use strict";var l=this&&this.__assign||Object.assign||function(t){for(var n,i=1,l=arguments.length;i<l;i++)for(var p in n=arguments[i])Object.prototype.hasOwnProperty.call(n,p)&&(t[p]=n[p]);return t};Object.defineProperty(n,"__esModule",{value:!0});var p=i(0),v=i(1),e=i(4),T=function(){function t(t,n,i,l,e){this.state=p.ENUM_PLAY_STATE.stop,this.candidateInfo=[],this.waitICETimer=null,this.waitingICETimeInterval=5e3,this.waitingOfferTimer=null,this.waitingOfferTimeInterval=5e3,this.qualityTimer=null,this.playQualityList=[],this.maxQualityListCount=10,this.lastPlayStats={audioPacketsLost:0,videoPacketsLost:0,time:0,audioTime:0,videoTime:0,audioBytesReceived:0,videoBytesReceived:0,framesDecoded:0,framesReceived:0,framesDropped:0,audioBitrate:0},this.reportSeq=v.getSeq(),this.videoSizeCallback=!1,this.qualityUpload=!1,this.qualityUploadInterval=3e4,this.qualityUploadLastTime=0,this.streamGoogInfo={},this.closeSessionSignal=!1,this.stateNego=p.ENUM_PLAY_STATE_NEGO.stop,this.negoInterval=25e3,this.broadcasterStatus=p.ENUM_BROADCASTER_STATUS.stop,this.cameraStatus=null,this.micStatus=null,this.playEvent=!1,this.gotStreamStatus=!1,this.ac=null,this.soundLevel=0,this.mic=null,this.script=null,this.logger=t,this.signal=n,this.dataReport=i,this.qualityTimeInterval=l,this.streamCenter=e,i.newReport(this.reportSeq)}return t.prototype.setAudioDestination=function(t){var n=this;return this.remoteVideo?"undefined"!==this.remoteVideo.sinkId?(this.remoteVideo.setSinkId(t).then(function(){n.logger.info("zp.sad.1 success device: "+t)}).catch(function(t){n.logger.info("zp.sad.1 "+t.name)}),!0):(this.logger.error("zp.sad.1 browser does not suppport"),!1):(this.logger.info("zp.sad.1 no remoteVideo"),!1)},t.prototype.startPlay=function(t,n,i,l){var e=this;if(this.logger.info("zp.sp.1 called ",t),this.playEvent=!1,this.signal&&this.signal.negoInterval&&(this.negoInterval=this.signal.negoInterval),t){this.streamId=t,this.remoteVideo=n,this.audioOutput=i,this.playOption=l||{},l&&l.videoDecodeType&&(this.playOption.videoDecodeType=l.videoDecodeType),this.sessionSeq=v.getSeq(),this.dataReport.eventStart(this.reportSeq,"CreateSession");var T=t;1==this.streamCenter.testEnvironment&&(T="zegotest-"+this.streamCenter.appid+"-"+t),this.signal.createSession(this.sessionSeq,1,0,T,l&&l.streamParams,function(t,n,i){e.dataReport.eventEndWithMsg(e.reportSeq,"CreateSession",{sessionId:i.session_id}),e.logger.info("zp.sp.1 sessionId:"+i.session_id),e.sessionSeq==t?0!==i.result?(e.logger.error("zp.sp.1 create error"),e.playStateUpdateError(v.playErrorList.CREATE_SESSION_ERROR)):(e.sessionId=i.session_id,e.onCreatePlaySessionSuccess(i)):e.logger.error("zp.sp.1 seq is not match.")},function(t,n){e.dataReport.eventEndWithMsg(e.reportSeq,"CreateSession",{error:t}),e.playStateUpdateError(v.playErrorList.SEND_SESSION_TIMEOUT)}),this.state=p.ENUM_PLAY_STATE.waitingSessionRsp,this.logger.debug("zp.sp.1 called success"),this.stateNego=p.ENUM_PLAY_STATE_NEGO.start,this.negoTimer=setTimeout(function(){e.logger.error("zp.sp.1 waiting timeout"),e.playStateUpdateError(v.playErrorList.SERVER_NEGO_TIMEOUT)},this.negoInterval)}else this.logger.warn("zp.sp.1 streamId is null")},t.prototype.onCreatePlaySessionSuccess=function(t){var n=this;this.logger.info("zp.ops.1 success");var i=[];t.turn_server&&i.push(t.turn_server),t.stun_server&&i.push(t.stun_server);var l={iceTransportPolicy:"relay",iceServers:[{urls:i,username:t.turn_username,credential:t.turn_auth_key}]};this.logger.info("zp.ops.1 username: "+t.turn_username),this.logger.info("zp.ops.1 credential: "+t.turn_auth_key),this.peerConnection=new RTCPeerConnection(l),this.peerConnection.onicecandidate=function(t){n.onIceCandidate(t)},this.peerConnection.onsignalingstatechange=function(t){n.onConnectionStateChange(t)},this.peerConnection.oniceconnectionstatechange=function(t){n.onIceConnectionStateChange(t)},this.peerConnection.ontrack=function(t){n.onGotRemoteStream(t.streams[0])},this.remoteVideo.oncanplay=function(){n.logger.debug("zp.ops.1 "+n.remoteVideo.videoWidth+" X "+n.remoteVideo.videoHeight),n.videoSizeCallback||(n.logger.debug("zp.ops.1 onresize callback"),n.onVideoSizeChanged(n.streamId,n.remoteVideo.videoWidth,n.remoteVideo.videoHeight),n.videoSizeCallback=!0)};var p={offerToReceiveAudio:1,offerToReceiveVideo:1};this.playOption&&"audio"===this.playOption.playType&&(p.offerToReceiveVideo=0),this.playOption&&"video"===this.playOption.playType&&(p.offerToReceiveAudio=0),this.logger.info("zp.ops.1 createOffer: "+JSON.stringify(p)),this.dataReport.eventStart(this.reportSeq,"CreateOffer"),this.peerConnection.createOffer(p).then(function(t){n.dataReport.eventEnd(n.reportSeq,"CreateOffer"),n.onCreateOfferSuccess(t)},function(t){n.dataReport.eventEndWithMsg(n.reportSeq,"CreateOffer",{error:t.toString()}),n.logger.error("zp.ops.0 create offer error "+t.toString()),n.playStateUpdateError(v.playErrorList.CREATE_OFFER_ERROR,!0)}),this.signal.registerPushCallback("MediaDescPush",this.sessionId,function(t,i,l){n.onRecvMediaDesc(t,i,l)}),this.signal.registerPushCallback("CandidateInfoPush",this.sessionId,function(t,i,l){n.onRecvCandidateInfo(t,i,l)}),this.signal.registerPushCallback("CloseSessionPush",this.sessionId,function(t,i,l){n.onRecvCloseSession(t,i,l)}),this.signal.registerPushCallback("SessionResetPush",this.sessionId,function(t,i,l){n.onRecvResetSession(t,i,l)}),this.signal.registerPushCallback("StreamStatusNotifyPush",this.sessionId,function(t,i,l){n.gotStreamStatus=!0,n.streamStatus=l,n.remoteStream&&n.onRecvStreamStatus(l)}),this.signal.registerPushCallback("PlayEventPush",this.sessionId,function(t,i,l){n.onRecvPlayEvent(t,i,l)}),this.logger.debug("zp.ops.1 call success")},t.prototype.onCreateOfferSuccess=function(t){var n=this;this.logger.info("zp.oco.1 localSdp1 "+t.sdp.substr(0,t.sdp.length/2)),this.logger.info("zp.oco.1 localSdp2 "+t.sdp.substr(t.sdp.length/2)),t.sdp=t.sdp.replace(/sendrecv/g,"recvonly"),this.playOption.videoDecodeType&&(t.sdp=e.sdpUtil.getSDPByVideDecodeType(t.sdp,this.playOption.videoDecodeType)),this.dataReport.eventStart(this.reportSeq,"SetLocalDescription"),this.peerConnection.setLocalDescription(t).then(function(){n.dataReport.eventEnd(n.reportSeq,"SetLocalDescription"),n.onSetLocalDescriptionSuccess(t)},function(t){n.logger.error("zp.oca.1 set error "+t.toString()),n.dataReport.eventEnd(n.reportSeq,"SetLocalDescription",{error:t.toString()}),n.playStateUpdateError(v.playErrorList.SET_LOCAL_DESC_ERROR,!0)})},t.prototype.onSetLocalDescriptionSuccess=function(t){var n=this;this.logger.info("zp.osd.1 success");var i={sdp:t.sdp};this.answerSeq=v.getSeq(),this.dataReport.eventStart(this.reportSeq,"SendMediaDesc"),this.signal.sendMediaDesc(this.answerSeq,this.sessionId,0,i,function(t,i,l){n.logger.info("zp.osd.1 sendMediaDesc resp"),n.answerSeq==t&&n.sessionId==i?(n.logger.info("zp.osd.1 send success stateNego:waiterAnswer"),n.stateNego=p.ENUM_PLAY_STATE_NEGO.waiterAnswer,n.dataReport.eventEnd(n.reportSeq,"SendMediaDesc"),n.waitingOfferTimer=setTimeout(function(){n.state==p.ENUM_PLAY_STATE.waitingOffserRsp&&(n.logger.error("zp.osd.1 waiting timeout"),n.playStateUpdateError(v.playErrorList.SERVER_CANDIDATE_TIMEOUT))},n.waitingOfferTimeInterval),n.state=p.ENUM_PLAY_STATE.waitingServerAnswer):n.logger.error("zp.osd.1 seq or sessionId is not equal "+n.answerSeq+" "+t,0+n.sessionId+" "+i)},function(t,i){n.logger.error("zp.osd.1 failed to send "+t),n.dataReport.eventEndWithMsg(n.reportSeq,"SendMediaDesc",{error:t}),n.playStateUpdateError(v.playErrorList.SEND_MEDIA_DESC_TIMEOUT)}),this.state=p.ENUM_PLAY_STATE.waitingOffserRsp},t.prototype.onRecvMediaDesc=function(t,n,i){var l=this;if(this.logger.info("zp.orm.1 received ",i),this.stateNego=p.ENUM_PLAY_STATE_NEGO.waitingCandidate,this.logger.info("zp.orm.1 received stateNego:waitingCandidate"),this.state===p.ENUM_PLAY_STATE.waitingServerAnswer){null!=this.waitingOfferTimer&&(clearTimeout(this.waitingOfferTimer),this.waitingOfferTimer=null),this.dataReport.addEvent(this.reportSeq,"RecvMediaDesc"),this.signal.sendMediaDescAck(t,this.sessionId,0);var e={type:"answer",sdp:i.sdp,toJSON:function(){}};this.dataReport.eventStart(this.reportSeq,"SetRemoteDescription"),this.logger.info("zp.orm.1 remoteSdp ",e.sdp),this.peerConnection.setRemoteDescription(new RTCSessionDescription(e)).then(function(){l.dataReport.eventEnd(l.reportSeq,"SetRemoteDescription"),l.logger.info("zp.orm.1 set success")},function(t){l.logger.error("zp.orm.1 set remote error "+t.toString()),l.dataReport.eventEndWithMsg(l.reportSeq,"SetRemoteDescription",{error:t.toString()}),l.playStateUpdateError(v.playErrorList.SET_REMOTE_DESC_ERROR,!0)}),this.waitICETimer=setTimeout(function(){l.state==p.ENUM_PLAY_STATE.waitingServerICE&&(l.logger.error("zp.orm.1 waiting server timeout"),l.playStateUpdateError(v.playErrorList.SERVER_CANDIDATE_TIMEOUT))},this.waitingICETimeInterval),this.state=p.ENUM_PLAY_STATE.waitingServerICE,this.logger.debug("zp.orm.1 call success")}else this.logger.error("zp.orm.1 current state "+this.state+" not allowed")},t.prototype.onRecvCandidateInfo=function(t,n,i){var l=this;if(this.logger.info("zp.orci.1 received "),this.state==p.ENUM_PLAY_STATE.waitingServerICE){null!=this.waitICETimer&&(clearTimeout(this.waitICETimer),this.waitICETimer=null),this.dataReport.addEvent(this.reportSeq,"RecvIceCandidate"),this.signal.sendCandidateInfoAck(t,this.sessionId,0),this.sendCandidateInfo(this.candidateInfo),this.candidateInfo=[];for(var e=0;e<i.infos.length;e++){var T={sdpMid:i.infos[e].sdpMid,sdpMLineIndex:i.infos[e].sdpMLineIndex,candidate:i.infos[e].candidate};this.logger.debug("zp.orci.1 candidate "+T.candidate),this.peerConnection.addIceCandidate(new RTCIceCandidate(T)).then(function(){l.logger.debug("zp.orci.1 add success")},function(t){l.logger.error("zp.orci.1 add error "+t.toString()),l.playStateUpdateError(v.playErrorList.SERVER_CANDIDATE_ERROR,!0)})}this.state=p.ENUM_PLAY_STATE.connecting,this.logger.debug("zp.orci.1 call success")}else this.logger.warn("zp.orci.1 current state "+this.state+" not allowed")},t.prototype.onRecvPlayEvent=function(t,n,i){if(this.logger.info("zp.orpe.1 received"),!0===this.playEvent&&0==i.event){this.logger.info("zp.orpe.1 retry: "+this.streamId);var l=this.streamId,p=this.remoteVideo,e=this.audioOutput,T=this.playOption;this.signal.sendCloseSession(v.getSeq(),this.sessionId,1),this.resetPlay(),this.startPlay(l,p,e,T)}else this.playEvent=!0},t.prototype.onIceCandidate=function(t){if(this.logger.info("zp.oic.1 called"),null!=t.candidate)if(this.logger.debug("zp.oic.1 candidate "+t.candidate.candidate),this.state<p.ENUM_PLAY_STATE.connecting||this.state==p.ENUM_PLAY_STATE.stop)this.logger.debug("zp.oic.1 cached"),this.candidateInfo.push({candidate:t.candidate.candidate,sdpMid:t.candidate.sdpMid,sdpMLineIndex:t.candidate.sdpMLineIndex});else{this.logger.debug("zp.oic.1 send");var n={candidate:t.candidate.candidate,sdpMid:t.candidate.sdpMid,sdpMLineIndex:t.candidate.sdpMLineIndex};this.sendCandidateInfo([n])}},t.prototype.onConnectionStateChange=function(t){this.logger.info("zp.oisc.1 called "+t.target.signalingState)},t.prototype.onIceConnectionStateChange=function(t){if(this.state!=p.ENUM_PLAY_STATE.stop&&null!=this.peerConnection)if(this.logger.info("zp.oisc.1  stateChanged "+this.peerConnection.iceConnectionState),"connected"===this.peerConnection.iceConnectionState){for(var n in this.dataReport.addEvent(this.reportSeq,"IceConnected"),this.state!=p.ENUM_PLAY_STATE.playing&&this.onPlayStateUpdate(v.ENUM_PLAY_STATE_UPDATE.start,this.streamId,null,!0),this.state=p.ENUM_PLAY_STATE.playing,this.dataReport.eventStart(this.reportSeq,"PlayState"),this.streamCenter.publisherList){if(this.streamCenter.publisherList[n].publisher.state==p.ENUM_PUBLISH_STATE.publishing&&this.broadcasterStatus==p.ENUM_BROADCASTER_STATUS.stop){this.signal&&this.signal.sendBroadcasterStatus(v.getSeq(),this.sessionId,1),this.broadcasterStatus=p.ENUM_BROADCASTER_STATUS.start;break}}this.setPlayQualityTimer(),this.stateNego=p.ENUM_PLAY_STATE_NEGO.iceConnected,this.logger.info("zp.oisc.1  stateNego:iceConnected"),this.negoTimer&&clearTimeout(this.negoTimer)}else"closed"===this.peerConnection.iceConnectionState?(this.dataReport.addEvent(this.reportSeq,"IceClosed"),this.stateNego=p.ENUM_PLAY_STATE_NEGO.iceClosed,this.checkPlayConnectionFailedState(this.peerConnection.iceConnectionState)):"failed"===this.peerConnection.iceConnectionState?(this.dataReport.addEvent(this.reportSeq,"IceFailed"),this.stateNego=p.ENUM_PLAY_STATE_NEGO.iceFailed,this.checkPlayConnectionFailedState(this.peerConnection.iceConnectionState)):"disconnected"===this.peerConnection.iceConnectionState&&(this.dataReport.addEvent(this.reportSeq,"IceDisconnected"),this.stateNego=p.ENUM_PLAY_STATE_NEGO.iceDisconnected,this.checkPlayConnectionFailedState(this.peerConnection.iceConnectionState))},t.prototype.checkPlayConnectionFailedState=function(t){var n=null;"failed"==t?n=v.playErrorList.MEDIA_CONNECTION_FAILED:"closed"==t?n=v.playErrorList.MEDIA_CONNECTION_CLOSED:"disconnected"==t&&(n=v.playErrorList.MEDIA_CONNECTION_DISCONNECTED),null!=n&&(this.logger.info("zp.oics.1  state "+this.state+" connectionState "+t),this.playStateUpdateError(n))},t.prototype.clearPlayQualityTimer=function(){null!=this.qualityTimer&&(clearInterval(this.qualityTimer),this.qualityTimer=null),this.lastPlayStats={audioPacketsLost:null,videoPacketsLost:null,time:null,audioTime:null,videoTime:null,audioBytesReceived:null,videoBytesReceived:null,framesDecoded:null,framesDropped:null,framesReceived:null,audioBitrate:null}},t.prototype.resetPlay=function(){this.logger.info("zp.rp.1 call"),this.streamId=null,this.state=p.ENUM_PLAY_STATE.stop,this.playEvent=!1,null!=this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null),null!=this.waitingOfferTimer&&(clearTimeout(this.waitingOfferTimer),this.waitingOfferTimer=null),null!=this.waitICETimer&&(clearTimeout(this.waitICETimer),this.waitICETimer=null),null!=this.negoTimer&&(clearTimeout(this.negoTimer),this.negoTimer=null),this.clearPlayQualityTimer(),this.remoteVideo&&(this.remoteVideo.srcObject=null,this.remoteVideo.oncanplay=null,this.remoteVideo=null),this.audioOputput=null,this.signal&&(this.signal.unregisterPushCallback("MediaDescPush",this.sessionId),this.signal.unregisterPushCallback("CandidateInfoPush",this.sessionId),this.signal.unregisterPushCallback("CloseSessionPush",this.sessionId)),this.sessionSeq=0,this.answerSeq=0,this.videoSizeCallback=!1,this.script&&this.script.disconnect(),this.mic&&this.mic.disconnect()},t.prototype.setPlayQualityTimer=function(){var t=this;if(null==this.qualityTimer){this.logger.debug("zp.spq.1 startTimer"),this.clearPlayQualityTimer();var n=!0;this.peerConnection.getStats(function(){}).catch(function(i){t.logger.info("zp.spq.1 "+t.streamId+" getStats callback not support"),n=!1}),this.qualityTimer=setInterval(function(){t.peerConnectionGetStats(n)},this.qualityTimeInterval),this.lastPlayStats={audioPacketsLost:0,videoPacketsLost:0,time:0,audioTime:0,videoTime:0,audioBytesReceived:0,videoBytesReceived:0,framesDecoded:0,framesReceived:0,framesDropped:0,audioBitrate:0}}},t.prototype.peerConnectionGetStats=function(t){var n=this;this.peerConnection&&(t&&this.peerConnection.getStats(function(t){n.getOldGoogStats(t)},function(t){n.logger.info("zp.spq.1 getOldGoogStats error "+t.toString())}),this.peerConnection.getStats(null).then(function(t){n.getPlayStats(t)},function(t){n.logger.info("zp.spq.1 getStats error "+t.toString())}))},t.prototype.getOldGoogStats=function(t){var n=this;t&&t.result().forEach(function(t){var i=["audioOutputLevel","googCpuLimitedResolution","googBandwidthLimitedResolution","googCodecName","googActualEncBitrate","googFrameWidthInput","googFrameHeightInput","googFrameRateInput","codecImplementationName"];if("VideoBwe"===t.type&&t.names().includes("googAvailableSendBandwidth")&&(n.streamGoogInfo.googAvailableSendBandwidth=t.stat("googAvailableReceiveBandwidth")||""),"ssrc"===t.type)for(var l=0;l<i.length;l++){var p=i[l];t.names().includes(p)&&(n.streamGoogInfo[p]=t.stat(p)||"")}})},t.prototype.getPlayStats=function(t){var n=this;if(null!=t){var i=l({audioFractionLost:null,audioPacketsLost:0,audioPacketsLostRate:0,audioBitrate:0,audioLevel:0,audioSendLevel:0,audioSamplingRate:0,audioCodecType:"opus",audioQuality:null,videoQuality:null,videoPacketsLostRate:0,videoBitrate:0,videoFPS:0,playData:0,nackCount:0,pliCount:0,audioJitter:0,videoFractionLost:null,videoFramesDecoded:0,frameHeight:0,frameWidth:0,videoTransferFPS:0,videoFramesDropped:0,totalRoundTripTime:0,currentRoundTripTime:0,muted:!this.remoteVideo||this.remoteVideo.muted,paused:!this.remoteVideo||this.remoteVideo.paused,volume:this.remoteVideo?this.remoteVideo.volume:0,audioDeviceLabel:"",videoDeviceLbabel:""},this.streamGoogInfo);if(this.remoteVideo){var p=this.remoteVideo.srcObject;i.audioDeviceLabel=p.getAudioTracks().length>0?p.getAudioTracks()[0].label:"",i.videoDeviceLbabel=p.getVideoTracks().length>0?p.getVideoTracks()[0].label:""}var v=this.lastPlayStats.time,e=null;t.forEach(function(t){("inbound-rtp"==t.type||"ssrc"==t.type&&null!=t.bytesReceived)&&("audio"==t.mediaType||t.id.indexOf("AudioStream")>=0)?(0!=v&&(i.audioBitrate=8*(t.bytesReceived-n.lastPlayStats.audioBytesReceived)/(t.timestamp-v)),i.audioBitrate<0&&(i.audioBitrate=0),i.audioJitter=t.jitter,i.audioPacketsLost=t.packetsLost,i.audioFractionLost=t.fractionLost,i.audioPacketsLostRate=(t.packetsLost-n.lastPlayStats.audioPacketsLost)/(t.timestamp-n.lastPlayStats.audioTime),n.lastPlayStats.audioBytesReceived=t.bytesReceived,n.lastPlayStats.audioPacketsLost=t.packetsLost,n.lastPlayStats.audioTime=t.timestamp,n.lastPlayStats.time=t.timestamp,n.lastPlayStats.audioBitrate=i.audioBitrate):("inbound-rtp"==t.type||"ssrc"==t.type&&null!=t.bytesReceived)&&("video"==t.mediaType||t.id.indexOf("VideoStream")>=0)?(0!=v&&(i.videoBitrate=8*(t.bytesReceived-n.lastPlayStats.videoBytesReceived)/(t.timestamp-v),i.videoFPS=1e3*(t.framesDecoded-n.lastPlayStats.framesDecoded)/(t.timestamp-v)),i.videoBitrate<0&&(i.videoBitrate=0),i.videoFPS<0&&(i.videoFPS=0),i.nackCount=t.nackCount,i.pliCount=t.pliCount,i.videoFractionLost=t.fractionLost,i.videoFramesDecoded=t.framesDecoded,i.videoPacketsLostRate=(t.packetsLost-n.lastPlayStats.videoPacketsLost)/(t.timestamp-n.lastPlayStats.videoTime),n.lastPlayStats.videoBytesReceived=t.bytesReceived,n.lastPlayStats.framesDecoded=t.framesDecoded,n.lastPlayStats.videoPacketsLost=t.packetsLost,n.lastPlayStats.videoTime=t.timestamp,n.lastPlayStats.time=t.timestamp):"track"==t.type&&("video"==t.kind||t.id.indexOf("video")>=0)||t.frameWidth?(i.frameHeight=t.frameHeight,i.frameWidth=t.frameWidth,0!=v&&(i.videoTransferFPS=1e3*(t.framesReceived-n.lastPlayStats.framesReceived)/(t.timestamp-v),i.videoFramesDropped=t.framesDropped-n.lastPlayStats.framesDropped),i.videoTransferFPS<0&&(i.videoTransferFPS=0),i.videoFramesDropped<0&&(i.videoFramesDropped=0),n.lastPlayStats.framesReceived=t.framesReceived,n.lastPlayStats.framesDropped=t.framesDropped):"track"==t.type&&("audio"==t.kind||t.id.indexOf("audio")>=0)?(i.audioLevel=t.audioLevel,i.audioSendLevel=t.totalAudioEnergy,i.audioSamplingRate=t.totalSamplesDuration):"candidate-pair"==t.type&&(null!=t.totalRoundTripTime&&(i.totalRoundTripTime=t.totalRoundTripTime),null!=t.currentRoundTripTime&&(i.currentRoundTripTime=t.currentRoundTripTime,e=1e3*i.currentRoundTripTime))}),i.audioQuality=this.getNetQuality(e,i.audioFractionLost),i.videoQuality=this.getNetQuality(e,i.videoFractionLost),this.uploadPlayQuality(i),0!=v&&this.onPlayQualityUpdate(this.streamId,i)}},t.prototype.getNetQuality=function(t,n){return t&&t<600?n>.4?2:n>.3?4:5:t<900?n>.4?2:n>.2?3:4:n>.2?2:3},t.prototype.uploadPlayQuality=function(t){var n=this;if(this.qualityUpload){var i=Date.parse(new Date+"");(0==this.qualityUploadLastTime||i-this.qualityUploadLastTime>=this.qualityUploadInterval)&&(t.stream_type="play",t.stream_id=this.streamId,t.timeStamp=i/1e3,this.logger.info("zp.upq.1 upload"+JSON.stringify(t)),this.signal.QualityReport(v.getSeq(),this.sessionId,t,function(t,i,l){void 0!==l.report&&(n.qualityUpload=l.report,n.qualityUploadInterval=l.report_interval_ms)},function(t,i){n.logger.info("zp.upq.1 upload failed "+t)}),this.qualityUploadLastTime=i)}},t.prototype.onRecvResetSession=function(t,n,i){if(this.logger.info("zp.orrs.1 received "),n==this.sessionId){this.dataReport.addEvent(this.reportSeq,"RecvResetSession"),this.signal.sendCloseSessionAck(t,this.sessionId,0);var l=JSON.parse(JSON.stringify(v.playErrorList.SESSION_CLOSED));this.negoTimer&&clearTimeout(this.negoTimer),this.playStateUpdateError(l)}else this.logger.info("zp.orrs.1 cannot find session")},t.prototype.onRecvCloseSession=function(t,n,i){this.logger.info("zp.orcs.1 reason: "+i.reason),this.dataReport.addEvent(this.reportSeq,"RecvCloseSession"),this.signal.sendCloseSessionAck(t,this.sessionId,0);var l=JSON.parse(JSON.stringify(v.playErrorList.SESSION_CLOSED));l.msg+=" reason:"+i.reason+(i.err_info&&JSON.parse(i.err_info).action?"action:"+JSON.parse(i.err_info).action:""),this.negoTimer&&clearTimeout(this.negoTimer);var p=1*i.reason,e=i.err_info&&JSON.parse(i.err_info).action?JSON.parse(i.err_info).action:null,T=![4,8,10,11,12,14,24,26,27,28].includes(p)&&5!=e&&2!=e;this.playStateUpdateError(l,T)},t.prototype.onRecvStreamStatus=function(t){if(this.logger.debug("zp.orss.0 call"),this.cameraStatus!==t.camera_status&&this.onRemoteCameraStatusUpdate(this.streamId,t.camera_status),this.micStatus!==t.mic_status&&this.onRemoteMicStatusUpdate(this.streamId,t.mic_status),this.cameraStatus=t.camera_status,this.micStatus=t.mic_status,-1===["all","video","audio"].indexOf(this.playOption.playType)){var n=this.remoteVideo.srcObject;0!==t.camera_status&&n&&0!==n.getVideoTracks().length&&(n.getVideoTracks().forEach(function(t){t.stop(),n.removeTrack(t)}),this.remoteVideo.srcObject=n),0==t.camera_status&&n&&0==n.getVideoTracks().length&&(this.remoteVideo.srcObject=this.remoteStream.clone()),this.logger.debug("zp.orss.0 call success")}else this.logger.info("zp.orss.0 has set playType, ignore stream status")},t.prototype.onGotRemoteStream=function(t){this.logger.info("zp.ogrs.0 called "+t),this.remoteVideo?(this.remoteStream=t,this.remoteVideo.srcObject=t.clone(),this.audioOputput&&this.setAudioDestination(this.audioOputput),this.gotStreamStatus&&this.onRecvStreamStatus(this.streamStatus),this.streamCenter.soundLevelDelegate&&this.startSoundLevel(),this.dataReport.addEvent(this.reportSeq,"GetRemoteStream")):this.logger.error("zp.ogrs.0 no remoteVideo")},t.prototype.sendCandidateInfo=function(t){var n=this;this.logger.info("zp.sci.1 called"),!(t=t.filter(function(t){return!(t.candidate.indexOf("tcp")>0)&&(!!t.candidate||void 0)}))||t.length<1?this.logger.info("zp.sci.1 cancelled"):(this.dataReport.eventStart(this.reportSeq,"SendIceCandidate"),this.stateNego!==p.ENUM_PLAY_STATE_NEGO.iceConnected&&(this.stateNego=p.ENUM_PLAY_STATE_NEGO.sendCandidate),this.logger.info("zp.sci.1  stateNego:sendCandidate"),this.signal.sendCandidateInfo(v.getSeq(),this.sessionId,t,function(t,i,l){n.logger.debug("zp.sci.1 send success"),n.dataReport.eventEnd(n.reportSeq,"SendIceCandidate")},function(t,i){n.logger.error("zp.sci.1 failed to send: "+t.toString()),n.dataReport.eventEndWithMsg(n.reportSeq,"SendIceCandidate",{error:t}),n.playStateUpdateError(v.playErrorList.SEND_CANDIDATE_ERROR)}))},t.prototype.shouldSendCloseSession=function(t){return this.state!=v.ENUM_PLAY_STATE_UPDATE.stop&&this.state!=p.ENUM_PLAY_STATE.waitingSessionRsp},t.prototype.playStateUpdateError=function(t,n){this.logger.info("zp.psue.1 called ",this.streamId,JSON.stringify(t)),this.streamId&&this.onPlayStateUpdate(v.ENUM_PLAY_STATE_UPDATE.error,this.streamId,t,n),this.logger.info("zp.psue.1 ended")},t.prototype.onPlayStateUpdate=function(t,n,i,l){},t.prototype.onPlayQualityUpdate=function(t,n){},t.prototype.onVideoSizeChanged=function(t,n,i){},t.prototype.onRemoteCameraStatusUpdate=function(t,n){},t.prototype.onRemoteMicStatusUpdate=function(t,n){},t.prototype.stopPlay=function(){for(var t in this.logger.info("zp.sp.1.1 called"),this.streamCenter.publisherList){if(this.streamCenter.publisherList[t].publisher.state==p.ENUM_PUBLISH_STATE.publishing&&this.broadcasterStatus==p.ENUM_BROADCASTER_STATUS.start){this.signal&&this.signal.sendBroadcasterStatus(v.getSeq(),this.sessionId,0),this.broadcasterStatus=p.ENUM_BROADCASTER_STATUS.stop;break}}this.sessionId&&!this.closeSessionSignal&&this.signal.sendCloseSession(v.getSeq(),this.sessionId,0),this.dataReport.eventEndWithMsg(this.reportSeq,"PlayState",{state:this.state+""}),this.dataReport.addEvent(this.reportSeq,"StopPlay"),this.dataReport.addMsgExt(this.reportSeq,{stream:this.streamId,sessionId:this.sessionId}),this.dataReport.uploadReport(this.reportSeq,"RTCPlayStream"),this.resetPlay()},t.prototype.onDisconnect=function(){this.logger.info("zp.od.1 call"),this.logger.info("zp.od.1 websocket disconnect"),this.dataReport.addEvent(this.reportSeq,"OnDisconnect"),this.playStateUpdateError(v.playErrorList.WEBSOCKET_ERROR)},t.prototype.startSoundLevel=function(){var t=this;if(this.logger.info("zp.ssl.1 call streamID: "+this.streamId),this.remoteStream&&0!=this.remoteStream.getAudioTracks().length){this.script&&this.script.disconnect()&&(this.script=null),this.mic&&this.mic.disconnect()&&(this.mic=null),this.ac&&this.ac.close()&&(this.ac=null);try{this.ac=new("undefined"!=typeof webkitAudioContext?webkitAudioContext:AudioContext),this.mic=this.ac.createMediaStreamSource(this.remoteVideo.srcObject),this.script=this.ac.createScriptProcessor(4096,1,1),this.mic.connect(this.script),this.script.connect(this.ac.destination),this.script.onaudioprocess=function(n){for(var i=n.inputBuffer.getChannelData(0),l=0,p=0;p<i.length;p++)l<i[p]&&(l=i[p]);t.soundLevel=100*l}}catch(t){this.logger.error("zp.ssl.1 get sound level failed "+t)}}else this.logger.info("zp.ssl.1 remote stream no found")},t.prototype.stopSoundLevel=function(){this.logger.info("zp.ssl.1.1 call streamID: "+this.streamId),this.script&&this.script.disconnect(),this.mic&&this.mic.disconnect(),this.ac&&this.ac.close(),this.script=null,this.mic=null,this.ac=null},t}();n.ZegoPlayWeb=T},function(t,n,i){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var l=function(){function t(t,n){this.playerList={},this.publisherList={}}return t.prototype.setSessionInfo=function(t,n,i,l){},t}();n.ZegoStreamCenter=l},function(t,n,i){"use strict";var l,p=this&&this.__extends||(l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var i in n)n.hasOwnProperty(i)&&(t[i]=n[i])},function(t,n){function i(){this.constructor=t}l(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)});Object.defineProperty(n,"__esModule",{value:!0});var v=i(5),e=i(0),T=i(1),E=function(t){function n(n,i){var l=t.call(this,n,i)||this;return l.logger=n,l.stateCenter=i,l}return p(n,t),n.prototype.initStream=function(t,n,i,l){this.streamCenter=t,this.isPublish=n,this.streamID=i,this.serverUrls=l},n.prototype.active=function(t){var n=this;if(this.logger.info("zc.tsh.a retry call "+this.streamID),this.stateCenter.networkState==e.ENUM_NETWORK_STATE.offline)return this.logger.info("zc.tsh.a network is broken, stop retry"),!1;if(this.retryTimer)return this.logger.info("zc.tsh.a has actived, ignore"),!1;if(this.isOverTime)return this.logger.warn("zc.tsh.a retry over time, stop retry"),!1;if(1==this.retryActiveCount)this.retryActiveInterval=Math.floor(Math.random()*(1-this.RETRY_START_TIME_INTERVAL)+this.RETRY_START_TIME_INTERVAL);else{var i=Math.pow(2,Math.round(this.retryActiveCount/this.RETRY_CONTINUE_COUNT+1));this.retryActiveInterval=i>this.RETRY_MAX_TIME_INTERVAL?this.RETRY_MAX_TIME_INTERVAL:i}var l,p=this.serverUrls;if(this.isPublish){var v=this.streamCenter.publisherList[this.streamID].publisher;l=v.signal?v.signal.server:""}else{var T=this.streamCenter.playerList[this.streamID].player;l=T.signal?T.signal.server:""}p.forEach(function(t,i){return i<=p.indexOf(l)&&n.serverUrls.push(t)}),p.splice(0,p.indexOf(l)+1);var E=this.serverUrls[this.retryActiveCount%this.serverUrls.length==0?this.serverUrls.length-1:this.retryActiveCount%this.serverUrls.length-1];return this.retryTimer=setTimeout(function(){console.warn("stream "+n.streamID+" retry connect signal server "+E),n.retryTimer&&clearTimeout(n.retryTimer),n.retryTimer=null,n.retryActiveCount++,n.isPublish?n.streamCenter.connectPublishServer(n.streamID,E):n.streamCenter.connectPlayServer(n.streamID,E)},"number"==typeof t?t:1e3*this.retryActiveInterval),this.logger.info("zc.tsh.a call success"),!0},n.prototype.startMaxTime=function(){var t=this;this.maxTimer||(this.maxTimer=setTimeout(function(){if(console.warn(t.streamID+" over max time "+t.RETRY_MAX_TIME+"s, stop retry"),t.isOverTime=!0,t.invalid(),t.isPublish){var n=t.streamCenter.publisherList[t.streamID];if(!n)return void t.logger.info("zc.tsh.smt streamID "+t.streamID+" publish no found");n.publisher.onPublishStateUpdate(T.ENUM_PUBLISH_STATE_UPDATE.error,t.streamID,T.publishErrorList.RETRY_TIMEOUT,!0)}else{var i=t.streamCenter.playerList[t.streamID];if(!i)return void t.logger.info("zc.tsh.smt streamID "+t.streamID+" play no found");i.player.onPlayStateUpdate(T.ENUM_PLAY_STATE_UPDATE.error,t.streamID,T.playErrorList.RETRY_TIMEOUT,!0)}},1e3*this.RETRY_MAX_TIME))},n.prototype.stopMaxTime=function(){this.maxTimer&&clearTimeout(this.maxTimer),this.maxTimer=null},n.prototype.onactive=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n]},n.prototype.retryNextSignal=function(t){if(t.code==T.publishErrorList.SESSION_CLOSED.code||t.code==T.playErrorList.SESSION_CLOSED.code){var n=t.msg.match(/reason:(\d+)/)[1];return this.isPublish?!["26"].includes(n):!["24","26","28"].includes(n)}return!0},n}(v.TryHandler);n.TryStreamHandler=E},function(t,n,i){"use strict";var l,p=this&&this.__extends||(l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var i in n)n.hasOwnProperty(i)&&(t[i]=n[i])},function(t,n){function i(){this.constructor=t}l(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)});Object.defineProperty(n,"__esModule",{value:!0});var v=i(20),e=i(0),T=i(2),E=i(21),R=i(22),S=i(23),L=i(25),M=i(26),u=i(27),h=i(28),f=function(t){function n(){return t.call(this)||this}return p(n,t),n.prototype.init=function(){this.bindSocketHandler(),this.bindStreamHandler(),this.bindHeatBeatHandler(),this.bindRoomHandler(),this.bindMessageHandler(),this.bindLiveHandler(),this.bindStreamCenterHandler()},n.prototype.bindSocketHandler=function(){var t=this;this.socketCenter=new E.SocketCenter(this.logger,this.stateCenter),this.socketCenter.registerRouter("push_signal",function(n){t.liveHandler.handlePushSignalMsg(n)}),this.socketCenter.getSocket=function(n){return t.getSocket(n)},this.socketCenter.handlePushKickout=function(n){t.logger.info("zb.cm.bsh.0 call "+n);var i=t.stateCenter.roomTryHandler;i.onactive=function(n,i){i&&t.onKickOut(i)},n.body.need_relogin&&1==n.body.need_relogin?(t.stateCenter.sessionid="",i.startMaxTime(),i.active()):(t.roomHandler.resetRoom(),t.onKickOut({code:e.sdkErrorList.KICK_OUT.code,msg:e.sdkErrorList.KICK_OUT.msg+n.body.reason})),t.logger.info("zb.cm.bsh.0 end")},this.socketCenter.handlePushCustomMsg=function(n){t.messageHandler.handlePushCustomMsg(n)},this.socketCenter.handlePushUserStateUpdateMsg=function(n){t.roomHandler.handlePushUserStateUpdateMsg(n)},this.socketCenter.handlePushRoomMsg=function(n){t.onRecvRoomMsg(n.body.chat_data,n.body.server_msg_id,n.body.ret_msg_id)},this.socketCenter.handlePushMergeMsg=function(n){t.messageHandler.handlePushMergeMsg(n)},this.socketCenter.handlePushTransMsg=function(n){t.messageHandler.handlePushTransMsg(n)},this.socketCenter.handleBigImMsgRsp=function(n){t.messageHandler.handleBigImMsgRsp(n)}},n.prototype.bindStreamHandler=function(){var t=this;this.streamHandler=new S.StreamHandler(this.logger,this.stateCenter,this.socketCenter,this.streamCenter),this.streamHandler.onStreamUpdated=function(n,i){t.onStreamUpdated(n,i)},this.streamHandler.onPublishStateUpdate=function(n,i,l){t.onPublishStateUpdate(n,i,l)},this.streamHandler.onStreamExtraInfoUpdated=function(n){t.onStreamExtraInfoUpdated(n)},this.streamHandler.setCDNInfo=function(n,i){t.setCDNInfo(n,i)}},n.prototype.bindHeatBeatHandler=function(){var t=this;this.heartBeatHandler=new L.HeartBeatHandler(this.logger,this.stateCenter,this.socketCenter),this.heartBeatHandler.onRecvReliableMessage=function(n,i,l){t.onRecvReliableMessage(n,i,l)},this.heartBeatHandler.handleFetchStreamListRsp=function(n){t.streamHandler.handleFetchStreamListRsp(n)},this.heartBeatHandler.fetchUserList=function(){t.roomHandler.fetchUserList()},this.heartBeatHandler.onUpdateOnlineCount=function(n,i){t.onUpdateOnlineCount(n,i)},this.heartBeatHandler.updateStreamInfo=function(n,i,l,p){void 0===l&&(l=""),t.streamHandler.updateStreamInfo(n,i,l,p)},this.heartBeatHandler.hbLogout=function(n){t.logger.info("zc.hl.0 call "+n);var i=t.stateCenter.roomTryHandler;i.onactive=function(n,i){t.disconnectedHandle(i)},n==e.sdkErrorList.HEARTBEAT_TIMEOUT||n.msg.endsWith("1000002001")||n.msg.endsWith("1000000152")?(i.startMaxTime(),i.active()):(i.stopMaxTime(),i.invalid(),t.roomHandler.resetRoom(),t.disconnectedHandle(n)),t.logger.info("zc.hl.0 end")}},n.prototype.bindRoomHandler=function(){var t=this;this.roomHandler=new R.RoomHandler(this.logger,this.stateCenter,this.socketCenter),this.roomHandler.loginSuccessCallBack=function(n,i){var l=i.body.hearbeat_interval<e.MINIUM_HEARTBEAT_INTERVAL?e.MINIUM_HEARTBEAT_INTERVAL:i.body.hearbeat_interval;t.stateCenter.tryHeartbeatCount=0,t.stateCenter.heartbeatTimer&&clearTimeout(t.stateCenter.heartbeatTimer),t.heartBeatHandler.start(l),t.heartBeatHandler.resetCheckMessage(),t.heartBeatHandler.startCheckMessageTimeout(),t.streamCenter.setSessionInfo(t.stateCenter.appid,t.stateCenter.idName,t.stateCenter.token,t.stateCenter.testEnvironment),i.body.anchor_info&&t.onGetAnchorInfo(i.body.anchor_info.anchor_id_name,i.body.anchor_info.anchor_nick_name),i.body.online_count&&t.onUpdateOnlineCount(t.stateCenter.roomid,i.body.online_count),t.logger.info("zb.cm.brh hls userStateUpdate "+t.stateCenter.userStateUpdate),t.stateCenter.userStateUpdate&&(t.logger.info("zb.cm.brh hls fetch all new userlist"),t.roomHandler.fetchUserList()),t.streamHandler.handleStreamStart(n,i)},this.roomHandler.onGetTotalUserList=function(n,i){t.onGetTotalUserList(n,i)},this.roomHandler.resetRoomCallBack=function(){t.heartBeatHandler.resetHeartbeat(),t.heartBeatHandler.resetCheckMessage(),t.resetStreamCenter()},this.roomHandler.onUserStateUpdate=function(n,i){t.onUserStateUpdate(n,i)},this.roomHandler.onDisconnect=function(n){t.logger.info("zc.od.0 call "+n),t.stateCenter.roomTryHandler.onactive=function(n,i){t.disconnectedHandle(i)},t.stateCenter.roomTryHandler.startMaxTime(),t.stateCenter.roomTryHandler.active(),t.logger.info("zc.od.0 end")},this.roomHandler.loginBodyData=function(){return t.loginBodyData()}},n.prototype.bindMessageHandler=function(){var t=this;this.messageHandler=new M.MessageHandler(this.logger,this.stateCenter,this.socketCenter),this.messageHandler.onRecvCustomCommand=function(n,i,l){t.onRecvCustomCommand(n,i,l)},this.messageHandler.onRecvBigRoomMessage=function(n,i){t.onRecvBigRoomMessage(n,i)},this.messageHandler.onRecvReliableMessage=function(n,i,l){t.onRecvReliableMessage(n,i,l)}},n.prototype.bindLiveHandler=function(){var t=this;this.liveHandler=new u.LiveHandler(this.logger,this.stateCenter,this.socketCenter),this.liveHandler.onRecvEndJoinLiveCommand=function(n,i,l,p){t.onRecvEndJoinLiveCommand(n,i,l,p)},this.liveHandler.onRecvInviteJoinLiveRequest=function(n,i,l,p){t.onRecvInviteJoinLiveRequest(n,i,l,p)},this.liveHandler.onRecvJoinLiveRequest=function(n,i,l,p){t.onRecvJoinLiveRequest(n,i,l,p)}},n.prototype.bindStreamCenterHandler=function(){var t=this;this.streamCenter.onPlayStateUpdate=function(n,i,l){t.onPlayStateUpdateHandle(n,i,l)},this.streamCenter.onPlayQualityUpdate=function(n,i){t.onPlayQualityUpdate(n,i)},this.streamCenter.onPublishStateUpdate=function(n,i,l){t.onPublishStateUpdateHandle(n,i,l)},this.streamCenter.onPublishQualityUpdate=function(n,i){t.onPublishQualityUpdate(n,i)},this.streamCenter.onPlayerStreamUrlUpdate=function(n,i,l){t.onStreamUrlUpdate(n,i,l)},this.streamCenter.onVideoSizeChanged=function(n,i,l){t.onVideoSizeChanged(n,i,l)},this.streamCenter.onRemoteCameraStatusUpdate=function(n,i){t.onRemoteCameraStatusUpdate(n,i)},this.streamCenter.onRemoteMicStatusUpdate=function(n,i){t.onRemoteMicStatusUpdate(n,i)},this.streamCenter.onSoundLevelUpdate=function(n){t.onSoundLevelUpdate(n)},this.streamCenter.onDeviceError=function(n){t.onDeviceError(n)},this.streamCenter.OnAudioDeviceStateChanged=function(n){t.OnAudioDeviceStateChanged(n)},this.streamCenter.OnVideoDeviceStateChanged=function(n){t.OnVideoDeviceStateChanged(n)}},n.prototype.config=function(t){return this.logger.debug("zb.cm.cf call"),T.ClientUtil.checkConfigParam(t,this.logger)?(this.stateCenter.appid=t.appid,"string"==typeof t.server?(this.stateCenter.server=t.server,this.stateCenter.serverBak=t.server):Array.isArray(t.server)&&t.server.length>0&&(this.stateCenter.server=t.server[0],this.stateCenter.serverBak=t.server[1]||t.server[0]),this.logger.info("zb.cm.cf server "+JSON.stringify(t.server)),this.stateCenter.idName=t.idName,this.stateCenter.nickName=t.nickName,this.logger.setLogLevel(t.logLevel),!1===t.audienceCreateRoom&&(this.stateCenter.roomCreateFlag=0),t.remoteLogLevel?this.logger.setRemoteLogLevel(t.remoteLogLevel):this.logger.setRemoteLogLevel(0),this.logger.setSessionInfo(t.appid,"","",t.idName,"",e.PROTO_VERSION),t.logUrl&&this.logger.openLogServer(t.logUrl),-1==this.stateCenter.server.indexOf("test2-wsliveroom-api.zego.im")&&-1==this.stateCenter.server.indexOf("wsliveroom-test.zegocloud.com")&&-1==this.stateCenter.server.indexOf("wsliveroom-test.zego.im")||(this.stateCenter.testEnvironment=!0),"number"==typeof t.maxRetryTime&&t.maxRetryTime<3600&&(this.stateCenter.roomRetryTime=this.stateCenter.streamRetryTime=t.maxRetryTime),this.stateCenter.configOK=!0,navigator&&navigator.appVersion&&this.logger.info("zb.cm.cf "+navigator.appVersion),this.stateCenter.networkState=navigator?navigator.onLine?e.ENUM_NETWORK_STATE.online:e.ENUM_NETWORK_STATE.offline:e.ENUM_NETWORK_STATE.online,this.logger.debug("zb.cm.cf call success"),!0):(this.logger.error("zb.cm.cf param error"),!1)},n.prototype.login=function(t,n,i,l,p){this.logger.info("zb.rh.lg call"),"string"==typeof t?"string"==typeof i?1===n||2===n?(this.stateCenter.runState!==e.ENUM_RUN_STATE.logout&&this.roomHandler.resetRoom(),this.stateCenter.roomTryHandler||(this.stateCenter.roomTryHandler=new h.RetryRoomHandler(this.logger,this.stateCenter)),this.stateCenter.roomTryHandler.init(this.stateCenter.roomRetryTime),this.stateCenter.roomTryHandler.initRoom(this.roomHandler,this.stateCenter.server,this.stateCenter.serverBak,t,n,i,null),this.stateCenter.roomTryHandler.onactive=function(t,n){t?l&&l(t):p&&p(n)},this.stateCenter.roomTryHandler.active(!0)):this.logger.error("zb.rh.lg role error"):this.logger.error("zb.rh.lg token type error"):this.logger.error("zb.rh.lg roomid  type error")},n.prototype.loginWithAuthor=function(t,n,i,l,p,v){"string"!=typeof t||"string"!=typeof i||"string"!=typeof l||1!==n&&2!==n?this.logger.error("zb.rh.lg params error"):this.roomHandler.login(this.stateCenter.server,t,n,i,l,p,v)},n.prototype.logout=function(){return this.logger.info("zc.lg.0 call"),this.roomHandler.logout()},n.prototype.setUserStateUpdate=function(t){"boolean"==typeof t?this.roomHandler.setUserStateUpdate(t):console.error("setUserStateUpdate param error")},n.prototype.onUserStateUpdate=function(t,n){},n.prototype.onGetTotalUserList=function(t,n){},n.prototype.onUpdateOnlineCount=function(t,n){},n.prototype.onGetAnchorInfo=function(t,n){},n.prototype.release=function(){this.logger.debug("zb.cm.rl call"),this.roomHandler.resetRoom(),this.logger.stopLogServer(),this.logger.debug("zb.cm.rl call success")},n.prototype.sendCustomCommand=function(t,n,i,l){return"string"!=typeof n&&"object"!=typeof n?(this.logger.error("zb.mh.scc params error"),!1):this.messageHandler.sendCustomCommand(t,n,i,l)},n.prototype.onRecvCustomCommand=function(t,n,i){},n.prototype.sendRoomMsg=function(t,n,i,l,p){this.messageHandler.sendRoomMsg(t,n,i,l,p)},n.prototype.onRecvRoomMsg=function(t,n,i){},n.prototype.sendReliableMessage=function(t,n,i,l){this.messageHandler.sendReliableMessage(t,n,i,l)},n.prototype.onRecvReliableMessage=function(t,n,i){},n.prototype.sendBigRoomMessage=function(t,n,i,l,p){this.messageHandler.sendBigRoomMessage(t,n,i,l,p)},n.prototype.onRecvBigRoomMessage=function(t,n){},n.prototype.sendRelayMessage=function(t,n,i,l){this.messageHandler.sendRelayMessage(t,n,i,l)},n.prototype.requestJoinLive=function(t,n,i,l){return this.liveHandler.requestJoinLive(t,n,i,l)},n.prototype.onRecvJoinLiveRequest=function(t,n,i,l){},n.prototype.inviteJoinLive=function(t,n,i,l){return this.liveHandler.inviteJoinLive(t,n,i,l)},n.prototype.onRecvInviteJoinLiveRequest=function(t,n,i,l){},n.prototype.endJoinLive=function(t,n,i){return this.liveHandler.endJoinLive(t,n,i)},n.prototype.onRecvEndJoinLiveCommand=function(t,n,i,l){},n.prototype.respondJoinLive=function(t,n,i,l){return this.liveHandler.respondJoinLive(t,n,i,l)},n.prototype.updateMixStream=function(t,n,i){return this.streamHandler.updateMixStream(t,n,i)},n.prototype.stopMixStream=function(t,n,i){return this.streamHandler.stopMixStream(t,n,i)},n.prototype.publishTarget=function(t,n,i){return this.streamHandler.publishTarget(t,n,i)},n.prototype.updateStreamExtraInfo=function(t,n){return this.streamHandler.updateStreamExtraInfo(t,n)},n.prototype.onStreamUrlUpdate=function(t,n,i){},n.prototype.onStreamUpdated=function(t,n){},n.prototype.onStreamExtraInfoUpdated=function(t){},n.prototype.onPlayStateUpdate=function(t,n,i){},n.prototype.onVideoSizeChanged=function(t,n,i){},n.prototype.onRemoteCameraStatusUpdate=function(t,n){},n.prototype.onRemoteMicStatusUpdate=function(t,n){},n.prototype.onPlayQualityUpdate=function(t,n){},n.prototype.onPublishStateUpdate=function(t,n,i){},n.prototype.onPublishQualityUpdate=function(t,n){},n.prototype.onSoundLevelUpdate=function(t){},n.prototype.onDeviceError=function(t){},n.prototype.OnAudioDeviceStateChanged=function(t){},n.prototype.OnVideoDeviceStateChanged=function(t){},n.prototype.onDisconnect=function(t){},n.prototype.onKickOut=function(t){},n.prototype.onTempBroken=function(){},n.prototype.onReconnect=function(){},n.prototype.disconnectedHandle=function(t){t?this.onDisconnect(e.sdkErrorList.LOGIN_DISCONNECT):this.onReconnect()},n.getCurrentVersion=function(){return e.PROTO_VERSION},n}(v.Common);n.BaseCenter=f},function(t,n,i){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var l=i(0),p=i(1),v=function(){function t(){}return t.prototype.onPlayStateUpdateHandle=function(t,n,i){this.onPlayStateUpdate(t,n,i)},t.prototype.onPublishStateUpdateHandle=function(t,n,i){0==t?this.stateCenter.publishStreamList[n]&&(this.stateCenter.publishStreamList[n].state!=l.ENUM_PUBLISH_STREAM_STATE.tryPublish||this.stateCenter.streamList.find(function(t){return t.stream_id==n})?(this.stateCenter.publishStreamList[n].state=l.ENUM_PUBLISH_STREAM_STATE.publishing,this.WebrtcOnPublishStateUpdateHandle(t,n,i)):(this.stateCenter.publishStreamList[n].state=l.ENUM_PUBLISH_STREAM_STATE.update_info,this.streamHandler.updateStreamInfo(n,l.ENUM_STREAM_SUB_CMD.liveBegin,this.stateCenter.publishStreamList[n].extra_info))):this.onPublishStateUpdate(t,n,i)},t.prototype.resetStreamCenter=function(){if(this.stateCenter.customUrl&&(this.stateCenter.customUrl=null),this.streamCenter.reset(),!this.socketCenter.isDisConnect())for(var t in this.stateCenter.publishStreamList)if(this.stateCenter.publishStreamList[t].state==l.ENUM_PUBLISH_STREAM_STATE.publishing){this.streamHandler.updateStreamInfo(t,l.ENUM_STREAM_SUB_CMD.liveEnd,this.stateCenter.publishStreamList[t].extra_info);for(var n=0;n<this.stateCenter.streamList.length;n++)if(this.stateCenter.streamList[n].stream_id==t){this.stateCenter.streamList.splice(n--,1);break}}},t.prototype.handleFetchWebRtcUrlRsp=function(t){var n=t.body.stream_id,i=!1;if(t.body.urls&&Array.isArray(t.body.urls)&&t.body.urls.length>0?i=!0:this.logger.error("cb.cm.hfwur signal url is empty"),"push"===t.body.ptype)!i&&this.onPublishStateUpdate(1,n,p.publishErrorList.DISPATCH_ERROR)&&this.stopPublishingStream(n),this.stateCenter.publishStreamList[n]?this.streamCenter.startPublishingStream(n,t.body.urls):this.logger.error("cb.cm.hfwur no streamid to publish");else if("pull"==t.body.ptype){!i&&this.onPlayStateUpdate(1,n,p.playErrorList.DISPATCH_ERROR)&&this.stopPlayingStream(n);for(var l=!1,v=0;v<this.stateCenter.streamList.length;v++)if(this.stateCenter.streamList[v].stream_id===n){l=!0;break}0==l&&this.logger.warn("cb.cm.hfwur cannot find stream, continue to play"),this.streamCenter.startPlayingStream(n,t.body.urls)}},t}();n.Common=v},function(t,n,i){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var l=i(0),p=i(2),v=function(){function t(t,n){var i=this;this.cmdSeq=0,this.responseRouters={},this.logger=t,this.stateCenter=n,this.responseRouters={push_kickout:function(t){i.handlePushKickout(t)},push_custommsg:function(t){i.handlePushCustomMsg(t)},push_im_chat:function(t){i.handlePushRoomMsg(t)},push_userlist_update:function(t){i.handlePushUserStateUpdateMsg(t)},push_merge_message:function(t){i.handlePushMergeMsg(t)},trans:function(t){i.handleTransRsp(t)},push_trans:function(t){i.handlePushTransMsg(t)}}}return t.prototype.handlePushKickout=function(t){},t.prototype.handlePushCustomMsg=function(t){},t.prototype.handlePushRoomMsg=function(t){},t.prototype.handlePushUserStateUpdateMsg=function(t){},t.prototype.handlePushMergeMsg=function(t){},t.prototype.handlePushTransMsg=function(t){},t.prototype.handleBigImMsgRsp=function(t){},t.prototype.handleTransRsp=function(t){if(this.stateCenter.isLogin())if(0==t.body.err_code){var n=t.body.trans_type;this.stateCenter.transSeqMap[n]?(this.stateCenter.transSeqMap[n].seq=t.body.trans_seq,this.logger.debug("zb.sc.htr trans "+n+" seq "+t.body.trans_seq)):this.logger.error("zb.sc.htr cannot match send info")}else this.logger.error("zb.sc.htr trans send error "+t.body.err_code);else this.logger.error("zb.sc.htr not login")},t.prototype.handleBizChannelRspCallback=function(t,n){0===t.body.err_code?null!=n.success&&n.success(t.header.seq,t.body.cmd,t.body.rsp_body):null!=n.error&&n.error(t.body.err_code,t.header.seq,t.body.rsp_body)},t.prototype.registerRouter=function(t,n){this.responseRouters[t]=n},t.prototype.getSocket=function(t){return null},t.prototype.getHeaderV2=function(t){return{Protocol:"req_v2",cmd:t,appid:this.stateCenter.appid,seq:++this.cmdSeq,user_id:this.stateCenter.userid,session_id:this.stateCenter.sessionid||"",room_id:this.stateCenter.roomid||""}},t.prototype.getHeader=function(t){return{Protocol:"req",cmd:t,appid:this.stateCenter.appid,seq:++this.cmdSeq,user_id:this.stateCenter.userid,session_id:this.stateCenter.sessionid||"",room_id:this.stateCenter.roomid||""}},t.prototype.sendMessage=function(t,n,i,p){if(this.logger.debug("zb.sc.sm call "+t),this.isDisConnect())return this.logger.error("zb.sc.sm error  "+t+" websocket is disconnected"),-1;var v="V1"===l.ROOMVERSION?this.getHeader(t):this.getHeaderV2(t),e={header:v,body:n};if(null==i&&(i=null),null==p&&(p=null),null!=i||null!=p){var T={data:e,seq:v.seq,deleted:!1,time:Date.parse(new Date+""),success:i,error:p},E=this.stateCenter.sendCommandList.push(T);this.stateCenter.sendCommandMap[T.seq]=E}return this.websocket.send(JSON.stringify(e)),this.logger.debug("zb.sc.sm success"),v.seq},t.prototype.sendCustomMessage=function(t,n,i,p){if(this.logger.debug("zb.sc.scm call"),this.isDisConnect())return this.logger.error("zb.sc.scm error"),!1;var v="V1"===l.ROOMVERSION?this.getHeader(t):this.getHeaderV2(t),e={header:v,body:n},T=JSON.stringify(e);null==i&&(i=null),null==p&&(p=null);var E={data:e,seq:v.seq,deleted:!1,time:Date.parse(new Date+""),success:i,error:p},R=this.stateCenter.sendDataList.push(E);return this.stateCenter.sendDataMap[E.seq]=R,this.websocket.send(T),this.logger.debug("zb.sc.scm success seq: ",v.seq),!0},t.prototype.isDisConnect=function(){return!this.websocket||1!==this.websocket.readyState},t.prototype.closeSocket=function(){this.websocket&&(this.logger.info("zb.sc.cs close websocket"),this.websocket.onclose=null,this.websocket.onerror=null,this.websocket.close(),this.websocket=null)},t.prototype.createSocket=function(t){this.websocket=this.getSocket(t)},t.prototype.openHandler=function(t){this.websocket.onopen=t},t.prototype.closeHandler=function(t){this.websocket.onclose=t},t.prototype.errorHandler=function(t){this.websocket.onerror=t},t.prototype.checkResponse=function(t){return(t.header.appid!==this.stateCenter.appid||t.header.session_id!==this.stateCenter.sessionid||t.header.user_id!==this.stateCenter.userid||t.header.room_id!==this.stateCenter.roomid||this.stateCenter.runState!==l.ENUM_RUN_STATE.login)&&(this.logger.error("zb.sc.crp check session fail."),!0)},t.prototype.responseHandler=function(){var t=this;this.websocket.onmessage=function(n){var i=JSON.parse(n.data);t.logger.info("zb.sc.ws.rph jsonmsg= ",i.header.cmd),t.logger.info("zb.sc.ws.rph jsonmsg= ",n.data),0!==i.body.err_code&&i.body.err_message&&t.logger.error("zb.sc.ws.rph cmd="+i.header.cmd+", err_code="+i.body.err_code+", err_message="+i.body.err_message+" "),"login"!==i.header.cmd?"logout"!==i.header.cmd?t.stateCenter.isLogin()?t.checkResponse(i)?t.logger.error("zb.sc.ws.rph check session fail."):(t.handleSendCommandMsgRsp(i),t.logger.info("zb.sc.ws.rph cmd="+i.header.cmd+",function="+!!t.responseRouters[i.header.cmd]),t.responseRouters[i.header.cmd]&&t.responseRouters[i.header.cmd](i)):t.logger.warn("zb.sc.ws.rph  already logout"):t.responseRouters.logout(i,t.cmdSeq):t.responseRouters.login(i,t.cmdSeq)}},t.prototype.handleSendCommandMsgRsp=function(t){this.logger.debug("zb.sc.hscmr call");var n,i=this.stateCenter.sendCommandMap[t.header.seq];null!=i&&(n=i._data,delete this.stateCenter.sendCommandMap[t.header.seq],this.stateCenter.sendCommandList.remove(i),"login"==n.data.header.cmd?this.logger.debug("zb.sc.hscmr don't check "+n.data.header.cmd):"relay"==n.data.header.cmd?this.handleRelayRspCallback(t,n):"bigim_chat"==n.data.header.cmd?this.handleBigImRspCallback(t,n):"biz_channel"==n.data.header.cmd?this.handleBizChannelRspCallback(t,n):0===t.body.err_code?null!=n.success&&n.success(t.header.seq):null!=n.error&&n.error(p.ClientUtil.getServerError(t.body.err_code),t.header.seq)),this.logger.debug("zb.sc.hscmr call success")},t.prototype.handleRelayRspCallback=function(t,n){0===t.body.err_code?null!=n.success&&n.success(t.header.seq,t.body.relay_result):null!=n.error&&n.error(p.ClientUtil.getServerError(t.body.err_code),t.header.seq)},t.prototype.handleBigImRspCallback=function(t,n){0===t.body.err_code?null!=n.success&&this.handleBigImMsgRsp(t):null!=n.error&&n.error(p.ClientUtil.getServerError(t.body.err_code),t.header.seq)},t}();n.SocketCenter=v},function(t,n,i){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var l=i(0),p=i(2),v=function(){function t(t,n,i){this.logger=t,this.socketCenter=i,this.stateCenter=n}return t.prototype.setRunState=function(t){this.logger.debug("zb.rh.srs old="+this.stateCenter.runState+", new="+t),this.stateCenter.lastRunState=this.stateCenter.runState,this.stateCenter.runState=t},t.prototype.resetTryLogin=function(){this.logger.debug("zb.rh.rtl call"),clearTimeout(this.stateCenter.tryLoginTimer),this.stateCenter.tryLoginTimer=null,this.logger.debug("zb.rh.rtl call success")},t.prototype.resetBigRoomInfo=function(){this.stateCenter.transSeqMap={},this.stateCenter.realyMessageList=[],this.stateCenter.relayTimer&&(clearTimeout(this.stateCenter.relayTimer),this.stateCenter.relayTimer=null),this.stateCenter.bigImLastTimeIndex=0,this.stateCenter.bigIMmessageList=[],this.stateCenter.bigImCallbackMap={},this.stateCenter.bigImTimer&&(clearTimeout(this.stateCenter.bigImTimer),this.stateCenter.bigImTimer=null),this.stateCenter.serverTimeOffset=0,this.stateCenter.datiTimeWindow=0,this.stateCenter.bigimTimeWindow=0},t.prototype.resetRoom=function(){var t=this;if(this.logger.debug("zb.rh.rr call"),this.resetTryLogin(),this.resetRoomCallBack(),this.stateCenter.roomTryHandler&&(this.stateCenter.roomTryHandler.invalid(),this.stateCenter.roomTryHandler.stopMaxTime(),this.stateCenter.roomTryHandler=null),this.stateCenter.streamList=[],this.stateCenter.streamQuerying=!1,this.stateCenter.publishStreamList={},this.stateCenter.joinLiveCallbackMap={},this.stateCenter.joinLiveRequestMap={},this.stateCenter.streamUrlMap={},this.resetBigRoomInfo(),this.stateCenter.cmdCallback={},this.logger.debug("zb.rh.rr call send logout=",this.stateCenter.sessionid),"0"!==this.stateCenter.sessionid&&this.stateCenter.runState!==l.ENUM_RUN_STATE.logout){this.socketCenter.registerRouter("logout",function(n){t.handleLogoutRsp(n)}),this.socketCenter.sendMessage("logout",{reserve:0})}this.socketCenter.closeSocket(),this.setRunState(l.ENUM_RUN_STATE.logout),this.stateCenter.userid="",this.stateCenter.sessionid="",this.logger.setSessionInfo(this.stateCenter.appid,this.stateCenter.roomid,this.stateCenter.sessionid,this.stateCenter.idName,this.stateCenter.nickName,l.PROTO_VERSION),this.logger.debug("zb.rh.rr call success")},t.prototype.resetRoomCallBack=function(){},t.prototype.onDisconnect=function(t){},t.prototype.loginSuccessCallBack=function(t,n){},t.prototype.onGetTotalUserList=function(t,n){},t.prototype.login=function(t,n,i,v,e,T,E){if(this.logger.setSessionInfo(this.stateCenter.appid,n,"",this.stateCenter.idName,this.stateCenter.nickName,l.PROTO_VERSION),this.logger.info("zb.rh.lg call:",n,v),e&&(this.stateCenter.third_token=e),!this.stateCenter.configOK||!p.ClientUtil.checkLoginParam(n,v))return this.logger.error("zb.rh.lg param error"),void E({code:"",msg:"param error"});this.logger.debug("zb.rh.lg begin"),this.stateCenter.runState!==l.ENUM_RUN_STATE.trylogin&&this.setRunState(l.ENUM_RUN_STATE.trylogin),this.stateCenter.roomid=n,this.stateCenter.token=v,this.stateCenter.role=i,p.ClientUtil.registerCallback("login",{success:T,error:E},this.stateCenter.callbackList),this.resetTryLogin(),this.tryLogin(t),this.logger.info("zb.rh.lg call success")},t.prototype.loginBodyData=function(){return null},t.prototype.tryLogin=function(t){var n=this;if(this.logger.debug("zb.rh.tl call"),this.stateCenter.runState===l.ENUM_RUN_STATE.trylogin){if(this.stateCenter.startConnceTime=(new Date).getTime(),console.warn("start connect",this.stateCenter.startConnceTime),this.socketCenter.isDisConnect()){this.logger.debug("zb.rh.tl need new websocket");try{this.socketCenter.closeSocket(),this.logger.debug("zb.rh.tl new websocket"),this.socketCenter.createSocket(t),this.socketCenter.registerRouter("login",function(t,i){n.handleLoginRsp(t,i)}),this.socketCenter.closeHandler(function(t){n.socketCenter.closeSocket(),n.closeHandler(t)}),this.socketCenter.openHandler(function(){n.openHandler()}),this.socketCenter.errorHandler(function(t){n.logger.error("zb.rh.tl "+t),n.socketCenter.closeSocket(),n.closeHandler(t)})}catch(t){this.logger.error("zb.rh.tl websocket err:"+t)}}else{var i=this.loginBodyData();this.logger.info("zb.rh.tl use current websocket and sent login"),this.socketCenter.sendMessage("login",i)}this.stateCenter.tryLoginTimer=setTimeout(function(){n.logger.warn("zb.rh.tl over time no response, login timeout"),p.ClientUtil.actionErrorCallback("login",n.stateCenter.callbackList)(l.sdkErrorList.LOGIN_TIMEOUT)},this.stateCenter.tryLoginInterval),this.logger.info("zb.rh.tl call success")}else this.logger.error("zb.rh.tl state error")},t.prototype.handleLoginRsp=function(t,n){if(this.logger.debug("zb.rh.hlr call"),this.stateCenter.runState===l.ENUM_RUN_STATE.trylogin){if(t.header.seq===n)return 0!==t.body.err_code?(this.handleLoginFail(t),void this.logger.error("zb.rh.hlr server error=",t.body.err_code)):(this.handleLoginSuccess(t),void this.logger.info("zb.rh.hlr call success."));this.logger.error("zb.rh.hlr in wrong seq, local=",n,",recv=",t.header.seq)}else this.logger.error("zb.rh.hlr state error")},t.prototype.handleLoginFail=function(t){this.logger.debug("zb.rh.hlf call"),this.resetTryLogin();var n=p.ClientUtil.getServerError(t.body.err_code);p.ClientUtil.actionErrorCallback("login",this.stateCenter.callbackList)(n),this.logger.debug("zb.rh.hlf call success")},t.prototype.handleLoginSuccess=function(t){this.stateCenter.startloginSucTime=(new Date).getTime(),console.warn("login suc",this.stateCenter.startloginSucTime,this.stateCenter.startloginSucTime-this.stateCenter.startloginTime,this.stateCenter.startloginSucTime-this.stateCenter.startConnceTime),this.logger.info("zb.rh.hls call");var n=this.stateCenter.lastRunState;if(this.setRunState(l.ENUM_RUN_STATE.login),this.stateCenter.userid=t.body.user_id,this.stateCenter.sessionid=t.body.session_id,this.stateCenter.anchor_info=t.body.anchor_info||this.stateCenter.anchor_info,this.stateCenter.userListInterval=t.body.userlist_interval||this.stateCenter.userListInterval,this.stateCenter.userListMergeInterval=t.body.userlist_merge_timeout||this.stateCenter.userListMergeInterval,this.logger.setSessionInfo(this.stateCenter.appid,this.stateCenter.roomid,this.stateCenter.sessionid,this.stateCenter.idName,this.stateCenter.nickName,l.PROTO_VERSION),t.body.config_info&&(this.logger.setRemoteLogLevel(t.body.config_info.log_level),""!=t.body.config_info.log_url&&this.logger.openLogServer(t.body.config_info.log_url)),null!=t.body.ret_timestamp&&"string"==typeof t.body.ret_timestamp){var i=parseFloat(t.body.ret_timestamp);this.stateCenter.serverTimeOffset=0==i?0:t.body.ret_timestamp-(new Date).getTime()}t.body.bigim_time_window&&"number"==typeof t.body.bigim_time_window&&(this.stateCenter.bigimTimeWindow=t.body.bigim_time_window),t.body.dati_time_window&&"number"==typeof t.body.dati_time_window&&(this.stateCenter.datiTimeWindow=t.body.dati_time_window),t.body.cluster_env&&1===t.body.cluster_env&&(this.stateCenter.testEnvironment=!0),this.resetTryLogin(),this.loginSuccessCallBack(n,t)},t.prototype.openHandler=function(){this.logger.info("zb.rh.oh websocket.onpen call"),this.socketCenter.responseHandler();var t=this.loginBodyData();this.logger.info("zb.rh.oh websocket.onpen send login"),this.stateCenter.startloginTime=(new Date).getTime(),console.warn("start login",this.stateCenter.startloginTime,this.stateCenter.startloginTime-this.stateCenter.startConnceTime),this.socketCenter.sendMessage("login",t),this.logger.debug("zb.rh.oh websocket.onpen call success")},t.prototype.closeHandler=function(t){this.logger.error("zb.rh.ws.oc room websocket close "+JSON.stringify(t.code)),this.stateCenter.runState!==l.ENUM_RUN_STATE.logout?this.stateCenter.runState===l.ENUM_RUN_STATE.trylogin?(this.resetTryLogin(),p.ClientUtil.actionErrorCallback("login",this.stateCenter.callbackList)(1006==t.code?l.sdkErrorList.LOGIN_TIMEOUT:t)):this.stateCenter.runState===l.ENUM_RUN_STATE.login&&(this.logger.info("zb.rh.ws.oc is called because of network broken"),this.resetTryLogin(),this.onDisconnect(l.sdkErrorList.LOGIN_DISCONNECT)):this.logger.info("zb.rh.ws.oc onclose logout flow call websocket.close")},t.prototype.logout=function(){return this.logger.debug("zb.rh.lo call"),this.resetRoom(),this.logger.info("zb.rh.lo call success"),!0},t.prototype.setUserStateUpdate=function(t){return this.logger.debug("zb.rh.su call"),"boolean"!=typeof t?(this.logger.info("zb.rh.su param error"),!1):(this.stateCenter.userStateUpdate=t,this.logger.info("zb.rh.su call success "+t),!0)},t.prototype.fetchUserList=function(){this.logger.debug("zb.rh.ful call"),this.stateCenter.userQuerying?this.logger.warn("zb.rh.ful is already querying"):(this.stateCenter.userQuerying=!0,this.stateCenter.userTempList=[],"V1"===l.ROOMVERSION?this.fetchUserListWithPage(0):this.fetchUserListWithPageV2(0),this.logger.info("zb.rh.ful the first time call"))},t.prototype.fetchUserListWithPageV2=function(t){var n=this;this.logger.debug("zb.rh.fulwp call"),this.socketCenter.registerRouter("user_list_v2",function(i){n.handleFetchUserListRspV2(t,i)}),this.socketCenter.sendMessage("user_list_v2",{marker:0===t?"":t+"",mode:0,limit:100}),this.logger.info("zb.rh.fulwp call success")},t.prototype.fetchUserListWithPage=function(t){var n=this;this.logger.debug("zb.rh.fulwp call"),this.socketCenter.registerRouter("user_list",function(t){n.handleFetchUserListRsp(t)}),this.socketCenter.sendMessage("user_list",{user_index:t,sort_type:0}),this.logger.info("zb.rh.fulwp call success")},t.prototype.handleFetchUserListRspV2=function(t,n){if(this.logger.debug("zb.rh.hfulr call"),0!=n.body.err_code)return this.stateCenter.userQuerying=!1,this.stateCenter.lastUserQueryTime=Date.now()+this.stateCenter.userListInterval,void this.logger.info("zb.rh.hfulr fetch error "+n.body.err_code);if(this.stateCenter.userStateUpdate){if(this.stateCenter.userTempList=this.stateCenter.userTempList.concat(n.body.user_baseinfos),t!=n.body.marker)return this.logger.warn("zb.rh.hfulr fetch another page"),void this.fetchUserListWithPageV2(t+1);this.stateCenter.userSeq=n.body.server_user_seq,this.logger.info("zb.rh.hfulr set user Seq "+this.stateCenter.userSeq);for(var i=[],l=0;l<this.stateCenter.userTempList.length;l++){var p={idName:this.stateCenter.userTempList[l].id_name,nickName:this.stateCenter.userTempList[l].nick_name,role:this.stateCenter.userTempList[l].role};i.push(p)}this.stateCenter.userQuerying=!1,this.stateCenter.lastUserQueryTime=Date.now()+this.stateCenter.userListInterval,this.onGetTotalUserList(this.stateCenter.roomid,i),this.stateCenter.userTempList=[],this.logger.info("zb.rh.hfulr call success user_list "+i+" count "+i.length)}},t.prototype.handleFetchUserListRsp=function(t){if(this.logger.debug("zb.rh.hfulr call"),0!=t.body.err_code)return this.stateCenter.userQuerying=!1,this.stateCenter.lastUserQueryTime=Date.now()+this.stateCenter.userListInterval,void this.logger.info("zb.rh.hfulr fetch error "+t.body.err_code);if(this.stateCenter.userStateUpdate){this.stateCenter.userTempList=this.stateCenter.userTempList.concat(t.body.user_baseinfos);var n=t.body.ret_user_index;if(n!=t.body.server_user_index)return this.logger.warn("zb.rh.hfulr fetch another page"),void this.fetchUserListWithPage(n+1);this.stateCenter.userSeq=t.body.server_user_seq,this.logger.info("zb.rh.hfulr set user Seq "+this.stateCenter.userSeq);for(var i=[],l=0;l<this.stateCenter.userTempList.length;l++){var p={idName:this.stateCenter.userTempList[l].id_name,nickName:this.stateCenter.userTempList[l].nick_name,role:this.stateCenter.userTempList[l].role};i.push(p)}this.stateCenter.userQuerying=!1,this.stateCenter.lastUserQueryTime=Date.now()+this.stateCenter.userListInterval,this.onGetTotalUserList(this.stateCenter.roomid,i),this.stateCenter.userTempList=[],this.logger.info("zb.rh.hfulr call success user_list "+i+" count "+i.length)}},t.prototype.handleLogoutRsp=function(t){this.logger.debug("zb.rh.hlor result=",t.body.err_code)},t.prototype.handlePushUserStateUpdateMsg=function(t){if(this.logger.info("zb.rh.hpus call"),this.stateCenter.isLogin())if(this.stateCenter.userStateUpdate)if(this.stateCenter.userSeq+t.body.user_actions.length===t.body.user_list_seq){this.stateCenter.userSeq=t.body.user_list_seq,this.logger.debug("zb.rh.hpus push userSeq "+this.stateCenter.userSeq);for(var n=[],i=0;i<t.body.user_actions.length;i++){var l={action:t.body.user_actions[i].Action,idName:t.body.user_actions[i].IdName,nickName:t.body.user_actions[i].NickName,role:t.body.user_actions[i].Role,loginTime:t.body.user_actions[i].LoginTime};n.push(l)}this.onUserStateUpdate(t.body.room_id,n),this.logger.info("zb.rh.hpus call success")}else this.mergeUserByUserSeq(t.body.user_list_seq,t.body.user_actions);else this.logger.info("zb.rh.hpus no userStateUpdate flag");else this.logger.error("zb.rh.hpus not login")},t.prototype.onUserStateUpdate=function(t,n){},t.prototype.mergeUserByUserSeq=function(t,n){var i=this;this.stateCenter.userSeqMergeMap||(this.logger.warn("zb.rh.hpus new merge userlist "+this.stateCenter.userSeq+" server "+t),this.stateCenter.userSeqMergeMap={},this.stateCenter.userSeqMergeTimer&&clearTimeout(this.stateCenter.userSeqMergeTimer),this.stateCenter.userSeqMergeTimer=setTimeout(function(){var t=Object.keys(i.stateCenter.userSeqMergeMap).map(function(t){return+t}).sort(function(t,n){return t-n});if(t[t.length-1]-t[0]+1===t.length)i.mergeUser(t);else{i.stateCenter.userSeqMergeMap=null;var n=i.stateCenter.lastUserQueryTime-Date.now();i.logger.info("zb.rh.hpus fetch merge userlist "+i.stateCenter.userSeq+" userSeqList "+t.join(",")+" wait "+n),n>0?(i.stateCenter.userQueryTimer&&clearTimeout(i.stateCenter.userQueryTimer),i.stateCenter.userQueryTimer=setTimeout(function(){i.fetchUserList()},n)):i.fetchUserList()}},this.stateCenter.userListMergeInterval)),this.logger.warn("zb.rh.hpus merge userlist "+this.stateCenter.userSeq+" server "+t+" userlist "+n.length),this.stateCenter.userSeqMergeMap[t]=n},t.prototype.mergeUser=function(t){var n=this;this.logger.info("zb.rh.hpus merge userlist "+this.stateCenter.userSeq+" userSeqList "+t.join(",")),this.stateCenter.userSeq=t[t.length-1];var i={};t.forEach(function(t){n.stateCenter.userSeqMergeMap[t].forEach(function(t){i[t.IdName]=t})}),this.stateCenter.userSeqMergeMap=null;var l=Object.values(i).map(function(t){return{action:t.Action,idName:t.IdName,nickName:t.NickName,role:t.Role,loginTime:t.LoginTime?String(t.LoginTime):""}});l.sort(function(t,n){return t.loginTime.localeCompare(n.loginTime)}),this.onUserStateUpdate(this.stateCenter.roomid,l)},t}();n.RoomHandler=v},function(t,n,i){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var l=i(0),p=i(2),v=i(24),e=function(){function t(t,n,i,l){this.logger=t,this.socketCenter=i,this.stateCenter=n,this.streamCenter=l}return t.prototype.setCDNInfo=function(t,n){},t.prototype.onStreamUpdated=function(t,n){},t.prototype.onStreamExtraInfoUpdated=function(t){},t.prototype.handleStreamStart=function(t,n){var i=this;if(this.stateCenter.streamQuerying=!1,this.socketCenter.registerRouter("stream",function(t){i.handleStreamUpdateRsp(t)}),this.socketCenter.registerRouter("push_stream_update",function(t){i.handlePushStreamUpdateMsg(t)}),t==l.ENUM_RUN_STATE.login){this.logger.info("zb.sh.hss recover from disconnect so call streamupdate"),this.handleFullUpdateStream(n.body.stream_seq,n.body.stream_info||[]),this.handleReconnectStream(n.body.stream_info);var v=this.makeCallbackStreamList(this.stateCenter.streamList);p.ClientUtil.actionSuccessCallback("login",this.stateCenter.callbackList)(v)}else{this.logger.info("zb.sh.hss success callback user"),this.stateCenter.streamList=n.body.stream_info||[],this.stateCenter.streamSeq=n.body.stream_seq;for(var e=0;e<this.stateCenter.streamList.length;e++)this.stateCenter.streamList[e].anchor_id_name==this.stateCenter.idName&&(this.updateStreamInfo(this.stateCenter.streamList[e].stream_id,l.ENUM_STREAM_SUB_CMD.liveEnd),this.stateCenter.streamList.splice(e--,1));v=this.makeCallbackStreamList(this.stateCenter.streamList);p.ClientUtil.actionSuccessCallback("login",this.stateCenter.callbackList)(v)}},t.prototype.onPublishStateUpdate=function(t,n,i){},t.prototype.updateStreamInfo=function(t,n,i,l){var p=this;void 0===i&&(i=""),this.logger.debug("zb.sh.usi call");var v={stream_id:t,extra_info:i||""},e={sub_cmd:n,stream_msg:JSON.stringify(v)};this.socketCenter.registerRouter("stream",function(t){p.handleStreamUpdateRsp(t)}),this.socketCenter.sendMessage("stream",e,void 0,l),this.logger.info("zb.sh.usi call success cmd "+n)},t.prototype.handleStreamUpdateRsp=function(t){if(this.stateCenter.isLogin())if(0==t.body.err_code){this.logger.info("zb.sh.hsur stream seq "+this.stateCenter.streamSeq+" server seq "+t.body.stream_seq),this.stateCenter.streamSeq=t.body.stream_seq;for(var n=function(n){var p=t.body.stream_info[n].stream_id;if(!i.stateCenter.publishStreamList[p])return i.logger.info("hsur.0 stream is not exist"),{value:void 0};i.stateCenter.publishStreamList[p].state==l.ENUM_PUBLISH_STREAM_STATE.update_info&&(i.stateCenter.publishStreamList[p].state=l.ENUM_PUBLISH_STREAM_STATE.publishing,i.stateCenter.streamList.find(function(t){return t.stream_id==p})||i.stateCenter.streamList.push(t.body.stream_info[n]),i.onPublishStateUpdate(0,p,0))},i=this,p=0;p<t.body.stream_info.length;p++){var v=n(p);if("object"==typeof v)return v.value}}else this.logger.error("zb.sh.hsur stream update error "+t.body.err_code);else this.logger.error("zb.sh.hsur not login")},t.prototype.handleFetchStreamListRsp=function(t){this.logger.info("zb.sh.hfslr call"),this.stateCenter.streamQuerying=!1,0===t.body.err_code?this.stateCenter.streamSeq!==t.body.stream_seq?(this.handleFullUpdateStream(t.body.stream_seq,t.body.stream_info),this.logger.debug("zb.sh.hfslr call success")):this.logger.info("zb.sh.hfslr same seq"):this.logger.info("zb.sh.hfslr server error=",t.body.err_code)},t.prototype.handleFullUpdateStream=function(t,n){var i=this;this.logger.debug("zb.sh.hfus call"),this.stateCenter.streamSeq=t,this.logger.debug("zb.sh.hfus server seq "+this.stateCenter.streamSeq),p.ClientUtil.mergeStreamList(this.logger,this.stateCenter.idName,this.stateCenter.streamList,n,function(t,n,p){0!==t.length&&(i.logger.debug("zb.sh.hfus callback addstream"),i.onStreamUpdated(l.ENUM_STREAM_UPDATE_TYPE.added,i.makeCallbackStreamList(t))),0!==n.length&&(i.logger.debug("zb.sh.hfus callback delstream"),i.onStreamUpdated(l.ENUM_STREAM_UPDATE_TYPE.deleted,i.makeCallbackStreamList(n))),0!==p.length&&(i.logger.debug("zb.sh.hfus callback updatestream"),i.onStreamExtraInfoUpdated(i.makeCallbackStreamList(p)))}),this.logger.info("zb.sh.hfus call success")},t.prototype.handlePushStreamUpdateMsg=function(t){if(this.logger.info("zb.sh.hpsum call"),t.body.stream_info&&0!==t.body.stream_info.length){if(t.body.stream_info.length+this.stateCenter.streamSeq!==t.body.stream_seq)return this.logger.info("zb.sh.hpsum call updatestream"),void this.fetchStreamList();switch(this.stateCenter.streamSeq=t.body.stream_seq,t.body.stream_cmd){case l.ENUM_STREAM_UPDATE_CMD.added:this.handleAddedStreamList(t.body.stream_info);break;case l.ENUM_STREAM_UPDATE_CMD.deleted:this.handleDeletedStreamList(t.body.stream_info);break;case l.ENUM_STREAM_UPDATE_CMD.updated:this.handleUpdatedStreamList(t.body.stream_info)}this.logger.info("zb.sh.hpsum call success")}else this.logger.info("zb.sh.hpsum, emtpy list")},t.prototype.handleAddedStreamList=function(t){this.logger.debug("zb.sh.hasl call");for(var n,i=[],p=0;p<t.length;p++)if(t[p].anchor_id_name!=this.stateCenter.idName){n=!1;for(var v=0;v<this.stateCenter.streamList.length;v++)if(t[p].stream_id===this.stateCenter.streamList[v].stream_id){n=!0;break}n||i.push(t[p])}else this.logger.debug("hdsl.0 have self stream added");if(0!==i.length){this.logger.debug("zb.sh.hasl callback addstream");for(var e=0;e<i.length;e++)this.stateCenter.streamList.push(i[e]);this.onStreamUpdated(l.ENUM_STREAM_UPDATE_TYPE.added,this.makeCallbackStreamList(i))}this.logger.info("zb.sh.hasl call success")},t.prototype.handleDeletedStreamList=function(t){this.logger.debug("zb.sh.hdsl call");for(var n=[],i=0;i<t.length;i++)if(t[i].anchor_id_name!=this.stateCenter.idName){for(var p=this.stateCenter.streamList.length-1;p>=0;p--)if(t[i].stream_id===this.stateCenter.streamList[p].stream_id){this.stateCenter.streamList.splice(p,1),n.push(t[i]);break}}else this.logger.debug("zb.sh.hdsl have self stream deleted");0!==n.length&&(this.logger.debug("zb.sh.hdsl callback delstream"),this.onStreamUpdated(l.ENUM_STREAM_UPDATE_TYPE.deleted,this.makeCallbackStreamList(n))),this.logger.info("zb.sh.hdsl call")},t.prototype.handleUpdatedStreamList=function(t){this.logger.debug("zb.sh.husl call");for(var n=[],i=0;i<t.length;i++)if(t[i].anchor_id_name!=this.stateCenter.idName){for(var l=0;l<this.stateCenter.streamList.length;l++)if(t[i].stream_id===this.stateCenter.streamList[l].stream_id){t[i].extra_info!==this.stateCenter.streamList[l].extra_info&&(this.stateCenter.streamList[l]=t[i],n.push(t[i]));break}}else this.logger.debug("hsul.0 have self stream updated");0!==n.length&&(this.logger.debug("zb.sh.husl callback updatestream"),this.onStreamExtraInfoUpdated(this.makeCallbackStreamList(n))),this.logger.info("zb.sh.husl call success")},t.prototype.fetchStreamList=function(){if(this.logger.info("zb.sh.fsl call"),this.stateCenter.isLogin())if(this.stateCenter.streamQuerying)this.logger.info("zb.sh.fsl already doing");else{this.stateCenter.streamQuerying=!0,this.logger.debug("zb.sh.fsl send fetch request");this.socketCenter.registerRouter("stream_info",this.handleFetchStreamListRsp.bind(this)),this.socketCenter.sendMessage("stream_info",{reserve:0}),this.logger.debug("zb.sh.fsl call success")}else this.logger.info("zb.sh.fsl state error")},t.prototype.handleReconnectStream=function(t){this.logger.info("zb.sh.hrs call");var n=this.streamCenter.publisherList,i=function(i){if(n[i].publisher.state!=l.ENUM_PUBLISH_STATE.publishing||t.find(function(t){return t.stream_id==i})){if(n[i].publisher.state==l.ENUM_PUBLISH_STATE.stop&&t.find(function(t){return t.stream_id==i})){p.updateStreamInfo(i,l.ENUM_STREAM_SUB_CMD.liveEnd);for(var v=0;v<p.stateCenter.streamList.length;v++)if(p.stateCenter.streamList[v].stream_id==i){p.stateCenter.streamList.splice(v--,1);break}}}else p.updateStreamInfo(i,l.ENUM_STREAM_SUB_CMD.liveBegin,p.stateCenter.publishStreamList[i].extra_info)},p=this;for(var v in n)i(v);this.logger.info("zb.sh.hrs end")},t.prototype.makeCallbackStreamList=function(t){var n=[];if(t&&t.length>0)for(var i=0;i<t.length;i++){var l={anchor_id_name:t[i].anchor_id_name,stream_gid:t[i].stream_gid,anchor_nick_name:t[i].anchor_nick_name,extra_info:t[i].extra_info,stream_id:t[i].stream_id,urls_flv:"",urls_rtmp:"",urls_hls:"",urls_https_flv:"",urls_https_hls:""};this.setCDNInfo(l,t[i]),n.push(l)}return n},t.prototype.updateMixStream=function(t,n,i){var v=this;if(this.logger.info("zb.sh.ums call"),null==t.outputStreamId&&null==t.outputUrl)return this.logger.error("zb.sh.ums no mix stream info"),!1;if(0==t.streamList.length)return this.logger.error("zb.sh.ums no input stream"),!1;var e={id_name:this.stateCenter.idName,live_channel:this.stateCenter.roomid,appid:this.stateCenter.appid,version:l.PROTO_VERSION};"string"==typeof t.userData&&t.userData.length<=1e4&&(e.UserData=t.userData);for(var T=[],E=0;E<t.streamList.length;E++){var R=t.streamList[E],S=R.streamId;this.stateCenter.testEnvironment&&(S="zegotest-"+this.stateCenter.appid+"-"+R.streamId),T.push({stream_id:S,rect:{layer:E,top:R.top,left:R.left,bottom:R.bottom,right:R.right}})}e.MixInput=T;var L={};if(null!=t.outputStreamId?this.stateCenter.testEnvironment?L.stream_id="zegotest-"+this.stateCenter.appid+"-"+t.outputStreamId:L.stream_id=t.outputStreamId:null!=t.outputUrl&&(L.mixurl=t.outputUrl),!t.outputBitrate)return this.logger.error("zb.sh.ums no bitrate param"),!1;if(L.bitrate=t.outputBitrate,!t.outputFps)return this.logger.error("zb.sh.ums no fps param"),!1;if(L.fps=t.outputFps,!t.outputWidth)return this.logger.error("zb.sh.ums no width param"),!1;if(L.width=t.outputWidth,!t.outputHeight)return this.logger.error("zb.sh.ums no height param"),!1;if(L.height=t.outputHeight,t.outputAudioConfig&&(L.audio_enc_id=t.outputAudioConfig),t.outputAudioBitrate&&(L.audio_bitrate=t.outputAudioBitrate),t.outputAudioChannels&&(L.audio_channel_cnt=t.outputAudioChannels),t.outputBgColor){if("number"!=typeof t.outputBgColor)return this.logger.error("zb.sh.ums param outputBgColor error"),!1;e.output_bg_color=t.outputBgColor}if(t.outputBgImage){if("string"!=typeof t.outputBgImage||!t.outputBgImage.startsWith("preset-id://"))return this.logger.error("zb.sh.ums param outputBgImage error"),!1;e.output_bg_image=t.outputBgImage}this.stateCenter.testEnvironment?L.testenv=1:L.testenv=0,e.MixOutput=[L],t.extraParams&&(e.extra_params=t.extraParams);var M={channel:"zeus",cmd:"start_mix",req_body:JSON.stringify(e)};return this.logger.debug("zb.sh.ums send command"),this.socketCenter.sendMessage("biz_channel",M,function(e,T,E){v.logger.debug("zb.sh.ums receive message");var R="zegotest-"+v.stateCenter.appid+"-";if(0!=E.length){for(var S=JSON.parse(E),L=[],M=t.outputStreamId,u=0;u<S.play.length;u++){var h={rtmpUrls:null,hlsUrls:null,flvUrls:null};v.stateCenter.testEnvironment&&M&&M.startsWith(R)&&(M=M.slice(R.length)),S.play[u].rtmp_url&&S.play[u].rtmp_url.length>0&&(h.rtmpUrls=[S.play[u].rtmp_url]),S.play[u].hls_url&&S.play[u].hls_url.length>0&&(h.hlsUrls=[S.play[u].hls_url]),S.play[u].hdl_url&&S.play[u].hdl_url.length>0&&(h.flvUrls=[S.play[u].hdl_url]),L.push(h)}n&&n(M,L)}else i&&i(p.ClientUtil.getServerError(l.MIXSTREAM_ERROR_CODE+1))},function(t,n,e){if("number"==typeof t){v.logger.debug("zb.sh.ums error: "+t);var T=[];if(1000000150==t&&0!=e.length)for(var E=JSON.parse(e),R="zegotest-"+v.stateCenter.appid+"-",S=0;S<E.non_exist_streams.length;S++){var L=E.non_exist_streams[S];v.stateCenter.testEnvironment&&L.startsWith(R)?T.push(L.slice(R.length)):T.push(L)}i&&i(p.ClientUtil.getServerError(l.MIXSTREAM_ERROR_CODE+t),T)}else v.logger.debug("zb.sh.ums error code "+t.code),i&&i(t)}),!0},t.prototype.publishTarget=function(t,n,i){var e=this;if(t.type&&-1!=["addpush","delpush","clearpush"].indexOf(t.type))if(this.logger.info("zb.sh.ptcall"),t.streamId&&"string"==typeof t.streamId)if(t.pushUrl&&"string"==typeof t.pushUrl)if(t.appSecret&&"string"==typeof t.appSecret)if(this.stateCenter.publishStreamList[t.streamId]){var T=Math.ceil((new Date).getTime()/1e3),E=t.streamId;this.stateCenter.testEnvironment&&(E="zegotest-"+this.stateCenter.appid+"-"+t.streamId);var R={appid:this.stateCenter.appid,biz_type:0,timestamp:T,signature:v(this.stateCenter.appid.toString()+T.toString()+t.appSecret),seq:this.stateCenter.cdnSeq++,version:1*l.PROTO_VERSION,stream_id:E,pushurl:t.pushUrl},S={channel:"media",cmd:t.type,req_body:JSON.stringify(R)};this.logger.debug("zb.sh.pt send command"),this.socketCenter.sendMessage("biz_channel",S,function(v,T,E){if(e.logger.debug("zb.sh.pt receive message"),0!=E.length){var R=JSON.parse(E),S=R.code,L=R.message;if(S&&0!=S)return e.logger.error("zb.sh.pt "+t.type+" error code: "+S+" "+L),void(i&&i({code:S,message:L}));e.logger.info("zb.sh.pt "+t.type+" success"),n&&n()}else i&&i(p.ClientUtil.getServerError(l.MIXSTREAM_ERROR_CODE+1))},function(t,n,l){e.logger.debug("zb.sh.pt error: "+i);var p="";2001==t?p="invalid channel":2002==t&&(p="bizchannel error"),i&&i({code:t,message:p})})}else this.logger.error("zb.sh.pt publish stream no found");else this.logger.error("zb.sh.pt appSecret error");else this.logger.error("zb.sh.pt pushurl error");else this.logger.error("zb.sh.pt streamid error");else this.logger.error("zb.sh.pt cdn push type error")},t.prototype.stopMixStream=function(t,n,i){if(this.logger.info("zb.sh.sms call"),null==t.outputStreamId&&null==t.outputUrl)return this.logger.error("zb.sh.sms outputStreamId and outputUrl at least one "),!1;var v={id_name:this.stateCenter.idName,live_channel:this.stateCenter.roomid,appid:this.stateCenter.appid,version:l.PROTO_VERSION};null!=t.outputStreamId?this.stateCenter.testEnvironment?v.stream_id="zegotest-"+this.stateCenter.appid+"-"+t.outputStreamId:v.stream_id=t.outputStreamId:null!=t.outputUrl&&(v.mixurl=t.outputUrl);var e={channel:"zeus",cmd:"stop_mix",req_body:JSON.stringify(v)};return this.socketCenter.sendMessage("biz_channel",e,function(t,i){n&&n()},function(t,n){"number"==typeof t?i&&i(p.ClientUtil.getServerError(l.MIXSTREAM_ERROR_CODE+t)):i&&i(t)}),!0},t.prototype.updateStreamExtraInfo=function(t,n){return this.logger.info("zb.sh.usei call"),t?"string"==typeof n&&(this.stateCenter.publishStreamList[t]&&(this.stateCenter.publishStreamList[t].extra_info=n,this.stateCenter.publishStreamList[t].state>=l.ENUM_PUBLISH_STREAM_STATE.update_info&&this.updateStreamInfo(t,l.ENUM_STREAM_SUB_CMD.liveUpdate,n)),!0):(this.logger.error("zb.sh.usei param error"),!1)},t}();n.StreamHandler=e},function(t,n,i){var l;!function(p){"use strict";function v(t,n){var i=(65535&t)+(65535&n);return(t>>16)+(n>>16)+(i>>16)<<16|65535&i}function e(t,n,i,l,p,e){return v(function(t,n){return t<<p|t>>>32-p}(v(v(n,t),v(l,e))),i)}function T(t,n,i,l,p,v,T){return e(n&i|~n&l,t,n,p,v,T)}function E(t,n,i,l,p,v,T){return e(n&l|i&~l,t,n,p,v,T)}function R(t,n,i,l,p,v,T){return e(n^i^l,t,n,p,v,T)}function S(t,n,i,l,p,v,T){return e(i^(n|~l),t,n,p,v,T)}function L(t,n){var i,l,p,e,L;t[n>>5]|=128<<n%32,t[14+(n+64>>>9<<4)]=n;var M=1732584193,u=-271733879,h=-1732584194,f=271733878;for(i=0;i<t.length;i+=16)u=S(u=S(u=S(u=S(u=R(u=R(u=R(u=R(u=E(u=E(u=E(u=E(u=T(u=T(u=T(u=T(p=u,h=T(e=h,f=T(L=f,M=T(l=M,u,h,f,t[i],7,-680876936),u,h,t[i+1],12,-389564586),M,u,t[i+2],17,606105819),f,M,t[i+3],22,-1044525330),h=T(h,f=T(f,M=T(M,u,h,f,t[i+4],7,-176418897),u,h,t[i+5],12,1200080426),M,u,t[i+6],17,-1473231341),f,M,t[i+7],22,-45705983),h=T(h,f=T(f,M=T(M,u,h,f,t[i+8],7,1770035416),u,h,t[i+9],12,-1958414417),M,u,t[i+10],17,-42063),f,M,t[i+11],22,-1990404162),h=T(h,f=T(f,M=T(M,u,h,f,t[i+12],7,1804603682),u,h,t[i+13],12,-40341101),M,u,t[i+14],17,-1502002290),f,M,t[i+15],22,1236535329),h=E(h,f=E(f,M=E(M,u,h,f,t[i+1],5,-165796510),u,h,t[i+6],9,-1069501632),M,u,t[i+11],14,643717713),f,M,t[i],20,-373897302),h=E(h,f=E(f,M=E(M,u,h,f,t[i+5],5,-701558691),u,h,t[i+10],9,38016083),M,u,t[i+15],14,-660478335),f,M,t[i+4],20,-405537848),h=E(h,f=E(f,M=E(M,u,h,f,t[i+9],5,568446438),u,h,t[i+14],9,-1019803690),M,u,t[i+3],14,-187363961),f,M,t[i+8],20,1163531501),h=E(h,f=E(f,M=E(M,u,h,f,t[i+13],5,-1444681467),u,h,t[i+2],9,-51403784),M,u,t[i+7],14,1735328473),f,M,t[i+12],20,-1926607734),h=R(h,f=R(f,M=R(M,u,h,f,t[i+5],4,-378558),u,h,t[i+8],11,-2022574463),M,u,t[i+11],16,1839030562),f,M,t[i+14],23,-35309556),h=R(h,f=R(f,M=R(M,u,h,f,t[i+1],4,-1530992060),u,h,t[i+4],11,1272893353),M,u,t[i+7],16,-155497632),f,M,t[i+10],23,-1094730640),h=R(h,f=R(f,M=R(M,u,h,f,t[i+13],4,681279174),u,h,t[i],11,-358537222),M,u,t[i+3],16,-722521979),f,M,t[i+6],23,76029189),h=R(h,f=R(f,M=R(M,u,h,f,t[i+9],4,-640364487),u,h,t[i+12],11,-421815835),M,u,t[i+15],16,530742520),f,M,t[i+2],23,-995338651),h=S(h,f=S(f,M=S(M,u,h,f,t[i],6,-198630844),u,h,t[i+7],10,1126891415),M,u,t[i+14],15,-1416354905),f,M,t[i+5],21,-57434055),h=S(h,f=S(f,M=S(M,u,h,f,t[i+12],6,1700485571),u,h,t[i+3],10,-1894986606),M,u,t[i+10],15,-1051523),f,M,t[i+1],21,-2054922799),h=S(h,f=S(f,M=S(M,u,h,f,t[i+8],6,1873313359),u,h,t[i+15],10,-30611744),M,u,t[i+6],15,-1560198380),f,M,t[i+13],21,1309151649),h=S(h,f=S(f,M=S(M,u,h,f,t[i+4],6,-145523070),u,h,t[i+11],10,-1120210379),M,u,t[i+2],15,718787259),f,M,t[i+9],21,-343485551),M=v(M,l),u=v(u,p),h=v(h,e),f=v(f,L);return[M,u,h,f]}function M(t){var n,i="",l=32*t.length;for(n=0;n<l;n+=8)i+=String.fromCharCode(t[n>>5]>>>n%32&255);return i}function u(t){var n,i=[];for(i[(t.length>>2)-1]=void 0,n=0;n<i.length;n+=1)i[n]=0;var l=8*t.length;for(n=0;n<l;n+=8)i[n>>5]|=(255&t.charCodeAt(n/8))<<n%32;return i}function h(t){var n,i,l="0123456789abcdef",p="";for(i=0;i<t.length;i+=1)n=t.charCodeAt(i),p+=l.charAt(n>>>4&15)+l.charAt(15&n);return p}function f(t){return unescape(encodeURIComponent(t))}function U(t){return function(t){return M(L(u(t),8*t.length))}(f(t))}function O(t,n){return function(t,n){var i,l,p=u(t),v=[],e=[];for(v[15]=e[15]=void 0,16<p.length&&(p=L(p,8*t.length)),i=0;i<16;i+=1)v[i]=909522486^p[i],e[i]=1549556828^p[i];return l=L(v.concat(u(n)),512+8*n.length),M(L(e.concat(l),640))}(f(t),f(n))}function N(t,n,i){return n?i?O(n,t):function(t,n){return h(O(t,n))}(n,t):i?U(t):function(t){return h(U(t))}(t)}void 0===(l=function(){return N}.call(n,i,n,t))||(t.exports=l)}()},function(t,n,i){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var l=i(0),p=i(2),v=function(){function t(t,n,i){this.logger=t,this.socketCenter=i,this.stateCenter=n}return t.prototype.resetHeartbeat=function(){this.logger.debug("zb.hb.rht call"),this.stateCenter.heartbeatTimer&&clearTimeout(this.stateCenter.heartbeatTimer),this.stateCenter.heartbeatTimer=null,this.stateCenter.tryHeartbeatCount=0,this.logger.debug("zb.hb.rht call success")},t.prototype.hbLogout=function(t){},t.prototype.start=function(t){var n=this;if(this.logger.debug("zb.hb.sht call"),this.stateCenter.isLogin()){if(++this.stateCenter.tryHeartbeatCount>3)return this.logger.error("zb.hb.sht come to try limit"),void this.hbLogout(l.sdkErrorList.HEARTBEAT_TIMEOUT);this.logger.debug("zb.hb.sht send packet");this.socketCenter.registerRouter("hb",function(t){n.handleHeartbeatRsp(t)}),this.socketCenter.sendMessage("hb",{reserve:0}),this.logger.debug("zb.hb.sht call success"),this.stateCenter.heartbeatInterval=t,this.stateCenter.heartbeatTimer=setTimeout(function(){n.start(n.stateCenter.heartbeatInterval)},this.stateCenter.heartbeatInterval)}else this.logger.warn("zb.hb.sht state error")},t.prototype.handleHeartbeatRsp=function(t){if(this.logger.debug("zb.hb.hhbr call"),0!==t.body.err_code)return this.logger.error("zb.hb.hhbr call disconnect, server error=",t.body.err_code),void this.hbLogout(p.ClientUtil.getServerError(t.body.err_code));for(var n in this.stateCenter.tryHeartbeatCount=0,this.stateCenter.heartbeatInterval=t.body.hearbeat_interval,this.stateCenter.heartbeatInterval<l.MINIUM_HEARTBEAT_INTERVAL&&(this.stateCenter.heartbeatInterval=l.MINIUM_HEARTBEAT_INTERVAL),t.body.bigim_time_window&&"number"==typeof t.body.bigim_time_window&&(this.stateCenter.bigimTimeWindow=t.body.bigim_time_window),t.body.dati_time_window&&"number"==typeof t.body.dati_time_window&&(this.stateCenter.datiTimeWindow=t.body.dati_time_window),this.ReliableMessageHandler(t),this.fetchStreamList(t),this.patchUserList(t),this.stateCenter.publishStreamList)this.stateCenter.publishStreamList[n].state==l.ENUM_PUBLISH_STREAM_STATE.update_info&&(this.logger.info("zb.hb.hhbr try to update stream info"),this.updateStreamInfo(n,l.ENUM_STREAM_SUB_CMD.liveBegin,this.stateCenter.publishStreamList[n].extra_info));null!=t.body.online_count&&0!=t.body.online_count&&this.onUpdateOnlineCount(this.stateCenter.roomid,t.body.online_count),this.logger.debug("zb.hb.hhbr call success")},t.prototype.ReliableMessageHandler=function(t){var n=this;if(t.body.trans_seqs)for(var i=0;i<t.body.trans_seqs.length;i++){var l=t.body.trans_seqs[i].trans_channel,p=t.body.trans_seqs[i].trans_seq_array;(p=p.filter(function(t){var i=t.trans_type,l=t.trans_seq;return!n.stateCenter.transSeqMap[i]||n.stateCenter.transSeqMap[i].seq!==l})).length>0&&this.fetchReliableMessage(l,p)}},t.prototype.fetchReliableMessage=function(t,n){var i=this;this.logger.debug("zb.hb.frm call");var l={trans_channel:t,fetch_array:n};this.socketCenter.registerRouter("trans_fetch",function(t){i.handleFetchTransRsp(t)}),this.socketCenter.sendMessage("trans_fetch",l),this.logger.debug("zb.hb.frm call success")},t.prototype.handleFetchTransRsp=function(t){var n=this;this.stateCenter.isLogin()?0==t.body.err_code?t.body.trans_fetch_results.forEach(function(t){var i=t.trans_type,l=t.trans_seq;n.stateCenter.transSeqMap[i]={seq:l},t.trans_user_idname!=n.stateCenter.idName&&t.trans_idname!=n.stateCenter.idName&&n.onRecvReliableMessage(i,l,t.trans_data),n.logger.debug("zb.hb.hftr trans "+i+" seq "+l)}):this.logger.error("zb.hb.hftr trans send error "+t.body.err_code):this.logger.error("zb.hb.hftr not login")},t.prototype.fetchStreamList=function(t){var n=this;t.body.stream_seq!==this.stateCenter.streamSeq&&(this.logger.debug("zb.hb.fsl current seq "+this.stateCenter.streamSeq+" server Seq "+t.body.stream_seq),this.logger.debug("zb.hb.fsl call"),this.stateCenter.isLogin()?this.stateCenter.streamQuerying?this.logger.warn("zb.hb.fsl already doing"):(this.stateCenter.streamQuerying=!0,this.logger.debug("zb.hb.fsl send fetch request"),this.socketCenter.registerRouter("stream_info",function(t){n.handleFetchStreamListRsp(t)}),this.socketCenter.sendMessage("stream_info",{reserve:0}),this.logger.debug("zb.hb.fsl call success")):this.logger.warn("zb.hb.fsl state error"))},t.prototype.patchUserList=function(t){var n=this;if(t.body.server_user_seq!==this.stateCenter.userSeq&&this.stateCenter.userStateUpdate&&!this.stateCenter.userSeqMergeMap){var i=this.stateCenter.lastUserQueryTime-Date.now();this.logger.info("zb.hb.hhbr call update user "+this.stateCenter.userSeq+" server "+t.body.server_user_seq+" wait "+i),i>0?(this.stateCenter.userQueryTimer&&clearTimeout(this.stateCenter.userQueryTimer),this.stateCenter.userQueryTimer=setTimeout(function(){n.fetchUserList()},i)):this.fetchUserList()}},t.prototype.handleFetchStreamListRsp=function(t){},t.prototype.fetchUserList=function(){},t.prototype.updateStreamInfo=function(t,n,i,l){void 0===i&&(i="")},t.prototype.onUpdateOnlineCount=function(t,n){},t.prototype.onRecvReliableMessage=function(t,n,i){},t.prototype.resetCheckMessage=function(){this.logger.debug("zb.hb.rcm call"),clearTimeout(this.stateCenter.sendDataCheckTimer),this.stateCenter.sendDataCheckTimer=null,this.checkSendMessageList(this.stateCenter.sendDataList),this.checkSendMessageList(this.stateCenter.sendCommandList),this.stateCenter.sendDataMap={},this.stateCenter.sendCommandMap={},this.logger.debug("zb.hb.rcm call success")},t.prototype.checkSendMessageList=function(t){for(var n=t.getFirst();null!=n;)t.remove(n),n._data.error&&(n._data.data.body.custom_msg?n._data.error(l.sdkErrorList.SEND_MSG_TIMEOUT,n._data.data.header.seq,n._data.data.body.custom_msg):n._data.error(l.sdkErrorList.SEND_MSG_TIMEOUT,n._data.data.header.seq)),n=t.getFirst()},t.prototype.checkMessageListTimeout=function(t,n){for(var i=t.getFirst(),p=Date.parse(new Date+""),v=0,e=0,T=0;!(null==i||i._data.time+this.stateCenter.sendDataTimeout>p||(delete n[i._data.data.header.seq],t.remove(i),++e,null==i._data.error||this.stateCenter.sendDataDropTimeout>0&&i._data.time+this.stateCenter.sendDataDropTimeout<p?++T:i._data.data.body.custom_msg?i._data.error(l.sdkErrorList.SEND_MSG_TIMEOUT,i._data.data.header.seq,i._data.data.body.custom_msg):i._data.error(l.sdkErrorList.SEND_MSG_TIMEOUT,i._data.data.header.seq),++v>=this.stateCenter.sendDataCheckOnceCount));)i=t.getFirst();0==e&&0==T||this.logger.debug("zb.hb.cmt call success, stat: timeout=",e,"drop=",T)},t.prototype.startCheckMessageTimeout=function(){var t=this;this.stateCenter.isLogin()?(this.checkMessageListTimeout(this.stateCenter.sendDataList,this.stateCenter.sendDataMap),this.checkMessageListTimeout(this.stateCenter.sendCommandList,this.stateCenter.sendCommandMap),this.stateCenter.sendDataCheckTimer=setTimeout(function(){t.startCheckMessageTimeout()},this.stateCenter.sendDataCheckInterval)):this.logger.warn("zb.hb.scmt state error")},t}();n.HeartBeatHandler=v},function(t,n,i){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var l=i(0),p=i(2),v=function(){function t(t,n,i){this.logger=t,this.socketCenter=i,this.stateCenter=n}return t.prototype.sendCustomCommand=function(t,n,i,l){var v=this;if(this.logger.debug("zb.mh.scc call"),!this.stateCenter.isLogin())return this.logger.error("zb.mh.scc state error"),!1;if(!t)return this.logger.error("zb.mh.scc dstMembers error"),!1;var e={from_userid:this.stateCenter.idName,from_username:this.stateCenter.nickName,request_id:this.stateCenter.getRequestId(),custom_content:n||"",room_id:this.stateCenter.roomid},T={dest_id_name:t,custom_msg:JSON.stringify(e)};return p.ClientUtil.checkCustomCommandParam(T)?(this.socketCenter.registerRouter("custommsg",function(t){v.handleSendCustomMsgRsp(t)}),this.socketCenter.sendCustomMessage("custommsg",T,i,l),this.logger.info("zb.mh.scc call success"),!0):(this.logger.info("zb.mh.scc param error"),!1)},t.prototype.handleSendCustomMsgRsp=function(t){this.logger.debug("zb.mh.hscmrcall");var n,i=this.stateCenter.sendDataMap[t.header.seq];null!=i?("custommsg"!=(n=i._data).data.header.cmd?this.logger.error("zb.mh.hscmrcmd wrong"+n.data.header.cmd):0===t.body.err_code?null!=n.success&&n.success(t.header.seq,n.data.body.custom_msg):null!=n.error&&n.error(p.ClientUtil.getServerError(t.body.err_code),t.header.seq,n.data.body.custom_msg),delete this.stateCenter.sendDataMap[t.header.seq],this.stateCenter.sendDataList.remove(i)):this.logger.error("zb.mh.hscmrno found seq="+t.header.seq),this.logger.debug("zb.mh.hscmr  call success")},t.prototype.handlePushCustomMsg=function(t){var n=JSON.parse(t.body.custommsg);this.logger.debug("zb.mh.hpcm submsg=",n),this.onRecvCustomCommand(n.from_userid,n.from_username,n.custom_content)},t.prototype.onRecvCustomCommand=function(t,n,i){},t.prototype.sendRoomMsg=function(t,n,i,p,v){var e=this;if(this.logger.debug("zb.mh.srm call"),this.stateCenter.isLogin()){var T=Date.parse(new Date+"");if(this.stateCenter.sendRoomMsgTime>0&&this.stateCenter.sendRoomMsgTime+this.stateCenter.SendRoomMsgInterval>T)return this.logger.info("zb.mh.srm freq error"),void(v&&v(l.sdkErrorList.FREQ_LIMITED,0,t,n,i));this.stateCenter.sendRoomMsgTime=T,this.logger.debug("zb.mh.srm send fetch request");var E={msg_category:t,msg_type:n,msg_content:i};this.socketCenter.registerRouter("im_chat",function(t){e.handleSendRoomMsgRsp(t)}),this.socketCenter.sendCustomMessage("im_chat",E,p,v),this.logger.info("zb.mh.srm call success")}else this.logger.error("zb.mh.srm state error")},t.prototype.handleSendRoomMsgRsp=function(t){this.logger.debug("zb.mh.hsrmr call");var n,i=this.stateCenter.sendDataMap[t.header.seq];null!=i?("im_chat"!=(n=i._data).data.header.cmd?this.logger.error("zb.mh.hsrmr cmd wrong"+n.data.header.cmd):0===t.body.err_code?n.success&&n.success(t.header.seq,t.body.msg_id,n.data.body.msg_category,n.data.body.msg_type,n.data.body.msg_content):n.error&&n.error(p.ClientUtil.getServerError(t.body.err_code),t.header.seq,n.data.body.msg_category,n.data.body.msg_type,n.data.body.msg_content),delete this.stateCenter.sendDataMap[t.header.seq],this.stateCenter.sendDataList.remove(i)):this.logger.error("hzb.mh.hsrmr no found seq="+t.header.seq),this.logger.info("zb.mh.hsrmr call success")},t.prototype.onRecvRoomMsg=function(t,n,i){},t.prototype.sendReliableMessage=function(t,n,i,l){this.logger.debug("zb.mh.srirm call"),this.stateCenter.transSeqMap[t]||(this.stateCenter.transSeqMap[t]={seq:0});var p={trans_type:t,trans_data:n,trans_local_seq:this.stateCenter.transSeqMap[t].seq,trans_channel:"clt"};this.socketCenter.sendMessage("trans",p,i,l)},t.prototype.sendBigRoomMessage=function(t,n,i,l,p){var v=this;this.logger.debug("zb.mh.sbim call");var e=this.stateCenter.bigimTimeWindow,T=this.stateCenter.serverTimeOffset,E=(new Date).getTime()+T,R=(++this.stateCenter.cmdSeq).toString();if(null==l&&(l=null),null==p&&(p=null),this.stateCenter.bigImCallbackMap[R]={success:l,error:p},0==e){var S={msg_category:t,msg_type:n,msg_content:i,bigmsg_client_id:R};this.logger.debug("zb.mh.sbim no time window"),this.sendBigRoomMessageInternal([S],function(t){v.handleBigImMsgRsp(t)},p)}else{var L=Math.floor(E/e);if(this.logger.debug("currentIndex "+L+" lastTimeIndex "+this.stateCenter.bigImLastTimeIndex),this.stateCenter.bigImLastTimeIndex<L&&0==this.stateCenter.bigImMessageList.length){this.stateCenter.bigImLastTimeIndex=L;var M={msg_category:t,msg_type:n,msg_content:i,bigmsg_client_id:R};this.sendBigRoomMessageInternal([M],function(t){v.handleBigImMsgRsp(t)},p)}else this.stateCenter.bigImMessageList.push({msg_category:t,msg_type:n,msg_content:i,bigmsg_client_id:R}),1==this.stateCenter.bigImMessageList.length&&this.setBigImTimer(T,e)}},t.prototype.handlePushMergeMsg=function(t){if(this.stateCenter.isLogin()){for(var n=0;n<t.body.messages.length;n++)14001===t.body.messages[n].sub_cmd&&this.handlePushBigRooMsg(t.body.messages[n].msg_body);this.logger.debug("zb.mh.hpmm call success")}else this.logger.error("zb.mh.hpmmnot login")},t.prototype.handlePushBigRooMsg=function(t){var n;try{n=JSON.parse(t)}catch(t){return void this.logger.warn("zb.mh.hpbrm parse json error")}if(n){for(var i=n.room_id,l=[],p=0;p<n.msg_data.length;p++){var v=n.msg_data[p];v.id_name!=this.stateCenter.idName?l.push({idName:v.id_name,nickName:v.nick_name,messageId:v.bigmsg_id,category:v.msg_category,type:v.msg_type,content:v.msg_content,time:v.send_time}):this.logger.debug("zb.mh.hpbrm self message")}0==l.length?this.logger.debug("zb.mh.hpbrm no other pushData except self"):this.onRecvBigRoomMessage(l,i),this.logger.debug("zb.mh.hpbrm call success")}else this.logger.warn("zb.mh.hpbrm cann't find message body")},t.prototype.onRecvBigRoomMessage=function(t,n){},t.prototype.sendBigRoomMessageInternal=function(t,n,i){this.logger.debug("zb.mh.sbim call");var l={msgs:t};this.socketCenter.sendMessage("bigim_chat",l,n,i)},t.prototype.handleBigImMsgRsp=function(t){if(this.stateCenter.isLogin()){this.stateCenter.bigimTimeWindow!=t.body.bigim_time_window&&(this.stateCenter.bigimTimeWindow=t.body.bigim_time_window);for(var n=0;n<t.body.msgs.length;n++){var i=t.body.msgs[n].bigmsg_client_id,l=t.body.msgs[n].bigmsg_id;if(this.stateCenter.bigImCallbackMap[i]){var p=this.stateCenter.bigImCallbackMap[i].success;null!=p&&p(t.header.seq,l),delete this.stateCenter.bigImCallbackMap[i]}}}else this.logger.info("zb.mh.hbmr not login")},t.prototype.setBigImTimer=function(t,n){var i=this,l=n-((new Date).getTime()+t)%n,v=p.ClientUtil.generateRandumNumber(n)+l;this.logger.info("zb.mh.sbt setTimer "+v),this.stateCenter.bigImTimer=setTimeout(function(){i.onBigImTimer()},v)},t.prototype.onBigImTimer=function(){var t=this,n=(new Date).getTime()+this.stateCenter.serverTimeOffset;this.stateCenter.bigImLastTimeIndex=Math.floor(n/this.stateCenter.bigimTimeWindow);for(var i=[],l=[],p=0;p<this.stateCenter.bigImMessageList.length&&!(p>=20);p++){var v=this.stateCenter.bigImMessageList[p];i.push({msg_category:v.msg_category,msg_type:v.msg_type,msg_content:v.msg_content,bigmsg_client_id:v.bigmsg_client_id}),l.push(v.bigmsg_client_id)}this.stateCenter.bigImMessageList.length>20?this.stateCenter.bigImMessageList.splice(0,20):this.stateCenter.bigImMessageList=[],this.sendBigRoomMessageInternal(i,function(n){t.handleBigImMsgRsp(n)},function(n,i){for(var p=0;p<l.length;p++){var v=l[p],e=t.stateCenter.bigImCallbackMap[v];e&&(null!=e.error&&e.error(n,i),delete t.stateCenter.bigImCallbackMap[v])}}),clearTimeout(this.stateCenter.bigImTimer),this.stateCenter.bigImTimer=null,this.stateCenter.bigImMessageList.length>0&&this.setBigImTimer(this.stateCenter.serverTimeOffset,this.stateCenter.bigimTimeWindow)},t.prototype.sendRelayMessage=function(t,n,i,l){this.logger.debug("zb.mh.srm call");var p=this.stateCenter.datiTimeWindow,v=this.stateCenter.serverTimeOffset;p>0?(this.stateCenter.realyMessageList.push({type:t,data:n,success:i,error:l}),1==this.stateCenter.realyMessageList.length&&this.setRelayTimer(v,p)):this.sendRelayMessageInternal(t,n,i,l)},t.prototype.sendRelayMessageInternal=function(t,n,i,l){this.logger.debug("zb.mh.srmi call");var p={relay_type:t,relay_data:n};this.socketCenter.sendMessage("relay",p,i,l)},t.prototype.setRelayTimer=function(t,n){var i=this,l=2*n-((new Date).getTime()+t)%n,v=p.ClientUtil.generateRandumNumber(l);this.logger.info("zb.mh.srt setTimer "+v),this.stateCenter.relayTimer=setTimeout(function(){i.onRelayTimer()},v)},t.prototype.onRelayTimer=function(){if(0!=this.stateCenter.realyMessageList.length){var t=this.stateCenter.realyMessageList[0];this.sendRelayMessageInternal(t.type,t.data,t.success,t.error),clearTimeout(this.stateCenter.relayTimer),this.stateCenter.relayTimer=null,this.stateCenter.realyMessageList.splice(0,1),this.stateCenter.realyMessageList.length>0&&this.setRelayTimer(this.stateCenter.serverTimeOffset,this.stateCenter.datiTimeWindow)}else this.logger.info("zb.mh.ort no relay data")},t.prototype.handlePushTransMsg=function(t){if(this.stateCenter.isLogin()){var n=t.body.trans_type,i=t.body.trans_seq;this.stateCenter.transSeqMap[n]?this.stateCenter.transSeqMap[n].seq=i:this.stateCenter.transSeqMap[n]={seq:i},t.body.trans_user_idname!=this.stateCenter.idName&&t.body.trans_idname!=this.stateCenter.idName?this.onRecvReliableMessage(n,i,t.body.trans_data):this.logger.debug("zb.mh.hptr receive self trans message"),this.logger.info("zb.mh.hptr trans "+n+" seq "+i)}else this.logger.error("zb.mh.hptr not login")},t.prototype.onRecvReliableMessage=function(t,n,i){},t}();n.MessageHandler=v},function(t,n,i){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var l=i(0),p=function(){function t(t,n,i){this.logger=t,this.socketCenter=i,this.stateCenter=n}return t.prototype.requestJoinLive=function(t,n,i,p){this.logger.debug("zb.lh.rjl call");var v=this.stateCenter.getRequestId(),e=this.stateCenter.getSignalCmdContent(v,t);return null!=p&&(this.stateCenter.joinLiveCallbackMap[v]=p,this.sendSignalCmd(l.ENUM_SIGNAL_SUB_CMD.joinLiveRequest,e,t,n,i),!0)},t.prototype.inviteJoinLive=function(t,n,i,p){this.logger.debug("zb.lh.ijl call");var v=this.stateCenter.getRequestId(),e=this.stateCenter.getSignalCmdContent(v,t);return null!=p&&(this.stateCenter.joinLiveCallbackMap[v]=p,this.sendSignalCmd(l.ENUM_SIGNAL_SUB_CMD.joinLiveInvite,e,t,n,i),!0)},t.prototype.endJoinLive=function(t,n,i){this.logger.debug("zb.lh.ejl call");var p=this.stateCenter.getRequestId(),v=this.stateCenter.getSignalCmdContent(p,t);return this.sendSignalCmd(l.ENUM_SIGNAL_SUB_CMD.joinLiveStop,v,t,n,i),!0},t.prototype.respondJoinLive=function(t,n,i,p){this.logger.debug("zb.lh.rpjl call");var v=this.stateCenter.joinLiveRequestMap[t];if(!v)return this.logger.info("zb.lh.rpjl no dest id name"),!1;var e=0;!0===n&&(e=1);var T=this.stateCenter.getSignalCmdContent(t,v,e);return this.sendSignalCmd(l.ENUM_SIGNAL_SUB_CMD.joinLiveResult,T,v,i,p),delete this.stateCenter.joinLiveRequestMap[t],!0},t.prototype.sendSignalCmd=function(t,n,i,l,p){if(this.logger.debug("zb.lh.ssc call"),this.stateCenter.isLogin()){this.logger.debug("zb.lh.ssc send signal cmd "+t);var v={sub_cmd:t,signal_msg:n,dest_id_name:[i]};this.socketCenter.sendMessage("signal",v,l,p),this.logger.info("zb.lh.ssc call success")}else this.logger.error("zb.lh.ssc state error")},t.prototype.handlePushSignalMsg=function(t){if(this.stateCenter.isLogin()){var n=JSON.parse(t.body.signal_msg);switch(this.logger.debug("zb.lh.hpcm hpsm= ",n),t.body.sub_cmd){case l.ENUM_PUSH_SIGNAL_SUB_CMD.pushJoinLiveRequest:this.handlePushJoinLiveRequestMsg(n);break;case l.ENUM_PUSH_SIGNAL_SUB_CMD.pushJoinLiveResult:this.handlePushJoinLiveResultMsg(n);break;case l.ENUM_PUSH_SIGNAL_SUB_CMD.pushJoinLiveInvite:this.handlePushJoinLiveInviteMsg(n);break;case l.ENUM_PUSH_SIGNAL_SUB_CMD.pushJoinLiveStop:this.handlePushJoinLiveStopMsg(n)}this.logger.debug("zb.lh.hpsm call end")}else this.logger.warn("zb.lh.hpsm not login")},t.prototype.handlePushJoinLiveRequestMsg=function(t){var n=t.request_id;if("string"==typeof n){var i=t.from_userid;"string"==typeof i?(this.stateCenter.joinLiveRequestMap[n]=i,this.logger.info("zb.lh.hpjlrm onRecvJoinLiveRequest "+i),this.onRecvJoinLiveRequest(n,t.from_userid,t.from_username,t.room_id)):this.logger.error("zb.lh.hpjlrm no from user")}else this.logger.error("zb.lh.hpjlrm no requestId")},t.prototype.onRecvJoinLiveRequest=function(t,n,i,l){},t.prototype.handlePushJoinLiveInviteMsg=function(t){var n=t.request_id;if("string"==typeof n){var i=t.from_userid;"string"==typeof i?(this.stateCenter.joinLiveRequestMap[n]=i,this.logger.info("zb.lh.hpjlim onRecvInviteJoinLiveRequest "+i),this.onRecvInviteJoinLiveRequest(n,t.from_userid,t.from_username,t.room_id)):this.logger.error("zb.lh.hpjlim no from user")}else this.logger.error("zb.lh.hpjlim no requestId")},t.prototype.onRecvInviteJoinLiveRequest=function(t,n,i,l){},t.prototype.handlePushJoinLiveResultMsg=function(t){var n=t.request_id;if("string"==typeof n){var i=t.result;if(null!=i){var l=1==i;if(this.stateCenter.joinLiveCallbackMap[n]){var p=this.stateCenter.joinLiveCallbackMap[n];if(!p)return void this.logger.info("hpjlrm.o no callback");this.logger.info("zb.lh.hpjlrm joinLiveRequest/invite result "+l),delete this.stateCenter.joinLiveCallbackMap[n],p(l,t.from_userid,t.from_username)}}else this.logger.info("zb.lh.hpjlrm no result")}else this.logger.error("zb.lh.hpjlrm no requestId")},t.prototype.handlePushJoinLiveStopMsg=function(t){var n=t.request_id;"string"==typeof n?(this.logger.info("zb.lh.hpjlsm onRecvEndJoinLiveCommand "+t.from_userid),this.onRecvEndJoinLiveCommand(n,t.from_userid,t.from_username,t.room_id)):this.logger.error("zb.lh.hpjlsm no requestId")},t.prototype.onRecvEndJoinLiveCommand=function(t,n,i,l){},t}();n.LiveHandler=p},function(t,n,i){"use strict";var l,p=this&&this.__extends||(l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var i in n)n.hasOwnProperty(i)&&(t[i]=n[i])},function(t,n){function i(){this.constructor=t}l(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)});Object.defineProperty(n,"__esModule",{value:!0});var v=i(5),e=i(0),T=function(t){function n(n,i){var l=t.call(this,n,i)||this;return l.logger=n,l.stateCenter=i,l}return p(n,t),n.prototype.initRoom=function(t,n,i,l,p,v,e){this.roomHandler=t,this.server=n,this.serverBak=i||n,this.roomID=l,this.role=p,this.token=v,this.authToken=e},n.prototype.active=function(t){var n=this;if(this.logger.info("zc.rrh.a retry call"),this.stateCenter.networkState!=e.ENUM_NETWORK_STATE.offline)if(this.retryTimer)this.logger.info("zc.rrh.a has actived, ignore");else if(this.isOverTime)this.logger.info("zc.rrh.a retry over time, stop retry");else{if(1==this.retryActiveCount)this.retryActiveInterval=Math.floor(Math.random()*(1-this.RETRY_START_TIME_INTERVAL)+this.RETRY_START_TIME_INTERVAL);else{var i=Math.pow(2,Math.round(this.retryActiveCount/this.RETRY_CONTINUE_COUNT+1));this.retryActiveInterval=i>this.RETRY_MAX_TIME_INTERVAL?this.RETRY_MAX_TIME_INTERVAL:i}this.retryTimer=setTimeout(function(){n.roomHandler.login(n.retryActiveCount%2==1?n.server:n.serverBak,n.roomID,n.role,n.token,n.authToken,function(t){n.handleLoginFinish(t)},function(t){n.handleLoginFinish(null,t)}),n.retryTimer&&clearTimeout(n.retryTimer),n.retryTimer=null,n.retryActiveCount++},t?0:1e3*this.retryActiveInterval)}else this.logger.info("zc.rrh.a network is broken, stop retry")},n.prototype.startMaxTime=function(){var t=this;this.maxTimer||(this.maxTimer=setTimeout(function(){console.warn("over max time "+t.RETRY_MAX_TIME+"s, stop retry"),t.isOverTime=!0,t.roomHandler.resetRoom(),t.stopMaxTime(),t.invalid(),t.onactive(null,e.sdkErrorList.LOGIN_TIMEOUT)},1e3*this.RETRY_MAX_TIME))},n.prototype.stopMaxTime=function(){this.maxTimer&&clearTimeout(this.maxTimer),this.maxTimer=null},n.prototype.onactive=function(t,n){},n.prototype.handleError=function(t){if(this.RETRY_MAX_TIME<3)return!1;if("ZegoClient.Error.Server"==t.code){var n=t.msg.match(/code:(\d+)/)[1];return!["1000002002","1000005030","1000005035","1010","1011","1013","1014","1015","1016","1017","1018","1019","1020","1021","1023"].includes(n)&&(!!["1100040001","1100040100"].includes(n)||this.stateCenter.lastRunState==e.ENUM_RUN_STATE.login&&(this.stateCenter.sessionid="",this.invalid(),!0))}return!0},n.prototype.handleLoginFinish=function(t,n){n?this.handleError(n)?(!this.maxTimer&&this.startMaxTime(),this.active()):(this.roomHandler.resetRoom(),this.stopMaxTime(),this.invalid(),this.onactive(null,n)):(this.stopMaxTime(),this.invalid(),this.onactive(t))},n}(v.TryHandler);n.RetryRoomHandler=T},function(t,n,i){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var l=i(0),p=i(1),v=function(){function t(){this.testEnvironment=!1,this.third_token="",this.pullLimited=!0,this.configOK=!1,this.roomCreateFlag=1,this.runState=l.ENUM_RUN_STATE.logout,this.lastRunState=l.ENUM_RUN_STATE.logout,this.callbackList={},this.streamList=[],this.publishStreamList={},this.userQuerying=!1,this.userTempList=[],this.userSeq=0,this.userSeqMergeMap=null,this.userSeqMergeTimer=null,this.userQueryTimer=null,this.lastUserQueryTime=0,this.userListInterval=3e4,this.userListMergeInterval=5e3,this.anchor_info={anchor_id:"",anchor_id_name:"",anchor_nick_name:""},this.deviceInfos=null,this.deviceChangeTimer=null,this.deviceStateOut=!1,this.sendCommandMap={},this.sendCommandList=new l.LinkedList,this.sendDataMap={},this.sendDataList=new l.LinkedList,this.joinLiveCallbackMap={},this.joinLiveRequestMap={},this.streamUrlMap={},this.cmdCallback={},this.transSeqMap={},this.realyMessageList=[],this.relayTimer=null,this.bigImLastTimeIndex=0,this.bigIMmessageList=[],this.bigImCallbackMap={},this.bigImTimer=null,this.serverTimeOffset=0,this.datiTimeWindow=0,this.bigimTimeWindow=0,this.bigImMessageList=[],this.screenShotStreamList=[],this.tryLoginTimer=null,this.tryLoginInterval=1e4,this.roomRetryTime=300,this.streamRetryTime=300,this.heartbeatTimer=null,this.sendDataCheckTimer=null,this.sendDataCheckInterval=2e3,this.sendDataTimeout=5e3,this.sendDataDropTimeout=1e4,this.sendDataCheckOnceCount=100,this.sendRoomMsgTime=0,this.SendRoomMsgInterval=500,this.cmdSeq=0,this.audioEffectBuffer={},this.audioBitRate=48e3,this.cdnSeq=0}return t.prototype.isLogin=function(){return this.runState===l.ENUM_RUN_STATE.login},t.prototype.getRequestId=function(){return this.idName+"-"+p.getSeq()},t.prototype.getSignalCmdContent=function(t,n,i){var l={request_id:t,room_id:this.roomid,from_userid:this.idName,from_username:this.nickName,to_userid:n};return null!=i&&(l.result=i),JSON.stringify(l)},t}();n.StateCenter=v},function(t,n,i){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var l=i(2),p=function(){function t(t){var n=t.type,i=t.channels,l=void 0===i?1:i,p=t.bufferSize,v=void 0===p?0:p,e=t.sampleBit,T=void 0===e?16:e,E=t.sampleRate,R=void 0===E?44100:E,S=this;this.instant=0,this.slow=0,this.clip=0;var L=new("undefined"!=typeof webkitAudioContext?webkitAudioContext:AudioContext);this.context=L,this.type=n,this.channels=l,this.bufferSize=v,this.sampleBit=T,this.sampleRate=R,this.script=L.createScriptProcessor(v,l,l);(new Date).getTime();this.script.addEventListener("audioprocess",function(t){var i,l=t.inputBuffer.getChannelData(0),p=0,v=0;for(i=0;i<l.length;++i)p+=l[i]*l[i],Math.abs(l[i])>.99&&(v+=1);if(S.instant=Math.sqrt(p/l.length),S.slow=.95*S.slow+.05*S.instant,S.clip=v/l.length,"pcm"===n||"wav"===n){for(var e=[],T=0;T<S.channels;T++)e.push(t.inputBuffer.getChannelData(T));S.recorderBuffer(e)}}),"pcm"!==n&&"wav"!==n||this.initRecorderBuffer(n)}return t.prototype.connectToSource=function(t,n){console.log("SoundMeter connecting");try{this.mic=this.context.createMediaStreamSource(t),this.mic.connect(this.script),this.script.connect(this.context.destination),void 0!==n&&n(null)}catch(t){console.error(t),void 0!==n&&n(t)}return this},t.prototype.recorderBuffer=function(t){this.worker.postMessage({command:"record",val:t})},t.prototype.initRecorderBuffer=function(t){var n=this;this.worker=l.ClientUtil.inlineWorker(function(){var t,n,i,l,p,v,e=[],T=this;function E(n){var i,l;if(1==t)i=S(e[0],p,e),1!=n&&(l=R(n,i));else if(2==t){var v=S(e[0],p,e),T=S(e[1],p,e);1!=n?l=L(R(n,v),R(n,T)):i=L(v,T)}return 1!=n?l:i}function R(t,n){for(var i=new Float32Array(n.length/t),l=0,p=0;l<i.length;)i[l]=n[p],p+=t,l++;return i}function S(t,n,i){for(var l=new Float32Array(n*t.length),p=0,v=0;v<i[0].length;v++)l.set(i[0][v],p),p+=i[0][v].length;return l}function L(t,n){for(var i=new Float32Array(t.length+n.length),l=0;l<t.length+n.length;l+=2)i[l]=t[l/2>>0],i[l+1]=n[l/2>>0];return i}function M(t,n,i){for(var l=0;l<i.length;l++)t.setUint8(n+l,i.charCodeAt(l))}function u(t,n,i){for(var l=0;l<i.length;l++,n+=2){var p=Math.max(-1,Math.min(1,i[l]));t.setInt16(n,p<0?32768*p:32767*p,!0)}}function h(t,n,i){for(var l=0;l<i.length;l++,n++){var p=Math.max(-1,Math.min(1,i[l])),v=p<0?128*p:127*p;v+=128,t.setInt8(n,v)}}this.onmessage=function(R){switch(R.data.command){case"init":S=R.data.val,t=S.sampleChannel,n=S.sampleBit,i=S.sampleRate,l=S.oldSampleRate,p=S.bufferSize,v=S.type;break;case"record":!function(p){for(var R=0;R<t;R++)e[R]||(e[R]=[]),e[R].push(p[R]);var S=Math.round(l/i);"pcm"===v?function(t){var i=function(t,i){var l;8==i?l=t.length:16==i&&(l=t.length,l*=2);var p=new ArrayBuffer(l),v=new DataView(p);8==i?h(v,0,t):16==n&&u(v,0,t);return v}(E(t),n);T.postMessage({command:"exportPcmLive",val:i})}(S):"wav"===v&&function(l){var p=function(l,p){var v;8==p?v=l.length:16==n&&(v=l.length,v*=2);var e=new ArrayBuffer(v+44),T=new DataView(e),E=i,R=n,S=t;M(T,0,"RIFF"),T.setUint32(4,36+v,!0),M(T,8,"WAVE"),M(T,12,"fmt "),T.setUint32(16,16,!0),T.setUint16(20,1,!0),T.setUint16(22,S,!0),T.setUint32(24,E,!0),T.setUint32(28,E*S*(R/8),!0),T.setUint16(32,S*(R/8),!0),T.setUint16(34,R,!0),M(T,36,"data"),T.setUint32(40,v,!0),8==n?h(T,44,l):16==n&&u(T,44,l);return T}(E(l),n);T.postMessage({command:"exportWav",val:p})}(S);e=[]}(R.data.val)}var S}}),this.worker.postMessage({command:"init",val:{sampleChannel:this.channels,sampleBit:this.sampleBit,sampleRate:this.sampleRate,oldSampleRate:this.context.sampleRate,bufferSize:this.bufferSize,type:t}}),this.worker.onmessage=function(t){switch(t.data.command){case"exportPcmLive":n.onReceiveBuffer(t.data.val);break;case"exportWav":n.onReceiveWav(t.data.val)}}},t.prototype.onReceiveBuffer=function(t){},t.prototype.onReceiveWav=function(t){},t.prototype.writeString=function(t,n,i){for(var l=0;l<i.length;l++)t.setUint8(n+l,i.charCodeAt(l))},t.prototype.writeBuffer=function(t,n,i){for(var l=0;l<i.byteLength;l++)t.setUint8(n+l,i[l])},t.prototype.concatenation=function(t){for(var n=0,i=0;i<t.length;++i)n+=t[i].buffer.byteLength;var l=new Uint8Array(n),p=0;for(i=0;i<t.length;++i)l.set(new Uint8Array(t[i].buffer),p),p+=t[i].buffer.byteLength;return l},t.prototype.encodeWave=function(t){var n=this.concatenation(t),i=n.byteLength,l=new ArrayBuffer(i+44),p=new DataView(l),v=this.sampleRate,e=this.sampleBit,T=this.channels;return this.writeString(p,0,"RIFF"),p.setUint32(4,36+i,!0),this.writeString(p,8,"WAVE"),this.writeString(p,12,"fmt "),p.setUint32(16,16,!0),p.setUint16(20,1,!0),p.setUint16(22,T,!0),p.setUint32(24,v,!0),p.setUint32(28,v*T*(e/8),!0),p.setUint16(32,T*(e/8),!0),p.setUint16(34,e,!0),this.writeString(p,36,"data"),p.setUint32(40,i,!0),this.writeBuffer(p,44,n),p},t.prototype.stop=function(){this.mic.disconnect(),this.script.disconnect()},t}();n.MediaUtil=p}])});