!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var r=t();for(var i in r)("object"==typeof exports?exports:e)[i]=r[i]}}("undefined"!=typeof self?self:this,(function(){return function(e){var t={};function r(i){if(t[i])return t[i].exports;var o=t[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(i,o,function(t){return e[t]}.bind(null,o));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=60)}([,,function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DrawState=t.Platform=t.Action=t.ActionType=t.ViewTool=t.FileType=t.Direction=t.ScrollMode=t.calStandard=void 0,t.calStandard={sizeWidth:1280,placeWidth:128e4,minFontSize:12,maxFontSize:100,minLineWidth:1,maxLineWidth:100},function(e){e[e.Page=0]="Page",e[e.Scroll=1]="Scroll"}(t.ScrollMode||(t.ScrollMode={})),function(e){e[e.Center=0]="Center",e[e.Horizontal=1]="Horizontal",e[e.Vertical=2]="Vertical"}(t.Direction||(t.Direction={})),function(e){e[e.PPT=1]="PPT",e[e.DOC=2]="DOC",e[e.ELS=4]="ELS",e[e.PDF=8]="PDF",e[e.IMG=16]="IMG",e[e.TXT=32]="TXT",e[e.PPTH5=512]="PPTH5"}(t.FileType||(t.FileType={})),function(e){e[e.Drag=0]="Drag",e[e.Pen=1]="Pen",e[e.Text=2]="Text",e[e.Line=4]="Line",e[e.Rect=8]="Rect",e[e.Ellipse=16]="Ellipse",e[e.Selector=32]="Selector",e[e.Eraser=64]="Eraser",e[e.Laser=128]="Laser"}(t.ViewTool||(t.ViewTool={})),function(e){e[e.Single=1]="Single",e[e.Multi=2]="Multi",e[e.Other=4]="Other"}(t.ActionType||(t.ActionType={})),function(e){e[e.Update=2]="Update",e[e.Delete=4]="Delete",e[e.Move=8]="Move",e[e.Create=32]="Create"}(t.Action||(t.Action={})),function(e){e[e.Pc=1]="Pc",e[e.Mobile=2]="Mobile"}(t.Platform||(t.Platform={})),function(e){e[e.Init=1]="Init",e[e.Down=2]="Down",e[e.Move=3]="Move",e[e.DownMove=4]="DownMove",e[e.DownMoveUp=5]="DownMoveUp",e[e.DownNoMoveUp=6]="DownNoMoveUp",e[e.Leave=7]="Leave",e[e.DownLeave=8]="DownLeave"}(t.DrawState||(t.DrawState={}))},function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.hasOwnProperty.call(e,r)&&i(t,e,r);return o(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.removeElement=t.getElementChild=t.getOffsetData=t.getScrollData=t.checkTextSize=t.checkBrushSize=t.checkColor=t.addTextBeginPlace=t.splitTextHandle=t.calSizeHandle=t.calPlaceHandle=t.transData=t.transColor=t.bindStopsEvents=t.transGraphicsData=t.mapGraphicsData=t.simplifyPathData=t.transRgbTo16=t.transPathByPointList=t.createSvgElementHandle=t.setAttributeHandle=t.createGraphicId=void 0;var s=n(r(81)),a=r(2),c=r(67),d=r(68);t.createGraphicId=function(){return""+d(s.v4())};t.setAttributeHandle=function(e,t){t.forEach((function(t){e.setAttribute(t.attr,t.value)}))};t.createSvgElementHandle=function(e,t,r){var i,o=document.querySelector("#"+e);if(o)return[i=o.querySelector("#"+t)];o=document.createElementNS("http://www.w3.org/2000/svg","svg");var n=document.createElementNS("http://www.w3.org/2000/svg","g");return i=document.createElementNS("http://www.w3.org/2000/svg",r),o.id=e,o.setAttribute("xmlns","http://www.w3.org/2000/svg"),o.setAttribute("version","1.1"),i.id=t,n.appendChild(i),o.appendChild(n),[i,o]};var l=function(e){for(var t=e.length,r=.1,i=t-4,o="M"+e[0]+", "+e[1],n=0;n<t-2;n+=2){var s=n?e[n-2]:e[0],a=n?e[n-1]:e[1],c=e[n+0],d=e[n+1],l=e[n+2],h=e[n+3],u=n!==i?e[n+4]:l,p=n!==i?e[n+5]:h;o+=" C"+(Number(c)+(l-s)/6*r)+","+(Number(d)+(h-a)/6*r)+","+(Number(l)-(u-c)/6*r)+","+(Number(h)-(p-d)/6*r)+","+l+","+h}return o};t.transPathByPointList=l;var h=function(e){if(0===e.indexOf("#"))return e;var t=e.replace(/rgba?/,"").replace(/\(/,"").replace(/\)/,"").replace(/[\s+]/g,"").split(","),r=parseFloat(t[3]||"1"),i=Math.floor(r*parseInt(t[0])+255*(1-r)),o=Math.floor(r*parseInt(t[1])+255*(1-r)),n=Math.floor(r*parseInt(t[2])+255*(1-r));return"#"+("0"+i.toString(16)).slice(-2)+("0"+o.toString(16)).slice(-2)+("0"+n.toString(16)).slice(-2)};t.transRgbTo16=h;t.checkColor=function(e){return/^#[0-9a-fA-F]{6}|rgba?\(*.+\d\)$/.test(e)};t.checkBrushSize=function(e){return/^([1-9]|[1-9]\d|100)$/.test(""+e)};t.checkTextSize=function(e){return/^([1-9]|[1-9]\d|100)$/.test(""+e)};t.simplifyPathData=function(e){var t=[],r=[];return e.forEach((function(e,t,i){t%2==0&&r.push({x:e,y:i[t+1]})})),c(r,1).forEach((function(e){t=t.concat([e.x,e.y])})),t};var u=function(e){var t=e[0],r=e[1],i=e[2],o=e[3];return[Math.min(t,i),Math.min(r,o)]};t.mapGraphicsData=function(e,t){var r;switch(e){case"path":r={d:l(t)};break;case"line":r={x1:t[0],y1:t[1],x2:t[2],y2:t[3]};break;case"rect":var i=Math.abs(t[2]-t[0]),o=Math.abs(t[3]-t[1]),n=u(t);r={x:n[0],y:n[1],width:i,height:o};break;case"ellipse":var s=Math.abs(t[2]-t[0])/2,a=Math.abs(t[3]-t[1])/2,c=u(t);r={cx:c[0]+s,cy:c[1]+a,rx:s,ry:a};break;default:r=!1}return r};t.transGraphicsData=function(e,t){var r=e.length>1?a.ActionType.Multi:a.ActionType.Single,i=JSON.parse(JSON.stringify(e));return i.forEach((function(e){e.action_type=r,e.action=t,delete e.initX,delete e.initY,delete e.selected,delete e.fontSize,delete e.bgColor})),i};t.transColor=function(e,t){var r=e.color;t?(r=r.toString(16),e.color="#"+r.slice(2).padStart(6,"0")):(r=h(r),e.color=parseInt("0xFF"+r.split("#")[1]))};var p=function(e,t,r){var i=e[t];e[t]=e[r],e[r]=i},g=function(e,t,r,i){var o=i.charCodeAt(t);e[t]=i.charCodeAt(r),e[r]=o},f=function(e){for(var t=e.split(","),r=new Uint8Array(Int32Array.from([+t[0],+t[1]]).buffer),i=unescape(encodeURIComponent(t[2])).split("").map((function(e){return e.charCodeAt()})),o=0;o<r.length;o+=4)p(r,o,o+3),p(r,o+1,o+2);var n=new Uint8Array(r.length+i.length);return n.set(r),n.set(i,r.length),btoa(String.fromCharCode.apply(null,n))},m=function(e){for(var t=atob(e),r=new Uint8Array(t.length),i=0;i<8;i+=4)g(r,i,i+3,t),g(r,i+1,i+2,t);for(;i<t.length;i++)r[i]=t.charCodeAt(i);return Array.from(new Int32Array(r.buffer,0,2)).join(",")+","+decodeURIComponent(escape(String.fromCharCode.apply(String,Array.from(r.subarray(8)))))};t.transData=function(e,t){var r=e.type,i=e.data,o=e.oldData;if(r===a.ViewTool.Text)t?(e.data=m(i),e.oldData&&(e.oldData=m(o))):(e.data=f(i),e.oldData&&(e.oldData=f(o)));else if(t){var n=atob(i);for(c=new Uint8Array(n.length),d=0;d<n.length;d+=4)g(c,d,d+3,n),g(c,d+1,d+2,n);e.data=Array.from(new Int32Array(c.buffer)).slice(1)}else{var s=i.slice();s.unshift(s.length/2);for(var c=new Uint8Array(Int32Array.from(s).buffer),d=0;d<c.length;d+=4)p(c,d,d+3),p(c,d+1,d+2);e.data=btoa(String.fromCharCode.apply(null,c))}};t.calSizeHandle=function(e,t,r,i){var o,n=a.calStandard.sizeWidth,s=a.calStandard.minFontSize,c=a.calStandard.minLineWidth;return i?o=Math.round(e*n/r):(o=Math.round(r*e/n),a.ViewTool.Text===t?o<s&&(o=s):o<c&&(o=c)),o};t.calPlaceHandle=function(e,t,r){var i=e.type,o=e.px,n=e.py,s=e.x,c=e.y,d=e.data,l=a.calStandard.placeWidth;if(i===a.ViewTool.Text){var h=d.split(",");r?(h[0]=Math.round(+h[0]*t/l)+"",h[1]=Math.round(+h[1]*t/l)+""):(h[0]=Math.round(+h[0]*l/t)+"",h[1]=Math.round(+h[1]*l/t)+""),e.data=h.join(",")}else{var u=[];d.forEach((function(e){r?u.push(Math.round(e*t/l)):u.push(Math.round(e*l/t))})),e.data=u}r?(e.px&&(e.px=Math.round(o*t/l)),e.py&&(e.py=Math.round(n*t/l)),e.x=Math.round(s*t/l),e.y=Math.round(c*t/l)):(e.px&&(e.px=Math.round(o*l/t)),e.py&&(e.py=Math.round(n*l/t)),e.x=Math.round(s*l/t),e.y=Math.round(c*l/t))};t.bindStopsEvents=function(e,t){t.forEach((function(t){e.addEventListener(t,(function(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0}))}))};t.splitTextHandle=function(e){var t=e.split(",");return{beginX:t[0],beginY:t[1],text:t[2]}};t.addTextBeginPlace=function(e,t,r){return parseInt(t)+","+parseInt(r)+","+e};t.getScrollData=function(e){var t=0,r=0;if(e)for(t+=e.scrollTop,r+=e.scrollLeft;e.parentNode;)t+=e.parentNode.scrollTop||0,r+=e.parentNode.scrollLeft||0,e=e.parentNode;return{scrollTop:t,scrollLeft:r}};t.getOffsetData=function(e){var t=0,r=0;if(e)for(t+=e.offsetTop,r+=e.offsetLeft;e.offsetParent;)t+=e.offsetParent.offsetTop,r+=e.offsetParent.offsetLeft,e=e.offsetParent;return{offsetTop:t,offsetLeft:r}};t.getElementChild=function(e){return e.children||e.childNodes};t.removeElement=function(e){if(e){var t=e.parentNode;t?t.removeChild(e):e.remove?e.remove():e.removeNode()}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Logger=t.getLogAction=void 0;var i=function(){function e(e){this.appid=0,this.userid="",this.roomid="",this.version="",this.platform="",this.isProd=!1,this.logCacheSend=[],this.logCacheMax=100,this.platform=e||"",this.openLogServer()}return e.prototype.init=function(e,t,r,i){this.appid=e||this.appid,this.userid=t||this.userid,this.version=r||this.version,this.isProd=i},e.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=this.log(0,e);console.debug(r)},e.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=this.log(1,e);console.info(r)},e.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=this.log(2,e);console.warn(r)},e.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=this.log(3,e);console.error(r)},e.prototype.log=function(e,t){var r=t.join("");return this.isProd&&this.remoteWebSocketLog(e,this.logParamList(e,r)),r},e.prototype.openLogServer=function(){this.stopWebSocketServer(),this.websocket=new WebSocket("wss://weblogger-edu.zego.im/log")},e.prototype.stopWebSocketServer=function(){this.websocket&&(this.websocket.close(),this.websocket=null)},e.prototype.remoteWebSocketLog=function(e,t){if("string"==typeof t&&t.length>4e3)console.info("log over maximum, ignore");else if(null==this.websocket||2==this.websocket.readyState||3==this.websocket.readyState)this.openLogServer(),this.logCacheSend.length<this.logCacheMax&&this.logCacheSend.push(t);else if(0==this.websocket.readyState)this.logCacheSend.length<this.logCacheMax&&this.logCacheSend.push(t);else if(1==this.websocket.readyState)if(this.logCacheSend.length>0){for(var r="",i=0;i<this.logCacheSend.length;i++)(r+this.logCacheSend[i]).length>4e3&&(this.websocket.send(r),r=""),r=r+this.logCacheSend[i]+"\n";t=r+t,this.logCacheSend=[],this.websocket.send(t)}else this.websocket.send(t);else console.warn("wrong socket state:"+this.websocket.readyState),this.logCacheSend.length<this.logCacheMax&&this.logCacheSend.push(t)},e.prototype.logParamList=function(e,t){var r=(new Date).toLocaleString(),i=t.indexOf(" "),o={time:r,level:e,action:t.substr(0,i)||t,content:t.substr(i+1,4500),appid:this.appid,userid:this.userid,roomid:this.roomid,version:this.version,platform:this.platform};return JSON.stringify(o)},e}(),o=function(e,t,r){var i=e&&e.versions.electron;return{electron:i,platform:(i?e.platform:t)+","+r[r.length-2]+","+r[r.length-1]}}(window.process,navigator.platform,navigator.userAgent.split(" ")),n=o.electron,s=o.platform,a=n?"ec.":"web.";t.getLogAction=function(e,t){return""+a+e+t+" "},t.Logger=new i(s)},function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),o=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||t.hasOwnProperty(r)||i(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),o(r(4),t)},function(e,t,r){"use strict";var i,o=function(){return void 0===i&&(i=Boolean(window&&document&&document.all&&!window.atob)),i},n=function(){var e={};return function(t){if(void 0===e[t]){var r=document.querySelector(t);if(window.HTMLIFrameElement&&r instanceof window.HTMLIFrameElement)try{r=r.contentDocument.head}catch(e){r=null}e[t]=r}return e[t]}}(),s=[];function a(e){for(var t=-1,r=0;r<s.length;r++)if(s[r].identifier===e){t=r;break}return t}function c(e,t){for(var r={},i=[],o=0;o<e.length;o++){var n=e[o],c=t.base?n[0]+t.base:n[0],d=r[c]||0,l="".concat(c," ").concat(d);r[c]=d+1;var h=a(l),u={css:n[1],media:n[2],sourceMap:n[3]};-1!==h?(s[h].references++,s[h].updater(u)):s.push({identifier:l,updater:m(u,t),references:1}),i.push(l)}return i}function d(e){var t=document.createElement("style"),i=e.attributes||{};if(void 0===i.nonce){var o=r.nc;o&&(i.nonce=o)}if(Object.keys(i).forEach((function(e){t.setAttribute(e,i[e])})),"function"==typeof e.insert)e.insert(t);else{var s=n(e.insert||"head");if(!s)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");s.appendChild(t)}return t}var l,h=(l=[],function(e,t){return l[e]=t,l.filter(Boolean).join("\n")});function u(e,t,r,i){var o=r?"":i.media?"@media ".concat(i.media," {").concat(i.css,"}"):i.css;if(e.styleSheet)e.styleSheet.cssText=h(t,o);else{var n=document.createTextNode(o),s=e.childNodes;s[t]&&e.removeChild(s[t]),s.length?e.insertBefore(n,s[t]):e.appendChild(n)}}function p(e,t,r){var i=r.css,o=r.media,n=r.sourceMap;if(o?e.setAttribute("media",o):e.removeAttribute("media"),n&&btoa&&(i+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(n))))," */")),e.styleSheet)e.styleSheet.cssText=i;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(i))}}var g=null,f=0;function m(e,t){var r,i,o;if(t.singleton){var n=f++;r=g||(g=d(t)),i=u.bind(null,r,n,!1),o=u.bind(null,r,n,!0)}else r=d(t),i=p.bind(null,r,t),o=function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(r)};return i(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap)return;i(e=t)}else o()}}e.exports=function(e,t){(t=t||{}).singleton||"boolean"==typeof t.singleton||(t.singleton=o());var r=c(e=e||[],t);return function(e){if(e=e||[],"[object Array]"===Object.prototype.toString.call(e)){for(var i=0;i<r.length;i++){var o=a(r[i]);s[o].references--}for(var n=c(e,t),d=0;d<r.length;d++){var l=a(r[d]);0===s[l].references&&(s[l].updater(),s.splice(l,1))}r=n}}}},function(e,t,r){"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var r=function(e,t){var r=e[1]||"",i=e[3];if(!i)return r;if(t&&"function"==typeof btoa){var o=(s=i,a=btoa(unescape(encodeURIComponent(JSON.stringify(s)))),c="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(a),"/*# ".concat(c," */")),n=i.sources.map((function(e){return"/*# sourceURL=".concat(i.sourceRoot||"").concat(e," */")}));return[r].concat(n).concat([o]).join("\n")}var s,a,c;return[r].join("\n")}(t,e);return t[2]?"@media ".concat(t[2]," {").concat(r,"}"):r})).join("")},t.i=function(e,r,i){"string"==typeof e&&(e=[[null,e,""]]);var o={};if(i)for(var n=0;n<this.length;n++){var s=this[n][0];null!=s&&(o[s]=!0)}for(var a=0;a<e.length;a++){var c=[].concat(e[a]);i&&o[c[0]]||(r&&(c[2]?c[2]="".concat(r," and ").concat(c[2]):c[2]=r),t.push(c))}},t}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,r){"use strict";var i,o=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.ZegoClient=t.ENUM_LOG_LEVEL=void 0,r(61),r(63);var n=r(64),s=r(76),a=r(77),c=r(5),d=r(80);!function(e){e[e.debug=0]="debug",e[e.info=1]="info",e[e.warn=2]="warn",e[e.error=3]="error",e[e.report=99]="report",e[e.disable=100]="disable"}(t.ENUM_LOG_LEVEL||(t.ENUM_LOG_LEVEL={}));var l=function(e){function t(){var t=e.call(this)||this;t.loginTimes=0,c.Logger.init(0,"",t.getVersion(),!0);var r=new s.WhiteboardError,i=new a.WhiteboardService({stateCenter:t.stateCenter,socketCenter:t.socketCenter,whiteboardError:r});t.baseManager=new n.BaseManager(i,r),t.getRoom=i.getRoom.bind(i),t.onRemotePush=i.onRemotePush.bind(i);var o=t.roomHandler.loginSuccessCallBack;t.roomHandler.loginSuccessCallBack=function(e,r){o(e,r),t.loginTimes++,t.loginTimes>1&&i.reload()};return["getViewList","createView","attachView","destroyView","clear"].forEach((function(e){t[e]=t.baseManager[e].bind(t.baseManager)})),t}return o(t,e),t.prototype.config=function(t){return c.Logger.appid=t&&t.appid||"",c.Logger.userid=t&&t.idName||"",e.prototype.config.call(this,t)},t.prototype.login=function(t,r,i,o,n){var s=this;c.Logger.roomid=t,e.prototype.login.call(this,t,r,i,(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];s.loginTimes=0,s.getRoom(),s.onRemotePush(),o.apply(void 0,e)}),(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];n.apply(void 0,e)}))},t.prototype.on=function(e,t){return this.baseManager.on(e,t)},t.prototype.off=function(e,t){return this.baseManager.off(e,t)},t.prototype.getVersion=function(){return"1.9.0"},t}(d.ZegoClient);t.ZegoClient=l},function(e,t,r){var i=r(6),o=r(62);"string"==typeof(o=o.__esModule?o.default:o)&&(o=[[e.i,o,""]]);var n={insert:"head",singleton:!1};i(o,n);e.exports=o.locals||{}},function(e,t,r){(t=r(7)(!1)).push([e.i,"[id^='zego-whiteboard-zoom'] {\n    width: 100%;\n    height: 100%;\n    overflow: hidden;\n}\n\n[id^='zego-whiteboard-con'],\n[id^='zego-whiteboard-con'] > div {\n    transform-origin: 0 0;\n}\n\n[id^='zego-whiteboard'] {\n    -webkit-tap-highlight-color: rgba(0, 0, 0, 0);\n    position: absolute;\n}\n[id^='zego-whiteboard'] *,\n[id^='zego-whiteboard'] ::after,\n[id^='zego-whiteboard'] ::before {\n    box-sizing: border-box !important;\n}\n[id^='zego-whiteboard'] [id^='zego-graphics-bg-container'] {\n    width: 100%;\n    height: 100%;\n    position: absolute;\n    /* z-index: 0; */\n    left: 0;\n    top: 0;\n}\n[id^='zego-whiteboard'] [id^='zego-graphics-container'] {\n    width: 100%;\n    height: 100%;\n    position: absolute;\n    /* z-index: 1; */\n    left: 0;\n    top: 0;\n    overflow: hidden;\n}\n[id^='zego-whiteboard'] [id^='zego-box-container'] {\n    width: 100%;\n    height: 100%;\n    position: absolute;\n    /* z-index: 1; */\n    left: 0;\n    top: 0;\n    overflow: hidden;\n}\n[id^='zego-whiteboard'] svg {\n    transform-origin: 0px 0px 0px;\n    position: absolute;\n    width: 100%;\n    height: 100%;\n    margin: 0px;\n    padding: 0px;\n    left: 0;\n    right: 0;\n    pointer-events: none;\n}\n[id^='zego-whiteboard'] textarea {\n    width: 100%;\n    height: 100%;\n    overflow: hidden;\n    border: none;\n    outline: none;\n    background: transparent;\n    resize: none;\n    position: absolute;\n    top: 0;\n    right: 0;\n    left: 0;\n    bottom: 0;\n    padding: 3px;\n    line-height: 1;\n    font-family: inherit;\n    font-size: inherit;\n    box-sizing: border-box;\n    color: inherit;\n    font-style: inherit;\n    font-weight: inherit;\n    white-space: pre-wrap;\n    word-break: break-all;\n    overflow: hidden;\n}\n[id^='zego-whiteboard'] pre {\n    display: block;\n    visibility: hidden;\n    margin: 0px 0px;\n    font-family: inherit;\n    font-size: inherit;\n    color: inherit;\n    font-style: inherit;\n    font-weight: inherit;\n    line-height: 1;\n    padding: 3px;\n}\n[id^='zego-textarea'] {\n    border: 1px dashed transparent;\n}\n[id^='zego-graphics-box'],\n[id^='zego-textarea'] {\n    position: absolute;\n}\n[id^='zego-graphics-box'] {\n    transition: border 0.3s;\n    -moz-transition: border 0.3s; /* Firefox 4 */\n    -webkit-transition: border 0.3s; /* Safari 和 Chrome */\n    -o-transition: border 0.3s; /* Opera */\n}\n[id^='zego-other-container'] {\n    width: 100%;\n    height: 100%;\n    position: absolute;\n    left: 0;\n    top: 0;\n    cursor: none;\n    overflow: hidden;\n}\n[id^='zego-other-container'] div {\n    box-sizing: border-box;\n}\n[id^='zego-laser'] {\n    width: 16px;\n    height: 16px;\n    border-radius: 50%;\n    background: rgba(255, 78, 51, 1);\n    border: 2px solid rgba(255, 144, 128, 1);\n    box-shadow: 0px 0px 8px 0px rgba(254, 94, 70, 0.7);\n    position: absolute;\n    left: 0;\n    top: 0;\n}\n",""]),e.exports=t},function(e,t){!function(){if(-1!==window.navigator.userAgent.indexOf("Trident")){function e(e,t){t=t||{bubbles:!1,cancelable:!1,detail:void 0};var r=document.createEvent("CustomEvent");return r.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),r}e.prototype=window.Event.prototype,window.CustomEvent=e,document.body.scrollTo||(Element.prototype.scrollTo=function(e,t){this.scrollLeft=e,this.scrollTop=t}),document.body.scrollBy||(Element.prototype.scrollBy=function(e,t){this.scrollLeft+=e,this.scrollTop+=t}),FileReader.prototype.readAsBinaryString||(FileReader.prototype.readAsBinaryString=function(e){var t=this,r=new FileReader;r.onload=function(e){for(var i="",o=new Uint8Array(r.result),n=o.byteLength,s=0;s<n;s++)i+=String.fromCharCode(o[s]);t.content=i,t.result=i,t.onload()},r.readAsArrayBuffer(e)})}}()},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseManager=void 0;var i=r(65),o=r(75),n=r(5),s=n.getLogAction.bind(null,"wb.m."),a=function(){function e(e,t){this.modIdMapInstance={},this.fileInfoMap={},this.store=new o.WhiteboardStore,this.error=t,this.serviceHandle=e,this.registerLoadfileListener(),this.registerPushCallbackHandle(),this.registerPullCallbackHandle()}return e.prototype.registerLoadfileListener=function(){var e=this;document.body.addEventListener("loadfile",(function(t){var r=t.detail.fileID;e.fileInfoMap[r]=t.detail,n.Logger.info(s("update_file_info"),JSON.stringify({fileID:r,detail:t.detail}))}))},e.prototype.registerPushCallbackHandle=function(){var e=this;this.serviceHandle.bindListener("pushClearPageGraphics",(function(t){e.clearGraphicsPushCallback(t)})),this.serviceHandle.bindListener("pushDrawPageGraphics",(function(t,r){e.drawGraphicsPushCallback(t,r)})),this.serviceHandle.bindListener("pushAddMod",(function(t){e.addModPushCallback(t)})),this.serviceHandle.bindListener("pushRemovedMod",(function(t){e.removedModPushCallback(t)})),this.serviceHandle.bindListener("pushScroll",(function(t,r,i,o){e.scrollPushCallback(t,r,i,o)}))},e.prototype.registerPullCallbackHandle=function(){var e=this;this.serviceHandle.bindListener("getPageGraphicsList",(function(t,r,i){var o=e.getMapInstance(t);o&&o.updateRemoteToLocal(r,i)}))},e.prototype.addModPushCallback=function(e){if(!this.getMapInstance(e)){n.Logger.info(s("mod.remote_add"),JSON.stringify({whiteboardID:e}));var t=new i.WhiteboardViewMod(e,this.store,this.serviceHandle);this.setMapInstance(t),this.serviceHandle.actionCustomListener("viewAdd",t)}},e.prototype.removedModPushCallback=function(e){var t=this.getMapInstance(e);t&&(n.Logger.info(s("mod.remote_removed"),JSON.stringify({whiteboardID:e})),t.destroyDomHandle(),t=null,this.deleteMapInstance(e),this.serviceHandle.actionCustomListener("viewRemoved",e))},e.prototype.scrollPushCallback=function(e,t,r,i){var o=this.getMapInstance(e);o&&(n.Logger.info(s("mod.remote_scroll"),JSON.stringify({whiteboardID:e,horizontalPercent:t,verticalPercent:r,step:i,actionMsg:"transValue"})),o.isActivited()&&o.scrollToHandle(t,r,i,!1))},e.prototype.clearGraphicsPushCallback=function(e){var t=this.getMapInstance(e);t&&(n.Logger.info(s("mod.remote_clear"),JSON.stringify({whiteboardID:e})),t.clearLocalHandle())},e.prototype.drawGraphicsPushCallback=function(e,t){var r=this.getMapInstance(e);if(r){var i=[],o=[];t.forEach((function(e){var t=e.del_graphic_id_list,r=e.graphic_list;i=i.concat(t),o=o.concat(r)})),r.updateRemoteToLocal(o,i)}},e.prototype.setFileInfo=function(e){var t;if(e.fileInfo){var r=e.fileInfo,i=r.fileID,o=r.fileName,a=this.fileInfoMap[i];(a=a&&a[o])&&(e.aspectWidth=a.width,e.aspectHeight=a.height,e.pageCount=a.pageCount,n.Logger.info(s("update_file_info"),JSON.stringify({fileID:i,detail:(t={fileID:i},t[o]=a,t)})))}},e.prototype.deleteMapInstance=function(e){delete this.modIdMapInstance[e]},e.prototype.getMapInstance=function(e){return this.modIdMapInstance[e]},e.prototype.setMapInstance=function(e){this.modIdMapInstance[e.getID()]=e},e.prototype.activitedView=function(e){Object.values(this.modIdMapInstance).forEach((function(t){t.setActivited(t.getID()==e)}))},e.prototype.checkAttachingParent=function(e){return!!document.getElementById(e)},e.prototype.checkCreatingView=function(e){return!(!e||!e.roomID||!e.name||isNaN(+e.aspectWidth)||!+e.aspectWidth||isNaN(+e.aspectHeight)||!+e.aspectHeight||isNaN(+e.pageCount)||!+e.pageCount)},e.prototype.getActivitedView=function(){return Object.values(this.modIdMapInstance).find((function(e){return e.isActivited()}))},e.prototype.clear=function(e){Object.values(this.modIdMapInstance).forEach((function(t){t.clearLaserHandle(e)})),n.Logger.info(s("clear"))},e.prototype.getViewList=function(){var e=this;return new Promise((function(t,r){e.serviceHandle.getModList(1,(function(o){try{Object.keys(e.modIdMapInstance).forEach((function(t){-1===o.indexOf(t)&&e.deleteMapInstance(t)})),o.forEach((function(t){e.modIdMapInstance[t]||e.setMapInstance(new i.WhiteboardViewMod(t,e.store,e.serviceHandle))})),n.Logger.info(s("getViewList"),JSON.stringify(Object.keys(e.modIdMapInstance)));var a=Object.values(e.modIdMapInstance).sort((function(t,r){return e.serviceHandle.getCreateTime(r.getID())-e.serviceHandle.getCreateTime(t.getID())}));t(a)}catch(t){r(e.error.transError(e.error.CODES.ZegoWhiteboardViewErrorGetListFail)),n.Logger.error(s("getViewList"),JSON.stringify(t))}}),(function(e){r(e),n.Logger.error(s("getViewList"),JSON.stringify(e))}))}))},e.prototype.createView=function(e){var t=this;return new Promise((function(r,o){if(n.Logger.info(s("createView"),JSON.stringify(e)),!t.checkCreatingView(e)){var a=t.error.transError(t.error.CODES.ZegoWhiteboardViewErrorParamInvalid,"参数错误：roomID、name必填，aspectWidth、aspectHeight、pageCount为正整数");return o(a),void n.Logger.error(s("createView"),JSON.stringify(a))}t.setFileInfo(e),t.serviceHandle.createMod(e,(function(e){try{var a=new i.WhiteboardViewMod(e,t.store,t.serviceHandle);t.setMapInstance(a),r(a),n.Logger.info(s("createView"),"success")}catch(e){o(t.error.transError(t.error.CODES.ZegoWhiteboardViewErrorViewCreateFail)),n.Logger.error(s("createView"),JSON.stringify(e))}}),(function(e){o(e),n.Logger.error(s("createView"),JSON.stringify(e))}))}))},e.prototype.destroyView=function(e){var t=this;return new Promise((function(r,i){if(!e||!e.getID){var o=t.error.transError(t.error.CODES.ZegoWhiteboardViewErrorViewNotExist);return i(o),void n.Logger.error(s("destroyView"),JSON.stringify({whiteboardView:e,errorData:o}))}t.serviceHandle.destroyMod(e.getID(),(function(){try{e.destroyDomHandle(),e=null,r(),n.Logger.info(s("destroyView"),"success")}catch(e){i(t.error.transError(t.error.CODES.ZegoWhiteboardViewErrorDestroyFail)),n.Logger.error(s("destroyView"),JSON.stringify(e))}}),(function(e){i(e),n.Logger.error(s("destroyView"),JSON.stringify(e))}))}))},e.prototype.attachView=function(e,t){var r=this;return new Promise((function(i,o){var a;if(!r.checkAttachingParent(t))return o(a=r.error.transError(r.error.CODES.ZegoWhiteboardViewErrorViewParentNotExist)),void n.Logger.error(s("attachView"),JSON.stringify({parent:t,errorData:a}));if(!e||!e.getID)return o(a=r.error.transError(r.error.CODES.ZegoWhiteboardViewErrorViewNotExist)),void n.Logger.error(s("attachView"),JSON.stringify({whiteboardView:e,errorData:a}));n.Logger.info(s("attachView"),JSON.stringify({whiteboardID:e.getID(),parent:t}));try{var c=e;c.init(t),r.setMapInstance(c),r.activitedView(c.getID()),i(),n.Logger.info(s("attachView"),"success")}catch(e){o(r.error.transError(r.error.CODES.ZegoWhiteboardViewErrorAttachFail)),n.Logger.error(s("attachView"),JSON.stringify(e))}}))},e.prototype.on=function(e,t){return n.Logger.info(s("on"),JSON.stringify({event:e})),this.serviceHandle.bindCustomListener(e,t)},e.prototype.off=function(e,t){return n.Logger.info(s("off"),JSON.stringify({event:e})),this.serviceHandle.deleteCustomListener(e,t)},e}();t.BaseManager=a},function(e,t,r){"use strict";var i,o=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),n=this&&this.__assign||function(){return(n=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.WhiteboardViewMod=void 0;var s=r(66),a=r(2),c=r(3),d=r(69),l=r(70),h=r(71),u=r(72),p=r(73),g=r(74),f=r(5),m=f.getLogAction.bind(null,"wb.v."),v=function(e){function t(t,r,i){var o=e.call(this)||this;return o._enable=!0,o._activited=!1,o.viewInfo={},o.graphicList=[],o.scrollLogTimer=null,o.scrollHandle=function(e){o.clearSelectedHandle(),!o.viewInfo.isOriginScroll||o.viewInfo.ticking||o.viewInfo.draging||(requestAnimationFrame((function(){var t=o.viewInfo.zoom,r=e.target,i=r.scrollTop,n=r.scrollLeft,s=Math.ceil(i/t),c=Math.ceil(n/t),d=0,l=0;if(o.viewInfo.direction===a.Direction.Vertical&&s!==o.viewInfo.scrollY?(o.viewInfo.scrollY=s,l=Number((s/o.viewInfo.viewHeight).toFixed(4)),o.checkEmitScrollHandle(d,l,1,!0)):o.viewInfo.direction===a.Direction.Horizontal&&c!==o.viewInfo.scrollX&&(o.viewInfo.scrollX=c,d=Number((c/o.viewInfo.viewWidth).toFixed(4)),o.checkEmitScrollHandle(d,l,1,!0)),o.viewInfo.ticking=!1,o.whiteboardStore.basicState.type===a.ViewTool.Laser){var h=o.toolInstance.getInstanceHandle(a.ViewTool.Laser);h&&h.pushActualPlaceHandle()}})),o.viewInfo.ticking=!0)},o.handleDragEvent=function(e,t){o.viewInfo.zoom>1&&o.viewInfo.zoomX&&!o._enable&&!o.viewInfo.ticking&&(requestAnimationFrame((function(){!t&&e.buttons<1||(o.viewInfo.isScroll?o.dragScroll(e,!!t):o.dragPage(e,!!t)),o.viewInfo.ticking=!1})),o.viewInfo.ticking=!0)},o.whiteboardID=t,o.whiteboardStore=r,o.serviceHandle=i,o}return o(t,e),t.prototype.destroyDomHandle=function(){this.parentDom&&(f.Logger.info(m("mod.destroy_dom"),JSON.stringify({domID:this.parentDom.id})),this.removeElement(this.parentDom.parentElement),this.parentDom=null)},t.prototype.setWhiteboardTransform=function(e,t){var r=this.viewInfo,i=r.viewportWidth,o=r.viewportHeight,n=r.zoom,s=r.direction,c=this.viewInfo.page||1;s===a.Direction.Horizontal?e-=(c-1)*i*n:t-=(c-1)*o*n,this.whiteboardNode.style.cssText+="transform:translate("+e+"px,"+t+"px) scale("+n+");"},t.prototype.dragScroll=function(e,t){var r=this.viewInfo,i=r.zoom,o=r.zoomX,n=r.zoomY,s=r.zoomTX,c=r.zoomTY,d=r.viewWidth,l=r.viewHeight,h=r.viewportWidth,u=r.viewportHeight,p=r.direction,g=Math.max(s+o-e.clientX,0),f=Math.max(c+n-e.clientY,0),m=d*i-h+17;g>m&&(g=m),f>(m=l*i-u+17)&&(f=m),this.viewInfo.scrollX=g/i|0,this.viewInfo.scrollY=f/i|0,this.viewInfo.ticking=!0,this.viewInfo.draging=!0,this.parentDom&&this.parentDom.scrollTo(g,f),this.viewInfo.ticking=!1,t&&(this.viewInfo.draging=!1,this.viewInfo.zoomX=0,this.viewInfo.zoomY=0,p===a.Direction.Horizontal?this.emitScroll(g/i/d,0,1,!0):this.emitScroll(0,f/i/l,1,!0))},t.prototype.dragPage=function(e,t){var r=this.viewInfo,i=r.zoom,o=r.zoomTX,n=r.zoomTY,s=r.zoomX,a=r.zoomY,c=r.viewportWidth,d=r.viewportHeight,l=o+e.clientX-s,h=n+e.clientY-a,u=c*(1-i);l>0?l=0:l<u&&(l=u),u=d*(1-i),h>0?h=0:h<u&&(h=u),t?(this.viewInfo.zoomTX=l,this.viewInfo.zoomTY=h,this.viewInfo.zoomX=0,this.viewInfo.zoomY=0):this.setWhiteboardTransform(l,h)},t.prototype.initDragEvents=function(){var e=this;this.viewInfo.hasOwnProperty("offsetPageX")||(this.viewInfo.offsetPageX=0,this.viewInfo.offsetPageY=0,this.viewInfo.zoom=1,this.viewInfo.zoomX=0,this.viewInfo.zoomY=0,this.viewInfo.zoomTX=0,this.viewInfo.zoomTY=0),this.parentDom&&!this.getFileInfo()&&(this.parentDom.addEventListener("mousedown",(function(t){if(e.viewInfo.zoomX=e.viewInfo.zoomY=0,e.viewInfo.zoom>1&&!e._enable&&e.parentDom){var r=t.clientX,i=t.clientY;if(e.viewInfo.isScroll){var o=e.parentDom.getBoundingClientRect(),n=o.bottom;if(r>o.right-15||i>n-15)return;e.viewInfo.zoomTX=e.parentDom.scrollLeft,e.viewInfo.zoomTX=e.parentDom.scrollTop}e.viewInfo.zoomX=r,e.viewInfo.zoomY=i}})),this.parentDom.addEventListener("mousemove",this.handleDragEvent),this.parentDom.addEventListener("mouseup",(function(t){return e.handleDragEvent(t,!0)})),this.parentDom.addEventListener("mouseleave",(function(t){return e.handleDragEvent(t,!0)})))},t.prototype.updateBindEvents=function(){switch(this.toolInstance.removeEventsHandle(a.ViewTool.Laser),this.toolInstance.removeEventsHandle(a.ViewTool.Line),this.toolInstance.removeEventsHandle(a.ViewTool.Text),this.toolInstance.removeEventsHandle(a.ViewTool.Selector),this.toolInstance.removeEventsHandle(a.ViewTool.Eraser),this.whiteboardStore.basicState.type){case a.ViewTool.Pen:case a.ViewTool.Line:case a.ViewTool.Ellipse:case a.ViewTool.Rect:this.toolInstance.bindEventsHandle(a.ViewTool.Line);break;case a.ViewTool.Laser:this.toolInstance.bindEventsHandle(a.ViewTool.Laser);break;case a.ViewTool.Text:this.toolInstance.bindEventsHandle(a.ViewTool.Text);break;case a.ViewTool.Selector:!this.toolInstance.getInstanceHandle(a.ViewTool.Selector)&&this.toolInstance.addInstanceHandle(new p.Selector({toolInstance:this.toolInstance})),this.toolInstance.bindEventsHandle(a.ViewTool.Selector);break;case a.ViewTool.Eraser:!this.toolInstance.getInstanceHandle(a.ViewTool.Eraser)&&this.toolInstance.addInstanceHandle(new g.Eraser({toolInstance:this.toolInstance})),this.toolInstance.bindEventsHandle(a.ViewTool.Eraser)}},t.prototype.init=function(e){this.parentDom||this.createModule(e),this.setClassNameHandle(this.whiteboardStore.basicState.type),this.initToolHandle(),this.updateBindEvents(),this.updateStateSizeHandle(),this.initDragEvents(),this.activited();var t=this.serviceHandle.getScrollPercent(this.whiteboardID),r=t.horizontalPercent,i=t.verticalPercent,o=t.pptStep;f.Logger.info(m("mod.get_percent"),JSON.stringify({horizontalPercent:r,verticalPercent:i,step:o})),this.scrollToHandle(r,i,o,!1),f.Logger.info(m("mod.init"),JSON.stringify({result:this.viewInfo}))},t.prototype.initToolHandle=function(){!this.toolInstance&&(this.toolInstance=new l.Tool({whiteboardID:this.whiteboardID,conNode:this.parentDom,zoomNode:this.zoomNode,graphicsConNode:this.graphicsConNode,whiteboardNode:this.whiteboardNode,graphicsBoxConNode:this.graphicsBoxConNode,serviceHandle:this.serviceHandle,graphicList:this.graphicList,whiteboardStore:this.whiteboardStore,viewInfo:this.viewInfo})),!this.toolInstance.getInstanceHandle(a.ViewTool.Laser)&&this.toolInstance.addInstanceHandle(new d.Laser({toolInstance:this.toolInstance})),!this.toolInstance.getInstanceHandle(a.ViewTool.Line)&&this.toolInstance.addInstanceHandle(new h.SvgGraphics({toolInstance:this.toolInstance})),!this.toolInstance.getInstanceHandle(a.ViewTool.Text)&&this.toolInstance.addInstanceHandle(new u.TextareaGraphics({toolInstance:this.toolInstance}))},t.prototype.updateStateSizeHandle=function(e,t){var r=this.viewInfo.viewportWidth;e&&(this.whiteboardStore.basicState.size=e),t&&(this.whiteboardStore.basicState.fontSize=t);var i=this.whiteboardStore.basicState,o=i.size,n=i.fontSize;this.whiteboardStore.basicState.drawSize=c.calSizeHandle(o,a.ViewTool.Line,r,!1),this.whiteboardStore.basicState.drawFontSize=c.calSizeHandle(n,a.ViewTool.Text,r,!1)},t.prototype.calculateHandle=function(e,t,r){var i={viewWidth:0,viewHeight:0},o=this.getFileInfo();if(o){this.viewInfo.direction=a.Direction.Vertical;var n=e.firstChild;if(n){var s=o.fileType,c=s!==a.FileType.PPT&&s!==a.FileType.PPTH5,d=Number(e.getAttribute("data-page")),l=n.clientWidth,h=n.clientHeight;if(l&&h||(l=+n.style.width.replace("px",""),h=+n.style.height.replace("px","")),i.viewWidth=l,i.viewHeight=h,s===a.FileType.PPTH5){var u=e.previousElementSibling;u&&(u.style.zIndex="0")}var p=c&&i.viewHeight>r;this.updateViewInfo({isScroll:c,isOriginScroll:p,page:1,pageCount:d})}return i}var g=this.serviceHandle.getAspectRatio(this.whiteboardID),f=Number(g.split(":")[0]),m=Number(g.split(":")[1]),v=Math.round(m/(f*r/t));if(v>=2)i.viewWidth=t,i.viewHeight=v*r,this.viewInfo.isScroll?this.viewInfo.isOriginScroll=!0:this.updateViewInfo({page:1,pageCount:v}),this.viewInfo.direction=a.Direction.Vertical;else{var y=Math.round(f/(m*t/r));y>=2?(i.viewWidth=y*t,i.viewHeight=r,this.viewInfo.isScroll?this.viewInfo.isOriginScroll=!0:this.updateViewInfo({page:1,pageCount:y}),this.viewInfo.direction=a.Direction.Horizontal):(i.viewWidth=t,i.viewHeight=r,this.viewInfo.direction=a.Direction.Center)}return i},t.prototype.createModule=function(e){var t=this,r=!!this.getFileInfo();this.viewInfo.isScroll=this.whiteboardStore.basicState.scroll===a.ScrollMode.Scroll;var i=document.getElementById(e),o=i.clientWidth,n=i.clientHeight;this.serviceHandle.setViewportSize(this.whiteboardID,o,n),this.whiteboardNode=document.createElement("div"),this.whiteboardNode.id=""+this.whiteboardStore.reservedPrefix.whiteboard+this.whiteboardID;var s=this.calculateHandle(i,o,n),c=s.viewWidth,d=s.viewHeight;this.whiteboardNode.style.cssText="width: "+c+"px; height: "+d+"px;",this.serviceHandle.setSize(this.whiteboardID,c,d);var l=document.createDocumentFragment();[this.whiteboardStore.reservedPrefix.graphicsBgContainer,this.whiteboardStore.reservedPrefix.graphicsContainer,this.whiteboardStore.reservedPrefix.boxContainer].forEach((function(e){var r=document.createElement("div");r.id=""+e+t.whiteboardID,l.appendChild(r)}));var h=this.getElementChild(l);if(this.graphicsConNode=h[1],this.graphicsBoxConNode=h[2],this.graphicsBgConNode=h[0],this.whiteboardNode.appendChild(l),r)this.parentDom=i,this.zoomNode=i.parentNode,this.removeElement(i.querySelector("#"+this.whiteboardNode.id)),this.removeElement(i.children[0]),i.appendChild(this.whiteboardNode),this.viewInfo.isScroll&&i.addEventListener("scroll",this.scrollHandle),this.handleDocsviewEvent(i);else{var u=document.createElement("div");u.id=""+this.whiteboardStore.reservedPrefix.whiteboardZoom+this.whiteboardID,this.zoomNode=u;var p=document.createElement("div");p.id=""+this.whiteboardStore.reservedPrefix.whiteboardCon+this.whiteboardID,p.appendChild(this.whiteboardNode);var g=this.viewInfo.isScroll?this.viewInfo.direction===a.Direction.Horizontal?"overflow: auto hidden;":"overflow: hidden auto;":"overflow: hidden";p.style.cssText="width: 100%; height: 100%;"+g,this.removeElement(i.querySelector("#"+p.id)),u.appendChild(p),i.appendChild(u),this.parentDom=p,this.viewInfo.isScroll&&p.addEventListener("scroll",this.scrollHandle)}this.updateViewInfo({viewportWidth:o,viewportHeight:n,viewWidth:c,viewHeight:d,zoom:1})},t.prototype.setActivited=function(e){this._activited=e},t.prototype.isActivited=function(){return this._activited},t.prototype.activited=function(){if(this.setActivited(!0),this.parentDom){var e=this.parentDom.parentElement;if(e){var t=e.id;e=e.parentElement,Array.from(this.getElementChild(e)).forEach((function(e){e.style.display=e.id===t?"block":"none"}))}this.graphicsBgConNode.style.backgroundColor=this.getFileInfo()?"rgba(255,255,255,0)":this.whiteboardStore.basicState.bgColor}},t.prototype.updateViewInfo=function(e){Object.assign(this.viewInfo,e)},t.prototype.removeElement=function(e){if(e){var t=e.parentNode;t?t.removeChild(e):e.remove?e.remove():e.removeNode()}},t.prototype.getElementChild=function(e){return e.children||e.childNodes},t.prototype.clearSelectedHandle=function(){var e=this;Array.from(this.getElementChild(this.graphicsBoxConNode)).forEach((function(t){t.style.border=e.whiteboardStore.unSelectedBorderCss})),this.graphicList.forEach((function(e){e.selected=!1}))},t.prototype.setClassNameHandle=function(e){var t,r=this.whiteboardStore.reservedPrefix,i=r.whiteboard,o=r.whiteboardCon,n=r.whiteboardZoom;null===(t=this.zoomNode.parentNode)||void 0===t||t.querySelectorAll("[id^="+i+"]").forEach((function(t){-1===t.id.indexOf(""+o)&&-1===t.id.indexOf(""+n)&&(t.className=a.ViewTool[e])}))},t.prototype.scrollToHandle=function(e,t,r,i){var o=this;r=r||1;var n=this.viewInfo,s=n.zoom,c=n.viewWidth,d=n.viewHeight,l=Math.ceil(e*c),h=Math.ceil(t*d);if(this.emitScroll(e,t,r,i),this.viewInfo.isScroll&&this.parentDom){if(this.viewInfo.ticking=!0,this.viewInfo.direction===a.Direction.Horizontal?this.parentDom.scrollLeft=l*s:this.parentDom.scrollTop=h*s,setTimeout((function(){return o.viewInfo.ticking=!1}),34),this.whiteboardStore.basicState.type===a.ViewTool.Laser){var u=this.toolInstance.getInstanceHandle(a.ViewTool.Laser);u&&u.pushActualPlaceHandle()}}else this.clearSelectedHandle(),this.jumpPage(l,h,e,t,r,i)},t.prototype.checkEmitScrollHandle=function(e,t,r,i){var o=this;null===this.scrollLogTimer&&f.Logger.info(m("mod.emit_scroll"),JSON.stringify({whiteboardID:this.whiteboardID,horizontalPercent:e,verticalPercent:t,step:r,notify:i})),clearTimeout(this.scrollLogTimer),this.scrollLogTimer=setTimeout((function(){f.Logger.info(m("mod.emit_scroll"),JSON.stringify({whiteboardID:o.whiteboardID,horizontalPercent:e,verticalPercent:t,step:r,notify:i})),clearTimeout(o.scrollLogTimer),o.scrollLogTimer=null}),100),this.emitScroll(e,t,1,!0)},t.prototype.emitScroll=function(e,t,r,i){i&&this.serviceHandle.scroll(this.whiteboardID,e,t,r),this.serviceHandle.loadCurrentGraphics(this.whiteboardID,e,t)},t.prototype.jumpPage=function(e,t,r,i,o,n){f.Logger.info(m("mod.jump_page"),JSON.stringify({params:{left:e,top:t,horizontalPercent:r,verticalPercent:i,step:o,notify:n,direction:this.viewInfo.direction}}));var s=this.getFileInfo();if(!n&&this.viewInfo.pageCount>1&&this.viewInfo.page<=this.viewInfo.pageCount){if(this.viewInfo.direction===a.Direction.Horizontal){var c=Math.min(Math.floor(e/this.viewInfo.viewportWidth)+1,this.viewInfo.pageCount);this.updateViewInfo({offsetPageX:e,page:c}),this.setWhiteboardTransform(this.viewInfo.zoomTX,this.viewInfo.zoomTY)}else if(s&&this.parentDom){var d={action:"page",y:t*this.viewInfo.zoom,step:o,notify:n};this.parentDom.dispatchEvent(new CustomEvent("zegowbevent",{detail:d}))}else{c=Math.min(Math.floor(t/this.viewInfo.viewportHeight)+1,this.viewInfo.pageCount);this.updateViewInfo({offsetPageY:t,page:c}),this.setWhiteboardTransform(this.viewInfo.zoomTX,this.viewInfo.zoomTY)}if(this.whiteboardStore.basicState.type===a.ViewTool.Laser){var l=this.toolInstance.getInstanceHandle(a.ViewTool.Laser);l&&l.pushActualPlaceHandle()}}s||this.serviceHandle.actionCustomListener("viewScroll",{id:this.whiteboardID,horizontalPercent:r,verticalPercent:i,page:this.getPage(),step:o})},t.prototype.handleDocsviewEvent=function(e){var t=this,r={action:"init",id:this.whiteboardID};e.dispatchEvent(new CustomEvent("zegowbevent",{detail:r})),e.addEventListener("zegodocsevent",(function(e){var r=e.detail,i=r.action;if("page"===i){var o=t.viewInfo,n=o.viewHeight,s=o.zoom,a=o.zoomTX,c=o.zoomTY,d=r.y,l=r.page,h=r.pageCount,u=r.scroll,p=r.step,g=r.notify,f=Number((d/s/n).toFixed(4));t.viewInfo.page=l,t.viewInfo.pageCount=h,u||(t.viewInfo.offsetPageY=d/s|0,t.setWhiteboardTransform(a,c)),g&&t.emitScroll(0,f,p,!0),t.serviceHandle.actionCustomListener("viewScroll",{id:t.whiteboardID,horizontalPercent:0,verticalPercent:f,page:l,step:p})}else"zoomdrag"===i&&(t.viewInfo.isScroll?t.viewInfo.ticking=!r.notify:(t.viewInfo.zoomTX=r.x,t.viewInfo.zoomTY=r.y))}))},t.prototype.clearLaserHandle=function(e){var t=this.toolInstance.getInstanceHandle(a.ViewTool.Laser);t&&t.clearLaserHandle(e)},t.prototype.clearLocalHandle=function(){this.toolInstance.clearLocalHandle()},t.prototype.updateRemoteToLocal=function(e,t){this.toolInstance.updatePushLocalHandle(e,t)},t.prototype.setDragStyle=function(e){if(this.parentDom){this._enable=!!e,this.toolInstance._enable=this._enable,this.parentDom.style.cursor=e?"auto":"move";var t={action:"drag",enable:e};this.parentDom.dispatchEvent(new CustomEvent("zegowbevent",{detail:t}))}},t.prototype.setScrollMode=function(e){this.whiteboardStore.basicState.scroll=e},t.prototype.enable=function(e){return f.Logger.info(m("mod.enable"),JSON.stringify({params:e})),this._enable=!!e,this.toolInstance._enable=this._enable,!0},t.prototype.isEnable=function(){var e=!!this._enable;return f.Logger.info(m("mod.isEnable"),JSON.stringify(e)),e},t.prototype.clear=function(){var e=this;f.Logger.info(m("mod.clear"),JSON.stringify({whiteboardID:this.whiteboardID}));var t=this.serviceHandle.whiteboardError.transError(this.serviceHandle.whiteboardError.CODES.ZegoWhiteboardViewErrorClearFail);this.serviceHandle.clearView(this.whiteboardID,(function(){try{e.clearLocalHandle(),f.Logger.info(m("mod.clear_cb"),"success")}catch(r){f.Logger.error(m("mod.clear_cb"),JSON.stringify(r)),e.serviceHandle.actionCustomListener("error",t)}}),(function(){f.Logger.error(m("mod.clear_cb"),JSON.stringify(t)),e.serviceHandle.actionCustomListener("error",t)}))},t.prototype.scroll=function(e,t){if(isNaN(+e)||isNaN(+t)){var r=this.serviceHandle.whiteboardError.transError(this.serviceHandle.whiteboardError.CODES.ZegoWhiteboardViewErrorParamInvalid,"参数错误: horizontalPercent、verticalPercent取值为0~1");return f.Logger.error(m("mod.scroll"),JSON.stringify(r)),this.serviceHandle.actionCustomListener("error",r),!1}if(f.Logger.info(m("mod.scroll"),JSON.stringify({params:{horizontalPercent:e,verticalPercent:t}})),e<0&&(e=0),e>1&&(e=1),t<0&&(t=0),t>1&&(t=1),e=Number(e.toFixed(4)),t=Number(t.toFixed(4)),f.Logger.info(m("mod.scroll"),JSON.stringify({transParams:{horizontalPercent:e,verticalPercent:t}})),this.viewInfo.pageCount>1&&this.viewInfo.page>0){if(this.parentDom&&this.getFileInfo()){var i={action:"page",vPercent:t,step:1,notify:!0};return this.parentDom.dispatchEvent(new CustomEvent("zegowbevent",{detail:i})),!0}if(this.viewInfo.direction===a.Direction.Horizontal){var o=e*this.viewInfo.viewWidth|0;(n=Math.round(o/this.viewInfo.viewportWidth)+1)<=this.viewInfo.pageCount&&(this.updateViewInfo({offsetPageX:o,page:n}),this.setWhiteboardTransform(this.viewInfo.zoomTX,this.viewInfo.zoomTY),this.scrollToHandle(e,0,1,!0))}else{var n,s=t*this.viewInfo.viewHeight|0;(n=Math.round(s/this.viewInfo.viewportHeight)+1)<=this.viewInfo.pageCount&&(this.updateViewInfo({offsetPageY:s,page:n}),this.setWhiteboardTransform(this.viewInfo.zoomTX,this.viewInfo.zoomTY),this.scrollToHandle(0,t,1,!0))}}else this.viewInfo.isScroll&&this.scrollToHandle(e,t,1,!0);return!0},t.prototype.getCurrentScrollPercent=function(){var e=n(n({},this.serviceHandle.getScrollPercent(this.whiteboardID)),{direction:this.viewInfo.direction});return f.Logger.info(m("mod.getCurrentScrollPercent"),JSON.stringify(e)),e},t.prototype.undo=function(){this.toolInstance.undoHandle()},t.prototype.redo=function(){this.toolInstance.redoHandle()},t.prototype.getAspectRatio=function(){var e=this.serviceHandle.getAspectRatio(this.whiteboardID);return f.Logger.info(m("mod.getAspectRatio"),e),e},t.prototype.getFileInfo=function(){var e=this.serviceHandle.getFileInfo(this.whiteboardID);return f.Logger.info(m("mod.getFileInfo"),JSON.stringify(e)),e},t.prototype.getID=function(){return this.whiteboardID},t.prototype.getName=function(){var e=this.serviceHandle.getModName(this.whiteboardID);return f.Logger.info(m("mod.getName"),e),e},t.prototype.getCreateTime=function(){var e=this.serviceHandle.getCreateTime(this.whiteboardID);return f.Logger.info(m("mod.getCreateTime"),e),e},t.prototype.getRoomID=function(){var e=this.serviceHandle.getRoomID(this.whiteboardID);return f.Logger.info(m("mod.getRoomID"),e),e},t.prototype.getPageCount=function(){var e=this.viewInfo.pageCount||1;return f.Logger.info(m("mod.getPageCount"),e),e},t.prototype.setBackgroundColor=function(e){if(f.Logger.info(m("mod.setBackgroundColor"),JSON.stringify({params:{color:e}})),!c.checkColor(e)){var t=this.serviceHandle.whiteboardError.transError(this.serviceHandle.whiteboardError.CODES.ZegoWhiteboardViewErrorParamInvalid,"参数错误: color仅支持16进制、rgba");return f.Logger.error(m("mod.setBackgroundColor"),JSON.stringify(t)),this.serviceHandle.actionCustomListener("error",t),!1}return this.whiteboardStore.basicState.bgColor=e,this.graphicsBgConNode.style.backgroundColor=e,!0},t.prototype.getBackgroundColor=function(){var e=this.whiteboardStore.basicState.bgColor;return f.Logger.info(m("mod.getBackgroundColor"),JSON.stringify(e)),e},t.prototype.setToolType=function(e){if(f.Logger.info(m("mod.setToolType"),JSON.stringify({params:e})),e=e||a.ViewTool.Drag,-1!==Object.keys(a.ViewTool).indexOf(""+e))return this.setClassNameHandle(e),this.setDragStyle(e!==a.ViewTool.Drag),this.whiteboardStore.basicState.type===e||(this.whiteboardStore.basicState.type=e,this.updateBindEvents(),this.clearSelectedHandle()),!0;var t=this.serviceHandle.whiteboardError.transError(this.serviceHandle.whiteboardError.CODES.ZegoWhiteboardViewErrorParamInvalid,"参数错误: 工具类型为1:path 涂鸦, 2:text 文本框, 4:line 线段, 8:rect 矩形, 16:ellipse 椭圆, 32:selector 选择, 64:eraser 橡皮擦, 128:laser 激光笔");return f.Logger.error(m("mod.setToolType"),JSON.stringify(t)),this.serviceHandle.actionCustomListener("error",t),!1},t.prototype.getToolType=function(){var e=this.whiteboardStore.basicState.type||null;return f.Logger.info(m("mod.getToolType"),e),e},t.prototype.setBrushColor=function(e){if(f.Logger.info(m("mod.setBrushColor"),JSON.stringify({params:e})),!c.checkColor(e)){var t=this.serviceHandle.whiteboardError.transError(this.serviceHandle.whiteboardError.CODES.ZegoWhiteboardViewErrorParamInvalid,"参数错误：color仅支持16进制、rgba");return f.Logger.error(m("mod.setBrushColor"),JSON.stringify(t)),this.serviceHandle.actionCustomListener("error",t),!1}return this.whiteboardStore.basicState.color=e,!0},t.prototype.getBrushColor=function(){var e=this.whiteboardStore.basicState.color;return f.Logger.info(m("mod.getBrushColor"),e),e},t.prototype.setBrushSize=function(e){if(f.Logger.info(m("mod.setBrushSize"),JSON.stringify({params:e})),c.checkBrushSize(e))return this.updateStateSizeHandle(e),!0;var t=this.serviceHandle.whiteboardError.transError(this.serviceHandle.whiteboardError.CODES.ZegoWhiteboardViewErrorParamInvalid,"参数错误: 画笔粗细为100内的正整数");return f.Logger.error(m("mod.setBrushSize"),JSON.stringify(t)),this.serviceHandle.actionCustomListener("error",t),!1},t.prototype.getBrushSize=function(){var e=this.whiteboardStore.basicState.size;return f.Logger.info(m("mod.getBrushSize"),e),e},t.prototype.setTextSize=function(e){if(f.Logger.info(m("mod.setTextSize"),JSON.stringify({params:e})),c.checkTextSize(e))return this.updateStateSizeHandle(void 0,e),!0;var t=this.serviceHandle.whiteboardError.transError(this.serviceHandle.whiteboardError.CODES.ZegoWhiteboardViewErrorParamInvalid,"参数错误: 文本大小为100内的正整数");return f.Logger.error(m("mod.setTextSize"),JSON.stringify(t)),this.serviceHandle.actionCustomListener("error",t),!1},t.prototype.getTextSize=function(){var e=this.whiteboardStore.basicState.fontSize;return f.Logger.info(m("mod.getTextSize"),e),e},t.prototype.getPage=function(){var e=this.viewInfo.page||1;return f.Logger.info(m("mod.getPage"),e),e},t.prototype.setScaleFactor=function(e,t,r){var i=this,o=e;if(f.Logger.info(m("mod.setScaleFactor"),JSON.stringify({params:{zoom:o,x:t,y:r}})),(!o||o<1)&&(o=1),this.viewInfo.zoom!==o){if(this.viewInfo.zoom=o,!this.getFileInfo()&&this.parentDom)if(this.viewInfo.isScroll){if(this.whiteboardNode.style.cssText+="transform:scale("+o+");",this.viewInfo.ticking=!0,this.viewInfo.direction===a.Direction.Horizontal){var n=this.viewInfo.scrollX*o+this.viewInfo.viewportWidth*(o-1)*.5,s=this.viewInfo.viewportHeight*(o-1)*.5;this.emitScroll(n/o/this.viewInfo.viewWidth,0,1,!1),this.parentDom.scrollTo(n,s)}else{n=this.viewInfo.viewportWidth*(o-1)*.5,s=this.viewInfo.scrollY*o+this.viewInfo.viewportHeight*(o-1)*.5;this.emitScroll(0,s/o/this.viewInfo.viewHeight,1,!1),this.parentDom.scrollTo(n,s)}setTimeout((function(){return i.viewInfo.ticking=!1}),34)}else this.viewInfo.zoomTX=this.viewInfo.viewportWidth*(1-o)*.5|0,this.viewInfo.zoomTY=this.viewInfo.viewportHeight*(1-o)*.5|0,this.setWhiteboardTransform(this.viewInfo.zoomTX,this.viewInfo.zoomTY);this.parentDom&&this.parentDom.dispatchEvent(new CustomEvent("zegowbevent",{detail:{action:"scale",zoom:o,x:t,y:r}})),this.toolInstance.reverseZoomHandle(a.ViewTool.Laser);var c=this.toolInstance.getInstanceHandle(a.ViewTool.Laser);c&&c.updateLaserConSize()}},t.prototype.getScaleFactor=function(){var e={scaleFactor:this.viewInfo.zoom,scaleOffsetX:0,scaleOffsetY:0,zoom:this.viewInfo.zoom,x:0,y:0};return f.Logger.info(m("mod.getScaleFactor"),JSON.stringify(e)),e},t.prototype.setFontItalic=function(e){if("boolean"!=typeof e)return!1;var t=this.whiteboardStore.basicState.attributes,r=JSON.parse(t);return r.italic=e,this.whiteboardStore.basicState.attributes=JSON.stringify(r),f.Logger.info(m("mod.setFontItalic"),JSON.stringify({params:e,result:this.whiteboardStore.basicState.attributes})),!0},t.prototype.isFontItalic=function(){var e=JSON.parse(this.whiteboardStore.basicState.attributes).italic;return f.Logger.info(m("mod.isFontItalic"),JSON.stringify(e)),e},t.prototype.setFontBold=function(e){if(f.Logger.info(m("mod.setFontBold"),JSON.stringify({params:e})),"boolean"!=typeof e)return!1;var t=this.whiteboardStore.basicState.attributes,r=JSON.parse(t);return r.bold=e,this.whiteboardStore.basicState.attributes=JSON.stringify(r),f.Logger.info(m("mod.setFontBold"),JSON.stringify({params:e,result:this.whiteboardStore.basicState.attributes})),!0},t.prototype.isFontBold=function(){var e=JSON.parse(this.whiteboardStore.basicState.attributes).bold;return f.Logger.info(m("mod.isFontBold"),JSON.stringify(e)),e},t}(s.WhiteboardView);t.WhiteboardViewMod=v},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WhiteboardView=void 0;var i=function(){};t.WhiteboardView=i},function(e,t,r){var i;!function(){"use strict";function o(e,t,r){var i=t.x,o=t.y,n=r.x-i,s=r.y-o;if(0!==n||0!==s){var a=((e.x-i)*n+(e.y-o)*s)/(n*n+s*s);a>1?(i=r.x,o=r.y):a>0&&(i+=n*a,o+=s*a)}return(n=e.x-i)*n+(s=e.y-o)*s}function n(e,t){var r=e.length-1,i=[e[0]];return function e(t,r,i,n,s){for(var a,c=n,d=r+1;d<i;d++){var l=o(t[d],t[r],t[i]);l>c&&(a=d,c=l)}c>n&&(a-r>1&&e(t,r,a,n,s),s.push(t[a]),i-a>1&&e(t,a,i,n,s))}(e,0,r,t,i),i.push(e[r]),i}function s(e,t,r){if(e.length<=2)return e;var i=void 0!==t?t*t:1;return e=n(e=r?e:function(e,t){for(var r,i,o,n,s,a=e[0],c=[a],d=1,l=e.length;d<l;d++)r=e[d],o=a,n=void 0,s=void 0,n=(i=r).x-o.x,s=i.y-o.y,n*n+s*s>t&&(c.push(r),a=r);return a!==r&&c.push(r),c}(e,i),i)}void 0===(i=function(){return s}.call(t,r,t,e))||(e.exports=i)}()},function(e,t,r){e.exports=function(e,t){var r,i,o,n,s,a,c,d;for(r=3&e.length,i=e.length-r,o=t,s=3432918353,a=461845907,d=0;d<i;)c=255&e.charCodeAt(d)|(255&e.charCodeAt(++d))<<8|(255&e.charCodeAt(++d))<<16|(255&e.charCodeAt(++d))<<24,++d,o=27492+(65535&(n=5*(65535&(o=(o^=c=(65535&(c=(c=(65535&c)*s+(((c>>>16)*s&65535)<<16)&4294967295)<<15|c>>>17))*a+(((c>>>16)*a&65535)<<16)&4294967295)<<13|o>>>19))+((5*(o>>>16)&65535)<<16)&4294967295))+((58964+(n>>>16)&65535)<<16);switch(c=0,r){case 3:c^=(255&e.charCodeAt(d+2))<<16;case 2:c^=(255&e.charCodeAt(d+1))<<8;case 1:o^=c=(65535&(c=(c=(65535&(c^=255&e.charCodeAt(d)))*s+(((c>>>16)*s&65535)<<16)&4294967295)<<15|c>>>17))*a+(((c>>>16)*a&65535)<<16)&4294967295}return o^=e.length,o=2246822507*(65535&(o^=o>>>16))+((2246822507*(o>>>16)&65535)<<16)&4294967295,o=3266489909*(65535&(o^=o>>>13))+((3266489909*(o>>>16)&65535)<<16)&4294967295,(o^=o>>>16)>>>0}},function(e,t,r){"use strict";var i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.Laser=void 0;var o=r(2),n=r(3),s=function(){function e(e){var t=this;this.bindFlag=!1,this.laserInfo={hiddenX:-100,hiddenY:-100,initX:0,initY:0},this.viewTool=o.ViewTool.Laser,this.eventList=[{name:"moveEventName",handle:"mousemoveHandle"},{name:"leaveEventName",handle:"mouseleaveHandle"}],this.mousemoveHandle=function(e){if(t.toolInstance._enable){t.drawLaserMoveBeforeHandle();var r=t.getMouseChangedPoint(e),i=r.clientX,n=r.clientY,s=t.addLaserHandle({place:{clientX:i,clientY:n}});s.x=i,s.y=n,t.drawGraphicsHandle(s,!0),t.toolInstance.updateToRemoteHandle([t.calLaserActualPlaceHandle(s)],o.Action.Move,!1)}},this.mouseleaveHandle=function(){t.toolInstance._enable&&t.laserHiddenHandle()},this.wheelHandle=function(e){var r;e.preventDefault();var i=t.toolInstance,o=i.whiteboardID,n=i.whiteboardStore.reservedPrefix.whiteboard,s=null===(r=document.querySelector("#"+n+o))||void 0===r?void 0:r.parentNode,a=s.getBoundingClientRect(),c=a.width;a.height!==s.scrollHeight&&(s.scrollTop+=Number(e.deltaY.toFixed(4))),c!==s.scrollWidth&&(s.scrollLeft+=Number(e.deltaX.toFixed(4)))};var r=e.toolInstance;this.toolInstance=r,this.laserContainerNode=this.addLaserConDomHandle(),this.updateZIndexHandle(-1)}return e.prototype.transLocationHandle=function(e){var t=e.clientX,r=e.clientY,i=this.toolInstance,o=i.offsetData,n=i.scrollData,s=o.offsetLeft,a=o.offsetTop,c=n.scrollTop,d=n.scrollLeft,l=this.toolInstance.conNode,h=l.scrollLeft,u=l.scrollTop;return{clientX:Math.round(t-s+d-h),clientY:Math.round(r-a+c-u)}},e.prototype.getMouseChangedPoint=function(e){var t;if(this.toolInstance.whiteboardStore.platform===o.Platform.Pc){var r=e,i=r.clientX,n=r.clientY;t=this.transLocationHandle({clientX:i,clientY:n})}else{var s=e.changedTouches[0];i=s.clientX,n=s.clientY;t=this.transLocationHandle({clientX:i,clientY:n})}return t},e.prototype.drawLaserMoveBeforeHandle=function(){this.toolInstance.updateOffsetHandle(),this.toolInstance.updateScrollHandle()},e.prototype.laserHiddenHandle=function(e){var t=this.findLaserHandle(e);if(t){var r=this.laserInfo,i=r.hiddenX,n=r.hiddenY;Object.assign(t,{x:i,y:n,px:0,py:0}),this.toolInstance.moveGraphicsHandle(t.graphic_id,i,n),e||this.toolInstance.updateToRemoteHandle([t],o.Action.Move,!1)}},e.prototype.addLaserHandle=function(e){var t=e.protoGraphic,r=(e.place,this.toolInstance),s=r.whiteboardStore,a=r.graphicList;if(!t){var c=this.findLaserHandle();if(c)return c;var d=this.laserInfo,l=d.initX,h=d.initY,u=d.hiddenX,p=d.hiddenY;t=i(i({graphic_id:n.createGraphicId()},s.basicState),{type:o.ViewTool.Laser,x:u,y:p,px:0,py:0,data:[l,h]})}return a.push(t),this.drawGraphicsHandle(t,!0),this.toolInstance.updateToRemoteHandle([this.calLaserActualPlaceHandle(t)],o.Action.Create,!1),t},e.prototype.findLaserHandle=function(e){var t=this;return this.toolInstance.graphicList.filter((function(r){return e?r.graphic_id===e:r.type===o.ViewTool.Laser&&(!r.id_name||r.id_name===t.toolInstance.getUserName())}))[0]},e.prototype.addLaserConDomHandle=function(){var e=this.toolInstance,t=e.whiteboardID,r=""+e.whiteboardStore.reservedPrefix.laserContainer+t,i=this.toolInstance.userNode.querySelector("#"+r);return i||((i=document.createElement("div")).id=r,this.toolInstance.zoomNode.appendChild(i),this.updateLaserConSize(i),i)},e.prototype.updateZIndexHandle=function(e){this.laserContainerNode.style.zIndex=""+e,this.laserContainerNode.style.visibility=-1===e?"hidden":"visible"},e.prototype.drawGraphicsHandle=function(e,t){var r=this.toolInstance.getUserName(),i=e.graphic_id,n=e.data,s=e.id_name,a=e.x,c=e.y;if(s===r&&!t){t=!0;var d=this.calLaserPlaceHandle(a,c),l=d.x,h=d.y;e.x=l,e.y=h,a=l,c=h}var u=this.toolInstance.whiteboardStore.reservedPrefix,p=""+u.graphics+i,g=""+u.laserCon+i,f=this.toolInstance.userNode.querySelector("#"+p);if(!f){f=document.createElement("div");var m=document.createElement("div");f.id=p,m.id=g,m.appendChild(f),t?this.laserContainerNode.appendChild(m):this.toolInstance.appendGraphicsDomHandle(m,o.ViewTool.Laser)}var v="transform:translate("+(a||0)+"px, "+(c||0)+"px)"+(t?";":"scale("+1/this.toolInstance.viewInfo.zoom+");")+"left:"+n[0]+"px;top:"+n[1]+"px;";f.parentNode.style.cssText=v},e.prototype.bindEventsHandle=function(){var e=this;if(this.updateZIndexHandle("initial"),!this.bindFlag){this.bindFlag=!0;var t=this.toolInstance.whiteboardStore;this.eventList.forEach((function(r){var i=r.name,o=r.handle;e.laserContainerNode.addEventListener(t[i],e[o])})),t.platform===o.Platform.Pc&&this.toolInstance.viewInfo.isScroll&&this.laserContainerNode.addEventListener(t.wheelEventName,this.wheelHandle)}},e.prototype.removeEventsHandle=function(){var e=this;if(this.bindFlag){this.bindFlag=!1,this.updateZIndexHandle(-1);var t=this.toolInstance.whiteboardStore;this.eventList.forEach((function(r){var i=r.name,o=r.handle;e.laserContainerNode.removeEventListener(t[i],e[o])})),this.laserContainerNode.removeEventListener(t.wheelEventName,this.wheelHandle)}},e.prototype.calLaserActualPlaceHandle=function(e){var t=(e=JSON.parse(JSON.stringify(e))).x,r=e.y,i=this.toolInstance.viewInfo,o=i.zoom,n=i.zoomTX,s=i.zoomTY,a=i.offsetPageX,c=i.offsetPageY,d=this.toolInstance.conNode,l=d.scrollLeft,h=d.scrollTop;return e.x=Math.round((t+l-n)/o+a),e.y=Math.round((r+h-s)/o+c),e},e.prototype.calLaserPlaceHandle=function(e,t){var r=this.toolInstance.viewInfo,i=r.zoom,o=r.zoomTX,n=r.zoomTY,s=r.offsetPageX,a=r.offsetPageY,c=this.toolInstance.conNode,d=c.scrollLeft,l=c.scrollTop;return{x:e=Math.round((e-s)*i+o-d),y:t=Math.round((t-a)*i+n-l)}},e.prototype.pushActualPlaceHandle=function(){this.toolInstance.updateScrollHandle();var e=this.findLaserHandle();e&&this.toolInstance.updateToRemoteHandle([this.calLaserActualPlaceHandle(e)],o.Action.Move,!1)},e.prototype.clearLaserHandle=function(e){var t;(t=e?this.toolInstance.graphicList.filter((function(t){return t.id_name===e}))[0]:this.findLaserHandle())&&(this.toolInstance.deleteHandle(t.graphic_id),this.toolInstance.updateToRemoteHandle([t],o.Action.Delete))},e.prototype.updateLaserConSize=function(e){var t;e=e||this.laserContainerNode;var r=this.toolInstance,i=r.whiteboardID,o=r.whiteboardStore.reservedPrefix.whiteboard,n=null===(t=document.querySelector("#"+o+i))||void 0===t?void 0:t.parentNode,s=n.getBoundingClientRect(),a=s.width,c=s.height,d="z-index: "+(e.style.zIndex||"initial")+";";c!==n.scrollHeight&&(d+="width:"+(a-18)+"px;"),a!==n.scrollWidth&&(d+="height:"+(c-18)+"px;"),e.style.cssText=d},e}();t.Laser=s},function(e,t,r){"use strict";var i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},o=this&&this.__spreadArrays||function(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var i=Array(e),o=0;for(t=0;t<r;t++)for(var n=arguments[t],s=0,a=n.length;s<a;s++,o++)i[o]=n[s];return i};Object.defineProperty(t,"__esModule",{value:!0}),t.Tool=void 0;var n=r(3),s=r(2),a=r(5),c=a.getLogAction.bind(null,"wb.v."),d=function(){function e(e){this.mousePointList=[],this.instancesMap={},this._enable=!0;var t=e.whiteboardID,r=e.graphicList,i=e.zoomNode,o=e.conNode,n=e.serviceHandle,s=e.whiteboardStore,a=e.graphicsConNode,c=e.graphicsBoxConNode,d=e.viewInfo,l=e.whiteboardNode;this.whiteboardID=t,this.conNode=o,this.zoomNode=i,this.userNode=i.parentNode,this.graphicsConNode=a,this.whiteboardNode=l,this.graphicsBoxConNode=c,this.graphicList=r,this.serviceHandle=n,this.whiteboardStore=s,this.viewInfo=d,this.updateOffsetHandle(),this.updateScrollHandle(),this.initDrawHandle()}return e.prototype.transLocationHandle=function(e){var t=e.clientX,r=e.clientY,i=this.offsetData,o=i.offsetLeft,n=i.offsetTop,s=this.scrollData,a=s.scrollLeft,c=s.scrollTop,d=this.getPageTranslateXY(),l=d.x,h=d.y,u=this.viewInfo,p=u.zoom,g=u.offsetPageX,f=u.offsetPageY;return{clientX:Math.round((t-o+a-l)/p+g),clientY:Math.round((r-n+c-h)/p+f)}},e.prototype.bindEventsHandle=function(e){this.initDrawHandle();var t=this.instancesMap[e];t&&t.bindEventsHandle()},e.prototype.removeEventsHandle=function(e){var t=this.instancesMap[e];t&&t.removeEventsHandle()},e.prototype.moveGraphicsHandle=function(e,t,r,i){void 0===i&&(i=!1);var o=this.getGraphicsHandle(e);if(o)if("g"===o.tagName)n.getElementChild(o)[0].setAttribute("transform","translate("+(t||0)+", "+(r||0)+")");else{var s="translate("+(t||0)+"px, "+(r||0)+"px)",a=o.style.transform.match(/scale\((\d*.?\d*)\)/),c=a?a[1]:"";s+=!1===i?c?" scale("+ +c+")":"":" scale("+ +i+")",o.style.transform=s}},e.prototype.getGraphicsHandle=function(e,t){void 0===t&&(t=this.userNode);var r=this.getGraphicsSelHandle(e),i=t.querySelector(r);return i&&(i=i.parentNode),i},e.prototype.batchGetGraphicsHandle=function(e,t){return void 0===e&&(e=this.userNode),e.querySelectorAll("[id^="+t+"]")},e.prototype.getGraphicsSelHandle=function(e){return"#"+this.whiteboardStore.reservedPrefix.graphics+e},e.prototype.getBoxSelHandle=function(e){return"#"+this.whiteboardStore.reservedPrefix.graphicsBox+e},e.prototype.updateOffsetHandle=function(){var e=n.getOffsetData(this.conNode),t=e.offsetLeft,r=e.offsetTop;this.offsetData={offsetLeft:t,offsetTop:r}},e.prototype.updateScrollHandle=function(){var e=n.getScrollData(this.conNode),t=e.scrollLeft,r=e.scrollTop;this.scrollData={scrollLeft:t,scrollTop:r}},e.prototype.calMoveHandle=function(){var e=this.mousePointList.length;return[this.mousePointList[e-2]-this.mousePointList[e-4],this.mousePointList[e-1]-this.mousePointList[e-3]]},e.prototype.updateGraphicsOffsetHandle=function(e,t,r){var i=e.x,o=e.y;e.px=i,e.py=o,e.x=i+t,e.y=o+r},e.prototype.updateMousePointsHandle=function(e){var t;e?this.mousePointList.length>=4?(this.mousePointList.splice(0,2),(t=this.mousePointList).push.apply(t,e)):this.mousePointList=this.mousePointList.concat(e):this.mousePointList=[]},e.prototype.updateToRemoteHandle=function(e,t,r){var i=this;if(void 0===r&&(r=!0),e.length){var o=n.transGraphicsData(e,t);a.Logger.info(c("gra.draw"),JSON.stringify(o)),this.serviceHandle.updateToRemote(this.whiteboardID,o,(function(e){a.Logger.info(c("gra.draw_cb"),"error"),r&&i.updateLocalHandle(e)}))}},e.prototype.updateLocalHandle=function(e){var t=this;a.Logger.info(c("gra.draw"),JSON.stringify(e)),e.forEach((function(e){switch(e.action){case s.Action.Delete:t.deleteHandle(e.graphic_id);break;case s.Action.Create:t.createHandle(e),t.updateBoxHandle(e);break;case s.Action.Move:t.moveHandle(e),t.updateBoxHandle(e);break;case s.Action.Update:t.updateHandle(e),t.updateBoxHandle(e)}}))},e.prototype.updatePushLocalHandle=function(e,t){var r=this;a.Logger.info(c("gra.remote_draw"),JSON.stringify({graphicList:e,delGraphicList:t,actionMsg:"transValue"})),this.updateOffsetHandle(),this.updateScrollHandle(),e.forEach((function(e){var t=e.graphic_id,i=e.type,o=r.graphicList.some((function(r){return t===r.graphic_id&&(Object.assign(r,e),!0)}));switch(o||r.graphicList.push(e),i){case s.ViewTool.Laser:r.instancesMap[s.ViewTool.Laser].drawGraphicsHandle(e,!1);break;case s.ViewTool.Text:var n=r.instancesMap[s.ViewTool.Text];o&&r.whiteboardNode.querySelector("#"+r.whiteboardStore.reservedPrefix.graphics+t+" ")?n.updateGraphicsHandle(e):n.drawGraphicsHandle(e,!1),r.updateBoxHandle(e);break;default:r.instancesMap[s.ViewTool.Line].drawGraphicsHandle(e,!1),r.updateBoxHandle(e)}})),t&&t.forEach((function(e){r.deleteHandle(e)}))},e.prototype.deleteHandle=function(e){n.removeElement(this.getBoxHandle(e));var t=this.getGraphicsHandle(e);n.removeElement(t&&"g"===t.tagName?t.parentNode:t),this.graphicList.forEach((function(t,r,i){t.graphic_id===e&&i.splice(r,1)}))},e.prototype.createHandle=function(e){switch(this.graphicList.push(e),e.type){case s.ViewTool.Text:this.getInstanceHandle(s.ViewTool.Text).drawGraphicsHandle(e,!1);break;default:this.getInstanceHandle(s.ViewTool.Line).drawGraphicsHandle(e,!0)}},e.prototype.moveHandle=function(e){var t=e.graphic_id,r=e.x,i=e.y,o=e.type;this.setDataToGraphicList(t,{x:r,y:i}),this.moveGraphicsHandle(t,r,i,o===s.ViewTool.Laser?1/this.viewInfo.zoom:void 0)},e.prototype.updateHandle=function(e){try{this.getInstanceHandle(s.ViewTool.Text).backUpdateGraphicsHandle(e)}catch(e){console.log(e)}},e.prototype.updateBoxHandle=function(e){var t=e.type,r=e.graphic_id,i=e.size,o=e.selected;if(t===s.ViewTool.Laser)return!1;var n=t===s.ViewTool.Text?0:i,a=this.getGraphicsHandle(r);if(!a)return!1;var c=this.getBoxInfoByGraphicInfo(a,n),d=c.left,l=c.top,h="width: "+c.width+"px; "+("height: "+c.height+"px; ")+("left: "+d+"px; ")+("top: "+l+"px; ")+("border: "+this.whiteboardStore[o?"selectedBorderCss":"unSelectedBorderCss"]+";"),u=this.getBoxHandle(r);return u||((u=document.createElement("div")).setAttribute("id",""+this.whiteboardStore.reservedPrefix.graphicsBox+r),this.graphicsBoxConNode.appendChild(u),t===s.ViewTool.Text&&(h+="pointer-events: initial;")),u.style.cssText=h,u},e.prototype.addInstanceHandle=function(e){var t=e.viewTool,r=this.getInstanceHandle(t);return r||(this.instancesMap[t]=e,e)},e.prototype.getInstanceHandle=function(e){return this.instancesMap[e]},e.prototype.getBoxHandle=function(e){var t=this.getBoxSelHandle(e);return this.userNode.querySelector(t)},e.prototype.getUserName=function(){return this.serviceHandle.getUserName()},e.prototype.appendGraphicsDomHandle=function(e,t){if(s.ViewTool.Laser===t)this.graphicsConNode.appendChild(e);else{var r=this.graphicsConNode.querySelector("[id ^= "+this.whiteboardStore.reservedPrefix.laserCon+"]");this.graphicsConNode.insertBefore(e,r||null)}},e.prototype.checkMultipointHandle=function(e){return e.touches.length>1},e.prototype.downCommonHandle=function(e){if(this.whiteboardStore.platform===s.Platform.Mobile){if(this.checkMultipointHandle(e))return!1;e.preventDefault()}return this.updateOffsetHandle(),this.updateScrollHandle(),!0},e.prototype.updateProtoGraphic=function(e){e?Object.assign(this.protoGraphic,e):this.protoGraphic=i({graphic_id:"",data:[],oldData:"",selected:!1,x:0,y:0,px:0,py:0},this.whiteboardStore.basicState)},e.prototype.updateGraphicsDataHandle=function(e){var t=this.protoGraphic.data;switch(this.protoGraphic.type){case s.ViewTool.Pen:t.push.apply(t,e);break;default:t.splice.apply(t,o([2,2],e))}},e.prototype.initDrawHandle=function(){this.updateProtoGraphic(),this.updateMousePointsHandle()},e.prototype.getBoxInfoByGraphicInfo=function(e,t){var r=e.getBoundingClientRect(),i=r.left,o=r.top,n=r.width,s=r.height,a=this.viewInfo.zoom,c=this.transLocationHandle({clientX:i,clientY:o});i=c.clientX-Math.ceil(t/2)-this.whiteboardStore.boxBorderWidth-this.whiteboardStore.boxPadding,o=c.clientY-Math.ceil(t/2)-this.whiteboardStore.boxBorderWidth-this.whiteboardStore.boxPadding;var d="electron"===this.serviceHandle.platform?-1:this.whiteboardStore.boxBorderWidth;return{left:i,top:o,width:n=Math.ceil(n/a)+t+2*this.whiteboardStore.boxPadding+d,height:s=Math.ceil(s/a)+t+2*this.whiteboardStore.boxPadding+d}},e.prototype.getMouseStartPoint=function(e){var t;if(this.whiteboardStore.platform===s.Platform.Pc){var r=e,i=r.clientX,o=r.clientY;t=this.transLocationHandle({clientX:i,clientY:o})}else{var n=e.touches[0];i=n.clientX,o=n.clientY;t=this.transLocationHandle({clientX:i,clientY:o})}return t},e.prototype.getMouseChangedPoint=function(e){var t;if(this.whiteboardStore.platform===s.Platform.Pc){var r=e,i=r.clientX,o=r.clientY;t=this.transLocationHandle({clientX:i,clientY:o})}else{var n=e.changedTouches[0];i=n.clientX,o=n.clientY;t=this.transLocationHandle({clientX:i,clientY:o})}return t},e.prototype.setDataToGraphicList=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];for(var i=0,n=this.graphicList.length;i<n;i++){var s=this.graphicList[i];if(e===s.graphic_id){Object.assign.apply(Object,o([s],t));break}}},e.prototype.getDataFromGraphicList=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];for(var i={},o=function(r,o){var s=n.graphicList[r];if(e===s.graphic_id)return t.forEach((function(e){i[e]=s[e]})),"break"},n=this,s=0,a=this.graphicList.length;s<a;s++){var c=o(s,a);if("break"===c)break}return i},e.prototype.getCoverHandle=function(e){var t=this,r=this.whiteboardStore.platform===s.Platform.Pc?e:e.changedTouches[0],i=r.clientX,o=r.clientY,n=!1,a=0;return this.graphicList.forEach((function(e){if(e.type!==s.ViewTool.Laser){var r=t.getBoxHandle(e.graphic_id);if(r){var c=r.getBoundingClientRect(),d=c.left,l=c.top,h=c.right,u=c.bottom;if(i>=d&&i<=h&&o>=l&&o<=u){var p=Math.pow(u-l,2)+Math.pow(h-d,2);(!a||a>p)&&(a=p,n=e)}}}})),n},e.prototype.filterExistingHandle=function(e){var t=this;return e.filter((function(e){return e.action===s.Action.Create||t.graphicList.filter((function(t){return t.graphic_id===e.graphic_id})).length}))},e.prototype.undoHandle=function(){var e=this;this.serviceHandle.undo(this.whiteboardID,(function(t){var r=e.filterExistingHandle(t.graphicList);return e.updateLocalHandle(r),a.Logger.info(c("gra.undo_cb"),"success"),{graphicList:r,doTaskSeq:t.doTaskSeq}}),(function(t){e.updateLocalHandle(t),a.Logger.info(c("gra.undo_cb"),"error")}))},e.prototype.redoHandle=function(){var e=this;this.serviceHandle.redo(this.whiteboardID,(function(t){e.updateLocalHandle(t),a.Logger.info(c("gra.redo_cb"),"success")}),(function(t){e.updateLocalHandle(t),a.Logger.info(c("gra.redo_cb"),"error")}))},e.prototype.clearLocalHandle=function(){var e=this.getInstanceHandle(s.ViewTool.Laser),t=e.findLaserHandle();this.graphicList.length=0,this.graphicsBoxConNode.innerHTML="",this.graphicsConNode.innerHTML="",t&&e.addLaserHandle({protoGraphic:t})},e.prototype.reverseZoomHandle=function(e){var t=this;if(e===s.ViewTool.Laser){var r=this.viewInfo.zoom,i=this.whiteboardStore.reservedPrefix.laserCon;this.batchGetGraphicsHandle(this.graphicsConNode,i).forEach((function(e){var i=e.style.transform,o=t.getTranslateXY(i),n=o.x,s=o.y;e.style.transform="translate("+n+"px, "+s+"px) scale("+1/r+")"}))}},e.prototype.getTranslateXY=function(e){if(!e)return{x:0,y:0};var t=e.match(/translate\((-?\d*.?\d*)px\,\s*(-?\d*.?\d*)px\)/);return{x:+t[1],y:+t[2]}},e.prototype.getPageTranslateXY=function(){var e=this.viewInfo,t=e.zoom,r=e.isScroll,i=e.direction,o=e.page,n=e.viewportWidth,a=e.viewportHeight,c=0,d=0;if(!r){var l=this.whiteboardNode.style.transform;if(l){var h=this.getTranslateXY(l);i===s.Direction.Horizontal?(c=h.x+(o-1)*n*t,d=h.y):(c=h.x,d=h.y+ +(o-1)*a*t)}}return{x:c,y:d}},e}();t.Tool=d},function(e,t,r){"use strict";var i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.SvgGraphics=void 0;var o=r(2),n=r(3),s=function(){function e(e){var t=this;this.bindFlag=!1,this.viewTool=o.ViewTool.Line,this.eventList=[{name:"downEventName",handle:"mousedownHandle"},{name:"moveEventName",handle:"mousemoveHandle"},{name:"upEventName",handle:"mouseupHandle"},{name:"leaveEventName",handle:"mouseleaveHandle"}],this.mousedownHandle=function(e){var r=t.toolInstance,o=r._enable,s=r.whiteboardNode,a=r.whiteboardStore;if(o&&t.toolInstance.downCommonHandle(e)){var c=t.toolInstance.getMouseStartPoint(e),d=c.clientX,l=c.clientY;t.toolInstance.updateMousePointsHandle([d,l]),t.toolInstance.updateProtoGraphic(i(i({graphic_id:n.createGraphicId()},a.basicState),{x:0,y:0,px:0,py:0,data:[d,l]})),s.addEventListener(a.moveEventName,t.mousemoveHandle)}},this.mousemoveHandle=function(e){if(t.toolInstance._enable){var r=t.toolInstance.getMouseChangedPoint(e),i=r.clientX,o=r.clientY;t.toolInstance.updateGraphicsDataHandle([i,o]),t.drawGraphicsHandle(t.toolInstance.protoGraphic,!0)}},this.mouseupHandle=function(){var e=t.toolInstance,r=e._enable,i=e.protoGraphic,s=e.whiteboardStore,a=e.graphicList,c=e.whiteboardNode;if(r){c.removeEventListener(s.moveEventName,t.mousemoveHandle);var d=i.graphic_id,l=i.type,h=i.data;if(d)if(t.toolInstance.updateBoxHandle(i)){if(l===o.ViewTool.Pen){var u=t.toolInstance.getGraphicsHandle(d);if(!u)return;var p=n.simplifyPathData(h);n.getElementChild(u)[0].setAttribute("d",n.mapGraphicsData("path",p).d),t.toolInstance.updateProtoGraphic({data:p})}var g=JSON.parse(JSON.stringify(i));a.push(g),t.toolInstance.updateToRemoteHandle([g],o.Action.Create)}t.toolInstance.initDrawHandle()}},this.mouseleaveHandle=function(){t.toolInstance._enable&&t.mouseupHandle()};var r=e.toolInstance;this.toolInstance=r}return e.prototype.bindEventsHandle=function(){var e=this;if(!this.bindFlag){this.bindFlag=!0;var t=this.toolInstance,r=t.whiteboardStore,i=t.whiteboardNode;this.eventList.forEach((function(t){var o=t.name,n=t.handle;"moveEventName"!==o&&i.addEventListener(r[o],e[n])}))}},e.prototype.removeEventsHandle=function(){var e=this;if(this.bindFlag){this.bindFlag=!1;var t=this.toolInstance,r=t.whiteboardStore,i=t.whiteboardNode;this.eventList.forEach((function(t){var o=t.name,n=t.handle;i.removeEventListener(r[o],e[n])}))}},e.prototype.drawGraphicsHandle=function(e,t){switch(e.type){case o.ViewTool.Pen:this.drawGraphicsPath(e,t);break;case o.ViewTool.Line:this.drawGraphicsLine(e,t);break;case o.ViewTool.Ellipse:this.drawGraphicsEllipse(e,t);break;case o.ViewTool.Rect:this.drawGraphicsRect(e,t)}},e.prototype.drawGraphicsLine=function(e,t,r,i,s,a){void 0===r&&(r="none"),void 0===i&&(i=1),void 0===s&&(s="round"),void 0===a&&(a="round");var c=this.toolInstance,d=c.viewInfo,l=c.whiteboardStore,h=e.data,u=e.graphic_id,p=e.color,g=e.x,f=e.y,m=t?l.basicState.drawSize:n.calSizeHandle(e.size,e.type,d.viewportWidth,!1),v=n.mapGraphicsData("line",h),y=v.x1,S=v.y1,b=v.x2,C=v.y2,_=""+l.reservedPrefix.graphicsSvg+u,T=""+l.reservedPrefix.graphics+u,E=n.createSvgElementHandle(_,T,"line"),w=E[0];E[1]&&this.toolInstance.appendGraphicsDomHandle(E[1],o.ViewTool.Line),n.setAttributeHandle(w,[{attr:"fill",value:r},{attr:"opacity",value:i},{attr:"stroke",value:p},{attr:"stroke-width",value:m},{attr:"stroke-linejoin",value:s},{attr:"stroke-linecap",value:a},{attr:"x1",value:y},{attr:"y1",value:S},{attr:"x2",value:b},{attr:"y2",value:C},{attr:"transform",value:"translate("+(g||0)+", "+(f||0)+")"}])},e.prototype.drawGraphicsRect=function(e,t,r,i,s,a){void 0===r&&(r="none"),void 0===i&&(i=1),void 0===s&&(s="round"),void 0===a&&(a="round");var c=this.toolInstance,d=c.viewInfo,l=c.whiteboardStore,h=e.data,u=e.graphic_id,p=e.color,g=e.x,f=e.y,m=t?l.basicState.drawSize:n.calSizeHandle(e.size,e.type,d.viewportWidth,!1),v=n.mapGraphicsData("rect",h),y=v.width,S=v.height,b=v.x,C=v.y;if(y&&S){var _=""+l.reservedPrefix.graphicsSvg+u,T=""+l.reservedPrefix.graphics+u,E=n.createSvgElementHandle(_,T,"rect"),w=E[0];E[1]&&this.toolInstance.appendGraphicsDomHandle(E[1],o.ViewTool.Rect),n.setAttributeHandle(w,[{attr:"fill",value:r},{attr:"opacity",value:i},{attr:"stroke",value:p},{attr:"stroke-width",value:m},{attr:"stroke-linejoin",value:s},{attr:"stroke-linecap",value:a},{attr:"width",value:y},{attr:"height",value:S},{attr:"x",value:b},{attr:"y",value:C},{attr:"transform",value:"translate("+(g||0)+", "+(f||0)+")"}])}},e.prototype.drawGraphicsPath=function(e,t,r,i,s){void 0===r&&(r="none"),void 0===i&&(i="round"),void 0===s&&(s="round");var a=this.toolInstance,c=a.viewInfo,d=a.whiteboardStore,l=e.color,h=e.graphic_id,u=e.data,p=e.x,g=e.y,f=t?d.basicState.drawSize:n.calSizeHandle(e.size,e.type,c.viewportWidth,!1);if(!(u.length<4)){var m=n.mapGraphicsData("path",u).d,v=""+d.reservedPrefix.graphicsSvg+h,y=""+d.reservedPrefix.graphics+h,S=n.createSvgElementHandle(v,y,"path"),b=S[0];S[1]&&this.toolInstance.appendGraphicsDomHandle(S[1],o.ViewTool.Pen),n.setAttributeHandle(b,[{attr:"fill",value:r},{attr:"d",value:m},{attr:"stroke",value:l},{attr:"stroke-width",value:f},{attr:"stroke-linejoin",value:i},{attr:"stroke-linecap",value:s},{attr:"transform",value:"translate("+(p||0)+", "+(g||0)+")"}])}},e.prototype.drawGraphicsEllipse=function(e,t,r,i,s,a){void 0===r&&(r="none"),void 0===i&&(i=1),void 0===s&&(s="round"),void 0===a&&(a="round");var c=this.toolInstance,d=c.viewInfo,l=c.whiteboardStore,h=e.color,u=e.data,p=e.graphic_id,g=e.x,f=e.y,m=t?l.basicState.drawSize:n.calSizeHandle(e.size,e.type,d.viewportWidth,!1),v=n.mapGraphicsData("ellipse",u),y=v.cx,S=v.cy,b=v.rx,C=v.ry,_=""+l.reservedPrefix.graphicsSvg+p,T=""+l.reservedPrefix.graphics+p,E=n.createSvgElementHandle(_,T,"ellipse"),w=E[0];E[1]&&this.toolInstance.appendGraphicsDomHandle(E[1],o.ViewTool.Ellipse),n.setAttributeHandle(w,[{attr:"fill",value:r},{attr:"opacity",value:i},{attr:"stroke",value:h},{attr:"stroke-width",value:m},{attr:"stroke-linejoin",value:s},{attr:"stroke-linecap",value:a},{attr:"cx",value:y},{attr:"cy",value:S},{attr:"rx",value:b},{attr:"ry",value:C},{attr:"transform",value:"translate("+(g||0)+", "+(f||0)+")"}])},e}();t.SvgGraphics=s},function(e,t,r){"use strict";var i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.TextareaGraphics=void 0;var o=r(2),n=r(3),s=function(){function e(e){var t=this;this.bindFlag=!1,this.isBlur=!1,this.backSpace=!1,this.scrollHeight=0,this.viewTool=o.ViewTool.Text,this.eventList=[{name:"upEventName",handle:"mouseupHandle"}],this.mouseupHandle=function(e){var r=t.toolInstance,o=r._enable,s=r.whiteboardStore,a=r.protoGraphic,c=r.graphicList;if(o&&t.toolInstance.downCommonHandle(e))if(t.isBlur)t.isBlur=!1;else{var d=t.toolInstance.getMouseChangedPoint(e),l=d.clientX,h=d.clientY;t.toolInstance.updateProtoGraphic(i({graphic_id:n.createGraphicId(),x:0,y:0,px:0,py:0,data:n.addTextBeginPlace("",l+"",h+"")},s.basicState));var u=i(i({},a),{size:s.basicState.fontSize});c.push(u),t.drawGraphicsHandle(u,!0)}};var r=e.toolInstance;this.toolInstance=r}return e.prototype.addTextareaDomHandle=function(e){var t=this.toolInstance.whiteboardStore,r=e.graphic_id,i=e.data,o=document.createElement("textarea"),s=""+t.reservedPrefix.graphics+r;o.setAttribute("id",s),o.setAttribute("spellcheck","false"),o.setAttribute("maxlength",""+t.maxlength);var a=n.splitTextHandle(i).text;return o.value=a,o},e.prototype.addPreDomHandle=function(e){var t=this.toolInstance,r=t.viewInfo,i=t.whiteboardStore,o=e.size,s=e.data,a=e.type,c=n.splitTextHandle(s).text,d=document.createElement("pre");d.innerHTML=c;var l=n.calSizeHandle(o,a,r.viewportWidth,!1),h=i.textareaPadding;return h*=2,d.style.cssText="min-height:"+(l+h)+"px;min-width:"+(l+h)+"px;",d},e.prototype.addTextareaConDomHandle=function(e){var t=this.toolInstance,r=t.viewInfo,i=t.whiteboardStore,o=e.size,s=e.color,a=e.data,c=e.graphic_id,d=e.type,l=e.attributes,h=JSON.parse(l||i.basicState.attributes),u=h.bold,p=h.italic,g=n.calSizeHandle(o,d,r.viewportWidth,!1),f=n.splitTextHandle(a),m=f.beginX,v=f.beginY,y=document.createElement("div"),S=""+i.reservedPrefix.textareaCon+c;return y.setAttribute("id",S),y.style.cssText="font-size:"+g+"px;font-style:"+(p?"italic":"normal")+";font-weight:"+(u?"bold":"normal")+";left:"+m+"px;top:"+v+"px;color:"+s+";caret-color:"+s+";",y},e.prototype.bindTextareaInputEventHandle=function(e){var t=this;e.addEventListener("keydown",(function(e){t.backSpace=8===e.keyCode})),e.addEventListener("input",(function(e){var r=t.toolInstance.whiteboardStore.maxlength,i=e.target,o=Number(i.style.height.split("px")[0]||0),n=i.previousSibling,s=Number(n.style.maxHeight.split("px")[0]),a=i.parentNode,c=i.value;c.length>r&&(i.value=c.slice(0,r)),n.innerHTML=c;var d=a.style.fontSize,l=Number(d.split("px")[0]);if(i.style.height=l+"px",!t.backSpace&&i.scrollHeight-o>10&&o&&t.scrollHeight!==i.scrollHeight){var h=i.selectionStart-1;c[h].match(/\n/)||(c=c.slice(0,h)+"\n"+c.slice(h),n.innerHTML=c,i.value=c,i.selectionStart=h+2,i.selectionEnd=h+2),t.scrollHeight=i.scrollHeight}var u=i.scrollHeight>s?s:i.scrollHeight;i.style.height=u+"px",n.style.height=u+"px"}))},e.prototype.bindTextareaFocusEvent=function(e,t){var r=this,i=t.data,o=n.splitTextHandle(i),s=o.beginX,a=o.beginY;e.addEventListener("focus",(function(e){var t=e.target;t.parentNode.style.borderColor="red";var i=t.id.split(r.toolInstance.whiteboardStore.reservedPrefix.graphics)[1];r.toolInstance.setDataToGraphicList(i,{oldData:n.addTextBeginPlace(t.value,s,a)}),r.initMaxSizeHandle(t)}))},e.prototype.bindTextareaBlurEvents=function(e){var t=this,r=this.toolInstance,i=r.whiteboardStore,s=r.graphicsBoxConNode,a=r.graphicList;e.addEventListener("blur",(function(e){var r=e.target,c=r.parentNode;t.scrollHeight=0,t.backSpace=!1;var d=r.value,l=r.id.split(i.reservedPrefix.graphics)[1];t.updatePointerEvents(2,s.querySelector(t.toolInstance.getBoxSelHandle(l)));var h,u=t.toolInstance.getDataFromGraphicList(l,"oldData").oldData,p=n.splitTextHandle(u),g=p.text,f=p.beginX,m=p.beginY;d?(h=g?o.Action.Update:o.Action.Create,t.isBlur=!0,c.style.borderColor="transparent",a.forEach((function(e){e.graphic_id===l&&(d!==g&&(e.oldData=e.data,e.data=n.addTextBeginPlace(d,f,m),t.toolInstance.updateToRemoteHandle([e],h)),t.toolInstance.updateBoxHandle(e))})),t.toolInstance.initDrawHandle()):(n.removeElement(c),g&&(h=o.Action.Delete,a.forEach((function(e,r,i){e.graphic_id===l&&(i.splice(r,1),e.oldData=e.data,t.toolInstance.updateToRemoteHandle([e],h))})),n.removeElement(t.toolInstance.getBoxHandle(l))),t.isBlur=!0)}))},e.prototype.updatePointerEvents=function(e,t){var r=this,i=this.toolInstance,o=i.graphicsBoxConNode,s=i.whiteboardStore;1===e?(Array.prototype.slice.call(n.getElementChild(o),0).forEach((function(e){var t=r.toolInstance.getGraphicsHandle(e.id.split(s.reservedPrefix.graphicsBox)[1]);t&&"DIV"===t.nodeName&&(e.style.pointerEvents="initial")})),o.style.pointerEvents="none",t&&(t.style.pointerEvents="none")):(o.style.pointerEvents="initial",t&&(t.style.pointerEvents="initial"))},e.prototype.bindEventsHandle=function(){if(!this.bindFlag){this.bindFlag=!0;var e=this.toolInstance,t=e.whiteboardStore;e.whiteboardNode.addEventListener(t.upEventName,this.mouseupHandle)}},e.prototype.removeEventsHandle=function(){if(this.bindFlag){this.bindFlag=!1;var e=this.toolInstance,t=e.whiteboardStore;e.whiteboardNode.removeEventListener(t.upEventName,this.mouseupHandle)}},e.prototype.drawGraphicsHandle=function(e,t){var r=e.x,i=e.y,s=this.addTextareaDomHandle(e),a=this.addPreDomHandle(e),c=this.addTextareaConDomHandle(e);c.appendChild(a),c.appendChild(s),c.style.transform="translate("+(r||0)+"px, "+(i||0)+"px)",this.toolInstance.appendGraphicsDomHandle(c,o.ViewTool.Text),this.bindTextareaInputEventHandle(s),this.bindTextareaFocusEvent(s,e);var d=this.toolInstance.whiteboardStore,l=d.downEventName,h=d.moveEventName,u=d.upEventName;n.bindStopsEvents(s,[l,h,u]),t&&(s.focus(),this.updatePointerEvents(1,null)),this.bindTextareaBlurEvents(s)},e.prototype.updateGraphicsHandle=function(e){var t=this.toolInstance,r=t.viewInfo,i=t.whiteboardStore,o=e.graphic_id,s=e.data,a=e.size,c=e.color,d=e.x,l=e.y,h=e.type,u=e.attributes,p=JSON.parse(u||i.basicState.attributes),g=p.bold,f=p.italic,m=n.calSizeHandle(a,h,r.viewportWidth,!1),v=i.textareaPadding;v*=2;var y=n.splitTextHandle(s),S=y.beginX,b=y.beginY,C=y.text,_=this.toolInstance.getGraphicsHandle(o);if(_){var T=n.getElementChild(_),E=T[0];T[1].value=C,_.style.cssText="font-size: "+m+"px;font-style:"+(f?"italic":"normal")+";font-weight:"+(g?"bold":"normal")+";left: "+S+"px;top: "+b+"px;color: "+c+";transform: translate("+d+"px, "+l+"px);caret-color:"+c+";";var w=C.split("\n").length;E.innerHTML=C,E.style.cssText="min-height:"+(m+v)+"px;min-width:"+(m+v)+"px;height:"+(w*m+v)+"px;"}},e.prototype.foucsHandle=function(e){this.toolInstance.setDataToGraphicList(e,{selected:!1});var t=this.toolInstance.getBoxHandle(e);t&&(t.style.borderColor="transparent"),this.updatePointerEvents(1,t);var r=this.toolInstance.getGraphicsHandle(e);if(r){var i=n.getElementChild(r)[1];r.style.borderColor="red",this.initMaxSizeHandle(i),this.scrollHeight=i.scrollHeight,i.focus()}},e.prototype.backUpdateGraphicsHandle=function(e){var t=e.graphic_id,r=e.data,i=n.splitTextHandle(r).text,o=this.toolInstance.getGraphicsHandle(t);if(o){var s=n.getElementChild(o),a=s[0];s[1].value=i,a.innerHTML=i;var c=o.getBoundingClientRect(),d=c.width,l=c.height,h=this.toolInstance.getBoxHandle(t);h&&(h.style.cssText+="width:"+d+"px;height:"+l+"px;"),this.toolInstance.setDataToGraphicList(t,{data:r})}},e.prototype.initMaxSizeHandle=function(e){var t=e.getBoundingClientRect(),r=t.left,i=t.top,o=this.calMaxSizeHandle(r,i),n=o.maxWidth,s=o.maxHeight,a=e.previousSibling;a.style.maxHeight=s+"px",a.style.maxWidth=n+"px"},e.prototype.calMaxSizeHandle=function(e,t){var r,i=this.toolInstance,o=i.viewInfo,n=i.whiteboardStore,s=o.viewHeight,a=o.viewWidth,c=o.isScroll,d=o.zoom,l=o.zoomTX,h=o.zoomTY,u=o.offsetPageX,p=o.offsetPageY,g=o.viewportHeight,f=o.viewportWidth,m=o.isOriginScroll,v=this.toolInstance.transLocationHandle({clientX:e,clientY:t}),y=v.clientX,S=v.clientY,b=0;return c?(r=Math.floor(a-(y-u)),b=Math.floor(s-(S-p)),m&&(r-=n.scrollbarSize,b-=n.scrollbarSize)):(r=Math.floor(f-(y-u)+l/d),b=Math.floor(g-(S-p)+h/d)),{maxWidth:r-=2*n.boxBorderWidth,maxHeight:b-=2*n.boxBorderWidth}},e}();t.TextareaGraphics=s},function(e,t,r){"use strict";var i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.Selector=void 0;var o=r(2),n=r(3),s=function(){function e(e){var t=this;this.bindFlag=!1,this.viewTool=o.ViewTool.Selector,this.eventList=[{name:"downEventName",handle:"mousedownHandle"},{name:"moveEventName",handle:"mousemoveHandle"},{name:"upEventName",handle:"mouseupHandle"},{name:"leaveEventName",handle:"mouseleaveHandle"}],this.noMoveUp=!0,this.isWillMove=!1,this.mousedownHandle=function(e){var r=t.toolInstance,s=r._enable,a=r.graphicList,c=r.whiteboardStore,d=r.whiteboardNode,l=c.unSelectedBorderCss,h=c.selectedBorderCss,u=c.moveEventName;if(s&&t.toolInstance.downCommonHandle(e)){var p=t.toolInstance.getCoverHandle(e);if(p){var g=p,f=g.graphic_id,m=g.selected,v=a.filter((function(e){return e.selected})).length;a.forEach((function(e){var r=t.toolInstance.getBoxHandle(e.graphic_id);m?1===v&&e.type===o.ViewTool.Text&&e.graphic_id===f&&(t.noMoveUp=e.graphic_id):e.graphic_id===f?(e.selected=!0,r&&(r.style.border=h)):(e.selected=!1,r&&(r.style.border=l))})),t.isWillMove=!0}else a.forEach((function(e){e.selected=!1;var r=t.toolInstance.getBoxHandle(e.graphic_id);r&&(r.style.border=l)}));var y=t.toolInstance.getMouseStartPoint(e),S=y.clientX,b=y.clientY;t.toolInstance.updateMousePointsHandle([S,b]),t.toolInstance.updateProtoGraphic(i(i({graphic_id:n.createGraphicId()},c.basicState),{x:0,y:0,px:0,py:0,data:[S,b]})),d.addEventListener(u,t.mousemoveHandle)}},this.mousemoveHandle=function(e){var r=t.toolInstance,i=r._enable,o=r.protoGraphic;if(i){t.noMoveUp=!1;var n=t.toolInstance.getMouseChangedPoint(e),s=n.clientX,a=n.clientY;t.isWillMove?t.updateGraphicsOnMoving(s,a):(t.toolInstance.updateGraphicsDataHandle([s,a]),t.drawGraphicsHandle(o,!0))}},this.mouseupHandle=function(){var e=t.toolInstance,r=e._enable,i=e.protoGraphic,s=e.whiteboardStore,a=e.whiteboardNode,c=s.moveEventName;if(r){if(t.noMoveUp&&!0!==t.noMoveUp)try{t.toolInstance.getInstanceHandle(o.ViewTool.Text).foucsHandle(t.noMoveUp)}catch(e){console.log(e)}a.removeEventListener(c,t.mousemoveHandle);var d=t.toolInstance.getGraphicsHandle(i.graphic_id);n.removeElement(d),t.toolInstance.initDrawHandle(),t.isWillMove=!1,t.noMoveUp=!0}},this.mouseleaveHandle=function(){t.toolInstance._enable&&t.mouseupHandle()};var r=e.toolInstance;this.toolInstance=r}return e.prototype.updateGraphicsOnMoving=function(e,t){var r=this;this.toolInstance.updateMousePointsHandle([e,t]);var i=this.toolInstance.calMoveHandle(),n=i[0],s=i[1],a=this.toolInstance.graphicList.filter((function(e){return e.selected}));a.forEach((function(e){r.toolInstance.updateGraphicsOffsetHandle(e,n,s);var t=e.graphic_id,i=e.x,a=e.y,c=e.type;r.toolInstance.moveGraphicsHandle(t,i,a),c!==o.ViewTool.Laser&&r.toolInstance.updateBoxHandle(e)})),this.toolInstance.updateToRemoteHandle(a,o.Action.Move)},e.prototype.drawGraphicsHandle=function(e,t){try{this.toolInstance.getInstanceHandle(o.ViewTool.Line).drawGraphicsRect(e,t,e.color,.3),this.updateBoxBorderOnSelector()}catch(e){console.log(e)}},e.prototype.updateBoxBorderOnSelector=function(){var e=this,t=this.toolInstance,r=t.whiteboardStore,i=t.protoGraphic,n=t.graphicList,s=r.selectedBorderCss,a=r.unSelectedBorderCss,c=this.toolInstance.getGraphicsHandle(i.graphic_id);if(c){var d=c.getBoundingClientRect(),l=d.left,h=d.right,u=d.top,p=d.bottom;n.forEach((function(t){if(t.type!==o.ViewTool.Laser){var r=e.toolInstance.getGraphicsHandle(t.graphic_id),i=e.toolInstance.getBoxHandle(t.graphic_id);if(r){var n=r.getBoundingClientRect(),c=n.left,d=n.right,g=n.top,f=n.bottom;Math.max(l,c)<Math.min(h,d)&&Math.max(u,g)<Math.min(p,f)?(t.selected=!0,i&&(i.style.border=s)):(t.selected=!1,i&&(i.style.border=a))}}}))}},e.prototype.bindEventsHandle=function(){var e=this;if(!this.bindFlag){this.bindFlag=!0;var t=this.toolInstance,r=t.whiteboardStore,i=t.whiteboardNode;this.eventList.forEach((function(t){var o=t.name,n=t.handle;"moveEventName"!==o&&i.addEventListener(r[o],e[n])}))}},e.prototype.removeEventsHandle=function(){var e=this;if(this.bindFlag){this.bindFlag=!1;var t=this.toolInstance,r=t.whiteboardStore,i=t.whiteboardNode;this.eventList.forEach((function(t){var o=t.name,n=t.handle;i.removeEventListener(r[o],e[n])}))}},e}();t.Selector=s},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Eraser=void 0;var i=r(2),o=function(){function e(e){var t=this;this.bindFlag=!1,this.viewTool=i.ViewTool.Eraser,this.eventList=[{name:"moveEventName",handle:"mousemoveHandle"},{name:"upEventName",handle:"mouseupPcHandle"},{name:"upEventName",handle:"mouseupMbHandle"}],this.mousemoveHandle=function(e){var r=t.toolInstance,i=r._enable,o=r.whiteboardStore,n=r.graphicList,s=o.unSelectedBorderCss,a=o.selectedBorderCss;if(i){var c=t.toolInstance.getCoverHandle(e);if(c){var d=c.graphic_id;n.forEach((function(e){var r=t.toolInstance.getBoxHandle(e.graphic_id);e.graphic_id===d?(e.selected=!0,r&&(r.style.border=a)):(e.selected=!1,r&&(r.style.border=s))}))}else n.forEach((function(e){e.selected=!1;var r=t.toolInstance.getBoxHandle(e.graphic_id);r&&(r.style.border=s)}))}},this.mouseupPcHandle=function(){var e=t.toolInstance,r=e._enable,o=e.graphicList;if(r){var n=o.filter((function(e){return!0===e.selected}));n.length&&(n.forEach((function(e){t.toolInstance.deleteHandle(e.graphic_id)})),t.toolInstance.updateToRemoteHandle(n,i.Action.Delete))}},this.mouseupMbHandle=function(e){t.mousemoveHandle(e),t.mouseupPcHandle()};var r=e.toolInstance;this.toolInstance=r}return e.prototype.bindEventsHandle=function(){if(!this.bindFlag){this.bindFlag=!0;var e=this.toolInstance,t=e.whiteboardStore,r=e.whiteboardNode;t.platform===i.Platform.Pc?(r.addEventListener(t.moveEventName,this.mousemoveHandle),r.addEventListener(t.upEventName,this.mouseupPcHandle)):r.addEventListener(t.upEventName,this.mouseupMbHandle)}},e.prototype.removeEventsHandle=function(){var e=this;if(this.bindFlag){this.bindFlag=!1;var t=this.toolInstance,r=t.whiteboardStore,i=t.whiteboardNode;this.eventList.forEach((function(t){var o=t.name,n=t.handle;i.removeEventListener(r[o],e[n])}))}},e}();t.Eraser=o},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WhiteboardStore=void 0;var i=r(2),o=function(){this.reservedPrefix={graphicsBgContainer:"zego-graphics-bg-container",graphicsContainer:"zego-graphics-container",graphicsSvg:"zego-svg",boxContainer:"zego-box-container",graphics:"zego-graphics",textareaCon:"zego-textarea",laserCon:"zego-laser",graphicsBox:"zego-graphics-box",whiteboard:"zego-whiteboard",whiteboardCon:"zego-whiteboard-con",whiteboardZoom:"zego-whiteboard-zoom",laserContainer:"zego-other-container",fileWhiteboardCon:"zego-docsview-con"},this.basicState={type:i.ViewTool.Pen,size:10,fontSize:24,drawSize:0,drawFontSize:0,color:"#0044FF",bgColor:"rgb(241, 243, 244)",scroll:i.ScrollMode.Page,attributes:'{"bold": false, "italic": false}'},this.boxPadding=0,this.textareaPadding=3,this.textareaConBorderWidth=1,this.boxBorderWidth=2,this.selectedBorderCss="2px solid rgba(183,186,194,1)",this.unSelectedBorderCss="2px solid transparent",this.maxlength=200,this.scrollbarSize=20,this.initLaserX=0,this.initLaserY=0,this.hiddenLaserX=-100,this.hiddenLaserY=-100,this.hiddenLaserDelay=5e3,this.wheelEventName="wheel",navigator.userAgent.match(/Android|BlackBerry|iPhone|iPad|iPod|Opera Mini|IEMobile/i)?(this.platform=2,this.downEventName="touchstart",this.upEventName="touchend",this.moveEventName="touchmove",this.leaveEventName=""):(this.platform=1,this.downEventName="mousedown",this.upEventName="mouseup",this.moveEventName="mousemove",this.leaveEventName="mouseleave")};t.WhiteboardStore=o},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WhiteboardError=void 0;var i=function(){function e(){this.CODES={ZegoWhiteboardViewErrorInternal:3000001,ZegoWhiteboardViewErrorParamInvalid:3000002,ZegoWhiteboardViewErrorNetworkTimeout:3000003,ZegoWhiteboardViewErrorNetworkDisconnect:3000004,ZegoWhiteboardViewErrorInvalidRsp:3000005,ZegoWhiteboardViewErrorRequestTooMany:3000006,ZegoWhiteboardViewErrorNoLoginRoom:3010001,ZegoWhiteboardViewErrorUserNotExist:3010002,ZegoWhiteboardViewErrorViewNotExist:3020001,ZegoWhiteboardViewErrorViewCreateFail:3020002,ZegoWhiteboardViewErrorViewModifyFail:3020003,ZegoWhiteboardViewErrorViewNameLimit:3020004,ZegoWhiteboardViewErrorViewParentNotExist:3020005,ZegoWhiteboardViewErrorViewNumLimit:3020006,ZegoWhiteboardViewErrorGraphicNotExist:3030001,ZegoWhiteboardViewErrorGraphicCreateFail:3030002,ZegoWhiteboardViewErrorGraphicModifyFail:3030003,ZegoWhiteboardViewErrorGraphicUnableDraw:3030004,ZegoWhiteboardViewErrorGraphicDataLimit:3030005,ZegoWhiteboardViewErrorGraphicNumLimit:3030006,ZegoWhiteboardViewErrorGraphicTextLimit:3030007,ZegoWhiteboardViewErrorInitFail:3040001,ZegoWhiteboardViewErrorGetListFail:3040002,ZegoWhiteboardViewErrorCreateFail:3040003,ZegoWhiteboardViewErrorDestroyFail:3040004,ZegoWhiteboardViewErrorAttachFail:3040005,ZegoWhiteboardViewErrorClearFail:3040006,ZegoWhiteboardViewErrorScrollFail:3040007,ZegoWhiteboardViewErrorUndoFail:3040008,ZegoWhiteboardViewErrorRedoFail:3040009},this.interfaceCodeData={3000001:"内部错误",3000002:"参数错误",3000003:"网络超时",3000004:"网络断开",3000005:"网络回包错误",3000006:"请求过于频繁",3010001:"未登录房间",3010002:"用户不存在",3020001:"白板view不存在",3020002:"创建白板view失败",3020003:"修改白板view失败",3020004:"白板view名称过长",3020005:"白板view的parent不存在",3020006:"超过白板最大数量限制",3030001:"图元不存在",3030002:"创建图元错误",3030003:"修改图元错误",3030004:"未开启绘制",3030005:"图元数据大小超过限制",3030006:"超过图元最大数量限制",3030007:"文本字数超过上限",3040001:"初始化失败",3040002:"拉取白板view列表失败",3040003:"创建白板view失败",3040004:"销毁白板view失败",3040005:"attach白板view失败",3040006:"清空白板view失败",3040007:"滚动白板view失败",3040008:"撤销操作失败",3040009:"重做操作失败"},this.sdkCodeMap={1003:112001003,1014:112001014,1101:112001101,1102:112001102,1104:112001104,1114:112001114,1212:112001212,1201:112001201,1202:112001202,1219:112001219,1217:112001217,1222:112001222,1223:112001223},this.viewCodeMap={10001e3:3000001,10001001:3000002,111001002:3000003,111001001:3000004,60003001:3000005,111101001:3000006,112001003:3010001,112001014:3010002,112001101:3020001,112001102:3020002,112001104:3020003,112001114:3020006,112001212:3030002,112001201:3030003,112001202:3030003,112001219:3030003,112001217:3030005,112001222:3030005,112001223:3030006}}return e.prototype.transError=function(e,t){var r=this.viewCodeMap[e],i=this.sdkCodeMap[e];return i&&(r=this.viewCodeMap[i]),r?{code:r,msg:t=t||this.interfaceCodeData[r]}:{code:e,msg:t=t||this.interfaceCodeData[e]||""}},e}();t.WhiteboardError=i},function(e,t,r){"use strict";var i,o=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),n=this&&this.__assign||function(){return(n=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},s=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))((function(o,n){function s(e){try{c(i.next(e))}catch(e){n(e)}}function a(e){try{c(i.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__generator||function(e,t){var r,i,o,n,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return n={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function a(n){return function(a){return function(n){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,i&&(o=2&n[0]?i.return:n[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,n[1])).done)return o;switch(i=0,o&&(n=[2&n[0],o.value]),n[0]){case 0:case 1:o=n;break;case 4:return s.label++,{value:n[1],done:!1};case 5:s.label++,i=n[1],n=[0];continue;case 7:n=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==n[0]&&2!==n[0])){s=0;continue}if(3===n[0]&&(!o||n[1]>o[0]&&n[1]<o[3])){s.label=n[1];break}if(6===n[0]&&s.label<o[1]){s.label=o[1],o=n;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(n);break}o[2]&&s.ops.pop(),s.trys.pop();continue}n=t.call(e,s)}catch(e){n=[6,e],i=0}finally{r=o=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,a])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.WhiteboardService=void 0;var c,d,l,h=r(78),u=r(2),p=r(3),g=r(79),f=r(5),m=f.getLogAction.bind(null,"wb.s.");!function(e){e[e.Initiative=1]="Initiative",e[e.Inner=2]="Inner"}(c||(c={})),function(e){e[e.InProgress=1]="InProgress",e[e.Pending=2]="Pending",e[e.Resolve=3]="Resolve",e[e.Reject=4]="Reject"}(d||(d={})),function(e){e[e.success=1]="success",e[e.error=2]="error"}(l||(l={}));var v=function(e){function t(t){var r=e.call(this,"web",t.whiteboardError)||this;r.modIdMapData={},r.listenerList={},r.graphicLimit=100,r.modLimit=50,r.doTaskSeq=0;var i=t.stateCenter,o=t.socketCenter;return r.stateCenter=i,r.socketCenter=o,r.modListSeq=0,r}return o(t,e),t.prototype.reverseGraphicList=function(e){if(!e||!e.length)return[];var t=JSON.parse(JSON.stringify(e)),r=t[0].action;return t.forEach((function(e){switch(r){case u.Action.Create:e.action=u.Action.Delete;break;case u.Action.Delete:e.action=u.Action.Create;break;case u.Action.Move:e.x=e.px,e.y=e.py;break;case u.Action.Update:e.data=e.oldData}})),t},t.prototype.transModInfo=function(e,t){var r={room_id:""},i={ar_w:1,ar_h:1,x:0,y:0,w:0,h:0,z:0};if(e){var o=JSON.parse(e),n=o.file_info;n&&(o.file_info={fileID:n.file_id,fileName:n.file_name,fileType:+n.file_type,authKey:n.auth_key}),r=o}return t&&(i=JSON.parse(t)),{modContent:r,modPos:i}},t.prototype.createModInfo=function(e){var t={room_id:e.roomID};if(e.fileInfo){var r=e.fileInfo,i=r.fileID,o=r.fileName,n=r.fileType,s=r.authKey;t.file_info={file_id:i,file_name:o,file_type:n,auth_key:s}}return e.pageCount&&(t.whiteboard_page_count=e.pageCount),{modContent:t,modPos:{x:0,y:0,w:0,h:0,z:0,ar_w:e.aspectWidth,ar_h:e.aspectHeight}}},t.prototype.getModHeader=function(){return{sdk_version:1,id_name:this.stateCenter.idName}},t.prototype.getModInfo=function(e){var t=this;return new Promise((function(r,i){t.queueWSCmdHandler("/eduv1/get_mod","/eduv1/get_mod",{header:t.getModHeader(),body:JSON.stringify({mod_id_list:e})},(function(e){t.handleGetModInfoRsp(e,r,i)}))}))},t.prototype.posToPageNum=function(e,t,r,i,o,n,s){var a=r.cx,c=r.cy,d=0;return a&&c&&(i+=n,o+=s,d=(d=(d=e===u.Direction.Horizontal?i<=0?0:Math.floor(i/a):o<=0?0:Math.floor(o/c))>t-1?t-1:d)>99?99:d),d},t.prototype.mapPageNumList=function(e){for(var t=[],r=Math.min.apply(Math,e),i=Math.max.apply(Math,e),o=r;o<=i;o++)t.push(o);return t},t.prototype.judgeGraphicPage=function(e,t){var r=this,i=this.getMap(e),o=i.innerDirection,n=i.innerPageSize,s=i.innerPageCount,a=[],c=t.type,d=t.data,l=t.x,h=t.y;switch(c){case u.ViewTool.Text:var g=p.splitTextHandle(d),f=g.beginX,m=g.beginY,v=this.posToPageNum(o,s,n,Number(f),Number(m),l,h);a=this.mapPageNumList([v]);break;case u.ViewTool.Pen:var y=[];d.forEach((function(e,t,i){t%2||y.push(r.posToPageNum(o,s,n,i[t],i[t+1],l,h))})),a=this.mapPageNumList(y);break;case u.ViewTool.Line:case u.ViewTool.Rect:case u.ViewTool.Ellipse:var S=d,b=S[0],C=S[1],_=S[2],T=S[3],E=this.posToPageNum(o,s,n,b,C,l,h),w=this.posToPageNum(o,s,n,_,T,l,h);a=this.mapPageNumList([E,w]);break;case u.ViewTool.Laser:var L=d,I=L[0],R=L[1],M=this.posToPageNum(o,s,n,I,R,l,h);a=this.mapPageNumList([M])}return a},t.prototype.checkProtoGraphic=function(e){var t=e.action,r=e.action_type,i=e.graphic_id,o=e.type,n=e.data,s=e.color,a=e.size,c=e.x,d=e.y,l=e.attributes,h={action:t,action_type:r,graphic_id:i,type:o};switch(t){case u.Action.Create:h.attributes=l;case u.Action.Update:h.data=n,h.color=s,h.size=a,h.x=c,h.y=d,h.attributes=l;break;case u.Action.Delete:break;case u.Action.Move:h.x=c,h.y=d}return h},t.prototype.mapDrawPages=function(e,t){var r=this,i=JSON.parse(JSON.stringify(t)),o=this.getMap(e),n=o.graphicListSeqs,s=[],a=[];i.forEach((function(t){var i=r.judgeGraphicPage(e,t);delete t.oldData,p.transColor(t,!1),p.calPlaceHandle(t,o.viewWidth,!1),p.transData(t,!1),t=r.checkProtoGraphic(t),i.forEach((function(e){a.includes(e)||a.push(e);var r=n[e];s.push({page:e,graphic_list_seq:r,draw_list:[t]})}))}));var c=[];return a.forEach((function(e){var t={page:e,draw_list:[]};s.forEach((function(r){r.page===e&&(t.draw_list=t.draw_list.concat(r.draw_list),t.graphic_list_seq=r.graphic_list_seq)})),c.push(t)})),c},t.prototype.splitPage=function(e,t,r){var i=this.getMap(e);if(i&&t&&r){var o=1,n=0,s=0;t>=r?(n=s=r,(o=Math.ceil(t/r))>100&&(n=Math.ceil(t/99),o=100),i.innerDirection=u.Direction.Horizontal):(s=n=t,(o=Math.ceil(r/t))>100&&(s=Math.ceil(r/99),o=100),i.innerDirection=u.Direction.Vertical),i.innerPageCount=o;for(var a=0;a<o;a++)i.graphicListSeqs[a]=0,i.pullMarks[a]=!1;i.innerPageSize.cx=n,i.innerPageSize.cy=s,f.Logger.info(m("mod.split_page"),JSON.stringify({whiteboardID:e,viewWidth:t,viewHeight:r,innerPageCx:n,innerPageCy:s,innerPageCount:o}))}},t.prototype.getRoom=function(){this.queueWSCmdHandler("/eduv1/get_room","/eduv1/get_room",{header:this.getModHeader(),body:""},void 0)},t.prototype.actionListener=function(e){for(var t,r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];this.listenerList[e]&&(t=this.listenerList)[e].apply(t,r)},t.prototype.bindListener=function(e,t){this.listenerList[e]=t},t.prototype.updateMap=function(e){var t=this.getMap(e.whiteboardID);if(t){var r=e.modPropSeq;r&&Object.assign(t.modPropSeq,r),delete e.modPropSeq,Object.assign(t,e)}else this.modIdMapData[e.whiteboardID]=n({graphicListSeqs:{0:0},pullMarks:{0:!1},modSeq:0,undoList:[],redoList:[],viewWidth:0,viewHeight:0,viewportWidth:0,viewportHeight:0,innerPageCount:1,innerDirection:u.Direction.Horizontal,innerPageSize:{cx:0,cy:0},modType:1,modSubtype:1,operateTimes:0,inProgress:!1,modSendSwitch:!0,graphicSendSwitch:!0,modifyModTaskList:[],moveTaskList:[]},e)},t.prototype.getMap=function(e){return this.modIdMapData[e]},t.prototype.deleteMap=function(e){delete this.modIdMapData[e]},t.prototype.getModPropSeq=function(e){return this.modIdMapData[e].modPropSeq},t.prototype.updateMapByMod=function(e){var t=e.mod_content,r=e.mod_pos,i=this.transModInfo(t,r),o=i.modContent,n=i.modPos;this.updateMap({whiteboardID:e.mod_id,name:e.mod_title,aspectWidth:n.ar_w,aspectHeight:n.ar_h,roomID:o.room_id,fileInfo:Object.freeze(o.file_info),createTime:e.mod_create_time?+e.mod_create_time:0,horizontalPercent:e.mod_horizontal_percent,verticalPercent:e.mod_vertical_percent,pptStep:e.mod_reserve,modType:e.mod_type,modSubtype:e.mod_subtype,modSeq:e.mod_seq,outPageCount:o.whiteboard_page_count,modPropSeq:{mod_title:e.mod_seq,mod_type:e.mod_seq,mod_subtype:e.mod_seq,mod_pos:e.mod_seq,mod_status:e.mod_seq,mod_content:e.mod_seq,mod_extra:e.mod_seq,mod_reserve:e.mod_seq,mod_delete_flag:e.mod_seq,mod_horizontal_percent:e.mod_seq,mod_vertical_percent:e.mod_seq}})},t.prototype.updateMapByModifyModOption=function(e,t,r){var i=e.mod_id,o=e.mod_title,n=e.mod_horizontal_percent,s=e.mod_vertical_percent,a=e.mod_reserve,c=e.is_modify_mod_horizontal_percent,d=e.is_modify_mod_vertical_percent,l=e.is_modify_mod_reserve,h=e.is_modify_mod_title,u=this.getModPropSeq(i),p=u.mod_horizontal_percent,g=u.mod_vertical_percent,v=u.mod_reserve,y=u.mod_title,S=this.getMap(i),b={isPushScroll:!1,horizontalPercent:S.horizontalPercent,verticalPercent:S.verticalPercent,pptStep:S.pptStep};if(c&&t>p){b.isPushScroll=!0,b.horizontalPercent=+n;var C={whiteboardID:i,horizontalPercent:b.horizontalPercent,modPropSeq:{mod_horizontal_percent:t}};f.Logger.info(m("mod.update_h_percent"),JSON.stringify(C)),this.updateMap(C)}if(d&&t>g){b.isPushScroll=!0,b.verticalPercent=+s,b.pptStep=+a;var _={whiteboardID:i,verticalPercent:b.verticalPercent,pptStep:b.pptStep,modPropSeq:{mod_vertical_percent:t}};f.Logger.info(m("mod.update_v_percent"),JSON.stringify(_)),this.updateMap(_)}if(l&&t>v){b.isPushScroll=!0,b.pptStep=+a;var T={whiteboardID:i,pptStep:b.pptStep,modPropSeq:{mod_reserve:t}};f.Logger.info(m("mod.update_step"),JSON.stringify(T)),this.updateMap(T)}if(h&&t>y){var E={whiteboardID:i,name:o,modPropSeq:{mod_title:t}};f.Logger.info(m("mod.update_name"),JSON.stringify(E)),this.updateMap(E)}b.isPushScroll&&r&&this.pushScrollHandle(i,b.horizontalPercent,b.verticalPercent,b.pptStep)},t.prototype.updateMapByGraphicListSeqs=function(e,t){var r=this.getMap(e).graphicListSeqs,i=t.graphicListSeqs;t.pages.forEach((function(e,t){r[e]=i[t]}))},t.prototype.getPopDoTaskIndex=function(e){var t=e.length-1,r=0;return e.forEach((function(e,i){r<e.seq&&(t=i,r=e.seq)})),t},t.prototype.getUndoHandle=function(e){var t=this.modIdMapData[e];return t.undoList[this.getPopDoTaskIndex(t.undoList)]},t.prototype.addUndoHandle=function(e,t){this.modIdMapData[e].undoList.push({seq:this.doTaskSeq+=1,data:t})},t.prototype.deleteUndoHandle=function(e){var t=this.modIdMapData[e];t.undoList.splice(this.getPopDoTaskIndex(t.undoList),1)},t.prototype.getRedoHandle=function(e){var t=this.modIdMapData[e];return t.redoList[this.getPopDoTaskIndex(t.redoList)]},t.prototype.addRedoHandle=function(e,t){this.modIdMapData[e].redoList.push({seq:this.doTaskSeq+=1,data:t})},t.prototype.deleteRedoHandle=function(e){var t=this.modIdMapData[e];t.redoList.splice(this.getPopDoTaskIndex(t.redoList),1)},t.prototype.setInProgress=function(e,t){this.modIdMapData[e].inProgress=t},t.prototype.getInProgress=function(e){return this.modIdMapData[e].inProgress},t.prototype.setModSendSwitch=function(e,t){this.modIdMapData[e].modSendSwitch=t},t.prototype.getModSendSwitch=function(e){var t=this.modIdMapData[e];return!t||t.modSendSwitch},t.prototype.setGraphicSendSwitch=function(e,t){this.modIdMapData[e].graphicSendSwitch=t},t.prototype.getGraphicSendSwitch=function(e){var t=this.modIdMapData[e];return!t||t.graphicSendSwitch},t.prototype.clearPullMarks=function(e){var t=this;f.Logger.info(m("mod.clear_pull_mark"),"init pull mark");var r=e?[e]:Object.keys(this.modIdMapData);Object.values(r).forEach((function(e){var r=t.modIdMapData[e];Object.keys(r.pullMarks).forEach((function(e){r.pullMarks[+e]=!1}))}))},t.prototype.moveSendBefore=function(e,t){var r=this.getGraphicSendSwitch(e);return this.setGraphicSendSwitch(e,!1),this.updateMoveTaskList(e,{data:t,status:r?d.InProgress:d.Pending}),r},t.prototype.moveSendAfter=function(e,t,r){this.setGraphicSendSwitch(e,!0);var i=this.getMap(e).moveTaskList.filter((function(e){return e.status===d.Pending}))[0];i&&(f.Logger.info(m("gra.local_move_cache_handle"),JSON.stringify(i)),this.updateToRemote(e,i.data,r))},t.prototype.mergeGraphicList=function(e,t){t.forEach((function(t){var r=e.findIndex((function(e){return e.graphic_id===t.graphic_id}));-1===r?e.push(t):e.splice(r,1,t)}))},t.prototype.updateMoveTaskList=function(e,t){f.Logger.info(m("gra.move_task_update"),JSON.stringify(n({whiteboardID:e},t)));var r=this.getMap(e),i=t.status,o=t.data;if(i===d.InProgress)r.moveTaskList.splice(0,r.moveTaskList.length,t);else{var s=r.moveTaskList.findIndex((function(e){return e.status===d.Pending}));-1===s?r.moveTaskList.push(t):this.mergeGraphicList(r.moveTaskList[s].data,o)}},t.prototype.updateModifyModTaskList=function(e){f.Logger.info(m("mod.modify_task_update"),JSON.stringify(e));var t=e.data.mod_id,r=this.getMap(t),i=e.status,o=e.push;if(i===d.InProgress)r.modifyModTaskList.splice(0,r.modifyModTaskList.length,e);else if(o)r.modifyModTaskList.push(e);else{var n=r.modifyModTaskList.findIndex((function(e){return e.push===o&&e.status===d.Pending}));-1===n?r.modifyModTaskList.push(e):Object.assign(r.modifyModTaskList[n].data,e.data)}},t.prototype.modifyModSendBefore=function(e){var t=e.mod_id,r=this.getModSendSwitch(t);this.setModSendSwitch(t,!1);var i={data:e,push:!1,status:r?d.InProgress:d.Pending};return this.updateModifyModTaskList(i),r},t.prototype.cachePushModifyModTaskHandle=function(e){var t=this;f.Logger.info(m("mod.remote_modify_cache_handle"),JSON.stringify(e)),e.forEach((function(e){var r=e.pushModSeq,i=e.data,o=i.mod_id;r>t.getMap(o).modSeq&&(f.Logger.info(m("mod.update_seq"),JSON.stringify({whiteboardID:o,modSeq:r})),t.updateMap({modSeq:r,whiteboardID:o})),t.updateMapByModifyModOption(i,r,!0)}))},t.prototype.modifyModRspAfter=function(e,t){var r=t.modifyModOption,i=t.success,o=t.error,n=t.errorData,s=r.mod_id,a=this.getMap(s).modifyModTaskList,c=a.filter((function(e){return!e.push&&e.status===d.Pending}))[0];if(this.cachePushModifyModTaskHandle(a.filter((function(e){return e.push}))),c)f.Logger.info(m("mod.local_modify_cache_handle"),JSON.stringify(c)),this.setModSendSwitch(s,!0),this.setMod(c.data,i,o);else{if(1===e)f.Logger.info(m("mod.modify_cb"),JSON.stringify({whiteboardID:s})),i(s);else{var l=this.getOldModInfoByModifyModOption(r);f.Logger.error(m("mod.modify_cb"),JSON.stringify({errorData:n,backModInfo:l})),o(n,l)}this.setModSendSwitch(s,!0)}},t.prototype.getOldModInfoByModifyModOption=function(e){var t={};return Object.keys(e).forEach((function(r){r.includes("mod_id")||r.includes("is_modify_mod")||(t[r]=e[r])})),t},t.prototype.checkScroll=function(e,t,r,i){var o=this.getMap(e);if(o){var n=o.horizontalPercent,s=o.verticalPercent,a=o.pptStep,c=!1,d={mod_id:e};return t!==n&&(d.mod_horizontal_percent=t,d.is_modify_mod_horizontal_percent=!0,c=d),r===s&&i===a||(d.mod_vertical_percent=r,d.is_modify_mod_vertical_percent=!0,d.mod_reserve=i,d.is_modify_mod_reserve=!0,c=d),c}return!1},t.prototype.getModName=function(e){var t=this.getMap(e);return t?t.name:""},t.prototype.getUserName=function(){return this.stateCenter.idName},t.prototype.getCreateTime=function(e){var t=this.getMap(e);return t?t.createTime:0},t.prototype.getRoomID=function(e){var t=this.getMap(e);return t?t.roomID:""},t.prototype.getPageCount=function(e){var t=this.getMap(e);return t?t.outPageCount:1},t.prototype.setSize=function(e,t,r){var i=this.getMap(e);return!!(i&&t&&r)&&(i.viewHeight=r,i.viewWidth=t,f.Logger.info(m("mod.set_view_size"),JSON.stringify({whiteboardID:e,viewWidth:t,viewHeight:r})),this.splitPage(e,t,r),!0)},t.prototype.setViewportSize=function(e,t,r){var i=this.getMap(e);return!!(i&&t&&r)&&(f.Logger.info(m("mod.set_viewpoart_size"),JSON.stringify({whiteboardID:e,viewportWidth:t,viewportHeight:r})),i.viewportHeight=r,i.viewportWidth=t,!0)},t.prototype.undo=function(e,t,r){var i=this;if(!this.getInProgress(e)){var o=this.getUndoHandle(e);if(o){var n=this.reverseGraphicList(o.data),s=t({graphicList:n,doTaskSeq:o.seq}),a=this.reverseGraphicList(n);s.graphicList.length?this.updateToRemoteHandle(e,s.graphicList,(function(){i.deleteUndoHandle(e),i.addRedoHandle(e,a)}),(function(){r(a)})):(f.Logger.info(m("gra.draw"),"empty"),this.deleteUndoHandle(e),this.addRedoHandle(e,a))}}},t.prototype.redo=function(e,t,r){var i=this;if(!this.getInProgress(e)){var o=this.getRedoHandle(e);o&&(t(JSON.parse(JSON.stringify(o.data))),o.data.length?this.updateToRemoteHandle(e,o.data,(function(){i.deleteRedoHandle(e),i.addUndoHandle(e,o.data)}),(function(){r(i.reverseGraphicList(o.data))})):(f.Logger.info(m("gra.draw"),"empty"),this.deleteRedoHandle(e),this.addUndoHandle(e,o.data)))}},t.prototype.createMod=function(e,t,r){var i=this,o=this.createModInfo(e),n=o.modContent,s=o.modPos,a={mod_id:p.createGraphicId(),mod_title:e.name,mod_subtype:1,mod_type:1,mod_delete_flag:0,mod_content:JSON.stringify(n),mod_horizontal_percent:0,mod_vertical_percent:0,mod_reserve:1,mod_pos:JSON.stringify(s)};f.Logger.info(m("mod.create"),JSON.stringify({params:a})),this.queueWSCmdHandler("/eduv1/create_mod","/eduv1/create_mod",{header:this.getModHeader(),body:JSON.stringify(a)},(function(e){return i.handleCreateModRsp(e,t,r)}))},t.prototype.setMod=function(e,t,r){var i=this,o=e.mod_id;this.modifyModSendBefore(e)&&this.queueWSCmdHandler("/eduv1/modify_mod","/eduv1/modify_mod",{header:this.getModHeader(),body:JSON.stringify(n({mod_seq:this.getMap(o).modSeq},e))},(function(o){i.handleSetModRsp(e,o,t,r)}))},t.prototype.destroyMod=function(e,t,r){var i=this;this.queueWSCmdHandler("/eduv1/destroy_mod","/eduv1/destroy_mod",{header:this.getModHeader(),body:JSON.stringify({mod_id:e})},(function(e){i.handleDestroyModRsp(e,t,r)}))},t.prototype.clearView=function(e,t,r){var i=this;this.queueWSCmdHandler("/eduv1/clear_page_graphics","/eduv1/clear_page_graphics",{header:this.getModHeader(),body:JSON.stringify({mod_id:e})},(function(o){i.handleClearRsp(o,e,t,r)}))},t.prototype.updateToRemote=function(e,t,r){var i=this,o=t[0],n=o.type,s=o.action;if(o.action===u.Action.Move&&!this.moveSendBefore(e,t))return;this.updateToRemoteHandle(e,t,(function(){n!==u.ViewTool.Laser&&i.addUndoHandle(e,t),s===u.Action.Move&&i.moveSendAfter(e,l.success,r)}),(function(){var o=i.reverseGraphicList(t);s===u.Action.Move&&i.moveSendAfter(e,l.error,r),r(o)}))},t.prototype.updateToRemoteHandle=function(e,t,r,i){var o=this;this.setInProgress(e,!0);var n=this.mapDrawPages(e,t);f.Logger.info(m("gra.draw"),JSON.stringify(n)),this.queueWSCmdHandler("/eduv1/draw_page_graphics","/eduv1/draw_page_graphics",{header:this.getModHeader(),body:JSON.stringify({mod_id:e,draw_pages:n})},(function(t){o.handleUpdateToRemoteRsp(e,t,r,i)}))},t.prototype.getModList=function(e,t,r){var i=this;this.queueWSCmdHandler("/eduv1/get_mod_list","/eduv1/get_mod_list",{header:this.getModHeader(),body:JSON.stringify({mod_list_seq:0,limit:this.modLimit,marker:"",mod_type:1})},(function(o){i.handleGetModListRsp(e,o,t,r)}))},t.prototype.scroll=function(e,t,r,i,o,n){var s=this.checkScroll(e,t,r,i);if(s){var a=s,c=a.mod_horizontal_percent,d=a.mod_vertical_percent,l=a.mod_reserve;this.setMod(s,(function(e){return o&&o(e)}),(function(t,r){n&&n(e,c,d,l)}))}},t.prototype.reload=function(){f.Logger.info(m("reload"),"reload whiteboard"),this.clearPullMarks(),this.getModList(c.Inner)},t.prototype.loadCurrentGraphics=function(e,t,r){for(var i=this.getCurrentPages(e,t,r),o=i.minPage,n=i.maxPage,s=this.getMap(e),a=[],c=o;c<=n;c++){!s.pullMarks[c]&&a.push(c)}f.Logger.info(m("gra.load_by_percent"),JSON.stringify({horizontalPercent:t,verticalPercent:r,minPage:o,maxPage:n,pageNumList:a})),a.length&&this.getPageGraphicsList(e,a)},t.prototype.getScrollPercent=function(e){var t=this.getMap(e);return{horizontalPercent:t.horizontalPercent,verticalPercent:t.verticalPercent,pptStep:t.pptStep}},t.prototype.getAspectRatio=function(e){var t=this.getMap(e);return t.aspectWidth+":"+t.aspectHeight},t.prototype.getFileInfo=function(e){var t=this.getMap(e);return t&&t.fileInfo||null},t.prototype.getCurrentPages=function(e,t,r){var i,o,n=this.getMap(e),s=n.viewWidth,a=n.viewHeight,c=n.innerPageSize,d=n.viewportWidth,l=n.viewportHeight;return n.innerDirection===u.Direction.Horizontal?(i=Math.floor(s*t/c.cx),o=Math.floor((d+s*t)/c.cx)):(i=Math.floor(a*r/c.cy),o=Math.floor((l+a*r)/c.cy)),{minPage:i,maxPage:o=o>99?99:o>=n.innerPageCount?n.innerPageCount-1:o}},t.prototype.getPageGraphicsList=function(e,t,r){var i=this;if(f.Logger.info(m("gra.get_list"),JSON.stringify({whiteboardID:e,pages:t,graphicListSeqs:r})),!r){var o=this.getMap(e).graphicListSeqs;r=t.map((function(e){return o[e]}))}this.queueWSCmdHandler("/eduv1/get_page_graphics","/eduv1/get_page_graphics",{header:this.getModHeader(),body:JSON.stringify({mod_id:e,pages:t,graphic_list_seqs:r,limit:this.graphicLimit})},(function(t){i.handleGetPageGraphicsListRsp(e,t)}))},t.prototype.onRemotePush=function(){var e=this;this.queueWSCmdHandler(null,"biz_channel",null,(function(t,r){switch(r){case g.PushType.DrawPageGraphics:e.pushDrawPageGraphicsHandle(t);break;case g.PushType.SetMod:e.pushSetModHandle(t);break;case g.PushType.ClearPageGraphics:e.pushClearPageGraphicsHandle(t)}}))},t.prototype.sendWbMessage=function(e,t,r,i){t&&"string"==typeof t&&(e||this.socketCenter.registerRouter("push_biz_channel",(function(e){var t=e.body.req_body;try{var r=JSON.parse(t).msg_body,o=JSON.parse(r),n=g.PushType.ClearPageGraphics;o.page_graphics?n=g.PushType.DrawPageGraphics:o.action_list&&(n=g.PushType.SetMod),i(o,n)}catch(e){console.error(e),i({},0)}})),e&&r&&"string"==typeof e&&this.socketCenter.sendMessage("biz_channel",r,(function(e,t,r){try{(r=JSON.parse(r)).body=r.body?JSON.parse(r.body):{},i(r)}catch(e){console.error(e)}}),(function(e,t,r,o){try{if("[object Object]"===Object.prototype.toString.call(e))i({header:{code:e.code,message:e.msg,headerSeq:t}});else{var n=JSON.parse(r).header,s=n.code,a=n.message;i({header:{code:s,message:a,headerSeq:t}})}}catch(e){i({header:{code:3000001,message:"内部错误",headerSeq:t}})}})))},t.prototype.queueWSCmdHandler=function(e,t,r,i){var o=this;return new Promise((function(n,s){try{if("/eduv1/draw_page_graphics"===e&&r&&r.body.length>=4800){var a={header:{code:3030005,message:"图元数据大小超过限制"}};return n(a),void(i&&i(a))}var c={channel:"edu",cmd:e,req_body:JSON.stringify(r)};o.sendWbMessage(e,t,c,(function(e,t){n(e,t),i&&i(e,t)}))}catch(e){s(e)}}))},t.prototype.handleCreateModRsp=function(e,t,r){return s(this,void 0,void 0,(function(){var i,o,n,s,c,d,l,h,u;return a(this,(function(a){switch(a.label){case 0:return i=e.header,o=e.body,n=i.code,s=i.message,0!==n?[3,2]:(c=o.mod_list_seq,d=o.mod_id,this.modListSeq=c,f.Logger.info(m("mod.update_seq"),JSON.stringify({modListSeq:c,actionMsg:"create cb success"})),[4,this.getModInfo([d])]);case 1:return l=a.sent(),h=l[0],this.updateMapByMod(h),t(h.mod_id),[3,3];case 2:u=this.whiteboardError.transError(n,s),f.Logger.error(m("mod.create_cb"),JSON.stringify(u)),r(u),a.label=3;case 3:return[2]}}))}))},t.prototype.handleGetModInfoRsp=function(e,t,r){var i=e.header,o=e.body,n=i.code,s=i.message;if(0===n){var a=o.mod_list;f.Logger.info(m("mod.get_info_cb"),"success"),t(a)}else{var c=this.whiteboardError.transError(n,s);f.Logger.error(m("mod.get_info_cb"),JSON.stringify(c)),r(c)}},t.prototype.handleSetModRsp=function(e,t,r,i){var o=t.header,n=t.body,s=o.code,a=o.message;if(0===s){var c=n.mod_list_seq,d=n.mod_seq,h=n.mod_id;this.modListSeq=c,f.Logger.info(m("mod.update_seq"),JSON.stringify({whiteboardID:h,modListSeq:c,modSeq:d})),this.updateMap({whiteboardID:h,modSeq:d}),this.updateMapByModifyModOption(e,d,!1),this.modifyModRspAfter(l.success,{modifyModOption:e,success:r,error:i})}else this.modifyModRspAfter(l.error,{modifyModOption:e,success:r,error:i,errorData:this.whiteboardError.transError(s,a)})},t.prototype.handleDestroyModRsp=function(e,t,r){var i=e.header,o=e.body,n=i.code,s=i.message;if(0===n){var a=o.mod_list_seq,c=o.mod_id;this.modListSeq=a,f.Logger.info(m("mod.update_seq"),JSON.stringify({modListSeq:a,actionMsg:"destroy cb success"})),this.deleteMap(c),t(c)}else{var d=this.whiteboardError.transError(n,s);f.Logger.error(m("mod.destroy_cb"),JSON.stringify(d)),r(d)}},t.prototype.handleClearRsp=function(e,t,r,i){var o=e.header,s=e.body,a=o.code,c=o.message;if(0===a){r();var d={pages:s.pages,graphicListSeqs:s.graphic_list_seqs};f.Logger.info(m("gra.update_seq"),JSON.stringify(n(n({whiteboardID:t},d),{actionMsg:"clear cb success"}))),this.updateMapByGraphicListSeqs(s.mod_id,d),this.updateMap({whiteboardID:s.mod_id,undoList:[],redoList:[],operateTimes:0})}else{var l=this.getMap(t);if(l&&++l.operateTimes<5)this.clearView(t,r,i);else{var h=this.whiteboardError.transError(a,c);f.Logger.error(m("mod.clear_cb"),JSON.stringify(h)),i(h)}}},t.prototype.compareHandle=function(e,t){var r=this;f.Logger.info(m("mod.compare"),"compare local with server");var i=Object.keys(this.modIdMapData),o=[];return t.sort((function(e,t){return t.mod_create_time-e.mod_create_time})),t.forEach((function(t){var n=t.mod_id,s=t.mod_horizontal_percent,a=t.mod_vertical_percent,d=t.mod_reserve;if(o.push(n),-1===i.indexOf(n))e===c.Inner?r.pushAddMod(t):r.updateMapByMod(t);else{var l=r.getMap(n),h=l.horizontalPercent,u=l.verticalPercent,p=l.pptStep;r.updateMapByMod(t),h===s&&u===a&&d===p||r.pushScrollHandle(n,s,a,d)}})),i.forEach((function(i){-1===t.findIndex((function(e){return e.mod_id===i}))&&(e===c.Inner?r.pushRemovedMod(i):r.deleteMap(i))})),o},t.prototype.handleGetModListRsp=function(e,t,r,i){var o=t.header,n=t.body,s=o.code,a=o.message;if(0===s){var d=n.mod_list_seq,l=n.mod_list;this.modListSeq=d,f.Logger.info(m("mod.update_seq"),JSON.stringify({modListSeq:d,actionMsg:"get list cb success"}));var h=this.compareHandle(e,l||[]);e===c.Initiative&&r&&r(h)}else{var u=this.whiteboardError.transError(s,a);f.Logger.error(m("mod.get_list_cb"),JSON.stringify(u)),i&&i(u)}},t.prototype.handleGetPageGraphicsListRsp=function(e,t){var r=this,i=t.header,o=t.body,n=i.code,s=i.message;if(0===n){var a=o.pages,c=this.getMap(e);if(!c||!c.viewWidth||!c.viewHeight)return;f.Logger.info(m("gra.get_list_cb"),"success");var d=[],l=[],h=[],u=[];a.forEach((function(t){var i=t.graphic_list,o=t.del_graphic_id_list,n=t.page,s=t.ret_graphic_list_seq,a=t.svr_graphic_list_seq;i=i||[],o=o||[],h.push(n),u.push(a),i.forEach((function(e){p.transData(e,!0),p.calPlaceHandle(e,c.viewWidth,!0),p.transColor(e,!0)})),r.actionListener("getPageGraphicsList",e,i,o),a!==s&&0!==s?(d.push(n),l.push(s)):r.getMap(e).pullMarks[n]=!0})),f.Logger.info(m("gra.update_seq"),JSON.stringify({whiteboardID:e,pages:h,graphicListSeqs:u,actionMsg:"get list cb success"})),this.updateMapByGraphicListSeqs(e,{pages:h,graphicListSeqs:u}),d.length&&(f.Logger.info(m("gra.get_list_cb"),"increment get"),this.getPageGraphicsList(e,d,l))}else f.Logger.error(m("gra.get_list_cb"),JSON.stringify({code:n,msg:s}))},t.prototype.handleUpdateToRemoteRsp=function(e,t,r,i){var o=t.header,s=t.body,a=o.code,c=o.message;if(this.setInProgress(e,!1),0===a){var d={pages:s.pages,graphicListSeqs:s.graphic_list_seqs};f.Logger.info(m("gra.update_seq"),JSON.stringify(n(n({whiteboardID:e},d),{actionMsg:"draw cb success"}))),this.updateMapByGraphicListSeqs(s.mod_id,d),r()}else{var l=this.whiteboardError.transError(a,c);f.Logger.error(m("gra.draw_cb"),JSON.stringify(l)),i(l)}},t.prototype.pushDrawPageGraphicsHandle=function(e){var t=e.page_graphics,r=e.mod_id,i=this.getMap(r);if(i&&i.viewWidth&&i.viewHeight){f.Logger.info(m("gra.remote_draw"),JSON.stringify({drawPages:t}));var o=[],n=[];t.forEach((function(e){var t=e.del_graphic_id_list,r=e.graphic_list,s=e.action_seq,a=e.page;r?r.forEach((function(e){p.transData(e,!0),p.calPlaceHandle(e,i.viewWidth,!0),p.transColor(e,!0),o.push(a),n.push(s)})):e.graphic_list=[],e.del_graphic_id_list=t||[]})),f.Logger.info(m("gra.update_seq"),JSON.stringify({whiteboardID:r,pages:o,graphicListSeqs:n,actionMsg:"remote draw"})),this.updateMapByGraphicListSeqs(r,{pages:o,graphicListSeqs:n}),this.actionListener("pushDrawPageGraphics",r,t)}},t.prototype.pushClearPageGraphicsHandle=function(e){var t=e.action_seqs,r=e.pages,i=e.mod_id,o=this.getMap(i);if(o&&o.viewWidth&&o.viewHeight){var s={pages:r,graphicListSeqs:t};f.Logger.info(m("gra.update_seq"),JSON.stringify(n(n({whiteboardID:i},s),{actionMsg:"remote clear"}))),this.updateMapByGraphicListSeqs(i,s),this.actionListener("pushClearPageGraphics",i),this.updateMap({whiteboardID:i,undoList:[],redoList:[],operateTimes:0})}},t.prototype.pushAddMod=function(e){var t=e.mod_id;f.Logger.info(m("mod.update_map"),JSON.stringify({whiteboardID:t,actionMsg:"remote add"})),this.updateMapByMod(e),this.actionListener("pushAddMod",t)},t.prototype.pushRemovedMod=function(e){this.deleteMap(e),this.actionListener("pushRemovedMod",e)},t.prototype.pushModifyMod=function(e){var t=e.mod_id,r=e.mod_seq,i=e.mod_title,o=e.mod_horizontal_percent,n=e.mod_vertical_percent,s=e.mod_reserve,a=e.is_modify_mod_vertical_percent,c=e.is_modify_mod_horizontal_percent,l=e.is_modify_mod_reserve,h=e.is_modify_mod_title,u=this.getMap(t);if(u&&u.viewWidth&&u.viewHeight)if(this.getModSendSwitch(t)){if(f.Logger.info(m("mod.remote_modify"),"immediate update"),r>u.modSeq){var p={whiteboardID:t,modSeq:r};f.Logger.info(m("mod.update_map"),JSON.stringify(p)),this.updateMap(p)}this.updateMapByModifyModOption(e,r,!0)}else{f.Logger.info(m("mod.remote_modify"),"cache");var g={mod_id:t};h&&Object.assign(g,{mod_title:i,is_modify_mod_title:h}),c&&Object.assign(g,{mod_horizontal_percent:o,is_modify_mod_horizontal_percent:c}),a&&Object.assign(g,{mod_vertical_percent:n,is_modify_mod_vertical_percent:a,mod_reserve:s,is_modify_mod_reserve:l}),l&&Object.assign(g,{mod_reserve:s,is_modify_mod_reserve:l}),this.updateModifyModTaskList({status:d.Pending,data:g,push:!0,pushModSeq:r})}},t.prototype.pushScrollHandle=function(e,t,r,i){f.Logger.info(m("mod.remote_scroll"),JSON.stringify({whiteboardID:e,horizontalPercent:t,verticalPercent:r,step:i})),t=+t,r=+r,this.actionListener("pushScroll",e,t>0?(1e4*t+1|0)/1e4:0,r>0?(1e4*r+1|0)/1e4:0,i)},t.prototype.pushSetModHandle=function(e){var t=e.mod_list_seq,r=e.action_list;if(t>=this.modListSeq){this.modListSeq=t;var i=r[0],o=i.action;o===g.ModAction.Removed?this.pushRemovedMod(i.mod_id):o===g.ModAction.Add?this.pushAddMod(i):o===g.ModAction.Modify&&this.pushModifyMod(i)}else f.Logger.warn(m("mod.remote_push"),JSON.stringify({localModListSeq:this.modListSeq,remoteModListSeq:t,msg:"throw away"}))},t}(h.WhiteboardServiceBase);t.WhiteboardService=v},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WhiteboardServiceBase=void 0;var i=function(){function e(e,t){this.customListenerList={error:[],viewAdd:[],viewRemoved:[],viewScroll:[]},this.platform=e,this.whiteboardError=t}return e.prototype.bindCustomListener=function(e,t){return!!this.customListenerList[e]&&("function"==typeof t&&(-1==this.customListenerList[e].indexOf(t)&&this.customListenerList[e].push(t),!0))},e.prototype.deleteCustomListener=function(e,t){if(!this.customListenerList[e])return!1;var r=this.customListenerList[e];return t?r.splice(r.indexOf(t),1):this.customListenerList[e]=[],!0},e.prototype.actionCustomListener=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];this.customListenerList[e]&&this.customListenerList[e].forEach((function(e){e.apply(void 0,t)}))},e}();t.WhiteboardServiceBase=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModAction=t.PushType=void 0,function(e){e[e.SetMod=1]="SetMod",e[e.ClearPageGraphics=2]="ClearPageGraphics",e[e.DrawPageGraphics=3]="DrawPageGraphics"}(t.PushType||(t.PushType={})),function(e){e[e.Add=1]="Add",e[e.Removed=2]="Removed",e[e.Modify=3]="Modify"}(t.ModAction||(t.ModAction={}))},function(e,t,r){"undefined"!=typeof self&&self,e.exports=function(e){var t={};function r(i){if(t[i])return t[i].exports;var o=t[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(i,o,function(t){return e[t]}.bind(null,o));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=5)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PROTO_VERSION="1.9.1",t.ROOMVERSION="V1",function(e){e[e.debug=0]="debug",e[e.info=1]="info",e[e.warn=2]="warn",e[e.error=3]="error",e[e.report=99]="report",e[e.disable=100]="disable"}(t.ENUM_LOG_LEVEL||(t.ENUM_LOG_LEVEL={})),function(e){e[e.disable=0]="disable",e[e.websocket=1]="websocket",e[e.https=2]="https"}(t.ENUM_REMOTE_TYPE||(t.ENUM_REMOTE_TYPE={}));var i=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=null),this._id=null,this.next=null,this.prev=null,this._id=e,this._data=t}return Object.defineProperty(e.prototype,"id",{get:function(){return this._id},set:function(e){this._id=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"data",{get:function(){return this._data},set:function(e){this._data=e},enumerable:!0,configurable:!0}),e.prototype.hasNext=function(){return this.next&&this.next.id},e.prototype.hasPrev=function(){return this.prev&&this.prev.id},e}();t.ListNode=i;var o=function(){function e(){this.start=new i,this.end=new i,this._idCounter=0,this._numNodes=0,this.start.next=this.end,this.start.prev=null,this.end.prev=this.start,this.end.next=null}return e.prototype.insertBefore=function(e,t){var r=new i(this._idCounter,t);return r.next=e,r.prev=e.prev,e.prev.next=r,e.prev=r,++this._idCounter,++this._numNodes,r},e.prototype.addLast=function(e){return this.insertBefore(this.end,e)},e.prototype.add=function(e){return this.addLast(e)},e.prototype.getFirst=function(){return 0===this._numNodes?null:this.start.next},e.prototype.getLast=function(){return 0===this._numNodes?null:this.end.prev},e.prototype.size=function(){return this._numNodes},e.prototype.getFromFirst=function(e){var t=0,r=this.start.next;if(e>=0)for(;t<e&&null!==r;)r=r.next,++t;else r=null;if(null===r)throw"Index out of bounds.";return r},e.prototype.get=function(e){return 0===e?this.getFirst():e===this._numNodes-1?this.getLast():this.getFromFirst(e)},e.prototype.remove=function(e){return e.prev.next=e.next,e.next.prev=e.prev,--this._numNodes,e},e.prototype.removeFirst=function(){var e=null;return this._numNodes>0&&(e=this.remove(this.start.next)),e},e.prototype.removeLast=function(){var e=null;return this._numNodes>0&&(e=this.remove(this.end.prev)),e},e.prototype.removeAll=function(){this.start.next=this.end,this.end.prev=this.start,this._numNodes=0,this._idCounter=0},e.prototype.each=function(e){for(var t=this.start;t.hasNext();)e(t=t.next)},e.prototype.find=function(e){for(var t=this.start,r=!1,i=null;t.hasNext()&&!r;)e(t=t.next)&&(i=t,r=!0);return i},e.prototype.map=function(e){for(var t=this.start,r=[];t.hasNext();)e(t=t.next)&&r.push(t);return r},e.prototype.push=function(e){return this.addLast(e)},e.prototype.unshift=function(e){this._numNodes>0?this.insertBefore(this.start.next,e):this.insertBefore(this.end,e)},e.prototype.pop=function(){return this.removeLast()},e.prototype.shift=function(){return this.removeFirst()},e}();t.LinkedList=o,t.sdkErrorList={SUCCESS:{code:"ZegoClient.Success",msg:"success."},PARAM:{code:"ZegoClient.Error.Param",msg:"input error."},HEARTBEAT_TIMEOUT:{code:"ZegoClient.Error.Timeout",msg:"heartbeat timeout."},LOGIN_TIMEOUT:{code:"ZegoClient.Error.Timeout",msg:"login timeout."},SEND_MSG_TIMEOUT:{code:"ZegoClient.Error.Timeout",msg:"send customsg timeout."},RESET_QUEUE:{code:"ZegoClient.Error.Timeout",msg:"msg waiting ack is clear when reset."},LOGIN_DISCONNECT:{code:"ZegoClient.Error.Network",msg:"network is broken and login fail."},KICK_OUT:{code:"ZegoClient.Error.Kickout",msg:"kickout reason="},UNKNOWN:{code:"ZegoClient.Error.Unknown",msg:"unknown error."},FREQ_LIMITED:{code:"ZegoClient.Error.requencyLimited",msg:"Frequency Limited."}},function(e){e[e.disconnected=0]="disconnected",e[e.connecting=1]="connecting",e[e.connected=2]="connected"}(t.ENUM_SIGNAL_STATE||(t.ENUM_SIGNAL_STATE={})),t.ENUM_RESOLUTION_TYPE={LOW:{width:240,height:320,frameRate:15,bitRate:300},MEDIUM:{width:480,height:640,frameRate:15,bitRate:800},HIGH:{width:720,height:1280,frameRate:20,bitRate:1500}},t.ENUM_RETRY_STATE={didNotStart:0,retrying:1,finished:2},t.ENUM_PUBLISH_STATE={start:0,waitingSessionRsp:1,waitingOffserRsp:2,waitingServerAnswer:3,waitingServerICE:4,connecting:5,publishing:6,stop:7,didNotStart:8},t.ENUM_PUBLISH_STATE_NEGO={stop:0,start:1,waiterAnswer:2,waitingCandidate:3,sendCandidate:4,iceConnected:5},t.ENUM_PLAY_STATE={start:0,waitingSessionRsp:1,waitingOffserRsp:2,waitingServerAnswer:3,waitingServerICE:4,connecting:5,playing:6,stop:7,didNotStart:8},t.ENUM_PLAY_STATE_NEGO={stop:0,start:1,waiterAnswer:2,waitingCandidate:3,sendCandidate:4,iceConnected:5},t.ENUM_CONNECT_STATE={disconnect:0,connecting:1,connected:2},t.MAX_TRY_CONNECT_COUNT=1,t.SEND_MSG_RESET=2,t.SEND_MSG_TIMEOUT=1,t.MAX_TRY_HEARTBEAT_COUNT=5,t.ENUM_PUBLISH_STREAM_STATE={waiting_url:1,tryPublish:2,update_info:3,publishing:4,stop:5},t.ENUM_STREAM_SUB_CMD={liveNone:0,liveBegin:2001,liveEnd:2002,liveUpdate:2003},t.ENUM_STREAM_UPDATE_TYPE={added:0,deleted:1},function(e){e[e.logout=0]="logout",e[e.trylogin=1]="trylogin",e[e.login=2]="login"}(t.ENUM_RUN_STATE||(t.ENUM_RUN_STATE={})),t.ENUM_PUBLISH_STATE_UPDATE={start:0,error:1,retry:2},t.ENUM_PLAY_STATE_UPDATE={start:0,error:1,retry:2},t.MAX_TRY_LOGIN_COUNT=5,t.TRY_LOGIN_INTERVAL=[2e3,4e3,6e3,8e3,1e4],t.MINIUM_HEARTBEAT_INTERVAL=3e3,t.ENUM_STREAM_UPDATE_CMD={added:12001,deleted:12002,updated:12003},t.SERVER_ERROR_CODE=1e4,t.MIXSTREAM_ERROR_CODE=1e4,function(e){e[e.low=1]="low",e[e.stantard=2]="stantard",e[e.hight=3]="hight",e[e.custome=4]="custome"}(t.QUALITYLEVEL||(t.QUALITYLEVEL={})),t.ENUM_SIGNAL_SUB_CMD={none:0,joinLiveRequest:1001,joinLiveResult:1002,joinLiveInvite:1003,joinLiveStop:1004},t.ENUM_PUSH_SIGNAL_SUB_CMD={none:0,pushJoinLiveRequest:11001,pushJoinLiveResult:11002,pushJoinLiveInvite:11003,pushJoinLiveStop:11004},function(e){e[e.auto=0]="auto",e[e.ultra=1]="ultra"}(t.ENUM_PLAY_SOURCE_TYPE||(t.ENUM_PLAY_SOURCE_TYPE={})),function(e){e[e.stop=0]="stop",e[e.start=1]="start"}(t.ENUM_BROADCASTER_STATUS||(t.ENUM_BROADCASTER_STATUS={})),function(e){e[e.cdn=0]="cdn",e[e.ultra=1]="ultra",e[e.customUrl=2]="customUrl"}(t.ENUM_DISPATCH_TYPE||(t.ENUM_DISPATCH_TYPE={})),function(e){e[e.ClientType_None=0]="ClientType_None",e[e.ClientType_H5=1]="ClientType_H5",e[e.ClientType_SmallPragram=2]="ClientType_SmallPragram",e[e.ClientType_Webrtc=3]="ClientType_Webrtc"}(t.E_CLIENT_TYPE||(t.E_CLIENT_TYPE={}))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){}return e.checkConfigParam=function(e,t){return e.appid&&"number"==typeof e.appid?!e.server||e.server.length<1||"string"!=typeof e.server&&!Array.isArray(e.server)?(t.error("ccp.0 server must be string or string[] and not empty"),!1):!(!e.idName||"string"!=typeof e.idName)||(t.error("ccp.0 idName must be string and not empty"),!1):(t.error("ccp.0 appid must be number"),!1)},e.checkLoginParam=function(e,t){return!0},e.checkPreviewParam=function(e,t){var r=e.bitRate;if(4===e.videoQuality||e.externalMediaStream){if("number"!=typeof e.width)return t.error("zc.p.sp.0 width must be number"),!1;if("number"!=typeof e.height)return t.error("zc.p.sp.0 height must be number"),!1;if("number"!=typeof e.frameRate)return t.error("zc.p.sp.0 frameRate must be number"),!1;if("number"==typeof r)r<48&&(r=48),r>1e4&&(r=1e4),e.minBitRate=e.maxBitRate=e.bitRate;else if(r.minBitRate&&r.maxBitRate&&"number"==typeof r.minBitRate&&"number"==typeof r.maxBitRate&&r.minBitRate<=r.maxBitRate)e.minBitRate=r.minBitRate<48?48:r.minBitRate,e.maxBitRate=r.maxBitRate>1e4?1e4:r.maxBitRate;else if(r)return t.error("zc.p.sp.0 bitRate must be number or object which has minBitRate and maxBitRate"),!1}return!0},e.registerCallback=function(e,t,r){var i,o;t.success&&(i=t.success),t.error&&(o=t.error),r[e+"SuccessCallback"]=i,r[e+"ErrorCallback"]=o},e.actionErrorCallback=function(e,t){return t[e+"ErrorCallback"]},e.actionSuccessCallback=function(e,t){return t[e+"SuccessCallback"]},e.getDevices=function(e,t){void 0!==navigator.mediaDevices&&void 0!==navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then((function(t){for(var r=[],i=[],o=[],n=0;n<t.length;n++){var s=t[n];"audioinput"===s.kind&&r.push({deviceName:s.label,deviceID:s.deviceId}),"audiooutput"===s.kind&&i.push({deviceName:s.label,deviceID:s.deviceId}),"videoinput"===s.kind&&o.push({deviceName:s.label,deviceID:s.deviceId})}e&&e({microphones:r,speakers:i,cameras:o})})).catch((function(e){console.error("enumerate devices wrong "+e),t&&t({code:"2000000007",msg:"enumerate devices fail"})})):t&&t({code:"2002000002",msg:"browser do not support"})},e.getServerError=function(e){var t={1:"parse json error.",1001:"login is processing.",1002:"liveroom request error.",1003:"zpush connect fail.",1004:"zpush handshake fail.",1005:"zpush login fail.",1006:"user login state is wrong.",1007:"got no zpush addr",1008:"token error",1009:"dispatch error",1010:"token expired",2002:"biz channel error",1e9:"liveroom cmd error, result="};if(0===e)return{code:"ZegoClient.Success",msg:"success"};var r={code:"ZegoClient.Error.Server",msg:""};return r.msg=e>1e9?t[1e9]+e:t[e]?t[e]:"unknown error code:"+e,r},e.isKeepTryLogin=function(e){switch(e){case 1002:case 1003:return!0;default:return!1}},e.mergeStreamList=function(e,t,r,i,o){e.debug("msl.0 call");var n,s=[],a=[],c=[];i||(i=[]);for(var d=0;d<i.length;d++)if(i[d].anchor_id_name!=t){n=!1;for(var l=0;l<r.length;l++)if(i[d].stream_id===r[l].stream_id){i[d].extra_info!==r[l].extra_info&&c.push(i[d]),n=!0;break}n||s.push(i[d])}else e.debug("msl.0 have self stream added");for(var h=0;h<r.length;h++){n=!1;for(var u=0;u<i.length;u++)if(r[h].stream_id===i[u].stream_id){n=!0;break}n||a.push(r[h])}for(r.splice(0),d=0;d<i.length;d++)r.push(i[d]);o(s,a,c),e.debug("msl.0 call success")},e.checkCustomCommandParam=function(e){return!0},e.generateRandumNumber=function(e){return parseInt(Math.random()*(e+1)+"",10)},e.uuid=function(e,t){var r,i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),o=[];if(t=t||i.length,e)for(r=0;r<e;r++)o[r]=i[0|Math.random()*t];else{var n=void 0;for(o[8]=o[13]=o[18]=o[23]="-",o[14]="4",r=0;r<36;r++)o[r]||(n=0|16*Math.random(),o[r]=i[19==r?3&n|8:n])}return o.join("")},e.supportDetection=function(e,t,r){var i={webRtc:!1,capture:!1,videoDecodeType:{H264:!1,VP8:!1},screenSharing:e};navigator&&(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.msGetUserMedia||navigator.mozGetUserMedia||navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)&&(i.capture=!0),window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection?(i.webRtc=!0,this.supportVideoCodeType((function(e){i.videoDecodeType.H264=e.H264,i.videoDecodeType.VP8=e.VP8,t&&t(i)}),(function(e){r&&r(e)}))):t&&t(i)},e.compareVersion=function(e,t){e=e.split("."),t=t.split(".");for(var r=Math.max(e.length,t.length);e.length<r;)e.push("0");for(;t.length<r;)t.push("0");for(var i=0;i<r;i++){var o=parseInt(e[i]),n=parseInt(t[i]);if(o>n)return 1;if(o<n)return-1}return 0},e.isSupportLive=function(e,t){var r=wx.getSystemInfoSync().SDKVersion,i={code:-1,msg:""};this.compareVersion(r,"1.7.0")<0&&(i={code:10001,msg:"当前微信版本过低，无法使用相关组件"},e&&e(i)),wx.getSetting({success:function(t){var r=t.authSetting;r["scope.camera"]&&r["scope.record"]||(i={code:10002,msg:"需要摄像头和录音功能的授权"}),e&&e(i)},fail:function(e){t&&t(e)}})},e.isSupportQQLive=function(e,t){var r=qq.getSystemInfoSync().SDKVersion,i={code:-1,msg:""};this.compareVersion(r,"1.7.0")<0&&(i={code:10001,msg:"当前微信版本过低，无法使用相关组件"},e&&e(i)),qq.getSetting({success:function(t){var r=t.authSetting;r["scope.camera"]&&r["scope.record"]||(i={code:10002,msg:"需要摄像头和录音功能的授权"}),e&&e(i)},fail:function(e){t&&t(e)}})},e.supportVideoCodeType=function(e,t){var r=!1;new RTCPeerConnection(null).createOffer({offerToReceiveAudio:1,offerToReceiveVideo:1}).then((function(t){if(t&&t.sdp){r=!0;var i=t.sdp.split("\r\n"),o=i.some((function(e){return e.startsWith("a=rtpmap:")&&e.indexOf("H264/")>-1})),n=i.some((function(e){return e.startsWith("a=rtpmap:")&&e.indexOf("VP8/")>-1})),s=i.some((function(e){return e.startsWith("a=rtpmap:")&&e.indexOf("VP9/")>-1})),a=i.some((function(e){return e.startsWith("a=rtpmap:")&&e.indexOf("H264/")>-1}));e&&e({H264:o,VP8:n,VP9:s,H265:a})}}),(function(e){r=!0,clearTimeout(i),t&&t(e)}));var i=setTimeout((function(){0==r&&t(!1)}),200)},e.inlineWorker=function(e){if(Worker){var t=e.toString().trim().match(/^function\s*\w*\s*\([\w\s,]*\)\s*{([\w\W]*?)}$/)[1],r=URL.createObjectURL(new window.Blob([t],{type:"text/javascript"}));return new Worker(r)}return null},e}();t.ClientUtil=i},function(e,t,r){"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.playErrorList={DISPATCH_ERROR:{code:"ZegoPlayWeb.Error.Dispatch",msg:"dispatch request error"},DISPATCH_TIMEOUT:{code:"ZegoPlayWeb.Timeout.Dispatch",msg:"dispatch request timeout"},TOKEN_ERROR:{code:"ZegoPlayWeb.Error.Token",msg:"login token error"},SEND_SESSION_TIMEOUT:{code:"ZegoPlayWeb.Timeout.Session",msg:"send session request timeout"},CREATE_SESSION_ERROR:{code:"ZegoPlayWeb.Error.Session",msg:"create session error"},CREATE_OFFER_ERROR:{code:"ZegoPublish.Error.CreateOffer",msg:"create offer error"},SERVER_MEDIA_DESC_TIMEOUT:{code:"ZegoPlayWeb.Timeout.RemoteOffer",msg:"wating server mediaDesc timeout"},SET_REMOTE_DESC_ERROR:{code:"ZegoPlayWeb.Error.RemoteOffer",msg:"other side offer error"},CREATE_ANSWER_ERROR:{code:"ZegoPlayWeb.Error.CreateAnswer",msg:"create offer error"},SET_LOCAL_DESC_ERROR:{code:"ZegoPlayWeb.Error.LocalDesc",msg:"setLocalDescription error"},SEND_MEDIA_DESC_TIMEOUT:{code:"ZegoPlayWeb.Timeout.Desc",msg:"send mediaDesc timeout"},SEND_CANDIDATE_ERROR:{code:"ZegoPlayWeb.Error.Candidate",msg:"send candidate error"},SEND_CANDIDATE_TIMEOUT:{code:"ZegoPlayWeb.Timeout.Candidate",msg:"send candidate timeout"},SERVER_NEGO_TIMEOUT:{code:"ZegoPlayWeb.Timeout.negotiation",msg:"negotiation timeout"},SERVER_CANDIDATE_TIMEOUT:{code:"ZegoPlayWeb.Timeout.ServerCandidate",msg:"waiting candidate timeout"},SERVER_CANDIDATE_ERROR:{code:"ZegoPlayWeb.Error.ServerCandidate",msg:"recv candidate error"},MEDIA_CONNECTION_FAILED:{code:"ZegoPlayWeb.Error.ConnectionFailed",msg:"ice Connection state failed"},MEDIA_CONNECTION_CLOSED:{code:"ZegoPlayWeb.Error.ConnectionClosed",msg:"ice connection state closed"},SESSION_CLOSED:{code:"ZegoPlayWeb.Error.SessionClosed",msg:"server session closed"},WEBSOCKET_ERROR:{code:"ZegoPlayWeb.Error.SocketError",msg:"network error"}},t.publishErrorList={DISPATCH_ERROR:{code:"ZegoPublish.Error.Dispatch",msg:"dispatch request error"},DISPATCH_TIMEOUT:{code:"ZegoPublish.Timeout.Dispatch",msg:"dispatch request timeout"},TOKEN_ERROR:{code:"ZegoPublish.Error.Token",msg:"login token error"},SEND_SESSION_TIMEOUT:{code:"ZegoPublish.Timeout.Session",msg:"send session request timeout"},CREATE_SESSION_ERROR:{code:"ZegoPublish.Error.Session",msg:"create session error"},CREATE_OFFER_ERROR:{code:"ZegoPublish.Error.CreateOffer",msg:"create offer error"},SET_LOCAL_DESC_ERROR:{code:"ZegoPublish.Error.LocalDesc",msg:"setLocalDescription error"},SEND_MEDIA_DESC_TIMEOUT:{code:"ZegoPublish.Timeout.Desc",msg:"send mediaDesc timeout"},SERVER_MEDIA_DESC_TIMEOUT:{code:"ZegoPublish.Timeout.ServerAnswer",msg:"waiting server mediaDesc timeout"},SERVER_MEDIA_DESC_ERROR:{code:"ZegoPublish.Error.ServerAnswer",msg:"server mediaDesc type error"},SET_REMOTE_DESC_ERROR:{code:"ZegoPublish.Error.RemoteDesc",msg:"other side offer error"},SEND_CANDIDATE_TIMEOUT:{code:"ZegoPublish.Timeout.Candidate",msg:"sendIceCandidate error"},SERVER_CANDIDATE_TIMEOUT:{code:"ZegoPublish.Timeout.ServerCandidate",msg:"waiting candidate timeout"},SERVER_NEGO_TIMEOUT:{code:"ZegoPublish.Timeout.negotiation",msg:"negotiation timeout"},SERVER_CANDIDATE_ERROR:{code:"ZegoPublish.Error.ServerCandidate",msg:"recv candidate error"},SESSION_CLOSED:{code:"ZegoPublish.Error.SessionClosed",msg:"server session closed"},MEDIA_CONNECTION_FAILED:{code:"ZegoPublish.Error.IConnectionFailed",msg:"Iice Connection state failed"},MEDIA_CONNECTION_CLOSED:{code:"ZegoPublish.Error.ConnectionClosed",msg:"ice connection state closed"},MEDIA_CONNECTION_DISCONNECTED:{code:"ZegoPublish.Error.IConnectionDisconnected",msg:"ice connection state disconnected"},WEBSOCKET_ERROR:{code:"ZegoPublish.Error.SocketError",msg:"network error"}},t.ENUM_PUBLISH_STATE_UPDATE={start:0,error:1,retry:2},t.ENUM_PLAY_STATE_UPDATE={start:0,error:1,retry:2,stop:3},t.ENUM_RETRY_STATE={didNotStart:0,retrying:1,finished:2},t.getSeq=(i=1,function(){return i++})},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){this.audioBufferList=[],this.loop=!1,this.replace=!1,this.effectEndedCallBack=null,this.effectEndedListener=null,this.startTimes=0,this.startOffset=0,this.pauseTimes=0,this.resumeOffset=0,this.isMixAudio=!1,this.isMixingBuffer=!1,this.logger=e,this.ac=t}return e.prototype.preloadEffect=function(e,t){var r=this;this.logger.info("amu.pe.0 start preload effect");var i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.onload=function(){if(200==i.status||304==i.status){var e=i.response;r.ac.decodeAudioData(e,(function(e){r.logger.info("amu.pe.0 effect preload success"),t("",e)}),(function(e){t(e)}))}else{var o=i.statusText;t(o)}},i.send()},e.prototype.playEffect=function(e,t,r,i,o){var n=this;!0!==this.isMixAudio?this.audioBuffer?(this.startOffset=e||0,this.loop=t||!1,this.replace=r||!1,this.effectEndedCallBack=o,this.mixEffect(this.audioBuffer,(function(){n.buffSource.loop=!!t,e?n.buffSource.start(0,e/1e3):n.buffSource.start(0),n.startTimes=Date.now(),n.effectEndedListener=n.effectEndedHandler.bind(n),n.buffSource.addEventListener("ended",n.effectEndedListener),i&&i()}))):this.logger.error("amu.pe.1 no audio buffer found"):this.logger.error("amu.pe.1 audio is mixing")},e.prototype.mixingBuffer=function(e,t){var r=this;!0!==this.isMixAudio||0!=this.audioBufferList.length||0!=this.isMixingBuffer?this.ac.decodeAudioData(e,(function(e){r.audioBufferList.push(e),1==r.audioBufferList.length&&r.playRealTimeEffect(r.audioBufferList[0]),r.isMixingBuffer=!0,t&&t()}),(function(e){r.logger.error("amu.mb.0 "+e),t&&t(e)})):this.logger.error("amu.mb.0 audio is mixing")},e.prototype.stopMingBuffer=function(){return this.isMixingBuffer=!1,this.stopMixingAudio()},e.prototype.playRealTimeEffect=function(e){var t=this;this.mixEffect(e,(function(){t.buffSource.start(0),t.buffSource.addEventListener("ended",(function(){t.audioBufferList.shift(),t.audioBufferList.length>0&&t.isMixAudio&&t.playRealTimeEffect(t.audioBufferList[0])}))}))},e.prototype.pauseEffect=function(){this.audioBufferList.length>0?this.logger.error("amu.pe.0 real time buffer can not be paused"):(this.stopMixingAudio(),this.resumeOffset=(this.pauseTimes-this.startTimes+this.startOffset)%(1e3*this.audioBuffer.duration))},e.prototype.resumeEffect=function(){this.audioBufferList.length>0?this.logger.error("amu.pe.0 real time buffer can not be resume"):(this.playEffect(this.resumeOffset,this.loop,this.replace,null,this.effectEndedCallBack),this.startOffset=this.resumeOffset)},e.prototype.mixEffect=function(e,t){this.localStream?(this.gainNode=this.ac.createGain(),this.buffSource=this.ac.createBufferSource(),this.buffSource.buffer=e,this.buffSource.connect(this.gainNode),this.gainNode.connect(this.ac.destination),this.replaceTrack()&&t()):this.logger.error("amu.me.0 localStream can not be found")},e.prototype.startMixingAudio=function(e,t){return this.replace=t||!1,this.isMixAudio?(this.logger.error("amu.sma.0 audio is mixing"),!1):this.localStream?(e.captureStream=e.captureStream||e.mozCaptureStream||e.webkitCaptureStream,this.gainNode=this.ac.createGain(),this.mixAudio=this.ac.createMediaStreamSource(e.captureStream()),this.mixAudio.connect(this.gainNode),this.replaceTrack()):(this.logger.error("amu.sma.0 localStream can not be found"),!1)},e.prototype.replaceTrack=function(){this.streamSource=this.ac.createMediaStreamSource(this.localStream),this.destination=this.ac.createMediaStreamDestination(),!this.replace&&this.streamSource.connect(this.destination),this.gainNode.connect(this.destination);var e=this.destination.stream.getAudioTracks()[0],t=this.peerConnection.getSenders().find((function(t){return t.track.kind===e.kind}));return t?(this.micTrack=this.localStream.getAudioTracks()[0],t.replaceTrack(e),this.localStream.removeTrack(this.micTrack),this.localStream.addTrack(e),this.isMixAudio=!0,!0):(this.logger.error("amu.rt.0 no sender"),!1)},e.prototype.stopMixingAudio=function(){return this.isMixAudio?this.localStream?(this.mixAudio?(this.mixAudio.disconnect(this.gainNode),this.mixAudio=null):this.buffSource&&(this.buffSource.removeEventListener("ended",this.effectEndedListener),this.buffSource.stop(),this.pauseTimes=Date.now(),this.buffSource.disconnect(this.gainNode),this.buffSource=null),this.gainNode.disconnect(this.destination),this.isMixAudio=!1,this.audioBufferList=[],!0):(this.logger.error("amu.sma.1 localStream can not be found"),!1):(this.logger.error("amu.sma.1 no mixing audio found"),!1)},e.prototype.setMixingAudioVolume=function(e){if(!this.gainNode)return this.logger.error("amu.sma.2 no mixing audio found"),!1;this.gainNode.gain.value=e},e.prototype.effectEndedHandler=function(){this.stopMixingAudio(),this.effectEndedCallBack&&this.effectEndedCallBack()},e}();t.audioMixUtil=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){}return e.zegoSdp=function(e){var t=e.split("\r\n"),r=[],i=[];t.forEach((function(e){var t=e.match(/a=rtpmap:(\d+)\s+((H264\/90000)|(opus\/48000\/2))/);t&&t[1]&&t[2]&&("H264/90000"===t[2]&&r.push(t[1]),"opus/48000/2"===t[2]&&i.push(t[1]))}));var o=[];return t.map((function(e){var t=!0,n=e.match(/((a=rtcp-fb:)|(a=rtpmap:)|(a=fmtp:))(\d+)/);if(n&&n[5]&&(r.concat(i).some((function(e){return e==n[5]}))||(t=!1)),e.indexOf("m=video")>-1){var s=e.split(" ");e=[s[0],s[1],s[2]].concat(r).join(" ")}else e.indexOf("m=audio")>-1&&(s=e.split(" "),e=[s[0],s[1],s[2]].concat(i).join(" "));t&&o.push(e)})),o.join("\r\n")},e.getSDPByVideDecodeType=function(e,t){var r={str:"",arr:[],obj:{H264:[],H265:[],VP8:[],VP9:[],OHTER:[]}};if(!e.includes("m=video"))return e;var i=/m=video.+/.exec(e)[0];i=i.match(/[\s|\d]+/g)[1].replace(" ",""),r.str=i,r.arr=r.str.split(" "),r.arr.forEach((function(t){var i=new RegExp("a=rtpmap:"+t+".+").exec(e)[0];i.includes("H264")?r.obj.H264.push(t):i.includes("H265")?r.obj.H265.push(t):i.includes("VP8")?r.obj.VP8.push(t):i.includes("VP9")?r.obj.VP9.push(t):r.obj.OHTER.push(t)})),r.obj.OHTER.forEach((function(t){var i=new RegExp("a=fmtp:"+t+".+apt=(\\d+)").exec(e),o=i&&i[1];o&&(r.obj.H264.includes(o)?r.obj.H264.push(t):r.obj.H265.includes(o)?r.obj.H265.push(t):r.obj.VP8.includes(o)?r.obj.VP8.push(t):r.obj.VP9.includes(o)&&r.obj.VP9.push(t))}));var o=[];return"VP9"===t?o=r.obj.H265.concat(r.obj.H264,r.obj.VP8):"VP8"===t?o=r.obj.H265.concat(r.obj.H264,r.obj.VP9):"H264"===t?o=r.obj.H265.concat(r.obj.VP8,r.obj.VP9):"H265"===t&&(o=r.obj.VP8.concat(r.obj.H264,r.obj.VP9)),o.forEach((function(t){var i=r.arr.indexOf(t);r.arr.splice(i,1);var o=new RegExp("a=rtpmap:"+t+".+\\s\\n","g"),n=new RegExp("a=rtcp-fb:"+t+".+\\s\\n","g"),s=new RegExp("a=fmtp:"+t+".+\\s\\n","g");e=(e=(e=e.replace(o,"")).replace(n,"")).replace(s,"")})),e=e.replace(i,r.arr.join(" "))},e}();t.sdpUtil=i},function(e,t,r){"use strict";var i,o=this&&this.__extends||(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),n=this&&this.__assign||Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},s=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))((function(o,n){function s(e){try{c(i.next(e))}catch(e){n(e)}}function a(e){try{c(i.throw(e))}catch(e){n(e)}}function c(e){e.done?o(e.value):new r((function(t){t(e.value)})).then(s,a)}c((i=i.apply(e,t||[])).next())}))},a=this&&this.__generator||function(e,t){var r,i,o,n,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return n={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function a(n){return function(a){return function(n){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,i&&(o=2&n[0]?i.return:n[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,n[1])).done)return o;switch(i=0,o&&(n=[2&n[0],o.value]),n[0]){case 0:case 1:o=n;break;case 4:return s.label++,{value:n[1],done:!1};case 5:s.label++,i=n[1],n=[0];continue;case 7:n=s.ops.pop(),s.trys.pop();continue;default:if(!((o=(o=s.trys).length>0&&o[o.length-1])||6!==n[0]&&2!==n[0])){s=0;continue}if(3===n[0]&&(!o||n[1]>o[0]&&n[1]<o[3])){s.label=n[1];break}if(6===n[0]&&s.label<o[1]){s.label=o[1],o=n;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(n);break}o[2]&&s.ops.pop(),s.trys.pop();continue}n=t.call(e,s)}catch(e){n=[6,e],i=0}finally{r=o=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var c=r(0),d=r(2),l=r(6),h=r(8),u=r(1),p=r(3),g=r(17),f=r(26),m=r(27),v=function(e){function t(){var t=this,r=new l.LoggerWeb,i=new f.StateCenter,o=new("undefined"!=typeof webkitAudioContext?webkitAudioContext:AudioContext),n=new h.ZegoStreamCenterWeb(r,i,o);return(t=e.call(this)||this).ac=o,t.streamCenter=n,t.logger=r,t.stateCenter=i,t.audioMixing=new p.audioMixUtil(r,t.ac),t.init(),t.bindWindowListener(),t}return o(t,e),t.prototype.getSocket=function(e){return new WebSocket(e)},t.prototype.enableCamera=function(e,t){return this.logger.debug("zc.p.ec.0 call"),"boolean"!=typeof t?(this.logger.error("zc.p.ec.0 argument is not bool"),!1):this.streamCenter.enableCamera(e,t)},t.prototype.enableMicrophone=function(e,t){return this.logger.debug("zc.p.em.0 call"),"boolean"!=typeof t?(this.logger.error("zc.p.em.0 argument is not bool"),!1):this.streamCenter.enableMicrophone(e,t)},t.prototype.setLocalAudioOutput=function(e,t){return this.logger.debug("zc.p.slao call"),"string"!=typeof t?(console.error("audiooutput is not string"),!1):this.streamCenter.setStreamAudioOutput(e,t)},t.prototype.setPlayAudioOutput=function(e,t){return this.logger.debug("zc.p.spao call"),"string"!=typeof t?(console.error("audiooutput is not string"),!1):this.streamCenter.setPlayStreamAudioOutput(e,t)},t.prototype.setCustomSignalUrl=function(e){if(this.logger.debug("zc.p.scs.0 call: "+e),!e||0==e.length)return this.logger.error("zc.p.scs.0 param error"),!1;var t=!0;if(e.forEach((function(e){return 0!=e.indexOf("wss://")&&(t=!1)})),!t)return this.logger.error("zc.p.scs.0 url is not correct"),!1;this.stateCenter.customUrl=e},t.prototype.setQualityMonitorCycle=function(e){"number"==typeof e&&e>=1e3&&this.streamCenter.setQualityMonitorCycle(e)},t.prototype.startPlayingStream=function(e,t,r,i){var o=this;if(this.logger.info("zc.p.sps.0 call streamid "+e),!e||""===e)return this.logger.error("zc.p.sps.0 param error"),!1;if(!t)return this.logger.error("zc.p.sps.0 don't have remoteVideo"),!1;if(this.stateCenter.customUrl)return this.streamCenter.setPlayStateStart(e,t,r,i)?this.streamCenter.startPlayingStream(e,this.stateCenter.customUrl):(this.logger.error("zc.p.sps.0 cannot start play"),!1);if(!this.stateCenter.isLogin())return this.logger.error("zc.p.sps.0 not login"),!1;for(var n=!1,s=0;s<this.stateCenter.streamList.length;s++)if(this.stateCenter.streamList[s].stream_id===e){n=!0;break}if(0==n&&this.logger.info("zc.p.sps.0 cannot find stream"),this.stateCenter.pullLimited||(e=NaN+e),!this.streamCenter.setPlayStateStart(e,t,r,i))return this.logger.info("zc.p.sps.0 cannot start play"),!1;var a={stream_id:e,ptype:"pull",signals:this.streamCenter.getAllInUseUrl()};return this.socketCenter.registerRouter("webrtc_url",(function(e){o.handleFetchWebRtcUrlRsp(e)})),this.socketCenter.sendMessage("webrtc_url",a,void 0,(function(t,r){t==c.sdkErrorList.SEND_MSG_TIMEOUT?o.onPlayStateUpdate(c.ENUM_PLAY_STATE_UPDATE.error,e,d.playErrorList.DISPATCH_TIMEOUT):o.onPlayStateUpdate(c.ENUM_PLAY_STATE_UPDATE.error,e,d.playErrorList.DISPATCH_ERROR),o.streamCenter.stopPlayingStream(e)})),!0},t.prototype.stopPlayingStream=function(e){if(this.logger.info("zc.p.sps.1.0 call"),!e||""===e)return this.logger.info("zc.p.sps.1.0 param error"),!1;var t=this.streamCenter.getTotalStreamId(e),r=this.streamCenter.playerList[t];if(!r||0==r.serverUrls.length||!r.player.signal)return r&&this.logger.error("zc.p.sps.1.0 stream can not be destroyed"),!1;for(var i in this.streamCenter.stopPlayingStream(e),this.stateCenter.streamUrlMap)if(this.stateCenter.streamUrlMap[i]===e){delete this.stateCenter.streamUrlMap[i];break}return this.logger.debug("zc.p.sps.1.0 call success"),!0},t.prototype.startPreview=function(e,t,r,i){if(this.logger.debug("zc.p.sp.0 call"),!e)return this.logger.error("zc.p.sp.0 no localVideo"),!1;if(t.audioBitRate){if("number"!=typeof t.audioBitRate)return void this.logger.error("zc.p.sp.0 audioBitRate must be number");if(t.audioBitRate<48e3)return void this.logger.error("zc.p.sp.0 audioBitRate cannot less 48000");this.stateCenter.audioBitRate=t.audioBitRate}return!!u.ClientUtil.checkPreviewParam(t,this.logger)&&this.streamCenter.startPreview(e,t,r,i)},t.prototype.stopPreview=function(e){return this.logger.debug("zc.p.sp.1 call"),e?this.streamCenter.stopPreview(e):(this.logger.info("zc.p.sp.1 param error"),!1)},t.prototype.startPublishingStream=function(e,t,r,i){var o=this;if(this.logger.info("zc.p.sps.1 call streamid: "+e),!e)return this.logger.error("zc.p.sps.1 param error"),!1;if(!this.streamCenter.checkPreview(t))return this.logger.error("zc.p.sps.1 need preview before publish"),!1;if(i||(i={}),i.audioBitRate=this.stateCenter.audioBitRate,this.stateCenter.customUrl&&0!=this.stateCenter.customUrl.length)return this.stateCenter.publishStreamList[e]={state:c.ENUM_PUBLISH_STREAM_STATE.tryPublish,extra_info:r},this.streamCenter.setPublishStateStart(e,t,i)?this.streamCenter.startPublishingStream(e,this.stateCenter.customUrl):(this.logger.info("zc.p.sps.1 cannot start publish"),!1);if(!this.stateCenter.isLogin())return this.logger.error("zc.p.sps.1 not login"),!1;if(this.stateCenter.publishStreamList[e]={state:c.ENUM_PUBLISH_STREAM_STATE.tryPublish,extra_info:r},!this.streamCenter.setPublishStateStart(e,t,i))return this.logger.error("zc.p.sps.1 cannot start publish"),!1;this.logger.info("zc.p.sps.1 start publish");var n={stream_id:e,ptype:"push",signals:this.streamCenter.getAllInUseUrl(),header_kvs:[{key:"grpc-metadata-push",value:i&&i.cdnUrl||""}]};return this.socketCenter.registerRouter("webrtc_url",(function(e){o.handleFetchWebRtcUrlRsp(e)})),this.socketCenter.sendMessage("webrtc_url",n,void 0,(function(t,r){t==c.sdkErrorList.SEND_MSG_TIMEOUT?o.onPublishStateUpdate(c.ENUM_PUBLISH_STATE_UPDATE.error,e,d.publishErrorList.DISPATCH_TIMEOUT):o.onPublishStateUpdate(c.ENUM_PUBLISH_STATE_UPDATE.error,e,d.publishErrorList.DISPATCH_ERROR),o.streamCenter.stopPublishingStream(e)})),!0},t.prototype.stopPublishingStream=function(e){if(this.logger.info("zc.p.sps.1.1 call streamid: "+e),!e)return this.logger.info("zc.p.sps.1.1 param error"),!1;var t=this.streamCenter.getTotalStreamId(e),r=this.streamCenter.publisherList[t];return r&&0!=r.serverUrls.length&&r.publisher.signal?(this.streamCenter.stopPublishingStream(e),this.stateCenter.publishStreamList[e]&&(this.stateCenter.publishStreamList[e].state>=c.ENUM_PUBLISH_STREAM_STATE.update_info&&this.streamHandler.updateStreamInfo(e,c.ENUM_STREAM_SUB_CMD.liveEnd),delete this.stateCenter.publishStreamList[e]),!0):(r&&this.logger.error("zc.p.sps.1.1 stream can not be destroyed when dispatching"),!1)},t.prototype.preloadEffect=function(e,t,r){var i=this;e&&"number"==typeof e&&t&&"string"==typeof t?this.stateCenter.audioEffectBuffer[e]?this.logger.error("zc.pe.0 audio buffer already exists"):this.audioMixing.preloadEffect(t,(function(t,o){if(t)return i.logger.error("zc.pe.0 effect preload fail "+t),void(r&&r(t));o&&(i.stateCenter.audioEffectBuffer[e]=o,r&&r())})):this.logger.error("zc.pe.0 params error")},t.prototype.playEffect=function(e,t,r){if(e.streamId&&"string"==typeof e.streamId&&e.effectId&&"number"==typeof e.effectId)if(this.stateCenter.audioEffectBuffer[e.effectId]){var i=this.stateCenter.audioEffectBuffer[e.effectId],o=this.getPublisher(e.streamId);o?i?o.playEffect(e,i,t,r):this.logger.error("zc.pe.1 no audio buffer found"):this.logger.error("zc.pe.1 publisher doesn't exist")}else this.logger.error("zc,pe.1 audio buffer dosesn't exists");else this.logger.error("zc.pe.1 params error")},t.prototype.pauseEffect=function(e){if(e&&"string"==typeof e){var t=this.getPublisher(e);t?t.pauseEffect():this.logger.error("zc.pe.2 publisher doesn't exist")}else this.logger.error("zc.pe.2 streamid format error")},t.prototype.resumeEffect=function(e){if(e&&"string"==typeof e){var t=this.getPublisher(e);t?t.resumeEffect():this.logger.error("zc.re.0 publisher doesn't exist")}else this.logger.error("zc.re.0 streamid format error")},t.prototype.unloadEffect=function(e){return e&&"number"==typeof e?(delete this.stateCenter.audioEffectBuffer[e],!0):(this.logger.error("zc.ue.0 params error"),!1)},t.prototype.startMixingAudio=function(e,t,r){return this.logger.debug("zc.sma.0 call"),e&&"string"==typeof e?t?Array.isArray(t)&&0!==t.length?this.streamCenter.startMixingAudio(e,t):t instanceof HTMLMediaElement?this.streamCenter.startMixingAudio(e,[t]):(this.logger.error("zc.sma.0 audio param type error"),!1):(this.logger.error("zc.sma.0 no audio"),!1):(this.logger.error("zc.sma.0 stream id type error"),!1)},t.prototype.stopMixingAudio=function(e,t){return e&&"string"==typeof e?Array.isArray(t)&&0!==t.length||void 0===t?this.streamCenter.stopMixingAudio(e,t):(this.logger.error("zc.sma.0 audio param type error"),!1):(this.logger.error("zc.sma.1 param streamID format error"),!1)},t.prototype.mixingBuffer=function(e,t,r,i){var o=this.getPublisher(e);o?r instanceof ArrayBuffer?o.mixingBuffer(r,i):this.logger.error("zc.mb.0 array buffer not found"):this.logger.error("zc.mb.0 publisher doesn't exist")},t.prototype.stopMixingBuffer=function(e,t){if(!e||"string"!=typeof e)return this.logger.error("zc.sma.1 param streamid format error"),!1;var r=this.getPublisher(e);return r?r.stopMixingBuffer():(this.logger.error("zc.sma.1 publisher doesn't exist"),!1)},t.prototype.setMixingAudioVolume=function(e,t){if(this.logger.debug("zc.sma.2 call"),!e||"string"!=typeof e||"number"!=typeof t||t<0||t>100)return this.logger.error("zc.sma.2 param error"),!1;var r=this.getPublisher(e);return r?r.audioMixing.setMixingAudioVolume(t/100):(this.logger.error("zc.sma.2 publisher doesn't exist"),!1)},t.prototype.getPublisher=function(e){var t=null,r=this.streamCenter.getTotalStreamId(e);return this.streamCenter.publisherList[r]&&this.streamCenter.publisherList[r].publisher&&(t=this.streamCenter.publisherList[r].publisher),t},t.prototype.startScreenShotChrome=function(e){if(!t.screenShotReady)return this.logger.error('zc.b.ss Please install the extension:1. Go to chrome://extensions  2. Check: "Enable Developer mode   3. Click: "Load the unpacked extension... 4. Choose "extension" folder from the repository 5. Reload this page'),!1;window.postMessage({type:"SS_UI_REQUEST",text:"start"},"*"),u.ClientUtil.registerCallback("screenShare",{success:e},this.stateCenter.callbackList)},t.prototype.startScreenSharing=function(e,t,r){var i=this;"getDisplayMedia"in navigator.mediaDevices?navigator.mediaDevices.getDisplayMedia({audio:t,video:{width:e.width||window.screen.width,height:e.height||window.screen.height,frameRate:e.frameRate||15,displaySurface:e.displaySurface||"minitor"}}).then((function(e){i.stateCenter.screenShotStreamList.push({stream:e,type:0}),e.getVideoTracks()[0].onended=function(){var t=i.stateCenter.screenShotStreamList.findIndex((function(t){return t.stream===e}));t>-1&&i.stateCenter.screenShotStreamList.splice(t,1),i.onScreenSharingEnded(e)},r(!0,e)})).catch((function(e){i.logger.error("zc.b.sss "+e),r(!1,null,e)})):this.logger.error("zc.b.sss getDisplayMedia is not supported ")},t.prototype.startScreenShotFirFox=function(e,t,r,i){var o=this,n={video:{width:e.width||window.screen.width,height:e.height||window.screen.height,frameRate:e.frameRate||15},audio:r};n.video.mediaSource=t,navigator.mediaDevices.getUserMedia(n).then((function(e){o.stateCenter.screenShotStreamList.push({stream:e,type:0}),e.getVideoTracks()[0].onended=function(){var t=o.stateCenter.screenShotStreamList.findIndex((function(t){return t.stream===e}));t>-1&&o.stateCenter.screenShotStreamList.splice(t,1),o.onScreenSharingEnded(e)},i(!0,e)})).catch((function(e){o.logger.error("zc.b.ssf "+e),i(!1,null)}))},t.prototype.stopScreenShot=function(e){var t=this,r=[];void 0===e?r=this.stateCenter.screenShotStreamList.slice():r.push({stream:e,type:-1}),r.forEach((function(e){var r=t.stateCenter.screenShotStreamList.findIndex((function(t){return t.stream===e.stream}));r>-1&&(e.stream.getTracks().forEach((function(e){e.stop()})),1===t.stateCenter.screenShotStreamList[r].type&&window.postMessage({type:"SS_UI_CANCEL",text:"start"},"*"),t.stateCenter.screenShotStreamList.splice(r,1))}))},t.prototype.switchDevice=function(e,t,r,i,o){var n=this;"audio"!==e&&"video"!==e||"string"!=typeof r?this.logger.error("zg.sd.0 param error"):this.enumDevices((function(s){var a=s.cameras,c=s.microphones;a.find((function(e){return e.deviceId==r}))||c.find((function(e){return e.deviceId==r}))?n.streamCenter.switchDevice(e,t,r,i,o):n.logger.error("zg.sd.0 can not switch device")}),(function(e){return o&&o(e)}))},t.prototype.WebrtcOnPublishStateUpdateHandle=function(e,t,r){this.stateCenter.publishStreamList[t].state==c.ENUM_PUBLISH_STREAM_STATE.publishing&&this.onPublishStateUpdate(e,t,r)},t.prototype.setCDNInfo=function(e,t){e.urls_flv=t.urls_flv,e.urls_hls=t.urls_m3u8,e.urls_https_flv=t.urls_https_flv,e.urls_https_hls=t.urls_https_m3u8,e.urls_rtmp=t.urls_rtmp},t.prototype.onScreenSharingEnded=function(e){},t.prototype.loginBodyData=function(){return{id_name:this.stateCenter.idName,nick_name:this.stateCenter.nickName,role:this.stateCenter.role,token:this.stateCenter.token,version:c.PROTO_VERSION,room_name:this.stateCenter.roomid,user_state_flag:this.stateCenter.userStateUpdate?1:0,room_create_flag:this.stateCenter.roomCreateFlag,client_type:c.E_CLIENT_TYPE.ClientType_Webrtc,third_token:this.stateCenter.third_token}},t.prototype.screenStreamFrom=function(e,t,r){var i=this,o={};o.audio={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e}},o.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxWidth:window.screen.width,maxHeight:window.screen.height}},!t&&(o.audio=!1),navigator.mediaDevices.getUserMedia(o).then((function(e){i.stateCenter.screenShotStreamList.push({stream:e,type:1}),e.getVideoTracks()[0].onended=function(){var t=i.stateCenter.screenShotStreamList.findIndex((function(t){return t.stream===e}));t>-1&&i.stateCenter.screenShotStreamList.splice(t,1),i.onScreenSharingEnded(e)},r(!0,e)})).catch((function(e){i.logger.error("zc.b.ssf "+e),r(!1,null,e)}))},t.prototype.filterStreamList=function(e){var t={},r={},i={},o=[],n=0;for(var s in this.stateCenter.streamList.forEach((function(t,r){t.stream_id==e&&(n=r)})),this.stateCenter.streamList[n])"urls_flv"!=s&&"urls_https_flv"!=s||(t[s]=this.stateCenter.streamList[n][s]),"urls_m3u8"!=s&&"urls_https_m3u8"!=s||(r[s]=this.stateCenter.streamList[n][s]),"urls_rtmp"==s&&(i[s]=this.stateCenter.streamList[n][s]);var a=window.location.protocol,c=window.navigator.userAgent;if(/Safari/.test(c)&&!/Chrome/.test(c))for(var s in r)r[s]&&r[s].forEach((function(e){-1!==e.indexOf(a)&&o.push(e)}));else if("http:"==a)for(var s in t)t[s]&&t[s].forEach((function(e){-1===e.indexOf("http")&&-1===e.indexOf("https")||o.push(e)}));else if("https:"==a)for(var s in t)t[s]&&t[s].forEach((function(e){-1!==e.indexOf(a)&&o.push(e)}));else if("rtmp:"==a)for(var s in i)i[s]&&i[s].forEach((function(e){-1!==e.indexOf(a)&&o.push(e)}));return o.filter((function(e,t,r){return r.indexOf(e)==t}))},t.prototype.voiceChange=function(e,t){return e&&"number"==typeof e?t&&"string"==typeof t?this.getPublisher(t).voiceChange(e):(this.logger.error("zc.vc.0 stream id error"),!1):(this.logger.error("zc.vc.0 mult error"),!1)},t.prototype.voiceBack=function(e){return this.getPublisher(e).voiceBack()},t.prototype.setPublishStreamConstraints=function(e,t,r,i){this.logger.info("zc.spsc.0 call"),"string"==typeof e&&""!=e?this.streamCenter.setPublishStreamConstraints(e,t,r,i):this.logger.error("zc.spsc.0 stream ID must be string and not empty")},t.prototype.setSoundLevelDelegate=function(e,t){this.logger.info("zc.ssd.0 call"),"boolean"==typeof e?t&&("number"!=typeof t||t<100||t>3e3)?this.logger.error("zc.ssd.0 soundLevel interval must be number which is between 100 and 3000"):this.streamCenter.setSoundLevelDelegate(e,t):this.logger.error("zc.ssd.0 param 1 must be boolean")},t.supportDetection=function(e,t){navigator&&navigator.mediaDevices&&(this.screenShotReady||"getDisplayMedia"in navigator.mediaDevices)?u.ClientUtil.supportDetection(!0,e,t):u.ClientUtil.supportDetection(!1,e,t)},t.prototype.enumDevices=function(e,r){t.enumDevices(e,r)},t.enumDevices=function(e,t){void 0!==navigator.mediaDevices&&void 0!==navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then((function(t){for(var r=[],i=[],o=[],n=0;n<t.length;n++){var s=t[n];"audioinput"===s.kind&&r.push({label:s.label,deviceId:s.deviceId}),"audiooutput"===s.kind&&i.push({label:s.label,deviceId:s.deviceId}),"videoinput"===s.kind&&o.push({label:s.label,deviceId:s.deviceId})}e&&e({microphones:r,speakers:i,cameras:o})})).catch((function(e){t&&t(e)})):t&&t("browser don't support enumerate devices")},t.getAudioInfo=function(e,t,r){if(!e.srcObject)return console.error("srcObject is empty!"),!1;var i=n({},r);return new m.MediaUtil(i).connectToSource(e.srcObject,(function(e){t(e)}))},t.handleDataAvailable=function(e){e.data&&e.data.size>0&&t.recordedBlobs.push(e.data)},t.startRecord=function(e,r,i){return s(this,void 0,void 0,(function(){var o,n;return a(this,(function(s){switch(s.label){case 0:return t.recordedBlobs=[],n={mimeType:"video/webm;codecs=vp9"},MediaRecorder.isTypeSupported(n.mimeType)||(n={mimeType:"video/webm;codecs=vp8"},MediaRecorder.isTypeSupported(n.mimeType)||(n={mimeType:"video/webm"},MediaRecorder.isTypeSupported(n.mimeType)||(n={mimeType:""}))),r&&r.audio?(n={mimeType:"audio/webm"},MediaRecorder.isTypeSupported(n.mimeType)||(n={mimeType:""}),[4,navigator.mediaDevices.getUserMedia({audio:{deviceId:r.audioInput?r.audioInput:""}})]):[3,2];case 1:return o=s.sent(),t.recordType="audio",[3,3];case 2:o=e.captureStream(),s.label=3;case 3:try{t.mediaRecorder=new MediaRecorder(o,n)}catch(e){return console.error("Exception while creating MediaRecorder:",e),i&&i(e),[2]}return t.mediaRecorder.onstop=function(e){console.log("Recorder stopped: ",e),r&&r.audio&&o.getTracks().forEach((function(e){return e.stop()}))},t.mediaRecorder.ondataavailable=t.handleDataAvailable,t.mediaRecorder.start(10),i&&i(),[2]}}))}))},t.stopRecord=function(){t.mediaRecorder?t.mediaRecorder.stop():console.warn("please invoke startRecord first")},t.resumeRecord=function(){t.mediaRecorder?t.mediaRecorder.resume():console.warn("please invoke startRecord first")},t.pauseRecord=function(){t.mediaRecorder?t.mediaRecorder.pause():console.warn("please invoke startRecord first")},t.saveRecord=function(e){if(t.mediaRecorder&&t.recordedBlobs){var r=new Blob(t.recordedBlobs,{type:"video"===t.recordType?"video/webm":"audio/webm"}),i=window.URL.createObjectURL(r);if("string"==typeof e&&""!==e){var o=document.createElement("a");o.style.display="none",o.href=i,o.download=e+".webm",document.body.appendChild(o),o.click(),setTimeout((function(){document.body.removeChild(o),window.URL.revokeObjectURL(i)}),100)}return i}console.warn("please invoke startRecord first")},t.resumeRecordAudio=function(){t.mediaRecorder?t.mediaRecorder.resume():console.warn("please invoke startRecordAudio first")},t.pauseRecordAudio=function(){t.mediaRecorder?t.mediaRecorder.pause():console.warn("please invoke startRecordAudio first")},t.getRecordAudio=function(){if(t.mediaRecorder&&t.recordedBlobs){var e=new Blob(t.recordedBlobs);return window.URL.createObjectURL(e)}console.warn("please invoke startRecordAudio first")},t.takeSnapShot=function(e,t){if(e&&0!==e.videoHeight){var r=document.createElement("canvas");r.width=e.videoWidth,r.height=e.videoHeight,r.getContext("2d").drawImage(e,0,0,r.width,r.height),t.src=r.toDataURL("image/jpeg")}else console.error("video can not empty")},t.saveSnapShot=function(e,t){if(e&&0!==e.videoHeight){var r=document.createElement("canvas");r.width=e.videoWidth,r.height=e.videoHeight,r.getContext("2d").drawImage(e,0,0,r.width,r.height),r.toBlob((function(e){var r=window.URL.createObjectURL(e),i=document.createElement("a");i.style.display="none",i.href=r,i.download=t+".jpeg",document.body.appendChild(i),i.click(),setTimeout((function(){document.body.removeChild(i),window.URL.revokeObjectURL(r)}),100)}))}else console.error("video can not empty")},t.prototype.bindWindowListener=function(){var e=this,t=navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPhone/i)?"pagehide":"beforeunload";window.addEventListener(t,(function(t){for(var r in window.event.cancelBubble=!0,e.streamCenter.publisherList)e.stopPublishingStream(r);for(var r in e.streamCenter.playerList)e.stopPublishingStream(r);console.log(e.streamCenter.playerList),console.log(e.streamCenter.publisherList),e.logout()})),window.addEventListener("message",(function(t){var r=t.data,i=r.type,o=r.streamId,n=r.canRequestAudioTrack;t.origin,"SS_DIALOG_SUCCESS"===i&&e.screenStreamFrom(o,n,u.ClientUtil.actionSuccessCallback("screenShare",e.stateCenter.callbackList)),"SS_DIALOG_CANCEL"===i&&(e.logger.error("zc.b.ss "+i),u.ClientUtil.actionSuccessCallback("screenShare",e.stateCenter.callbackList)(!1,null,i))}))},t.screenShotReady=!1,t.recordType="video",t}(g.BaseCenter);t.ZegoClient=v,window.addEventListener("message",(function(e){var t=e.data,r=t.type,i=(t.streamId,e.origin);i!==window.location.origin&&console.warn("ScreenStream: you should discard foreign event from origin:",i),"SS_PING"===r&&(v.screenShotReady=!0)}))},function(e,t,r){"use strict";var i,o=this&&this.__extends||(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0});var n=r(7),s=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return o(t,e),t.prototype.openWebSocketLogServer=function(e){if(this.url!=e){if(this.url=e,!e)return;if(null!=this.websocket&&2!=this.websocket.readyState&&3!=this.websocket.readyState)return;this.stopWebSocketServer(),this.websocket=new WebSocket(e),this.websocket.onopen=function(e){},this.websocket.onclose=function(e){console.error("onclose   websocket error:",e)},this.websocket.onmessage=function(e){},this.websocket.onerror=function(e){console.error("open log websocket error:"+e)}}},t.prototype.SendHttpsLog=function(){var e=this;if(0!=this.logCacheSend.length){var t=this.logCacheSend.join("\n"),r=new XMLHttpRequest;r.onreadystatechange=function(){if(4==r.readyState)if(200==r.status){if(0==r.responseText.length)return;try{var t=JSON.parse(r.responseText).interval;"number"==typeof t&&e.logUploadInterval!==t&&(e.timeInterval=t,e.openHttpsLogServer(e.url))}catch(e){console.log("send result failed "+e)}}else console.log("send failed "+r.status)},r.open("POST",this.url,!0),r.send(t),this.logCacheSend=[]}},t.prototype.logReportParamList=function(e,t){var r=new Date,i=r.getFullYear()+"/";return i+=(n.D[r.getMonth()+1]||r.getMonth()+1)+"/",i+=(n.D[r.getDate()]||r.getDate())+" ",i+=(n.D[r.getHours()]||r.getHours())+":",i+=(n.D[r.getMinutes()]||r.getMinutes())+":",i+=n.D[r.getSeconds()]||r.getSeconds(),i+="."+r.getTime()%1e3,t.time=i,t.level=e,t.console="rtc",t.appid=this.appid,t.roomid=this.roomid,t.userid=this.userid,t.id_name=this.userid,t.userName=this.userName,t.sessionid=this.sessionid,t.version=this.version,[JSON.stringify(t)]},t}(n.Logger);t.LoggerWeb=s},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=r(0);t.D=["00","01","02","03","04","05","06","07","08","09"];var o=function(){function e(){this.logLevel=i.ENUM_LOG_LEVEL.info,this.logUploadTimer=null,this.logUploadInterval=1e4,this.logCache=[],this.logCacheSend=[],this.logCacheMax=100}return e.prototype.setLogLevel=function(e){this.logLevel<i.ENUM_LOG_LEVEL.debug||this.logLevel>i.ENUM_LOG_LEVEL.report?this.logLevel=i.ENUM_LOG_LEVEL.disable:this.logLevel=e},e.prototype.setRemoteLogLevel=function(e){this.logRemoteLevel<i.ENUM_LOG_LEVEL.debug||this.logRemoteLevel>i.ENUM_LOG_LEVEL.report?this.logRemoteLevel=i.ENUM_LOG_LEVEL.disable:this.logRemoteLevel=e},e.prototype.setSessionInfo=function(e,t,r,i,o,n){this.appid=e,this.roomid=t,this.sessionid=r,this.userid=i,this.userName=o,this.version=n},e.prototype.openLogServer=function(e){try{e.startsWith("wss:")?(this.logType=i.ENUM_REMOTE_TYPE.websocket,this.openWebSocketLogServer(e)):e.startsWith("https:")?(this.logType=i.ENUM_REMOTE_TYPE.https,this.openHttpsLogServer(e)):this.logType=i.ENUM_REMOTE_TYPE.disable}catch(e){this.error(JSON.stringify(e))}},e.prototype.stopLogServer=function(){this.logType==i.ENUM_REMOTE_TYPE.websocket?this.stopWebSocketServer():this.logType==i.ENUM_REMOTE_TYPE.https&&(this.SendHttpsLog(),this.stopHttpsServer()),this.logType=i.ENUM_REMOTE_TYPE.disable},e.prototype.stopWebSocketServer=function(){this.websocket&&(this.websocket.onclose=null,this.websocket.onerror=null,this.websocket.close(),this.websocket=null)},e.prototype.openHttpsLogServer=function(e){var t=this;this.url=e,e&&(this.stopHttpsServer(),this.logUploadTimer||(this.logUploadTimer=setInterval((function(){t.SendHttpsLog()}),this.logUploadInterval)))},e.prototype.stopHttpsServer=function(){this.logUploadTimer&&(clearInterval(this.logUploadTimer),this.logUploadTimer=null)},e.prototype.report=function(e){var t=this.logReportParamList(i.ENUM_LOG_LEVEL.report,e);this.logLevel!==i.ENUM_LOG_LEVEL.disable&&this.logLevel<=i.ENUM_LOG_LEVEL.report&&console.debug.apply(console,t),this.RemoteLog(i.ENUM_LOG_LEVEL.report,t,!0)},e.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=this.logParamList(i.ENUM_LOG_LEVEL.debug,e.join(""));this.logLevel!==i.ENUM_LOG_LEVEL.disable&&this.logLevel<=i.ENUM_LOG_LEVEL.debug&&console.debug.apply(console,r),this.log(i.ENUM_LOG_LEVEL.debug,r)},e.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=this.logParamList(i.ENUM_LOG_LEVEL.info,e.join(""));this.logLevel!==i.ENUM_LOG_LEVEL.disable&&this.logLevel<=i.ENUM_LOG_LEVEL.info&&console.info.apply(console,r),this.log(i.ENUM_LOG_LEVEL.info,r)},e.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=this.logParamList(i.ENUM_LOG_LEVEL.warn,e.join(""));this.logLevel!==i.ENUM_LOG_LEVEL.disable&&this.logLevel<=i.ENUM_LOG_LEVEL.warn&&console.warn.apply(console,r),this.log(i.ENUM_LOG_LEVEL.warn,r)},e.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=this.logParamList(i.ENUM_LOG_LEVEL.error,e.join(""));this.logLevel!==i.ENUM_LOG_LEVEL.disable&&this.logLevel<=i.ENUM_LOG_LEVEL.error&&console.error.apply(console,r),this.log(i.ENUM_LOG_LEVEL.error,r)},e.prototype.log=function(e,t){this.logRemoteLevel!==i.ENUM_LOG_LEVEL.disable&&this.logRemoteLevel<=e&&this.RemoteLog(e,t)},e.prototype.RemoteLog=function(e,t,r){if(void 0===r&&(r=!1),""!=this.url)if(this.logType==i.ENUM_REMOTE_TYPE.websocket)this.RemoteWebSocketLog(e,t);else if(this.logType==i.ENUM_REMOTE_TYPE.https)this.RemoteHttpsLog(e,t,r);else if(this.logLevel!==i.ENUM_LOG_LEVEL.disable&&this.logLevel<=e)for(this.logCacheSend.push(t);this.logCacheSend.length>this.logCacheMax;)this.logCacheSend.shift()},e.prototype.RemoteWebSocketLog=function(e,t){if("string"==typeof t&&t.length>4e3)console.info("log over maximum, ignore");else if(null==this.websocket||2==this.websocket.readyState||3==this.websocket.readyState){var r=this.url;this.url="",this.openLogServer(r),this.logCacheSend.length<this.logCacheMax&&this.logCacheSend.push(t)}else if(0==this.websocket.readyState)this.logCacheSend.length<this.logCacheMax&&this.logCacheSend.push(t);else if(1==this.websocket.readyState)if(this.logCacheSend.length>0){for(var i="",o=0;o<this.logCacheSend.length;o++)(i+this.logCacheSend[o]).length>4e3&&(this.websocket.send(i),i=""),i=i+this.logCacheSend[o]+"\n";t=i+t,this.logCacheSend=[],this.websocket.send(t)}else this.websocket.send(t);else console.warn("wrong socket state:"+this.websocket.readyState),this.logCacheSend.length<this.logCacheMax&&this.logCacheSend.push(t)},e.prototype.RemoteHttpsLog=function(e,t,r){this.logCacheSend.push(t),(this.logCacheSend.length>=this.logCacheMax||!0===r)&&this.SendHttpsLog()},e.prototype.logParamList=function(e,r){var i=new Date,o=i.getFullYear()+"/";o+=(t.D[i.getMonth()+1]||i.getMonth()+1)+"/",o+=(t.D[i.getDate()]||i.getDate())+" ",o+=(t.D[i.getHours()]||i.getHours())+":",o+=(t.D[i.getMinutes()]||i.getMinutes())+":",o+=t.D[i.getSeconds()]||i.getSeconds(),o+="."+i.getTime()%1e3;var n=r.substr(0,r.indexOf(" "));0==n.length&&(n=r);var s=r.substr(r.indexOf(" ")+1,4500);0==s.length&&(s="");var a={time:o,level:e,action:n,content:s,appid:this.appid,roomid:this.roomid,userid:this.userid,userName:this.userName,sessionid:this.sessionid};return[JSON.stringify(a)]},e}();t.Logger=o},function(e,t,r){"use strict";var i,o=this&&this.__extends||(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0});var n=r(9),s=r(10),a=r(11),c=r(2),d=r(0),l=r(14),h=r(15),u=r(16),p=r(1),g=function(e){function t(t,r,i){var o=e.call(this,t,r)||this;return o.testEnvironment=!1,o.heartbeatTimer=null,o.heartbeatInterval=1e4,o.chargeInfos={itemtype:"ChargeInfos",timestamp_begin:0,timestamp_end:0,timestamp_diff_flag:0,timestamp_diff:0,infos:[]},o.chargeInfosTimer=null,o.chargeInfosInterval=6e4,o.qualityTimerInterval=3e3,o.maxRetryCount=5,o.previewVideoList=[],o.signalList={},o.deviceStates={camera:0,microphone:0},o.soundLevelDelegate=!1,o.soundLevelInterval=1e3,o.soundLevelTimer=null,o.tryCountConnectInterval=3e3,o.checkMessageTimeout=function(){for(var e in o.signalList)o.signalList[e].signal&&o.signalList[e].signal.checkMessageTimeout()},o.getAllInUseUrl=function(){var e=[];for(var t in o.signalList)e.push(t);return e},o.onDisconnectHandle=function(e){if(o.logger.info("zsc.od.0 call"),o.signalList[e]){var t=o.signalList[e];delete o.signalList[e];for(var r=0;r<t.publishConnectedList.length;r++){var i=o.publisherList[t.publishConnectedList[r]];i&&i.publisher&&i.publisher.onDisconnect()}for(r=0;r<t.playConnectedList.length;r++){var n=o.playerList[t.playConnectedList[r]];n&&n.player&&n.player.onDisconnect()}o.stopSignalHeartbeat(),o.stopChargeInfosUpload(),o.stopSoundLevel()}},o.logger=t,o.stateCenter=r,o.dataReport=new n.ZegoDataReport(o.logger),o.ac=i,o}return o(t,e),t.prototype.onSignalDisconnected=function(e){},t.prototype.setQualityMonitorCycle=function(e){this.logger.debug("zsc.qmc.0 timeInterval "+e),this.qualityTimerInterval=e},t.prototype.setSessionInfo=function(e,t,r,i){this.logger.debug("zsc.ssi.0 called"),this.appid=e,this.userid=t,this.token=r,this.testEnvironment=i},t.prototype.onPlayStateUpdate=function(e,t,r){},t.prototype.onPlayQualityUpdate=function(e,t){},t.prototype.onPublishStateUpdate=function(e,t,r){},t.prototype.onPublishQualityUpdate=function(e,t){},t.prototype.onUpdateHeartBeartIntervalHandle=function(e){e!=this.heartbeatInterval&&(this.logger.debug("zsc.uhb.0 update "+e),this.heartbeatTimer&&(clearTimeout(this.heartbeatTimer),this.heartbeatTimer=null),this.heartbeatInterval=e,this.startSignalHeartbeat())},t.prototype.switchDevice=function(e,t,r,i,o){var n,s,a,d,l,h,u=this,p=null,g=/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent);if(n=this.checkPreview(t)){delete(s=n.mediaStreamConfig).facingMode,"video"===e?(s.videoInput=r,d=t.srcObject.getVideoTracks()[0]):(s.audioInput=r,d=t.srcObject.getAudioTracks()[0]),!g&&d.stop();var f=n.getMediaStreamConstraints(s);navigator.mediaDevices.getUserMedia(f).then((function(r){for(var o in"video"===e?(l=r.getVideoTracks()[0],n.localStream.removeTrack(n.localStream.getVideoTracks()[0])):(l=r.getAudioTracks()[0],n.localStream.removeTrack(n.localStream.getAudioTracks()[0])),u.publisherList)u.publisherList[o].localVideo===t&&(h=o);h&&(p=u.publisherList[h].publisher,(a=p.peerConnection.getSenders().find((function(e){return e.track.kind===l.kind})))?a.replaceTrack(l):u.logger.warn("zg.sd.0 no sender found, only swithcing device on localMediaElement")),n.localStream.addTrack(l),p.signal.sendStreamStatus(c.getSeq(),p.sessionId,n.localStream.getVideoTracks()[0].enabled?0:2,n.localStream.getAudioTracks()[0].enabled?0:2),i&&i()}),(function(e){return o&&o(e)}))}else this.logger.error("zg.sd.0 no preview found")},t.prototype.enableMicrophone=function(e,t){var r=this.checkPreview(e);return r?r.enableMicrophone(t,this):(this.logger.info("zsc.em.0 no preview"),!1)},t.prototype.enableCamera=function(e,t){var r=this.checkPreview(e);return r?r.enableCamera(t,this):(this.logger.error("zsc.ec.0 no preview"),!1)},t.prototype.recordDevices=function(e){var t=this,r=this.checkPreview(e);r?(this.logger.info("zsc.rd.0 call"),p.ClientUtil.getDevices((function(e){t.stateCenter.deviceInfos={microphones:e.microphones,speakers:e.speakers,cameras:e.cameras}}),(function(e){t.logger.warn("zsc.rd.0 getDevices err:",e)})),this.videoDeviceName=0!==r.localStream.getVideoTracks().length?r.localStream.getVideoTracks()[0].label:"",this.audioDeviceName=0!==r.localStream.getAudioTracks().length?r.localStream.getAudioTracks()[0].label:"",navigator.mediaDevices&&void 0!==navigator.mediaDevices.ondevicechange&&(navigator.mediaDevices.ondevicechange=function(r){t.logger.info("zsc.rd.0 devicechange"),t.stateCenter.deviceChangeTimer&&(clearTimeout(t.stateCenter.deviceChangeTimer),t.stateCenter.deviceChangeTimer=null),t.stateCenter.deviceChangeTimer=setTimeout((function(){p.ClientUtil.getDevices((function(r){var i,o=!1;for(var n in r.cameras.find((function(e){return e.deviceName===t.videoDeviceName}))?t.deviceStates.camera=0:(t.deviceStates.camera=-6,o=!0,t.onDeviceError({deviceName:t.videoDeviceName,deviceType:"camera",errorCode:-6})),r.microphones.find((function(e){return e.deviceName===t.audioDeviceName}))?t.deviceStates.microphone=0:(t.deviceStates.microphone=-6,o=!0,t.onDeviceError({deviceName:t.audioDeviceName,deviceType:"microphone",errorCode:-6})),t.publisherList)t.publisherList[n].localVideo===e&&(i=n);if(o&&i){var s=t.getPublisher(i);s.signal.sendStreamStatus(c.getSeq(),s.sessionId,t.deviceStates.camera,t.deviceStates.microphone)}var a=t.stateCenter.deviceInfos.cameras.filter((function(e){return!r.cameras.find((function(t){return t.deviceID===e.deviceID}))})),d=t.stateCenter.deviceInfos.microphones.filter((function(e){return!r.microphones.find((function(t){return t.deviceID===e.deviceID}))})),l=t.stateCenter.deviceInfos.speakers.filter((function(e){return!r.speakers.find((function(t){return t.deviceID===e.deviceID}))})),h=r.cameras.filter((function(e){return!t.stateCenter.deviceInfos.cameras.find((function(t){return t.deviceID===e.deviceID}))})),u=r.microphones.filter((function(e){return!t.stateCenter.deviceInfos.microphones.find((function(t){return t.deviceID===e.deviceID}))})),p=r.speakers.filter((function(e){return!t.stateCenter.deviceInfos.speakers.find((function(t){return t.deviceID===e.deviceID}))}));a.forEach((function(e){var r={deviceInfo:e,state:"DELETE"};t.OnVideoDeviceStateChanged(r)})),d.forEach((function(e){var r={deviceType:"Input",deviceInfo:e,state:"DELETE"};t.OnAudioDeviceStateChanged(r)})),l.forEach((function(e){var r={deviceType:"Output",deviceInfo:e,state:"DELETE"};t.OnAudioDeviceStateChanged(r)})),h.forEach((function(e){var r={deviceInfo:e,state:"ADD"};t.OnVideoDeviceStateChanged(r)})),u.forEach((function(e){var r={deviceType:"Input",deviceInfo:e,state:"ADD"};t.OnAudioDeviceStateChanged(r)})),p.forEach((function(e){var r={deviceType:"Output",deviceInfo:e,state:"ADD"};t.OnAudioDeviceStateChanged(r)})),t.stateCenter.deviceInfos={microphones:r.microphones,speakers:r.speakers,cameras:r.cameras}}),(function(e){t.logger.warn("zsc.rd.0 getDevices err:",e)}))}),10)})):this.logger.error("zsc.rd.0 no localVideo found")},t.prototype.startPreview=function(e,t,r,i){var o=this;if(!e)return this.logger.error("zsc.sp.0 localVideo null"),!1;var n=this.checkPreview(e);return n?(this.logger.warn("zsc.sp.0 localvideo already exist"),!0):(n=new s.ZegoPreview(this.logger),this.previewVideoList.push(n),n.startPreview(e,t,(function(){o.logger.debug("zsc.sp.0 call success"),o.recordDevices(e),r&&r()}),(function(e){o.previewVideoList=o.previewVideoList.filter((function(e){return e!==n})),i&&i(e)})),!0)},t.prototype.stopPreview=function(e){if(!e)return this.logger.warn("zsc.sp.0 localVideo null"),!1;for(var t in this.publisherList)this.publisherList[t].localVideo===e&&(this.publisherList[t].localVideo=null);var r=this.checkPreview(e);return r?(r.previewSuc&&(r.stopPreview(),this.removePreview(r)),!0):(this.logger.warn("zsc.sp.0 no preview"),!1)},t.prototype.setPublishStateStart=function(e,t,r){var i=this,o=this.getTotalStreamId(e);if(this.publisherList[o])return this.logger.error("zsc.pss.0 publisher already exist"),!1;var n=new a.ZegoPublish(this.logger,null,this.dataReport,this.qualityTimerInterval,this);return n.onPublishStateUpdate=function(t,r,o){var n=i.publisherList[r];n?i.onPublishStateUpdate(t,n.streamId,o):i.logger.error("zsc.psuh.0 cannot find publish "+e)},n.onPublishQualityUpdate=function(t,r){var o=i.publisherList[t];o?i.onPublishQualityUpdate(o.streamId,r):i.logger.error("zsc.psuh.0 cannot find publish "+e)},this.publisherList[o]={localVideo:t,publisher:n,serverUrls:[],retryCount:0,streamId:e,playOption:r,tryCountConnect:1,countConnectTimer:void 0},this.dataReport.eventStart(n.reportSeq,"GetSignalUrl"),!0},t.prototype.getTotalStreamId=function(e){if(this.testEnvironment&&-1==e.indexOf("zegotest-")){var t="zegotest-"+this.appid+"-"+e;return this.logger.info("zsc.gts.0 test streamid "+t),t}return e},t.prototype.getBackStreamId=function(e){return this.testEnvironment&&e?e.replace("zegotest-"+this.appid+"-",""):e},t.prototype.startPublishingStream=function(e,t,r){this.logger.info("zsc.sps.0 call");var i=this.getTotalStreamId(e),o=this.publisherList[i];if(!o)return this.logger.error("zsc.sps.0 publisher don't exist"),!1;var n=o.publisher;if(this.dataReport.eventEndWithMsg(n.reportSeq,"GetSignalUrl",{urls:t}),!t||0===t.length)return this.onPublishStateUpdate(c.ENUM_PUBLISH_STATE_UPDATE.error,e,c.publishErrorList.DISPATCH_ERROR),this.logger.info("zsc.sps.0 server don't have signal url"),!1;o.serverUrls=o.serverUrls.concat(t);var s=t.indexOf(this.server);return-1!==s&&(o.serverUrls.splice(s,1),o.serverUrls.unshift(this.server)),this.connectPublishServer(i)},t.prototype.updateWaitingList=function(e,t,r,i,o){t?e.publishWaitingList.push({streamId:r,success:i,error:o}):e.playWaitingList.push({streamId:r,success:i,error:o})},t.prototype.publishStream=function(e){var t=this.publisherList[e].publisher;if(t){var r=null,i=null,o=this.publisherList[e].playOption,n=this.checkPreview(this.publisherList[e].localVideo);n&&(r=n.localStream,i=n.videoInfo),r?(this.logger.debug("zsc.ps.0 call success"),t.startPublish(e,r,i,n.mediaStreamConfig,o)):this.logger.error("zsc.ps.0 no localStream found before publish")}else this.logger.info("zsc.ps.0 publisher don't exist")},t.prototype.connectPublishServer=function(e){var t=this,r=this.publisherList[e];return r?(this.dataReport.eventStart(r.publisher.reportSeq,"ConnectServer"),this.connetWithReuseSignalServerTimer(e,!0,(function(e,r,i){var o=t.publisherList[e];if(o){var n=o.publisher;if(n){t.dataReport.eventEndWithMsg(n.reportSeq,"ConnectServer",{result:0,server:i});var s=r.tokenInfo;t.logger.info("zsc.cps.0 update token success"),s&&s.report&&(n.qualityUpload=s.report,n.qualityUploadInterval=s.report_interval),n.signal=r.signal,o.retryCount=0,t.server=i,t.publishStream(e),t.getTokenSuccess()}else t.logger.info("zsc.cps.1 check publisher don't exist")}else t.logger.info("zsc.cps.0 after connect publisher don't exist")}),(function(e,r){t.logger.error("zsc.cps.0 "+e+" connect fail "+r);var i=t.publisherList[e];i?t.shouldRetry(i,r)?(t.logger.info("zsc.cps.1 retry connect"),i.serverUrls.splice(0,1),i.retryCount+=1,t.connectPublishServer(e)):t.onPublishStateUpdate(c.ENUM_PUBLISH_STATE_UPDATE.error,e,c.publishErrorList.DISPATCH_TIMEOUT):t.logger.info("zsc.cps.0 after connect publisher don't exist")})),!0):(this.logger.error("zsc.cps.0 publisher don't exist"),!1)},t.prototype.shouldRetry=function(e,t){return 0!=e.serverUrls.length&&!(e.retryCount>=this.maxRetryCount)&&3==t},t.prototype.getTokenSuccess=function(){this.logger.debug("zsc.gts.0 call")},t.prototype.stopPublishingStream=function(e){var t=this.getTotalStreamId(e),r=this.publisherList[t];r?(this.publisherList[t].countConnectTimer&&clearTimeout(this.publisherList[t].countConnectTimer),delete this.publisherList[t],r.publisher&&(r.publisher.stopPublish(),delete r.publisher),this.removeStreamFromSignal(!0,t),this.stopSignalHeartbeat(),this.stopChargeInfosUpload(),this.stopSoundLevel(),this.logger.debug("zsc.sps.0.1 call success")):this.logger.warn("zsc.sps.0.1 publisher don't exist")},t.prototype.setPlayStreamAudioOutput=function(e,t){var r=this.getTotalStreamId(e);if(null!=t&&0!=t.length){this.logger.debug("zsc.psao.1 device "+t);var i=this.playerList[r];return i?i.player?i.player.setAudioDestination(t):(this.logger.info("zsc.psao.1 player don't exist"),!1):(this.logger.info("zsc.psao.1 play don't exist"),!1)}return!1},t.prototype.setStreamAudioOutput=function(e,t){var r=this;return!(null==t||0==t.length||!e||(this.logger.debug("zsc.ssao.0 device "+t),e?"undefined"!==e.sinkId?(e.setSinkId(t).then((function(){r.logger.info("zsc.ssao.0 success device: "+t)})).catch((function(e){r.logger.info("zsc.ssao.0 "+e.name)})),0):(this.logger.error("zsc.ssao.0 browser does not suppport"),1):(this.logger.error("zsc.ssao.0 no localVideo"),1)))},t.prototype.connetWithReuseSignalServer=function(e,t,r,i,o){var n=this;this.logger.info("zsc.crss.0 begin "+r);var s=null;if(this.signalList[r])(s=this.signalList[r]).state==d.ENUM_SIGNAL_STATE.connected?(this.logger.info("zsc.crss.0 already connected "+r+" streamId: "+e),t?s.publishConnectedList.push(e):s.playConnectedList.push(e),i(e,s)):s.state==d.ENUM_SIGNAL_STATE.connecting&&(this.logger.debug("zsc.crss.0 signal is connecting "+r+" streamId: "+e),this.updateWaitingList(s,t,e,i,o));else{this.logger.info("zsc.crss.0 new signal "+r+" streamId: "+e);var a=new l.ZegoSignal(this.logger,this.stateCenter);a.setSessionInfo(this.appid,this.userid),a.onUpdateHeartBeartInterval=this.onUpdateHeartBeartIntervalHandle.bind(this),a.onDisconnect=this.onDisconnectHandle,this.signalList[r]={signal:a,state:d.ENUM_SIGNAL_STATE.connecting,publishWaitingList:[],playWaitingList:[],publishConnectedList:[],playConnectedList:[],tokenInfo:null,isTimeOut:!1},this.updateWaitingList(this.signalList[r],t,e,i,o),a.connectServer(this.token,r,(function(e,t,i){(s=n.signalList[r]).isTimeOut&&(n.logger.error("zsc.crss.0 connected "+t+" over time"),a.disconnectServer(),delete n.signalList[r]);var o,c,l=0;if(0!=e){for(n.logger.debug("zsc.crss.0 connect failed "+t),l=0;l<s.publishWaitingList.length;l++)(o=s.publishWaitingList[l]).error&&o.error(o.streamId,e);for(l=0;l<s.playWaitingList.length;l++)(c=s.playWaitingList[l]).error&&c.error(c.streamId,e);delete n.signalList[r]}else{for(n.logger.debug("zsc.crss.0 connected success "+t),s.state=d.ENUM_SIGNAL_STATE.connected,s.tokenInfo=i,l=0;l<s.publishWaitingList.length;l++)(o=s.publishWaitingList[l]).success&&o.success(o.streamId,s),s.publishConnectedList.push(o.streamId);for(l=0;l<s.playWaitingList.length;l++)(c=s.playWaitingList[l]).success&&c.success(c.streamId,s),s.playConnectedList.push(c.streamId);s.publishWaitingList=[],s.playWaitingList=[],null==n.heartbeatTimer&&n.startSignalHeartbeat(),null==n.chargeInfosTimer&&n.startChargeInfosUpload(),null==n.soundLevelTimer&&n.soundLevelDelegate&&n.startSoundLevel()}}))}},t.prototype.setPlayStateStart=function(e,t,r,i){var o=this.getTotalStreamId(e);if(this.playerList[o])return this.logger.warn("zsc.pss.1 player already exist"),!1;var n=new h.ZegoPlayWeb(this.logger,null,this.dataReport,this.qualityTimerInterval,this);return n.onPlayStateUpdate=this.onPlayStateUpdate,n.onPlayQualityUpdate=this.onPlayQualityUpdate,n.onVideoSizeChanged=this.onVideoSizeChanged,n.onRemoteCameraStatusUpdate=this.onRemoteCameraStatusUpdate,n.onRemoteMicStatusUpdate=this.onRemoteMicStatusUpdate,this.playerList[o]={player:n,remoteVideo:t,audioOutput:r,signal:null,serverUrls:[],retryCount:0,playOption:i,tryCountConnect:1,countConnectTimer:void 0},this.dataReport.eventStart(n.reportSeq,"GetSignalUrl"),!0},t.prototype.startPlayingStream=function(e,t,r){this.logger.info("zsc.sps.1 start play called");var i=this.getTotalStreamId(e),o=this.playerList[i];if(!o)return this.logger.error("zsc.sps.1 player don't exist"),!1;var n=o.player;if(this.dataReport.eventEndWithMsg(n.reportSeq,"GetSignalUrl",{urls:t}),0==t.length)return this.onPlayStateUpdate(c.ENUM_PLAY_STATE_UPDATE.error,e,c.playErrorList.DISPATCH_ERROR),this.logger.info("zsc.sps.1 server don't have signal url"),!1;o.serverUrls=o.serverUrls.concat(t);var s=t.indexOf(this.server);return-1!==s&&(o.serverUrls.splice(s,1),o.serverUrls.unshift(this.server)),this.connectPlayServer(i)},t.prototype.connectPlayServer=function(e){var t=this,r=this.playerList[e];return r?(this.dataReport.eventStart(r.player.reportSeq,"ConnectServer"),this.connetWithReuseSignalServerTimer(e,!1,(function(e,r,i){var o=t.playerList[e];if(o){var n=o.player;if(n){t.dataReport.eventEndWithMsg(n.reportSeq,"ConnectServer",{result:0,server:i});var s=r.tokenInfo;t.logger.info("zsc.cps.1 update token success"),s&&s.report&&(n.qualityUpload=s.report,n.qualityUploadInterval=s.report_interval),n.signal=r.signal,o.retryCount=0,t.server=i,t.playStream(e),t.getTokenSuccess()}else t.logger.error("zsc.cps.1 checkplayer don't exist")}else t.logger.error("zsc.cps.1 after connect player don't exist")}),(function(e,r){var i=t.playerList[e];i?t.shouldRetry(i,r)?(t.logger.info("zsc.cps.1 retry connect"),i.serverUrls[0],i.serverUrls.splice(0,1),i.retryCount+=1,t.connectPlayServer(e)):t.onPlayStateUpdate(c.ENUM_PLAY_STATE_UPDATE.error,e,c.playErrorList.TOKEN_ERROR):t.logger.error("zsc.cps.1 after connect player don't exist")})),!0):(this.logger.error("zsc.cps.1 player don't exist"),!1)},t.prototype.connetWithReuseSignalServerTimer=function(e,t,r,i){var o,n,s,a,c=this;if(t&&this.publisherList[e]){if(s=(o=this.publisherList[e].serverUrls)[0==(a=(this.publisherList[e].tryCountConnect-1)%o.length)?o.length-1:a-1],1!==this.publisherList[e].tryCountConnect&&this.signalList[s]&&(this.signalList[s].isTimeOut=!0),this.publisherList[e].tryCountConnect>3*o.length)return void this.logger.error("zs.crsst.0 beyond max limit");this.publisherList[e].countConnectTimer=setTimeout((function(){c.connetWithReuseSignalServerTimer(e,t,r,i)}),this.tryCountConnectInterval),n=o[a],this.logger.info("zs.crsst.0 called "+this.publisherList[e].tryCountConnect+" "+n),this.connetWithReuseSignalServer(e,t,n,(function(t,i){clearTimeout(c.publisherList[e].countConnectTimer),c.publisherList[e].tryCountConnect=1,r(t,i,n)}),this.publisherList[e].tryCountConnect===3*o.length?i:void 0),++this.publisherList[e].tryCountConnect}else if(!t&&this.playerList[e]){if(s=(o=this.playerList[e].serverUrls)[0==(a=(this.playerList[e].tryCountConnect-1)%o.length)?o.length-1:a-1],1!==this.playerList[e].tryCountConnect&&this.signalList[s]&&(this.signalList[s].isTimeOut=!0),this.playerList[e].tryCountConnect>3*o.length)return void this.logger.error("zs.crsst.0 beyond max limit");this.logger.info("zs.crsst.0 called "+this.playerList[e].tryCountConnect),this.playerList[e].countConnectTimer=setTimeout((function(){c.connetWithReuseSignalServerTimer(e,t,r,i)}),this.tryCountConnectInterval),n=o[(this.playerList[e].tryCountConnect-1)%o.length],this.connetWithReuseSignalServer(e,t,n,(function(t,i){clearTimeout(c.playerList[e].countConnectTimer),c.playerList[e].tryCountConnect=1,r(t,i,n)}),this.playerList[e].tryCountConnect===3*o.length?i:void 0),++this.playerList[e].tryCountConnect}},t.prototype.playStream=function(e){var t=this.playerList[e].player;t?(this.logger.info("zsc.ps.1 call success"),t.startPlay(e,this.playerList[e].remoteVideo,this.playerList[e].audioOutput,this.playerList[e].playOption)):this.logger.warn("zsc.ps.1 player don't exist")},t.prototype.removeStreamFromSignal=function(e,t){var r=[];for(var i in this.signalList){var o=this.signalList[i];if(e){for(var n=0;n<o.publishConnectedList.length;n++)if(o.publishConnectedList[n]===t){this.logger.debug("zsc.rsfs.0 found from publish"),o.publishConnectedList.splice(n,1);break}}else for(var s=0;s<o.playConnectedList.length;s++)if(o.playConnectedList[s]===t){this.logger.debug("zsc.rsfs.0 found from play"),o.playConnectedList.splice(s,1);break}0==o.publishConnectedList.length&&0==o.playConnectedList.length&&(o.signal.disconnectServer(),r.push(i))}for(var a=0;a<r.length;a++)delete this.signalList[r[a]]},t.prototype.stopSignalHeartbeat=function(){this.logger.debug("zsc.ssh.1 call");var e=0;for(var t in this.signalList)e+=1;this.heartbeatTimer&&0==e&&(this.logger.info("zsc.ssh.1 stop"),clearTimeout(this.heartbeatTimer),this.heartbeatTimer=null)},t.prototype.stopChargeInfosUpload=function(){this.logger.debug("zsc.sciu.0 call");var e=0;for(var t in this.signalList)e+=1;this.chargeInfosTimer&&0==e&&(this.logger.info("zsc.sciu.0 stop"),clearTimeout(this.chargeInfosTimer),this.chargeInfosTimer=null)},t.prototype.getPublisher=function(e){var t=null,r=this.getTotalStreamId(e);return this.publisherList[r]&&this.publisherList[r].publisher&&(t=this.publisherList[r].publisher),t},t.prototype.stopPlayingStream=function(e){var t=this.getTotalStreamId(e),r=this.playerList[t];r?(this.playerList[t].countConnectTimer&&clearTimeout(this.playerList[t].countConnectTimer),delete this.playerList[t],r.player&&(r.player.stopPlay(),delete r.player),this.removeStreamFromSignal(!1,t),this.stopSignalHeartbeat(),this.stopChargeInfosUpload(),this.stopSoundLevel(),this.logger.debug("zsc.sps.1.1 call success")):this.logger.info("zsc.sps.1.1 player don't exist")},t.prototype.reset=function(){for(var e in this.publisherList)this.publisherList[e].publisher&&this.publisherList[e].publisher.stopPublish();for(var t in this.playerList)this.playerList[t].player&&this.playerList[t].player.stopPlay();for(var r in this.signalList)this.signalList[r].signal&&this.signalList[r].signal.disconnectServer();this.playerList={},this.publisherList={},this.signalList={},this.server="",this.heartbeatTimer&&(clearTimeout(this.heartbeatTimer),this.heartbeatTimer=null)},t.prototype.startSignalHeartbeat=function(){var e=this;this.logger.debug("zsc.ssh.0 call"),this.heartbeatTimer&&(clearTimeout(this.heartbeatTimer),this.heartbeatTimer=null),this.heartbeatTimer=setTimeout((function(){e.checkSignalHeartbeat()}),this.heartbeatInterval)},t.prototype.checkSignalHeartbeat=function(){for(var e in this.logger.debug("zsc.csh.0 call"),this.signalList)this.signalList[e].signal&&this.signalList[e].signal.sendHeartbeat();this.heartbeatTimer&&this.startSignalHeartbeat()},t.prototype.startChargeInfosUpload=function(){var e=this;this.logger.debug("zsc.sciu.0 call"),this.chargeInfosTimer&&(clearTimeout(this.chargeInfosTimer),this.chargeInfosTimer=null),this.chargeInfosTimer=setTimeout((function(){e.checkChargeInfos()}),this.chargeInfosInterval)},t.prototype.checkChargeInfos=function(){this.logger.debug("zsc.cci.0 call");var e={is_publishing:0,play_max_audio_bitrate:0,play_stream_resolution_infos:[]};for(var t in this.chargeInfos.timestamp_begin=(new Date).getTime(),this.publisherList){this.publisherList[t].publisher.state===d.ENUM_PUBLISH_STATE.publishing&&(e.is_publishing=1);break}e.play_max_audio_bitrate=0;var r=function(t){var r=i.playerList[t].remoteVideo,o={video_width:r.videoWidth||0,video_height:r.videoHeight||0,count:1};if(!e.play_stream_resolution_infos.find((function(e){return e.video_width==o.video_width&&e.video_height==o.video_height&&(e.count++,!0)}))&&e.play_stream_resolution_infos.push(o),0==o.video_width&&0==o.video_height){var n=1e3*i.playerList[t].player.lastPlayStats.audioBitrate;n>e.play_max_audio_bitrate&&(e.play_max_audio_bitrate=n)}},i=this;for(var o in this.playerList)r(o);0!==this.chargeInfos.timestamp_end?(this.chargeInfos.timestamp_diff=this.chargeInfos.timestamp_begin-this.chargeInfos.timestamp_end,this.chargeInfos.timestamp_diff_flag=1):(this.chargeInfos.timestamp_diff=0,this.chargeInfos.timestamp_diff_flag=0),this.chargeInfos.timestamp_end=(new Date).getTime(),this.chargeInfos.infos=[e],0!==e.play_stream_resolution_infos.length&&this.logger.report(this.chargeInfos),this.chargeInfosTimer&&this.startChargeInfosUpload()},t.prototype.startSoundLevel=function(){var e=this;this.logger.debug("zsc.ssl.0 call"),this.soundLevelTimer&&(clearTimeout(this.soundLevelTimer),this.soundLevelTimer=null),this.soundLevelTimer=setTimeout((function(){e.checkSoundLevel()}),this.soundLevelInterval)},t.prototype.checkSoundLevel=function(){this.logger.debug("zsc.csl.0 call");var e=[];for(var t in this.publisherList){var r=this.publisherList[t].publisher;e.push({streamID:this.getBackStreamId(r.streamId),soundLevel:r.soundLevel,type:"push"})}for(var t in this.playerList){var i=this.playerList[t].player;e.push({streamID:this.getBackStreamId(i.streamId),soundLevel:i.soundLevel,type:"pull"})}this.soundLevelDelegate&&e.length>0&&this.onSoundLevelUpdate(e),this.soundLevelDelegate&&this.startSoundLevel()},t.prototype.setSoundLevelDelegate=function(e,t){for(var r in this.logger.info("zsc.ssd.0 call"),t&&(this.soundLevelInterval=t),this.soundLevelDelegate=e,this.publisherList){var i=this.publisherList[r].publisher;e?i.startSoundLevel():i.stopSoundLevel()}for(var r in this.playerList){var o=this.playerList[r].player;e?o.startSoundLevel():o.stopSoundLevel()}if(e){this.logger.info("zsc.ssd.0 start getting sound");var n=0;for(var s in this.signalList)n+=1;null==this.soundLevelTimer&&n>0&&this.startSoundLevel()}else this.logger.info("zsc.ssd.0 stop getting sound"),this.soundLevelTimer&&clearTimeout(this.soundLevelTimer),this.soundLevelTimer=null,this.soundLevelInterval=1e3},t.prototype.stopSoundLevel=function(){var e=0;for(var t in this.signalList)e+=1;this.soundLevelTimer&&0==e&&(this.logger.info("zsc.ssl.0 stop"),clearTimeout(this.soundLevelTimer),this.soundLevelTimer=null,this.soundLevelInterval=1e3)},t.prototype.checkPreview=function(e){for(var t=0;t<this.previewVideoList.length;t++)if(this.previewVideoList[t].localVideo===e)return this.previewVideoList[t];return null},t.prototype.removePreview=function(e){for(var t=0;t<this.previewVideoList.length;t++)if(this.previewVideoList[t]===e){this.previewVideoList.splice(t,1);break}},t.prototype.onDeviceError=function(e){},t.prototype.OnAudioDeviceStateChanged=function(e){},t.prototype.OnVideoDeviceStateChanged=function(e){},t.prototype.onPlayerStreamUrlUpdate=function(e,t,r){},t.prototype.onVideoSizeChanged=function(e,t,r){},t.prototype.onRemoteCameraStatusUpdate=function(e,t){},t.prototype.onRemoteMicStatusUpdate=function(e,t){},t.prototype.onSoundLevelUpdate=function(e){},t.prototype.setPublishStreamConstraints=function(e,t,r,i){var o=this;e=this.getTotalStreamId(e);var n=this.publisherList[e],s=/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent);if(n){var a=this.checkPreview(n.localVideo);if(a)if(t&&0!=Object.keys(t).length){var c=!1,d=!1;t.minBitRate&&t.maxBitRate&&(t.bitRate={minBitRate:t.minBitRate,maxBitRate:t.maxBitRate}),t.width&&t.width!=a.mediaStreamConfig.width||t.height&&t.height!=a.mediaStreamConfig.height||t.frameRate&&t.frameRate!=a.mediaStreamConfig.frameRate?c=!0:t.minBitRate==a.mediaStreamConfig.bitRate.minBitRate&&t.maxBitRate==a.mediaStreamConfig.bitRate.maxBitRate||t.minBitRate&&t.maxBitRate&&(d=!0),a.mediaStreamConfig.videoInput!==t.videoInput&&delete a.mediaStreamConfig.facingMode&&delete t.facingMode;var l=Object.assign(a.mediaStreamConfig,t);if(l.externalCapture||l.externalMediaStream)this.logger.error("zc.spsc.0 do not support external stream");else{var h=a.getMediaStreamConstraints(l),u=n.publisher.localStream;if(!n.publisher.peerConnection.getSenders||!n.publisher.peerConnection.getSenders()[0].replaceTrack)return this.logger.error("zc.spsc.0 set publish constraints is not supported"),void(i&&i({code:1,msg:"not supported"}));if(c&&(!s&&u.getTracks().forEach((function(e){return e.stop()})),navigator.mediaDevices.getUserMedia(h).then((function(e){e.getTracks().forEach((function(e){var t=u.getTracks().find((function(t){return t.kind===e.kind})),r=n.publisher.peerConnection.getSenders().find((function(t){return t.track.kind===e.kind}));l.minBitRate&&l.maxBitRate&&"video"===r.track.kind&&o.setVideoBitRate(r,l.minBitRate,l.maxBitRate),r.replaceTrack(e),u.removeTrack(t),u.addTrack(e),o.logger.info("zc.spsc.0 set constraints success")})),r&&r()})).catch((function(e){o.logger.error("zc.spsc.0 fail reason ",e.name),i&&i({code:2,msg:e.name})}))),d)try{var p=n.publisher.peerConnection.getSenders().find((function(e){return"video"===e.track.kind}));this.setVideoBitRate(p,t.minBitRate,t.maxBitRate),r&&r()}catch(e){this.logger.error("zc.spsc.0 fail reason ",e.name),i&&i({code:2,msg:e.name})}}}else this.logger.error("zc.spsc.0 constraints wrong");else this.logger.error("zc.spsc.0 preview no found")}else this.logger.error("zc.spsc.0 publisher not found")},t.prototype.setVideoBitRate=function(e,t,r){var i=this,o=e.getParameters();return o.encodings||(o.encodings=[{}]),o.encodings[0].minBitrate=1e3*t,o.encodings[0].maxBitrate=1e3*r,e.setParameters(o).then((function(){i.logger.info("zc.spsc.0 set video bitrate success")})).catch((function(e){i.logger.error("zc.spsc.0 set video bitrate fail "+e)})),!0},t.prototype.startMixingAudio=function(e,t){var r=this.getPublisher(e);return r?r.startMixingAudio(t):(this.logger.error("zc.sma.0 publisher doesn't exist"),!1)},t.prototype.stopMixingAudio=function(e,t){var r=this.getPublisher(e);return r?r.stopMixingAudio(t):(this.logger.error("zc.sma.1 publisher doesn't exist"),!1)},t}(u.ZegoStreamCenter);t.ZegoStreamCenterWeb=g},function(e,t,r){"use strict";var i=this&&this.__assign||Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e};Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e){this.log=e,this.dataStatistics={},this.logger=e}return e.prototype.newReport=function(e){this.dataStatistics[e]={abs_time:Date.now(),time_consumed:0,error:0,events:[]}},e.prototype.addMsgExt=function(e,t){this.dataStatistics[e]?this.dataStatistics[e].msg_ext=t:console.warn(e+" not exist")},e.prototype.eventStart=function(e,t){this.dataStatistics[e]?null!=this.dataStatistics[e].events?this.dataStatistics[e].events.push({event:t,abs_time:Date.now(),time_consumed:0}):this.logger.warn("zd.es.0 no events"):this.logger.warn("zd.es.0 no seq match")},e.prototype.eventEnd=function(e,t,r){if(this.dataStatistics[e]){var i=this.dataStatistics[e].events;if(i&&0!==i.length){for(var o=i.length-1;o>=0;o--)if(i[o].event==t&&i[o].time_consumed){i[o].time_consumed=Date.now()-i[o].abs_time;break}}else this.logger.info("zd.ee.0 no events")}else this.logger.info("zd.ee.0 no seq match")},e.prototype.eventEndWithMsg=function(e,t,r){if(this.dataStatistics[e]){var o=this.dataStatistics[e].events;if(o){for(var n=o.length-1;n>=0;n--)if(o[n].event==t&&o[n].time_consumed){o[n].time_consumed=Date.now()-o[n].abs_time,null==o[n].msg_ext&&(o[n].msg_ext={}),o[n].msg_ext=i({},r);break}}else this.logger.warn("zd.ee.0 no events")}else this.logger.warn("zd.ee.0 no seq match")},e.prototype.addEventInfo=function(e,t,r,i){if(this.dataStatistics[e]){var o=this.dataStatistics[e].events;if(null!=o){for(var n=o.length-1;n>=0;n--)if(o[n].event==t&&null!=o[n].time_consumed&&o[n].event==t&&null!=o[n].time_consumed){null==o[n].msg_ext&&(o[n].msg_ext={}),o[n].msg_ext[r]=i;break}}else this.logger.warn("zd.aei.0 no events")}else this.logger.warn("zd.aei.0 no seq match")},e.prototype.addEvent=function(e,t,r){this.dataStatistics[e]?this.dataStatistics[e].events&&(r?this.dataStatistics[e].events.push({event:t,abs_time:Date.now(),msg_ext:r}):this.dataStatistics[e].events.push({event:t,abs_time:Date.now()})):this.logger.warn("zd.ae.0 no seq match")},e.prototype.uploadReport=function(e,t){var r=this.dataStatistics[e];null!=r&&(r.itemtype=t,r.time_consumed=Date.now()-r.abs_time,this.logger.report(r),delete this.dataStatistics[e])},e}();t.ZegoDataReport=o},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=r(0),o=r(2),n=function(){function e(e){var t=this;this.log=e,this.localVideo=null,this.localStream=null,this.previewSuc=!1,this.enableMicrophone=function(e,r){if(!t.localStream)return t.logger.error("zp.em.2 no localStream"),!1;for(var i in t.localStream.getAudioTracks().forEach((function(t){t.enabled=e})),r.publisherList){var n=r.publisherList[i].publisher;n.localStream==t.localStream&&n.signal.sendStreamStatus(o.getSeq(),n.sessionId,t.localStream&&t.localStream.getVideoTracks()[0]&&!0===t.localStream.getVideoTracks()[0].enabled?0:2,e?0:2)}return t.logger.debug("zp.em.2 call success"),!0},this.enableCamera=function(e,r){if(!t.localStream)return t.logger.error("zp.ec.2 no localStream"),!1;for(var i in t.localStream.getVideoTracks().forEach((function(t){t.enabled=e})),r.publisherList){var n=r.publisherList[i].publisher;n.localStream==t.localStream&&n.signal.sendStreamStatus(o.getSeq(),n.sessionId,e?0:2,t.localStream&&t.localStream.getAudioTracks()[0]&&1==t.localStream.getAudioTracks()[0].enabled?0:2)}return t.logger.debug("zp.ec.2 call success"),!0},this.setAudioDestination=function(e){return t.localVideo?"undefined"!==t.localVideo.sinkId?(t.localVideo.setSinkId(e).then((function(){t.logger.info("zp.sad.2 success device: "+e)})).catch((function(e){t.logger.info("zp.sad.2 "+e.name)})),!0):(t.logger.error("zp.sad.2 browser does not suppport"),!1):(t.logger.error("zp.sad.2 no localVideo"),!1)},this.logger=e}return e.prototype.getMediaStreamConstraints=function(e){var t={audio:null,video:null};if(t.audio=!1,t.video=!1,console.log("mediaStreamConfig",e),e.audio&&(void 0===e.audioInput&&void 0===e.noiseSuppression&&void 0===e.autoGainControl&&void 0===e.echoCancellation?(t.audio={},t.audio.noiseSuppression=!0,t.audio.autoGainControl=!0,t.audio.echoCancellation=!0):(t.audio={},void 0!==e.audioInput&&null!==e.audioInput&&(t.audio.deviceId=e.audioInput),void 0!==e.noiseSuppression&&(t.audio.noiseSuppression=e.noiseSuppression),void 0!==e.autoGainControl&&(t.audio.autoGainControl=e.autoGainControl),void 0!==e.echoCancellation&&(t.audio.echoCancellation=e.echoCancellation))),e.video){var r=640,o=480,n=15,s=800;if(1===e.videoQuality?(r=i.ENUM_RESOLUTION_TYPE.LOW.width,o=i.ENUM_RESOLUTION_TYPE.LOW.height,n=i.ENUM_RESOLUTION_TYPE.LOW.frameRate,s=i.ENUM_RESOLUTION_TYPE.LOW.bitRate):2===e.videoQuality?(r=i.ENUM_RESOLUTION_TYPE.MEDIUM.width,o=i.ENUM_RESOLUTION_TYPE.MEDIUM.height,n=i.ENUM_RESOLUTION_TYPE.MEDIUM.frameRate,s=i.ENUM_RESOLUTION_TYPE.MEDIUM.bitRate):3===e.videoQuality?(r=i.ENUM_RESOLUTION_TYPE.HIGH.width,o=i.ENUM_RESOLUTION_TYPE.HIGH.height,n=i.ENUM_RESOLUTION_TYPE.HIGH.frameRate,s=i.ENUM_RESOLUTION_TYPE.HIGH.bitRate):4===e.videoQuality?(r=e.width,o=e.height,n=e.frameRate,s=e.maxBitRate||800):this.logger.info("zp.gmsc.2 user default"),!0===e.horizontal){var a=o;o=r,r=a}t.video={width:r,height:o,frameRate:n,bitRate:s},null!=e.facingMode?t.video.facingMode=e.facingMode:null!=e.videoInput&&null!=e.videoInput&&(t.video.deviceId={exact:e.videoInput}),this.logger.info("zp.gmsc.2 width: "+r+" height: "+o+" rate: "+n)}return t},e.prototype.startPreview=function(e,t,r,i){var o=this;if(this.logger.debug("zp.sv.2 called"),this.localVideo=e,this.mediaStreamConfig=t,void 0!==navigator.mediaDevices&&null!=navigator.mediaDevices.getUserMedia){if(t.externalMediaStream instanceof MediaStream)return this.logger.debug("zp.sv.2 use external media stream"),this.previewSuc=!0,this.localStream=t.externalMediaStream,this.videoInfo={width:t.width,height:t.height,frameRate:t.frameRate,minBitRate:t.minBitRate,maxBitRate:t.maxBitRate},void(r&&r());if(t.externalCapture)this.captureStream(e,t)?(this.previewSuc=!0,r&&r()):i&&i("external capture fail");else{var n=this.getMediaStreamConstraints(t);this.videoInfo=n.video,this.videoInfo&&(this.videoInfo.minBitRate=t.minBitRate||n.video.bitRate),this.videoInfo&&(this.videoInfo.maxBitRate=t.maxBitRate||n.video.bitRate),this.logger.info("zp.sv.2 ",JSON.stringify(n)),navigator.mediaDevices.getUserMedia(n).then((function(e){if(o.logger.info("zp.sv.2 success"),!o.localVideo)return o.logger.info("zp.sv.2 no localVideo"),void(i&&i("no localVideo"));o.localVideo.srcObject=e,o.localStream=e,o.previewSuc=!0,r&&r()}),(function(e){o.logger.info("zp.sv.2 failed "+e.message),i&&i(e)}))}}else i&&i("browser don't support")},e.prototype.captureStream=function(e,t){if(!e)return this.logger.info("zp.cs.2 no local video"),!1;var r,i;if(e.captureStream)r=e.captureStream(),this.logger.debug("zp.cs.2 captureStream");else{if(!e.mozCaptureStream)return this.logger.info("zp.cs.2 don't support capture stream"),!1;r=e.mozCaptureStream(),this.logger.debug("zp.cs.2 mozCaptureStream")}return 0==r.getTracks().length?(this.logger.error("zp.cs.2 external capture tracks no found"),!1):(this.localStream=r,this.videoInfo={width:e.videoWidth,height:e.videoHeight,frameRate:t.frameRate||15,minBitRate:800,maxBitRate:800},"number"==typeof t.bitRate?(i<48&&(i=48),i>1e4&&(i=1e4),this.videoInfo.minBitRate=this.videoInfo.maxBitRate=t.bitRate):t.bitRate&&t.bitRate.minBitRate&&t.bitRate.maxBitRate&&"number"==typeof t.bitRate.minBitRate&&"number"==typeof t.bitRate.maxBitRate&&t.bitRate.minBitRate<=t.bitRate.maxBitRate&&(this.videoInfo.minBitRate=t.bitRate.minBitRate<48?48:t.bitRate.minBitRate,this.videoInfo.maxBitRate=t.bitRate.maxBitRate>1e4?1e4:t.bitRate.maxBitRate),this.logger.debug("zp.cs.2 called success"),!0)},e.prototype.stopPreview=function(){if(this.logger.info("zp.sv.2.1 called"),this.localStream){var e=this.localStream.getTracks();e.reverse(),e.forEach((function(e){e.stop()})),this.localStream=null,this.localVideo.srcObject=null,this.localVideo=null,this.videoInfo=null}},e}();t.ZegoPreview=n},function(e,t,r){"use strict";var i=this&&this.__assign||Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e};Object.defineProperty(t,"__esModule",{value:!0});var o=r(0),n=r(2),s=r(12),a=r(3),c=r(4),d=r(13),l=function(){function e(e,t,r,i,s){this.state=o.ENUM_PUBLISH_STATE.stop,this.sessionId=0,this.waitingICETimeInterval=5e3,this.waitingAnswerTimeInterval=5e3,this.candidateInfo=[],this.waitingICETimer=null,this.waitingAnswerTimer=null,this.qualityTimer=null,this.publishQualityList=[],this.maxQualityListCount=10,this.lastPublishStats={},this.reportSeq=n.getSeq(),this.qualityUpload=!1,this.qualityUploadInterval=3e4,this.qualityUploadLastTime=0,this.qualitySeq=0,this.maxRetryCount=3,this.currentRetryCount=0,this.retryState=o.ENUM_RETRY_STATE.didNotStart,this.waitingServerTimerInterval=3e3,this.waitingServerTimer=null,this.videoInfo={width:0,height:0,frameRate:0,minBitRate:0,maxBitRate:0},this.streamGoogInfo={},this.mediaStreamConfig=null,this.offerSeq=0,this.audioMixList=[],this.arrayBufferMap={},this.qualityCount=0,this.closeSessionSignal=!1,this.audioBitRate=48e3,this.localSdpRevert=!1,this.videoDecodeType="H264",this.stateNego=o.ENUM_PUBLISH_STATE_NEGO.stop,this.negoInterval=25e3,this.negoTryCount=1,this.negoTryMaxCount=2,this.publishEvent=!1,this.nextSignalTryCount=1,this.waittingConnectedTimer=null,this.waittingConnectedInerval=15e3,this.tryingNexitSignal=!1,this.soundLevel=0,this.script=null,this.mic=null,this.logger=e,this.signal=t,this.dataReport=r,this.streamCenter=s,this.ac=this.streamCenter.ac,this.qualityTimeInterval=i,this.audioMixing=new a.audioMixUtil(e,this.ac),r.newReport(this.reportSeq)}return e.prototype.publishStateUpdateError=function(e,t){this.logger.error("zp.psu.0 call "+JSON.stringify(e)),t||!(this.state===o.ENUM_PUBLISH_STATE.stop||this.negoTryCount<this.negoTryMaxCount&&this.stateNego<o.ENUM_PUBLISH_STATE_NEGO.iceConnected)?(0!=this.sessionId&&this.shouldSendCloseSession(e)&&(this.signal.sendCloseSession(n.getSeq(),this.sessionId,1),this.closeSessionSignal=!0),this.state=o.ENUM_PUBLISH_STATE.stop,this.onPublishStateUpdate(n.ENUM_PUBLISH_STATE_UPDATE.error,this.streamId,e),this.logger.info("zp.psu.0 ended"),this.resetPublish()):this.logger.info("zp.psu.0 already reset")},e.prototype.resetPublish=function(){this.logger.info("zp.rp.0 call"),this.streamId=null,this.state=o.ENUM_PUBLISH_STATE.stop,this.publishEvent=!1,null==this.peerConnection&&null==this.peerConnection||(this.peerConnection.close(),this.peerConnection=null),null!=this.waitingAnswerTimer&&(clearTimeout(this.waitingAnswerTimer),this.waitingAnswerTimer=null),null!=this.waitingICETimer&&(clearTimeout(this.waitingICETimer),this.waitingICETimer=null),null!=this.negoTimer&&(clearTimeout(this.negoTimer),this.negoTimer=null),null!=this.waittingConnectedTimer&&(clearTimeout(this.waittingConnectedTimer),this.waittingConnectedTimer=null),this.clearPublishQualityTimer(),this.signal&&(this.signal.unregisterPushCallback("CandidateInfoPush",this.sessionId),this.signal.unregisterPushCallback("MediaDescPush",this.sessionId),this.signal.unregisterPushCallback("CloseSessionPush",this.sessionId)),this.sessionSeq=0,this.offerSeq=0,this.candidateInfo=[],this.publishQualityList=[],this.qualityUploadLastTime=0,this.currentRetryCount=0,this.retryState=o.ENUM_RETRY_STATE.didNotStart,this.clearTryPublishTimer()},e.prototype.clearTryPublishTimer=function(){null!=this.waitingServerTimer&&(clearTimeout(this.waitingServerTimer),this.waitingServerTimer=null)},e.prototype.clearPublishQualityTimer=function(){null!=this.qualityTimer&&(clearInterval(this.qualityTimer),this.qualityTimer=null),this.lastPublishStats={},this.qualityCount=0},e.prototype.shouldSendCloseSession=function(e){return this.state!=o.ENUM_PUBLISH_STATE.stop&&this.state!=o.ENUM_PUBLISH_STATE.waitingSessionRsp},e.prototype.startPublish=function(e,t,r,i,s){var a=this;this.logger.info("zp.sp.0 called"),this.signal&&this.signal.negoInterval&&(this.negoInterval=this.signal.negoInterval),this.signal&&this.signal.negoTryCount&&(this.negoTryCount=this.signal.negoTryCount),this.signal&&this.signal.negoTryMaxCount&&(this.negoTryMaxCount=this.signal.negoTryMaxCount),e?(this.streamId=e,this.localStream=t,this.mediaStreamConfig=i,this.playOption=s||{},navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&(i.externalCapture||i.externalMediaStream)&&(this.localStream.onaddtrack=function(){a.logger.info("zp.sp.0 Track added");var e=a.localStream.getVideoTracks(),t=a.localStream.getAudioTracks();e.length>1?(a.peerConnection.getSenders().find((function(t){return t.track.kind===e[1].kind})).replaceTrack(e[1]),a.localStream.removeTrack(e[0])):t.length>1&&(a.peerConnection.getSenders().find((function(e){return e.track.kind===t[1].kind})).replaceTrack(t[1]),a.localStream.removeTrack(t[0]))}),r&&(this.videoInfo=r),s&&s.audioBitRate&&(this.audioBitRate=s.audioBitRate),s&&s.videoDecodeType&&(this.videoDecodeType=s.videoDecodeType),this.sessionSeq=n.getSeq(),this.dataReport.eventStart(this.reportSeq,"CreateSession"),this.signal.createSession(this.sessionSeq,0,0,e,s&&s.streamParams,(function(e,t,r){a.dataReport.eventEndWithMsg(a.reportSeq,"CreateSession",{sessionId:r.session_id}),a.logger.info("zp.sp.0 sessionId:"+r.session_id),a.sessionSeq==e?0!==r.result?(a.logger.error("zp.sp.0 create session failed "+r.result),a.publishStateUpdateError(n.publishErrorList.CREATE_SESSION_ERROR)):(a.sessionId=r.session_id,a.logger.debug("zp.sp.0 create session success "+a.sessionId),a.onCreatePublishSessionSuccess(r)):a.logger.error("zp.sp.0 seq is not match.")}),(function(e,t){a.dataReport.eventEndWithMsg(a.reportSeq,"CreateSession",{error:e}),a.publishStateUpdateError(n.publishErrorList.SEND_SESSION_TIMEOUT)})),this.state=o.ENUM_PUBLISH_STATE.waitingSessionRsp,this.logger.info("zp.sp.0 called success"),this.stateNego=o.ENUM_PUBLISH_STATE_NEGO.start,this.negoTimer=setTimeout((function(){a.stateNego!==o.ENUM_PUBLISH_STATE_NEGO.iceConnected&&a.negoTryCount<a.negoTryMaxCount?(a.signal.sendCloseSession(n.getSeq(),a.sessionId,1),a.resetPublish(),a.startPublish(e,t,r,i,s),++a.negoTryCount):a.stateNego!==o.ENUM_PUBLISH_STATE_NEGO.iceConnected&&a.negoTryCount===a.negoTryMaxCount&&(a.logger.error("zp.sp.0 waiting timeout"),a.publishStateUpdateError(n.publishErrorList.SERVER_NEGO_TIMEOUT))}),this.negoInterval)):this.logger.error("zp.sp.0 streamId is null")},e.prototype.onCreatePublishSessionSuccess=function(e){var t=this;this.logger.info("zp.ops.0 called");var r=[];e.turn_server&&r.push(e.turn_server),e.stun_server&&r.push(e.stun_server);var i={iceTransportPolicy:"relay",iceServers:[{urls:r,username:e.turn_username,credential:e.turn_auth_key}]};this.logger.info("zp.ops.0 username: "+e.turn_username),this.logger.info("zp.ops.0 credential: "+e.turn_auth_key),this.peerConnection=new RTCPeerConnection(i),this.peerConnection.onicecandidate=function(e){t.onIceCandidate(e)},this.peerConnection.onsignalingstatechange=function(e){t.onConnectionStateChange(e)},this.peerConnection.oniceconnectionstatechange=function(e){t.onIceConnectionStateChange(e)};var o=[],s=[];this.localStream&&(this.localStream.getTracks().forEach((function(e){t.peerConnection.addTrack(e,t.localStream)})),o=this.localStream.getVideoTracks(),s=this.localStream.getAudioTracks(),console.warn("getConstraints",s&&s[0]&&s[0].getConstraints&&s[0].getConstraints()),o.length>0&&this.logger.info("zp.ops.0 video device: "+o[0].label),s.length>0&&this.logger.info("zp.ops.0 audio device: "+s[0].label));var a={offerToReceiveAudio:s.length>0?1:0,offerToReceiveVideo:o.length>0?1:0};this.logger.info("zp.ops.0 createOffer: "+JSON.stringify(a)),this.dataReport.eventStart(this.reportSeq,"CreateOffer"),this.peerConnection.createOffer(a).then((function(e){t.dataReport.eventEnd(t.reportSeq,"CreateOffer"),t.onCreateOfferSuccess(e)}),(function(e){t.dataReport.eventEndWithMsg(t.reportSeq,"CreateOffer",{error:e.toString()}),t.logger.error("zp.ops.0 create offer error "+e.toString()),t.publishStateUpdateError(n.publishErrorList.CREATE_OFFER_ERROR,!0)})),this.signal.registerPushCallback("CandidateInfoPush",this.sessionId,(function(e,r,i){t.onRecvCandidateInfo(e,r,i)})),this.signal.registerPushCallback("CloseSessionPush",this.sessionId,(function(e,r,i){t.onRecvCloseSession(e,r,i)})),this.signal.registerPushCallback("MediaDescPush",this.sessionId,(function(e,r,i){t.onRecvMediaDescription(e,r,i)})),this.signal.registerPushCallback("SessionResetPush",this.sessionId,(function(e,r,i){t.onRecvResetSession(e,r,i)})),this.signal.registerPushCallback("PublishEventPush",this.sessionId,(function(e,r,i){t.onRecvPublishEvent(e,r,i)})),this.logger.debug("zp.ops.0 call success")},e.prototype.onCreateOfferSuccess=function(e){var t=this;0!=this.videoInfo.maxBitRate&&(e.sdp=this.updateBandwidthRestriction(e.sdp,this.videoInfo.maxBitRate)),e.sdp=e.sdp.replace(/sendrecv/g,"sendonly"),e.sdp=e.sdp.replace(/useinbandfec=\d+/,"maxaveragebitrate="+this.audioBitRate),/m=video[\s\S]*m=audio/.test(e.sdp)&&(this.localSdpRevert=!0),e.sdp=c.sdpUtil.getSDPByVideDecodeType(e.sdp,this.videoDecodeType),this.logger.info("zp.oco.0 localSdp1 "+e.sdp.substr(0,e.sdp.length/2)),this.logger.info("zp.oco.0 localSdp2 "+e.sdp.substr(e.sdp.length/2)),this.dataReport.eventStart(this.reportSeq,"SetLocalDescription"),this.peerConnection.setLocalDescription(e).then((function(){t.dataReport.eventEnd(t.reportSeq,"SetLocalDescription"),t.onSetLocalDescriptionSuccess(e)}),(function(e){t.dataReport.eventEndWithMsg(t.reportSeq,"SetLocalDescription",{error:e.toString()}),t.logger.error("zp.oco.0 error "+e.toString()),t.publishStateUpdateError(n.publishErrorList.SET_LOCAL_DESC_ERROR,!0)}))},e.prototype.updateBandwidthRestriction=function(e,t){var r="AS";return"firefox"===s.browserDetails.browser&&(t=1e3*(t>>>0),r="TIAS"),-1===e.indexOf("b="+r+":")?(e=e.replace(/c=IN (.*)\r\n/g,"c=IN $1\r\nb="+r+":"+t+"\r\n")).replace("b="+r+":"+t+"\r\n",""):(e=e.replace(new RegExp("b="+r+":.*\r\n","g"),"b="+r+":"+t+"\r\n")).replace("b="+r+":"+t+"\r\n","")},e.prototype.onSetLocalDescriptionSuccess=function(e){var t=this;this.logger.info("zp.osd.0 success");var r={sdp:e.sdp,width:this.videoInfo.width,height:this.videoInfo.height,frameRate:this.videoInfo.frameRate,video_min_kpbs:this.videoInfo.minBitRate,video_max_kpbs:this.videoInfo.maxBitRate,audio_kpbs:48,keyframe_intv:2};this.offerSeq=n.getSeq(),this.dataReport.eventStart(this.reportSeq,"SendMediaDesc"),this.signal.sendMediaDesc(this.offerSeq,this.sessionId,0,r,(function(e,r,i){t.offerSeq==e&&t.sessionId==r?(t.logger.info("zp.osd.0 send success"),t.dataReport.eventEnd(t.reportSeq,"SendMediaDesc"),t.waitingAnswerTimer=setTimeout((function(){t.state==o.ENUM_PUBLISH_STATE.waitingServerAnswer&&(t.logger.error("zp.osd.0 waiting timeout"),t.publishStateUpdateError(n.publishErrorList.SERVER_MEDIA_DESC_TIMEOUT))}),t.waitingAnswerTimeInterval),t.logger.info("zp.osd.0 send success stateNego:waiterAnswer"),t.stateNego=o.ENUM_PUBLISH_STATE_NEGO.waiterAnswer,t.state=o.ENUM_PUBLISH_STATE.waitingServerAnswer):t.logger.error("zp.osd.0 seq or sessionId is not equal")}),(function(e,r){t.dataReport.eventEndWithMsg(t.reportSeq,"SendMediaDesc",{error:e}),t.publishStateUpdateError(n.publishErrorList.SEND_MEDIA_DESC_TIMEOUT)})),this.state=o.ENUM_PUBLISH_STATE.waitingOffserRsp,this.logger.debug("zp.osd.0 call success")},e.prototype.onRecvMediaDescription=function(e,t,r){this.logger.info("zp.ormd.0 received"),this.state==o.ENUM_PUBLISH_STATE.waitingServerAnswer?(this.stateNego=o.ENUM_PUBLISH_STATE_NEGO.waitingCandidate,this.logger.info("zp.orm.0 received stateNego:waitingCandidate"),null!=this.waitingAnswerTimer&&(clearTimeout(this.waitingAnswerTimer),this.waitingAnswerTimer=null),this.dataReport.addEvent(this.reportSeq,"RecvMediaDesc"),this.signal.sendMediaDescAck(e,this.sessionId,0),1==r.type?this.onGetRemoteOfferSucceses(r.sdp):this.publishStateUpdateError(n.publishErrorList.SERVER_MEDIA_DESC_ERROR)):this.logger.info("zp.ormd.0 current state "+this.state+" not allowed")},e.prototype.onGetRemoteOfferSucceses=function(e){var t=this;if(48e3!==this.audioBitRate&&(e=e.replace(/maxaveragebitrate=(\d+)/,"maxaveragebitrate="+this.audioBitRate)),this.localSdpRevert){var r=[/[\s\S]*m=audio/.exec(e)[0].replace("m=audio",""),/m=video[\s\S]*/.exec(e)[0],/m=audio[\s\S]*m=video/.exec(e)[0].replace("m=video","")],i=r[0],s=r[1],a=r[2],c=/a=group:BUNDLE\s+(\w+)\s+(\w+)/.exec(i);e=(i=i.replace(/a=group:BUNDLE\s+(\w+)\s+(\w+)/,"a=group:BUNDLE "+c[2]+" "+c[1]))+s+a}this.logger.info("zp.oro.0 remoteSdp:",e);var d={type:"answer",sdp:e,toJSON:function(){}};this.dataReport.eventStart(this.reportSeq,"SetRemoteDescription"),this.peerConnection.setRemoteDescription(new RTCSessionDescription(d)).then((function(){t.logger.info("zp.oro.0 set success"),t.dataReport.eventEnd(t.reportSeq,"SetRemoteDescription")}),(function(e){t.logger.error("zp.oro.0 failed: "+e.toString()),t.dataReport.eventEndWithMsg(t.reportSeq,"SetRemoteDescription",{error:e.toString()}),t.publishStateUpdateError(n.publishErrorList.SET_REMOTE_DESC_ERROR)})),this.state=o.ENUM_PUBLISH_STATE.waitingServerICE,this.waitingICETimer=setTimeout((function(){t.state==o.ENUM_PUBLISH_STATE.waitingServerICE&&(t.logger.error("zp.orod.0 waiting server timeout"),t.publishStateUpdateError(n.publishErrorList.SERVER_CANDIDATE_TIMEOUT))}),this.waitingICETimeInterval),this.logger.debug("zp.oro.0 call success")},e.prototype.onIceConnectionStateChange=function(e){var t=this;this.state!=o.ENUM_PUBLISH_STATE.stop&&null!=this.peerConnection&&(this.logger.info("zp.oics.0 stateChanged "+this.peerConnection.iceConnectionState),"connected"===this.peerConnection.iceConnectionState?(this.logger.info("zp.oics.0 connected state "+this.state),this.dataReport.eventEnd(this.reportSeq,"IceConnected"),this.stateNego=o.ENUM_PUBLISH_STATE_NEGO.iceConnected,this.waittingConnectedTimer&&clearTimeout(this.waittingConnectedTimer),this.waittingConnectedTimer=null,this.logger.info("zp.oisc.0  stateNego:iceConnected"),this.negoTryCount=1,this.nextSignalTryCount=1,this.negoTimer&&(clearTimeout(this.negoTimer),this.negoTimer=null),this.publishEvent&&this.publishSuccess()):"closed"===this.peerConnection.iceConnectionState?(this.dataReport.addEvent(this.reportSeq,"IceClosed"),this.checkPublishConnectionFailedState(this.peerConnection.iceConnectionState)):"failed"===this.peerConnection.iceConnectionState?(this.dataReport.addEvent(this.reportSeq,"IceFailed"),this.checkPublishConnectionFailedState(this.peerConnection.iceConnectionState)):"disconnected"===this.peerConnection.iceConnectionState&&(this.dataReport.addEvent(this.reportSeq,"IceDisconnected"),this.waittingConnectedTimer=setTimeout((function(){!t.tryingNexitSignal&&t.tryNextSignal(n.publishErrorList.MEDIA_CONNECTION_DISCONNECTED)}),this.waittingConnectedInerval)))},e.prototype.onIceCandidate=function(e){if(this.logger.info("zp.oic.0 candidate"+e.candidate),e.candidate)if(this.logger.info("zp.oic.0 candidate"+e.candidate.candidate),this.state<o.ENUM_PUBLISH_STATE.connecting||this.state==o.ENUM_PUBLISH_STATE.stop)this.candidateInfo.push({candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex});else{var t={candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex};this.sendCandidateInfo([t])}},e.prototype.sendCandidateInfo=function(e){var t=this;this.logger.info("zp.sci.0 called"),!(e=e.filter((function(e){return e.candidate.indexOf("relay")>0})))||e.length<1?this.logger.info("zp.sci.0 cancelled"):(this.dataReport.eventStart(this.reportSeq,"SendIceCandidate"),this.stateNego!==o.ENUM_PUBLISH_STATE_NEGO.iceConnected&&(this.stateNego=o.ENUM_PUBLISH_STATE_NEGO.sendCandidate),this.logger.info("zp.sci.0  stateNego:sendCandidate"),this.signal.sendCandidateInfo(n.getSeq(),this.sessionId,e,(function(e,r,i){t.logger.info("zp.sci.0 send success"),t.dataReport.eventEnd(t.reportSeq,"SendIceCandidate")}),(function(e,r){t.logger.error("zp.sci.0 failed to send: "+e.toString()),t.dataReport.eventEndWithMsg(t.reportSeq,"SendIceCandidate",{error:e}),t.publishStateUpdateError(n.publishErrorList.SEND_CANDIDATE_TIMEOUT)})))},e.prototype.onConnectionStateChange=function(e){this.logger.info("zp.ocs.0 called "+e.target.signalingState)},e.prototype.onRecvCandidateInfo=function(e,t,r){var i=this;if(this.logger.info("zp.oci.0 received "+JSON.stringify(r.infos)),this.state==o.ENUM_PUBLISH_STATE.waitingServerICE){null!=this.waitingICETimer&&(clearTimeout(this.waitingICETimer),this.waitingICETimer=null),this.dataReport.addEvent(this.reportSeq,"RecvIceCandidate"),this.signal.sendCandidateInfoAck(e,this.sessionId,0),this.sendCandidateInfo(this.candidateInfo),this.candidateInfo=[];for(var s=0;s<r.infos.length;s++){var a={sdpMid:r.infos[s].sdpMid,sdpMLineIndex:r.infos[s].sdpMLineIndex,candidate:r.infos[s].candidate};this.logger.debug("zp.orci.0 candidate "+a.candidate),this.peerConnection.addIceCandidate(new RTCIceCandidate(a)).then((function(){i.logger.debug("zp.oci.0 add success")}),(function(e){i.logger.error("zp.oci.0 add error "+e.toString()),i.publishStateUpdateError(n.publishErrorList.SERVER_CANDIDATE_ERROR)}))}this.state=o.ENUM_PUBLISH_STATE.connecting,this.dataReport.eventStart(this.reportSeq,"IceConnected")}else this.logger.info("zp.oci.0 current state "+this.state+" not allowed")},e.prototype.onRecvCloseSession=function(e,t,r){this.logger.info("zp.orcs.0 reason: "+r.reason),this.dataReport.addEvent(this.reportSeq,"RecvCloseSession"),this.signal.sendCloseSessionAck(e,this.sessionId,0);var i=JSON.parse(JSON.stringify(n.publishErrorList.SESSION_CLOSED));i.msg+=r.reason,this.negoTimer&&clearTimeout(this.negoTimer);var o=1*r.reason,s=r.err_info&&JSON.parse(r.err_info).action?JSON.parse(r.err_info).action:null;if("number"==typeof o&&[26].includes(o)&&this.negoTryCount<this.negoTryMaxCount||5==s){this.logger.info("zp.orcs.0 retry: "+this.streamId);var a=this.streamId,c=this.localStream,d=this.videoInfo,l=this.mediaStreamConfig,h=this.playOption;this.signal.sendCloseSession(n.getSeq(),this.sessionId,1),this.resetPublish(),this.startPublish(a,c,d,l,h),++this.negoTryCount}else[4,8,10,11,12,14,27].includes(o)||2==s?(this.logger.info("zp.orcs.0 try next signal "+this.tryingNexitSignal),!this.tryingNexitSignal&&this.tryNextSignal(i)):this.publishStateUpdateError(i,!0)},e.prototype.onRecvResetSession=function(e,t,r){if(this.logger.info("zp.orrs.0 received "),t==this.sessionId){this.dataReport.addEvent(this.reportSeq,"RecvResetSession"),this.signal.sendCloseSessionAck(e,this.sessionId,0);var i=JSON.parse(JSON.stringify(n.publishErrorList.SESSION_CLOSED));this.negoTimer&&clearTimeout(this.negoTimer),!this.tryingNexitSignal&&this.tryNextSignal(i)}else this.logger.error("zp.orrs.0 cannot find session")},e.prototype.onRecvPublishEvent=function(e,t,r){this.logger.info("zp.orpe.0 received"),this.publishEvent=!0,this.stateNego===o.ENUM_PUBLISH_STATE_NEGO.iceConnected&&0==r.event&&this.publishSuccess()},e.prototype.shouldRetryPublish=function(){return this.retryState==o.ENUM_RETRY_STATE.didNotStart&&this.state!=o.ENUM_PUBLISH_STATE.publishing?(this.logger.info("zp.srp.0.0 connection didn't success"),!1):this.retryState==o.ENUM_RETRY_STATE.retrying?(this.logger.info("zp.srp.0.0 already retrying"),!1):this.currentRetryCount>this.maxRetryCount?(this.logger.info("zp.srp.0.0 beyond max"),!1):(this.logger.info("zp.srp.1.0 call success"),!0)},e.prototype.startRetryPublish=function(){this.logger.info("zp.srp.0 call");var e=this.streamId;e?(this.resetPublish(),this.tryStartPublish(e)):this.logger.info("zp.srp.0 no streamid")},e.prototype.tryStartPublish=function(e){var t=this;if(this.logger.info("zp.tsp.0 call"),this.clearTryPublishTimer(),this.streamId=e,this.currentRetryCount>this.maxRetryCount)return this.logger.info("zp.tsp.0 beyond max limit"),void this.publishStateUpdateError(n.publishErrorList.WEBSOCKET_ERROR);this.retryState=o.ENUM_RETRY_STATE.retrying,this.currentRetryCount+=1,this.signal.isServerConnected()?(this.logger.info("zp.tsp.0 signal connected"),this.startPublish(e,this.localStream,this.videoInfo,this.mediaStreamConfig,this.playOption)):(this.logger.debug("zp.tsp.0 signal server not connected"),this.waitingAnswerTimer=setTimeout((function(){t.tryStartPublish(e),console.warn(new Date)}),this.waitingAnswerTimeInterval))},e.prototype.checkPublishConnectionFailedState=function(e){var t=null;"failed"==e?t=n.publishErrorList.MEDIA_CONNECTION_FAILED:"closed"==e&&(t=n.publishErrorList.MEDIA_CONNECTION_CLOSED),null!=t&&(this.state!=o.ENUM_PUBLISH_STATE.publishing&&this.retryState==o.ENUM_PUBLISH_STATE.didNotStart?(this.logger.info("zp.oics.0  state "+this.state+" retryState "+this.retryState+" connectionState "+e),this.publishStateUpdateError(t)):this.shouldRetryPublish()?(this.onPublishStateUpdate(n.ENUM_PUBLISH_STATE_UPDATE.retry,this.streamId),this.startRetryPublish()):this.publishStateUpdateError(t))},e.prototype.setPublishQualityTimer=function(){var e=this;if(null==this.qualityTimer){this.logger.info("zp.spq.0 called"),this.clearPublishQualityTimer();var t=!0;this.peerConnection.getStats((function(){})).catch((function(r){e.logger.info("zp.spq.0 "+e.streamId+" getStats callback not support"),t=!1})),this.qualityTimer=setInterval((function(){e.peerConnectionGetStats(t)}),this.qualityTimeInterval),this.lastPublishStats={time:0,audioBytesSent:0,videoBytesSent:0,framesEncoded:0,framesSent:0},this.qualitySeq=n.getSeq(),this.qualityCount=0,this.dataReport.newReport(this.qualitySeq)}},e.prototype.peerConnectionGetStats=function(e){var t=this;this.peerConnection&&(e&&this.peerConnection.getStats((function(e){t.getOldGoogStats(e)}),(function(e){t.logger.info("zp.spq.0 getOldGoogStats error "+e.toString())})),this.peerConnection.getStats(null).then((function(e){t.getPublishStats(e)}),(function(e){t.logger.info("zp.spq.0 getStats error "+e.toString())})))},e.prototype.getOldGoogStats=function(e){var t=this;e&&e.result&&e.result().forEach((function(e){var r=["audioInputLevel","googCpuLimitedResolution","googBandwidthLimitedResolution","googCodecName","googActualEncBitrate","googFrameWidthInput","googFrameHeightInput","googFrameRateInput","codecImplementationName"];if("VideoBwe"===e.type&&(t.streamGoogInfo.googAvailableSendBandwidth=e.stat("googAvailableSendBandwidth")||""),"ssrc"===e.type)for(var i=0;i<r.length;i++){var o=r[i];e.names().includes(o)&&(t.streamGoogInfo[o]=e.stat(o)||"")}}))},e.prototype.getPublishStats=function(e){var t=this;if(e){var r=i({audioCodeType:"opus",audioBitrate:0,videoBitrate:0,audioLevel:0,videoFPS:0,nackCount:0,pliCount:0,frameHeight:0,frameWidth:0,videoTransferFPS:0,totalRoundTripTime:0,currentRoundTripTime:0,muted:!this.localVideo||this.localVideo.muted,paused:!this.localVideo||this.localVideo.paused,volume:this.localVideo?this.localVideo.volume:0,audioDeviceLabel:this.streamCenter.audioDeviceName,videoDeviceLbabel:this.streamCenter.videoDeviceName},this.streamCenter.deviceStates,this.streamGoogInfo),o=this.lastPublishStats.time;e.forEach((function(e){("outbound-rtp"==e.type||"ssrc"==e.type&&null!=e.bytesSent)&&"audio"==e.mediaType?(0!=o&&(r.audioBitrate=8*(e.bytesSent-t.lastPublishStats.audioBytesSent)/(e.timestamp-o)),r.audioBitrate<0&&(r.audioBitrate=0),t.lastPublishStats.audioBytesSent=e.bytesSent,t.lastPublishStats.time=e.timestamp):("outbound-rtp"==e.type||"ssrc"==e.type&&null!=e.bytesSent)&&"video"==e.mediaType?(0!=o&&(r.videoBitrate=8*(e.bytesSent-t.lastPublishStats.videoBytesSent)/(e.timestamp-o),r.videoFPS=1e3*(e.framesEncoded-t.lastPublishStats.framesEncoded)/(e.timestamp-o)),r.videoBitrate<0&&(r.videoBitrate=0),r.videoFPS<0&&(r.videoFPS=0),r.nackCount=e.nackCount,r.pliCount=e.pliCount,t.lastPublishStats.videoBytesSent=e.bytesSent,t.lastPublishStats.framesEncoded=e.framesEncoded,t.lastPublishStats.time=e.timestamp):"track"==e.type&&("video"==e.kind||e.id.indexOf("video")>=0)||e.frameWidth?(r.frameHeight=e.frameHeight,r.frameWidth=e.frameWidth,0!=o&&(r.videoTransferFPS=1e3*(e.framesSent-t.lastPublishStats.framesSent)/(e.timestamp-o)),r.videoTransferFPS<0&&(r.videoTransferFPS=0),t.lastPublishStats.framesSent=e.framesSent):"candidate-pair"==e.type?(null!=e.totalRoundTripTime&&(r.totalRoundTripTime=e.totalRoundTripTime),null!=e.currentRoundTripTime&&(r.currentRoundTripTime=e.currentRoundTripTime)):"media-source"==e.type&&("audio"==e.kind||e.id.toLowerCase().indexOf("audio")>=0)&&(r.audioLevel=e.audioLevel)})),this.uploadPublishQuality(r),0!=o&&this.onPublishQualityUpdate(this.streamId,r)}},e.prototype.uploadPublishQuality=function(e){var t=this;if(this.qualityUpload){var r=Date.parse(new Date+"");(0==this.qualityUploadLastTime||r-this.qualityUploadLastTime>=this.qualityUploadInterval)&&(e.stream_type="publish",e.stream_id=this.streamId,e.timeStamp=r/1e3,this.logger.info("zp.upq.0 upload"+JSON.stringify(e)),this.signal.QualityReport(n.getSeq(),this.sessionId,e,(function(e,r,i){void 0!==i.report&&(t.qualityUpload=i.report,t.qualityUploadInterval=i.report_interval_ms)}),(function(e,r){t.logger.info("zp.upq.0 upload failed "+e)})),this.qualityUploadLastTime=r)}},e.prototype.stopPublish=function(){if(this.logger.info("zp.sp.0.1 called"),Object.keys(this.streamCenter.publisherList).length=1)for(var e in this.streamCenter.playerList){var t=this.streamCenter.playerList[e].player;t.state==o.ENUM_PLAY_STATE.playing&&t.broadcasterStatus==o.ENUM_BROADCASTER_STATUS.start&&(this.signal&&this.signal.sendBroadcasterStatus(n.getSeq(),t.sessionId,0),t.broadcasterStatus=o.ENUM_BROADCASTER_STATUS.stop)}this.sessionId&&!this.closeSessionSignal&&this.signal.sendCloseSession(n.getSeq(),this.sessionId,0),this.dataReport.eventEndWithMsg(this.reportSeq,"PublishState",{state:this.state+""}),this.dataReport.addEvent(this.reportSeq,"StopPublish"),this.dataReport.addMsgExt(this.reportSeq,{stream:this.streamId,sessionId:this.sessionId}),this.dataReport.uploadReport(this.reportSeq,"RTCPublishStream"),this.resetPublish()},e.prototype.onPublishStateUpdate=function(e,t,r){},e.prototype.onPublishQualityUpdate=function(e,t){},e.prototype.onDisconnect=function(){this.logger.info("zp.od.0 call"),this.logger.info("zp.od.0 websocket disconnect"),this.dataReport.addEvent(this.reportSeq,"OnDisconnect"),!this.tryingNexitSignal&&this.tryNextSignal(n.publishErrorList.WEBSOCKET_ERROR)},e.prototype.playEffect=function(e,t,r,i){this.audioMixing.localStream=this.localStream,this.audioMixing.peerConnection=this.peerConnection,this.audioMixing.audioBuffer=t,this.audioMixing.playEffect(e.playTime,e.loop,e.replace,r,i)},e.prototype.pauseEffect=function(){this.audioMixing.pauseEffect()},e.prototype.resumeEffect=function(){this.audioMixing.resumeEffect()},e.prototype.stopMixingBuffer=function(){return this.audioMixing.stopMingBuffer()},e.prototype.mixingBuffer=function(e,t){this.audioMixing.localStream=this.localStream,this.audioMixing.peerConnection=this.peerConnection,this.audioMixing.mixingBuffer(e,t)},e.prototype.voiceChange=function(e){var t=null,r=null;if(this.pitchEffect||(this.pitchEffect=new d.pitchUtil(this.ac),t=this.ac.createMediaStreamSource(this.localStream),r=this.ac.createMediaStreamDestination(),t.connect(this.pitchEffect.input),this.pitchEffect.output.connect(r)),this.pitchEffect.setPitchOffset(e),!this.micTrack){var i=r.stream.getAudioTracks()[0],o=this.peerConnection.getSenders().find((function(e){return e.track.kind===i.kind}));if(!o)return this.logger.error("zp.vc.0 no sender"),!1;this.micTrack=this.localStream.getAudioTracks()[0],o.replaceTrack(i),this.localStream.removeTrack(this.micTrack),this.localStream.addTrack(i)}},e.prototype.voiceBack=function(){var e=this;this.micTrack?(this.peerConnection.getSenders().find((function(t){return t.track.kind===e.micTrack.kind})).replaceTrack(this.micTrack),this.localStream.removeTrack(this.localStream.getAudioTracks()[0]),this.localStream.addTrack(this.micTrack),this.micTrack=null,this.pitchEffect=null):this.logger.error("zp.vb.0 mo mickTrack found")},e.prototype.publishSuccess=function(){for(var e in this.state!=o.ENUM_PUBLISH_STATE.publishing&&this.onPublishStateUpdate(n.ENUM_PUBLISH_STATE_UPDATE.start,this.streamId),this.state=o.ENUM_PUBLISH_STATE.publishing,this.retryState!=o.ENUM_RETRY_STATE.didNotStart&&(this.retryState=o.ENUM_RETRY_STATE.finished,this.currentRetryCount=0),this.dataReport.eventStart(this.reportSeq,"PublishState"),this.streamCenter.playerList){var t=this.streamCenter.playerList[e].player;t.state==o.ENUM_PLAY_STATE.playing&&t.broadcasterStatus==o.ENUM_BROADCASTER_STATUS.stop&&(this.signal&&this.signal.sendBroadcasterStatus(n.getSeq(),t.sessionId,1),t.broadcasterStatus=o.ENUM_BROADCASTER_STATUS.start)}this.setPublishQualityTimer();var r=2,i=2;0!==this.localStream.getVideoTracks().length&&1==this.localStream.getVideoTracks()[0].enabled&&(r=0),0!==this.localStream.getAudioTracks().length&&1==this.localStream.getAudioTracks()[0].enabled&&(i=0),this.signal.sendStreamStatus(n.getSeq(),this.sessionId,r,i),this.streamCenter.soundLevelDelegate&&this.startSoundLevel()},e.prototype.tryNextSignal=function(e){this.tryingNexitSignal=!0;var t=this.streamId,r=this.signal.server,i=this.streamCenter.publisherList[t],s=[];i&&i.serverUrls&&(s=i.serverUrls),this.nextSignalTryCount>3*s.length?(this.logger.error("zp.tns.0 try max limit"),this.publishStateUpdateError(e,!0)):(s.forEach((function(e,t){return t<=s.indexOf(r)&&s.push(e)})),s.splice(0,s.indexOf(r)+1),this.logger.info("zp.tns.0 try next signal "+t),this.signal&&this.signal.state==o.ENUM_CONNECT_STATE.connected&&this.signal.sendCloseSession(n.getSeq(),this.sessionId,1),this.signal&&this.signal.removeSession(this.sessionId),this.resetPublish(),this.streamCenter.connectPublishServer(t),this.nextSignalTryCount++)},e.prototype.startSoundLevel=function(){var e=this;if(this.logger.info("zp.ssl.0 call streamID: "+this.streamId),this.localStream&&0!=this.localStream.getAudioTracks().length){this.script&&this.script.disconnect()&&(this.script=null),this.mic&&this.mic.disconnect()&&(this.mic=null);try{this.mic=this.ac.createMediaStreamSource(this.localStream),this.script=this.ac.createScriptProcessor(4096,1,1),this.mic.connect(this.script),this.script.connect(this.ac.destination),this.script.onaudioprocess=function(t){for(var r=t.inputBuffer.getChannelData(0),i=0,o=0;o<r.length;o++)i<r[o]&&(i=r[o]);e.soundLevel=100*i},this.ac.resume()}catch(e){this.logger.error("zp.ssl.0 get sound level failed "+e)}}else this.logger.info("zp.ssl.0 local stream no found")},e.prototype.stopSoundLevel=function(){this.logger.info("zp.ssl.0.1 call streamID: "+this.streamId),this.script&&this.script.disconnect(),this.mic&&this.mic.disconnect(),this.script=null,this.mic=null},e.prototype.startMixingAudio=function(e){var t=this;return this.logger.info("zp.sma.0 call"),e.forEach((function(e){if(t.audioMixList.find((function(t){return t.media==e})))t.logger.info("zp.sma.0 mix audio already exist");else{var r=new a.audioMixUtil(t.logger,t.ac);r.localStream=t.localStream,r.peerConnection=t.peerConnection,t.audioMixList.push({audioMix:r,media:e}),r.startMixingAudio(e)}})),!0},e.prototype.stopMixingAudio=function(e){var t=this;return this.logger.info("zp.sma.0.0 call"),e?e.forEach((function(e){for(var r=0;r<t.audioMixList.length;r++)if(t.audioMixList[r].media==e){t.audioMixList[r].audioMix.stopMixingAudio()&&t.audioMixList.splice(r--,1);break}})):(this.audioMixList.forEach((function(e){return e.audioMix.stopMixingAudio()})),this.audioMixList=[],this.audioMixing.isMixAudio&&this.audioMixing.stopMixingAudio()),!0},e}();t.ZegoPublish=l},function(e,t,r){e.exports=function e(t,r,i){function o(s,a){if(!r[s]){if(!t[s]){if(n)return n(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var d=r[s]={exports:{}};t[s][0].call(d.exports,(function(e){return o(t[s][1][e]||e)}),d,d.exports,e,t,r,i)}return r[s].exports}for(var n=!1,s=0;s<i.length;s++)o(i[s]);return o}({1:[function(e,t,r){"use strict";var i=(0,e("./adapter_factory.js").adapterFactory)({window:window});t.exports=i},{"./adapter_factory.js":2}],2:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.adapterFactory=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.window,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0},d=i.log,l=i.detectBrowser(t),h={browserDetails:l,commonShim:c,extractVersion:i.extractVersion,disableLog:i.disableLog,disableWarnings:i.disableWarnings};switch(l.browser){case"chrome":if(!o||!o.shimPeerConnection||!r.shimChrome)return d("Chrome shim is not included in this adapter release."),h;d("adapter.js shimming chrome."),h.browserShim=o,o.shimGetUserMedia(t),o.shimMediaStream(t),o.shimPeerConnection(t),o.shimOnTrack(t),o.shimAddTrackRemoveTrack(t),o.shimGetSendersWithDtmf(t),o.shimGetStats(t),o.shimSenderReceiverGetStats(t),o.fixNegotiationNeeded(t),c.shimRTCIceCandidate(t),c.shimConnectionState(t),c.shimMaxMessageSize(t),c.shimSendThrowTypeError(t),c.removeAllowExtmapMixed(t);break;case"firefox":if(!s||!s.shimPeerConnection||!r.shimFirefox)return d("Firefox shim is not included in this adapter release."),h;d("adapter.js shimming firefox."),h.browserShim=s,s.shimGetUserMedia(t),s.shimPeerConnection(t),s.shimOnTrack(t),s.shimRemoveStream(t),s.shimSenderGetStats(t),s.shimReceiverGetStats(t),s.shimRTCDataChannel(t),c.shimRTCIceCandidate(t),c.shimConnectionState(t),c.shimMaxMessageSize(t),c.shimSendThrowTypeError(t);break;case"edge":if(!n||!n.shimPeerConnection||!r.shimEdge)return d("MS edge shim is not included in this adapter release."),h;d("adapter.js shimming edge."),h.browserShim=n,n.shimGetUserMedia(t),n.shimGetDisplayMedia(t),n.shimPeerConnection(t),n.shimReplaceTrack(t),c.shimMaxMessageSize(t),c.shimSendThrowTypeError(t);break;case"safari":if(!a||!r.shimSafari)return d("Safari shim is not included in this adapter release."),h;d("adapter.js shimming safari."),h.browserShim=a,a.shimRTCIceServerUrls(t),a.shimCreateOfferLegacy(t),a.shimCallbacksAPI(t),a.shimLocalStreamsAPI(t),a.shimRemoteStreamsAPI(t),a.shimTrackEventTransceiver(t),a.shimGetUserMedia(t),c.shimRTCIceCandidate(t),c.shimMaxMessageSize(t),c.shimSendThrowTypeError(t),c.removeAllowExtmapMixed(t);break;default:d("Unsupported browser!")}return h};var i=d(e("./utils")),o=d(e("./chrome/chrome_shim")),n=d(e("./edge/edge_shim")),s=d(e("./firefox/firefox_shim")),a=d(e("./safari/safari_shim")),c=d(e("./common_shim"));function d(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}},{"./chrome/chrome_shim":3,"./common_shim":6,"./edge/edge_shim":7,"./firefox/firefox_shim":11,"./safari/safari_shim":14,"./utils":15}],3:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=r.shimGetUserMedia=void 0;var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:!0,get:function(){return o.shimGetUserMedia}});var n=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:!0,get:function(){return n.shimGetDisplayMedia}}),r.shimMediaStream=function(e){e.MediaStream=e.MediaStream||e.webkitMediaStream},r.shimOnTrack=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var r=this;return this._ontrackpoly||(this._ontrackpoly=function(t){t.stream.addEventListener("addtrack",(function(i){var o;o=e.RTCPeerConnection.prototype.getReceivers?r.getReceivers().find((function(e){return e.track&&e.track.id===i.track.id})):{track:i.track};var n=new Event("track");n.track=i.track,n.receiver=o,n.transceiver={receiver:o},n.streams=[t.stream],r.dispatchEvent(n)})),t.stream.getTracks().forEach((function(i){var o;o=e.RTCPeerConnection.prototype.getReceivers?r.getReceivers().find((function(e){return e.track&&e.track.id===i.id})):{track:i};var n=new Event("track");n.track=i,n.receiver=o,n.transceiver={receiver:o},n.streams=[t.stream],r.dispatchEvent(n)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else s.wrapPeerConnectionEvent(e,"track",(function(e){return e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e}))},r.shimGetSendersWithDtmf=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){var t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};var r=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){var o=r.apply(this,arguments);return o||(o=t(this,e),this._senders.push(o)),o};var o=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){o.apply(this,arguments);var t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}var n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var r=this;this._senders=this._senders||[],n.apply(this,[e]),e.getTracks().forEach((function(e){r._senders.push(t(r,e))}))};var s=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;this._senders=this._senders||[],s.apply(this,[e]),e.getTracks().forEach((function(e){var r=t._senders.find((function(t){return t.track===e}));r&&t._senders.splice(t._senders.indexOf(r),1)}))}}else if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){var a=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){var e=this,t=a.apply(this,[]);return t.forEach((function(t){return t._pc=e})),t},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}},r.shimGetStats=function(e){if(e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,r,i){var o=this,n=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof arguments[0]))return t.apply(this,[]);var s=function(e){var t={};return e.result().forEach((function(e){var r={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((function(t){r[t]=e.stat(t)})),t[r.id]=r})),t},a=function(e){return new Map(Object.keys(e).map((function(t){return[t,e[t]]})))};if(arguments.length>=2){var c=function(e){n[1](a(s(e)))};return t.apply(this,[c,arguments[0]])}return new Promise((function(e,r){t.apply(o,[function(t){e(a(s(t)))},r])})).then(r,i)}}},r.shimSenderReceiverGetStats=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver){if(!("getStats"in e.RTCRtpSender.prototype)){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,r=t.apply(this,[]);return r.forEach((function(t){return t._pc=e})),r});var r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){var e=this;return this._pc.getStats().then((function(t){return s.filterStats(t,e.track,!0)}))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){var o=e.RTCPeerConnection.prototype.getReceivers;o&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,t=o.apply(this,[]);return t.forEach((function(t){return t._pc=e})),t}),s.wrapPeerConnectionEvent(e,"track",(function(e){return e.receiver._pc=e.srcElement,e})),e.RTCRtpReceiver.prototype.getStats=function(){var e=this;return this._pc.getStats().then((function(t){return s.filterStats(t,e.track,!1)}))}}if("getStats"in e.RTCRtpSender.prototype&&"getStats"in e.RTCRtpReceiver.prototype){var n=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){var t=arguments[0],r=void 0,i=void 0,o=void 0;return this.getSenders().forEach((function(e){e.track===t&&(r?o=!0:r=e)})),this.getReceivers().forEach((function(e){return e.track===t&&(i?o=!0:i=e),e.track===t})),o||r&&i?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():i?i.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return n.apply(this,arguments)}}}},r.shimAddTrackRemoveTrackWithNative=a,r.shimAddTrackRemoveTrack=function(e){if(e.RTCPeerConnection){var t=s.detectBrowser(e);if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return a(e);var r=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this,t=r.apply(this);return this._reverseStreams=this._reverseStreams||{},t.map((function(t){return e._reverseStreams[t.id]}))};var i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){var r=this;if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((function(e){if(r.getSenders().find((function(t){return t.track===e})))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){var o=new e.MediaStream(t.getTracks());this._streams[t.id]=o,this._reverseStreams[o.id]=t,t=o}i.apply(this,[t])};var o=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},o.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,r){var i=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var o=[].slice.call(arguments,1);if(1!==o.length||!o[0].getTracks().find((function(e){return e===t})))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");var n=this.getSenders().find((function(e){return e.track===t}));if(n)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};var s=this._streams[r.id];if(s)s.addTrack(t),Promise.resolve().then((function(){i.dispatchEvent(new Event("negotiationneeded"))}));else{var a=new e.MediaStream([t]);this._streams[r.id]=a,this._reverseStreams[a.id]=r,this.addStream(a)}return this.getSenders().find((function(e){return e.track===t}))},["createOffer","createAnswer"].forEach((function(t){var r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){var e=this,t=arguments,i=arguments.length&&"function"==typeof arguments[0];return i?r.apply(this,[function(r){var i=d(e,r);t[0].apply(null,[i])},function(e){t[1]&&t[1].apply(null,e)},arguments[2]]):r.apply(this,arguments).then((function(t){return d(e,t)}))}}));var n=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=l(this,arguments[0]),n.apply(this,arguments)):n.apply(this,arguments)};var c=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get:function(){var e=c.get.apply(this);return""===e.type?e:d(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(e._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};var r=void 0;Object.keys(this._streams).forEach((function(i){t._streams[i].getTracks().find((function(t){return e.track===t}))&&(r=t._streams[i])})),r&&(1===r.getTracks().length?this.removeStream(this._reverseStreams[r.id]):r.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function d(e,t){var r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((function(t){var i=e._reverseStreams[t],o=e._streams[i.id];r=r.replace(new RegExp(o.id,"g"),i.id)})),new RTCSessionDescription({type:t.type,sdp:r})}function l(e,t){var r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((function(t){var i=e._reverseStreams[t],o=e._streams[i.id];r=r.replace(new RegExp(i.id,"g"),o.id)})),new RTCSessionDescription({type:t.type,sdp:r})}},r.shimPeerConnection=function(e){if(!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection){["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){var r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}}));var t=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?t.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}},r.fixNegotiationNeeded=function(e){s.wrapPeerConnectionEvent(e,"negotiationneeded",(function(e){if("stable"===e.target.signalingState)return e}))};var s=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils.js"));function a(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((function(t){return e._shimmedLocalStreams[t][0]}))};var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){if(!r)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};var i=t.apply(this,arguments);return this._shimmedLocalStreams[r.id]?-1===this._shimmedLocalStreams[r.id].indexOf(i)&&this._shimmedLocalStreams[r.id].push(i):this._shimmedLocalStreams[r.id]=[r,i],i};var r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var t=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((function(e){if(t.getSenders().find((function(t){return t.track===e})))throw new DOMException("Track already exists.","InvalidAccessError")}));var i=this.getSenders();r.apply(this,arguments);var o=this.getSenders().filter((function(e){return-1===i.indexOf(e)}));this._shimmedLocalStreams[e.id]=[e].concat(o)};var i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],i.apply(this,arguments)};var o=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((function(r){var i=t._shimmedLocalStreams[r].indexOf(e);-1!==i&&t._shimmedLocalStreams[r].splice(i,1),1===t._shimmedLocalStreams[r].length&&delete t._shimmedLocalStreams[r]})),o.apply(this,arguments)}}},{"../utils.js":15,"./getdisplaymedia":4,"./getusermedia":5}],4:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(r){return t(r).then((function(t){var i=r.video&&r.video.width,o=r.video&&r.video.height,n=r.video&&r.video.frameRate;return r.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:n||3}},i&&(r.video.mandatory.maxWidth=i),o&&(r.video.mandatory.maxHeight=o),e.navigator.mediaDevices.getUserMedia(r)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}},{}],5:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimGetUserMedia=function(e){var t=e&&e.navigator;if(t.mediaDevices){var r=o.detectBrowser(e),s=function(e){if("object"!==(void 0===e?"undefined":i(e))||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach((function(r){if("require"!==r&&"advanced"!==r&&"mediaSource"!==r){var o="object"===i(e[r])?e[r]:{ideal:e[r]};void 0!==o.exact&&"number"==typeof o.exact&&(o.min=o.max=o.exact);var n=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==o.ideal){t.optional=t.optional||[];var s={};"number"==typeof o.ideal?(s[n("min",r)]=o.ideal,t.optional.push(s),(s={})[n("max",r)]=o.ideal,t.optional.push(s)):(s[n("",r)]=o.ideal,t.optional.push(s))}void 0!==o.exact&&"number"!=typeof o.exact?(t.mandatory=t.mandatory||{},t.mandatory[n("",r)]=o.exact):["min","max"].forEach((function(e){void 0!==o[e]&&(t.mandatory=t.mandatory||{},t.mandatory[n(e,r)]=o[e])}))}})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},a=function(e,o){if(r.version>=61)return o(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"===i(e.audio)){var a=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])};a((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),a(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=s(e.audio)}if(e&&"object"===i(e.video)){var c=e.video.facingMode;c=c&&("object"===(void 0===c?"undefined":i(c))?c:{ideal:c});var d=r.version<66;if(c&&("user"===c.exact||"environment"===c.exact||"user"===c.ideal||"environment"===c.ideal)&&(!t.mediaDevices.getSupportedConstraints||!t.mediaDevices.getSupportedConstraints().facingMode||d)){delete e.video.facingMode;var l=void 0;if("environment"===c.exact||"environment"===c.ideal?l=["back","rear"]:"user"!==c.exact&&"user"!==c.ideal||(l=["front"]),l)return t.mediaDevices.enumerateDevices().then((function(t){var r=(t=t.filter((function(e){return"videoinput"===e.kind}))).find((function(e){return l.some((function(t){return e.label.toLowerCase().includes(t)}))}));return!r&&t.length&&l.includes("back")&&(r=t[t.length-1]),r&&(e.video.deviceId=c.exact?{exact:r.deviceId}:{ideal:r.deviceId}),e.video=s(e.video),n("chrome: "+JSON.stringify(e)),o(e)}))}e.video=s(e.video)}return n("chrome: "+JSON.stringify(e)),o(e)},c=function(e){return r.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}};if(t.getUserMedia=function(e,r,i){a(e,(function(e){t.webkitGetUserMedia(e,r,(function(e){i&&i(c(e))}))}))}.bind(t),t.mediaDevices.getUserMedia){var d=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return a(e,(function(e){return d(e).then((function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach((function(e){e.stop()})),new DOMException("","NotFoundError");return t}),(function(e){return Promise.reject(c(e))}))}))}}}};var o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils.js")),n=o.log},{"../utils.js":15}],6:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimRTCIceCandidate=function(e){if(!(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)){var t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){var r=new t(e),o=n.default.parseCandidate(e.candidate),s=Object.assign(r,o);return s.toJSON=function(){return{candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex,usernameFragment:s.usernameFragment}},s}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,s.wrapPeerConnectionEvent(e,"icecandidate",(function(t){return t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t}))}},r.shimMaxMessageSize=function(e){if(!e.RTCSctpTransport&&e.RTCPeerConnection){var t=s.detectBrowser(e);"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get:function(){return void 0===this._sctp?null:this._sctp}});var r=function(e){if(!e||!e.sdp)return!1;var t=n.default.splitSections(e.sdp);return t.shift(),t.some((function(e){var t=n.default.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))},i=function(e){var t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;var r=parseInt(t[1],10);return r!=r?-1:r},o=function(e){var r=65536;return"firefox"===t.browser&&(r=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),r},a=function(e,r){var i=65536;"firefox"===t.browser&&57===t.version&&(i=65535);var o=n.default.matchPrefix(e.sdp,"a=max-message-size:");return o.length>0?i=parseInt(o[0].substr(19),10):"firefox"===t.browser&&-1!==r&&(i=2147483637),i},c=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,r(arguments[0])){var e=i(arguments[0]),t=o(e),n=a(arguments[0],e),s=void 0;s=0===t&&0===n?Number.POSITIVE_INFINITY:0===t||0===n?Math.max(t,n):Math.min(t,n);var d={};Object.defineProperty(d,"maxMessageSize",{get:function(){return s}}),this._sctp=d}return c.apply(this,arguments)}}},r.shimSendThrowTypeError=function(e){if(e.RTCPeerConnection&&"createDataChannel"in e.RTCPeerConnection.prototype){var t=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){var e=t.apply(this,arguments);return r(e,this),e},s.wrapPeerConnectionEvent(e,"datachannel",(function(e){return r(e.channel,e.target),e}))}function r(e,t){var r=e.send;e.send=function(){var i=arguments[0],o=i.length||i.size||i.byteLength;if("open"===e.readyState&&t.sctp&&o>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return r.apply(e,arguments)}}},r.shimConnectionState=function(e){if(e.RTCPeerConnection&&!("connectionState"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get:function(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get:function(){return this._onconnectionstatechange||null},set:function(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((function(e){var r=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=function(e){var t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;var r=new Event("connectionstatechange",e);t.dispatchEvent(r)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),r.apply(this,arguments)}}))}},r.removeAllowExtmapMixed=function(e){if(e.RTCPeerConnection){var t=s.detectBrowser(e);if(!("chrome"===t.browser&&t.version>=71)){var r=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(e){return e&&e.sdp&&-1!==e.sdp.indexOf("\na=extmap-allow-mixed")&&(e.sdp=e.sdp.split("\n").filter((function(e){return"a=extmap-allow-mixed"!==e.trim()})).join("\n")),r.apply(this,arguments)}}}};var o,n=(o=e("sdp"))&&o.__esModule?o:{default:o},s=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("./utils"))},{"./utils":15,sdp:17}],7:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=r.shimGetUserMedia=void 0;var i=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:!0,get:function(){return i.shimGetUserMedia}});var o=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:!0,get:function(){return o.shimGetDisplayMedia}}),r.shimPeerConnection=function(e){var t=s.detectBrowser(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)){var r=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set:function(e){r.set.call(this,e);var t=new Event("enabled");t.enabled=e,this.dispatchEvent(t)}})}e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)&&Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);var i=(0,c.default)(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=(0,a.filterIceServers)(e.iceServers,t.version),s.log("ICE servers after filtering:",e.iceServers)),new i(e)},e.RTCPeerConnection.prototype=i.prototype},r.shimReplaceTrack=function(e){e.RTCRtpSender&&!("replaceTrack"in e.RTCRtpSender.prototype)&&(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)};var n,s=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils")),a=e("./filtericeservers"),c=(n=e("rtcpeerconnection-shim"))&&n.__esModule?n:{default:n}},{"../utils":15,"./filtericeservers":8,"./getdisplaymedia":9,"./getusermedia":10,"rtcpeerconnection-shim":16}],8:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.filterIceServers=function(e,t){var r=!1;return(e=JSON.parse(JSON.stringify(e))).filter((function(e){if(e&&(e.urls||e.url)){var t=e.urls||e.url;e.url&&!e.urls&&i.deprecated("RTCIceServer.url","RTCIceServer.urls");var o="string"==typeof t;return o&&(t=[t]),t=t.filter((function(e){if(0===e.indexOf("stun:"))return!1;var t=e.startsWith("turn")&&!e.startsWith("turn:[")&&e.includes("transport=udp");return t&&!r?(r=!0,!0):t&&!r})),delete e.url,e.urls=o?t[0]:t,!!t.length}}))};var i=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils"))},{"../utils":15}],9:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=function(e){"getDisplayMedia"in e.navigator&&e.navigator.mediaDevices&&(e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=e.navigator.getDisplayMedia.bind(e.navigator)))}},{}],10:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetUserMedia=function(e){var t=e&&e.navigator,r=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return r(e).catch((function(e){return Promise.reject(function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString:function(){return this.name}}}(e))}))}}},{}],11:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=r.shimGetUserMedia=void 0;var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:!0,get:function(){return o.shimGetUserMedia}});var n=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:!0,get:function(){return n.shimGetDisplayMedia}}),r.shimOnTrack=function(e){"object"===(void 0===e?"undefined":i(e))&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},r.shimPeerConnection=function(e){var t=s.detectBrowser(e);if("object"===(void 0===e?"undefined":i(e))&&(e.RTCPeerConnection||e.mozRTCPeerConnection)){!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){var r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}}));var r=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?r.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};var o={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,r,i){return n.apply(this,[e||null]).then((function(e){if(t.version<53&&!r)try{e.forEach((function(e){e.type=o[e.type]||e.type}))}catch(t){if("TypeError"!==t.name)throw t;e.forEach((function(t,r){e.set(r,Object.assign({},t,{type:o[t.type]||t.type}))}))}return e})).then(r,i)}}},r.shimSenderGetStats=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&(!e.RTCRtpSender||!("getStats"in e.RTCRtpSender.prototype))){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,r=t.apply(this,[]);return r.forEach((function(t){return t._pc=e})),r});var r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}},r.shimReceiverGetStats=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&(!e.RTCRtpSender||!("getStats"in e.RTCRtpReceiver.prototype))){var t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,r=t.apply(this,[]);return r.forEach((function(t){return t._pc=e})),r}),s.wrapPeerConnectionEvent(e,"track",(function(e){return e.receiver._pc=e.srcElement,e})),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}},r.shimRemoveStream=function(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;s.deprecated("removeStream","removeTrack"),this.getSenders().forEach((function(r){r.track&&e.getTracks().includes(r.track)&&t.removeTrack(r)}))})},r.shimRTCDataChannel=function(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)};var s=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils"))},{"../utils":15,"./getdisplaymedia":12,"./getusermedia":13}],12:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(r){if(!r||!r.video){var i=new DOMException("getDisplayMedia without video constraints is undefined");return i.name="NotFoundError",i.code=8,Promise.reject(i)}return!0===r.video?r.video={mediaSource:t}:r.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(r)})}},{}],13:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimGetUserMedia=function(e){var t=o.detectBrowser(e),r=e&&e.navigator,n=e&&e.MediaStreamTrack;if(r.getUserMedia=function(e,t,i){o.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),r.mediaDevices.getUserMedia(e).then(t,i)},!(t.version>55&&"autoGainControl"in r.mediaDevices.getSupportedConstraints())){var s=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])},a=r.mediaDevices.getUserMedia.bind(r.mediaDevices);if(r.mediaDevices.getUserMedia=function(e){return"object"===(void 0===e?"undefined":i(e))&&"object"===i(e.audio)&&(e=JSON.parse(JSON.stringify(e)),s(e.audio,"autoGainControl","mozAutoGainControl"),s(e.audio,"noiseSuppression","mozNoiseSuppression")),a(e)},n&&n.prototype.getSettings){var c=n.prototype.getSettings;n.prototype.getSettings=function(){var e=c.apply(this,arguments);return s(e,"mozAutoGainControl","autoGainControl"),s(e,"mozNoiseSuppression","noiseSuppression"),e}}if(n&&n.prototype.applyConstraints){var d=n.prototype.applyConstraints;n.prototype.applyConstraints=function(e){return"audio"===this.kind&&"object"===(void 0===e?"undefined":i(e))&&(e=JSON.parse(JSON.stringify(e)),s(e,"autoGainControl","mozAutoGainControl"),s(e,"noiseSuppression","mozNoiseSuppression")),d.apply(this,[e])}}}};var o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils"))},{"../utils":15}],14:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimLocalStreamsAPI=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){var r=this;this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getTracks().forEach((function(i){return t.call(r,i,e)}))},e.RTCPeerConnection.prototype.addTrack=function(e,r){return r&&(this._localStreams?this._localStreams.includes(r)||this._localStreams.push(r):this._localStreams=[r]),t.call(this,e,r)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;this._localStreams||(this._localStreams=[]);var r=this._localStreams.indexOf(e);if(-1!==r){this._localStreams.splice(r,1);var i=e.getTracks();this.getSenders().forEach((function(e){i.includes(e.track)&&t.removeTrack(e)}))}})}},r.shimRemoteStreamsAPI=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(e){var t=this;this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach((function(e){if(t._remoteStreams||(t._remoteStreams=[]),!t._remoteStreams.includes(e)){t._remoteStreams.push(e);var r=new Event("addstream");r.stream=e,t.dispatchEvent(r)}}))})}});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((function(t){if(e._remoteStreams||(e._remoteStreams=[]),!(e._remoteStreams.indexOf(t)>=0)){e._remoteStreams.push(t);var r=new Event("addstream");r.stream=t,e.dispatchEvent(r)}}))}),t.apply(e,arguments)}}},r.shimCallbacksAPI=function(e){if("object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype,r=t.createOffer,o=t.createAnswer,n=t.setLocalDescription,s=t.setRemoteDescription,a=t.addIceCandidate;t.createOffer=function(e,t){var i=arguments.length>=2?arguments[2]:arguments[0],o=r.apply(this,[i]);return t?(o.then(e,t),Promise.resolve()):o},t.createAnswer=function(e,t){var r=arguments.length>=2?arguments[2]:arguments[0],i=o.apply(this,[r]);return t?(i.then(e,t),Promise.resolve()):i};var c=function(e,t,r){var i=n.apply(this,[e]);return r?(i.then(t,r),Promise.resolve()):i};t.setLocalDescription=c,c=function(e,t,r){var i=s.apply(this,[e]);return r?(i.then(t,r),Promise.resolve()):i},t.setRemoteDescription=c,c=function(e,t,r){var i=a.apply(this,[e]);return r?(i.then(t,r),Promise.resolve()):i},t.addIceCandidate=c}},r.shimGetUserMedia=function(e){var t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){var r=t.mediaDevices,i=r.getUserMedia.bind(r);t.mediaDevices.getUserMedia=function(e){return i(n(e))}}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,r,i){t.mediaDevices.getUserMedia(e).then(r,i)}.bind(t))},r.shimConstraints=n,r.shimRTCIceServerUrls=function(e){var t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,r){if(e&&e.iceServers){for(var i=[],n=0;n<e.iceServers.length;n++){var s=e.iceServers[n];!s.hasOwnProperty("urls")&&s.hasOwnProperty("url")?(o.deprecated("RTCIceServer.url","RTCIceServer.urls"),(s=JSON.parse(JSON.stringify(s))).urls=s.url,delete s.url,i.push(s)):i.push(e.iceServers[n])}e.iceServers=i}return new t(e,r)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in e.RTCPeerConnection&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return t.generateCertificate}})},r.shimTrackEventTransceiver=function(e){"object"===(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&"receiver"in e.RTCTrackEvent.prototype&&!e.RTCTransceiver&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},r.shimCreateOfferLegacy=function(e){var t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);var r=this.getTransceivers().find((function(e){return"audio"===e.receiver.track.kind}));!1===e.offerToReceiveAudio&&r?"sendrecv"===r.direction?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":"recvonly"===r.direction&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):!0!==e.offerToReceiveAudio||r||this.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);var i=this.getTransceivers().find((function(e){return"video"===e.receiver.track.kind}));!1===e.offerToReceiveVideo&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):!0!==e.offerToReceiveVideo||i||this.addTransceiver("video")}return t.apply(this,arguments)}};var o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils"));function n(e){return e&&void 0!==e.video?Object.assign({},e,{video:o.compactObject(e.video)}):e}},{"../utils":15}],15:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.extractVersion=s,r.wrapPeerConnectionEvent=function(e,t,r){if(e.RTCPeerConnection){var i=e.RTCPeerConnection.prototype,o=i.addEventListener;i.addEventListener=function(e,i){if(e!==t)return o.apply(this,arguments);var n=function(e){var t=r(e);t&&i(t)};return this._eventMap=this._eventMap||{},this._eventMap[i]=n,o.apply(this,[e,n])};var n=i.removeEventListener;i.removeEventListener=function(e,r){if(e!==t||!this._eventMap||!this._eventMap[r])return n.apply(this,arguments);var i=this._eventMap[r];return delete this._eventMap[r],n.apply(this,[e,i])},Object.defineProperty(i,"on"+t,{get:function(){return this["_on"+t]},set:function(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}},r.disableLog=function(e){return"boolean"!=typeof e?new Error("Argument type: "+(void 0===e?"undefined":i(e))+". Please use a boolean."):(o=e,e?"adapter.js logging disabled":"adapter.js logging enabled")},r.disableWarnings=function(e){return"boolean"!=typeof e?new Error("Argument type: "+(void 0===e?"undefined":i(e))+". Please use a boolean."):(n=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))},r.log=function(){if("object"===("undefined"==typeof window?"undefined":i(window))){if(o)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},r.deprecated=function(e,t){n&&console.warn(e+" is deprecated, please use "+t+" instead.")},r.detectBrowser=function(e){var t=e.navigator,r={browser:null,version:null};if(void 0===e||!e.navigator)return r.browser="Not a browser.",r;if(t.mozGetUserMedia)r.browser="firefox",r.version=s(t.userAgent,/Firefox\/(\d+)\./,1);else if(t.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)r.browser="chrome",r.version=s(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/))r.browser="edge",r.version=s(t.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!t.userAgent.match(/AppleWebKit\/(\d+)\./))return r.browser="Not a supported browser.",r;r.browser="safari",r.version=s(t.userAgent,/AppleWebKit\/(\d+)\./,1)}return r},r.compactObject=function e(t){return"object"!==(void 0===t?"undefined":i(t))?t:Object.keys(t).reduce((function(r,o){var n="object"===i(t[o]),s=n?e(t[o]):t[o],a=n&&!Object.keys(s).length;return void 0===s||a?r:Object.assign(r,function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}({},o,s))}),{})},r.walkStats=a,r.filterStats=function(e,t,r){var i=r?"outbound-rtp":"inbound-rtp",o=new Map;if(null===t)return o;var n=[];return e.forEach((function(e){"track"===e.type&&e.trackIdentifier===t.id&&n.push(e)})),n.forEach((function(t){e.forEach((function(r){r.type===i&&r.trackId===t.id&&a(e,r,o)}))})),o};var o=!0,n=!0;function s(e,t,r){var i=e.match(t);return i&&i.length>=r&&parseInt(i[r],10)}function a(e,t,r){t&&!r.has(t.id)&&(r.set(t.id,t),Object.keys(t).forEach((function(i){i.endsWith("Id")?a(e,e.get(t[i]),r):i.endsWith("Ids")&&t[i].forEach((function(t){a(e,e.get(t),r)}))})))}},{}],16:[function(e,t,r){"use strict";var i=e("sdp");function o(e,t,r,o,n){var s=i.writeRtpDescription(e.kind,t);if(s+=i.writeIceParameters(e.iceGatherer.getLocalParameters()),s+=i.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":n||"active"),s+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?s+="a=sendrecv\r\n":e.rtpSender?s+="a=sendonly\r\n":e.rtpReceiver?s+="a=recvonly\r\n":s+="a=inactive\r\n",e.rtpSender){var a=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=a;var c="msid:"+(o?o.id:"-")+" "+a+"\r\n";s+="a="+c,s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+c,e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+c,s+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+i.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+i.localCName+"\r\n"),s}function n(e,t){var r={codecs:[],headerExtensions:[],fecMechanisms:[]},i=function(e,t){e=parseInt(e,10);for(var r=0;r<t.length;r++)if(t[r].payloadType===e||t[r].preferredPayloadType===e)return t[r]},o=function(e,t,r,o){var n=i(e.parameters.apt,r),s=i(t.parameters.apt,o);return n&&s&&n.name.toLowerCase()===s.name.toLowerCase()};return e.codecs.forEach((function(i){for(var n=0;n<t.codecs.length;n++){var s=t.codecs[n];if(i.name.toLowerCase()===s.name.toLowerCase()&&i.clockRate===s.clockRate){if("rtx"===i.name.toLowerCase()&&i.parameters&&s.parameters.apt&&!o(i,s,e.codecs,t.codecs))continue;(s=JSON.parse(JSON.stringify(s))).numChannels=Math.min(i.numChannels,s.numChannels),r.codecs.push(s),s.rtcpFeedback=s.rtcpFeedback.filter((function(e){for(var t=0;t<i.rtcpFeedback.length;t++)if(i.rtcpFeedback[t].type===e.type&&i.rtcpFeedback[t].parameter===e.parameter)return!0;return!1}));break}}})),e.headerExtensions.forEach((function(e){for(var i=0;i<t.headerExtensions.length;i++){var o=t.headerExtensions[i];if(e.uri===o.uri){r.headerExtensions.push(o);break}}})),r}function s(e,t,r){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(r)}function a(e,t){var r=e.getRemoteCandidates().find((function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type}));return r||e.addRemoteCandidate(t),!r}function c(e,t){var r=new Error(t);return r.name=e,r.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],r}t.exports=function(e,t){function r(t,r){r.addTrack(t),r.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function d(t,r,i,o){var n=new Event("track");n.track=r,n.receiver=i,n.transceiver={receiver:i},n.streams=o,e.setTimeout((function(){t._dispatchEvent("track",n)}))}var l=function(r){var o=this,n=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach((function(e){o[e]=n[e].bind(n)})),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",r=JSON.parse(JSON.stringify(r||{})),this.usingBundle="max-bundle"===r.bundlePolicy,"negotiate"===r.rtcpMuxPolicy)throw c("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(r.rtcpMuxPolicy||(r.rtcpMuxPolicy="require"),r.iceTransportPolicy){case"all":case"relay":break;default:r.iceTransportPolicy="all"}switch(r.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:r.bundlePolicy="balanced"}if(r.iceServers=function(e,t){var r=!1;return(e=JSON.parse(JSON.stringify(e))).filter((function(e){if(e&&(e.urls||e.url)){var i=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var o="string"==typeof i;return o&&(i=[i]),i=i.filter((function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||r?0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp"):(r=!0,!0)})),delete e.url,e.urls=o?i[0]:i,!!i.length}}))}(r.iceServers||[],t),this._iceGatherers=[],r.iceCandidatePoolSize)for(var s=r.iceCandidatePoolSize;s>0;s--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:r.iceServers,gatherPolicy:r.iceTransportPolicy}));else r.iceCandidatePoolSize=0;this._config=r,this.transceivers=[],this._sdpSessionId=i.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(l.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(l.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),l.prototype.onicecandidate=null,l.prototype.onaddstream=null,l.prototype.ontrack=null,l.prototype.onremovestream=null,l.prototype.onsignalingstatechange=null,l.prototype.oniceconnectionstatechange=null,l.prototype.onconnectionstatechange=null,l.prototype.onicegatheringstatechange=null,l.prototype.onnegotiationneeded=null,l.prototype.ondatachannel=null,l.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},l.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},l.prototype.getConfiguration=function(){return this._config},l.prototype.getLocalStreams=function(){return this.localStreams},l.prototype.getRemoteStreams=function(){return this.remoteStreams},l.prototype._createTransceiver=function(e,t){var r=this.transceivers.length>0,i={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&r)i.iceTransport=this.transceivers[0].iceTransport,i.dtlsTransport=this.transceivers[0].dtlsTransport;else{var o=this._createIceAndDtlsTransports();i.iceTransport=o.iceTransport,i.dtlsTransport=o.dtlsTransport}return t||this.transceivers.push(i),i},l.prototype.addTrack=function(t,r){if(this._isClosed)throw c("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var i;if(this.transceivers.find((function(e){return e.track===t})))throw c("InvalidAccessError","Track already exists.");for(var o=0;o<this.transceivers.length;o++)this.transceivers[o].track||this.transceivers[o].kind!==t.kind||(i=this.transceivers[o]);return i||(i=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(r)&&this.localStreams.push(r),i.track=t,i.stream=r,i.rtpSender=new e.RTCRtpSender(t,i.dtlsTransport),i.rtpSender},l.prototype.addStream=function(e){var r=this;if(t>=15025)e.getTracks().forEach((function(t){r.addTrack(t,e)}));else{var i=e.clone();e.getTracks().forEach((function(e,t){var r=i.getTracks()[t];e.addEventListener("enabled",(function(e){r.enabled=e.enabled}))})),i.getTracks().forEach((function(e){r.addTrack(e,i)}))}},l.prototype.removeTrack=function(t){if(this._isClosed)throw c("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var r=this.transceivers.find((function(e){return e.rtpSender===t}));if(!r)throw c("InvalidAccessError","Sender was not created by this connection.");var i=r.stream;r.rtpSender.stop(),r.rtpSender=null,r.track=null,r.stream=null,-1===this.transceivers.map((function(e){return e.stream})).indexOf(i)&&this.localStreams.indexOf(i)>-1&&this.localStreams.splice(this.localStreams.indexOf(i),1),this._maybeFireNegotiationNeeded()},l.prototype.removeStream=function(e){var t=this;e.getTracks().forEach((function(e){var r=t.getSenders().find((function(t){return t.track===e}));r&&t.removeTrack(r)}))},l.prototype.getSenders=function(){return this.transceivers.filter((function(e){return!!e.rtpSender})).map((function(e){return e.rtpSender}))},l.prototype.getReceivers=function(){return this.transceivers.filter((function(e){return!!e.rtpReceiver})).map((function(e){return e.rtpReceiver}))},l.prototype._createIceGatherer=function(t,r){var i=this;if(r&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var o=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(o,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var r=!e.candidate||0===Object.keys(e.candidate).length;o.state=r?"completed":"gathering",null!==i.transceivers[t].bufferedCandidateEvents&&i.transceivers[t].bufferedCandidateEvents.push(e)},o.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),o},l.prototype._gather=function(t,r){var o=this,n=this.transceivers[r].iceGatherer;if(!n.onlocalcandidate){var s=this.transceivers[r].bufferedCandidateEvents;this.transceivers[r].bufferedCandidateEvents=null,n.removeEventListener("localcandidate",this.transceivers[r].bufferCandidates),n.onlocalcandidate=function(e){if(!(o.usingBundle&&r>0)){var s=new Event("icecandidate");s.candidate={sdpMid:t,sdpMLineIndex:r};var a=e.candidate,c=!a||0===Object.keys(a).length;if(c)"new"!==n.state&&"gathering"!==n.state||(n.state="completed");else{"new"===n.state&&(n.state="gathering"),a.component=1,a.ufrag=n.getLocalParameters().usernameFragment;var d=i.writeCandidate(a);s.candidate=Object.assign(s.candidate,i.parseCandidate(d)),s.candidate.candidate=d,s.candidate.toJSON=function(){return{candidate:s.candidate.candidate,sdpMid:s.candidate.sdpMid,sdpMLineIndex:s.candidate.sdpMLineIndex,usernameFragment:s.candidate.usernameFragment}}}var l=i.getMediaSections(o._localDescription.sdp);l[s.candidate.sdpMLineIndex]+=c?"a=end-of-candidates\r\n":"a="+s.candidate.candidate+"\r\n",o._localDescription.sdp=i.getDescription(o._localDescription.sdp)+l.join("");var h=o.transceivers.every((function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state}));"gathering"!==o.iceGatheringState&&(o.iceGatheringState="gathering",o._emitGatheringStateChange()),c||o._dispatchEvent("icecandidate",s),h&&(o._dispatchEvent("icecandidate",new Event("icecandidate")),o.iceGatheringState="complete",o._emitGatheringStateChange())}},e.setTimeout((function(){s.forEach((function(e){n.onlocalcandidate(e)}))}),0)}},l.prototype._createIceAndDtlsTransports=function(){var t=this,r=new e.RTCIceTransport(null);r.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState()};var i=new e.RTCDtlsTransport(r);return i.ondtlsstatechange=function(){t._updateConnectionState()},i.onerror=function(){Object.defineProperty(i,"state",{value:"failed",writable:!0}),t._updateConnectionState()},{iceTransport:r,dtlsTransport:i}},l.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var r=this.transceivers[e].iceTransport;r&&(delete r.onicestatechange,delete this.transceivers[e].iceTransport);var i=this.transceivers[e].dtlsTransport;i&&(delete i.ondtlsstatechange,delete i.onerror,delete this.transceivers[e].dtlsTransport)},l.prototype._transceive=function(e,r,o){var s=n(e.localCapabilities,e.remoteCapabilities);r&&e.rtpSender&&(s.encodings=e.sendEncodingParameters,s.rtcp={cname:i.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(s.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(s)),o&&e.rtpReceiver&&s.codecs.length>0&&("video"===e.kind&&e.recvEncodingParameters&&t<15019&&e.recvEncodingParameters.forEach((function(e){delete e.rtx})),e.recvEncodingParameters.length?s.encodings=e.recvEncodingParameters:s.encodings=[{}],s.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(s.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(s.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(s))},l.prototype.setLocalDescription=function(e){var t,r,o=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(c("TypeError",'Unsupported type "'+e.type+'"'));if(!s("setLocalDescription",e.type,o.signalingState)||o._isClosed)return Promise.reject(c("InvalidStateError","Can not set local "+e.type+" in state "+o.signalingState));if("offer"===e.type)t=i.splitSections(e.sdp),r=t.shift(),t.forEach((function(e,t){var r=i.parseRtpParameters(e);o.transceivers[t].localCapabilities=r})),o.transceivers.forEach((function(e,t){o._gather(e.mid,t)}));else if("answer"===e.type){t=i.splitSections(o._remoteDescription.sdp),r=t.shift();var a=i.matchPrefix(r,"a=ice-lite").length>0;t.forEach((function(e,t){var s=o.transceivers[t],c=s.iceGatherer,d=s.iceTransport,l=s.dtlsTransport,h=s.localCapabilities,u=s.remoteCapabilities;if(!(i.isRejected(e)&&0===i.matchPrefix(e,"a=bundle-only").length||s.rejected)){var p=i.getIceParameters(e,r),g=i.getDtlsParameters(e,r);a&&(g.role="server"),o.usingBundle&&0!==t||(o._gather(s.mid,t),"new"===d.state&&d.start(c,p,a?"controlling":"controlled"),"new"===l.state&&l.start(g));var f=n(h,u);o._transceive(s,f.codecs.length>0,!1)}}))}return o._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?o._updateSignalingState("have-local-offer"):o._updateSignalingState("stable"),Promise.resolve()},l.prototype.setRemoteDescription=function(o){var l=this;if(-1===["offer","answer"].indexOf(o.type))return Promise.reject(c("TypeError",'Unsupported type "'+o.type+'"'));if(!s("setRemoteDescription",o.type,l.signalingState)||l._isClosed)return Promise.reject(c("InvalidStateError","Can not set remote "+o.type+" in state "+l.signalingState));var h={};l.remoteStreams.forEach((function(e){h[e.id]=e}));var u=[],p=i.splitSections(o.sdp),g=p.shift(),f=i.matchPrefix(g,"a=ice-lite").length>0,m=i.matchPrefix(g,"a=group:BUNDLE ").length>0;l.usingBundle=m;var v=i.matchPrefix(g,"a=ice-options:")[0];return l.canTrickleIceCandidates=!!v&&v.substr(14).split(" ").indexOf("trickle")>=0,p.forEach((function(s,c){var d=i.splitLines(s),p=i.getKind(s),v=i.isRejected(s)&&0===i.matchPrefix(s,"a=bundle-only").length,y=d[0].substr(2).split(" ")[2],S=i.getDirection(s,g),b=i.parseMsid(s),C=i.getMid(s)||i.generateIdentifier();if(v||"application"===p&&("DTLS/SCTP"===y||"UDP/DTLS/SCTP"===y))l.transceivers[c]={mid:C,kind:p,protocol:y,rejected:!0};else{var _,T,E,w,L,I,R,M,P;!v&&l.transceivers[c]&&l.transceivers[c].rejected&&(l.transceivers[c]=l._createTransceiver(p,!0));var k,N,D=i.parseRtpParameters(s);v||(k=i.getIceParameters(s,g),(N=i.getDtlsParameters(s,g)).role="client"),R=i.parseRtpEncodingParameters(s);var O=i.parseRtcpParameters(s),x=i.matchPrefix(s,"a=end-of-candidates",g).length>0,z=i.matchPrefix(s,"a=candidate:").map((function(e){return i.parseCandidate(e)})).filter((function(e){return 1===e.component}));if(("offer"===o.type||"answer"===o.type)&&!v&&m&&c>0&&l.transceivers[c]&&(l._disposeIceAndDtlsTransports(c),l.transceivers[c].iceGatherer=l.transceivers[0].iceGatherer,l.transceivers[c].iceTransport=l.transceivers[0].iceTransport,l.transceivers[c].dtlsTransport=l.transceivers[0].dtlsTransport,l.transceivers[c].rtpSender&&l.transceivers[c].rtpSender.setTransport(l.transceivers[0].dtlsTransport),l.transceivers[c].rtpReceiver&&l.transceivers[c].rtpReceiver.setTransport(l.transceivers[0].dtlsTransport)),"offer"!==o.type||v)"answer"!==o.type||v||(T=(_=l.transceivers[c]).iceGatherer,E=_.iceTransport,w=_.dtlsTransport,L=_.rtpReceiver,I=_.sendEncodingParameters,M=_.localCapabilities,l.transceivers[c].recvEncodingParameters=R,l.transceivers[c].remoteCapabilities=D,l.transceivers[c].rtcpParameters=O,z.length&&"new"===E.state&&(!f&&!x||m&&0!==c?z.forEach((function(e){a(_.iceTransport,e)})):E.setRemoteCandidates(z)),m&&0!==c||("new"===E.state&&E.start(T,k,"controlling"),"new"===w.state&&w.start(N)),!n(_.localCapabilities,_.remoteCapabilities).codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&_.sendEncodingParameters[0].rtx&&delete _.sendEncodingParameters[0].rtx,l._transceive(_,"sendrecv"===S||"recvonly"===S,"sendrecv"===S||"sendonly"===S),!L||"sendrecv"!==S&&"sendonly"!==S?delete _.rtpReceiver:(P=L.track,b?(h[b.stream]||(h[b.stream]=new e.MediaStream),r(P,h[b.stream]),u.push([P,L,h[b.stream]])):(h.default||(h.default=new e.MediaStream),r(P,h.default),u.push([P,L,h.default]))));else{(_=l.transceivers[c]||l._createTransceiver(p)).mid=C,_.iceGatherer||(_.iceGatherer=l._createIceGatherer(c,m)),z.length&&"new"===_.iceTransport.state&&(!x||m&&0!==c?z.forEach((function(e){a(_.iceTransport,e)})):_.iceTransport.setRemoteCandidates(z)),M=e.RTCRtpReceiver.getCapabilities(p),t<15019&&(M.codecs=M.codecs.filter((function(e){return"rtx"!==e.name}))),I=_.sendEncodingParameters||[{ssrc:1001*(2*c+2)}];var U,H=!1;"sendrecv"===S||"sendonly"===S?(H=!_.rtpReceiver,L=_.rtpReceiver||new e.RTCRtpReceiver(_.dtlsTransport,p),H&&(P=L.track,b&&"-"===b.stream||(b?(h[b.stream]||(h[b.stream]=new e.MediaStream,Object.defineProperty(h[b.stream],"id",{get:function(){return b.stream}})),Object.defineProperty(P,"id",{get:function(){return b.track}}),U=h[b.stream]):(h.default||(h.default=new e.MediaStream),U=h.default)),U&&(r(P,U),_.associatedRemoteMediaStreams.push(U)),u.push([P,L,U]))):_.rtpReceiver&&_.rtpReceiver.track&&(_.associatedRemoteMediaStreams.forEach((function(t){var r=t.getTracks().find((function(e){return e.id===_.rtpReceiver.track.id}));r&&function(t,r){r.removeTrack(t),r.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}))}(r,t)})),_.associatedRemoteMediaStreams=[]),_.localCapabilities=M,_.remoteCapabilities=D,_.rtpReceiver=L,_.rtcpParameters=O,_.sendEncodingParameters=I,_.recvEncodingParameters=R,l._transceive(l.transceivers[c],!1,H)}}})),void 0===l._dtlsRole&&(l._dtlsRole="offer"===o.type?"active":"passive"),l._remoteDescription={type:o.type,sdp:o.sdp},"offer"===o.type?l._updateSignalingState("have-remote-offer"):l._updateSignalingState("stable"),Object.keys(h).forEach((function(t){var r=h[t];if(r.getTracks().length){if(-1===l.remoteStreams.indexOf(r)){l.remoteStreams.push(r);var i=new Event("addstream");i.stream=r,e.setTimeout((function(){l._dispatchEvent("addstream",i)}))}u.forEach((function(e){var t=e[0],i=e[1];r.id===e[2].id&&d(l,t,i,[r])}))}})),u.forEach((function(e){e[2]||d(l,e[0],e[1],[])})),e.setTimeout((function(){l&&l.transceivers&&l.transceivers.forEach((function(e){e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))}))}),4e3),Promise.resolve()},l.prototype.close=function(){this.transceivers.forEach((function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()})),this._isClosed=!0,this._updateSignalingState("closed")},l.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)},l.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,e.setTimeout((function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}}),0))},l.prototype._updateIceConnectionState=function(){var e,t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&!e.rejected&&t[e.iceTransport.state]++})),e="new",t.failed>0?e="failed":t.checking>0?e="checking":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0?e="connected":t.completed>0&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var r=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",r)}},l.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&e.dtlsTransport&&!e.rejected&&(t[e.iceTransport.state]++,t[e.dtlsTransport.state]++)})),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0&&(e="connected"),e!==this.connectionState){this.connectionState=e;var r=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",r)}},l.prototype.createOffer=function(){var r=this;if(r._isClosed)return Promise.reject(c("InvalidStateError","Can not call createOffer after close"));var n=r.transceivers.filter((function(e){return"audio"===e.kind})).length,s=r.transceivers.filter((function(e){return"video"===e.kind})).length,a=arguments[0];if(a){if(a.mandatory||a.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==a.offerToReceiveAudio&&(n=!0===a.offerToReceiveAudio?1:!1===a.offerToReceiveAudio?0:a.offerToReceiveAudio),void 0!==a.offerToReceiveVideo&&(s=!0===a.offerToReceiveVideo?1:!1===a.offerToReceiveVideo?0:a.offerToReceiveVideo)}for(r.transceivers.forEach((function(e){"audio"===e.kind?--n<0&&(e.wantReceive=!1):"video"===e.kind&&--s<0&&(e.wantReceive=!1)}));n>0||s>0;)n>0&&(r._createTransceiver("audio"),n--),s>0&&(r._createTransceiver("video"),s--);var d=i.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.transceivers.forEach((function(o,n){var s=o.track,a=o.kind,c=o.mid||i.generateIdentifier();o.mid=c,o.iceGatherer||(o.iceGatherer=r._createIceGatherer(n,r.usingBundle));var d=e.RTCRtpSender.getCapabilities(a);t<15019&&(d.codecs=d.codecs.filter((function(e){return"rtx"!==e.name}))),d.codecs.forEach((function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),o.remoteCapabilities&&o.remoteCapabilities.codecs&&o.remoteCapabilities.codecs.forEach((function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)}))})),d.headerExtensions.forEach((function(e){(o.remoteCapabilities&&o.remoteCapabilities.headerExtensions||[]).forEach((function(t){e.uri===t.uri&&(e.id=t.id)}))}));var l=o.sendEncodingParameters||[{ssrc:1001*(2*n+1)}];s&&t>=15019&&"video"===a&&!l[0].rtx&&(l[0].rtx={ssrc:l[0].ssrc+1}),o.wantReceive&&(o.rtpReceiver=new e.RTCRtpReceiver(o.dtlsTransport,a)),o.localCapabilities=d,o.sendEncodingParameters=l})),"max-compat"!==r._config.bundlePolicy&&(d+="a=group:BUNDLE "+r.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),d+="a=ice-options:trickle\r\n",r.transceivers.forEach((function(e,t){d+=o(e,e.localCapabilities,"offer",e.stream,r._dtlsRole),d+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===r.iceGatheringState||0!==t&&r.usingBundle||(e.iceGatherer.getLocalCandidates().forEach((function(e){e.component=1,d+="a="+i.writeCandidate(e)+"\r\n"})),"completed"===e.iceGatherer.state&&(d+="a=end-of-candidates\r\n"))}));var l=new e.RTCSessionDescription({type:"offer",sdp:d});return Promise.resolve(l)},l.prototype.createAnswer=function(){var r=this;if(r._isClosed)return Promise.reject(c("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==r.signalingState&&"have-local-pranswer"!==r.signalingState)return Promise.reject(c("InvalidStateError","Can not call createAnswer in signalingState "+r.signalingState));var s=i.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.usingBundle&&(s+="a=group:BUNDLE "+r.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),s+="a=ice-options:trickle\r\n";var a=i.getMediaSections(r._remoteDescription.sdp).length;r.transceivers.forEach((function(e,i){if(!(i+1>a)){if(e.rejected)return"application"===e.kind?"DTLS/SCTP"===e.protocol?s+="m=application 0 DTLS/SCTP 5000\r\n":s+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?s+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(s+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(s+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");var c;e.stream&&("audio"===e.kind?c=e.stream.getAudioTracks()[0]:"video"===e.kind&&(c=e.stream.getVideoTracks()[0]),c&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1}));var d=n(e.localCapabilities,e.remoteCapabilities);!d.codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,s+=o(e,d,"answer",e.stream,r._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(s+="a=rtcp-rsize\r\n")}}));var d=new e.RTCSessionDescription({type:"answer",sdp:s});return Promise.resolve(d)},l.prototype.addIceCandidate=function(e){var t,r=this;return e&&void 0===e.sdpMLineIndex&&!e.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise((function(o,n){if(!r._remoteDescription)return n(c("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var s=e.sdpMLineIndex;if(e.sdpMid)for(var d=0;d<r.transceivers.length;d++)if(r.transceivers[d].mid===e.sdpMid){s=d;break}var l=r.transceivers[s];if(!l)return n(c("OperationError","Can not add ICE candidate"));if(l.rejected)return o();var h=Object.keys(e.candidate).length>0?i.parseCandidate(e.candidate):{};if("tcp"===h.protocol&&(0===h.port||9===h.port))return o();if(h.component&&1!==h.component)return o();if((0===s||s>0&&l.iceTransport!==r.transceivers[0].iceTransport)&&!a(l.iceTransport,h))return n(c("OperationError","Can not add ICE candidate"));var u=e.candidate.trim();0===u.indexOf("a=")&&(u=u.substr(2)),(t=i.getMediaSections(r._remoteDescription.sdp))[s]+="a="+(h.type?u:"end-of-candidates")+"\r\n",r._remoteDescription.sdp=i.getDescription(r._remoteDescription.sdp)+t.join("")}else for(var p=0;p<r.transceivers.length&&(r.transceivers[p].rejected||(r.transceivers[p].iceTransport.addRemoteCandidate({}),(t=i.getMediaSections(r._remoteDescription.sdp))[p]+="a=end-of-candidates\r\n",r._remoteDescription.sdp=i.getDescription(r._remoteDescription.sdp)+t.join(""),!r.usingBundle));p++);o()}))},l.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var r=null;if(this.transceivers.forEach((function(e){e.rtpSender&&e.rtpSender.track===t?r=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(r=e.rtpReceiver)})),!r)throw c("InvalidAccessError","Invalid selector.");return r.getStats()}var i=[];return this.transceivers.forEach((function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach((function(t){e[t]&&i.push(e[t].getStats())}))})),Promise.all(i).then((function(e){var t=new Map;return e.forEach((function(e){e.forEach((function(e){t.set(e.id,e)}))})),t}))},["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach((function(t){var r=e[t];if(r&&r.prototype&&r.prototype.getStats){var i=r.prototype.getStats;r.prototype.getStats=function(){return i.apply(this).then((function(e){var t=new Map;return Object.keys(e).forEach((function(r){var i;e[r].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(i=e[r]).type]||i.type,t.set(r,e[r])})),t}))}}}));var h=["createOffer","createAnswer"];return h.forEach((function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return"function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then((function(t){"function"==typeof e[0]&&e[0].apply(null,[t])}),(function(t){"function"==typeof e[1]&&e[1].apply(null,[t])})):t.apply(this,arguments)}})),(h=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach((function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)}),(function(t){"function"==typeof e[2]&&e[2].apply(null,[t])})):t.apply(this,arguments)}})),["getStats"].forEach((function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)})):t.apply(this,arguments)}})),l}},{sdp:17}],17:[function(e,t,r){"use strict";var i={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};i.localCName=i.generateIdentifier(),i.splitLines=function(e){return e.trim().split("\n").map((function(e){return e.trim()}))},i.splitSections=function(e){return e.split("\nm=").map((function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"}))},i.getDescription=function(e){var t=i.splitSections(e);return t&&t[0]},i.getMediaSections=function(e){var t=i.splitSections(e);return t.shift(),t},i.matchPrefix=function(e,t){return i.splitLines(e).filter((function(e){return 0===e.indexOf(t)}))},i.parseCandidate=function(e){for(var t,r={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},i=8;i<t.length;i+=2)switch(t[i]){case"raddr":r.relatedAddress=t[i+1];break;case"rport":r.relatedPort=parseInt(t[i+1],10);break;case"tcptype":r.tcpType=t[i+1];break;case"ufrag":r.ufrag=t[i+1],r.usernameFragment=t[i+1];break;default:r[t[i]]=t[i+1]}return r},i.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var r=e.type;return t.push("typ"),t.push(r),"host"!==r&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},i.parseIceOptions=function(e){return e.substr(14).split(" ")},i.parseRtpMap=function(e){var t=e.substr(9).split(" "),r={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),r.name=t[0],r.clockRate=parseInt(t[1],10),r.channels=3===t.length?parseInt(t[2],10):1,r.numChannels=r.channels,r},i.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var r=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==r?"/"+r:"")+"\r\n"},i.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},i.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},i.parseFmtp=function(e){for(var t,r={},i=e.substr(e.indexOf(" ")+1).split(";"),o=0;o<i.length;o++)r[(t=i[o].trim().split("="))[0].trim()]=t[1];return r},i.writeFmtp=function(e){var t="",r=e.payloadType;if(void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var i=[];Object.keys(e.parameters).forEach((function(t){e.parameters[t]?i.push(t+"="+e.parameters[t]):i.push(t)})),t+="a=fmtp:"+r+" "+i.join(";")+"\r\n"}return t},i.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},i.writeRtcpFb=function(e){var t="",r=e.payloadType;return void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((function(e){t+="a=rtcp-fb:"+r+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},i.parseSsrcMedia=function(e){var t=e.indexOf(" "),r={ssrc:parseInt(e.substr(7,t-7),10)},i=e.indexOf(":",t);return i>-1?(r.attribute=e.substr(t+1,i-t-1),r.value=e.substr(i+1)):r.attribute=e.substr(t+1),r},i.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((function(e){return parseInt(e,10)}))}},i.getMid=function(e){var t=i.matchPrefix(e,"a=mid:")[0];if(t)return t.substr(6)},i.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},i.getDtlsParameters=function(e,t){return{role:"auto",fingerprints:i.matchPrefix(e+t,"a=fingerprint:").map(i.parseFingerprint)}},i.writeDtlsParameters=function(e,t){var r="a=setup:"+t+"\r\n";return e.fingerprints.forEach((function(e){r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),r},i.getIceParameters=function(e,t){var r=i.splitLines(e);return{usernameFragment:(r=r.concat(i.splitLines(t))).filter((function(e){return 0===e.indexOf("a=ice-ufrag:")}))[0].substr(12),password:r.filter((function(e){return 0===e.indexOf("a=ice-pwd:")}))[0].substr(10)}},i.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},i.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=i.splitLines(e)[0].split(" "),o=3;o<r.length;o++){var n=r[o],s=i.matchPrefix(e,"a=rtpmap:"+n+" ")[0];if(s){var a=i.parseRtpMap(s),c=i.matchPrefix(e,"a=fmtp:"+n+" ");switch(a.parameters=c.length?i.parseFmtp(c[0]):{},a.rtcpFeedback=i.matchPrefix(e,"a=rtcp-fb:"+n+" ").map(i.parseRtcpFb),t.codecs.push(a),a.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(a.name.toUpperCase())}}}return i.matchPrefix(e,"a=extmap:").forEach((function(e){t.headerExtensions.push(i.parseExtmap(e))})),t},i.writeRtpDescription=function(e,t){var r="";r+="m="+e+" ",r+=t.codecs.length>0?"9":"0",r+=" UDP/TLS/RTP/SAVPF ",r+=t.codecs.map((function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType})).join(" ")+"\r\n",r+="c=IN IP4 0.0.0.0\r\n",r+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach((function(e){r+=i.writeRtpMap(e),r+=i.writeFmtp(e),r+=i.writeRtcpFb(e)}));var o=0;return t.codecs.forEach((function(e){e.maxptime>o&&(o=e.maxptime)})),o>0&&(r+="a=maxptime:"+o+"\r\n"),r+="a=rtcp-mux\r\n",t.headerExtensions&&t.headerExtensions.forEach((function(e){r+=i.writeExtmap(e)})),r},i.parseRtpEncodingParameters=function(e){var t,r=[],o=i.parseRtpParameters(e),n=-1!==o.fecMechanisms.indexOf("RED"),s=-1!==o.fecMechanisms.indexOf("ULPFEC"),a=i.matchPrefix(e,"a=ssrc:").map((function(e){return i.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute})),c=a.length>0&&a[0].ssrc,d=i.matchPrefix(e,"a=ssrc-group:FID").map((function(e){return e.substr(17).split(" ").map((function(e){return parseInt(e,10)}))}));d.length>0&&d[0].length>1&&d[0][0]===c&&(t=d[0][1]),o.codecs.forEach((function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var i={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10)};c&&t&&(i.rtx={ssrc:t}),r.push(i),n&&((i=JSON.parse(JSON.stringify(i))).fec={ssrc:c,mechanism:s?"red+ulpfec":"red"},r.push(i))}})),0===r.length&&c&&r.push({ssrc:c});var l=i.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substr(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substr(5),10)*.95-16e3:void 0,r.forEach((function(e){e.maxBitrate=l}))),r},i.parseRtcpParameters=function(e){var t={},r=i.matchPrefix(e,"a=ssrc:").map((function(e){return i.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute}))[0];r&&(t.cname=r.value,t.ssrc=r.ssrc);var o=i.matchPrefix(e,"a=rtcp-rsize");t.reducedSize=o.length>0,t.compound=0===o.length;var n=i.matchPrefix(e,"a=rtcp-mux");return t.mux=n.length>0,t},i.parseMsid=function(e){var t,r=i.matchPrefix(e,"a=msid:");if(1===r.length)return{stream:(t=r[0].substr(7).split(" "))[0],track:t[1]};var o=i.matchPrefix(e,"a=ssrc:").map((function(e){return i.parseSsrcMedia(e)})).filter((function(e){return"msid"===e.attribute}));return o.length>0?{stream:(t=o[0].value.split(" "))[0],track:t[1]}:void 0},i.generateSessionId=function(){return Math.random().toString().substr(2,21)},i.writeSessionBoilerplate=function(e,t,r){var o=void 0!==t?t:2;return"v=0\r\no="+(r||"thisisadapterortc")+" "+(e||i.generateSessionId())+" "+o+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},i.writeMediaSection=function(e,t,r,o){var n=i.writeRtpDescription(e.kind,t);if(n+=i.writeIceParameters(e.iceGatherer.getLocalParameters()),n+=i.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":"active"),n+="a=mid:"+e.mid+"\r\n",e.direction?n+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?n+="a=sendrecv\r\n":e.rtpSender?n+="a=sendonly\r\n":e.rtpReceiver?n+="a=recvonly\r\n":n+="a=inactive\r\n",e.rtpSender){var s="msid:"+o.id+" "+e.rtpSender.track.id+"\r\n";n+="a="+s,n+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+s,e.sendEncodingParameters[0].rtx&&(n+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+s,n+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return n+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+i.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(n+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+i.localCName+"\r\n"),n},i.getDirection=function(e,t){for(var r=i.splitLines(e),o=0;o<r.length;o++)switch(r[o]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[o].substr(2)}return t?i.getDirection(t):"sendrecv"},i.getKind=function(e){return i.splitLines(e)[0].split(" ")[0].substr(2)},i.isRejected=function(e){return"0"===e.split(" ",2)[1]},i.parseMLine=function(e){var t=i.splitLines(e)[0].substr(2).split(" ");return{kind:t[0],port:parseInt(t[1],10),protocol:t[2],fmt:t.slice(3).join(" ")}},i.parseOLine=function(e){var t=i.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:t[0],sessionId:t[1],sessionVersion:parseInt(t[2],10),netType:t[3],addressType:t[4],address:t[5]}},i.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var t=i.splitLines(e),r=0;r<t.length;r++)if(t[r].length<2||"="!==t[r].charAt(1))return!1;return!0},"object"==typeof t&&(t.exports=i)},{}]},{},[1])(1)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e){this.delayTime=.1,this.fadeTime=.05,this.startTime=.1,this.previousPitch=-1,this.context=e,this.input=e.createGain(),this.output=e.createGain(),this.mod1=e.createBufferSource(),this.mod2=e.createBufferSource(),this.mod3=e.createBufferSource(),this.mod4=e.createBufferSource(),this.shiftDownBuffer=this.createDelayTimeBuffer(e,this.startTime,this.fadeTime,!1),this.shiftUpBuffer=this.createDelayTimeBuffer(e,this.startTime,this.fadeTime,!0),this.mod1.buffer=this.shiftDownBuffer,this.mod2.buffer=this.shiftDownBuffer,this.mod3.buffer=this.shiftUpBuffer,this.mod4.buffer=this.shiftUpBuffer,this.mod1.loop=!0,this.mod2.loop=!0,this.mod3.loop=!0,this.mod4.loop=!0,this.mod1Gain=e.createGain(),this.mod2Gain=e.createGain(),this.mod3Gain=e.createGain(),this.mod4Gain=e.createGain(),this.mod3Gain.gain.value=0,this.mod4Gain.gain.value=0,this.mod1.connect(this.mod1Gain),this.mod2.connect(this.mod2Gain),this.mod3.connect(this.mod3Gain),this.mod4.connect(this.mod4Gain),this.modGain1=e.createGain(),this.modGain2=e.createGain(),this.delay1=e.createDelay(),this.delay2=e.createDelay(),this.mod1Gain.connect(this.modGain1),this.mod2Gain.connect(this.modGain2),this.mod3Gain.connect(this.modGain1),this.mod4Gain.connect(this.modGain2),this.modGain1.connect(this.delay1.delayTime),this.modGain2.connect(this.delay2.delayTime),this.fade1=e.createBufferSource(),this.fade2=e.createBufferSource(),this.fadeBuffer=this.createFadeBuffer(e,this.startTime,this.fadeTime),this.fade1.buffer=this.fadeBuffer,this.fade2.buffer=this.fadeBuffer,this.fade1.loop=!0,this.fade2.loop=!0,this.mix1=e.createGain(),this.mix2=e.createGain(),this.mix1.gain.value=0,this.mix2.gain.value=0,this.fade1.connect(this.mix1.gain),this.fade2.connect(this.mix2.gain),this.input.connect(this.delay1),this.input.connect(this.delay2),this.delay1.connect(this.mix1),this.delay2.connect(this.mix2),this.mix1.connect(this.output),this.mix2.connect(this.output);var t=e.currentTime+.05,r=t+this.startTime-this.fadeTime;this.mod1.start(t),this.mod2.start(r),this.mod3.start(t),this.mod4.start(r),this.fade1.start(t),this.fade2.start(r),this.setDelay(this.delayTime)}return e.prototype.createFadeBuffer=function(e,t,r){for(var i=t*e.sampleRate,o=i+(t-2*r)*e.sampleRate,n=e.createBuffer(1,o,e.sampleRate),s=n.getChannelData(0),a=r*e.sampleRate,c=i-a,d=0;d<i;++d)s[d]=d<a?Math.sqrt(d/a):d>=c?Math.sqrt(1-(d-c)/a):1;for(d=i;d<length;++d)s[d]=0;return n},e.prototype.createDelayTimeBuffer=function(e,t,r,i){for(var o=t*e.sampleRate,n=o+(t-2*r)*e.sampleRate,s=e.createBuffer(1,n,e.sampleRate),a=s.getChannelData(0),c=0;c<o;++c)a[c]=i?(o-c)/n:c/o;for(c=o;c<n;++c)a[c]=0;return s},e.prototype.setDelay=function(e){this.modGain1.gain.setTargetAtTime(.5*e,0,.01),this.modGain2.gain.setTargetAtTime(.5*e,0,.01)},e.prototype.setPitchOffset=function(e){e>0?(this.mod1Gain.gain.value=0,this.mod2Gain.gain.value=0,this.mod3Gain.gain.value=1,this.mod4Gain.gain.value=1):(this.mod1Gain.gain.value=1,this.mod2Gain.gain.value=1,this.mod3Gain.gain.value=0,this.mod4Gain.gain.value=0),this.setDelay(this.delayTime*Math.abs(e)),this.previousPitch=e},e}();t.pitchUtil=i},function(e,t,r){"use strict";var i=this&&this.__assign||Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e};Object.defineProperty(t,"__esModule",{value:!0});var o=r(0),n=r(2),s=function(){function e(e,t){this.sendDataMap={},this.sendDataList=new o.LinkedList,this.sendDataCheckOnceCount=100,this.signalSeq=0,this.pushCallback={},this.sessionInfos={},this.tryHeartbeatCount=0,this.heartbeatInterval=1e4,this.sendDataTimeout=5e3,this.sendDataDropTimeout=1e4,this.tryConnectCount=1,this.tryConnectTimer=null,this.tryConnectInterval=3e3,this.state=o.ENUM_CONNECT_STATE.disconnect,this.tokenType=0,this.browser=this.getBrowserAndVersion(),this.platform=navigator.platform,this.negoInterval=25e3,this.negoTryCount=1,this.negoTryMaxCount=2,this.logger=e,this.stateCenter=t}return e.prototype.getBrowserAndVersion=function(){var e,t=navigator.userAgent,r=t.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*([\d\.]+)/i)||[];return/trident/i.test(r[1])?{name:"IE",version:(e=/\brv[ :]+([\d\.]+)/g.exec(t)||[])[1]||""}:"Chrome"===r[1]&&null!=(e=t.match(/\bOPR|Edge\/([\d\.]+)/))?{name:"Opera",version:e[1]}:(r=r[2]?[r[1],r[2]]:[navigator.appName,navigator.appVersion,"-?"],null!=(e=t.match(/version\/([\d+\.]+)/i))&&r.splice(1,1,e[1]),{name:r[0],version:r[1]})},e.prototype.setSessionInfo=function(e,t){this.logger.debug("zs.ssi.0 call"),this.appid=e+"",this.userid=t},e.prototype.onDisconnect=function(e){},e.prototype.onUpdateHeartBeartInterval=function(e){},e.prototype.resetConnectTimer=function(){this.logger.info("zs.rct.0 call"),clearTimeout(this.tryConnectTimer),this.tryConnectTimer=null,this.tryConnectCount=0},e.prototype.bindWebSocketHandle=function(){var e=this;this.tryHeartbeatCount=0,this.websocket.onmessage=function(t){var r=JSON.parse(t.data);e.logger.info("zs.bsh.0 signmsg= ",r.header.cmd),e.logger.info("zs.bsh.0 signmsg= "+JSON.stringify(r)),r.header.appid==e.appid&&r.header.user_id===e.userid?e.handleServerPush(r):e.logger.warn("zs.bsh.0 check header failed")},this.websocket.onclose=function(t){e.logger.info("zs.bsh.0 signal close msg = "+JSON.stringify(t.code)),e.state!=o.ENUM_CONNECT_STATE.disconnect&&(e.resetConnectTimer(),e.startConnectTimer(),e.resetCheckMessage())},this.websocket.onerror=function(t){e.logger.error("zs.bsh.0 msg = "+JSON.stringify(t))}},e.prototype.resetCheckMessage=function(){this.logger.debug("zs.rcm.0 call");for(var e=this.sendDataList.getFirst();null!=e;)this.sendDataList.remove(e),e._data.error&&e._data.error(o.SEND_MSG_RESET,e._data.seq),e=this.sendDataList.getFirst();this.sendDataMap={}},e.prototype.handleServerPush=function(e){switch(e.header.cmd){case"LoginRsp":this.handleRespondData("LoginReq",e);break;case"CreateSessionRsp":this.handleRespondData("CreateSessionReq",e),0===e.body.result&&this.addSession(e.header.session_id,e.body.session_token);break;case"MediaDescRsp":this.handleRespondData("MediaDescReq",e);break;case"CandidateInfoRsp":this.handleRespondData("CandidateInfoReq",e);break;case"CloseSessionRsp":this.handleRespondData("CloseSessionReq",e),this.removeSession(e.header.session_id);break;case"ClientHBRsp":this.handleRespondData("ClientHBReq",e);break;case"MediaDescPush":case"CandidateInfoPush":this.handlePushData(e);break;case"CloseSessionPush":this.handlePushData(e),this.removeSession(e.header.session_id);break;case"QualityReportRsp":this.handleRespondData("QualityReportReq",e);break;case"SessionResetPush":this.handlePushResetSessionData(e);break;case"StreamStatusNotifyPush":case"PublishEventPush":case"PlayEventPush":this.handlePushData(e)}},e.prototype.disconnectCallback=function(){this.connectCallback&&(this.connectCallback(-1,this.server,void 0),this.connectCallback=null);var e=this.server;this.disconnectServer(),this.onDisconnect(e)},e.prototype.updateToken=function(){var e=this;this.logger.info("zs.ut.0 call");var t={token:this.token,tokenType:this.tokenType,roomid:this.stateCenter.roomid,anchorname:this.stateCenter.anchor_info.anchor_id,sdkversion:o.PROTO_VERSION,osinfo:navigator.appVersion};if(0!=Object.keys(this.sessionInfos).length){var r=[];for(var i in this.sessionInfos){var s=parseInt(i);r.push({session_id:s,session_token:this.sessionInfos[s].token})}t.sessions=r}this.sendMessageWithCallback("LoginReq",n.getSeq(),0,t,(function(t,r,i){if(0==i.result){e.token=i.token,e.tokenType=i.tokenType;var o={report:i.report,report_interval:i.report_interval_ms};i.negoInterval&&(e.negoInterval=i.negoInterval),i.negoTryCount&&(e.negoTryCount=i.negoTryCount),i.negoTryMaxCount&&(e.negoTryMaxCount=i.negoTryMaxCount),null!=e.connectCallback&&(e.connectCallback(0,e.server,o),e.connectCallback=null)}else{var n={error:i.strError};null!=e.connectCallback&&(e.connectCallback(i.result,e.server,n),e.connectCallback=null)}}),(function(t,r){null!=e.connectCallback&&(e.connectCallback(-1,e.server,void 0),e.connectCallback=null)}))},e.prototype.sendMessageWithCallback=function(e,t,r,i,n,s){if(this.logger.debug("zs.smwc.0 call "+e),!this.websocket||1!==this.websocket.readyState)return this.logger.error("zs.smwc.0 connect not establish"),void(s&&s(o.SEND_MSG_TIMEOUT,t));var a={header:this.getHeader(e,t,r),body:i};null==n&&(n=null),null==s&&(s=null);var c={seq:t,deleted:!1,cmd:e,time:Date.parse(new Date+""),success:n,error:s},d=this.sendDataList.push(c);this.sendDataMap[c.seq]=d;var l=JSON.stringify(a);this.websocket.send(l),this.logger.debug("zs.smwc.0 success")},e.prototype.getHeader=function(e,t,r){return this.globalHeader={version:"1.0.1",cmd:e,appid:this.appid+"",seq:t,user_id:this.userid,session_id:r},this.globalHeader},e.prototype.connectServer=function(e,t,r){var i=this;if(this.token=e,this.server=t,this.state=o.ENUM_CONNECT_STATE.connecting,this.connectCallback=r,this.websocket&&1===this.websocket.readyState)this.resetConnectTimer(),this.state=o.ENUM_CONNECT_STATE.connected;else{this.logger.info("zs.cs.0 need new websocket");try{this.websocket&&(this.logger.warn("zs.cs.0 close error websocket"),this.websocket.onclose=null,this.websocket.onerror=null,this.websocket.close(),this.websocket=null),this.websocket=new WebSocket(this.server),this.websocket.onopen=function(){i.resetConnectTimer(),i.logger.info("zs.cs.0 websocket open call"),i.bindWebSocketHandle(),i.updateToken(),i.state=o.ENUM_CONNECT_STATE.connected},this.websocket.onclose=function(e){i.logger.info("zs.cs.0 signal websocket close code "+JSON.stringify(e.code))},this.websocket.onerror=function(e){i.logger.info("zs.cs.0 websocket onerror call  "+JSON.stringify(e))}}catch(e){this.logger.error("zs.cs.0 websocket error "+e)}}this.tryConnectTimer=setTimeout((function(){i.startConnectTimer(r)}),this.tryConnectInterval)},e.prototype.startConnectTimer=function(e){if(this.logger.info("zs.sct.0 call"),this.tryConnectCount>=o.MAX_TRY_CONNECT_COUNT)return this.logger.info("zs.sct.0 beyond "+this.server+" max limit"),void this.disconnectCallback();this.websocket&&1===this.websocket.readyState?this.resetConnectTimer():(this.tryConnectCount+=1,this.connectServer(this.token,this.server,e))},e.prototype.disconnectServer=function(){this.logger.debug("zs.ds.0 call"),this.connectCallback=null,this.resetCheckMessage(),this.resetConnectTimer(),this.websocket&&(this.websocket.onclose=null,this.websocket.onerror=null,this.websocket.close(),this.websocket=null),this.token="",this.sessionInfos={},this.tokenType=0,this.tryHeartbeatCount=0,this.tryConnectCount=0,this.state=o.ENUM_CONNECT_STATE.disconnect},e.prototype.isServerConnected=function(){return!(!this.websocket||1!==this.websocket.readyState)},e.prototype.createSession=function(e,t,r,i,n,s,a){void 0===n&&(n=""),this.logger.debug("zs.cs.1 call: ",i);var c="";o.PROTO_VERSION.split(".").forEach((function(e,t){return 1==e.length&&1==t?c+="0"+e:c+=e}));var d={type:t,stream_id:i,platform:this.platform,browser:this.browser.name,version:this.browser.version,app_id:this.appid,negotiate_mode:r,strAuthParam:n,sdk_version:1*c};this.sendMessageWithCallback("CreateSessionReq",e,0,d,s,a)},e.prototype.removeSession=function(e){this.logger.info("zs.rs.0 call"),this.sessionInfos[e]&&delete this.sessionInfos[e]},e.prototype.sendCloseSession=function(e,t,r,i,o){this.logger.debug("zs.scs.0 call: ",t);var n={reason:r};this.removeSession(t),this.sendMessageWithCallback("CloseSessionReq",e,t,n,i,o)},e.prototype.sendMessage=function(e,t,r,i){if(this.logger.debug("zs.sm.0 call "+e),this.websocket&&1===this.websocket.readyState){var o={header:this.getHeader(e,t,r),body:i},n=JSON.stringify(o);this.websocket.send(n),this.logger.debug("zs.sm.0 success")}else this.logger.error("zs.sm.0 connect not establish")},e.prototype.handleRespondData=function(e,t){this.logger.debug("zs.hrd.0 call");var r=this.sendDataMap[t.header.seq];if(null!=r){var i=r._data;i.cmd!==e?this.logger.error("sz.hrd.0 command is not match"):i.success&&i.success(t.header.seq,t.header.session_id,t.body),delete this.sendDataMap[t.header.seq],this.sendDataList.remove(r)}else{if("CloseSessionRsp"==t.header.cmd)return;this.logger.error("zs.hrd.0 cannot find data "+e)}},e.prototype.addSession=function(e,t){this.logger.info("zs.as.0 call"),this.sessionInfos[e]={token:t}},e.prototype.handlePushData=function(e){this.logger.debug("zs.hpd.0 call "+e.header.cmd+" session "+e.header.session_id);var t=this.pushCallback[e.header.cmd+e.header.session_id];t?t.callback&&t.callback(e.header.seq,e.header.session_id,e.body):this.logger.info("zs.hpd.0 no callbackData "+e.header.cmd+" session: "+e.header.session_id)},e.prototype.handlePushResetSessionData=function(e){this.logger.debug("zs.hprsd.0 call ");var t=[];if(0==e.body.cResetType)t=Object.keys(this.sessionInfos);else if(1==e.body.cResetType)for(var r=0;r<e.body.session_ids.length;r++)t.push(e.body.session_ids[r]);if(this.sendResetSessionAck(e.header.seq,0,0),0!=t.length)for(var i=0;i<t.length;i++){var o=this.pushCallback[e.header.cmd+t[i]];null==o?this.logger.info("zs.hprsd.0 no callbackData "+t[i]):o.callback&&o.callback(e.header.seq,t[i],e.body)}else this.logger.info("zs.hprsd.0 no session to callback")},e.prototype.sendMediaDesc=function(e,t,r,i,o,n){this.logger.debug("zs.smd.0 call: ",t);var s={type:r,sdp:i.sdp};null!=i.width&&(s.width=i.width),null!=i.height&&(s.height=i.height),null!=i.frameRate&&(s.framerate=i.frameRate),null!=i.video_min_kpbs&&(s.video_min_kpbs=i.video_min_kpbs),null!=i.video_max_kpbs&&(s.video_max_kpbs=i.video_max_kpbs),null!=i.audio_kpbs&&(s.audio_kpbs=i.audio_kpbs),null!=i.keyframe_intv&&(s.keyframe_intv=i.keyframe_intv),this.sendMessageWithCallback("MediaDescReq",e,t,s,o,n)},e.prototype.sendCandidateInfo=function(e,t,r,i,o){this.logger.debug("zs.sci.0 call: ",t);for(var n=[],s=0;s<r.length;s++){var a={candidate:r[s].candidate,sdpMid:r[s].sdpMid,sdpMLineIndex:r[s].sdpMLineIndex};n.push(a)}var c={infos:n};this.sendMessageWithCallback("CandidateInfoReq",e,t,c,i,o)},e.prototype.sendMediaDescAck=function(e,t,r){this.logger.debug("zs.smda.0 call: ",t);var i={result:r};this.sendMessage("MediaDescAck",e,t,i)},e.prototype.sendCandidateInfoAck=function(e,t,r){this.logger.debug("zs.scia.0 call: ",t);var i={result:r};this.sendMessage("CandidateInfoAck",e,t,i)},e.prototype.sendCloseSessionAck=function(e,t,r){this.logger.debug("zs.scsa.0 call: ",t);var i={result:r};this.sendMessage("CloseSessionAck",e,t,i)},e.prototype.sendResetSessionAck=function(e,t,r){this.logger.debug("zs.ssra.0 call: ",t);var i={result:r};this.sendMessage("SessionResetAck",e,t,i)},e.prototype.registerPushCallback=function(e,t,r){r&&"function"==typeof r&&(this.logger.debug("zs.rpc.0 setcallback"),this.pushCallback[e+t]={callback:r})},e.prototype.unregisterPushCallback=function(e,t){delete this.pushCallback[e+t]},e.prototype.checkMessageTimeout=function(){for(var e=this.sendDataList.getFirst(),t=Date.parse(new Date+""),r=0,i=0,n=0;!(null==e||e._data.time+this.sendDataTimeout>t||(delete this.sendDataMap[e._data.seq],this.sendDataList.remove(e),++i,null==e._data.error||this.sendDataDropTimeout>0&&e._data.time+this.sendDataDropTimeout<t?++n:e._data.error&&e._data.error(o.SEND_MSG_TIMEOUT,e._data.seq),++r>=this.sendDataCheckOnceCount));)e=this.sendDataList.getFirst();0==i&&0==n||this.logger.debug("zs.cmt.0 call success, state: timeout=",i," drop=",n)},e.prototype.sendHeartbeat=function(){var e=this;if(this.logger.debug("zs.shb.0 call tryHeartbeatCount:"+this.tryHeartbeatCount),0!=Object.keys(this.sessionInfos).length){if(++this.tryHeartbeatCount>o.MAX_TRY_HEARTBEAT_COUNT)return this.logger.error("zs.shb.0 heartbeat try limit"),void this.disconnectCallback();var t=[];for(var r in this.sessionInfos)t.push(parseInt(r));var i={session_ids:t};this.sendMessageWithCallback("ClientHBReq",n.getSeq(),0,i,(function(t,r,i){e.heartbeatInterval!=i.hb_interval&&(e.heartbeatInterval=i.hb_interval,e.onUpdateHeartBeartInterval(i.hb_interval)),e.tryHeartbeatCount=0}),(function(e,t){}))}else this.logger.info("zs.shb.0 no need to heartbeat")},e.prototype.QualityReport=function(e,t,r,o,n){this.logger.debug("zs.qr.0 call");var s={streams:[i({},r,{aid:t})]};this.sendMessageWithCallback("QualityReportReq",e,t,s,o,n)},e.prototype.sendStreamStatus=function(e,t,r,i){this.logger.debug("zs.sss.0 call");var o={mic_status:i,camera_status:r};this.logger.info("zs.sss.0 stream status "+JSON.stringify(o)),this.sendMessage("StreamStatusNotify",e,t,o)},e.prototype.sendBroadcasterStatus=function(e,t,r){this.logger.debug("zs.sss.0 call");var i={status:r};this.sendMessage("BroadcasterStatusNotify",e,t,i)},e}();t.ZegoSignal=s},function(e,t,r){"use strict";var i=this&&this.__assign||Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e};Object.defineProperty(t,"__esModule",{value:!0});var o=r(0),n=r(2),s=r(4),a=function(){function e(e,t,r,i,s){this.state=o.ENUM_PLAY_STATE.stop,this.candidateInfo=[],this.waitICETimer=null,this.waitingICETimeInterval=5e3,this.waitingOfferTimer=null,this.waitingOfferTimeInterval=5e3,this.waitingServerTimer=null,this.waitingServerTimerInterval=3e3,this.qualityTimer=null,this.playQualityList=[],this.maxQualityListCount=10,this.lastPlayStats={audioPacketsLost:0,videoPacketsLost:0,time:0,audioTime:0,videoTime:0,audioBytesReceived:0,videoBytesReceived:0,framesDecoded:0,framesReceived:0,framesDropped:0,audioBitrate:0},this.reportSeq=n.getSeq(),this.videoSizeCallback=!1,this.qualityUpload=!1,this.qualityUploadInterval=3e4,this.qualityUploadLastTime=0,this.maxRetryCount=3,this.currentRetryCount=0,this.retryState=o.ENUM_RETRY_STATE.didNotStart,this.streamGoogInfo={},this.closeSessionSignal=!1,this.stateNego=o.ENUM_PLAY_STATE_NEGO.stop,this.negoInterval=25e3,this.negoTryCount=1,this.negoTryMaxCount=2,this.broadcasterStatus=o.ENUM_BROADCASTER_STATUS.stop,this.cameraStatus=null,this.micStatus=null,this.playEvent=!1,this.nextSignalTryCount=1,this.waittingConnectedTimer=null,this.waittingConnectedInerval=15e3,this.gotStreamStatus=!1,this.tryingNexitSignal=!1,this.ac=null,this.soundLevel=0,this.mic=null,this.script=null,this.logger=e,this.signal=t,this.dataReport=r,this.qualityTimeInterval=i,this.streamCenter=s,r.newReport(this.reportSeq)}return e.prototype.setAudioDestination=function(e){var t=this;return this.remoteVideo?"undefined"!==this.remoteVideo.sinkId?(this.remoteVideo.setSinkId(e).then((function(){t.logger.info("zp.sad.1 success device: "+e)})).catch((function(e){t.logger.info("zp.sad.1 "+e.name)})),!0):(this.logger.error("zp.sad.1 browser does not suppport"),!1):(this.logger.info("zp.sad.1 no remoteVideo"),!1)},e.prototype.startPlay=function(e,t,r,i){var s=this;this.logger.info("zp.sp.1 called ",e),this.playEvent=!1,this.signal&&this.signal.negoInterval&&(this.negoInterval=this.signal.negoInterval),this.signal&&this.signal.negoTryCount&&(this.negoTryCount=this.signal.negoTryCount),this.signal&&this.signal.negoTryMaxCount&&(this.negoTryMaxCount=this.signal.negoTryMaxCount),e?(this.streamId=e,this.remoteVideo=t,this.audioOutput=r,this.playOption=i||{},i&&i.videoDecodeType&&(this.playOption.videoDecodeType=i.videoDecodeType),this.sessionSeq=n.getSeq(),this.dataReport.eventStart(this.reportSeq,"CreateSession"),this.signal.createSession(this.sessionSeq,1,0,e,i&&i.streamParams,(function(e,t,r){s.dataReport.eventEndWithMsg(s.reportSeq,"CreateSession",{sessionId:r.session_id}),s.logger.info("zp.sp.1 sessionId:"+r.session_id),s.sessionSeq==e?0!==r.result?(s.logger.error("zp.sp.1 create error"),s.playStateUpdateError(n.playErrorList.CREATE_SESSION_ERROR)):(s.sessionId=r.session_id,s.onCreatePlaySessionSuccess(r)):s.logger.error("zp.sp.1 seq is not match.")}),(function(e,t){s.dataReport.eventEndWithMsg(s.reportSeq,"CreateSession",{error:e}),s.playStateUpdateError(n.playErrorList.SEND_SESSION_TIMEOUT)})),this.state=o.ENUM_PLAY_STATE.waitingSessionRsp,this.logger.debug("zp.sp.1 called success"),this.stateNego=o.ENUM_PLAY_STATE_NEGO.start,this.negoTimer=setTimeout((function(){s.stateNego!==o.ENUM_PLAY_STATE_NEGO.iceConnected&&s.negoTryCount<s.negoTryMaxCount?(s.signal.sendCloseSession(n.getSeq(),s.sessionId,1),s.resetPlay(),s.startPlay(e,t,r,i),++s.negoTryCount):s.stateNego!==o.ENUM_PLAY_STATE_NEGO.iceConnected&&s.negoTryCount===s.negoTryMaxCount&&(s.logger.error("zp.sp.1 waiting timeout"),s.playStateUpdateError(n.playErrorList.SERVER_NEGO_TIMEOUT))}),this.negoInterval)):this.logger.warn("zp.sp.1 streamId is null")},e.prototype.onCreatePlaySessionSuccess=function(e){var t=this;this.logger.info("zp.ops.1 success");var r=[];e.turn_server&&r.push(e.turn_server),e.stun_server&&r.push(e.stun_server);var i={iceTransportPolicy:"relay",iceServers:[{urls:r,username:e.turn_username,credential:e.turn_auth_key}]};this.logger.info("zp.ops.1 username: "+e.turn_username),this.logger.info("zp.ops.1 credential: "+e.turn_auth_key),this.peerConnection=new RTCPeerConnection(i),this.peerConnection.onicecandidate=function(e){t.onIceCandidate(e)},this.peerConnection.onsignalingstatechange=function(e){t.onConnectionStateChange(e)},this.peerConnection.oniceconnectionstatechange=function(e){t.onIceConnectionStateChange(e)},this.peerConnection.ontrack=function(e){t.onGotRemoteStream(e.streams[0])},this.remoteVideo.oncanplay=function(){t.logger.debug("zp.ops.1 "+t.remoteVideo.videoWidth+" X "+t.remoteVideo.videoHeight),t.videoSizeCallback||(t.logger.debug("zp.ops.1 onresize callback"),t.onVideoSizeChanged(t.streamId,t.remoteVideo.videoWidth,t.remoteVideo.videoHeight),t.videoSizeCallback=!0)};var o={offerToReceiveAudio:1,offerToReceiveVideo:1};this.playOption&&"audio"===this.playOption.playType&&(o.offerToReceiveVideo=0),this.playOption&&"video"===this.playOption.playType&&(o.offerToReceiveAudio=0),this.logger.info("zp.ops.1 createOffer: "+JSON.stringify(o)),this.dataReport.eventStart(this.reportSeq,"CreateOffer"),this.peerConnection.createOffer(o).then((function(e){t.dataReport.eventEnd(t.reportSeq,"CreateOffer"),t.onCreateOfferSuccess(e)}),(function(e){t.dataReport.eventEndWithMsg(t.reportSeq,"CreateOffer",{error:e.toString()}),t.logger.error("zp.ops.0 create offer error "+e.toString()),t.playStateUpdateError(n.playErrorList.CREATE_OFFER_ERROR,!0)})),this.signal.registerPushCallback("MediaDescPush",this.sessionId,(function(e,r,i){t.onRecvMediaDesc(e,r,i)})),this.signal.registerPushCallback("CandidateInfoPush",this.sessionId,(function(e,r,i){t.onRecvCandidateInfo(e,r,i)})),this.signal.registerPushCallback("CloseSessionPush",this.sessionId,(function(e,r,i){t.onRecvCloseSession(e,r,i)})),this.signal.registerPushCallback("SessionResetPush",this.sessionId,(function(e,r,i){t.onRecvResetSession(e,r,i)})),this.signal.registerPushCallback("StreamStatusNotifyPush",this.sessionId,(function(e,r,i){t.gotStreamStatus=!0,t.streamStatus=i,t.remoteStream&&t.onRecvStreamStatus(i)})),this.signal.registerPushCallback("PlayEventPush",this.sessionId,(function(e,r,i){t.onRecvPlayEvent(e,r,i)})),this.logger.debug("zp.ops.1 call success")},e.prototype.onCreateOfferSuccess=function(e){var t=this;this.logger.info("zp.oco.1 localSdp1 "+e.sdp.substr(0,e.sdp.length/2)),this.logger.info("zp.oco.1 localSdp2 "+e.sdp.substr(e.sdp.length/2)),e.sdp=e.sdp.replace(/sendrecv/g,"recvonly"),this.playOption.videoDecodeType&&(e.sdp=s.sdpUtil.getSDPByVideDecodeType(e.sdp,this.playOption.videoDecodeType)),this.dataReport.eventStart(this.reportSeq,"SetLocalDescription"),this.peerConnection.setLocalDescription(e).then((function(){t.dataReport.eventEnd(t.reportSeq,"SetLocalDescription"),t.onSetLocalDescriptionSuccess(e)}),(function(e){t.logger.error("zp.oca.1 set error "+e.toString()),t.dataReport.eventEnd(t.reportSeq,"SetLocalDescription",{error:e.toString()}),t.playStateUpdateError(n.playErrorList.SET_LOCAL_DESC_ERROR,!0)}))},e.prototype.onSetLocalDescriptionSuccess=function(e){var t=this;this.logger.info("zp.osd.1 success");var r={sdp:e.sdp};this.answerSeq=n.getSeq(),this.dataReport.eventStart(this.reportSeq,"SendMediaDesc"),this.signal.sendMediaDesc(this.answerSeq,this.sessionId,0,r,(function(e,r,i){t.logger.info("zp.osd.1 sendMediaDesc resp"),t.answerSeq==e&&t.sessionId==r?(t.logger.info("zp.osd.1 send success stateNego:waiterAnswer"),t.stateNego=o.ENUM_PLAY_STATE_NEGO.waiterAnswer,t.dataReport.eventEnd(t.reportSeq,"SendMediaDesc"),t.waitingOfferTimer=setTimeout((function(){t.state==o.ENUM_PLAY_STATE.waitingOffserRsp&&(t.logger.error("zp.osd.1 waiting timeout"),t.playStateUpdateError(n.playErrorList.SERVER_CANDIDATE_TIMEOUT))}),t.waitingOfferTimeInterval),t.state=o.ENUM_PLAY_STATE.waitingServerAnswer):t.logger.error("zp.osd.1 seq or sessionId is not equal "+t.answerSeq+" "+e,0+t.sessionId+" "+r)}),(function(e,r){t.logger.error("zp.osd.1 failed to send "+e),t.dataReport.eventEndWithMsg(t.reportSeq,"SendMediaDesc",{error:e}),t.playStateUpdateError(n.playErrorList.SEND_MEDIA_DESC_TIMEOUT)})),this.state=o.ENUM_PLAY_STATE.waitingOffserRsp},e.prototype.onRecvMediaDesc=function(e,t,r){var i=this;if(this.logger.info("zp.orm.1 received ",r),this.stateNego=o.ENUM_PLAY_STATE_NEGO.waitingCandidate,this.logger.info("zp.orm.1 received stateNego:waitingCandidate"),this.state===o.ENUM_PLAY_STATE.waitingServerAnswer){null!=this.waitingOfferTimer&&(clearTimeout(this.waitingOfferTimer),this.waitingOfferTimer=null),this.dataReport.addEvent(this.reportSeq,"RecvMediaDesc"),this.signal.sendMediaDescAck(e,this.sessionId,0);var s={type:"answer",sdp:r.sdp,toJSON:function(){}};this.dataReport.eventStart(this.reportSeq,"SetRemoteDescription"),this.logger.info("zp.orm.1 remoteSdp ",s.sdp),this.peerConnection.setRemoteDescription(new RTCSessionDescription(s)).then((function(){i.dataReport.eventEnd(i.reportSeq,"SetRemoteDescription"),i.logger.info("zp.orm.1 set success")}),(function(e){i.logger.error("zp.orm.1 set remote error "+e.toString()),i.dataReport.eventEndWithMsg(i.reportSeq,"SetRemoteDescription",{error:e.toString()}),i.playStateUpdateError(n.playErrorList.SET_REMOTE_DESC_ERROR)})),this.waitICETimer=setTimeout((function(){i.state==o.ENUM_PLAY_STATE.waitingServerICE&&(i.logger.error("zp.orm.1 waiting server timeout"),i.playStateUpdateError(n.playErrorList.SERVER_CANDIDATE_TIMEOUT))}),this.waitingICETimeInterval),this.state=o.ENUM_PLAY_STATE.waitingServerICE,this.logger.debug("zp.orm.1 call success")}else this.logger.error("zp.orm.1 current state "+this.state+" not allowed")},e.prototype.onRecvCandidateInfo=function(e,t,r){var i=this;if(this.logger.info("zp.orci.1 received "),this.state==o.ENUM_PLAY_STATE.waitingServerICE){null!=this.waitICETimer&&(clearTimeout(this.waitICETimer),this.waitICETimer=null),this.dataReport.addEvent(this.reportSeq,"RecvIceCandidate"),this.signal.sendCandidateInfoAck(e,this.sessionId,0),this.sendCandidateInfo(this.candidateInfo),this.candidateInfo=[];for(var s=0;s<r.infos.length;s++){var a={sdpMid:r.infos[s].sdpMid,sdpMLineIndex:r.infos[s].sdpMLineIndex,candidate:r.infos[s].candidate};this.logger.debug("zp.orci.1 candidate "+a.candidate),this.peerConnection.addIceCandidate(new RTCIceCandidate(a)).then((function(){i.logger.debug("zp.orci.1 add success")}),(function(e){i.logger.error("zp.orci.1 add error "+e.toString()),i.playStateUpdateError(n.playErrorList.SERVER_CANDIDATE_ERROR)}))}this.state=o.ENUM_PLAY_STATE.connecting,this.logger.debug("zp.orci.1 call success")}else this.logger.warn("zp.orci.1 current state "+this.state+" not allowed")},e.prototype.onRecvPlayEvent=function(e,t,r){if(this.logger.info("zp.orpe.1 received"),!0===this.playEvent&&0==r.event){this.logger.info("zp.orpe.1 retry: "+this.streamId);var i=this.streamId,o=this.remoteVideo,s=this.audioOutput,a=this.playOption;this.signal.sendCloseSession(n.getSeq(),this.sessionId,1),this.resetPlay(),this.startPlay(i,o,s,a)}else this.playEvent=!0},e.prototype.onIceCandidate=function(e){if(this.logger.info("zp.oic.1 called"),null!=e.candidate)if(this.logger.debug("zp.oic.1 candidate "+e.candidate.candidate),this.state<o.ENUM_PLAY_STATE.connecting||this.state==o.ENUM_PLAY_STATE.stop)this.logger.debug("zp.oic.1 cached"),this.candidateInfo.push({candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex});else{this.logger.debug("zp.oic.1 send");var t={candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex};this.sendCandidateInfo([t])}},e.prototype.onConnectionStateChange=function(e){this.logger.info("zp.oisc.1 called "+e.target.signalingState)},e.prototype.onIceConnectionStateChange=function(e){var t=this;if(this.state!=o.ENUM_PLAY_STATE.stop&&null!=this.peerConnection)if(this.logger.info("zp.oisc.1  stateChanged "+this.peerConnection.iceConnectionState),"connected"===this.peerConnection.iceConnectionState){for(var r in this.dataReport.addEvent(this.reportSeq,"IceConnected"),this.state!=o.ENUM_PLAY_STATE.playing&&this.onPlayStateUpdate(n.ENUM_PLAY_STATE_UPDATE.start,this.streamId),this.state=o.ENUM_PLAY_STATE.playing,this.tryingNexitSignal=!1,this.retryState!=o.ENUM_RETRY_STATE.didNotStart&&(this.retryState=o.ENUM_RETRY_STATE.finished,this.currentRetryCount=0),this.dataReport.eventStart(this.reportSeq,"PlayState"),this.streamCenter.publisherList)if(this.streamCenter.publisherList[r].publisher.state==o.ENUM_PUBLISH_STATE.publishing&&this.broadcasterStatus==o.ENUM_BROADCASTER_STATUS.stop){this.signal&&this.signal.sendBroadcasterStatus(n.getSeq(),this.sessionId,1),this.broadcasterStatus=o.ENUM_BROADCASTER_STATUS.start;break}this.setPlayQualityTimer(),this.stateNego=o.ENUM_PLAY_STATE_NEGO.iceConnected,this.logger.info("zp.oisc.1  stateNego:iceConnected"),this.negoTryCount=1,this.nextSignalTryCount=1,this.waittingConnectedTimer&&clearTimeout(this.waittingConnectedTimer),this.waittingConnectedTimer=null,this.negoTimer&&clearTimeout(this.negoTimer)}else"closed"===this.peerConnection.iceConnectionState?(this.dataReport.addEvent(this.reportSeq,"IceClosed"),this.checkPlayConnectionFailedState(this.peerConnection.iceConnectionState)):"failed"===this.peerConnection.iceConnectionState?(this.dataReport.addEvent(this.reportSeq,"IceFailed"),this.checkPlayConnectionFailedState(this.peerConnection.iceConnectionState)):"disconnected"===this.peerConnection.iceConnectionState&&(this.dataReport.addEvent(this.reportSeq,"IceDisconnected"),this.waittingConnectedTimer=setTimeout((function(){!t.tryingNexitSignal&&t.tryNextSignal(n.publishErrorList.MEDIA_CONNECTION_DISCONNECTED)}),this.waittingConnectedInerval))},e.prototype.checkPlayConnectionFailedState=function(e){var t=null;"failed"==e?t=n.playErrorList.MEDIA_CONNECTION_FAILED:"closed"==e&&(t=n.playErrorList.MEDIA_CONNECTION_CLOSED),null!=t&&(this.state!=o.ENUM_PLAY_STATE.playing&&this.retryState==o.ENUM_PLAY_STATE.didNotStart?(this.logger.info("zp.oics.1  state "+this.state+" retryState "+this.retryState+" connectionState "+e),this.playStateUpdateError(t)):this.shouldRetryPlay()?(this.onPlayStateUpdate(n.ENUM_PLAY_STATE_UPDATE.retry,this.streamId),this.startRetryPlay()):this.playStateUpdateError(t))},e.prototype.shouldRetryPlay=function(){return this.retryState==o.ENUM_RETRY_STATE.didNotStart&&this.state!=o.ENUM_PLAY_STATE.playing?(this.logger.info("zp.srp.1.0 connection didn't success"),!1):this.retryState==o.ENUM_RETRY_STATE.retrying?(this.logger.info("zp.srp.0.0 already retrying"),!1):this.currentRetryCount>this.maxRetryCount?(this.logger.info("zp.srp.1.0 beyond max"),!1):(this.logger.debug("zp.srp.1.0 call success"),!0)},e.prototype.startRetryPlay=function(){this.logger.debug("zp.srp.0 call");var e=this.streamId,t=this.remoteVideo,r=this.audioOutput;this.resetPlay(),this.tryStartPlay(e,t,r)},e.prototype.clearTryPlayTimer=function(){null!=this.waitingServerTimer&&(clearTimeout(this.waitingServerTimer),this.waitingServerTimer=null)},e.prototype.tryStartPlay=function(e,t,r){var i=this;if(this.logger.debug("zp.tsp.1 call"),this.clearTryPlayTimer(),this.streamId=e,this.remoteVideo=t,this.audioOutput=r,this.currentRetryCount>this.maxRetryCount)return this.logger.error("zp.tsp.1 beyond max limit"),void this.playStateUpdateError(n.playErrorList.WEBSOCKET_ERROR);this.retryState=o.ENUM_RETRY_STATE.retrying,this.currentRetryCount+=1,this.signal.isServerConnected()?(this.logger.debug("zp.tsp.1 signal connected"),this.startPlay(e,this.remoteVideo,this.audioOputput,this.playOption)):(this.logger.debug("zp.tsp.1 signal server not connected"),this.waitingServerTimer=setTimeout((function(){i.tryStartPlay(e,i.remoteVideo,i.audioOputput)}),this.waitingServerTimerInterval))},e.prototype.clearPlayQualityTimer=function(){null!=this.qualityTimer&&(clearInterval(this.qualityTimer),this.qualityTimer=null),this.lastPlayStats={audioPacketsLost:null,videoPacketsLost:null,time:null,audioTime:null,videoTime:null,audioBytesReceived:null,videoBytesReceived:null,framesDecoded:null,framesDropped:null,framesReceived:null,audioBitrate:null}},e.prototype.resetPlay=function(){this.logger.info("zp.rp.1 call"),this.streamId=null,this.state=o.ENUM_PLAY_STATE.stop,this.playEvent=!1,null!=this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null),null!=this.waitingOfferTimer&&(clearTimeout(this.waitingOfferTimer),this.waitingOfferTimer=null),null!=this.waitICETimer&&(clearTimeout(this.waitICETimer),this.waitICETimer=null),null!=this.negoTimer&&(clearTimeout(this.negoTimer),this.negoTimer=null),null!=this.waittingConnectedTimer&&(clearTimeout(this.waittingConnectedTimer),this.waittingConnectedTimer=null),this.clearPlayQualityTimer(),this.remoteVideo&&(this.remoteVideo.srcObject=null,this.remoteVideo.oncanplay=null,this.remoteVideo=null),this.audioOputput=null,this.signal&&(this.signal.unregisterPushCallback("MediaDescPush",this.sessionId),this.signal.unregisterPushCallback("CandidateInfoPush",this.sessionId),this.signal.unregisterPushCallback("CloseSessionPush",this.sessionId)),this.sessionSeq=0,this.answerSeq=0,this.videoSizeCallback=!1,this.script&&this.script.disconnect(),this.mic&&this.mic.disconnect(),this.currentRetryCount=0,this.retryState=o.ENUM_RETRY_STATE.didNotStart,this.clearTryPlayTimer()},e.prototype.setPlayQualityTimer=function(){var e=this;if(null==this.qualityTimer){this.logger.debug("zp.spq.1 startTimer"),this.clearPlayQualityTimer();var t=!0;this.peerConnection.getStats((function(){})).catch((function(r){e.logger.info("zp.spq.1 "+e.streamId+" getStats callback not support"),t=!1})),this.qualityTimer=setInterval((function(){e.peerConnectionGetStats(t)}),this.qualityTimeInterval),this.lastPlayStats={audioPacketsLost:0,videoPacketsLost:0,time:0,audioTime:0,videoTime:0,audioBytesReceived:0,videoBytesReceived:0,framesDecoded:0,framesReceived:0,framesDropped:0,audioBitrate:0}}},e.prototype.peerConnectionGetStats=function(e){var t=this;this.peerConnection&&(e&&this.peerConnection.getStats((function(e){t.getOldGoogStats(e)}),(function(e){t.logger.info("zp.spq.1 getOldGoogStats error "+e.toString())})),this.peerConnection.getStats(null).then((function(e){t.getPlayStats(e)}),(function(e){t.logger.info("zp.spq.1 getStats error "+e.toString())})))},e.prototype.getOldGoogStats=function(e){var t=this;e&&e.result().forEach((function(e){var r=["audioOutputLevel","googCpuLimitedResolution","googBandwidthLimitedResolution","googCodecName","googActualEncBitrate","googFrameWidthInput","googFrameHeightInput","googFrameRateInput","codecImplementationName"];if("VideoBwe"===e.type&&e.names().includes("googAvailableSendBandwidth")&&(t.streamGoogInfo.googAvailableSendBandwidth=e.stat("googAvailableReceiveBandwidth")||""),"ssrc"===e.type)for(var i=0;i<r.length;i++){var o=r[i];e.names().includes(o)&&(t.streamGoogInfo[o]=e.stat(o)||"")}}))},e.prototype.getPlayStats=function(e){var t=this;if(null!=e){var r=i({audioFractionLost:null,audioPacketsLost:0,audioPacketsLostRate:0,audioBitrate:0,audioLevel:0,audioSendLevel:0,audioSamplingRate:0,audioCodecType:"opus",audioQuality:null,videoQuality:null,videoPacketsLostRate:0,videoBitrate:0,videoFPS:0,playData:0,nackCount:0,pliCount:0,audioJitter:0,videoFractionLost:null,videoFramesDecoded:0,frameHeight:0,frameWidth:0,videoTransferFPS:0,videoFramesDropped:0,totalRoundTripTime:0,currentRoundTripTime:0,muted:!this.remoteVideo||this.remoteVideo.muted,paused:!this.remoteVideo||this.remoteVideo.paused,volume:this.remoteVideo?this.remoteVideo.volume:0,audioDeviceLabel:"",videoDeviceLbabel:""},this.streamGoogInfo);if(this.remoteVideo){var o=this.remoteVideo.srcObject;r.audioDeviceLabel=o.getAudioTracks().length>0?o.getAudioTracks()[0].label:"",r.videoDeviceLbabel=o.getVideoTracks().length>0?o.getVideoTracks()[0].label:""}var n=this.lastPlayStats.time,s=null;e.forEach((function(e){("inbound-rtp"==e.type||"ssrc"==e.type&&null!=e.bytesReceived)&&("audio"==e.mediaType||e.id.indexOf("AudioStream")>=0)?(0!=n&&(r.audioBitrate=8*(e.bytesReceived-t.lastPlayStats.audioBytesReceived)/(e.timestamp-n)),r.audioBitrate<0&&(r.audioBitrate=0),r.audioJitter=e.jitter,r.audioPacketsLost=e.packetsLost,r.audioFractionLost=e.fractionLost,r.audioPacketsLostRate=(e.packetsLost-t.lastPlayStats.audioPacketsLost)/(e.timestamp-t.lastPlayStats.audioTime),t.lastPlayStats.audioBytesReceived=e.bytesReceived,t.lastPlayStats.audioPacketsLost=e.packetsLost,t.lastPlayStats.audioTime=e.timestamp,t.lastPlayStats.time=e.timestamp,t.lastPlayStats.audioBitrate=r.audioBitrate):("inbound-rtp"==e.type||"ssrc"==e.type&&null!=e.bytesReceived)&&("video"==e.mediaType||e.id.indexOf("VideoStream")>=0)?(0!=n&&(r.videoBitrate=8*(e.bytesReceived-t.lastPlayStats.videoBytesReceived)/(e.timestamp-n),r.videoFPS=1e3*(e.framesDecoded-t.lastPlayStats.framesDecoded)/(e.timestamp-n)),r.videoBitrate<0&&(r.videoBitrate=0),r.videoFPS<0&&(r.videoFPS=0),r.nackCount=e.nackCount,r.pliCount=e.pliCount,r.videoFractionLost=e.fractionLost,r.videoFramesDecoded=e.framesDecoded,r.videoPacketsLostRate=(e.packetsLost-t.lastPlayStats.videoPacketsLost)/(e.timestamp-t.lastPlayStats.videoTime),t.lastPlayStats.videoBytesReceived=e.bytesReceived,t.lastPlayStats.framesDecoded=e.framesDecoded,t.lastPlayStats.videoPacketsLost=e.packetsLost,t.lastPlayStats.videoTime=e.timestamp,t.lastPlayStats.time=e.timestamp):"track"==e.type&&("video"==e.kind||e.id.indexOf("video")>=0)||e.frameWidth?(r.frameHeight=e.frameHeight,r.frameWidth=e.frameWidth,0!=n&&(r.videoTransferFPS=1e3*(e.framesReceived-t.lastPlayStats.framesReceived)/(e.timestamp-n),r.videoFramesDropped=e.framesDropped-t.lastPlayStats.framesDropped),r.videoTransferFPS<0&&(r.videoTransferFPS=0),r.videoFramesDropped<0&&(r.videoFramesDropped=0),t.lastPlayStats.framesReceived=e.framesReceived,t.lastPlayStats.framesDropped=e.framesDropped):"track"==e.type&&("audio"==e.kind||e.id.indexOf("audio")>=0)?(r.audioLevel=e.audioLevel,r.audioSendLevel=e.totalAudioEnergy,r.audioSamplingRate=e.totalSamplesDuration):"candidate-pair"==e.type&&(null!=e.totalRoundTripTime&&(r.totalRoundTripTime=e.totalRoundTripTime),null!=e.currentRoundTripTime&&(r.currentRoundTripTime=e.currentRoundTripTime,s=1e3*r.currentRoundTripTime))})),r.audioQuality=this.getNetQuality(s,r.audioFractionLost),r.videoQuality=this.getNetQuality(s,r.videoFractionLost),this.uploadPlayQuality(r),0!=n&&this.onPlayQualityUpdate(this.streamId,r)}},e.prototype.getNetQuality=function(e,t){return e&&e<600?t>.4?2:t>.3?4:5:e<900?t>.4?2:t>.2?3:4:t>.2?2:3},e.prototype.uploadPlayQuality=function(e){var t=this;if(this.qualityUpload){var r=Date.parse(new Date+"");(0==this.qualityUploadLastTime||r-this.qualityUploadLastTime>=this.qualityUploadInterval)&&(e.stream_type="play",e.stream_id=this.streamId,e.timeStamp=r/1e3,this.logger.info("zp.upq.1 upload"+JSON.stringify(e)),this.signal.QualityReport(n.getSeq(),this.sessionId,e,(function(e,r,i){void 0!==i.report&&(t.qualityUpload=i.report,t.qualityUploadInterval=i.report_interval_ms)}),(function(e,r){t.logger.info("zp.upq.1 upload failed "+e)})),this.qualityUploadLastTime=r)}},e.prototype.onRecvResetSession=function(e,t,r){if(this.logger.info("zp.orrs.1 received "),t==this.sessionId){this.dataReport.addEvent(this.reportSeq,"RecvResetSession"),this.signal.sendCloseSessionAck(e,this.sessionId,0);var i=JSON.parse(JSON.stringify(n.playErrorList.SESSION_CLOSED));this.negoTimer&&clearTimeout(this.negoTimer),!this.tryingNexitSignal&&this.tryNextSignal(i)}else this.logger.info("zp.orrs.1 cannot find session")},e.prototype.onRecvCloseSession=function(e,t,r){this.logger.info("zp.orcs.1 reason: "+r.reason),this.dataReport.addEvent(this.reportSeq,"RecvCloseSession"),this.signal.sendCloseSessionAck(e,this.sessionId,0);var i=JSON.parse(JSON.stringify(n.playErrorList.SESSION_CLOSED));i.msg+=r.reason,this.negoTimer&&clearTimeout(this.negoTimer);var o=1*r.reason,s=r.err_info&&JSON.parse(r.err_info).action?JSON.parse(r.err_info).action:null;if("number"==typeof o&&[24,26,28].includes(o)&&this.negoTryCount<this.negoTryMaxCount||5==s){this.logger.info("zp.orcs.1 retry: "+this.streamId);var a=this.streamId,c=this.remoteVideo,d=this.audioOutput,l=this.playOption;this.signal.sendCloseSession(n.getSeq(),this.sessionId,1),this.resetPlay(),this.startPlay(a,c,d,l),++this.negoTryCount}else[4,8,10,11,12,14,27].includes(o)||2==s?(this.logger.info("zp.orcs.1 try next signal "+this.tryingNexitSignal),!this.tryingNexitSignal&&this.tryNextSignal(i)):this.playStateUpdateError(i,!0)},e.prototype.onRecvStreamStatus=function(e){if(this.logger.debug("zp.orss.0 call"),this.cameraStatus!==e.camera_status&&this.onRemoteCameraStatusUpdate(this.streamId,e.camera_status),this.micStatus!==e.mic_status&&this.onRemoteMicStatusUpdate(this.streamId,e.mic_status),this.cameraStatus=e.camera_status,this.micStatus=e.mic_status,-1===["all","video","audio"].indexOf(this.playOption.playType)){var t=this.remoteVideo.srcObject;0!==e.camera_status&&t&&0!==t.getVideoTracks().length&&(t.getVideoTracks().forEach((function(e){e.stop(),t.removeTrack(e)})),this.remoteVideo.srcObject=t),0==e.camera_status&&t&&0==t.getVideoTracks().length&&(this.remoteVideo.srcObject=this.remoteStream.clone()),this.logger.debug("zp.orss.0 call success")}else this.logger.info("zp.orss.0 has set playType, ignore stream status")},e.prototype.onGotRemoteStream=function(e){this.logger.info("zp.ogrs.0 called "+e),this.remoteVideo?(this.remoteStream=e,this.remoteVideo.srcObject=e.clone(),this.audioOputput&&this.setAudioDestination(this.audioOputput),this.gotStreamStatus&&this.onRecvStreamStatus(this.streamStatus),this.streamCenter.soundLevelDelegate&&this.startSoundLevel(),this.dataReport.addEvent(this.reportSeq,"GetRemoteStream")):this.logger.error("zp.ogrs.0 no remoteVideo")},e.prototype.sendCandidateInfo=function(e){var t=this;this.logger.info("zp.sci.1 called"),!(e=e.filter((function(e){return!(e.candidate.indexOf("tcp")>0)&&(!!e.candidate||void 0)})))||e.length<1?this.logger.info("zp.sci.1 cancelled"):(this.dataReport.eventStart(this.reportSeq,"SendIceCandidate"),this.stateNego!==o.ENUM_PLAY_STATE_NEGO.iceConnected&&(this.stateNego=o.ENUM_PLAY_STATE_NEGO.sendCandidate),this.logger.info("zp.sci.1  stateNego:sendCandidate"),this.signal.sendCandidateInfo(n.getSeq(),this.sessionId,e,(function(e,r,i){t.logger.debug("zp.sci.1 send success"),t.dataReport.eventEnd(t.reportSeq,"SendIceCandidate")}),(function(e,r){t.logger.error("zp.sci.1 failed to send: "+e.toString()),t.dataReport.eventEndWithMsg(t.reportSeq,"SendIceCandidate",{error:e}),t.playStateUpdateError(n.playErrorList.SEND_CANDIDATE_ERROR)})))},e.prototype.shouldSendCloseSession=function(e){return this.state!=n.ENUM_PLAY_STATE_UPDATE.stop&&this.state!=o.ENUM_PLAY_STATE.waitingSessionRsp},e.prototype.playStateUpdateError=function(e,t){this.logger.info("zp.psue.1 called ",e.code),t||!(this.state===o.ENUM_PLAY_STATE.stop||this.negoTryCount<this.negoTryMaxCount&&this.stateNego<o.ENUM_PLAY_STATE_NEGO.iceConnected)?(0!=this.sessionId&&this.shouldSendCloseSession(e)&&(this.signal.sendCloseSession(n.getSeq(),this.sessionId,1),this.closeSessionSignal=!0),this.state=o.ENUM_PLAY_STATE.stop,this.onPlayStateUpdate(n.ENUM_PLAY_STATE_UPDATE.error,this.streamId,e),this.logger.info("zp.psue.1 ended"),this.resetPlay()):this.logger.info("zp.psue.1 already reset")},e.prototype.onPlayStateUpdate=function(e,t,r){},e.prototype.onPlayQualityUpdate=function(e,t){},e.prototype.onVideoSizeChanged=function(e,t,r){},e.prototype.onRemoteCameraStatusUpdate=function(e,t){},e.prototype.onRemoteMicStatusUpdate=function(e,t){},e.prototype.stopPlay=function(){for(var e in this.logger.info("zp.sp.1.1 called"),this.streamCenter.publisherList)if(this.streamCenter.publisherList[e].publisher.state==o.ENUM_PUBLISH_STATE.publishing&&this.broadcasterStatus==o.ENUM_BROADCASTER_STATUS.start){this.signal&&this.signal.sendBroadcasterStatus(n.getSeq(),this.sessionId,0),this.broadcasterStatus=o.ENUM_BROADCASTER_STATUS.stop;break}this.sessionId&&!this.closeSessionSignal&&this.signal.sendCloseSession(n.getSeq(),this.sessionId,0),this.dataReport.eventEndWithMsg(this.reportSeq,"PlayState",{state:this.state+""}),this.dataReport.addEvent(this.reportSeq,"StopPlay"),this.dataReport.addMsgExt(this.reportSeq,{stream:this.streamId,sessionId:this.sessionId}),this.dataReport.uploadReport(this.reportSeq,"RTCPlayStream"),this.resetPlay()},e.prototype.onDisconnect=function(){this.logger.info("zp.od.1 call"),this.logger.info("zp.od.1 websocket disconnect"),this.dataReport.addEvent(this.reportSeq,"OnDisconnect"),!this.tryingNexitSignal&&this.tryNextSignal(n.playErrorList.WEBSOCKET_ERROR)},e.prototype.tryNextSignal=function(e){this.tryingNexitSignal=!0;var t=this.streamId,r=this.signal.server,i=this.streamCenter.playerList[t],s=[];i&&i.serverUrls&&(s=i.serverUrls),this.nextSignalTryCount>3*s.length?(this.logger.error("zp.tns.1 try max limit"),this.playStateUpdateError(e,!0)):(s.forEach((function(e,t){return t<=s.indexOf(r)&&s.push(e)})),s.splice(0,s.indexOf(r)+1),this.logger.info("zp.tns.1 try next signal "+t),this.signal&&this.signal.state==o.ENUM_CONNECT_STATE.connected&&this.signal.sendCloseSession(n.getSeq(),this.sessionId,1),this.signal&&this.signal.removeSession(this.sessionId),this.resetPlay(),this.streamCenter.connectPlayServer(t),this.nextSignalTryCount++)},e.prototype.startSoundLevel=function(){var e=this;if(this.logger.info("zp.ssl.1 call streamID: "+this.streamId),this.remoteStream&&0!=this.remoteStream.getAudioTracks().length){this.script&&this.script.disconnect()&&(this.script=null),this.mic&&this.mic.disconnect()&&(this.mic=null),this.ac&&this.ac.close()&&(this.ac=null);try{this.ac=new("undefined"!=typeof webkitAudioContext?webkitAudioContext:AudioContext),this.mic=this.ac.createMediaStreamSource(this.remoteVideo.srcObject),this.script=this.ac.createScriptProcessor(4096,1,1),this.mic.connect(this.script),this.script.connect(this.ac.destination),this.script.onaudioprocess=function(t){for(var r=t.inputBuffer.getChannelData(0),i=0,o=0;o<r.length;o++)i<r[o]&&(i=r[o]);e.soundLevel=100*i}}catch(e){this.logger.error("zp.ssl.1 get sound level failed "+e)}}else this.logger.info("zp.ssl.1 remote stream no found")},e.prototype.stopSoundLevel=function(){this.logger.info("zp.ssl.1.1 call streamID: "+this.streamId),this.script&&this.script.disconnect(),this.mic&&this.mic.disconnect(),this.ac&&this.ac.close(),this.script=null,this.mic=null,this.ac=null},e}();t.ZegoPlayWeb=a},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){this.playerList={},this.publisherList={}}return e.prototype.setSessionInfo=function(e,t,r,i){},e}();t.ZegoStreamCenter=i},function(e,t,r){"use strict";var i,o=this&&this.__extends||(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0});var n=r(18),s=r(0),a=r(1),c=r(19),d=r(20),l=r(21),h=r(23),u=r(24),p=r(25),g=function(e){function t(){return e.call(this)||this}return o(t,e),t.prototype.init=function(){this.bindSocketHandler(),this.bindStreamHandler(),this.bindHeatBeatHandler(),this.bindRoomHandler(),this.bindMessageHandler(),this.bindLiveHandler(),this.bindStreamCenterHandler()},t.prototype.bindSocketHandler=function(){var e=this;this.socketCenter=new c.SocketCenter(this.logger,this.stateCenter),this.socketCenter.registerRouter("push_signal",(function(t){e.liveHandler.handlePushSignalMsg(t)})),this.socketCenter.getSocket=function(t){return e.getSocket(t)},this.socketCenter.handlePushKickout=function(t){e.logger.info("zb.cm.bsh.0  call hpk"),e.roomHandler.setRunState(s.ENUM_RUN_STATE.logout),e.roomHandler.resetRoom(),e.onKickOut({code:s.sdkErrorList.KICK_OUT.code,msg:s.sdkErrorList.KICK_OUT.msg+t.body.reason}),e.logger.debug("zb.cm.bsh.0  call hpk success")},this.socketCenter.handlePushCustomMsg=function(t){e.messageHandler.handlePushCustomMsg(t)},this.socketCenter.handlePushUserStateUpdateMsg=function(t){e.roomHandler.handlePushUserStateUpdateMsg(t)},this.socketCenter.handlePushRoomMsg=function(t){e.onRecvRoomMsg(t.body.chat_data,t.body.server_msg_id,t.body.ret_msg_id)},this.socketCenter.handlePushMergeMsg=function(t){e.messageHandler.handlePushMergeMsg(t)},this.socketCenter.handlePushTransMsg=function(t){e.messageHandler.handlePushTransMsg(t)},this.socketCenter.handleBigImMsgRsp=function(t){e.messageHandler.handleBigImMsgRsp(t)}},t.prototype.bindStreamHandler=function(){var e=this;this.streamHandler=new l.StreamHandler(this.logger,this.stateCenter,this.socketCenter),this.streamHandler.onStreamUpdated=function(t,r){e.onStreamUpdated(t,r)},this.streamHandler.onPublishStateUpdate=function(t,r,i){var o=r;o.indexOf("zegotest-")>=0&&(o=o.replace("zegotest-"+e.stateCenter.appid+"-","")),e.onPublishStateUpdate(t,o,i)},this.streamHandler.onStreamExtraInfoUpdated=function(t){e.onStreamExtraInfoUpdated(t)},this.streamHandler.setCDNInfo=function(t,r){e.setCDNInfo(t,r)}},t.prototype.bindHeatBeatHandler=function(){var e=this;this.heartBeatHandler=new h.HeartBeatHandler(this.logger,this.stateCenter,this.socketCenter),this.heartBeatHandler.onRecvReliableMessage=function(t,r,i){e.onRecvReliableMessage(t,r,i)},this.heartBeatHandler.handleFetchStreamListRsp=function(t){e.streamHandler.handleFetchStreamListRsp(t)},this.heartBeatHandler.fetchUserList=function(){e.roomHandler.fetchUserList()},this.heartBeatHandler.onUpdateOnlineCount=function(t,r){e.onUpdateOnlineCount(t,r)},this.heartBeatHandler.updateStreamInfo=function(t,r,i,o){void 0===i&&(i=""),e.streamHandler.updateStreamInfo(t,r,i,o)},this.heartBeatHandler.hbLogout=function(t){e.onDisconnect(t)}},t.prototype.bindRoomHandler=function(){var e=this;this.roomHandler=new d.RoomHandler(this.logger,this.stateCenter,this.socketCenter),this.roomHandler.loginSuccessCallBack=function(t,r){var i=r.body.hearbeat_interval<s.MINIUM_HEARTBEAT_INTERVAL?s.MINIUM_HEARTBEAT_INTERVAL:r.body.hearbeat_interval;e.stateCenter.tryHeartbeatCount=0,e.stateCenter.heartbeatTimer&&clearTimeout(e.stateCenter.heartbeatTimer),e.heartBeatHandler.start(i),e.heartBeatHandler.resetCheckMessage(),e.heartBeatHandler.startCheckMessageTimeout(),e.streamCenter.setSessionInfo(e.stateCenter.appid,e.stateCenter.idName,e.stateCenter.token,e.stateCenter.testEnvironment),r.body.anchor_info&&e.onGetAnchorInfo(r.body.anchor_info.anchor_id_name,r.body.anchor_info.anchor_nick_name),r.body.online_count&&e.onUpdateOnlineCount(e.stateCenter.roomid,r.body.online_count),e.logger.info("zb.cm.brh hls userStateUpdate "+e.stateCenter.userStateUpdate),e.stateCenter.userStateUpdate&&(e.logger.info("zb.cm.brh hls fetch all new userlist"),e.roomHandler.fetchUserList()),e.streamHandler.handleStreamStart(t,r)},this.roomHandler.onGetTotalUserList=function(t,r){e.onGetTotalUserList(t,r)},this.roomHandler.resetRoomCallBack=function(){e.heartBeatHandler.resetHeartbeat(),e.heartBeatHandler.resetCheckMessage(),e.resetStreamCenter()},this.roomHandler.onUserStateUpdate=function(t,r){e.onUserStateUpdate(t,r)},this.roomHandler.onDisconnect=function(t){e.onDisconnect(t)},this.roomHandler.loginBodyData=function(){return e.loginBodyData()}},t.prototype.bindMessageHandler=function(){var e=this;this.messageHandler=new u.MessageHandler(this.logger,this.stateCenter,this.socketCenter),this.messageHandler.onRecvCustomCommand=function(t,r,i){e.onRecvCustomCommand(t,r,i)},this.messageHandler.onRecvBigRoomMessage=function(t,r){e.onRecvBigRoomMessage(t,r)},this.messageHandler.onRecvReliableMessage=function(t,r,i){e.onRecvReliableMessage(t,r,i)}},t.prototype.bindLiveHandler=function(){var e=this;this.liveHandler=new p.LiveHandler(this.logger,this.stateCenter,this.socketCenter),this.liveHandler.onRecvEndJoinLiveCommand=function(t,r,i,o){e.onRecvEndJoinLiveCommand(t,r,i,o)},this.liveHandler.onRecvInviteJoinLiveRequest=function(t,r,i,o){e.onRecvInviteJoinLiveRequest(t,r,i,o)},this.liveHandler.onRecvJoinLiveRequest=function(t,r,i,o){e.onRecvJoinLiveRequest(t,r,i,o)}},t.prototype.bindStreamCenterHandler=function(){var e=this;this.streamCenter.onPlayStateUpdate=function(t,r,i){e.onPlayStateUpdateHandle(t,r,i)},this.streamCenter.onPlayQualityUpdate=function(t,r){var i=t;i.indexOf("zegotest-")>=0&&(i=i.replace("zegotest-"+e.stateCenter.appid+"-","")),e.onPlayQualityUpdate(i,r)},this.streamCenter.onPublishStateUpdate=function(t,r,i){e.onPublishStateUpdateHandle(t,r,i)},this.streamCenter.onPublishQualityUpdate=function(t,r){e.onPublishQualityUpdate(t,r)},this.streamCenter.onPlayerStreamUrlUpdate=function(t,r,i){e.onStreamUrlUpdate(t,r,i)},this.streamCenter.onVideoSizeChanged=function(t,r,i){e.onVideoSizeChanged(t,r,i)},this.streamCenter.onRemoteCameraStatusUpdate=function(t,r){e.onRemoteCameraStatusUpdate(t,r)},this.streamCenter.onRemoteMicStatusUpdate=function(t,r){e.onRemoteMicStatusUpdate(t,r)},this.streamCenter.onSoundLevelUpdate=function(t){e.onSoundLevelUpdate(t)},this.streamCenter.onDeviceError=function(t){e.onDeviceError(t)},this.streamCenter.OnAudioDeviceStateChanged=function(t){e.OnAudioDeviceStateChanged(t)},this.streamCenter.OnVideoDeviceStateChanged=function(t){e.OnVideoDeviceStateChanged(t)}},t.prototype.config=function(e){return this.logger.debug("zb.cm.cf call"),a.ClientUtil.checkConfigParam(e,this.logger)?(this.stateCenter.appid=e.appid,"string"==typeof e.server?(this.stateCenter.server=e.server,this.stateCenter.serverBak=e.server):Array.isArray(e.server)&&e.server.length>0&&(this.stateCenter.server=e.server[0],this.stateCenter.serverBak=e.server[1]||e.server[0]),this.logger.info("zb.cm.cf server "+JSON.stringify(e.server)),this.stateCenter.idName=e.idName,this.stateCenter.nickName=e.nickName,this.logger.setLogLevel(e.logLevel),!1===e.audienceCreateRoom&&(this.stateCenter.roomCreateFlag=0),e.remoteLogLevel?this.logger.setRemoteLogLevel(e.remoteLogLevel):this.logger.setRemoteLogLevel(0),this.logger.setSessionInfo(e.appid,"","",e.idName,"",s.PROTO_VERSION),e.logUrl&&this.logger.openLogServer(e.logUrl),-1==this.stateCenter.server.indexOf("test2-wsliveroom-api.zego.im")&&-1==this.stateCenter.server.indexOf("wsliveroom-test.zegocloud.com")&&-1==this.stateCenter.server.indexOf("wsliveroom-test.zego.im")||(this.stateCenter.testEnvironment=!0),this.stateCenter.configOK=!0,navigator&&navigator.appVersion&&this.logger.info("zb.cm.cf "+navigator.appVersion),this.logger.debug("zb.cm.cf call success"),!0):(this.logger.error("zb.cm.cf param error"),!1)},t.prototype.login=function(e,t,r,i,o){"string"==typeof e?"string"==typeof r?1===t||2===t?this.roomHandler.login(e,t,r,null,i,o):this.logger.error("zb.rh.lg role error"):this.logger.error("zb.rh.lg token type error"):this.logger.error("zb.rh.lg roomid  type error")},t.prototype.loginWithAuthor=function(e,t,r,i,o,n){"string"!=typeof e||"string"!=typeof r||"string"!=typeof i||1!==t&&2!==t?this.logger.error("zb.rh.lg params error"):this.roomHandler.login(e,t,r,i,o,n)},t.prototype.logout=function(){return this.roomHandler.logout()},t.prototype.setUserStateUpdate=function(e){"boolean"==typeof e?this.roomHandler.setUserStateUpdate(e):console.error("setUserStateUpdate param error")},t.prototype.onUserStateUpdate=function(e,t){},t.prototype.onGetTotalUserList=function(e,t){},t.prototype.onUpdateOnlineCount=function(e,t){},t.prototype.onGetAnchorInfo=function(e,t){},t.prototype.release=function(){this.logger.debug("zb.cm.rl call"),this.roomHandler.setRunState(s.ENUM_RUN_STATE.logout),this.roomHandler.resetRoom(),this.logger.stopLogServer(),this.logger.debug("zb.cm.rl call success")},t.prototype.sendCustomCommand=function(e,t,r,i){return"string"!=typeof t&&"object"!=typeof t?(this.logger.error("zb.mh.scc params error"),!1):this.messageHandler.sendCustomCommand(e,t,r,i)},t.prototype.onRecvCustomCommand=function(e,t,r){},t.prototype.sendRoomMsg=function(e,t,r,i,o){this.messageHandler.sendRoomMsg(e,t,r,i,o)},t.prototype.onRecvRoomMsg=function(e,t,r){},t.prototype.sendReliableMessage=function(e,t,r,i){this.messageHandler.sendReliableMessage(e,t,r,i)},t.prototype.onRecvReliableMessage=function(e,t,r){},t.prototype.sendBigRoomMessage=function(e,t,r,i,o){this.messageHandler.sendBigRoomMessage(e,t,r,i,o)},t.prototype.onRecvBigRoomMessage=function(e,t){},t.prototype.sendRelayMessage=function(e,t,r,i){this.messageHandler.sendRelayMessage(e,t,r,i)},t.prototype.requestJoinLive=function(e,t,r,i){return this.liveHandler.requestJoinLive(e,t,r,i)},t.prototype.onRecvJoinLiveRequest=function(e,t,r,i){},t.prototype.inviteJoinLive=function(e,t,r,i){return this.liveHandler.inviteJoinLive(e,t,r,i)},t.prototype.onRecvInviteJoinLiveRequest=function(e,t,r,i){},t.prototype.endJoinLive=function(e,t,r){return this.liveHandler.endJoinLive(e,t,r)},t.prototype.onRecvEndJoinLiveCommand=function(e,t,r,i){},t.prototype.respondJoinLive=function(e,t,r,i){return this.liveHandler.respondJoinLive(e,t,r,i)},t.prototype.updateMixStream=function(e,t,r){return this.streamHandler.updateMixStream(e,t,r)},t.prototype.stopMixStream=function(e,t,r){return this.streamHandler.stopMixStream(e,t,r)},t.prototype.publishTarget=function(e,t,r){return this.streamHandler.publishTarget(e,t,r)},t.prototype.updateStreamExtraInfo=function(e,t){return this.streamHandler.updateStreamExtraInfo(e,t)},t.prototype.onStreamUrlUpdate=function(e,t,r){},t.prototype.onStreamUpdated=function(e,t){},t.prototype.onStreamExtraInfoUpdated=function(e){},t.prototype.onPlayStateUpdate=function(e,t,r){},t.prototype.onVideoSizeChanged=function(e,t,r){},t.prototype.onRemoteCameraStatusUpdate=function(e,t){},t.prototype.onRemoteMicStatusUpdate=function(e,t){},t.prototype.onPlayQualityUpdate=function(e,t){},t.prototype.onPublishStateUpdate=function(e,t,r){},t.prototype.onPublishQualityUpdate=function(e,t){},t.prototype.onSoundLevelUpdate=function(e){},t.prototype.onDeviceError=function(e){},t.prototype.OnAudioDeviceStateChanged=function(e){},t.prototype.OnVideoDeviceStateChanged=function(e){},t.prototype.onDisconnect=function(e){},t.prototype.onKickOut=function(e){},t.getCurrentVersion=function(){return s.PROTO_VERSION},t}(n.Common);t.BaseCenter=g},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=r(0),o=r(2),n=function(){function e(){}return e.prototype.onPlayStateUpdateHandle=function(e,t,r){1==e&&this.stopPlayingStream(t),this.onPlayStateUpdate(e,t,r)},e.prototype.onPublishStateUpdateHandle=function(e,t,r){var o=this;0==e?this.stateCenter.publishStreamList[t]&&(this.stateCenter.publishStreamList[t].state==i.ENUM_PUBLISH_STREAM_STATE.tryPublish?(this.stateCenter.publishStreamList[t].state=i.ENUM_PUBLISH_STREAM_STATE.update_info,this.streamHandler.updateStreamInfo(t,i.ENUM_STREAM_SUB_CMD.liveBegin,this.stateCenter.publishStreamList[t].extra_info,(function(e){o.stateCenter.publishStreamList[t]&&o.stateCenter.publishStreamList[t].state==i.ENUM_PUBLISH_STREAM_STATE.update_info&&(o.stateCenter.publishStreamList[t].state=i.ENUM_PUBLISH_STREAM_STATE.stop,o.onPublishStateUpdate(1,t,e),o.streamCenter.stopPlayingStream(t))}))):this.WebrtcOnPublishStateUpdateHandle(e,t,r)):(this.onPublishStateUpdate(e,t,r),1==e&&this.stopPublishingStream(t))},e.prototype.resetStreamCenter=function(){if(this.stateCenter.customUrl&&(this.stateCenter.customUrl=null),this.streamCenter.reset(),!this.socketCenter.isDisConnect())for(var e in this.stateCenter.publishStreamList)this.stateCenter.publishStreamList[e].state==i.ENUM_PUBLISH_STREAM_STATE.publishing&&this.streamHandler.updateStreamInfo(e,i.ENUM_STREAM_SUB_CMD.liveEnd,this.stateCenter.publishStreamList[e].extra_info)},e.prototype.handleFetchWebRtcUrlRsp=function(e){var t=e.body.stream_id,r=!1;if(e.body.urls&&Array.isArray(e.body.urls)&&e.body.urls.length>0?r=!0:this.logger.error("cb.cm.hfwur signal url is empty"),"push"===e.body.ptype)!r&&this.onPublishStateUpdate(1,t,o.publishErrorList.DISPATCH_ERROR)&&this.stopPublishingStream(t),this.stateCenter.publishStreamList[t]?this.streamCenter.startPublishingStream(t,e.body.urls):this.logger.error("cb.cm.hfwur no streamid to publish");else if("pull"==e.body.ptype){!r&&this.onPlayStateUpdate(1,t,o.playErrorList.DISPATCH_ERROR)&&this.stopPlayingStream(t);for(var i=!1,n=0;n<this.stateCenter.streamList.length;n++)if(this.stateCenter.streamList[n].stream_id===t){i=!0;break}0==i&&this.logger.warn("cb.cm.hfwur cannot find stream, continue to play"),this.streamCenter.startPlayingStream(t,e.body.urls)}},e}();t.Common=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=r(0),o=r(1),n=function(){function e(e,t){var r=this;this.cmdSeq=0,this.responseRouters={},this.logger=e,this.stateCenter=t,this.responseRouters={push_kickout:function(e){r.handlePushKickout(e)},push_custommsg:function(e){r.handlePushCustomMsg(e)},push_im_chat:function(e){r.handlePushRoomMsg(e)},push_userlist_update:function(e){r.handlePushUserStateUpdateMsg(e)},push_merge_message:function(e){r.handlePushMergeMsg(e)},trans:function(e){r.handleTransRsp(e)},push_trans:function(e){r.handlePushTransMsg(e)}}}return e.prototype.handlePushKickout=function(e){},e.prototype.handlePushCustomMsg=function(e){},e.prototype.handlePushRoomMsg=function(e){},e.prototype.handlePushUserStateUpdateMsg=function(e){},e.prototype.handlePushMergeMsg=function(e){},e.prototype.handlePushTransMsg=function(e){},e.prototype.handleBigImMsgRsp=function(e){},e.prototype.handleTransRsp=function(e){if(this.stateCenter.isLogin())if(0==e.body.err_code){var t=e.body.trans_type;this.stateCenter.transSeqMap[t]?(this.stateCenter.transSeqMap[t].seq=e.body.trans_seq,this.logger.debug("zb.sc.htr trans "+t+" seq "+e.body.trans_seq)):this.logger.error("zb.sc.htr cannot match send info")}else this.logger.error("zb.sc.htr trans send error "+e.body.err_code);else this.logger.error("zb.sc.htr not login")},e.prototype.handleBizChannelRspCallback=function(e,t){0===e.body.err_code?null!=t.success&&t.success(e.header.seq,e.body.cmd,e.body.rsp_body):null!=t.error&&t.error(e.body.err_code,e.header.seq,e.body.rsp_body)},e.prototype.registerRouter=function(e,t){this.responseRouters[e]=t},e.prototype.getSocket=function(e){return null},e.prototype.getHeaderV2=function(e){return{Protocol:"req_v2",cmd:e,appid:this.stateCenter.appid,seq:++this.cmdSeq,user_id:this.stateCenter.userid,session_id:this.stateCenter.sessionid||"",room_id:this.stateCenter.roomid||""}},e.prototype.getHeader=function(e){return{Protocol:"req",cmd:e,appid:this.stateCenter.appid,seq:++this.cmdSeq,user_id:this.stateCenter.userid,session_id:this.stateCenter.sessionid||"",room_id:this.stateCenter.roomid||""}},e.prototype.sendMessage=function(e,t,r,o){if(this.logger.debug("zb.sc.sm call "+e),this.isDisConnect())return this.logger.error("zb.sc.sm error  "+e+"websocket is disconnected"),-1;var n="V1"===i.ROOMVERSION?this.getHeader(e):this.getHeaderV2(e),s={header:n,body:t};if(null==r&&(r=null),null==o&&(o=null),null!=r||null!=o){var a={data:s,seq:n.seq,deleted:!1,time:Date.parse(new Date+""),success:r,error:o},c=this.stateCenter.sendCommandList.push(a);this.stateCenter.sendCommandMap[a.seq]=c}return this.websocket.send(JSON.stringify(s)),this.logger.debug("zb.sc.sm success"),n.seq},e.prototype.sendCustomMessage=function(e,t,r,o){if(this.logger.debug("zb.sc.scm call"),this.isDisConnect())return this.logger.error("zb.sc.scm error"),!1;var n="V1"===i.ROOMVERSION?this.getHeader(e):this.getHeaderV2(e),s={header:n,body:t},a=JSON.stringify(s);null==r&&(r=null),null==o&&(o=null);var c={data:s,seq:n.seq,deleted:!1,time:Date.parse(new Date+""),success:r,error:o},d=this.stateCenter.sendDataList.push(c);return this.stateCenter.sendDataMap[c.seq]=d,this.websocket.send(a),this.logger.debug("zb.sc.scm success seq: ",n.seq),!0},e.prototype.isDisConnect=function(){return!this.websocket||1!==this.websocket.readyState},e.prototype.closeSocket=function(){this.websocket&&(this.logger.info("zb.sc.cs close websocket"),this.websocket.onclose=null,this.websocket.onerror=null,this.websocket.close(),this.websocket=null)},e.prototype.createSocket=function(e){this.websocket=this.getSocket(e)},e.prototype.openHandler=function(e){this.websocket.onopen=e},e.prototype.closeHandler=function(e){this.websocket.onclose=e},e.prototype.errorHandler=function(){var e=this;this.websocket.onerror=function(t){e.logger.error("zb.sc.oe msg="+JSON.stringify(t))}},e.prototype.checkResponse=function(e){return(e.header.appid!==this.stateCenter.appid||e.header.session_id!==this.stateCenter.sessionid||e.header.user_id!==this.stateCenter.userid||e.header.room_id!==this.stateCenter.roomid||this.stateCenter.runState!==i.ENUM_RUN_STATE.login)&&(this.logger.error("zb.sc.crp check session fail."),!0)},e.prototype.responseHandler=function(){var e=this;this.websocket.onmessage=function(t){var r=JSON.parse(t.data);e.logger.info("zb.sc.ws.rph jsonmsg= ",r.header.cmd),e.logger.info("zb.sc.ws.rph jsonmsg= ",t.data),0!==r.body.err_code&&r.body.err_message&&e.logger.error("zb.sc.ws.rph cmd="+r.header.cmd+", err_code="+r.body.err_code+", err_message="+r.body.err_message+" "),"login"!==r.header.cmd?"logout"!==r.header.cmd?e.stateCenter.isLogin()?e.checkResponse(r)?e.logger.error("zb.sc.ws.rph check session fail."):(e.handleSendCommandMsgRsp(r),e.logger.info("zb.sc.ws.rph cmd="+r.header.cmd+",function="+!!e.responseRouters[r.header.cmd]),e.responseRouters[r.header.cmd]&&e.responseRouters[r.header.cmd](r)):e.logger.warn("zb.sc.ws.rph  already logout"):e.responseRouters.logout(r,e.cmdSeq):e.responseRouters.login(r,e.cmdSeq)}},e.prototype.handleSendCommandMsgRsp=function(e){this.logger.debug("zb.sc.hscmr call");var t,r=this.stateCenter.sendCommandMap[e.header.seq];null!=r&&("login"==(t=r._data).data.header.cmd?this.logger.debug("zb.sc.hscmr don't check "+t.data.header.cmd):"relay"==t.data.header.cmd?this.handleRelayRspCallback(e,t):"bigim_chat"==t.data.header.cmd?this.handleBigImRspCallback(e,t):"biz_channel"==t.data.header.cmd?this.handleBizChannelRspCallback(e,t):0===e.body.err_code?null!=t.success&&t.success(e.header.seq):null!=t.error&&t.error(o.ClientUtil.getServerError(e.body.err_code),e.header.seq),delete this.stateCenter.sendCommandMap[e.header.seq],this.stateCenter.sendCommandList.remove(r)),this.logger.debug("zb.sc.hscmr call success")},e.prototype.handleRelayRspCallback=function(e,t){0===e.body.err_code?null!=t.success&&t.success(e.header.seq,e.body.relay_result):null!=t.error&&t.error(o.ClientUtil.getServerError(e.body.err_code),e.header.seq)},e.prototype.handleBigImRspCallback=function(e,t){0===e.body.err_code?null!=t.success&&this.handleBigImMsgRsp(e):null!=t.error&&t.error(o.ClientUtil.getServerError(e.body.err_code),e.header.seq)},e}();t.SocketCenter=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=r(0),o=r(1),n=function(){function e(e,t,r){this.logger=e,this.socketCenter=r,this.stateCenter=t}return e.prototype.setRunState=function(e){this.logger.debug("zb.rh.srs old="+this.stateCenter.runState+", new="+e),this.stateCenter.lastRunState=this.stateCenter.runState,this.stateCenter.runState=e},e.prototype.resetTryLogin=function(){this.logger.debug("zb.rh.rtl call"),clearTimeout(this.stateCenter.tryLoginTimer),this.stateCenter.tryLoginTimer=null,this.stateCenter.tryLoginCount=0,this.logger.debug("zb.rh.rtl call success")},e.prototype.resetBigRoomInfo=function(){this.stateCenter.transSeqMap={},this.stateCenter.realyMessageList=[],this.stateCenter.relayTimer&&(clearTimeout(this.stateCenter.relayTimer),this.stateCenter.relayTimer=null),this.stateCenter.bigImLastTimeIndex=0,this.stateCenter.bigIMmessageList=[],this.stateCenter.bigImCallbackMap={},this.stateCenter.bigImTimer&&(clearTimeout(this.stateCenter.bigImTimer),this.stateCenter.bigImTimer=null),this.stateCenter.serverTimeOffset=0,this.stateCenter.datiTimeWindow=0,this.stateCenter.bigimTimeWindow=0},e.prototype.resetRoom=function(){var e=this;this.logger.debug("zb.rh.rr call"),this.resetTryLogin(),this.resetRoomCallBack(),this.stateCenter.streamList=[],this.stateCenter.streamQuerying=!1,this.stateCenter.publishStreamList={},this.stateCenter.joinLiveCallbackMap={},this.stateCenter.joinLiveRequestMap={},this.stateCenter.streamUrlMap={},this.resetBigRoomInfo(),this.stateCenter.cmdCallback={},this.logger.debug("zb.rh.rr call send logout=",this.stateCenter.sessionid),"0"!==this.stateCenter.sessionid&&this.stateCenter.runState!==i.ENUM_RUN_STATE.logout&&(this.socketCenter.registerRouter("logout",(function(t){e.handleLogoutRsp(t)})),this.socketCenter.sendMessage("logout",{reserve:0})),this.socketCenter.closeSocket(),this.setRunState(i.ENUM_RUN_STATE.logout),this.stateCenter.userid="",this.stateCenter.sessionid="",this.logger.setSessionInfo(this.stateCenter.appid,this.stateCenter.roomid,this.stateCenter.sessionid,this.stateCenter.idName,this.stateCenter.nickName,i.PROTO_VERSION),this.logger.debug("zb.rh.rr call success")},e.prototype.resetRoomCallBack=function(){},e.prototype.onDisconnect=function(e){},e.prototype.loginSuccessCallBack=function(e,t){},e.prototype.onGetTotalUserList=function(e,t){},e.prototype.login=function(e,t,r,n,s,a){if(this.logger.setSessionInfo(this.stateCenter.appid,e,"","",this.stateCenter.nickName,i.PROTO_VERSION),this.logger.info("zb.rh.lg call:",e,r),n&&(this.stateCenter.third_token=n),!this.stateCenter.configOK||!o.ClientUtil.checkLoginParam(e,r))return this.logger.error("zb.rh.lg param error"),void a({code:"",msg:"param error"});this.stateCenter.runState!==i.ENUM_RUN_STATE.logout&&(this.logger.debug("zb.rh.lg reset"),this.setRunState(i.ENUM_RUN_STATE.logout),this.resetRoom()),this.logger.debug("zb.rh.lg begin"),this.setRunState(i.ENUM_RUN_STATE.trylogin),this.stateCenter.roomid=e,this.stateCenter.token=r,this.stateCenter.role=t,o.ClientUtil.registerCallback("login",{success:s,error:a},this.stateCenter.callbackList),this.resetTryLogin(),this.tryLogin(),this.logger.info("zb.rh.lg call success")},e.prototype.loginBodyData=function(){return null},e.prototype.tryLogin=function(){var e=this;if(this.logger.debug("zb.rh.tl call"),this.stateCenter.runState===i.ENUM_RUN_STATE.trylogin){if(++this.stateCenter.tryLoginCount>i.MAX_TRY_LOGIN_COUNT){this.logger.error("zb.rh.tl fail times limit");var t=this.stateCenter.lastRunState;return this.setRunState(i.ENUM_RUN_STATE.logout),this.resetRoom(),void(t==i.ENUM_RUN_STATE.login?(this.logger.error("zb.rh.tl fail and disconnect"),this.onDisconnect(i.sdkErrorList.LOGIN_DISCONNECT)):(this.logger.info("zb.rh.tl fail and callback user"),o.ClientUtil.actionErrorCallback("login",this.stateCenter.callbackList)(i.sdkErrorList.LOGIN_TIMEOUT)))}if(this.stateCenter.startConnceTime=(new Date).getTime(),console.warn("start connect",this.stateCenter.startConnceTime),this.socketCenter.isDisConnect()){this.logger.debug("zb.rh.tl need new websocket");try{this.socketCenter.closeSocket(),this.logger.debug("zb.rh.tl new websocket"),this.socketCenter.createSocket(this.stateCenter.tryLoginCount%2==1?this.stateCenter.server:this.stateCenter.serverBak),this.socketCenter.registerRouter("login",(function(t,r){e.handleLoginRsp(t,r)})),this.socketCenter.closeHandler((function(t){e.socketCenter.closeSocket(),e.closeHandler(t)})),this.socketCenter.openHandler((function(){e.openHandler()}))}catch(e){this.logger.error("zb.rh.tl websocket err:"+e)}}else{var r=this.loginBodyData();this.logger.info("zb.rh.tl use current websocket and sent login"),this.socketCenter.sendMessage("login",r)}this.stateCenter.tryLoginTimer=setTimeout((function(){e.tryLogin()}),i.TRY_LOGIN_INTERVAL[this.stateCenter.tryLoginCount%i.MAX_TRY_LOGIN_COUNT]),this.logger.info("zb.rh.tl call success")}else this.logger.error("zb.rh.tl state error")},e.prototype.handleLoginRsp=function(e,t){if(this.logger.debug("zb.rh.hlr call"),this.stateCenter.runState===i.ENUM_RUN_STATE.trylogin){if(e.header.seq===t)return 0!==e.body.err_code?(this.handleLoginFail(e),void this.logger.error("zb.rh.hlr server error=",e.body.err_code)):(this.handleLoginSuccess(e),void this.logger.info("zb.rh.hlr call success."));this.logger.error("zb.rh.hlr in wrong seq, local=",t,",recv=",e.header.seq)}else this.logger.error("zb.rh.hlr state error")},e.prototype.handleLoginFail=function(e){if(this.logger.debug("zb.rh.hlf call"),o.ClientUtil.isKeepTryLogin(e.body.err_code))this.logger.warn("zb.rh.hlf KeepTry true");else{var t=this.stateCenter.lastRunState;this.setRunState(i.ENUM_RUN_STATE.logout),this.resetRoom();var r=o.ClientUtil.getServerError(e.body.err_code);t===i.ENUM_RUN_STATE.login?(this.logger.info("zb.rh.hlf callback disconnect"),this.onDisconnect(r)):(this.logger.info("zb.rh.hlf callback error"),o.ClientUtil.actionErrorCallback("login",this.stateCenter.callbackList)(r)),this.logger.debug("zb.rh.hlf call success")}},e.prototype.handleLoginSuccess=function(e){this.stateCenter.startloginSucTime=(new Date).getTime(),console.warn("login suc",this.stateCenter.startloginSucTime,this.stateCenter.startloginSucTime-this.stateCenter.startloginTime,this.stateCenter.startloginSucTime-this.stateCenter.startConnceTime),this.logger.info("zb.rh.hls call");var t=this.stateCenter.lastRunState;if(this.setRunState(i.ENUM_RUN_STATE.login),this.stateCenter.userid=e.body.user_id,this.stateCenter.sessionid=e.body.session_id,this.stateCenter.anchor_info=e.body.anchor_info||this.stateCenter.anchor_info,this.stateCenter.userListInterval=e.body.userlist_interval||this.stateCenter.userListInterval,this.stateCenter.userListMergeInterval=e.body.userlist_merge_timeout||this.stateCenter.userListMergeInterval,this.logger.setSessionInfo(this.stateCenter.appid,this.stateCenter.roomid,this.stateCenter.sessionid,this.stateCenter.idName,this.stateCenter.nickName,i.PROTO_VERSION),e.body.config_info&&(this.logger.setRemoteLogLevel(e.body.config_info.log_level),""!=e.body.config_info.log_url&&this.logger.openLogServer(e.body.config_info.log_url)),null!=e.body.ret_timestamp&&"string"==typeof e.body.ret_timestamp){var r=parseFloat(e.body.ret_timestamp);this.stateCenter.serverTimeOffset=0==r?0:e.body.ret_timestamp-(new Date).getTime()}e.body.bigim_time_window&&"number"==typeof e.body.bigim_time_window&&(this.stateCenter.bigimTimeWindow=e.body.bigim_time_window),e.body.dati_time_window&&"number"==typeof e.body.dati_time_window&&(this.stateCenter.datiTimeWindow=e.body.dati_time_window),e.body.cluster_env&&1===e.body.cluster_env&&(this.stateCenter.testEnvironment=!0),this.resetTryLogin(),this.loginSuccessCallBack(t,e)},e.prototype.openHandler=function(){this.logger.info("zb.rh.oh websocket.onpen call"),this.socketCenter.responseHandler();var e=this.loginBodyData();this.logger.info("zb.rh.oh websocket.onpen send login"),this.stateCenter.startloginTime=(new Date).getTime(),console.warn("start login",this.stateCenter.startloginTime,this.stateCenter.startloginTime-this.stateCenter.startConnceTime),this.socketCenter.sendMessage("login",e),this.logger.debug("zb.rh.oh websocket.onpen call success")},e.prototype.closeHandler=function(e){this.logger.info("zb.rh.ws.oc room websocket close "+JSON.stringify(e.code)),this.stateCenter.runState!==i.ENUM_RUN_STATE.logout?this.stateCenter.runState===i.ENUM_RUN_STATE.trylogin&&this.stateCenter.tryLoginCount<=i.MAX_TRY_LOGIN_COUNT?this.logger.info("zb.rh.ws.oc is called because of try login"):this.stateCenter.runState===i.ENUM_RUN_STATE.login?(this.logger.info("zb.rh.ws.oc is called because of network broken, try again"),this.setRunState(i.ENUM_RUN_STATE.trylogin),this.resetTryLogin(),this.tryLogin()):(this.logger.error("zb.rh.ws.oc out of think!!!"),this.setRunState(i.ENUM_RUN_STATE.logout),this.resetRoom(),this.onDisconnect(i.sdkErrorList.UNKNOWN)):this.logger.info("zb.rh.ws.oc onclose logout flow call websocket.close")},e.prototype.logout=function(){return this.logger.debug("zb.rh.lo call"),this.stateCenter.runState===i.ENUM_RUN_STATE.logout?(this.logger.warn("zb.rh.lo at logout"),!1):(this.resetRoom(),this.logger.info("zb.rh.lo call success"),!0)},e.prototype.setUserStateUpdate=function(e){return this.logger.debug("zb.rh.su call"),"boolean"!=typeof e?(this.logger.info("zb.rh.su param error"),!1):(this.stateCenter.userStateUpdate=e,this.logger.info("zb.rh.su call success "+e),!0)},e.prototype.fetchUserList=function(){this.logger.debug("zb.rh.ful call"),this.stateCenter.userQuerying?this.logger.warn("zb.rh.ful is already querying"):(this.stateCenter.userQuerying=!0,this.stateCenter.userTempList=[],"V1"===i.ROOMVERSION?this.fetchUserListWithPage(0):this.fetchUserListWithPageV2(0),this.logger.info("zb.rh.ful the first time call"))},e.prototype.fetchUserListWithPageV2=function(e){var t=this;this.logger.debug("zb.rh.fulwp call"),this.socketCenter.registerRouter("user_list_v2",(function(r){t.handleFetchUserListRspV2(e,r)})),this.socketCenter.sendMessage("user_list_v2",{marker:0===e?"":e+"",mode:0,limit:100}),this.logger.info("zb.rh.fulwp call success")},e.prototype.fetchUserListWithPage=function(e){var t=this;this.logger.debug("zb.rh.fulwp call"),this.socketCenter.registerRouter("user_list",(function(e){t.handleFetchUserListRsp(e)})),this.socketCenter.sendMessage("user_list",{user_index:e,sort_type:0}),this.logger.info("zb.rh.fulwp call success")},e.prototype.handleFetchUserListRspV2=function(e,t){if(this.logger.debug("zb.rh.hfulr call"),0!=t.body.err_code)return this.stateCenter.userQuerying=!1,this.stateCenter.lastUserQueryTime=Date.now()+this.stateCenter.userListInterval,void this.logger.info("zb.rh.hfulr fetch error "+t.body.err_code);if(this.stateCenter.userStateUpdate){if(this.stateCenter.userTempList=this.stateCenter.userTempList.concat(t.body.user_baseinfos),e!=t.body.marker)return this.logger.warn("zb.rh.hfulr fetch another page"),void this.fetchUserListWithPageV2(e+1);this.stateCenter.userSeq=t.body.server_user_seq,this.logger.info("zb.rh.hfulr set user Seq "+this.stateCenter.userSeq);for(var r=[],i=0;i<this.stateCenter.userTempList.length;i++){var o={idName:this.stateCenter.userTempList[i].id_name,nickName:this.stateCenter.userTempList[i].nick_name,role:this.stateCenter.userTempList[i].role};r.push(o)}this.stateCenter.userQuerying=!1,this.stateCenter.lastUserQueryTime=Date.now()+this.stateCenter.userListInterval,this.onGetTotalUserList(this.stateCenter.roomid,r),this.stateCenter.userTempList=[],this.logger.info("zb.rh.hfulr call success user_list "+r+" count "+r.length)}},e.prototype.handleFetchUserListRsp=function(e){if(this.logger.debug("zb.rh.hfulr call"),0!=e.body.err_code)return this.stateCenter.userQuerying=!1,this.stateCenter.lastUserQueryTime=Date.now()+this.stateCenter.userListInterval,void this.logger.info("zb.rh.hfulr fetch error "+e.body.err_code);if(this.stateCenter.userStateUpdate){this.stateCenter.userTempList=this.stateCenter.userTempList.concat(e.body.user_baseinfos);var t=e.body.ret_user_index;if(t!=e.body.server_user_index)return this.logger.warn("zb.rh.hfulr fetch another page"),void this.fetchUserListWithPage(t+1);this.stateCenter.userSeq=e.body.server_user_seq,this.logger.info("zb.rh.hfulr set user Seq "+this.stateCenter.userSeq);for(var r=[],i=0;i<this.stateCenter.userTempList.length;i++){var o={idName:this.stateCenter.userTempList[i].id_name,nickName:this.stateCenter.userTempList[i].nick_name,role:this.stateCenter.userTempList[i].role};r.push(o)}this.stateCenter.userQuerying=!1,this.stateCenter.lastUserQueryTime=Date.now()+this.stateCenter.userListInterval,this.onGetTotalUserList(this.stateCenter.roomid,r),this.stateCenter.userTempList=[],this.logger.info("zb.rh.hfulr call success user_list "+r+" count "+r.length)}},e.prototype.handleLogoutRsp=function(e){this.logger.debug("zb.rh.hlor result=",e.body.err_code)},e.prototype.handlePushUserStateUpdateMsg=function(e){if(this.logger.info("zb.rh.hpus call"),this.stateCenter.isLogin())if(this.stateCenter.userStateUpdate)if(this.stateCenter.userSeq+e.body.user_actions.length===e.body.user_list_seq){this.stateCenter.userSeq=e.body.user_list_seq,this.logger.debug("zb.rh.hpus push userSeq "+this.stateCenter.userSeq);for(var t=[],r=0;r<e.body.user_actions.length;r++){var i={action:e.body.user_actions[r].Action,idName:e.body.user_actions[r].IdName,nickName:e.body.user_actions[r].NickName,role:e.body.user_actions[r].Role,loginTime:e.body.user_actions[r].LoginTime};t.push(i)}this.onUserStateUpdate(e.body.room_id,t),this.logger.info("zb.rh.hpus call success")}else this.mergeUserByUserSeq(e.body.user_list_seq,e.body.user_actions);else this.logger.info("zb.rh.hpus no userStateUpdate flag");else this.logger.error("zb.rh.hpus not login")},e.prototype.onUserStateUpdate=function(e,t){},e.prototype.mergeUserByUserSeq=function(e,t){var r=this;this.stateCenter.userSeqMergeMap||(this.logger.warn("zb.rh.hpus new merge userlist "+this.stateCenter.userSeq+" server "+e),this.stateCenter.userSeqMergeMap={},this.stateCenter.userSeqMergeTimer&&clearTimeout(this.stateCenter.userSeqMergeTimer),this.stateCenter.userSeqMergeTimer=setTimeout((function(){var e=Object.keys(r.stateCenter.userSeqMergeMap).map((function(e){return+e})).sort((function(e,t){return e-t}));if(e[e.length-1]-e[0]+1===e.length)r.mergeUser(e);else{r.stateCenter.userSeqMergeMap=null;var t=r.stateCenter.lastUserQueryTime-Date.now();r.logger.info("zb.rh.hpus fetch merge userlist "+r.stateCenter.userSeq+" userSeqList "+e.join(",")+" wait "+t),t>0?(r.stateCenter.userQueryTimer&&clearTimeout(r.stateCenter.userQueryTimer),r.stateCenter.userQueryTimer=setTimeout((function(){r.fetchUserList()}),t)):r.fetchUserList()}}),this.stateCenter.userListMergeInterval)),this.logger.warn("zb.rh.hpus merge userlist "+this.stateCenter.userSeq+" server "+e+" userlist "+t.length),this.stateCenter.userSeqMergeMap[e]=t},e.prototype.mergeUser=function(e){var t=this;this.logger.info("zb.rh.hpus merge userlist "+this.stateCenter.userSeq+" userSeqList "+e.join(",")),this.stateCenter.userSeq=e[e.length-1];var r={};e.forEach((function(e){t.stateCenter.userSeqMergeMap[e].forEach((function(e){r[e.IdName]=e}))})),this.stateCenter.userSeqMergeMap=null;var i=Object.values(r).map((function(e){return{action:e.Action,idName:e.IdName,nickName:e.NickName,role:e.Role,loginTime:e.LoginTime?String(e.LoginTime):""}}));i.sort((function(e,t){return e.loginTime.localeCompare(t.loginTime)})),this.onUserStateUpdate(this.stateCenter.roomid,i)},e}();t.RoomHandler=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=r(0),o=r(1),n=r(22),s=function(){function e(e,t,r){this.logger=e,this.socketCenter=r,this.stateCenter=t}return e.prototype.setCDNInfo=function(e,t){},e.prototype.onStreamUpdated=function(e,t){},e.prototype.onStreamExtraInfoUpdated=function(e){},e.prototype.handleStreamStart=function(e,t){var r=this;if(this.stateCenter.streamQuerying=!1,this.socketCenter.registerRouter("stream",(function(e){r.handleStreamUpdateRsp(e)})),this.socketCenter.registerRouter("push_stream_update",(function(e){r.handlePushStreamUpdateMsg(e)})),e==i.ENUM_RUN_STATE.login)this.logger.info("zb.sh.hss recover from disconnect so call streamupdate"),this.handleFullUpdateStream(t.body.stream_seq,t.body.stream_info||[]);else{this.logger.info("zb.sh.hss success callback user"),this.stateCenter.streamList=t.body.stream_info||[],this.stateCenter.streamSeq=t.body.stream_seq;for(var n=0;n<this.stateCenter.streamList.length;n++)this.stateCenter.streamList[n].anchor_id_name==this.stateCenter.idName&&(this.updateStreamInfo(this.stateCenter.streamList[n].stream_id,i.ENUM_STREAM_SUB_CMD.liveEnd),this.stateCenter.streamList.splice(n--,1));var s=this.makeCallbackStreamList(this.stateCenter.streamList);o.ClientUtil.actionSuccessCallback("login",this.stateCenter.callbackList)(s)}},e.prototype.onPublishStateUpdate=function(e,t,r){},e.prototype.updateStreamInfo=function(e,t,r,i){var o=this;void 0===r&&(r=""),this.logger.debug("zb.sh.usi call");var n={stream_id:e,extra_info:r},s={sub_cmd:t,stream_msg:JSON.stringify(n)};this.socketCenter.registerRouter("stream",(function(e){o.handleStreamUpdateRsp(e)})),this.socketCenter.sendMessage("stream",s,void 0,i),this.logger.info("zb.sh.usi call success cmd "+t)},e.prototype.handleStreamUpdateRsp=function(e){if(this.stateCenter.isLogin())if(0==e.body.err_code){this.logger.info("zb.sh.hsur stream seq "+this.stateCenter.streamSeq+" server seq "+e.body.stream_seq),this.stateCenter.streamSeq=e.body.stream_seq;for(var t=0;t<e.body.stream_info.length;t++){var r=e.body.stream_info[t].stream_id;if(!this.stateCenter.publishStreamList[r])return void this.logger.info("hsur.0 stream is not exist");this.stateCenter.publishStreamList[r].state==i.ENUM_PUBLISH_STREAM_STATE.update_info&&(this.stateCenter.publishStreamList[r].state=i.ENUM_PUBLISH_STREAM_STATE.publishing,this.onPublishStateUpdate(0,r,0))}}else this.logger.error("zb.sh.hsur stream update error "+e.body.err_code);else this.logger.error("zb.sh.hsur not login")},e.prototype.handleFetchStreamListRsp=function(e){this.logger.info("zb.sh.hfslr call"),this.stateCenter.streamQuerying=!1,0===e.body.err_code?this.stateCenter.streamSeq!==e.body.stream_seq?(this.handleFullUpdateStream(e.body.stream_seq,e.body.stream_info),this.logger.debug("zb.sh.hfslr call success")):this.logger.info("zb.sh.hfslr same seq"):this.logger.info("zb.sh.hfslr server error=",e.body.err_code)},e.prototype.handleFullUpdateStream=function(e,t){var r=this;this.logger.debug("zb.sh.hfus call"),this.stateCenter.streamSeq=e,this.logger.debug("zb.sh.hfus server seq "+this.stateCenter.streamSeq),o.ClientUtil.mergeStreamList(this.logger,this.stateCenter.idName,this.stateCenter.streamList,t,(function(e,t,o){0!==e.length&&(r.logger.debug("zb.sh.hfus callback addstream"),r.onStreamUpdated(i.ENUM_STREAM_UPDATE_TYPE.added,r.makeCallbackStreamList(e))),0!==t.length&&(r.logger.debug("zb.sh.hfus callback delstream"),r.onStreamUpdated(i.ENUM_STREAM_UPDATE_TYPE.deleted,r.makeCallbackStreamList(t))),0!==o.length&&(r.logger.debug("zb.sh.hfus callback updatestream"),r.onStreamExtraInfoUpdated(r.makeCallbackStreamList(o)))})),this.logger.info("zb.sh.hfus call success")},e.prototype.handlePushStreamUpdateMsg=function(e){if(this.logger.info("zb.sh.hpsum call"),e.body.stream_info&&0!==e.body.stream_info.length){if(e.body.stream_info.length+this.stateCenter.streamSeq!==e.body.stream_seq)return this.logger.info("zb.sh.hpsum call updatestream"),void this.fetchStreamList();switch(this.stateCenter.streamSeq=e.body.stream_seq,e.body.stream_cmd){case i.ENUM_STREAM_UPDATE_CMD.added:this.handleAddedStreamList(e.body.stream_info);break;case i.ENUM_STREAM_UPDATE_CMD.deleted:this.handleDeletedStreamList(e.body.stream_info);break;case i.ENUM_STREAM_UPDATE_CMD.updated:this.handleUpdatedStreamList(e.body.stream_info)}this.logger.info("zb.sh.hpsum call success")}else this.logger.info("zb.sh.hpsum, emtpy list")},e.prototype.handleAddedStreamList=function(e){this.logger.debug("zb.sh.hasl call");for(var t,r=[],o=0;o<e.length;o++)if(e[o].anchor_id_name!=this.stateCenter.idName){t=!1;for(var n=0;n<this.stateCenter.streamList.length;n++)if(e[o].stream_id===this.stateCenter.streamList[n].stream_id){t=!0;break}t||r.push(e[o])}else this.logger.debug("hdsl.0 have self stream added");if(0!==r.length){this.logger.debug("zb.sh.hasl callback addstream");for(var s=0;s<r.length;s++)this.stateCenter.streamList.push(r[s]);this.onStreamUpdated(i.ENUM_STREAM_UPDATE_TYPE.added,this.makeCallbackStreamList(r))}this.logger.info("zb.sh.hasl call success")},e.prototype.handleDeletedStreamList=function(e){this.logger.debug("zb.sh.hdsl call");for(var t=[],r=0;r<e.length;r++)if(e[r].anchor_id_name!=this.stateCenter.idName){for(var o=this.stateCenter.streamList.length-1;o>=0;o--)if(e[r].stream_id===this.stateCenter.streamList[o].stream_id){this.stateCenter.streamList.splice(o,1),t.push(e[r]);break}}else this.logger.debug("zb.sh.hdsl have self stream deleted");0!==t.length&&(this.logger.debug("zb.sh.hdsl callback delstream"),this.onStreamUpdated(i.ENUM_STREAM_UPDATE_TYPE.deleted,this.makeCallbackStreamList(t))),this.logger.info("zb.sh.hdsl call")},e.prototype.handleUpdatedStreamList=function(e){this.logger.debug("zb.sh.husl call");for(var t=[],r=0;r<e.length;r++)if(e[r].anchor_id_name!=this.stateCenter.idName){for(var i=0;i<this.stateCenter.streamList.length;i++)if(e[r].stream_id===this.stateCenter.streamList[i].stream_id){e[r].extra_info!==this.stateCenter.streamList[i].extra_info&&(this.stateCenter.streamList[i]=e[r],t.push(e[r]));break}}else this.logger.debug("hsul.0 have self stream updated");0!==t.length&&(this.logger.debug("zb.sh.husl callback updatestream"),this.onStreamExtraInfoUpdated(this.makeCallbackStreamList(t))),this.logger.info("zb.sh.husl call success")},e.prototype.fetchStreamList=function(){this.logger.info("zb.sh.fsl call"),this.stateCenter.isLogin()?this.stateCenter.streamQuerying?this.logger.info("zb.sh.fsl already doing"):(this.stateCenter.streamQuerying=!0,this.logger.debug("zb.sh.fsl send fetch request"),this.socketCenter.registerRouter("stream_info",this.handleFetchStreamListRsp.bind(this)),this.socketCenter.sendMessage("stream_info",{reserve:0}),this.logger.debug("zb.sh.fsl call success")):this.logger.info("zb.sh.fsl state error")},e.prototype.makeCallbackStreamList=function(e){var t=[];if(e&&e.length>0)for(var r=0;r<e.length;r++){var i={anchor_id_name:e[r].anchor_id_name,stream_gid:e[r].stream_gid,anchor_nick_name:e[r].anchor_nick_name,extra_info:e[r].extra_info,stream_id:e[r].stream_id,urls_flv:"",urls_rtmp:"",urls_hls:"",urls_https_flv:"",urls_https_hls:""};this.setCDNInfo(i,e[r]),t.push(i)}return t},e.prototype.updateMixStream=function(e,t,r){var n=this;if(this.logger.info("zb.sh.ums call"),null==e.outputStreamId&&null==e.outputUrl)return this.logger.error("zb.sh.ums no mix stream info"),!1;if(0==e.streamList.length)return this.logger.error("zb.sh.ums no input stream"),!1;var s={id_name:this.stateCenter.idName,live_channel:this.stateCenter.roomid,appid:this.stateCenter.appid,version:i.PROTO_VERSION};"string"==typeof e.userData&&e.userData.length<=1e4&&(s.UserData=e.userData);for(var a=[],c=0;c<e.streamList.length;c++){var d=e.streamList[c],l=d.streamId;this.stateCenter.testEnvironment&&(l="zegotest-"+this.stateCenter.appid+"-"+d.streamId),a.push({stream_id:l,rect:{layer:c,top:d.top,left:d.left,bottom:d.bottom,right:d.right}})}s.MixInput=a;var h={};if(null!=e.outputStreamId?this.stateCenter.testEnvironment?h.stream_id="zegotest-"+this.stateCenter.appid+"-"+e.outputStreamId:h.stream_id=e.outputStreamId:null!=e.outputUrl&&(h.mixurl=e.outputUrl),!e.outputBitrate)return this.logger.error("zb.sh.ums no bitrate param"),!1;if(h.bitrate=e.outputBitrate,!e.outputFps)return this.logger.error("zb.sh.ums no fps param"),!1;if(h.fps=e.outputFps,!e.outputWidth)return this.logger.error("zb.sh.ums no width param"),!1;if(h.width=e.outputWidth,!e.outputHeight)return this.logger.error("zb.sh.ums no height param"),!1;if(h.height=e.outputHeight,e.outputAudioConfig&&(h.audio_enc_id=e.outputAudioConfig),e.outputAudioBitrate&&(h.audio_bitrate=e.outputAudioBitrate),e.outputAudioChannels&&(h.audio_channel_cnt=e.outputAudioChannels),e.outputBgColor){if("number"!=typeof e.outputBgColor)return this.logger.error("zb.sh.ums param outputBgColor error"),!1;s.output_bg_color=e.outputBgColor}if(e.outputBgImage){if("string"!=typeof e.outputBgImage||!e.outputBgImage.startsWith("preset-id://"))return this.logger.error("zb.sh.ums param outputBgImage error"),!1;s.output_bg_image=e.outputBgImage}this.stateCenter.testEnvironment?h.testenv=1:h.testenv=0,s.MixOutput=[h],e.extraParams&&(s.extra_params=e.extraParams);var u={channel:"zeus",cmd:"start_mix",req_body:JSON.stringify(s)};return this.logger.debug("zb.sh.ums send command"),this.socketCenter.sendMessage("biz_channel",u,(function(s,a,c){n.logger.debug("zb.sh.ums receive message");var d="zegotest-"+n.stateCenter.appid+"-";if(0!=c.length){for(var l=JSON.parse(c),h=[],u=e.outputStreamId,p=0;p<l.play.length;p++){var g={rtmpUrls:null,hlsUrls:null,flvUrls:null};n.stateCenter.testEnvironment&&u&&u.startsWith(d)&&(u=u.slice(d.length)),l.play[p].rtmp_url&&l.play[p].rtmp_url.length>0&&(g.rtmpUrls=[l.play[p].rtmp_url]),l.play[p].hls_url&&l.play[p].hls_url.length>0&&(g.hlsUrls=[l.play[p].hls_url]),l.play[p].hdl_url&&l.play[p].hdl_url.length>0&&(g.flvUrls=[l.play[p].hdl_url]),h.push(g)}t&&t(u,h)}else r&&r(o.ClientUtil.getServerError(i.MIXSTREAM_ERROR_CODE+1))}),(function(e,t,s){if("number"==typeof e){n.logger.debug("zb.sh.ums error: "+e);var a=[];if(1000000150==e&&0!=s.length)for(var c=JSON.parse(s),d="zegotest-"+n.stateCenter.appid+"-",l=0;l<c.non_exist_streams.length;l++){var h=c.non_exist_streams[l];n.stateCenter.testEnvironment&&h.startsWith(d)?a.push(h.slice(d.length)):a.push(h)}r&&r(o.ClientUtil.getServerError(i.MIXSTREAM_ERROR_CODE+e),a)}else n.logger.debug("zb.sh.ums error code "+e.code),r&&r(e)})),!0},e.prototype.publishTarget=function(e,t,r){var s=this;if(e.type&&-1!=["addpush","delpush","clearpush"].indexOf(e.type))if(this.logger.info("zb.sh.ptcall"),e.streamId&&"string"==typeof e.streamId)if(e.pushUrl&&"string"==typeof e.pushUrl)if(e.appSecret&&"string"==typeof e.appSecret)if(this.stateCenter.publishStreamList[e.streamId]){var a=Math.ceil((new Date).getTime()/1e3),c=e.streamId;this.stateCenter.testEnvironment&&(c="zegotest-"+this.stateCenter.appid+"-"+e.streamId);var d={appid:this.stateCenter.appid,biz_type:0,timestamp:a,signature:n(this.stateCenter.appid.toString()+a.toString()+e.appSecret),seq:this.stateCenter.cdnSeq++,version:1*i.PROTO_VERSION,stream_id:c,pushurl:e.pushUrl},l={channel:"media",cmd:e.type,req_body:JSON.stringify(d)};this.logger.debug("zb.sh.pt send command"),this.socketCenter.sendMessage("biz_channel",l,(function(n,a,c){if(s.logger.debug("zb.sh.pt receive message"),0!=c.length){var d=JSON.parse(c),l=d.code,h=d.message;if(l&&0!=l)return s.logger.error("zb.sh.pt "+e.type+" error code: "+l+" "+h),void(r&&r({code:l,message:h}));s.logger.info("zb.sh.pt "+e.type+" success"),t&&t()}else r&&r(o.ClientUtil.getServerError(i.MIXSTREAM_ERROR_CODE+1))}),(function(e,t,i){s.logger.debug("zb.sh.pt error: "+r);var o="";2001==e?o="invalid channel":2002==e&&(o="bizchannel error"),r&&r({code:e,message:o})}))}else this.logger.error("zb.sh.pt publish stream no found");else this.logger.error("zb.sh.pt appSecret error");else this.logger.error("zb.sh.pt pushurl error");else this.logger.error("zb.sh.pt streamid error");else this.logger.error("zb.sh.pt cdn push type error")},e.prototype.stopMixStream=function(e,t,r){if(this.logger.info("zb.sh.sms call"),null==e.outputStreamId&&null==e.outputUrl)return this.logger.error("zb.sh.sms outputStreamId and outputUrl at least one "),!1;var n={id_name:this.stateCenter.idName,live_channel:this.stateCenter.roomid,appid:this.stateCenter.appid,version:i.PROTO_VERSION};null!=e.outputStreamId?this.stateCenter.testEnvironment?n.stream_id="zegotest-"+this.stateCenter.appid+"-"+e.outputStreamId:n.stream_id=e.outputStreamId:null!=e.outputUrl&&(n.mixurl=e.outputUrl);var s={channel:"zeus",cmd:"stop_mix",req_body:JSON.stringify(n)};return this.socketCenter.sendMessage("biz_channel",s,(function(e,r){t&&t()}),(function(e,t){"number"==typeof e?r&&r(o.ClientUtil.getServerError(i.MIXSTREAM_ERROR_CODE+e)):r&&r(e)})),!0},e.prototype.updateStreamExtraInfo=function(e,t){return this.logger.info("zb.sh.usei call"),e?"string"==typeof t&&(this.stateCenter.publishStreamList[e]&&(this.stateCenter.publishStreamList[e].extra_info=t,this.stateCenter.publishStreamList[e].state>=i.ENUM_PUBLISH_STREAM_STATE.update_info&&this.updateStreamInfo(e,i.ENUM_STREAM_SUB_CMD.liveUpdate,t)),!0):(this.logger.error("zb.sh.usei param error"),!1)},e}();t.StreamHandler=s},function(e,t,r){var i;!function(o){"use strict";function n(e,t){var r=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(r>>16)<<16|65535&r}function s(e,t,r,i,o,s){return n(function(e,t){return e<<t|e>>>32-t}(n(n(t,e),n(i,s)),o),r)}function a(e,t,r,i,o,n,a){return s(t&r|~t&i,e,t,o,n,a)}function c(e,t,r,i,o,n,a){return s(t&i|r&~i,e,t,o,n,a)}function d(e,t,r,i,o,n,a){return s(t^r^i,e,t,o,n,a)}function l(e,t,r,i,o,n,a){return s(r^(t|~i),e,t,o,n,a)}function h(e,t){var r,i,o,s,h;e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;var u=1732584193,p=-271733879,g=-1732584194,f=271733878;for(r=0;r<e.length;r+=16)p=l(p=l(p=l(p=l(p=d(p=d(p=d(p=d(p=c(p=c(p=c(p=c(p=a(p=a(p=a(p=a(o=p,g=a(s=g,f=a(h=f,u=a(i=u,p,g,f,e[r],7,-680876936),p,g,e[r+1],12,-389564586),u,p,e[r+2],17,606105819),f,u,e[r+3],22,-1044525330),g=a(g,f=a(f,u=a(u,p,g,f,e[r+4],7,-176418897),p,g,e[r+5],12,1200080426),u,p,e[r+6],17,-1473231341),f,u,e[r+7],22,-45705983),g=a(g,f=a(f,u=a(u,p,g,f,e[r+8],7,1770035416),p,g,e[r+9],12,-1958414417),u,p,e[r+10],17,-42063),f,u,e[r+11],22,-1990404162),g=a(g,f=a(f,u=a(u,p,g,f,e[r+12],7,1804603682),p,g,e[r+13],12,-40341101),u,p,e[r+14],17,-1502002290),f,u,e[r+15],22,1236535329),g=c(g,f=c(f,u=c(u,p,g,f,e[r+1],5,-165796510),p,g,e[r+6],9,-1069501632),u,p,e[r+11],14,643717713),f,u,e[r],20,-373897302),g=c(g,f=c(f,u=c(u,p,g,f,e[r+5],5,-701558691),p,g,e[r+10],9,38016083),u,p,e[r+15],14,-660478335),f,u,e[r+4],20,-405537848),g=c(g,f=c(f,u=c(u,p,g,f,e[r+9],5,568446438),p,g,e[r+14],9,-1019803690),u,p,e[r+3],14,-187363961),f,u,e[r+8],20,1163531501),g=c(g,f=c(f,u=c(u,p,g,f,e[r+13],5,-1444681467),p,g,e[r+2],9,-51403784),u,p,e[r+7],14,1735328473),f,u,e[r+12],20,-1926607734),g=d(g,f=d(f,u=d(u,p,g,f,e[r+5],4,-378558),p,g,e[r+8],11,-2022574463),u,p,e[r+11],16,1839030562),f,u,e[r+14],23,-35309556),g=d(g,f=d(f,u=d(u,p,g,f,e[r+1],4,-1530992060),p,g,e[r+4],11,1272893353),u,p,e[r+7],16,-155497632),f,u,e[r+10],23,-1094730640),g=d(g,f=d(f,u=d(u,p,g,f,e[r+13],4,681279174),p,g,e[r],11,-358537222),u,p,e[r+3],16,-722521979),f,u,e[r+6],23,76029189),g=d(g,f=d(f,u=d(u,p,g,f,e[r+9],4,-640364487),p,g,e[r+12],11,-421815835),u,p,e[r+15],16,530742520),f,u,e[r+2],23,-995338651),g=l(g,f=l(f,u=l(u,p,g,f,e[r],6,-198630844),p,g,e[r+7],10,1126891415),u,p,e[r+14],15,-1416354905),f,u,e[r+5],21,-57434055),g=l(g,f=l(f,u=l(u,p,g,f,e[r+12],6,1700485571),p,g,e[r+3],10,-1894986606),u,p,e[r+10],15,-1051523),f,u,e[r+1],21,-2054922799),g=l(g,f=l(f,u=l(u,p,g,f,e[r+8],6,1873313359),p,g,e[r+15],10,-30611744),u,p,e[r+6],15,-1560198380),f,u,e[r+13],21,1309151649),g=l(g,f=l(f,u=l(u,p,g,f,e[r+4],6,-145523070),p,g,e[r+11],10,-1120210379),u,p,e[r+2],15,718787259),f,u,e[r+9],21,-343485551),u=n(u,i),p=n(p,o),g=n(g,s),f=n(f,h);return[u,p,g,f]}function u(e){var t,r="",i=32*e.length;for(t=0;t<i;t+=8)r+=String.fromCharCode(e[t>>5]>>>t%32&255);return r}function p(e){var t,r=[];for(r[(e.length>>2)-1]=void 0,t=0;t<r.length;t+=1)r[t]=0;var i=8*e.length;for(t=0;t<i;t+=8)r[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return r}function g(e){var t,r,i="0123456789abcdef",o="";for(r=0;r<e.length;r+=1)t=e.charCodeAt(r),o+=i.charAt(t>>>4&15)+i.charAt(15&t);return o}function f(e){return unescape(encodeURIComponent(e))}function m(e){return function(e){return u(h(p(e),8*e.length))}(f(e))}function v(e,t){return function(e,t){var r,i,o=p(e),n=[],s=[];for(n[15]=s[15]=void 0,16<o.length&&(o=h(o,8*e.length)),r=0;r<16;r+=1)n[r]=909522486^o[r],s[r]=1549556828^o[r];return i=h(n.concat(p(t)),512+8*t.length),u(h(s.concat(i),640))}(f(e),f(t))}function y(e,t,r){return t?r?v(t,e):function(e,t){return g(v(e,t))}(t,e):r?m(e):function(e){return g(m(e))}(e)}void 0===(i=function(){return y}.call(t,r,t,e))||(e.exports=i)}()},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=r(0),o=r(1),n=function(){function e(e,t,r){this.logger=e,this.socketCenter=r,this.stateCenter=t}return e.prototype.resetHeartbeat=function(){this.logger.debug("zb.hb.rht call"),this.stateCenter.heartbeatTimer&&clearTimeout(this.stateCenter.heartbeatTimer),this.stateCenter.heartbeatTimer=null,this.stateCenter.tryHeartbeatCount=0,this.logger.debug("zb.hb.rht call success")},e.prototype.hbLogout=function(e){},e.prototype.start=function(e){var t=this;if(this.logger.debug("zb.hb.sht call"),this.stateCenter.isLogin()){if(++this.stateCenter.tryHeartbeatCount>3)return this.logger.error("zb.hb.sht come to try limit"),void this.hbLogout(i.sdkErrorList.HEARTBEAT_TIMEOUT);this.logger.debug("zb.hb.sht send packet"),this.socketCenter.registerRouter("hb",(function(e){t.handleHeartbeatRsp(e)})),this.socketCenter.sendMessage("hb",{reserve:0}),this.logger.debug("zb.hb.sht call success"),this.stateCenter.heartbeatInterval=e,this.stateCenter.heartbeatTimer=setTimeout((function(){t.start(t.stateCenter.heartbeatInterval)}),this.stateCenter.heartbeatInterval)}else this.logger.error("zb.hb.sht state error")},e.prototype.handleHeartbeatRsp=function(e){if(this.logger.debug("zb.hb.hhbr call"),0!==e.body.err_code)return this.logger.error("zb.hb.hhbr call disconnect, server error=",e.body.err_code),void this.hbLogout(o.ClientUtil.getServerError(e.body.err_code));for(var t in this.stateCenter.tryHeartbeatCount=0,this.stateCenter.heartbeatInterval=e.body.hearbeat_interval,this.stateCenter.heartbeatInterval<i.MINIUM_HEARTBEAT_INTERVAL&&(this.stateCenter.heartbeatInterval=i.MINIUM_HEARTBEAT_INTERVAL),e.body.bigim_time_window&&"number"==typeof e.body.bigim_time_window&&(this.stateCenter.bigimTimeWindow=e.body.bigim_time_window),e.body.dati_time_window&&"number"==typeof e.body.dati_time_window&&(this.stateCenter.datiTimeWindow=e.body.dati_time_window),this.ReliableMessageHandler(e),this.fetchStreamList(e),this.patchUserList(e),this.stateCenter.publishStreamList)this.stateCenter.publishStreamList[t].state==i.ENUM_PUBLISH_STREAM_STATE.update_info&&(this.logger.info("zb.hb.hhbr try to update stream info"),this.updateStreamInfo(t,i.ENUM_STREAM_SUB_CMD.liveBegin,this.stateCenter.publishStreamList[t].extra_info));null!=e.body.online_count&&0!=e.body.online_count&&this.onUpdateOnlineCount(this.stateCenter.roomid,e.body.online_count),this.logger.debug("zb.hb.hhbr call success")},e.prototype.ReliableMessageHandler=function(e){var t=this;if(e.body.trans_seqs)for(var r=0;r<e.body.trans_seqs.length;r++){var i=e.body.trans_seqs[r].trans_channel,o=e.body.trans_seqs[r].trans_seq_array;(o=o.filter((function(e){var r=e.trans_type,i=e.trans_seq;return!t.stateCenter.transSeqMap[r]||t.stateCenter.transSeqMap[r].seq!==i}))).length>0&&this.fetchReliableMessage(i,o)}},e.prototype.fetchReliableMessage=function(e,t){var r=this;this.logger.debug("zb.hb.frm call");var i={trans_channel:e,fetch_array:t};this.socketCenter.registerRouter("trans_fetch",(function(e){r.handleFetchTransRsp(e)})),this.socketCenter.sendMessage("trans_fetch",i),this.logger.debug("zb.hb.frm call success")},e.prototype.handleFetchTransRsp=function(e){var t=this;this.stateCenter.isLogin()?0==e.body.err_code?e.body.trans_fetch_results.forEach((function(e){var r=e.trans_type,i=e.trans_seq;t.stateCenter.transSeqMap[r]={seq:i},e.trans_user_idname!=t.stateCenter.idName&&e.trans_idname!=t.stateCenter.idName&&t.onRecvReliableMessage(r,i,e.trans_data),t.logger.debug("zb.hb.hftr trans "+r+" seq "+i)})):this.logger.error("zb.hb.hftr trans send error "+e.body.err_code):this.logger.error("zb.hb.hftr not login")},e.prototype.fetchStreamList=function(e){var t=this;e.body.stream_seq!==this.stateCenter.streamSeq&&(this.logger.debug("zb.hb.fsl current seq "+this.stateCenter.streamSeq+" server Seq "+e.body.stream_seq),this.logger.debug("zb.hb.fsl call"),this.stateCenter.isLogin()?this.stateCenter.streamQuerying?this.logger.warn("zb.hb.fsl already doing"):(this.stateCenter.streamQuerying=!0,this.logger.debug("zb.hb.fsl send fetch request"),this.socketCenter.registerRouter("stream_info",(function(e){t.handleFetchStreamListRsp(e)})),this.socketCenter.sendMessage("stream_info",{reserve:0}),this.logger.debug("zb.hb.fsl call success")):this.logger.error("zb.hb.fsl state error"))},e.prototype.patchUserList=function(e){var t=this;if(e.body.server_user_seq!==this.stateCenter.userSeq&&this.stateCenter.userStateUpdate&&!this.stateCenter.userSeqMergeMap){var r=this.stateCenter.lastUserQueryTime-Date.now();this.logger.info("zb.hb.hhbr call update user "+this.stateCenter.userSeq+" server "+e.body.server_user_seq+" wait "+r),r>0?(this.stateCenter.userQueryTimer&&clearTimeout(this.stateCenter.userQueryTimer),this.stateCenter.userQueryTimer=setTimeout((function(){t.fetchUserList()}),r)):this.fetchUserList()}},e.prototype.handleFetchStreamListRsp=function(e){},e.prototype.fetchUserList=function(){},e.prototype.updateStreamInfo=function(e,t,r,i){void 0===r&&(r="")},e.prototype.onUpdateOnlineCount=function(e,t){},e.prototype.onRecvReliableMessage=function(e,t,r){},e.prototype.resetCheckMessage=function(){this.logger.debug("zb.hb.rcm call"),clearTimeout(this.stateCenter.sendDataCheckTimer),this.stateCenter.sendDataCheckTimer=null,this.checkSendMessageList(this.stateCenter.sendDataList),this.checkSendMessageList(this.stateCenter.sendCommandList),this.stateCenter.sendDataMap={},this.stateCenter.sendCommandMap={},this.logger.debug("zb.hb.rcm call success")},e.prototype.checkSendMessageList=function(e){for(var t=e.getFirst();null!=t;)e.remove(t),t._data.error&&(t._data.data.body.custom_msg?t._data.error(i.sdkErrorList.SEND_MSG_TIMEOUT,t._data.data.header.seq,t._data.data.body.custom_msg):t._data.error(i.sdkErrorList.SEND_MSG_TIMEOUT,t._data.data.header.seq)),t=e.getFirst()},e.prototype.checkMessageListTimeout=function(e,t){for(var r=e.getFirst(),o=Date.parse(new Date+""),n=0,s=0,a=0;!(null==r||r._data.time+this.stateCenter.sendDataTimeout>o||(delete t[r._data.data.header.seq],e.remove(r),++s,null==r._data.error||this.stateCenter.sendDataDropTimeout>0&&r._data.time+this.stateCenter.sendDataDropTimeout<o?++a:r._data.data.body.custom_msg?r._data.error(i.sdkErrorList.SEND_MSG_TIMEOUT,r._data.data.header.seq,r._data.data.body.custom_msg):r._data.error(i.sdkErrorList.SEND_MSG_TIMEOUT,r._data.data.header.seq),++n>=this.stateCenter.sendDataCheckOnceCount));)r=e.getFirst();0==s&&0==a||this.logger.debug("zb.hb.cmt call success, stat: timeout=",s,"drop=",a)},e.prototype.startCheckMessageTimeout=function(){var e=this;this.stateCenter.isLogin()?(this.checkMessageListTimeout(this.stateCenter.sendDataList,this.stateCenter.sendDataMap),this.checkMessageListTimeout(this.stateCenter.sendCommandList,this.stateCenter.sendCommandMap),this.stateCenter.sendDataCheckTimer=setTimeout((function(){e.startCheckMessageTimeout()}),this.stateCenter.sendDataCheckInterval)):this.logger.error("zb.hb.scmt state error")},e}();t.HeartBeatHandler=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=r(0),o=r(1),n=function(){function e(e,t,r){this.logger=e,this.socketCenter=r,this.stateCenter=t}return e.prototype.sendCustomCommand=function(e,t,r,i){var n=this;if(this.logger.debug("zb.mh.scc call"),!this.stateCenter.isLogin())return this.logger.error("zb.mh.scc state error"),!1;if(!e)return this.logger.error("zb.mh.scc dstMembers error"),!1;var s={from_userid:this.stateCenter.idName,from_username:this.stateCenter.nickName,request_id:this.stateCenter.getRequestId(),custom_content:t||"",room_id:this.stateCenter.roomid},a={dest_id_name:e,custom_msg:JSON.stringify(s)};return o.ClientUtil.checkCustomCommandParam(a)?(this.socketCenter.registerRouter("custommsg",(function(e){n.handleSendCustomMsgRsp(e)})),this.socketCenter.sendCustomMessage("custommsg",a,r,i),this.logger.info("zb.mh.scc call success"),!0):(this.logger.info("zb.mh.scc param error"),!1)},e.prototype.handleSendCustomMsgRsp=function(e){this.logger.debug("zb.mh.hscmrcall");var t,r=this.stateCenter.sendDataMap[e.header.seq];null!=r?("custommsg"!=(t=r._data).data.header.cmd?this.logger.error("zb.mh.hscmrcmd wrong"+t.data.header.cmd):0===e.body.err_code?null!=t.success&&t.success(e.header.seq,t.data.body.custom_msg):null!=t.error&&t.error(o.ClientUtil.getServerError(e.body.err_code),e.header.seq,t.data.body.custom_msg),delete this.stateCenter.sendDataMap[e.header.seq],this.stateCenter.sendDataList.remove(r)):this.logger.error("zb.mh.hscmrno found seq="+e.header.seq),this.logger.debug("zb.mh.hscmr  call success")},e.prototype.handlePushCustomMsg=function(e){var t=JSON.parse(e.body.custommsg);this.logger.debug("zb.mh.hpcm submsg=",t),this.onRecvCustomCommand(t.from_userid,t.from_username,t.custom_content)},e.prototype.onRecvCustomCommand=function(e,t,r){},e.prototype.sendRoomMsg=function(e,t,r,o,n){var s=this;if(this.logger.debug("zb.mh.srm call"),this.stateCenter.isLogin()){var a=Date.parse(new Date+"");if(this.stateCenter.sendRoomMsgTime>0&&this.stateCenter.sendRoomMsgTime+this.stateCenter.SendRoomMsgInterval>a)return this.logger.info("zb.mh.srm freq error"),void(n&&n(i.sdkErrorList.FREQ_LIMITED,0,e,t,r));this.stateCenter.sendRoomMsgTime=a,this.logger.debug("zb.mh.srm send fetch request");var c={msg_category:e,msg_type:t,msg_content:r};this.socketCenter.registerRouter("im_chat",(function(e){s.handleSendRoomMsgRsp(e)})),this.socketCenter.sendCustomMessage("im_chat",c,o,n),this.logger.info("zb.mh.srm call success")}else this.logger.error("zb.mh.srm state error")},e.prototype.handleSendRoomMsgRsp=function(e){this.logger.debug("zb.mh.hsrmr call");var t,r=this.stateCenter.sendDataMap[e.header.seq];null!=r?("im_chat"!=(t=r._data).data.header.cmd?this.logger.error("zb.mh.hsrmr cmd wrong"+t.data.header.cmd):0===e.body.err_code?t.success&&t.success(e.header.seq,e.body.msg_id,t.data.body.msg_category,t.data.body.msg_type,t.data.body.msg_content):t.error&&t.error(o.ClientUtil.getServerError(e.body.err_code),e.header.seq,t.data.body.msg_category,t.data.body.msg_type,t.data.body.msg_content),delete this.stateCenter.sendDataMap[e.header.seq],this.stateCenter.sendDataList.remove(r)):this.logger.error("hzb.mh.hsrmr no found seq="+e.header.seq),this.logger.info("zb.mh.hsrmr call success")},e.prototype.onRecvRoomMsg=function(e,t,r){},e.prototype.sendReliableMessage=function(e,t,r,i){this.logger.debug("zb.mh.srirm call"),this.stateCenter.transSeqMap[e]||(this.stateCenter.transSeqMap[e]={seq:0});var o={trans_type:e,trans_data:t,trans_local_seq:this.stateCenter.transSeqMap[e].seq,trans_channel:"clt"};this.socketCenter.sendMessage("trans",o,r,i)},e.prototype.sendBigRoomMessage=function(e,t,r,i,o){var n=this;this.logger.debug("zb.mh.sbim call");var s=this.stateCenter.bigimTimeWindow,a=this.stateCenter.serverTimeOffset,c=(new Date).getTime()+a,d=(++this.stateCenter.cmdSeq).toString();if(null==i&&(i=null),null==o&&(o=null),this.stateCenter.bigImCallbackMap[d]={success:i,error:o},0==s){var l={msg_category:e,msg_type:t,msg_content:r,bigmsg_client_id:d};this.logger.debug("zb.mh.sbim no time window"),this.sendBigRoomMessageInternal([l],(function(e){n.handleBigImMsgRsp(e)}),o)}else{var h=Math.floor(c/s);if(this.logger.debug("currentIndex "+h+" lastTimeIndex "+this.stateCenter.bigImLastTimeIndex),this.stateCenter.bigImLastTimeIndex<h&&0==this.stateCenter.bigImMessageList.length){this.stateCenter.bigImLastTimeIndex=h;var u={msg_category:e,msg_type:t,msg_content:r,bigmsg_client_id:d};this.sendBigRoomMessageInternal([u],(function(e){n.handleBigImMsgRsp(e)}),o)}else this.stateCenter.bigImMessageList.push({msg_category:e,msg_type:t,msg_content:r,bigmsg_client_id:d}),1==this.stateCenter.bigImMessageList.length&&this.setBigImTimer(a,s)}},e.prototype.handlePushMergeMsg=function(e){if(this.stateCenter.isLogin()){for(var t=0;t<e.body.messages.length;t++)14001===e.body.messages[t].sub_cmd&&this.handlePushBigRooMsg(e.body.messages[t].msg_body);this.logger.debug("zb.mh.hpmm call success")}else this.logger.error("zb.mh.hpmmnot login")},e.prototype.handlePushBigRooMsg=function(e){var t;try{t=JSON.parse(e)}catch(e){return void this.logger.warn("zb.mh.hpbrm parse json error")}if(t){for(var r=t.room_id,i=[],o=0;o<t.msg_data.length;o++){var n=t.msg_data[o];n.id_name!=this.stateCenter.idName?i.push({idName:n.id_name,nickName:n.nick_name,messageId:n.bigmsg_id,category:n.msg_category,type:n.msg_type,content:n.msg_content,time:n.send_time}):this.logger.debug("zb.mh.hpbrm self message")}0==i.length?this.logger.debug("zb.mh.hpbrm no other pushData except self"):this.onRecvBigRoomMessage(i,r),this.logger.debug("zb.mh.hpbrm call success")}else this.logger.warn("zb.mh.hpbrm cann't find message body")},e.prototype.onRecvBigRoomMessage=function(e,t){},e.prototype.sendBigRoomMessageInternal=function(e,t,r){this.logger.debug("zb.mh.sbim call");var i={msgs:e};this.socketCenter.sendMessage("bigim_chat",i,t,r)},e.prototype.handleBigImMsgRsp=function(e){if(this.stateCenter.isLogin()){this.stateCenter.bigimTimeWindow!=e.body.bigim_time_window&&(this.stateCenter.bigimTimeWindow=e.body.bigim_time_window);for(var t=0;t<e.body.msgs.length;t++){var r=e.body.msgs[t].bigmsg_client_id,i=e.body.msgs[t].bigmsg_id;if(this.stateCenter.bigImCallbackMap[r]){var o=this.stateCenter.bigImCallbackMap[r].success;null!=o&&o(e.header.seq,i),delete this.stateCenter.bigImCallbackMap[r]}}}else this.logger.info("zb.mh.hbmr not login")},e.prototype.setBigImTimer=function(e,t){var r=this,i=t-((new Date).getTime()+e)%t,n=o.ClientUtil.generateRandumNumber(t)+i;this.logger.info("zb.mh.sbt setTimer "+n),this.stateCenter.bigImTimer=setTimeout((function(){r.onBigImTimer()}),n)},e.prototype.onBigImTimer=function(){var e=this,t=(new Date).getTime()+this.stateCenter.serverTimeOffset;this.stateCenter.bigImLastTimeIndex=Math.floor(t/this.stateCenter.bigimTimeWindow);for(var r=[],i=[],o=0;o<this.stateCenter.bigImMessageList.length&&!(o>=20);o++){var n=this.stateCenter.bigImMessageList[o];r.push({msg_category:n.msg_category,msg_type:n.msg_type,msg_content:n.msg_content,bigmsg_client_id:n.bigmsg_client_id}),i.push(n.bigmsg_client_id)}this.stateCenter.bigImMessageList.length>20?this.stateCenter.bigImMessageList.splice(0,20):this.stateCenter.bigImMessageList=[],this.sendBigRoomMessageInternal(r,(function(t){e.handleBigImMsgRsp(t)}),(function(t,r){for(var o=0;o<i.length;o++){var n=i[o],s=e.stateCenter.bigImCallbackMap[n];s&&(null!=s.error&&s.error(t,r),delete e.stateCenter.bigImCallbackMap[n])}})),clearTimeout(this.stateCenter.bigImTimer),this.stateCenter.bigImTimer=null,this.stateCenter.bigImMessageList.length>0&&this.setBigImTimer(this.stateCenter.serverTimeOffset,this.stateCenter.bigimTimeWindow)},e.prototype.sendRelayMessage=function(e,t,r,i){this.logger.debug("zb.mh.srm call");var o=this.stateCenter.datiTimeWindow,n=this.stateCenter.serverTimeOffset;o>0?(this.stateCenter.realyMessageList.push({type:e,data:t,success:r,error:i}),1==this.stateCenter.realyMessageList.length&&this.setRelayTimer(n,o)):this.sendRelayMessageInternal(e,t,r,i)},e.prototype.sendRelayMessageInternal=function(e,t,r,i){this.logger.debug("zb.mh.srmi call");var o={relay_type:e,relay_data:t};this.socketCenter.sendMessage("relay",o,r,i)},e.prototype.setRelayTimer=function(e,t){var r=this,i=2*t-((new Date).getTime()+e)%t,n=o.ClientUtil.generateRandumNumber(i);this.logger.info("zb.mh.srt setTimer "+n),this.stateCenter.relayTimer=setTimeout((function(){r.onRelayTimer()}),n)},e.prototype.onRelayTimer=function(){if(0!=this.stateCenter.realyMessageList.length){var e=this.stateCenter.realyMessageList[0];this.sendRelayMessageInternal(e.type,e.data,e.success,e.error),clearTimeout(this.stateCenter.relayTimer),this.stateCenter.relayTimer=null,this.stateCenter.realyMessageList.splice(0,1),this.stateCenter.realyMessageList.length>0&&this.setRelayTimer(this.stateCenter.serverTimeOffset,this.stateCenter.datiTimeWindow)}else this.logger.info("zb.mh.ort no relay data")},e.prototype.handlePushTransMsg=function(e){if(this.stateCenter.isLogin()){var t=e.body.trans_type,r=e.body.trans_seq;this.stateCenter.transSeqMap[t]?this.stateCenter.transSeqMap[t].seq=r:this.stateCenter.transSeqMap[t]={seq:r},e.body.trans_user_idname!=this.stateCenter.idName&&e.body.trans_idname!=this.stateCenter.idName?this.onRecvReliableMessage(t,r,e.body.trans_data):this.logger.debug("zb.mh.hptr receive self trans message"),this.logger.info("zb.mh.hptr trans "+t+" seq "+r)}else this.logger.error("zb.mh.hptr not login")},e.prototype.onRecvReliableMessage=function(e,t,r){},e}();t.MessageHandler=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=r(0),o=function(){function e(e,t,r){this.logger=e,this.socketCenter=r,this.stateCenter=t}return e.prototype.requestJoinLive=function(e,t,r,o){this.logger.debug("zb.lh.rjl call");var n=this.stateCenter.getRequestId(),s=this.stateCenter.getSignalCmdContent(n,e);return null!=o&&(this.stateCenter.joinLiveCallbackMap[n]=o,this.sendSignalCmd(i.ENUM_SIGNAL_SUB_CMD.joinLiveRequest,s,e,t,r),!0)},e.prototype.inviteJoinLive=function(e,t,r,o){this.logger.debug("zb.lh.ijl call");var n=this.stateCenter.getRequestId(),s=this.stateCenter.getSignalCmdContent(n,e);return null!=o&&(this.stateCenter.joinLiveCallbackMap[n]=o,this.sendSignalCmd(i.ENUM_SIGNAL_SUB_CMD.joinLiveInvite,s,e,t,r),!0)},e.prototype.endJoinLive=function(e,t,r){this.logger.debug("zb.lh.ejl call");var o=this.stateCenter.getRequestId(),n=this.stateCenter.getSignalCmdContent(o,e);return this.sendSignalCmd(i.ENUM_SIGNAL_SUB_CMD.joinLiveStop,n,e,t,r),!0},e.prototype.respondJoinLive=function(e,t,r,o){this.logger.debug("zb.lh.rpjl call");var n=this.stateCenter.joinLiveRequestMap[e];if(!n)return this.logger.info("zb.lh.rpjl no dest id name"),!1;var s=0;!0===t&&(s=1);var a=this.stateCenter.getSignalCmdContent(e,n,s);return this.sendSignalCmd(i.ENUM_SIGNAL_SUB_CMD.joinLiveResult,a,n,r,o),delete this.stateCenter.joinLiveRequestMap[e],!0},e.prototype.sendSignalCmd=function(e,t,r,i,o){if(this.logger.debug("zb.lh.ssc call"),this.stateCenter.isLogin()){this.logger.debug("zb.lh.ssc send signal cmd "+e);var n={sub_cmd:e,signal_msg:t,dest_id_name:[r]};this.socketCenter.sendMessage("signal",n,i,o),this.logger.info("zb.lh.ssc call success")}else this.logger.error("zb.lh.ssc state error")},e.prototype.handlePushSignalMsg=function(e){if(this.stateCenter.isLogin()){var t=JSON.parse(e.body.signal_msg);switch(this.logger.debug("zb.lh.hpcm hpsm= ",t),e.body.sub_cmd){case i.ENUM_PUSH_SIGNAL_SUB_CMD.pushJoinLiveRequest:this.handlePushJoinLiveRequestMsg(t);break;case i.ENUM_PUSH_SIGNAL_SUB_CMD.pushJoinLiveResult:this.handlePushJoinLiveResultMsg(t);break;case i.ENUM_PUSH_SIGNAL_SUB_CMD.pushJoinLiveInvite:this.handlePushJoinLiveInviteMsg(t);break;case i.ENUM_PUSH_SIGNAL_SUB_CMD.pushJoinLiveStop:this.handlePushJoinLiveStopMsg(t)}this.logger.debug("zb.lh.hpsm call end")}else this.logger.warn("zb.lh.hpsm not login")},e.prototype.handlePushJoinLiveRequestMsg=function(e){var t=e.request_id;if("string"==typeof t){var r=e.from_userid;"string"==typeof r?(this.stateCenter.joinLiveRequestMap[t]=r,this.logger.info("zb.lh.hpjlrm onRecvJoinLiveRequest "+r),this.onRecvJoinLiveRequest(t,e.from_userid,e.from_username,e.room_id)):this.logger.error("zb.lh.hpjlrm no from user")}else this.logger.error("zb.lh.hpjlrm no requestId")},e.prototype.onRecvJoinLiveRequest=function(e,t,r,i){},e.prototype.handlePushJoinLiveInviteMsg=function(e){var t=e.request_id;if("string"==typeof t){var r=e.from_userid;"string"==typeof r?(this.stateCenter.joinLiveRequestMap[t]=r,this.logger.info("zb.lh.hpjlim onRecvInviteJoinLiveRequest "+r),this.onRecvInviteJoinLiveRequest(t,e.from_userid,e.from_username,e.room_id)):this.logger.error("zb.lh.hpjlim no from user")}else this.logger.error("zb.lh.hpjlim no requestId")},e.prototype.onRecvInviteJoinLiveRequest=function(e,t,r,i){},e.prototype.handlePushJoinLiveResultMsg=function(e){var t=e.request_id;if("string"==typeof t){var r=e.result;if(null!=r){var i=1==r;if(this.stateCenter.joinLiveCallbackMap[t]){var o=this.stateCenter.joinLiveCallbackMap[t];if(!o)return void this.logger.info("hpjlrm.o no callback");this.logger.info("zb.lh.hpjlrm joinLiveRequest/invite result "+i),delete this.stateCenter.joinLiveCallbackMap[t],o(i,e.from_userid,e.from_username)}}else this.logger.info("zb.lh.hpjlrm no result")}else this.logger.error("zb.lh.hpjlrm no requestId")},e.prototype.handlePushJoinLiveStopMsg=function(e){var t=e.request_id;"string"==typeof t?(this.logger.info("zb.lh.hpjlsm onRecvEndJoinLiveCommand "+e.from_userid),this.onRecvEndJoinLiveCommand(t,e.from_userid,e.from_username,e.room_id)):this.logger.error("zb.lh.hpjlsm no requestId")},e.prototype.onRecvEndJoinLiveCommand=function(e,t,r,i){},e}();t.LiveHandler=o},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=r(0),o=r(2),n=function(){function e(){this.testEnvironment=!1,this.third_token="",this.pullLimited=!0,this.configOK=!1,this.roomCreateFlag=1,this.runState=i.ENUM_RUN_STATE.logout,this.lastRunState=i.ENUM_RUN_STATE.logout,this.callbackList={},this.streamList=[],this.publishStreamList={},this.userQuerying=!1,this.userTempList=[],this.userSeq=0,this.userSeqMergeMap=null,this.userSeqMergeTimer=null,this.userQueryTimer=null,this.lastUserQueryTime=0,this.userListInterval=3e4,this.userListMergeInterval=5e3,this.anchor_info={anchor_id:"",anchor_id_name:"",anchor_nick_name:""},this.deviceInfos=null,this.deviceChangeTimer=null,this.deviceStateOut=!1,this.sendCommandMap={},this.sendCommandList=new i.LinkedList,this.sendDataMap={},this.sendDataList=new i.LinkedList,this.joinLiveCallbackMap={},this.joinLiveRequestMap={},this.streamUrlMap={},this.cmdCallback={},this.transSeqMap={},this.realyMessageList=[],this.relayTimer=null,this.bigImLastTimeIndex=0,this.bigIMmessageList=[],this.bigImCallbackMap={},this.bigImTimer=null,this.serverTimeOffset=0,this.datiTimeWindow=0,this.bigimTimeWindow=0,this.bigImMessageList=[],this.screenShotStreamList=[],this.tryLoginCount=0,this.tryLoginTimer=null,this.heartbeatTimer=null,this.sendDataCheckTimer=null,this.sendDataCheckInterval=2e3,this.sendDataTimeout=5e3,this.sendDataDropTimeout=1e4,this.sendDataCheckOnceCount=100,this.sendRoomMsgTime=0,this.SendRoomMsgInterval=500,this.cmdSeq=0,this.audioEffectBuffer={},this.audioBitRate=48e3,this.cdnSeq=0}return e.prototype.isLogin=function(){return this.runState===i.ENUM_RUN_STATE.login},e.prototype.getRequestId=function(){return this.idName+"-"+o.getSeq()},e.prototype.getSignalCmdContent=function(e,t,r){var i={request_id:e,room_id:this.roomid,from_userid:this.idName,from_username:this.nickName,to_userid:t};return null!=r&&(i.result=r),JSON.stringify(i)},e}();t.StateCenter=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=r(1),o=function(){function e(e){var t=e.type,r=e.channels,i=void 0===r?1:r,o=e.bufferSize,n=void 0===o?0:o,s=e.sampleBit,a=void 0===s?16:s,c=e.sampleRate,d=void 0===c?44100:c,l=this;this.instant=0,this.slow=0,this.clip=0;var h=new("undefined"!=typeof webkitAudioContext?webkitAudioContext:AudioContext);this.context=h,this.type=t,this.channels=i,this.bufferSize=n,this.sampleBit=a,this.sampleRate=d,this.script=h.createScriptProcessor(n,i,i),(new Date).getTime(),this.script.addEventListener("audioprocess",(function(e){var r,i=e.inputBuffer.getChannelData(0),o=0,n=0;for(r=0;r<i.length;++r)o+=i[r]*i[r],Math.abs(i[r])>.99&&(n+=1);if(l.instant=Math.sqrt(o/i.length),l.slow=.95*l.slow+.05*l.instant,l.clip=n/i.length,"pcm"===t||"wav"===t){for(var s=[],a=0;a<l.channels;a++)s.push(e.inputBuffer.getChannelData(a));l.recorderBuffer(s)}})),"pcm"!==t&&"wav"!==t||this.initRecorderBuffer(t)}return e.prototype.connectToSource=function(e,t){console.log("SoundMeter connecting");try{this.mic=this.context.createMediaStreamSource(e),this.mic.connect(this.script),this.script.connect(this.context.destination),void 0!==t&&t(null)}catch(e){console.error(e),void 0!==t&&t(e)}return this},e.prototype.recorderBuffer=function(e){this.worker.postMessage({command:"record",val:e})},e.prototype.initRecorderBuffer=function(e){var t=this;this.worker=i.ClientUtil.inlineWorker((function(){var e,t,r,i,o,n,s=[],a=this;function c(t){var r,i;if(1==e)r=l(s[0],o,s),1!=t&&(i=d(t,r));else if(2==e){var n=l(s[0],o,s),a=l(s[1],o,s);1!=t?i=h(d(t,n),d(t,a)):r=h(n,a)}return 1!=t?i:r}function d(e,t){for(var r=new Float32Array(t.length/e),i=0,o=0;i<r.length;)r[i]=t[o],o+=e,i++;return r}function l(e,t,r){for(var i=new Float32Array(t*e.length),o=0,n=0;n<r[0].length;n++)i.set(r[0][n],o),o+=r[0][n].length;return i}function h(e,t){for(var r=new Float32Array(e.length+t.length),i=0;i<e.length+t.length;i+=2)r[i]=e[i/2>>0],r[i+1]=t[i/2>>0];return r}function u(e,t,r){for(var i=0;i<r.length;i++)e.setUint8(t+i,r.charCodeAt(i))}function p(e,t,r){for(var i=0;i<r.length;i++,t+=2){var o=Math.max(-1,Math.min(1,r[i]));e.setInt16(t,o<0?32768*o:32767*o,!0)}}function g(e,t,r){for(var i=0;i<r.length;i++,t++){var o=Math.max(-1,Math.min(1,r[i])),n=o<0?128*o:127*o;n+=128,e.setInt8(t,n)}}this.onmessage=function(d){switch(d.data.command){case"init":l=d.data.val,e=l.sampleChannel,t=l.sampleBit,r=l.sampleRate,i=l.oldSampleRate,o=l.bufferSize,n=l.type;break;case"record":!function(o){for(var d=0;d<e;d++)s[d]||(s[d]=[]),s[d].push(o[d]);var l=Math.round(i/r);"pcm"===n?function(e){var r=function(e,r){var i;8==r?i=e.length:16==r&&(i=e.length,i*=2);var o=new ArrayBuffer(i),n=new DataView(o);return 8==r?g(n,0,e):16==t&&p(n,0,e),n}(c(e),t);a.postMessage({command:"exportPcmLive",val:r})}(l):"wav"===n&&function(i){var o=function(i,o){var n;8==o?n=i.length:16==t&&(n=i.length,n*=2);var s=new ArrayBuffer(n+44),a=new DataView(s),c=r,d=t,l=e;return u(a,0,"RIFF"),a.setUint32(4,36+n,!0),u(a,8,"WAVE"),u(a,12,"fmt "),a.setUint32(16,16,!0),a.setUint16(20,1,!0),a.setUint16(22,l,!0),a.setUint32(24,c,!0),a.setUint32(28,c*l*(d/8),!0),a.setUint16(32,l*(d/8),!0),a.setUint16(34,d,!0),u(a,36,"data"),a.setUint32(40,n,!0),8==t?g(a,44,i):16==t&&p(a,44,i),a}(c(i),t);a.postMessage({command:"exportWav",val:o})}(l),s=[]}(d.data.val)}var l}})),this.worker.postMessage({command:"init",val:{sampleChannel:this.channels,sampleBit:this.sampleBit,sampleRate:this.sampleRate,oldSampleRate:this.context.sampleRate,bufferSize:this.bufferSize,type:e}}),this.worker.onmessage=function(e){switch(e.data.command){case"exportPcmLive":t.onReceiveBuffer(e.data.val);break;case"exportWav":t.onReceiveWav(e.data.val)}}},e.prototype.onReceiveBuffer=function(e){},e.prototype.onReceiveWav=function(e){},e.prototype.writeString=function(e,t,r){for(var i=0;i<r.length;i++)e.setUint8(t+i,r.charCodeAt(i))},e.prototype.writeBuffer=function(e,t,r){for(var i=0;i<r.byteLength;i++)e.setUint8(t+i,r[i])},e.prototype.concatenation=function(e){for(var t=0,r=0;r<e.length;++r)t+=e[r].buffer.byteLength;var i=new Uint8Array(t),o=0;for(r=0;r<e.length;++r)i.set(new Uint8Array(e[r].buffer),o),o+=e[r].buffer.byteLength;return i},e.prototype.encodeWave=function(e){var t=this.concatenation(e),r=t.byteLength,i=new ArrayBuffer(r+44),o=new DataView(i),n=this.sampleRate,s=this.sampleBit,a=this.channels;return this.writeString(o,0,"RIFF"),o.setUint32(4,36+r,!0),this.writeString(o,8,"WAVE"),this.writeString(o,12,"fmt "),o.setUint32(16,16,!0),o.setUint16(20,1,!0),o.setUint16(22,a,!0),o.setUint32(24,n,!0),o.setUint32(28,n*a*(s/8),!0),o.setUint16(32,a*(s/8),!0),o.setUint16(34,s,!0),this.writeString(o,36,"data"),o.setUint32(40,r,!0),this.writeBuffer(o,44,t),o},e.prototype.stop=function(){this.mic.disconnect(),this.script.disconnect()},e}();t.MediaUtil=o}])},function(e,t,r){"use strict";r.r(t),r.d(t,"v1",(function(){return p})),r.d(t,"v3",(function(){return _})),r.d(t,"v4",(function(){return T})),r.d(t,"v5",(function(){return L}));var i="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto),o=new Uint8Array(16);function n(){if(!i)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return i(o)}for(var s=[],a=0;a<256;++a)s.push((a+256).toString(16).substr(1));var c,d,l=function(e,t){var r=t||0;return(s[e[r+0]]+s[e[r+1]]+s[e[r+2]]+s[e[r+3]]+"-"+s[e[r+4]]+s[e[r+5]]+"-"+s[e[r+6]]+s[e[r+7]]+"-"+s[e[r+8]]+s[e[r+9]]+"-"+s[e[r+10]]+s[e[r+11]]+s[e[r+12]]+s[e[r+13]]+s[e[r+14]]+s[e[r+15]]).toLowerCase()},h=0,u=0;var p=function(e,t,r){var i=t&&r||0,o=t||new Array(16),s=(e=e||{}).node||c,a=void 0!==e.clockseq?e.clockseq:d;if(null==s||null==a){var p=e.random||(e.rng||n)();null==s&&(s=c=[1|p[0],p[1],p[2],p[3],p[4],p[5]]),null==a&&(a=d=16383&(p[6]<<8|p[7]))}var g=void 0!==e.msecs?e.msecs:Date.now(),f=void 0!==e.nsecs?e.nsecs:u+1,m=g-h+(f-u)/1e4;if(m<0&&void 0===e.clockseq&&(a=a+1&16383),(m<0||g>h)&&void 0===e.nsecs&&(f=0),f>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");h=g,u=f,d=a;var v=(1e4*(268435455&(g+=122192928e5))+f)%4294967296;o[i++]=v>>>24&255,o[i++]=v>>>16&255,o[i++]=v>>>8&255,o[i++]=255&v;var y=g/4294967296*1e4&268435455;o[i++]=y>>>8&255,o[i++]=255&y,o[i++]=y>>>24&15|16,o[i++]=y>>>16&255,o[i++]=a>>>8|128,o[i++]=255&a;for(var S=0;S<6;++S)o[i+S]=s[S];return t||l(o)};var g=function(e,t,r){function i(e,i,o,n){if("string"==typeof e&&(e=function(e){e=unescape(encodeURIComponent(e));for(var t=[],r=0;r<e.length;++r)t.push(e.charCodeAt(r));return t}(e)),"string"==typeof i&&(i=function(e){var t=[];return e.replace(/[a-fA-F0-9]{2}/g,(function(e){t.push(parseInt(e,16))})),t}(i)),!Array.isArray(e))throw TypeError("value must be an array of bytes");if(!Array.isArray(i)||16!==i.length)throw TypeError("namespace must be uuid string or an Array of 16 byte values");var s=r(i.concat(e));if(s[6]=15&s[6]|t,s[8]=63&s[8]|128,o){n=n||0;for(var a=0;a<16;++a)o[n+a]=s[a];return o}return l(s)}try{i.name=e}catch(e){}return i.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",i.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8",i};function f(e){return 14+(e+64>>>9<<4)+1}function m(e,t){var r=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(r>>16)<<16|65535&r}function v(e,t,r,i,o,n){return m((s=m(m(t,e),m(i,n)))<<(a=o)|s>>>32-a,r);var s,a}function y(e,t,r,i,o,n,s){return v(t&r|~t&i,e,t,o,n,s)}function S(e,t,r,i,o,n,s){return v(t&i|r&~i,e,t,o,n,s)}function b(e,t,r,i,o,n,s){return v(t^r^i,e,t,o,n,s)}function C(e,t,r,i,o,n,s){return v(r^(t|~i),e,t,o,n,s)}var _=g("v3",48,(function(e){if("string"==typeof e){var t=unescape(encodeURIComponent(e));e=new Uint8Array(t.length);for(var r=0;r<t.length;++r)e[r]=t.charCodeAt(r)}return function(e){for(var t=[],r=32*e.length,i=0;i<r;i+=8){var o=e[i>>5]>>>i%32&255,n=parseInt("0123456789abcdef".charAt(o>>>4&15)+"0123456789abcdef".charAt(15&o),16);t.push(n)}return t}(function(e,t){e[t>>5]|=128<<t%32,e[f(t)-1]=t;for(var r=1732584193,i=-271733879,o=-1732584194,n=271733878,s=0;s<e.length;s+=16){var a=r,c=i,d=o,l=n;r=y(r,i,o,n,e[s],7,-680876936),n=y(n,r,i,o,e[s+1],12,-389564586),o=y(o,n,r,i,e[s+2],17,606105819),i=y(i,o,n,r,e[s+3],22,-1044525330),r=y(r,i,o,n,e[s+4],7,-176418897),n=y(n,r,i,o,e[s+5],12,1200080426),o=y(o,n,r,i,e[s+6],17,-1473231341),i=y(i,o,n,r,e[s+7],22,-45705983),r=y(r,i,o,n,e[s+8],7,1770035416),n=y(n,r,i,o,e[s+9],12,-1958414417),o=y(o,n,r,i,e[s+10],17,-42063),i=y(i,o,n,r,e[s+11],22,-1990404162),r=y(r,i,o,n,e[s+12],7,1804603682),n=y(n,r,i,o,e[s+13],12,-40341101),o=y(o,n,r,i,e[s+14],17,-1502002290),i=y(i,o,n,r,e[s+15],22,1236535329),r=S(r,i,o,n,e[s+1],5,-165796510),n=S(n,r,i,o,e[s+6],9,-1069501632),o=S(o,n,r,i,e[s+11],14,643717713),i=S(i,o,n,r,e[s],20,-373897302),r=S(r,i,o,n,e[s+5],5,-701558691),n=S(n,r,i,o,e[s+10],9,38016083),o=S(o,n,r,i,e[s+15],14,-660478335),i=S(i,o,n,r,e[s+4],20,-405537848),r=S(r,i,o,n,e[s+9],5,568446438),n=S(n,r,i,o,e[s+14],9,-1019803690),o=S(o,n,r,i,e[s+3],14,-187363961),i=S(i,o,n,r,e[s+8],20,1163531501),r=S(r,i,o,n,e[s+13],5,-1444681467),n=S(n,r,i,o,e[s+2],9,-51403784),o=S(o,n,r,i,e[s+7],14,1735328473),i=S(i,o,n,r,e[s+12],20,-1926607734),r=b(r,i,o,n,e[s+5],4,-378558),n=b(n,r,i,o,e[s+8],11,-2022574463),o=b(o,n,r,i,e[s+11],16,1839030562),i=b(i,o,n,r,e[s+14],23,-35309556),r=b(r,i,o,n,e[s+1],4,-1530992060),n=b(n,r,i,o,e[s+4],11,1272893353),o=b(o,n,r,i,e[s+7],16,-155497632),i=b(i,o,n,r,e[s+10],23,-1094730640),r=b(r,i,o,n,e[s+13],4,681279174),n=b(n,r,i,o,e[s],11,-358537222),o=b(o,n,r,i,e[s+3],16,-722521979),i=b(i,o,n,r,e[s+6],23,76029189),r=b(r,i,o,n,e[s+9],4,-640364487),n=b(n,r,i,o,e[s+12],11,-421815835),o=b(o,n,r,i,e[s+15],16,530742520),i=b(i,o,n,r,e[s+2],23,-995338651),r=C(r,i,o,n,e[s],6,-198630844),n=C(n,r,i,o,e[s+7],10,1126891415),o=C(o,n,r,i,e[s+14],15,-1416354905),i=C(i,o,n,r,e[s+5],21,-57434055),r=C(r,i,o,n,e[s+12],6,1700485571),n=C(n,r,i,o,e[s+3],10,-1894986606),o=C(o,n,r,i,e[s+10],15,-1051523),i=C(i,o,n,r,e[s+1],21,-2054922799),r=C(r,i,o,n,e[s+8],6,1873313359),n=C(n,r,i,o,e[s+15],10,-30611744),o=C(o,n,r,i,e[s+6],15,-1560198380),i=C(i,o,n,r,e[s+13],21,1309151649),r=C(r,i,o,n,e[s+4],6,-145523070),n=C(n,r,i,o,e[s+11],10,-1120210379),o=C(o,n,r,i,e[s+2],15,718787259),i=C(i,o,n,r,e[s+9],21,-343485551),r=m(r,a),i=m(i,c),o=m(o,d),n=m(n,l)}return[r,i,o,n]}(function(e){if(0===e.length)return[];for(var t=8*e.length,r=new Uint32Array(f(t)),i=0;i<t;i+=8)r[i>>5]|=(255&e[i/8])<<i%32;return r}(e),8*e.length))}));var T=function(e,t,r){var i=(e=e||{}).random||(e.rng||n)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,t){r=r||0;for(var o=0;o<16;++o)t[r+o]=i[o];return t}return l(i)};function E(e,t,r,i){switch(e){case 0:return t&r^~t&i;case 1:return t^r^i;case 2:return t&r^t&i^r&i;case 3:return t^r^i}}function w(e,t){return e<<t|e>>>32-t}var L=g("v5",80,(function(e){var t=[1518500249,1859775393,2400959708,3395469782],r=[1732584193,4023233417,2562383102,271733878,3285377520];if("string"==typeof e){var i=unescape(encodeURIComponent(e));e=[];for(var o=0;o<i.length;++o)e.push(i.charCodeAt(o))}e.push(128);for(var n=e.length/4+2,s=Math.ceil(n/16),a=new Array(s),c=0;c<s;++c){for(var d=new Uint32Array(16),l=0;l<16;++l)d[l]=e[64*c+4*l]<<24|e[64*c+4*l+1]<<16|e[64*c+4*l+2]<<8|e[64*c+4*l+3];a[c]=d}a[s-1][14]=8*(e.length-1)/Math.pow(2,32),a[s-1][14]=Math.floor(a[s-1][14]),a[s-1][15]=8*(e.length-1)&4294967295;for(var h=0;h<s;++h){for(var u=new Uint32Array(80),p=0;p<16;++p)u[p]=a[h][p];for(var g=16;g<80;++g)u[g]=w(u[g-3]^u[g-8]^u[g-14]^u[g-16],1);for(var f=r[0],m=r[1],v=r[2],y=r[3],S=r[4],b=0;b<80;++b){var C=Math.floor(b/20),_=w(f,5)+E(C,m,v,y)+S+t[C]+u[b]>>>0;S=y,y=v,v=w(m,30)>>>0,m=f,f=_}r[0]=r[0]+f>>>0,r[1]=r[1]+m>>>0,r[2]=r[2]+v>>>0,r[3]=r[3]+y>>>0,r[4]=r[4]+S>>>0}return[r[0]>>24&255,r[0]>>16&255,r[0]>>8&255,255&r[0],r[1]>>24&255,r[1]>>16&255,r[1]>>8&255,255&r[1],r[2]>>24&255,r[2]>>16&255,r[2]>>8&255,255&r[2],r[3]>>24&255,r[3]>>16&255,r[3]>>8&255,255&r[3],r[4]>>24&255,r[4]>>16&255,r[4]>>8&255,255&r[4]]}))}])}));